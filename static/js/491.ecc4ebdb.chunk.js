/*! For license information please see 491.ecc4ebdb.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkvitessce_demo_gh_pages=self.webpackChunkvitessce_demo_gh_pages||[]).push([[491],{491:(e,t,n)=>{n.r(t),n.d(t,{i:()=>nV});var i=n(504),r=n(43);function s(e,t){for(var n=0;n<t.length;n++){const i=t[n];if("string"!=typeof i&&!Array.isArray(i))for(const t in i)if("default"!==t&&!(t in e)){const n=Object.getOwnPropertyDescriptor(i,t);n&&Object.defineProperty(e,t,n.get?n:{enumerable:!0,get:()=>i[t]})}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}var o={},a=i.aV,l=i.aW,c=i.aX,d=function(e,t){var n=(l.Object||{})[e]||Object[e],i={};i[e]=t(n),a(a.S+a.F*c((function(){n(1)})),"Object",i)},u=i.aY,h=i.aZ;d("keys",(function(){return function(e){return h(u(e))}}));var p={default:i.aW.Object.keys,__esModule:!0};const f=(0,i.g)(p);var g=i.a$,m=(0,i.a_)("toStringTag"),v="Arguments"==g(function(){return arguments}()),y=function(e){var t,n,i;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch{}}(t=Object(e),m))?n:v?g(t):"Object"==(i=g(t))&&"function"==typeof t.callee?"Arguments":i},b=y,S=(0,i.a_)("iterator"),w=i.b0,x=i.aW.isIterable=function(e){var t=Object(e);return void 0!==t[S]||"@@iterator"in t||w.hasOwnProperty(b(t))},C={default:x,__esModule:!0},k=y,T=(0,i.a_)("iterator"),E=i.b0,L=i.aW.getIteratorMethod=function(e){if(null!=e)return e[T]||e["@@iterator"]||E[k(e)]},I=i.b1,D=L,M=i.aW.getIterator=function(e){var t=D(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return I(t.call(e))},P={default:M,__esModule:!0};const A=(0,i.g)(P);var R=V(C),N=V(P);function V(e){return e&&e.__esModule?e:{default:e}}var O=function(e,t){if(Array.isArray(e))return e;if((0,R.default)(Object(e)))return function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=(0,N.default)(e);!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(l){r=!0,s=l}finally{try{!i&&a.return&&a.return()}finally{if(r)throw s}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},B=i.b2,_=function(e,t,n){for(var i in t)n&&e[i]?e[i]=t[i]:B(e,i,t[i]);return e},F=function(e,t,n,i){if(!(e instanceof t)||void 0!==i&&i in e)throw TypeError(n+": incorrect invocation!");return e},z={exports:{}},U=i.b1,G=function(e,t,n,i){try{return i?t(U(n)[0],n[1]):t(n)}catch(s){var r=e.return;throw void 0!==r&&U(r.call(e)),s}},W=i.b0,$=(0,i.a_)("iterator"),j=Array.prototype,H=function(e){return void 0!==e&&(W.Array===e||j[$]===e)},J=i.b3,q=G,Y=H,Z=i.b1,X=i.b4,K=L,Q={},ee={},te=z.exports=function(e,t,n,i,r){var s,o,a,l,c=r?function(){return e}:K(e),d=J(n,i,t?2:1),u=0;if("function"!=typeof c)throw TypeError(e+" is not iterable!");if(Y(c)){for(s=X(e.length);s>u;u++)if((l=t?d(Z(o=e[u])[0],o[1]):d(e[u]))===Q||l===ee)return l}else for(a=c.call(e);!(o=a.next()).done;)if((l=q(a,d,o.value,t))===Q||l===ee)return l};te.BREAK=Q,te.RETURN=ee;var ne,ie,re,se,oe=z.exports,ae=i.b5,le=i.aW,ce=i.b6,de=i.b7,ue=(0,i.a_)("species"),he=function(e){var t="function"==typeof le[e]?le[e]:ae[e];de&&t&&!t[ue]&&ce.f(t,ue,{configurable:!0,get:function(){return this}})},pe=i.b8,fe=function(e,t){if(!pe(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e},ge=i.b6.f,me=i.ba,ve=_,ye=i.b3,be=F,Se=oe,we=i.bb,xe=i.bc,Ce=he,ke=i.b7,Te=i.b9.fastKey,Ee=fe,Le=ke?"_s":"size",Ie=function(e,t){var n,i=Te(t);if("F"!==i)return e._i[i];for(n=e._f;n;n=n.n)if(n.k==t)return n},De={getConstructor:function(e,t,n,i){var r=e((function(e,s){be(e,r,t,"_i"),e._t=t,e._i=me(null),e._f=void 0,e._l=void 0,e[Le]=0,null!=s&&Se(s,n,e[i],e)}));return ve(r.prototype,{clear:function(){for(var e=Ee(this,t),n=e._i,i=e._f;i;i=i.n)i.r=!0,i.p&&(i.p=i.p.n=void 0),delete n[i.i];e._f=e._l=void 0,e[Le]=0},delete:function(e){var n=Ee(this,t),i=Ie(n,e);if(i){var r=i.n,s=i.p;delete n._i[i.i],i.r=!0,s&&(s.n=r),r&&(r.p=s),n._f==i&&(n._f=r),n._l==i&&(n._l=s),n[Le]--}return!!i},forEach:function(e){Ee(this,t);for(var n,i=ye(e,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(i(n.v,n.k,this);n&&n.r;)n=n.p},has:function(e){return!!Ie(Ee(this,t),e)}}),ke&&ge(r.prototype,"size",{get:function(){return Ee(this,t)[Le]}}),r},def:function(e,t,n){var i,r,s=Ie(e,t);return s?s.v=n:(e._l=s={i:r=Te(t,!0),k:t,v:n,p:i=e._l,n:void 0,r:!1},e._f||(e._f=s),i&&(i.n=s),e[Le]++,"F"!==r&&(e._i[r]=s)),e},getEntry:Ie,setStrong:function(e,t,n){we(e,t,(function(e,n){this._t=Ee(e,t),this._k=n,this._l=void 0}),(function(){for(var e=this,t=e._k,n=e._l;n&&n.r;)n=n.p;return e._t&&(e._l=n=n?n.n:e._t._f)?xe(0,"keys"==t?n.k:"values"==t?n.v:[n.k,n.v]):(e._t=void 0,xe(1))}),n?"entries":"values",!n,!0),Ce(t)}},Me=i.b8,Pe=i.bd,Ae=(0,i.a_)("species"),Re=function(e){var t;return Pe(e)&&("function"==typeof(t=e.constructor)&&(t===Array||Pe(t.prototype))&&(t=void 0),Me(t)&&(null===(t=t[Ae])&&(t=void 0))),void 0===t?Array:t},Ne=i.b3,Ve=i.be,Oe=i.aY,Be=i.b4,_e=function(e,t){return new(Re(e))(t)},Fe=function(e,t){var n=1==e,i=2==e,r=3==e,s=4==e,o=6==e,a=5==e||o,l=t||_e;return function(t,c,d){for(var u,h,p=Oe(t),f=Ve(p),g=Ne(c,d,3),m=Be(f.length),v=0,y=n?l(t,m):i?l(t,0):void 0;m>v;v++)if((a||v in f)&&(h=g(u=f[v],v,p),e))if(n)y[v]=h;else if(h)switch(e){case 3:return!0;case 5:return u;case 6:return v;case 2:y.push(u)}else if(s)return!1;return o?-1:r||s?s:y}},ze=i.b5,Ue=i.aV,Ge=i.b9,We=i.aX,$e=i.b2,je=_,He=oe,Je=F,qe=i.b8,Ye=i.bf,Ze=i.b6.f,Xe=Fe(0),Ke=i.b7,Qe=function(e,t,n,i,r,s){var o=ze[e],a=o,l=r?"set":"add",c=a&&a.prototype,d={};return Ke&&"function"==typeof a&&(s||c.forEach&&!We((function(){(new a).entries().next()})))?(a=t((function(t,n){Je(t,a,e,"_c"),t._c=new o,null!=n&&He(n,r,t[l],t)})),Xe("add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON".split(","),(function(e){var t="add"==e||"set"==e;e in c&&(!s||"clear"!=e)&&$e(a.prototype,e,(function(n,i){if(Je(this,a,e),!t&&s&&!qe(n))return"get"==e&&void 0;var r=this._c[e](0===n?0:n,i);return t?this:r}))})),s||Ze(a.prototype,"size",{get:function(){return this._c.size}})):(a=i.getConstructor(t,e,r,l),je(a.prototype,n),Ge.NEED=!0),Ye(a,e),d[e]=a,Ue(Ue.G+Ue.W+Ue.F,d),s||i.setStrong(a,e,r),a},et=De,tt=fe,nt="Map";function it(){if(se)return re;se=1;var e=y,t=function(){if(ie)return ne;ie=1;var e=oe;return ne=function(t,n){var i=[];return e(t,!1,i.push,i,n),i}}();return re=function(n){return function(){if(e(this)!=n)throw TypeError(n+"#toJSON isn't generic");return t(this)}}}Qe(nt,(function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}}),{get:function(e){var t=et.getEntry(tt(this,nt),e);return t&&t.v},set:function(e,t){return et.def(tt(this,nt),0===e?0:e,t)}},et,!0);var rt=i.aV;rt(rt.P+rt.R,"Map",{toJSON:it()("Map")});var st=i.aV,ot=function(e){st(st.S,e,{of:function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return new this(t)}})};ot("Map");var at=i.aV,lt=i.bg,ct=i.b3,dt=oe,ut=function(e){at(at.S,e,{from:function(e){var t,n,i,r,s=arguments[1];return lt(this),(t=void 0!==s)&&lt(s),null==e?new this:(n=[],t?(i=0,r=ct(s,arguments[2],2),dt(e,!1,(function(e){n.push(r(e,i++))}))):dt(e,!1,n.push,n),new this(n))}})};ut("Map");var ht={default:i.aW.Map,__esModule:!0};const pt=(0,i.g)(ht);var ft,gt,mt=i.b6,vt=i.bh;function yt(){if(gt)return ft;gt=1;var e=(0,i.a_)("iterator"),t=!1;try{var n=[7][e]();n.return=function(){t=!0},Array.from(n,(function(){throw 2}))}catch{}return ft=function(n,i){if(!i&&!t)return!1;var r=!1;try{var s=[7],o=s[e]();o.next=function(){return{done:r=!0}},s[e]=function(){return o},n(s)}catch{}return r}}var bt=i.b3,St=i.aV,wt=i.aY,xt=G,Ct=H,kt=i.b4,Tt=function(e,t,n){t in e?mt.f(e,t,vt(0,n)):e[t]=n},Et=L;St(St.S+St.F*!yt()((function(e){Array.from(e)})),"Array",{from:function(e){var t,n,i,r,s=wt(e),o="function"==typeof this?this:Array,a=arguments.length,l=a>1?arguments[1]:void 0,c=void 0!==l,d=0,u=Et(s);if(c&&(l=bt(l,a>2?arguments[2]:void 0,2)),null==u||o==Array&&Ct(u))for(n=new o(t=kt(s.length));t>d;d++)Tt(n,d,c?l(s[d],d):s[d]);else for(r=u.call(s),n=new o;!(i=r.next()).done;d++)Tt(n,d,c?xt(r,l,[i.value,d],!0):i.value);return n.length=d,n}});var Lt={default:i.aW.Array.from,__esModule:!0};const It=(0,i.g)(Lt);var Dt=De,Mt=fe;Qe("Set",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}}),{add:function(e){return Dt.def(Mt(this,"Set"),e=0===e?0:e,e)}},Dt);var Pt=i.aV;Pt(Pt.P+Pt.R,"Set",{toJSON:it()("Set")}),ot("Set"),ut("Set");var At={default:i.aW.Set,__esModule:!0};const Rt=(0,i.g)(At);var Nt=i.aW,Vt=Nt.JSON||(Nt.JSON={stringify:JSON.stringify}),Ot={default:function(e){return Vt.stringify.apply(Vt,arguments)},__esModule:!0};const Bt=(0,i.g)(Ot);function _t(e,t){let n=e.length,i=0;for(let r=0;r<n;++r)t(e[r],r,e)&&(e[i]=e[r],++i);e.length=i}function Ft(e,t,n,i){const r=e.length/t,s=e.length*n*i,o=new e.constructor(s),a=e.length*i,l=t,c=t*i;for(let d=0;d<r;++d)for(let r=0;r<t;++r){const s=e[d*t+r],u=d*c+r;for(let e=0;e<n;++e)for(let t=0;t<i;++t)o[e*a+t*l+u]=s}return o}function zt(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.length;for(;i<r;){const s=i+r-1>>1,o=n(t,e[s]);if(o>0)i=s+1;else{if(!(o<0))return s;r=s}}return~i}function Ut(e,t){const n=e.length;if(t.length!==n)return!1;for(let i=0;i<n;++i)if(e[i]!==t[i])return!1;return!0}function Gt(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e===t;const i=e.length;if(t.length!==i)return!1;for(let r=0;r<i;++r)if(!n(e[r],t[r]))return!1;return!0}function Wt(e,t,n){for(let i=0,r=n.length;i<r;++i){const r=n[i];-1!==r&&(e[i]=t[r])}return e}function $t(e){const t=[];for(let n=0,i=e.length;n<i;++n){const i=e[n];for(let e=0,n=i.length;e<n;++e){let n=t[e];void 0===n&&(n=t[e]=[]),n.push(i[e])}}return t}var jt=i.bi,Ht=function(){return jt.Date.now()},Jt=/\s/;var qt=function(e){for(var t=e.length;t--&&Jt.test(e.charAt(t)););return t},Yt=qt,Zt=/^\s+/;var Xt=function(e){return e&&e.slice(0,Yt(e)+1).replace(Zt,"")},Kt=i.bj,Qt=i.bk;var en=function(e){return"symbol"==typeof e||Qt(e)&&"[object Symbol]"==Kt(e)},tn=Xt,nn=i.bl,rn=en,sn=/^[-+]0x[0-9a-f]+$/i,on=/^0b[01]+$/i,an=/^0o[0-7]+$/i,ln=parseInt;var cn=function(e){if("number"==typeof e)return e;if(rn(e))return NaN;if(nn(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=nn(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=tn(e);var n=on.test(e);return n||an.test(e)?ln(e.slice(2),n?2:8):sn.test(e)?NaN:+e},dn=i.bl,un=Ht,hn=cn,pn=Math.max,fn=Math.min;var gn=function(e,t,n){var i,r,s,o,a,l,c=0,d=!1,u=!1,h=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function p(t){var n=i,s=r;return i=r=void 0,c=t,o=e.apply(s,n)}function f(e){var n=e-l;return void 0===l||n>=t||n<0||u&&e-c>=s}function g(){var e=un();if(f(e))return m(e);a=setTimeout(g,function(e){var n=t-(e-l);return u?fn(n,s-(e-c)):n}(e))}function m(e){return a=void 0,h&&i?p(e):(i=r=void 0,o)}function v(){var e=un(),n=f(e);if(i=arguments,r=this,l=e,n){if(void 0===a)return function(e){return c=e,a=setTimeout(g,t),d?p(e):o}(l);if(u)return clearTimeout(a),a=setTimeout(g,t),p(l)}return void 0===a&&(a=setTimeout(g,t)),o}return t=hn(t)||0,dn(n)&&(d=!!n.leading,s=(u="maxWait"in n)?pn(hn(n.maxWait)||0,t):s,h="trailing"in n?!!n.trailing:h),v.cancel=function(){void 0!==a&&clearTimeout(a),c=0,i=l=r=a=void 0},v.flush=function(){return void 0===a?o:m(un())},v};const mn=(0,i.g)(gn);function vn(e){"object"==typeof e?e.dispose():e()}function yn(e){for(let t=e.length;t>0;--t)vn(e[t-1])}function bn(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}class Sn{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){0===--this.refCount&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();let e=this.disposers;void 0!==e&&(yn(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){let t=this.disposers;return null==t?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){let t=this.disposers;if(null!=t){let n=t.indexOf(e);-1!==n&&t.splice(n,1)}return e}registerEventListener(e,t,n,i){this.registerDisposer(bn(e,t,n,i))}registerCancellable(e){return this.registerDisposer((()=>{e.cancel()})),e}}class wn extends Sn{constructor(e){super(),this.value=e}}function xn(e){return()=>{if(void 0!==e){let t=e;e=void 0,vn(t)}}}class Cn{constructor(){this.handlers=new Rt,this.count=0;const e=this;this.dispatch=function(){++e.count,e.handlers.forEach((e=>{e.apply(this,arguments)}))}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}}class kn extends Cn{}const Tn={count:0,add:e=>()=>{},remove:e=>!1};class En{constructor(e){this.value_=e,this.changed=new kn}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}}class Ln extends En{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;super(e),this.validator=t,this.defaultValue=n}toJSON(){if(this.value_!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(void 0!==e){let t=this.validator;try{return void(this.value=t(e))}catch{}}this.value=this.defaultValue}}class In extends Sn{constructor(e,t){super(),this.changed=new kn,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map((e=>e.value)))}}function Dn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return new In(e,n)}class Mn extends Sn{constructor(e,t){super(),this.changed=new kn,this.valueGeneration=-1,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){const e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map((e=>e.value))),this.valueGeneration=e),this.value_}}function Pn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return new Mn(e,n)}class An extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(e,t)=>e===t;super(),this.changed=new Cn,this.value=e.value,this.registerDisposer(e.changed.add((()=>{const n=e.value;t(this.value,n)||(this.value=n,this.changed.dispatch())})))}}function Rn(e,t,n){const i=new In(e,t),r=new An(i,n);return r.registerDisposer(i),r}class Nn extends Sn{constructor(e){super(),this.changed=new kn;const t=e(this),n=f(t),i=()=>{const e=Array.isArray(t)?[]:{};for(const i of n)e[i]=t[i].value;this.value=e,this.changed.dispatch()};i();for(const r of n){const e=t[r];this.registerDisposer(e.changed.add((()=>i())))}}}class Vn{constructor(e){this.changed=new kn,this.values=void 0===e?new Rt:new Rt(e)}add(e){const t=this.values;return t.has(e)||(t.add(e),this.changed.dispatch()),this}delete(e){return!!this.values.delete(e)&&(this.changed.dispatch(),!0)}has(e){return this.values.has(e)}get size(){return this.values.size}[i.bm](){return A(this.values)}clear(){const e=this.values;e.size>0&&(e.clear(),this.changed.dispatch())}}function On(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];let r=n.map((e=>e.value));const s=n.length;let o=new Sn,a=e(o,...r);const l=mn((()=>{let t=!1;for(let e=0;e<s;++e){const i=n[e].value;r[e]!==i&&(r[e]=i,t=!0)}t&&(o.dispose(),o=new Sn,a=e(o,...r))}),0),c=n.map((e=>e.changed.add(l)));return{flush(){l.flush()},dispose(){l.cancel(),yn(c),o.dispose()},get value(){return l.flush(),a}}}function Bn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];let r=n.map((e=>e.value));const s=n.length;let o=new Sn,a=e(o,...r);const l=()=>{let t=!1;for(let e=0;e<s;++e){const i=n[e].value;r[e]!==i&&(r[e]=i,t=!0)}t&&(o.dispose(),o=new Sn,a=e(o,...r))},c=n.map((e=>e.changed.add(l)));return{dispose(){yn(c),o.dispose()},get value(){return a}}}function _n(e){return{changed:Tn,value:e}}function Fn(e,t){return e(t.value),t.changed.add((()=>e(t.value)))}class zn{constructor(e,t){this.outer=e,this.getInner=t,this.changed=new kn,this.update=()=>{const e=this.disposer,t=this.outer;void 0!==e&&e();const n=this.inner=this.getInner(t.value);this.disposer=n.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class Un extends zn{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}const Gn=new Float32Array(1);var Wn=1e-6,$n=typeof Float32Array<"u"?Float32Array:Array;function jn(){var e=new $n(9);return $n!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function Hn(e){var t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*(c*s-o*l)+n*(-c*r+o*a)+i*(l*r-s*a)}function Jn(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=n+n,a=i+i,l=r+r,c=n*o,d=i*o,u=i*a,h=r*o,p=r*a,f=r*l,g=s*o,m=s*a,v=s*l;return e[0]=1-u-f,e[3]=d-v,e[6]=h+m,e[1]=d+v,e[4]=1-c-f,e[7]=p-g,e[2]=h-m,e[5]=p+g,e[8]=1-c-u,e}function qn(){var e=new $n(16);return $n!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Yn(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Zn(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Xn(e,t){if(e===t){var n=t[1],i=t[2],r=t[3],s=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=s,e[11]=t[14],e[12]=r,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function Kn(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],l=t[6],c=t[7],d=t[8],u=t[9],h=t[10],p=t[11],f=t[12],g=t[13],m=t[14],v=t[15],y=n*a-i*o,b=n*l-r*o,S=n*c-s*o,w=i*l-r*a,x=i*c-s*a,C=r*c-s*l,k=d*g-u*f,T=d*m-h*f,E=d*v-p*f,L=u*m-h*g,I=u*v-p*g,D=h*v-p*m,M=y*D-b*I+S*L+w*E-x*T+C*k;return M?(M=1/M,e[0]=(a*D-l*I+c*L)*M,e[1]=(r*I-i*D-s*L)*M,e[2]=(g*C-m*x+v*w)*M,e[3]=(h*x-u*C-p*w)*M,e[4]=(l*E-o*D-c*T)*M,e[5]=(n*D-r*E+s*T)*M,e[6]=(m*S-f*C-v*b)*M,e[7]=(d*C-h*S+p*b)*M,e[8]=(o*I-a*E+c*k)*M,e[9]=(i*E-n*I-s*k)*M,e[10]=(f*x-g*S+v*y)*M,e[11]=(u*S-d*x-p*y)*M,e[12]=(a*T-o*L-l*k)*M,e[13]=(n*L-i*T+r*k)*M,e[14]=(g*b-f*w-m*y)*M,e[15]=(d*w-u*b+h*y)*M,e):null}function Qn(e,t,n){var i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],l=t[5],c=t[6],d=t[7],u=t[8],h=t[9],p=t[10],f=t[11],g=t[12],m=t[13],v=t[14],y=t[15],b=n[0],S=n[1],w=n[2],x=n[3];return e[0]=b*i+S*a+w*u+x*g,e[1]=b*r+S*l+w*h+x*m,e[2]=b*s+S*c+w*p+x*v,e[3]=b*o+S*d+w*f+x*y,b=n[4],S=n[5],w=n[6],x=n[7],e[4]=b*i+S*a+w*u+x*g,e[5]=b*r+S*l+w*h+x*m,e[6]=b*s+S*c+w*p+x*v,e[7]=b*o+S*d+w*f+x*y,b=n[8],S=n[9],w=n[10],x=n[11],e[8]=b*i+S*a+w*u+x*g,e[9]=b*r+S*l+w*h+x*m,e[10]=b*s+S*c+w*p+x*v,e[11]=b*o+S*d+w*f+x*y,b=n[12],S=n[13],w=n[14],x=n[15],e[12]=b*i+S*a+w*u+x*g,e[13]=b*r+S*l+w*h+x*m,e[14]=b*s+S*c+w*p+x*v,e[15]=b*o+S*d+w*f+x*y,e}function ei(e,t,n,i,r,s,o){var a=1/(t-n),l=1/(i-r),c=1/(s-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+n)*a,e[13]=(r+i)*l,e[14]=(o+s)*c,e[15]=1,e}function ti(){var e=new $n(3);return $n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function ni(e){var t=new $n(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ii(e,t,n){var i=new $n(3);return i[0]=e,i[1]=t,i[2]=n,i}function ri(e,t,n,i){return e[0]=t,e[1]=n,e[2]=i,e}function si(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function oi(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function ai(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e}function li(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e}function ci(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function di(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function ui(e,t){var n=t[0],i=t[1],r=t[2],s=n*n+i*i+r*r;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function hi(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function pi(e,t,n){var i=t[0],r=t[1],s=t[2],o=n[3]*i+n[7]*r+n[11]*s+n[15];return o=o||1,e[0]=(n[0]*i+n[4]*r+n[8]*s+n[12])/o,e[1]=(n[1]*i+n[5]*r+n[9]*s+n[13])/o,e[2]=(n[2]*i+n[6]*r+n[10]*s+n[14])/o,e}function fi(e,t,n){var i=n[0],r=n[1],s=n[2],o=n[3],a=t[0],l=t[1],c=t[2],d=r*c-s*l,u=s*a-i*c,h=i*l-r*a,p=r*h-s*u,f=s*d-i*h,g=i*u-r*d,m=2*o;return d*=m,u*=m,h*=m,p*=2,f*=2,g*=2,e[0]=a+d+p,e[1]=l+u+f,e[2]=c+h+g,e}function gi(e,t){var n=e[0],i=e[1],r=e[2],s=t[0],o=t[1],a=t[2];return Math.abs(n-s)<=Wn*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-o)<=Wn*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=Wn*Math.max(1,Math.abs(r),Math.abs(a))}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var mi=oi;function vi(){var e=new $n(4);return $n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function yi(e,t,n,i){var r=new $n(4);return r[0]=e,r[1]=t,r[2]=n,r[3]=i,r}function bi(){var e=new $n(4);return $n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Si(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function wi(e,t,n){n*=.5;var i=Math.sin(n);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(n),e}function xi(e,t,n){var i=t[0],r=t[1],s=t[2],o=t[3],a=n[0],l=n[1],c=n[2],d=n[3];return e[0]=i*d+o*a+r*c-s*l,e[1]=r*d+o*l+s*a-i*c,e[2]=s*d+o*c+i*l-r*a,e[3]=o*d-i*a-r*l-s*c,e}function Ci(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=n*n+i*i+r*r+s*s,a=o?1/o:0;return e[0]=-n*a,e[1]=-i*a,e[2]=-r*a,e[3]=s*a,e}function ki(e,t){var n,i=t[0]+t[4]+t[8];if(i>0)n=Math.sqrt(i+1),e[3]=.5*n,n=.5/n,e[0]=(t[5]-t[7])*n,e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var s=(r+1)%3,o=(r+2)%3;n=Math.sqrt(t[3*r+r]-t[3*s+s]-t[3*o+o]+1),e[r]=.5*n,n=.5/n,e[3]=(t[3*s+o]-t[3*o+s])*n,e[s]=(t[3*s+r]+t[3*r+s])*n,e[o]=(t[3*o+r]+t[3*r+o])*n}return e}!function(){var e=ti()}(),function(){var e=vi()}();var Ti=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Ei=function(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=n*n+i*i+r*r+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=n*o,e[1]=i*o,e[2]=r*o,e[3]=s*o,e};function Li(){var e=new $n(2);return $n!=Float32Array&&(e[0]=0,e[1]=0),e}!function(){var e=ti(),t=ii(1,0,0),n=ii(0,1,0)}(),function(){var e=bi(),t=bi()}(),function(){var e=jn()}(),function(){var e=Li()}();const Ii=qn(),Di=["x","y","z"],Mi=[ii(1,0,0),ii(0,1,0),ii(0,0,1)];ii(0,0,0);const Pi=yi(0,0,0,0),Ai=ii(1,1,1);function Ri(e){return e[0]*e[1]*e[2]}function Ni(e){return`${e[0]},${e[1]},${e[2]}`}function Vi(e,t,n){let i=t[0],r=t[1],s=t[2];return e[0]=n[0]*i+n[1]*r+n[2]*s,e[1]=n[4]*i+n[5]*r+n[6]*s,e[2]=n[8]*i+n[9]*r+n[10]*s,e}function Oi(e,t,n,i){const r=e.length;let s=function(e,t,n){const i=n.length;let r=0;for(let o=0;o<i;++o)r+=(e[o]-t[o])**2;let s=0;for(let o=0;o<i;++o){const i=e[o];s-=(i-n[o])*(t[o]-i)}return s/Math.max(r,1e-6)}(t,n,i);s=Math.max(0,Math.min(1,s));for(let o=0;o<r;++o){const i=t[o];e[o]=i+s*(n[o]-i)}return e}function Bi(e,t){const n=t[0],i=t[1],r=t[2],s=t[4],o=t[5],a=t[6],l=t[8],c=t[9],d=t[10];return e[0]=n,e[1]=i,e[2]=r,e[3]=s,e[4]=o,e[5]=a,e[6]=l,e[7]=c,e[8]=d,e}function _i(e,t){const n=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],l=t[6],c=t[7],d=t[8],u=t[9],h=t[10],p=t[11],f=t[12],g=t[13],m=t[14],v=t[15];e[0]=s+n,e[1]=c+o,e[2]=p+d,e[3]=v+f,e[4]=s-n,e[5]=c-o,e[6]=p-d,e[7]=v-f,e[8]=s+i,e[9]=c+a,e[10]=p+u,e[11]=v+g,e[12]=s-i,e[13]=c-a,e[14]=p-u,e[15]=v-g;const y=s+r,b=c+l,S=p+h,w=v+m,x=s-r,C=c-l,k=p-h,T=v-m,E=Math.sqrt(y**2+b**2+S**2);e[16]=y/E,e[17]=b/E,e[18]=S/E,e[19]=w/E;const L=Math.sqrt(x**2+C**2+k**2);return e[20]=x/L,e[21]=C/L,e[22]=k/L,e[23]=T/L,e}function Fi(e,t,n,i,r,s,o){for(let a=0;a<6;++a){const l=o[4*a],c=o[4*a+1],d=o[4*a+2],u=o[4*a+3];if(Math.max(l*e,l*i)+Math.max(c*t,c*r)+Math.max(d*n,d*s)+u<0)return!1}return!0}function zi(e,t,n,i,r,s,o){for(let a=0;a<4;++a){const l=o[4*a],c=o[4*a+1],d=o[4*a+2],u=o[4*a+3];if(Math.max(l*e,l*i)+Math.max(c*t,c*r)+Math.max(d*n,d*s)+u<0)return!1}{const a=o[20],l=o[21],c=o[22],d=o[23],u=Math.max(a*e,a*i)+Math.max(l*t,l*r)+Math.max(c*n,c*s),h=Math.min(a*e,a*i)+Math.min(l*t,l*r)+Math.min(c*n,c*s),p=1e-6*Math.abs(d);if(h>-d+p||u<-d-p)return!1}return!0}function Ui(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=n.length,s=[],o=i?1:t+1,a=i?t+1:1;for(let l=0;l<r;++l){const i=n[l];for(let n=0;n<t;++n)0!==e[n*o+i*a]&&(s[n]=!0)}return function(e,t){const n=[];for(let i=0,r=e.length;i<r;++i)e[i]===t&&n.push(i);return n}(s,!0)}function Gi(e,t,n){for(let i=0;i<3;++i){const r=n[i];for(let n=0;n<3;++n)e[i+3*n]=r*t[i+3*n]}return e}function Wi(e){if(1===e[15])return 2/Math.abs(e[10]);const t=e[10],n=2*e[14]/(2*t-2),i=(t-1)*n/(t+1);return Math.abs(i-n)}ii(1/0,1/0,1/0),bi();const $i=ti();function ji(e){return("0"+e.toString(16)).slice(-2)}function Hi(e){const t=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{const n=e.match(t);if(null!==n)return[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3],10),parseFloat(n[4])]}const n=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{const t=e.match(n);if(null!==t)return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1]}throw new Error(`Invalid serialized color: ${Bt(e)}.`)}function Ji(e){try{if("string"!=typeof e)throw new Error(`Expected string, but received ${Bt(e)}.`);const t=document.createElement("canvas").getContext("2d");t.fillStyle=e;const n=Hi(t.fillStyle);return yi(n[0]/255,n[1]/255,n[2]/255,n[3])}catch(t){throw new Error(`Failed to parse color specification: ${t.message}`)}}function qi(e){return Ji(e).subarray(0,3)}function Yi(e){const t=void 0===e[3]?3:4;let n=0;for(let i=0;i<t;i++)n=(n<<8>>>0)+Math.min(255,Math.max(0,Math.round(255*e[t-1-i])));return n}function Zi(e){return ii((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255)}function Xi(e){return yi((e>>>0&255)/255,(e>>>8&255)/255,(e>>>16&255)/255,(e>>>24&255)/255)}function Ki(e){if(void 0===e[3]||1===e[3]){let t="#";for(let n=0;n<3;++n)t+=ji(Math.min(255,Math.max(0,Math.round(255*e[n]))));return t}{let t="rgba(";for(let n=0;n<3;++n)0!==n&&(t+=", "),t+=Math.min(255,Math.max(0,Math.round(255*e[n])));return t+=`, ${function(e){Gn[0]=e,e=Gn[0];for(let t=1;t<21;++t){let n=e.toPrecision(t);if(Gn[0]=parseFloat(n),Gn[0]===e)return n}return e.toString()}(e[3])})`,t}}function Qi(e){return e<=.03928?e/12.92:((e+.055)/1.055)**2.4}function er(e){var t=O(e,3);const n=t[0],i=t[1],r=t[2];return.2126*Qi(n)+.7152*Qi(i)+.0722*Qi(r)}function tr(e){return er(e)<=.179}class nr extends En{constructor(e){super(ni(e)),this.defaultValue=e}toString(){return Ki(this.value)}toJSON(){if(!gi(this.value,this.defaultValue))return Ki(this.value)}reset(){this.value=ni(this.defaultValue)}restoreState(e){if(void 0===e)return void this.reset();const t=this.value,n=qi(e);gi(t,n)||(this.value=n)}}class ir extends En{constructor(){super(void 0)}toJSON(){const e=this.value;if(void 0!==e)return Ki(e)}reset(){this.value=void 0}restoreState(e){if(void 0===e)return void this.reset();const t=this.value,n=qi(e);(void 0===t||!gi(t,n))&&(this.value=n)}}const rr=Object.freeze(Object.defineProperty({__proto__:null,TrackableOptionalRGB:ir,TrackableRGB:nr,getRelativeLuminance:er,packColor:Yi,parseColorSerialization:Hi,parseRGBAColorSpecification:Ji,parseRGBColorSpecification:qi,serializeColor:Ki,srgbGammaExpand:Qi,unpackRGB:Zi,unpackRGBA:Xi,useWhiteBackground:tr},Symbol.toStringTag,{value:"Module"}));var sr,or;(or=sr||(sr={}))[or.UINT8=0]="UINT8",or[or.INT8=1]="INT8",or[or.UINT16=2]="UINT16",or[or.INT16=3]="INT16",or[or.UINT32=4]="UINT32",or[or.INT32=5]="INT32",or[or.UINT64=6]="UINT64",or[or.FLOAT32=7]="FLOAT32";const ar={[sr.UINT8]:!1,[sr.INT8]:!0,[sr.UINT16]:!1,[sr.INT16]:!0,[sr.UINT32]:!1,[sr.INT32]:!0,[sr.UINT64]:!1,[sr.FLOAT32]:void 0},lr={[sr.UINT8]:1,[sr.INT8]:1,[sr.UINT16]:2,[sr.INT16]:2,[sr.UINT32]:4,[sr.INT32]:4,[sr.UINT64]:8,[sr.FLOAT32]:4},cr={[sr.UINT8]:Uint8Array,[sr.INT8]:Int8Array,[sr.UINT16]:Uint16Array,[sr.INT16]:Int16Array,[sr.UINT32]:Uint32Array,[sr.INT32]:Int32Array,[sr.UINT64]:Uint32Array,[sr.FLOAT32]:Float32Array};var dr;sr.UINT8,sr.INT8,sr.UINT16,sr.INT16,sr.UINT32,sr.INT32,sr.UINT64,sr.FLOAT32,function(e){e[e.LITTLE=0]="LITTLE",e[e.BIG=1]="BIG"}(dr||(dr={}));const ur=function(){const e=Uint16Array.of(4386);return 17===new Uint8Array(e.buffer)[0]?dr.BIG:dr.LITTLE}();var hr,pr;var fr=i.aV;fr(fr.S,"Number",{isInteger:function(){if(pr)return hr;pr=1;var e=i.b8,t=Math.floor;return hr=function(n){return!e(n)&&isFinite(n)&&t(n)===n}}()});var gr={default:i.aW.Number.isInteger,__esModule:!0};const mr=(0,i.g)(gr);var vr=i.aV,yr=i.b5.isFinite;vr(vr.S,"Number",{isFinite:function(e){return"number"==typeof e&&yr(e)}});var br={default:i.aW.Number.isFinite,__esModule:!0};const Sr=(0,i.g)(br);var wr=i.aV;wr(wr.S,"Number",{isNaN:function(e){return e!=e}});var xr={default:i.aW.Number.isNaN,__esModule:!0};const Cr=(0,i.g)(xr);function kr(e){let t=typeof e;if("number"===t||"string"===t){let t=parseFloat(""+e);if(!Cr(t))return t}throw new Error(`Expected floating-point number, but received: ${Bt(e)}.`)}function Tr(e){let t=kr(e);if(Sr(t))return t;throw new Error(`Expected finite floating-point number, but received: ${t}.`)}function Er(e){let t=kr(e);if(Sr(t)&&t>=0)return t;throw new Error(`Expected finite non-negative floating-point number, but received: ${t}.`)}function Lr(e){let t=Tr(e);if(t>0)return t;throw new Error(`Expected positive finite floating-point number, but received: ${t}.`)}function Ir(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:kr;Yr(t),e[0]=e[1]=e[2]=0;for(const i of f(t))switch(i){case"x":e[0]=n(t[i]);break;case"y":e[1]=n(t[i]);break;case"z":e[2]=n(t[i]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${Bt(t)}.`)}return e}function Dr(e,t){let n=e.length;if(!Array.isArray(t)||t.length!==n)throw new Error("Incompatible sizes");for(let i=0;i<n;++i)if(!Sr(parseFloat(t[i])))throw new Error("Non-finite value.");for(let i=0;i<n;++i)e[i]=parseFloat(t[i]);return e}function Mr(e,t){let n=e.length;if(!Array.isArray(t)||t.length!==n)throw new Error("Incompatible sizes.");for(let i=0;i<n;++i){let e=parseInt(t[i],void 0);if(!mr(e))throw new Error("Non-integer value.")}for(let i=0;i<n;++i)e[i]=parseInt(t[i],void 0);return e}function Pr(e){if("object"==typeof e){if(null===e)return"null";if(Array.isArray(e)){let t="[",n=e.length,i=0;if(i<n)for(t+=Pr(e[i]);++i<n;)t+=",",t+=Pr(e[i]);return t+="]",t}let t="{",n=f(e).sort(),i=0,r=n.length;if(i<r){let s=n[i];for(t+=Bt(s),t+=":",t+=Pr(e[s]);++i<r;)t+=",",s=n[i],t+=Bt(s),t+=":",t+=Pr(e[s])}return t+="}",t}return Bt(e)}function Ar(e){return e.replace(/['"]/g,(e=>'"'===e?"'":'"'))}function Rr(e){return Ar(Bt(Ar(e)))}const Nr=/('(?:[^'\\]|(?:\\.))*')/,Vr=/("(?:[^"\\]|(?:\\.))*")/,Or=new RegExp(`${Nr.source}|${Vr.source}`),Br=new RegExp(`${Vr.source}|${Nr.source}`),_r=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,Fr=/^((?:[^"'\\]|(?:\\.))*)'/;function zr(e,t,n,i){if(e.length>=2&&e.charAt(0)===t&&e.charAt(e.length-1)===t){let r=e.substr(1,e.length-2),s=n;for(;r.length>0;){let e=r.match(i);if(null===e){s+=r;break}s+=e[1],e[2]===n?(s+="\\",s+=n):s+=t,r=r.substr(e.index+e[0].length)}return s+=n,s}return e}function Ur(e){return zr(e,"'",'"',_r)}function Gr(e,t,n){const i=/[&_,]/g;let r,s,o;'"'===n?(r="'",s=_r,o=Or):(r='"',s=Fr,o=Br);let a="";for(;e.length>0;){let l,c,d=e.match(o);if(null===d)l=e,e="",c="";else{l=e.substr(0,d.index),e=e.substr(d.index+d[0].length);let t=d[1];c=void 0!==t?zr(t,r,n,s):d[2]}a+=l.replace(i,t),a+=c}return a}function Wr(e){return Gr(e,",",'"')}function $r(e){return JSON.parse(Wr(e))}function jr(e){let t="";for(;e.length>0;){let n,i,r=e.match(Or);if(null===r)n=e,e="",i="";else{n=e.substr(0,r.index),e=e.substr(r.index+r[0].length);let t=r[1];i=void 0!==t?Ur(t):r[2]}t+=n.replace(/\(/g,"[").replace(/\)/g,"]").replace("True","true").replace("False","false").replace(/,\s*([\}\]])/g,"$1"),t+=i}return t}function Hr(e,t){if(!Array.isArray(e))throw new Error(`Expected array, but received: ${Bt(e)}.`);if(void 0!==t&&e.length!==t)throw new Error(`Expected array of length ${t}, but received: ${Bt(e)}.`);return e}function Jr(e,t){if(!Array.isArray(e))throw new Error(`Expected array, but received: ${Bt(e)}.`);return e.map(t)}function qr(e,t,n){const i=e.length;if(!Array.isArray(t)||t.length!==i)throw new Error(`Expected length ${i} array, but received: ${Bt(t)}.`);for(let r=0;r<i;++r)e[r]=n(t[r],r);return e}function Yr(e){if("object"!=typeof e||null==e||Array.isArray(e))throw new Error(`Expected JSON object, but received: ${Bt(e)}.`);return e}function Zr(e){let t=parseInt(e,10);if(!mr(t))throw new Error(`Expected integer, but received: ${Bt(e)}.`);return t}function Xr(e){let t=Zr(e);if(t<=0)throw new Error(`Expected positive integer, but received: ${t}.`);return t}function Kr(e){const t=Zr(e);if(t<0)throw new Error(`Expected non-negative integer, but received: ${t}.`);return t}function Qr(e,t){let n=t.get(e);if(void 0===n)throw new Error(`Expected one of ${Bt(It(t.keys()))}, but received: ${Bt(e)}.`);return n}function es(e){if("string"!=typeof e)throw new Error(`Expected string, but received: ${Bt(e)}.`);return e}function ts(e){if(void 0!==e)return es(e)}function ns(e,t,n){let i=Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0;try{return n(i)}catch(r){throw new Error(`Error parsing ${Bt(t)} property: ${r.message}`)}}function is(e,t,n,i){return ns(e,t,(e=>void 0===e?i:n(e)))}function rs(e,t){Yr(e);let n=new pt;for(let r of f(e))try{n.set(r,t(e[r]))}catch(i){throw new Error(`Error parsing value associated with key ${Bt(r)}: ${i.message}`)}return n}function ss(e){if("number"!=typeof e||!Sr(e)||e<0||e>1)throw new Error(`Expected floating point number in [0,1], but received: ${Bt(e)}.`);return e}function os(e){if(""===e)return{};if(e.startsWith("{"))return $r(e);{let t={},n=e.split(/[&;]/);for(let e of n){let n=e.match(/^([^=&;]+)=([^&;]*)$/);if(null===n)throw new Error(`Invalid query string part: ${Bt(e)}.`);t[n[1]]=decodeURIComponent(n[2])}return t}}function as(e){if(void 0===e)return"";const t=f(e);return 0===t.length?"":t.some((t=>"string"!=typeof e[t]))?Bt(e):t.map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`)).join("&")}function ls(e,t){if("string"==typeof e&&null!==e.match(/^[a-zA-Z]/)&&(e=e.toUpperCase(),t.hasOwnProperty(e)))return t[e];throw new Error(`Invalid enum value: ${Bt(e)}.`)}function cs(e){return qr(ti(),e,Tr)}function ds(e){if(!Array.isArray(e))throw new Error(`Expected array, received: ${Bt(e)}.`);for(let t of e)if("string"!=typeof t)throw new Error(`Expected string, received: ${Bt(t)}.`);return e}function us(e){if(!Array.isArray(e))throw new Error(`Expected array, received: ${Bt(e)}.`);for(let t of e)if(!mr(t))throw new Error(`Expected integer, received: ${Bt(t)}.`);return e}function hs(e){if("boolean"!=typeof e)throw new Error(`Expected boolean, received: ${Bt(e)}`);return e}function ps(e){for(const t in e)return e}const fs=Object.freeze(Object.defineProperty({__proto__:null,emptyToUndefined:ps,expectArray:Hr,jsonToUrlSafe:function(e){return Gr(e,"_","'")},normalizeStringLiteral:Ur,parseArray:Jr,parseFiniteVec:Dr,parseFixedLengthArray:qr,parseIntVec:Mr,parseQueryStringParameters:os,parseXYZ:Ir,pythonLiteralParse:function(e){return JSON.parse(jr(e))},pythonLiteralToJSON:jr,stableStringify:Pr,unparseQueryStringParameters:as,urlSafeParse:$r,urlSafeStringify:function e(t){if("object"==typeof t){if(null===t)return"null";let n=t.toJSON;if("function"==typeof n)return e(n.call(t));if(Array.isArray(t)){let n="[",i=t.length,r=0;if(r<i)for(n+=e(t[r]);++r<i;)n+="_",n+=e(t[r]);return n+="]",n}let i="{",r=f(t),s=!0;for(let o of r){let n=t[o];if(void 0===n)continue;let r=e(n);r&&(s?s=!1:i+="_",i+=Rr(o),i+=":",i+=r)}return i+="}",i}return"string"==typeof t?Rr(t):Bt(t)},urlSafeStringifyString:Rr,urlSafeToJSON:Wr,valueOr:function(e,t){return void 0===e?t:e},verify3dDimensions:function(e){return qr(ti(),e,Xr)},verify3dScale:function(e){return qr(ti(),e,Lr)},verify3dVec:cs,verifyBoolean:hs,verifyEnumString:ls,verifyFiniteFloat:Tr,verifyFiniteNonNegativeFloat:Er,verifyFinitePositiveFloat:Lr,verifyFloat:kr,verifyFloat01:ss,verifyInt:Zr,verifyIntegerArray:us,verifyMapKey:Qr,verifyNonnegativeInt:Kr,verifyObject:Yr,verifyObjectAsMap:rs,verifyObjectProperty:ns,verifyOptionalBoolean:function(e){if(void 0!==e){if("boolean"==typeof e)return e;if("true"===e)return!0;if("false"===e)return!1;throw new Error(`Expected string or boolean but received: ${Bt(e)}`)}},verifyOptionalInt:function(e){if(void 0!==e)return Zr(e)},verifyOptionalObjectProperty:is,verifyOptionalString:ts,verifyPositiveInt:Xr,verifyString:es,verifyStringArray:ds},Symbol.toStringTag,{value:"Module"})),gs=5e-324,ms=new Float64Array(1),vs=new Uint32Array(ms.buffer);var ys=i.aV,bs=Math.imul;ys(ys.S+ys.F*(0,i.aX)((function(){return-5!=bs(4294967295,5)||2!=bs.length})),"Math",{imul:function(e,t){var n=65535,i=+e,r=+t,s=n&i,o=n&r;return 0|s*o+((n&i>>>16)*o+s*(n&r>>>16)<<16>>>0)}});var Ss={default:i.aW.Math.imul,__esModule:!0};const ws=(0,i.g)(Ss);var xs=i.aV;xs(xs.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}});var Cs={default:i.aW.Math.log2,__esModule:!0};const ks=(0,i.g)(Cs),Ts=new Uint32Array(2),Es=4294967296;let Ls=[];for(let iV=2;iV<=36;++iV){let e=Math.floor(32/ks(iV)),t=Math.pow(iV,e),n=`^[0-${String.fromCharCode("0".charCodeAt(0)+Math.min(9,iV-1))}`;iV>10&&(n+=`a-${String.fromCharCode("a".charCodeAt(0)+iV-11)}`,n+=`A-${String.fromCharCode("A".charCodeAt(0)+iV-11)}`),n+=`]{1,${Math.ceil(64/ks(iV))}}$`;let i=new RegExp(n);Ls[iV]={lowDigits:e,lowBase:t,pattern:i}}function Is(e,t){const n=65535&(e>>>=0),i=e>>>16,r=65535&(t>>>=0),s=t>>>16;let o=(n*r>>>16)+i*r,a=o>>>16;o=(65535&o)+n*s,a+=o>>>16;let l=a>>>16;return a=(65535&a)+i*s,l+=a>>>16,((65535&l)<<16|65535&a)>>>0}class Ds{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.low=e,this.high=t}clone(){return new Ds(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=this.low,n=this.high;if(0===n)return t.toString(e);n*=Es;var i=Ls[e];let r=i.lowBase,s=i.lowDigits,o=n%r;n=Math.floor(n/r),t+=o,n+=Math.floor(t/r),t%=r;let a=t.toString(e);return n.toString(e)+"0".repeat(s-a.length)+a}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return Ds.less(e,t)?e:t}static max(e,t){return Ds.less(e,t)?t:e}static random(){return crypto.getRandomValues(Ts),new Ds(Ts[0],Ts[1])}tryParseString(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;var n=Ls[t];const i=n.lowDigits,r=n.lowBase;if(!n.pattern.test(e))return!1;if(e.length<=i)return this.low=parseInt(e,t),this.high=0,!0;const s=e.length-i,o=parseInt(e.substr(s),t),a=parseInt(e.substr(0,s),t);let l,c;if(r===Es)l=a,c=o;else{const e=ws(a,r)>>>0;l=Is(a,r)+(ws(Math.floor(a/Es),r)>>>0),c=o+e,c>=Es&&(++l,c-=Es)}return c>>>0===c&&l>>>0===l&&(this.low=c,this.high=l,!0)}parseString(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${Bt(e)}.`);return this}static parseString(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return(new Ds).parseString(e,t)}valid(){let e=this.low,t=this.high;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,n){const i=t.low,r=t.high;return 0===n?(e.low=i,e.high=r):n<32?(e.low=i<<n,e.high=r<<n|i>>>32-n):(e.low=0,e.high=i<<n-32),e}static rshift(e,t,n){const i=t.low,r=t.high;return 0===n?(e.low=i,e.high=r):n<32?(e.low=i>>>n|r<<32-n,e.high=r>>>n):(e.low=r>>>n-32,e.high=0),e}static or(e,t,n){return e.low=t.low|n.low,e.high=t.high|n.high,e}static xor(e,t,n){return e.low=t.low^n.low,e.high=t.high^n.high,e}static and(e,t,n){return e.low=t.low&n.low,e.high=t.high&n.high,e}static add(e,t,n){let i=t.low+n.low,r=t.high+n.high;const s=i>>>0;return s!==i&&(r+=1),e.low=s,e.high=r>>>0,e}static addUint32(e,t,n){let i=t.low+n,r=t.high;const s=i>>>0;return s!==i&&(r+=1),e.low=s,e.high=r>>>0,e}static decrement(e,t){let n=t.low,i=t.high;return 0===n&&(i-=1),e.low=n-1>>>0,e.high=i>>>0,e}static increment(e,t){let n=t.low,i=t.high;return 4294967295===n&&(i+=1),e.low=n+1>>>0,e.high=i>>>0,e}static subtract(e,t,n){let i=t.low-n.low,r=t.high-n.high;const s=i>>>0;return s!==i&&(r-=1),e.low=s,e.high=r>>>0,e}static absDifference(e,t,n){return Ds.less(t,n)?Ds.subtract(e,n,t):Ds.subtract(e,t,n)}static multiplyUint32(e,t,n){const i=t.low,r=t.high;return e.low=ws(i,n)>>>0,e.high=ws(r,n)+Is(i,n)>>>0,e}static lowMask(e,t){return 0===t?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+4294967296*this.high}setFromNumber(e){(e=Math.round(e))<0?this.low=this.high=0:e>=0x10000000000000000?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}}Ds.ZERO=new Ds(0,0),Ds.ONE=new Ds(1,0);const Ms=Object.freeze(Object.defineProperty({__proto__:null,Uint64:Ds},Symbol.toStringTag,{value:"Module"})),Ps={[sr.UINT8]:[0,255],[sr.INT8]:[-128,127],[sr.UINT16]:[0,65535],[sr.INT16]:[-32768,32767],[sr.UINT32]:[0,4294967295],[sr.INT32]:[-2147483648,2147483647],[sr.UINT64]:[Ds.ZERO,new Ds(4294967295,4294967295)],[sr.FLOAT32]:[0,1]};function As(e,t){if("number"==typeof t){const n=e[0];return(t-n)/(e[1]-n)}{const n=e[0],i=e[1];let r;r=Ds.compare(t,n)<0?-Ds.subtract(Fs,n,t).toNumber():Ds.subtract(Fs,t,n).toNumber();let s=Ds.absDifference(Fs,i,n).toNumber();return Ds.compare(n,i)>0&&(s*=-1),r/s}}function Rs(e,t,n){if("number"==typeof e[0]){let i=e[0]*(1-n)+e[1]*n;if(t!==sr.FLOAT32){const e=Ps[t];i=Math.round(i),i=Math.max(e[0],i),i=Math.min(e[1],i)}return i}{let t=e[0],r=e[1];if(Ds.compare(t,r)>0){var i=[r,t];t=i[0],r=i[1],n=1-n}const s=Ds.subtract(Fs,r,t).toNumber(),o=new Ds;return n<=0?(Fs.setFromNumber(s*-n),Ds.subtract(o,t,Ds.min(Fs,t))):n>=1?(Fs.setFromNumber(s*(n-1)),Ds.add(o,r,Fs),Ds.less(o,r)&&(o.low=o.high=4294967295)):(Fs.setFromNumber(s*n),Ds.add(o,t,Fs),Ds.less(o,t)&&(o.low=o.high=4294967295)),o}}function Ns(e,t){return"number"==typeof t?Math.min(Math.max(e[0],t),e[1]):Ds.min(Ds.max(e[0],t),e[1])}function Vs(e,t){return[Ns(e,t[0]),Ns(e,t[1])]}function Os(e){if(_s(e[0],e[1])<=0)return e;throw new Error(`Invalid interval: [${e[0]}, ${e[1]}]`)}function Bs(e){return _s(e[0],e[1])<=0?e:[e[1],e[0]]}function _s(e,t){return"number"==typeof e?e-t:Ds.compare(e,t)}const Fs=new Ds,zs=new Ds;function Us(e,t){let n;switch(n="string"!=typeof t?""+t:t,e){case sr.UINT64:return Ds.parseString(n);case sr.FLOAT32:{const e=parseFloat(n);if(!Sr(e))throw new Error(`Invalid float32 value: ${Bt(n)}`);return e}default:{const t=parseInt(n),i=Ps[e];if(!mr(t)||t<i[0]||t>i[1])throw new Error(`Invalid ${sr[e].toLowerCase()} value: ${Bt(n)}`);return t}}}function Gs(e,t){return qr(new Array(2),e,(e=>Us(t,e)))}function Ws(e,t,n){return e===sr.UINT64?Ds.equal(t[0],n[0])&&Ds.equal(t[1],n[1]):t[0]===n[0]&&t[1]===n[1]}function $s(e,t){if(!Ws(t,e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ps[t]))return t===sr.UINT64?[e[0].toString(),e[1].toString()]:e}function js(e,t,n){switch(e){case sr.FLOAT32:return function(e,t){if(isNaN(e)||isNaN(t))return NaN;if(e===t)return t;if(0===e)return t<0?-gs:gs;ms[0]=e;const n=ur===dr.LITTLE?0:1,i=1-n;return t>e==e>0?4294967295===vs[n]?(vs[n]=0,vs[i]+=1):vs[n]+=1:0===vs[n]?(vs[n]=4294967295,vs[i]-=1):vs[n]-=1,ms[0]}(t,n*(1/0));case sr.UINT64:const i=t;return-1===n?0===i.low&&0===i.high?i:Ds.decrement(new Ds,i):4294967295===i.low&&4294967295===i.high?i:Ds.increment(new Ds,i);default:{const i=Ps[e];return Math.max(i[0],Math.min(i[1],t+n))}}}function Hs(e,t){switch(e){case sr.FLOAT32:return 1;case sr.UINT64:{const e=Ds.absDifference(Fs,t[0],t[1]).toNumber();return e/(e+1)}default:{const e=Math.abs(t[0]-t[1]);return e/(e+1)}}}function Js(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:128;const t=Math.ceil(e/32),n=new Uint32Array(t);crypto.getRandomValues(n);let i="";for(let r=0;r<t;++r)i+=("00000000"+n[r].toString(16)).slice(-8);return i}function qs(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}class Ys extends Sn{constructor(e){super(),this.id=e,this.changed=new kn}addRef(){return super.addRef()}dispose(){super.dispose()}}var Zs;!function(e){e[e.POINT=0]="POINT",e[e.LINE=1]="LINE",e[e.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",e[e.ELLIPSOID=3]="ELLIPSOID",e[e.SPHERE=4]="SPHERE"}(Zs||(Zs={}));const Xs=[Zs.POINT,Zs.LINE,Zs.AXIS_ALIGNED_BOUNDING_BOX,Zs.ELLIPSOID,Zs.SPHERE],Ks={rgb:{serializedBytes:()=>3,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, true);dv.setUint8(${t} + 2, ${e} >>> 16);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, true) | (dv.getUint8(${t} + 2) << 16);`,deserializeJson:e=>Yi(qi(e)),serializeJson:e=>Ki(Zi(e))},rgba:{serializedBytes:()=>4,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, true);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, true);`,deserializeJson:e=>Yi(Ji(e)),serializeJson:e=>Ki(Xi(e))},float32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setFloat32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getFloat32(${t}, isLittleEndian);`,deserializeJson:e=>kr(e),serializeJson:e=>e},uint32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setUint32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint32(${t}, isLittleEndian);`,deserializeJson:e=>Zr(e),serializeJson:e=>e},int32:{serializedBytes:()=>4,alignment:()=>4,serializeCode:(e,t)=>`dv.setInt32(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt32(${t}, isLittleEndian);`,deserializeJson:e=>Zr(e),serializeJson:e=>e},uint16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setUint16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getUint16(${t}, isLittleEndian);`,deserializeJson:e=>Zr(e),serializeJson:e=>e},int16:{serializedBytes:()=>2,alignment:()=>2,serializeCode:(e,t)=>`dv.setInt16(${t}, ${e}, isLittleEndian);`,deserializeCode:(e,t)=>`${e} = dv.getInt16(${t}, isLittleEndian);`,deserializeJson:e=>Zr(e),serializeJson:e=>e},uint8:{serializedBytes:()=>1,alignment:()=>1,serializeCode:(e,t)=>`dv.setUint8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getUint8(${t});`,deserializeJson:e=>Zr(e),serializeJson:e=>e},int8:{serializedBytes:()=>2,alignment:()=>1,serializeCode:(e,t)=>`dv.setInt8(${t}, ${e});`,deserializeCode:(e,t)=>`${e} = dv.getInt8(${t});`,deserializeJson:e=>Zr(e),serializeJson:e=>e}};function Qs(e,t,n){let i=0;const r=n.length,s=new Array(r),o=[];for(let h=0;h<r;++h)s[h]=h;const a=t=>Ks[n[t].type].alignment(e);s.sort(((e,t)=>a(t)-a(e)));let l=0;const c=new Array(r);let d=t;const u=()=>{d+=(4-d%4)%4,i+=d,o[l]=d,d=0,++l};for(let h=0;h<r;++h){const t=s[h],i=n[t],r=Ks[i.type],o=r.serializedBytes(e),a=r.alignment(e),p=(a-d%a)%a,f=d+p+o;f+(4-f%4)%4<=255?d+=p:u(),c[t]={offset:d,group:l},d+=o}return u(),{serializedBytes:i,offsets:c,propertyGroupBytes:o}}class eo{constructor(e,t,n){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=n,0===n.length)return this.serializedBytes=t,this.serialize=this.deserialize=()=>{},void(this.propertyGroupBytes=[t]);var i=Qs(e,t,n);const r=i.serializedBytes,s=i.offsets,o=i.propertyGroupBytes;this.propertyGroupBytes=o;let a="let groupOffset0 = offset;";for(let h=1;h<o.length;++h)a+=`let groupOffset${h} = groupOffset${h-1} + ${o[h-1]}*annotationCount;`;for(let h=0;h<o.length;++h)a+=`groupOffset${h} += ${o[h]}*annotationIndex;`;let l=a,c=a;const d=n.length;for(let h=0;h<d;++h){var u=s[h];const t=u.group,i=u.offset,r=n[h],o=Ks[r.type],a=`properties[${h}]`,d=`groupOffset${t} + ${i}`;l+=o.serializeCode(a,d,e),c+=o.deserializeCode(a,d,e)}this.serializedBytes=r,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",l),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",c)}}function to(e,t){const n=[];for(const i of Xs){const r=po[i];n[i]=new eo(e,r.serializedBytes(e),t)}return n}function no(e,t){const n="float32"===e.type?t.toPrecision(6):t.toString(),i=e.enumValues,r=e.enumLabels;if(void 0!==i){const e=i.indexOf(t);if(-1!==e)return`${r[e]} (${n})`}return n}function io(e){const t=es(e);if(null===t.match(/^[a-z][a-zA-Z0-9_]*$/))throw new Error(`Invalid property identifier: ${Bt(e)}`);return t}function ro(e){if(es(e),!Object.prototype.hasOwnProperty.call(Ks,e))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return e}function so(e){Yr(e);const t=ns(e,"id",io),n=ns(e,"type",ro),i=is(e,"description",es);let r,s,o=is(e,"default",(e=>Ks[n].deserializeJson(e)),0);switch(n){case"rgb":case"rgba":break;default:{const t=sr[n.toUpperCase()];r=is(e,"enum_values",(e=>Jr(e,(e=>Us(t,e))))),void 0!==r&&(s=ns(e,"enum_labels",(e=>qr(new Array(r.length),e,es))))}}return{type:n,identifier:t,description:i,default:o,enumValues:r,enumLabels:s}}function oo(e){const t=e.default;return{id:e.identifier,description:e.description,type:e.type,default:0===t?void 0:Ks[e.type].serializeJson(t)}}function ao(e){if(void 0===e)return[];const t=Jr(e,so);return function(e){const t=new Rt;for(const n of e){if(t.has(n.identifier))throw new Error(`Duplicate property identifier: ${n.identifier}`);t.add(n.identifier)}}(t),t}function lo(e,t,n,i,r){for(let s=0;s<i;++s)e.setFloat32(t,r[s],n),t+=4;return t}function co(e,t,n,i,r,s){return t=lo(e,t,n,i,r),t=lo(e,t,n,i,s)}function uo(e,t,n,i,r){for(let s=0;s<i;++s)r[s]=e.getFloat32(t,n),t+=4;return t}function ho(e,t,n,i,r,s){return t=uo(e,t,n,i,r),t=uo(e,t,n,i,s)}const po={[Zs.LINE]:{icon:"\ua579",description:"Line",toJSON:e=>({pointA:It(e.pointA),pointB:It(e.pointB)}),restoreState(e,t,n){e.pointA=ns(t,"pointA",(e=>qr(new Float32Array(n),e,Tr))),e.pointB=ns(t,"pointB",(e=>qr(new Float32Array(n),e,Tr)))},serializedBytes:e=>8*e,serialize(e,t,n,i,r){co(e,t,n,i,r.pointA,r.pointB)},deserialize:(e,t,n,i,r)=>{const s=new Float32Array(i),o=new Float32Array(i);return ho(e,t,n,i,s,o),{type:Zs.LINE,pointA:s,pointB:o,id:r,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},[Zs.SPHERE]:{icon:"\u2296",description:"Sphere",toJSON:e=>({pointA:It(e.pointA),pointB:It(e.pointB)}),restoreState(e,t,n){e.pointA=ns(t,"pointA",(e=>qr(new Float32Array(n),e,Tr))),e.pointB=ns(t,"pointB",(e=>qr(new Float32Array(n),e,Tr)))},serializedBytes:e=>8*e,serialize(e,t,n,i,r){co(e,t,n,i,r.pointA,r.pointB)},deserialize:(e,t,n,i,r)=>{const s=new Float32Array(i),o=new Float32Array(i);return ho(e,t,n,i,s,o),{type:Zs.SPHERE,pointA:s,pointB:o,id:r,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},[Zs.POINT]:{icon:"\u26ac",description:"Point",toJSON:e=>({point:It(e.point)}),restoreState:(e,t,n)=>{e.point=ns(t,"point",(e=>qr(new Float32Array(n),e,Tr)))},serializedBytes:e=>4*e,serialize:(e,t,n,i,r)=>{lo(e,t,n,i,r.point)},deserialize:(e,t,n,i,r)=>{const s=new Float32Array(i);return uo(e,t,n,i,s),{type:Zs.POINT,point:s,id:r,properties:[]}},visitGeometry(e,t){t(e.point,!1)}},[Zs.AXIS_ALIGNED_BOUNDING_BOX]:{icon:"\u2751",description:"Bounding Box",toJSON:e=>({pointA:It(e.pointA),pointB:It(e.pointB)}),restoreState:(e,t,n)=>{e.pointA=ns(t,"pointA",(e=>qr(new Float32Array(n),e,Tr))),e.pointB=ns(t,"pointB",(e=>qr(new Float32Array(n),e,Tr)))},serializedBytes:e=>8*e,serialize(e,t,n,i,r){co(e,t,n,i,r.pointA,r.pointB)},deserialize:(e,t,n,i,r)=>{const s=new Float32Array(i),o=new Float32Array(i);return ho(e,t,n,i,s,o),{type:Zs.AXIS_ALIGNED_BOUNDING_BOX,pointA:s,pointB:o,id:r,properties:[]}},visitGeometry(e,t){t(e.pointA,!1),t(e.pointB,!1)}},[Zs.ELLIPSOID]:{icon:"\u25ce",description:"Ellipsoid",toJSON:e=>({center:It(e.center),radii:It(e.radii)}),restoreState:(e,t,n)=>{e.center=ns(t,"center",(e=>qr(new Float32Array(n),e,Tr))),e.radii=ns(t,"radii",(e=>qr(new Float32Array(n),e,Er)))},serializedBytes:e=>8*e,serialize(e,t,n,i,r){co(e,t,n,i,r.center,r.radii)},deserialize:(e,t,n,i,r)=>{const s=new Float32Array(i),o=new Float32Array(i);return ho(e,t,n,i,s,o),{type:Zs.ELLIPSOID,center:s,radii:o,id:r,properties:[]}},visitGeometry(e,t){t(e.center,!1),t(e.radii,!0)}}};function fo(e,t){const n=po[e.type].toJSON(e,t.rank);n.type=Zs[e.type].toLowerCase(),n.id=e.id,n.description=e.description||void 0;const i=e.relatedSegments;if(void 0!==i&&i.some((e=>0!==e.length))&&(n.segments=i.map((e=>e.map((e=>e.toString()))))),0!==t.properties.length){const i=t.properties;n.props=e.properties.map(((e,t)=>Ks[i[t].type].serializeJson(e)))}return n}class go extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];super(),this.relationships=t,this.properties=n,this.annotationMap=new pt,this.changed=new kn,this.readonly=!1,this.childAdded=new Cn,this.childUpdated=new Cn,this.childDeleted=new Cn,this.childRefreshed=new kn,this.pending=new Rt,this.references=new pt,this.rank_=e,this.annotationPropertySerializers=to(e,n)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.ensureUpdated(),e.id){if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${Bt(e.id)}.`)}else e.id=vo();return this.annotationMap.set(e.id,e),this.changed.dispatch(),this.childAdded.dispatch(e),t||this.pending.add(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();const t=e.id;this.pending.delete(t),this.changed.dispatch()}update(e,t){if(this.ensureUpdated(),null===e.value)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[i.bm](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){null!==e.value&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return void 0!==t?t.addRef():(t=new Ys(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer((()=>{this.references.delete(e)})),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();const e=[],t=this.pending;for(const n of this)t.has(n.id)||e.push(fo(n,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();const t=this.annotationMap;t.clear(),this.pending.clear(),void 0!==e&&Jr(e,(e=>{const n=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Yr(e);const i=ns(e,"type",(e=>ls(e,Zs))),r=ns(e,"id",n?ts:es)||vo(),s=ns(e,"segments",(e=>{if(void 0===e)return t.relationships.map((()=>[]));const n=Hr(e);return 0===n.length?t.relationships.map((()=>[])):1!==t.relationships.length||Array.isArray(n[0])?Jr(Hr(e,t.relationships.length),(e=>Jr(e,(e=>Ds.parseString(e))))):[Jr(n,(e=>Ds.parseString(e)))]})),o=ns(e,"props",(e=>{const n=t.properties;return void 0===e?n.map((e=>e.default)):Jr(Hr(e,t.properties.length),((e,t)=>Ks[n[t].type].deserializeJson(e)))})),a={id:r,description:ns(e,"description",ts),relatedSegments:s,properties:o,type:i};return po[i].restoreState(a,e,t.rank),a}(e,this);t.set(n.id,n)}));for(const n of this.references.values()){const e=n.id,i=t.get(e);n.value=i||null,n.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class mo extends go{constructor(e,t,n){super(e.value.sourceRank,n,t),this.watchableTransform=e,this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add((()=>this.ensureUpdated())))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){const e=this.watchableTransform.value,t=this.curCoordinateTransform;if(e===t)return;this.curCoordinateTransform=e;const n=e.sourceRank,i=t.sourceRank;if(i===n&&(t.inputSpace===e.inputSpace||Ut(t.inputSpace.ids.slice(0,n),e.inputSpace.ids.slice(0,n))))return;const r=e.inputSpace.ids,s=t.inputSpace.ids,o=[];for(let l=0;l<n;++l){let e=s.indexOf(r[l]);e>=i&&(e=-1),o.push(e)}const a=e=>{const t=new Float32Array(n);for(let i=0;i<n;++i){const n=o[i];t[i]=-1===n?0:e[i]}return t};for(const l of this.annotationMap.values())switch(l.type){case Zs.POINT:l.point=a(l.point);break;case Zs.LINE:case Zs.SPHERE:case Zs.AXIS_ALIGNED_BOUNDING_BOX:l.pointA=a(l.pointA),l.pointB=a(l.pointB);break;case Zs.ELLIPSOID:l.center=a(l.center),l.radii=a(l.radii)}this.rank_!==n&&(this.rank_=n,this.annotationPropertySerializers=to(this.rank_,this.properties)),this.changed.dispatch()}}function vo(){return Js(160)}function yo(e){const t=new go(e.lowerBounds.length);return t.readonly=!0,t.add(function(e){return{type:Zs.AXIS_ALIGNED_BOUNDING_BOX,id:"data-bounds",description:"Data Bounds",pointA:new Float32Array(e.lowerBounds),pointB:new Float32Array(e.upperBounds),properties:[]}}(e)),t}class bo{constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return function(e,t){let n=0;const i=[];for(const c of Xs){const r=t[c].serializedBytes;i[c]=n,n+=r*e[c].length}const r=[],s=[],o=new ArrayBuffer(n),a=new DataView(o),l=ur===dr.LITTLE;for(const c of Xs){const n=t[c],o=n.rank,d=n.serialize,u=e[c];r[c]=u.map((e=>e.id)),s[c]=new pt(u.map(((e,t)=>[e.id,t])));const h=po[c].serialize,p=i[c],f=n.propertyGroupBytes[0];for(let e=0,t=u.length;e<t;++e){const n=u[e];h(a,p+e*f,l,o,n),d(a,p,e,t,l,n.properties)}}return{data:new Uint8Array(o),typeToIds:r,typeToOffset:i,typeToIdMaps:s}}(this.annotations,this.propertySerializers)}}function So(e){if(null==e)return e;const t=e.relatedSegments;if(void 0!==t)for(let n=0,i=t.length;n<i;++n){const e=t[n];void 0!==e&&(t[n]=e.map((e=>new Ds(e.low,e.high))))}return e}function wo(e,t,n,i,r,s,o,a,l){for(let c=0;c<o;++c)for(let o=0;o<l;++o){let l=0;for(let e=0;e<a;++e)l+=n[c+i*e]*r[e+s*o];e[c+t*o]=l}return e}function xo(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;return function(e,t,n){for(let i=0;i<n;++i){const r=t*i;e.fill(0,r,r+n),e[r+i]=1}return e}(new e(t*n),t,Math.min(t,n))}function Co(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=t.length,r=n?i+1:i,s=new e(r*(i+1));n&&(s[s.length-1]=1);for(let o=0;o<i;++o)s[(r+1)*o]=t[o];return s}function ko(e,t,n,i,r,s){for(let o=0;o<s;++o){const s=o*i,a=o*t;for(let t=0;t<r;++t)e[a+t]=n[s+t]}return e}function To(e,t,n,i){ko(e,t+1,n,i+1,i,i);for(let r=0;r<i;++r)e[(t+1)*t+r]=n[(i+1)*i+r];e[e.length-1]=1;for(let r=i;r<t;++r)e[(t+1)*r+r]=1;return e}let Eo;function Lo(e,t,n,i,r){return ko(e,t,n,i,r,r),function(e,t,n){let i=1;(void 0===Eo||Eo.length<n)&&(Eo=new Uint32Array(n));for(let r=0;r<n;++r)Eo[r]=r;for(let r=0;r<n;++r){const s=t*r;let o=r;{let t=Math.abs(e[s+r]);for(let i=r+1;i<n;++i){const n=Math.abs(e[s+i]);n>t&&(t=n,o=i)}}if(r!==o){i*=-1;for(let i=0;i<n;++i){const n=t*i,s=e[n+r];e[n+r]=e[n+o],e[n+o]=s}{const e=Eo[r];Eo[r]=Eo[o],Eo[o]=e}}const a=e[s+r],l=1/a;i*=a;for(let i=0;i<n;++i)e[t*i+r]*=l;e[s+r]=l;for(let i=0;i<n;++i){if(i===r)continue;const s=-e[t*r+i];for(let o=0;o<n;++o){const n=t*o;e[n+i]+=s*e[n+r]}e[t*r+i]=s*l}}for(let r=0;r<n;++r){let i=Eo[r];for(;i!==r;){const s=t*r,o=t*i;for(let t=0;t<n;++t){const n=s+t,i=o+t,r=e[n];e[n]=e[i],e[i]=r}const a=Eo[r]=Eo[i];Eo[i]=i,i=a}}return i}(e,t,r)}function Io(e,t,n,i,r){for(let s=0;s<r;++s){let o=t[n*r+s];for(let e=0;e<r;++e)o+=t[n*e+s]*i[e];e[s]=o}return e}function Do(e,t,n,i,r){for(let s=0;s<r;++s){let o=0;for(let e=0;e<r;++e)o+=t[n*e+s]*i[e];e[s]=o}return e}var Mo=i.aV;Mo(Mo.S,"Math",{log10:function(e){return Math.log(e)*Math.LOG10E}});var Po={default:i.aW.Math.log10,__esModule:!0};const Ao=(0,i.g)(Po),Ro=[{prefix:"Y",exponent:24},{prefix:"Z",exponent:21},{prefix:"E",exponent:18},{prefix:"P",exponent:15},{prefix:"T",exponent:12},{prefix:"G",exponent:9},{prefix:"M",exponent:6},{prefix:"k",exponent:3},{prefix:"",exponent:0},{prefix:"m",exponent:-3},{prefix:"\xb5",exponent:-6},{prefix:"n",exponent:-9},{prefix:"p",exponent:-12},{prefix:"f",exponent:-15},{prefix:"a",exponent:-18},{prefix:"z",exponent:-21},{prefix:"y",exponent:-24}],No=[{prefix:"c",exponent:-2},{prefix:"u",exponent:-6},...Ro],Vo=new pt;Vo.set("",{unit:"",exponent:0});const Oo=new pt;for(const iV of No){const e=iV.prefix,t=iV.exponent;Oo.set(t,e);for(const n of["m","s","Hz","rad/s"])Vo.set(`${e}${n}`,{unit:n,exponent:t})}function Bo(e){const t=Ao(e),n=Ro.length,i=function(e,t,n){let i=t-e;for(;i>0;){let t=Math.floor(i/2),r=e+t;n(r)?i=t:(e=r+1,i-=t+1)}return e}(0,n,(e=>Ro[e].exponent<=t));return Ro[Math.min(i,n-1)]}function _o(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var i=n.precision;const r=void 0===i?6:i;var s=n.elide1;const o=void 0===s||s;let a,l=e,c="";if(""!==t){const t=Bo(e);c=t.prefix,l=Go(e,-t.exponent)}if(o&&1===l)return{scale:"",unit:t,prefix:c};if(0!=r){a=l<1||l>=1e3?l.toPrecision(r):l.toFixed(r);const e=a.indexOf("e");let t,n;-1!==e?(t=a.substring(0,e),n=a.substring(e)):(t=a,n="");const i=t.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);null!==i&&(t=t.substring(0,t.length-i[1].length),t.endsWith(".")&&(t=t.substring(0,t.length-1)),a=t+n)}else a=l.toString();return{scale:a,unit:t,prefix:c}}function Fo(e,t,n){var i=_o(e,t,n);const r=i.scale,s=i.unit;return`${r}${i.prefix}${s}`}function zo(e){if(""===e)return{scale:1,unit:""};const t=e.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([\xb5a-zA-Z]+)?$/);if(null===t)return;const n=t[1];let i=void 0===n?1:Number(n);if(Cr(i))return;let r="";if(void 0!==t[2]){const e=Vo.get(t[2]);if(void 0===e)return;r=e.unit,e.exponent>0?i*=10**e.exponent:i/=10**-e.exponent}return i<=0||!Sr(i)?void 0:{scale:i,unit:r}}function Uo(e){const t=Vo.get(e);if(void 0===t)throw new Error(`Invalid unit: ${Bt(e)}`);return t}function Go(e,t){return t>=0?e*10**t:e/10**-t}function Wo(e,t,n){const i=e.length;for(let r=0;r<i;++r)e[r]=t[r]+n[r];return e}function $o(e,t,n){const i=e.length;for(let r=0;r<i;++r)e[r]=t[r]-n[r];return e}function jo(e){let t=1;for(let n=0,i=e.length;n<i;++n)t*=e[n];return t}function Ho(e,t,n){const i=e.length;for(let r=0;r<i;++r)e[r]=Math.min(t[r],n[r]);return e}const Jo=new Float32Array(0),qo=new Float64Array(0);let Yo=0;function Zo(){return++Yo}function Xo(e,t){return void 0===e?void 0===t:void 0!==t&&(e.explicit===t.explicit&&Ut(e.coordinates,t.coordinates)&&Ut(e.labels,t.labels))}function Ko(e,t){const n=new pt;for(let i=0,r=e.length;i<r;++i)n.set(e[i],t[i]);return(e=It(n.keys())).sort(((e,t)=>e-t)),{coordinates:e,labels:t=It(e,(e=>n.get(e)))}}function Qo(e){if(1===e.length)return e[0];const t=new pt;let n=!1;for(const r of e){r.explicit&&(n=!0);const e=r.coordinates,i=r.labels;for(let n=0,r=e.length;n<r;++n)t.set(e[n],i[n])}const i=It(t.keys());i.sort(((e,t)=>e-t));return{explicit:n,coordinates:i,labels:It(i,(e=>t.get(e)))}}function ea(e){if(0!==(e=e.filter((e=>void 0!==e))).length)return Qo(e)}function ta(e,t){return Ut(e.transform,t.transform)&&function(e,t){return Ut(e.lowerBounds,t.lowerBounds)&&Ut(e.upperBounds,t.upperBounds)}(e.box,t.box)}function na(e,t){return e.valid===t.valid&&e.rank===t.rank&&Ut(e.names,t.names)&&Ut(e.ids,t.ids)&&Ut(e.timestamps,t.timestamps)&&Ut(e.units,t.units)&&Ut(e.scales,t.scales)&&Gt(e.boundingBoxes,t.boundingBoxes,ta)&&Gt(e.coordinateArrays,t.coordinateArrays,Xo)}function ia(e){const t=e.names,n=e.units,i=e.scales;var r=e.valid;const s=void 0===r||r;var o=e.rank;const a=void 0===o?t.length:o;var l=e.timestamps;const c=void 0===l?t.map((()=>Number.NEGATIVE_INFINITY)):l;var d=e.ids;const u=void 0===d?t.map(((e,t)=>-t)):d;var h=e.boundingBoxes;const p=void 0===h?[]:h;var f=e.coordinateArrays;const g=void 0===f?new Array(a):f;var m=e.bounds;const v=void 0===m?function(e,t){const n=new Float64Array(t),i=new Float64Array(t);n.fill(Number.NEGATIVE_INFINITY),i.fill(Number.POSITIVE_INFINITY);for(const r of e)for(let e=0;e<t;++e){const s=ha(r,e,t);if(void 0===s)continue;const o=s.lower,a=s.upper;n[e]=n[e]===Number.NEGATIVE_INFINITY?o:Math.min(n[e],o),i[e]=i[e]===Number.POSITIVE_INFINITY?a:Math.max(i[e],a)}return{lowerBounds:n,upperBounds:i}}(p,a):m;return{valid:s,rank:a,names:t,timestamps:c,ids:u,units:n,scales:i,boundingBoxes:p,bounds:v,coordinateArrays:g}}const ra=ia({valid:!1,names:[],units:[],scales:qo,boundingBoxes:[]}),sa=ia({valid:!0,names:[],units:[],scales:qo,boundingBoxes:[]});function oa(e){var t=Hr(e,2),n=O(t,2);const i=n[0],r=n[1],s=Lr(i),o=es(r),a=Vo.get(o);if(void 0===a)throw new Error(`Invalid unit: ${Bt(o)}`);return{unit:a.unit,scale:Go(s,a.exponent)}}function aa(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(void 0===e)return ra;Yr(e);const n=Ma(f(e),t),r=n.length,s=new Array(r),o=new Float64Array(r),a=new Array(r);for(let l=0;l<r;++l)ns(e,n[l],(e=>{if(Array.isArray(e)){var t=oa(e);const n=t.unit,i=t.scale;s[l]=n,o[l]=i}else{Yr(e);let t=ns(e,"coordinates",us),n=ns(e,"labels",ds),r=t.length;if(r!==n.length)throw new Error(`Length of coordinates array (${r}) does not match length of labels array (${n.length})`);s[l]="",o[l]=1,a[l]=(0,i.bn)({explicit:!0},Ko(t,n))}}));return ia({valid:!1,names:n,units:s,scales:o,coordinateArrays:a})}function la(e){const t=e.rank;if(0===t)return;const n=e.names,i=e.units,r=e.scales,s=e.coordinateArrays,o={};for(let a=0;a<t;++a){const e=n[a],t=s[a];o[e]=t?.explicit?{coordinates:It(t.coordinates),labels:t.labels}:[r[a],i[a]]}return o}class ca extends En{constructor(){super(ra)}toJSON(){return la(this.value)}reset(){this.value=ra}restoreState(e){this.value=aa(e)}}function da(e,t){let n=(e+t)/2;return Sr(n)||(n=Math.min(Math.max(0,e),t)),n}function ua(e){const t=e.lowerBounds.length;return{box:e,transform:xo(Float64Array,t,t+1)}}function ha(e,t,n){var i=e.box;const r=i.lowerBounds,s=i.upperBounds,o=e.transform,a=r.length,l=n,c=o[l*a+t];let d=c,u=c,h=!1;for(let p=0;p<a;++p){let e=o[l*p+t];if(0===e)continue;const n=e*r[p],i=e*s[p];d+=Math.min(n,i),u+=Math.max(n,i),h=!0}if(h)return{lower:d,upper:u}}function pa(e,t,n){const i=e.transform,r=e.box,s=n.length,o=r.lowerBounds.length,a=new Float64Array((o+1)*t);for(let l=0;l<s;++l){const e=n[l];if(-1!==e)for(let n=0;n<=o;++n)a[n*t+e]=i[n*s+l]}return{transform:a,box:r}}function fa(e,t){const n={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},i=new Float64Array(2*e);return i[t]=1,{transform:i,box:n}}function ga(e,t,n){if(t===n)return e;const i=e.box,r=i.lowerBounds.length,s=new Float64Array((r+1)*n);return ko(s,n,e.transform,t,t,r+1),{box:i,transform:s}}function ma(e){return{rank:e.rank,sourceRank:e.rank,inputSpace:e,outputSpace:e,transform:xo(Float64Array,e.rank+1)}}function va(e,t,n){return e.boundingBoxes.map((i=>function(e,t,n,i){let r=e.transform,s=e.box;const o=e.box.lowerBounds.length,a=i.length,l=new Float64Array((o+1)*a);for(let c=0;c<a;++c){const e=i[c];for(let i=0;i<o;++i){let s=0;for(let o=0;o<a;++o){const l=n[o];s+=t[(a+1)*o+c]*r[a*i+o]*(l/e)}l[a*i+c]=s}let s=t[(a+1)*a+c];for(let i=0;i<a;++i){const l=n[i];s+=t[(a+1)*i+c]*r[a*o+i]*(l/e)}l[o*a+c]=s}return{transform:l,box:s}}(i,t,e.scales,n)))}function ya(e,t,n){const i=ia({valid:e.valid,rank:n.rank,ids:n.ids,names:n.names,timestamps:n.timestamps,scales:n.scales,units:n.units,boundingBoxes:va(e,t,n.scales),coordinateArrays:n.coordinateArrays});return na(i,n)?n:i}function ba(e){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1]){const t=Number(e);if(mr(t)&&t>=0)return!0}return null!==e.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)}function Sa(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new Rt;for(const i of e){if(!ba(i,t)||n.has(i))return!1;n.add(i)}return!0}function wa(e){const t=e.length,n=new Array(t);n.fill(!0);for(let i=0;i<t;++i){const t=e[i];if(!ba(t)){n[i]=!1;continue}const r=e.indexOf(t,i+1);-1!==r&&(n[i]=!1,n[r]=!1)}return n}function xa(e){return e.endsWith("'")}function Ca(e){return e.endsWith("'")||e.endsWith("^")}function ka(e){return e.endsWith("^")}function Ta(e){return!Ca(e)}function Ea(e,t,n,i,r,s){if(!function(e,t,n,i,r,s){for(let o=0;o<s;++o){const s=t*o,a=i*o;for(let t=0;t<r;++t)if(e[s+t]!==n[a+t])return!1}return!0}(e,t+1,i,r+1,t,t))return!1;for(let o=0;o<t;++o){const a=e[(t+1)*t+o],l=i[(r+1)*r+o];if(a*(n[o]/s[o])!==l)return!1}for(let o=t;o<r;++o)if(0!==i[(r+1)*r+o])return!1;for(let o=t;o<r;++o){for(let e=0;e<t;++e)if(0!==i[(r+1)*e+o])return!1;for(let e=0;e<r;++e){const t=i[(r+1)*o+e];if(o===e){if(1!==t)return!1}else if(0!==t)return!1}}return!0}function La(e,t){if(!t.includes(e))return e;var n=e.match(/^([^']*)('?)$/),i=O(n,3);const r=i[1],s=i[2];for(let o=0;;++o){const e=`${r}${o}${s}`;if(!t.includes(e))return e}}function Ia(e){const t=ya(e.inputSpace,e.transform,e.outputSpace);return t===e.outputSpace?e:{rank:e.rank,sourceRank:e.sourceRank,inputSpace:e.inputSpace,transform:e.transform,outputSpace:t}}class Da{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.mutableSourceRank=t,this.value_=void 0,this.changed=new kn,this.inputSpaceChanged=new kn,this.defaultTransform=Ia(e);const n=this;this.outputSpace={changed:n.changed,get value(){return n.value.outputSpace},set value(e){const t=n.value;if(na(t.outputSpace,e)||t.rank!==e.rank)return;const i=function(e,t,n){const i=new Float64Array(e),r=t.length,s=(r+1)*r;for(let o=0;o<r;++o)i[s+o]*=t[o]/n[o];return i}(t.transform,t.outputSpace.scales,e.scales);n.value_={sourceRank:t.sourceRank,rank:t.rank,inputSpace:t.inputSpace,outputSpace:ya(t.inputSpace,i,e),transform:i},n.changed.dispatch()}},this.inputSpace={changed:n.inputSpaceChanged,get value(){return n.value.inputSpace},set value(e){const t=n.value;na(t.inputSpace,e)||(n.value_=function(e,t){const n=e.inputSpace,i=e.transform,r=n.ids,s=n.rank,o=t.rank,a=t.names,l=t.units,c=t.scales,d=new Array(s);d.fill(!0);const u=[],h=t.ids.map(((e,t)=>{const n=r.indexOf(e);return-1!==n?d[n]=!1:u.push(t),n})),p=e.outputSpace,f=p.names,g=p.units,m=p.scales,v=p.ids,y=p.timestamps,b=p.coordinateArrays,S=d,w=[],x=[],C=new Float64Array(o),k=[],T=[],E=new Array(o);let L=0;const I=new Float64Array((o+1)**2);I[I.length-1]=1;for(let M=0;M<s;++M)if(!S[M]){w[L]=f[M],k[L]=v[M],x[L]=g[M],C[L]=m[M],T[L]=y[M],E[L]=b[M];for(let e=0;e<o;++e){const t=h[e];-1!==t&&(I[e*(o+1)+L]=i[t*(s+1)+M])}I[o*(o+1)+L]=i[s*(s+1)+M],++L}for(const M of u)k[L]=Zo(),w[L]=La(a[M],w),C[L]=c[M],x[L]=l[M],I[M*(o+1)+L]=1,++L;const D=ia({valid:t.valid,rank:o,names:w,ids:k,timestamps:T,units:x,scales:C,boundingBoxes:va(t,I,C),coordinateArrays:E});return{rank:o,sourceRank:e.sourceRank,inputSpace:t,outputSpace:D,transform:I}}(t,e),n.inputSpaceChanged.dispatch(),n.changed.dispatch())}}}set value(e){const t=this.value;e!==t&&(this.value_=Ia(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let e=this.value_;return void 0===e&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){const e=this.value,t=e.rank,n=e.transform,i=e.inputSpace,r=e.outputSpace,s=e.sourceRank,o=this.defaultTransform,a=this.mutableSourceRank,l=o.inputSpace,c=o.rank,d=o.transform,u=o.outputSpace,h=i.units,p=i.scales,f=s===t&&Ut(p,a?r.scales:l.scales)&&Ut(h,a?r.units:l.units),g=Ea(d,c,u.scales,n,t,r.scales),m=Ut(u.names,r.names);if(!(g&&m&&f))return{sourceRank:s,transform:g?void 0:n,outputSpace:e.outputSpace,inputSpace:f?void 0:i}}set transform(e){const t=this.value,n=t.inputSpace;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:n,transform:e,outputSpace:ya(n,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(void 0===e)return void this.reset();if(this.mutableSourceRank){const t=e.inputSpace||e.outputSpace,n=t.rank,i=ia({rank:n,names:t.names.map(((e,t)=>`${t}`)),units:t.units,scales:t.scales,coordinateArrays:t.coordinateArrays});return void(this.value={rank:n,transform:e.transform||xo(Float64Array,n+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:i})}var t=this.defaultTransform;const n=t.inputSpace,r=t.sourceRank,s=t.outputSpace,o=t.transform,a=t.rank,l=e.inputSpace,c=e.sourceRank,d=e.outputSpace,u=e.transform,h=e.outputSpace.rank,p=n.names,f=void 0!==l?l.names:p,g=new Array(r);for(let i=0;i<r;++i){let e=f.indexOf(p[i]);e>=c&&(e=-1),g[i]=e}const m=h-c+r;for(let i=c;i<h;++i)g[r+i-c]=i;const v=new Float64Array(m),y=new Array(m),b=[];for(let i=0;i<r;++i){const e=g[i];-1===e||void 0===l?(v[i]=n.scales[i],b[i]=n.units[i],y[i]=n.coordinateArrays[i]):(v[i]=l.scales[e],b[i]=l.units[e],y[i]=ea([n.coordinateArrays[i],l.coordinateArrays[e]]))}const S=l||d,w=p.slice(0,r),x=s.names.slice(0,r),C=s.coordinateArrays.slice(0,r),k=new Float64Array(m),T=[];for(let i=0;i<m;++i){const e=g[i];-1===e?(k[i]=s.scales[i],T[i]=s.units[i],C[i]=s.coordinateArrays[i]):(x[i]=d.names[e],T[i]=d.units[e],k[i]=d.scales[e],C[i]=d.coordinateArrays[e])}if(!Sa(x))return void this.reset();for(let i=r;i<m;++i){const e=i-r+c;v[i]=S.scales[e],b[i]=S.units[e],w[i]=`${i}`}const E=new Float64Array((m+1)**2);E[E.length-1]=1;for(let i=0;i<m;++i){const e=g[i];let t;t=-1===e||void 0===u?i>=r?0:o[a*(a+1)+i]*(s.scales[i]/k[i]):u[h*(h+1)+e],E[m*(m+1)+i]=t;for(let n=0;n<m;++n){const t=g[n];let s;s=-1===e!=(-1===t)?0:-1===e||void 0===u?e>=r||t>=r?e===t?1:0:o[n*(a+1)+i]:u[t*(h+1)+e],E[n*(m+1)+i]=s}}const L=n.boundingBoxes.map((e=>ga(e,a,m)));for(let i=r;i<m;++i)L.push(fa(m,i));for(let I=0;I<m;++I){if(0!==E[m*(m+1)+I])continue;let e;for(let n=0;n<m;++n){const t=E[n*(m+1)+I];if(0!==t){if(1!==t){e=null;break}if(void 0!==e){e=null;break}e=n}}if(null==e)continue;let t=y[e];void 0!==t&&(t.explicit&&(t=(0,i.bn)((0,i.bn)({},t),{explicit:!1})),C[I]=ea([t,C[I]]))}this.value={rank:m,transform:E,sourceRank:r,outputSpace:ia({rank:m,names:x,scales:k,units:T,coordinateArrays:C}),inputSpace:ia({rank:m,names:w,scales:v,units:b,coordinateArrays:y,boundingBoxes:L})}}toJSON(){return Va(this.spec)}restoreState(e){this.spec=Na(e)}}function Ma(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=Jr(e,(e=>function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=es(e);if(!ba(n,t))throw new Error(`Invalid dimension name: ${Bt(n)}`);return n}(e,t)));if(!Sa(n,t))throw new Error(`Invalid dimensions: ${Bt(n)}`);return n}class Pa{constructor(e,t){this.combined=e,this.bindings=new Rt,this.retainCount=0,this.prevCombined=this.combined.value,this.dimensionRefCounts=new pt,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t}getRenameValidity(e){const t=this.combined.value.names,n=wa(e),i=e.length;for(let r=0;r<i;++r){if(!n[r])continue;const i=e[r];if(t.includes(i))continue;let s=!0;for(const e of this.bindings)if(e.space.value.names.includes(i)){s=!1;break}n[r]=s}return n}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){const e=this.combined,t=this.bindings,n=this.retainCount>0?1:0;if(0===t.size&&!n)return void(e.value=ra);const i=this.includeDimensionPredicate_,r=e.value;let s=It(r.names),o=It(r.units),a=It(r.scales),l=It(r.ids),c=It(r.timestamps),d=r.names.map((()=>n?1:0));const u=[];let h=!1;for(const S of t){const e=S.space.value,t=S.prevValue,r=S.mappedDimensionIds;h=h||e.valid;const p=e.names,f=e.units,g=e.scales,m=e.ids,v=e.timestamps,y=[],b=[];u.push(b),S.mappedDimensionIds=y,S.prevValue=e;const w=p.length;for(let u=0;u<w;++u){const e=p[u];if(!i(e))continue;if(void 0!==t){const n=m[u],i=t.ids.indexOf(n);if(-1!==i){const t=r[i];if(void 0!==t){const n=l.indexOf(t);if(-1!==n){y[u]=t,++d[n],b[u]=n;const i=v[u];void 0!==i&&!(i<=c[n])&&(s[n]=e,a[n]=g[u],o[n]=f[u],c[n]=i);continue}}}}let h=s.indexOf(e);if(-1!==h){y[u]=l[h],++d[h],b[u]=h;continue}h=s.length,b[u]=h,d[h]=1+n,s[h]=e,o[h]=f[u],a[h]=g[u],c[h]=v[u];const S=Zo();l[h]=S,y[u]=S}}const p=this.dimensionRefCounts;p.clear();let f=0,g=s.length;for(const S of t){const e=S.space.value,t=u[f++],n=e.rank,i=It(e.names),r=It(e.timestamps),l=Float64Array.from(e.scales),d=It(e.units);for(let u=0;u<n;++u){const e=t[u];void 0!==e&&(d[u]=o[e],l[u]=a[e],r[u]=c[e],i[u]=s[e])}for(const s of i){let e=p.get(s);void 0===e?e=1:++e,p.set(s,e)}if(!Ut(d,e.units)||!Ut(l,e.scales)||!Ut(i,e.names)||!Ut(r,e.timestamps)){const t=ia({valid:e.valid,ids:e.ids,scales:l,units:d,names:i,timestamps:r,boundingBoxes:e.boundingBoxes,coordinateArrays:e.coordinateArrays});S.prevValue=t,S.space.value=t}}{for(let t=0;t<g;++t)i(s[t])||(d[t]=0);const e=(e,t)=>0!==d[t];s=s.filter(e),o=o.filter(e),a=a.filter(e),l=l.filter(e),c=c.filter(e),d=d.filter(e),g=s.length}const m=[],v=new Array(g);for(let S=0,w=r.rank;S<w;++S){const e=r.coordinateArrays[S];if(!e?.explicit)continue;const t=l.indexOf(r.ids[S]);-1!==t&&(v[t]=[e])}for(const S of t){const e=S.space.value,t=e.rank,n=e.boundingBoxes,i=e.coordinateArrays,r=e.names.map((e=>s.indexOf(e)));for(const s of n)m.push(pa(s,g,r));for(let s=0;s<t;++s){const e=i[s];if(void 0===e)continue;const t=r[s],n=v[t];void 0===n?v[t]=[e]:n.push(e)}}const y=new Array(g);for(let S=0;S<g;++S){const e=v[S];void 0!==e&&(y[S]=Qo(e))}const b=ia({valid:h,ids:l,names:s,units:o,scales:new Float64Array(a),boundingBoxes:m,coordinateArrays:y});if(n)for(let S=0;S<g;++S)--d[S];na(r,b)||(this.prevCombined=b,e.value=b)}retain(){return++this.retainCount,()=>{0===--this.retainCount&&this.update()}}bind(e){const t={space:e,mappedDimensionIds:[],prevValue:void 0},n=this.bindings;0===n.size&&this.combined.changed.add(this.handleCombinedChanged),n.add(t);const i=e.changed.add((()=>{e.value!==t.prevValue&&this.update()}));return this.update(),()=>{i();const e=this.bindings;e.delete(t),0===e.size&&this.combined.changed.remove(this.handleCombinedChanged),this.update()}}}function Aa(e,t,n,i,r){const s=r.length,o=new e((s+1)**2);o[o.length-1]=1;for(let a=0;a<s;++a){const e=i[a];o[(s+1)*s+a]=t[(n+1)*n+e];for(let i=0;i<s;++i){const l=r[i];o[(s+1)*i+a]=t[(n+1)*l+e]}}return o}function Ra(e){if(void 0===e)return;const t=new Float64Array(16);if(Array.isArray(e))if(16===e.length)for(let n=0;n<4;++n)for(let i=0;i<4;++i)t[4*n+i]=Tr(e[4*i+n]);else{Hr(e,4);for(let n=0;n<4;++n){const i=Hr(e[n],4);for(let e=0;e<4;++e)t[4*e+n]=Tr(i[e])}}else{Yr(e);const n=bi(),i=ti(),r=ii(1,1,1);is(e,"rotation",(e=>{Dr(n,e),Ei(n,n)})),is(e,"translation",(e=>{Dr(i,e)})),is(e,"scale",(e=>{Dr(r,e)}));const s=qn();(function(e,t,n,i){var r=t[0],s=t[1],o=t[2],a=t[3],l=r+r,c=s+s,d=o+o,u=r*l,h=r*c,p=r*d,f=s*c,g=s*d,m=o*d,v=a*l,y=a*c,b=a*d,S=i[0],w=i[1],x=i[2];e[0]=(1-(f+m))*S,e[1]=(h+b)*S,e[2]=(p-y)*S,e[3]=0,e[4]=(h-b)*w,e[5]=(1-(u+m))*w,e[6]=(g+v)*w,e[7]=0,e[8]=(p+y)*x,e[9]=(g-v)*x,e[10]=(1-(u+f))*x,e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1})(s,n,i,r),t.set(s)}return{sourceRank:3,transform:t,outputSpace:ia({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function Na(e){if(void 0===e)return;const t=Yr(e),n=ns(t,"outputDimensions",aa),i=n.rank,r=ns(t,"sourceRank",(e=>{if(void 0===e)return i;if(!mr(e)||e<0||e>i)throw new Error(`Expected integer in range [0, ${i}] but received: ${Bt(e)}`);return e})),s=is(t,"inputDimensions",(e=>{const t=aa(e,!0);if(t.rank!==i)throw new Error(`Expected rank of ${i}, but received rank of: ${t.rank}`);return t}));return{transform:is(t,"matrix",(e=>{const t=new Float64Array((i+1)**2),n=Hr(e,i);t[t.length-1]=1;for(let s=0;s<i;++s)try{const e=Hr(n[s],i+1);for(let n=0;n<=i;++n)t[(i+1)*n+s]=Tr(e[n])}catch(r){throw new Error(`Error in row ${s}: ${r.message}`)}return t})),outputSpace:n,inputSpace:s,sourceRank:r}}function Va(e){if(void 0===e)return;const t=e.transform,n=e.outputSpace,i=e.inputSpace,r=e.sourceRank;let s;const o=n.rank;if(void 0!==t){s=[];for(let e=0;e<o;++e){const n=[];s[e]=n;for(let i=0;i<=o;++i)n[i]=t[(o+1)*i+e]}}return{sourceRank:r===o?void 0:r,matrix:s,outputDimensions:la(n),inputDimensions:void 0===i?void 0:la(i)}}function Oa(e,t){const n=e.ids,i=e.names,r=e.scales,s=e.units,o=e.timestamps,a=e.coordinateArrays;return ia({rank:t.length,valid:e.valid,ids:t.map((e=>n[e])),names:t.map((e=>i[e])),timestamps:t.map((e=>o[e])),scales:Float64Array.from(t,(e=>r[e])),units:t.map((e=>s[e])),coordinateArrays:t.map((e=>a[e])),boundingBoxes:e.boundingBoxes.map((n=>function(e,t,n){const i=e.box,r=e.transform,s=e.box.lowerBounds.length,o=t.length,a=new Float64Array((s+1)*o);for(let l=0;l<o;++l)for(let e=0;e<=s;++e){const i=t[l];a[l+e*o]=r[i+e*n]}if(!a.every((e=>0===e)))return{transform:a,box:i}}(n,t,e.rank))).filter((e=>void 0!==e))})}function Ba(e,t,n){return t===n?e:Oa(e,function(e,t,n){const i=[];if(n===t){for(let t=0;t<e;++t)i[t]=t;return i}i[n]=t;for(let r=0,s=0;r<e;)r!==t?(s===n&&++s,i[s++]=r++):++r;return i}(e.rank,n,t))}function _a(e,t){const n=e.transform,i=e.rank,r=Ui(n,i,[t]);if(1!==r.length)return;const s=O(r,1)[0],o=Math.abs(n[(i+1)*s+t]),a=e.inputSpace;return{scale:a.scales[s]*o,unit:a.units[s]}}function Fa(e,t){var n=e.defaultInputSpace;const i=n.scales,r=n.units;return t<i.length?{scale:i[t],unit:r[t]}:void 0}function za(e,t,n,i,r,s){const o=n.scales,a=r.scales,l=r.rank,c=t+1;for(let d=0;d<l;++d){const n=s[d];if(-1===n)continue;const r=a[d];for(let s=0;s<t;++s){const t=o[i[s]];e[c*s+n]*=t/r}}}function Ua(e,t){return e===t||void 0===e.error&&void 0===t.error&&(Ut(e.modelDimensionNames,t.modelDimensionNames)&&Ut(e.layerDimensionNames,t.layerDimensionNames)&&Ut(e.globalToRenderLayerDimensions,t.globalToRenderLayerDimensions)&&Ut(e.localToRenderLayerDimensions,t.localToRenderLayerDimensions)&&Ut(e.channelToRenderLayerDimensions,t.channelToRenderLayerDimensions)&&Ut(e.modelToRenderLayerTransform,t.modelToRenderLayerTransform)&&Ut(e.channelSpaceShape,t.channelSpaceShape))}function Ga(e,t,n,i,r){return Rn(((e,t,n,r)=>function(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:sa;const s=n.inputSpace,o=n.rank,a=n.sourceRank,l=n.outputSpace,c=n.transform,d=s.names,u=l.names;let h;if(void 0!==i)h=It(i.modelSubspaceDimensionIndices);else{h=[];for(let e=0;e<a;++e)h[e]=e}const p=h.length;for(let E=a;E<o;++E)h.push(E);const f=Ui(n.transform,o,h,!0),g=h.length,m=h.map((e=>d[e]||`${e}`)),v=f.map((e=>u[e]));if(g!==f.length)return{error:"Rank mismatch between model subspace dimensions ("+m.join(", ")+") and corresponding layer/global dimensions ("+v.join(", ")+")"};let y=Aa(Float32Array,c,o,f,h);const b=f.map((e=>u[e])),S=t.names.map((e=>b.indexOf(e))),w=e.names.map((e=>b.indexOf(e)));za(y,g,s,h,e,w),za(y,g,s,h,t,S);const x=r.names.map((e=>b.indexOf(e)));za(y,g,s,h,r,x);const C=[],k=r.rank;if(void 0!==i){let e=i.subsourceToModelSubspaceTransform;p!==g&&(e=To(new Float32Array((g+1)**2),g,e,p)),y=wo(new Float32Array((g+1)**2),g+1,y,g+1,e,g+1,g+1,g+1,g+1)}const T=new Uint32Array(k);for(let E=0;E<k;++E){const e=r.bounds.lowerBounds[E],t=r.bounds.upperBounds[E];if(0!==e||!mr(t)||t<=0||t>=2**32)return{error:`Channel dimension ${r.names[E]} must have lower bound of 0 and positive integer upper bound`};T[E]=t;const n=x[E];let i=-1;if(-1!==n)for(let r=0;r<g;++r){const e=y[n+r*(g+1)];if(0!==e){if(1!==e||-1!==i)return{error:`Channel dimension ${v[n]} must map to a single source dimension`};i=r}}C[E]=i}return{rank:g,unpaddedRank:p,modelDimensionNames:m,layerDimensionNames:v,localToRenderLayerDimensions:S,globalToRenderLayerDimensions:w,channelToRenderLayerDimensions:x,modelToRenderLayerTransform:y,channelToModelDimensions:C,channelSpaceShape:T}}(e,t,n,i,r)),[e,t,n,void 0===r?_n(void 0):r],Ua)}function Wa(e,t){const n=e.rank,i=e.unpaddedRank;let r;i!==n&&void 0!==t&&(t=To(new Float32Array((n+1)**2),n,t,i)),void 0!==t?(r=new Float32Array((n+1)*(n+1)),wo(r,n+1,e.modelToRenderLayerTransform,n+1,t,n+1,n+1,n+1,n+1)):r=e.modelToRenderLayerTransform;const s=new Float32Array((n+1)*(n+1)),o=Lo(s,n+1,r,n+1,n+1);if(0===o)throw new Error("Transform is singular");const a=e.globalToRenderLayerDimensions,l=e.localToRenderLayerDimensions,c=e.channelToRenderLayerDimensions,d=a.length,u=l.length,h=d+u,p=new Float32Array((h+1)*n);for(let w=0;w<n;++w){for(let e=0;e<d;++e){const t=a[e];-1!==t&&(p[w+e*n]=s[w+t*(n+1)])}for(let e=0;e<u;++e){const t=l[e];-1!==t&&(p[w+(d+e)*n]=s[w+t*(n+1)])}p[w+h*n]=s[w+n*(n+1)]}const f=c.length;let g=new Array(f);const m=[];for(let w=0;w<f;++w){const t=c[w];let i=-1;if(-1!==t){for(let s=0;s<n;++s){const o=r[t+s*(n+1)];if(0!==o){if(1!==o||-1!==i)throw new Error(`Channel dimension ${e.layerDimensionNames[t]} must map with stride 1 to a single data chunk dimensions`);i=s}}if(-1!==i){if(0!==r[t+n*(n+1)])throw new Error(`Channel dimension ${e.layerDimensionNames[t]} must have an offset of 0 in the chunk coordinate space`);m.push(i)}}g[w]=i}const v=e.channelSpaceShape,y=jo(v),b=m.length,S=new Uint32Array(y*b);for(let w=0;w<y;++w){let e=w,t=0;for(let n=0;n<f;++n){const i=e%v[n];e=(e-i)/v[n],-1!==g[n]&&(S[w*b+t]=i,++t)}}return{layerRank:n,modelTransform:e,chunkToLayerTransform:r,layerToChunkTransform:s,chunkToLayerTransformDet:o,combinedGlobalLocalRank:h,combinedGlobalLocalToChunkTransform:p,channelToChunkDimensionIndices:g,chunkChannelDimensionIndices:m,numChannels:y,chunkChannelCoordinates:S,channelSpaceShape:v}}function $a(e,t){const n=e.globalToRenderLayerDimensions,i=[],r=[];for(let s=0;s<3;++s){const e=t[s];if(-1==e)continue;const o=n[e];r.push(o),-1!==o&&i.push(o)}for(let s=r.length;s<3;++s)r[s]=-1;return{layerDisplayDimensionIndices:i,displayToLayerDimensionIndices:r}}function ja(e,t){const n=e.chunkToLayerTransform,i=e.modelTransform,r=i.rank,s=t.layerDisplayDimensionIndices,o=t.displayToLayerDimensionIndices,a=s.length,l=Ui(n,r,s);if(l.length!==a){const e=i.modelDimensionNames,t=i.layerDimensionNames;throw new Error(`Rank mismatch between displayed layer dimensions (${It(s,(e=>t[e])).join(",\xa0")}) and corresponding chunk dimensions (${It(l,(t=>e[t])).join(",\xa0")})`)}const c=qn();for(let u=0;u<3;++u){const e=o[u];if(-1!==e){for(let t=0;t<a;++t){const i=l[t];c[4*t+u]=n[i*(r+1)+e]}c[12+u]=n[r*(r+1)+e]}}const d=qn();Kn(d,c);for(let u=l.length;u<3;++u)l[u]=-1;return{modelTransform:e.modelTransform,chunkTransform:e,displaySubspaceModelMatrix:c,displaySubspaceInvModelMatrix:d,chunkDisplayDimensionIndices:l,numChunkDisplayDims:a}}function Ha(e,t,n,i,r){const s=t.length,o=n.length,a=e.length;let l=!0;for(let c=0;c<i;++c){let d=c,u=0;for(let e=0;e<s;++e)u+=r[d+e*i]*t[e];d+=s*i;for(let e=0;e<o;++e)u+=r[d+e*i]*n[e];u+=r[d+o*i],c<a?e[c]=u:(u<0||u>=1)&&(l=!1)}return l}var Ja={default:i.aW.Object.getOwnPropertySymbols,__esModule:!0};const qa=(0,i.g)(Ja);var Ya=i.bp,Za=i.bo.f;d("getOwnPropertyDescriptor",(function(){return function(e,t){return Za(Ya(e),t)}}));var Xa=i.aW.Object,Ka={default:function(e,t){return Xa.getOwnPropertyDescriptor(e,t)},__esModule:!0};const Qa=(0,i.g)(Ka);var el;!function(e){e[e.GPU_MEMORY=0]="GPU_MEMORY",e[e.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",e[e.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",e[e.DOWNLOADING=3]="DOWNLOADING",e[e.QUEUED=4]="QUEUED",e[e.NEW=5]="NEW",e[e.FAILED=6]="FAILED",e[e.EXPIRED=7]="EXPIRED"}(el||(el={}));var tl;!function(e){e[e.FIRST_TIER=0]="FIRST_TIER",e[e.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",e[e.VISIBLE=0]="VISIBLE",e[e.PREFETCH=1]="PREFETCH",e[e.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",e[e.RECENT=2]="RECENT",e[e.LAST_TIER=2]="LAST_TIER"}(tl||(tl={}));var nl,il;!function(e){e[e.totalTime=0]="totalTime",e[e.totalChunks=1]="totalChunks"}(nl||(nl={})),function(e){e[e.numChunks=0]="numChunks",e[e.systemMemoryBytes=1]="systemMemoryBytes",e[e.gpuMemoryBytes=2]="gpuMemoryBytes"}(il||(il={}));function rl(e,t){return 3*e+t}function sl(e){return 72+e}class ol{constructor(){this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.numPrefetchChunksAvailable=0}}function al(e){let t=-1;return(0,i.bn)((()=>{-1===t&&(t=requestAnimationFrame((()=>{t=-1,e()})))}),{flush:()=>{-1!==t&&(t=-1,e())},cancel:()=>{-1!==t&&(cancelAnimationFrame(t),t=-1)}})}class ll{constructor(){this.map=new pt}get(e,t){let n=this.map,i=n.get(e);return void 0===i?(i=t(),i.registerDisposer((()=>{n.delete(e)})),n.set(e,i)):i.addRef(),i}}class cl extends ll{get(e,t){return"string"!=typeof e&&(e=Pr(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,(()=>new wn(t()))).value}}class dl{constructor(){this.width=0,this.height=0,this.logicalWidth=0,this.logicalHeight=0,this.visibleLeftFraction=0,this.visibleTopFraction=0,this.visibleWidthFraction=0,this.visibleHeightFraction=0}}function ul(e,t){const n=1/e.visibleWidthFraction,i=1/e.visibleHeightFraction,r=-1-(2*e.visibleLeftFraction-1)*n;let s=-1-(2*e.visibleTopFraction-1)*i;s=-s,t[0]=t[0]*n+t[3]*r,t[4]=t[4]*n+t[7]*r,t[8]=t[8]*n+t[11]*r,t[12]=t[12]*n+t[15]*r,t[1]=t[1]*i+t[3]*s,t[5]=t[5]*i+t[7]*s,t[9]=t[9]*i+t[11]*s,t[13]=t[13]*i+t[15]*s}function hl(e,t){return e.width===t.width&&e.height===t.height&&e.logicalWidth===t.logicalWidth&&e.logicalHeight===t.logicalHeight&&e.visibleLeftFraction===t.visibleLeftFraction&&e.visibleTopFraction===t.visibleTopFraction}class pl extends Sn{constructor(e,t,n){super(),this.context=e,this.element=t,this.visibility=n,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new dl,this.boundsObserversRegistered=!1,this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){const e=this.context;e.ensureBoundsUpdated();const t=e.boundsGeneration;if(t===this.boundsGeneration)return;this.boundsGeneration=t;const n=this.element;!this.boundsObserversRegistered&&e.monitorPanel(n)&&(this.boundsObserversRegistered=!0);const i=n.getBoundingClientRect(),r=e.container,s=e.canvasRect,o=e.canvas,a=o.width,l=o.height,c=a/s.width,d=l/s.height,u=s.left,h=s.top;let p=this.canvasRelativeLogicalLeft=Math.round((i.left-u)*c+n.clientLeft),f=this.canvasRelativeLogicalTop=Math.round((i.top-h)*d+n.clientTop),g=n.clientWidth,m=n.clientHeight,v=f,y=p,b=p+g,S=f+m;for(let k=n.parentElement;null!==k&&k!==r;k=k.parentElement){const e=k.getBoundingClientRect();0===e.x&&0===e.y&&0===e.width&&0===e.height||(y=Math.max(y,(e.left-u)*c),v=Math.max(v,(e.top-h)*d),b=Math.min(b,(e.right-u)*c),S=Math.min(S,(e.bottom-h)*d))}v=this.canvasRelativeClippedTop=Math.round(Math.max(v,0)),y=this.canvasRelativeClippedLeft=Math.round(Math.max(y,0)),b=Math.round(Math.min(b,a)),S=Math.round(Math.min(S,l));const w=this.renderViewport,x=w.width=Math.max(0,b-y),C=w.height=Math.max(0,S-v);w.logicalWidth=g,w.logicalHeight=m,w.visibleLeftFraction=(y-p)/g,w.visibleTopFraction=(v-f)/m,w.visibleWidthFraction=x/g,w.visibleHeightFraction=C/m}setGLClippedViewport(){const e=this.gl,t=this.canvasRelativeClippedTop,n=this.canvasRelativeClippedLeft;var i=this.renderViewport;const r=i.width,s=i.height,o=t+s;e.enable(WebGL2RenderingContext.SCISSOR_TEST);let a=this.context.canvas.height-o;e.viewport(n,a,r,s),e.scissor(n,a,r,s)}setGLLogicalViewport(){const e=this.gl;var t=this.renderViewport;const n=t.width,i=t.height,r=t.logicalWidth,s=t.logicalHeight,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+s),r,s),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+i),n,i)}disposed(){this.boundsObserversRegistered&&this.context.unmonitorPanel(this.element),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;const e=this.element;return!(0===e.clientWidth||0===e.clientHeight||0===e.offsetWidth||0===e.offsetHeight)}get drawOrder(){return 0}}class fl extends pl{constructor(e,t,n){super(e,t,n),this.canvas=document.createElement("canvas"),this.canvasRenderingContext=this.canvas.getContext("2d");const i=this.canvas;t.appendChild(i),t.style.position="relative",i.style.position="absolute",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0"}draw(){this.drawIndirect();const e=this.renderViewport,t=this.canvas,n=e.logicalWidth,i=e.logicalHeight;t.width=n,t.height=i;const r=this.canvasRenderingContext;r?.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,n,i,0,0,n,i)}}class gl extends Ln{constructor(){super(Float64Array.of(0,0,1,1),(e=>qr(new Float64Array(4),e,ss)))}toJSON(){const e=this.value;var t=O(e,4);const n=t[0],i=t[1],r=t[2],s=t[3];if(0!==n||0!=i||1!==r||1!==s)return It(e)}}class ml extends Sn{constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new kn,this.updateFinished=new kn,this.changed=this.updateFinished,this.panels=new Rt,this.resizeGeneration=0,this.boundsGeneration=-1,this.orderedPanels=[],this.frameNumber=0,this.panelAncestors=new pt,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.scheduleRedraw=this.registerCancellable(al((()=>this.draw())));const t=this.canvas,n=this.resizeObserver;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",n.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",(e=>{console.log(`Lost WebGL context: ${e.statusMessage}`),e.preventDefault()})),this.registerEventListener(t,"webglcontextrestored",(()=>{console.log("WebGL context restored"),window.location.reload()})),this.gl=function(e){let t=e.getContext("webgl2",{antialias:!1,stencil:!0});if(null==t)throw new Error("WebGL not supported.");t.memoize=new ll,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(const n of["EXT_color_buffer_float"])if(!t.getExtension(n))throw new Error(`${n} extension not available`);for(const n of["EXT_float_blend"])t.getExtension(n);return t}(t)}monitorPanel(e){const t=this.panelAncestors,n=this.container;if(!n.contains(e))return!1;for(;e!==n;){let n=t.get(e);if(void 0!==n){++n.count;break}const i=e.parentElement;n={parent:i,count:1},t.set(e,n),e.addEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.observe(e),e=i}return!0}unmonitorPanel(e){const t=this.panelAncestors,n=this.container;for(;e!==n;){const n=t.get(e);if(1!==n.count){--n.count;break}e.removeEventListener("scroll",this.resizeCallback,{capture:!0}),this.resizeObserver.unobserve(e),t.delete(e),e=n.parent}}applyWindowedViewportToElement(e,t){var n=O(t,4);const i=n[0],r=n[1],s=1/n[2],o=1/n[3];e.style.position="absolute",e.style.top=-o*r*100+"%",e.style.left=-s*i*100+"%",e.style.width=100*s+"%",e.style.height=100*o+"%",++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(const e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){const e=this.resizeGeneration;if(this.boundsGeneration===e)return;const t=this.canvas;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();let e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t=this.orderedPanels,n=this.panels;t.length!==n.size&&(t.push(...n),t.sort(((e,t)=>e.drawOrder-t.drawOrder)));for(const i of t){if(!i.shouldDraw)continue;i.ensureBoundsUpdated();const e=i.renderViewport;0===e.width||0===e.height||i.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){var e=this.canvas;const t=e.width,n=e.height,i=new Float32Array(t*n);for(const s of this.panels){if(!s.shouldDraw)continue;const e=s.getDepthArray();if(void 0===e)continue;const t=s.canvasRelativeClippedTop,n=s.canvasRelativeClippedLeft;var r=s.renderViewport;const o=r.width,a=r.height;for(let r=0;r<a;++r){const s=(a-1-r)*o;i.set(e.subarray(s,s+o),(t+r)*o+n)}}return i}}class vl extends dl{constructor(){super(...arguments),this.globalPosition=Jo,this.projectionMat=qn(),this.viewMatrix=qn(),this.invViewMatrix=qn(),this.viewProjectionMat=qn(),this.invViewProjectionMat=qn()}}function yl(e,t){return e.displayDimensionRenderInfo===t.displayDimensionRenderInfo&&hl(e,t)&&Ut(e.globalPosition,t.globalPosition)&&Ut(e.projectionMat,t.projectionMat)&&Ut(e.viewMatrix,t.viewMatrix)}function bl(e){const t=e.viewMatrix,n=e.viewProjectionMat;Kn(t,e.invViewMatrix),Qn(n,e.projectionMat,t),Kn(e.invViewProjectionMat,n)}var Sl;!function(e){e[e.info=0]="info",e[e.warning=1]="warning",e[e.error=2]="error"}(Sl||(Sl={}));class wl{constructor(){this.changed=new kn,this.messages=[],this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){const e=this.messages;0!==e.length&&(e.length=0,this.changed.dispatch())}isEmpty(){return 0===this.messages.length&&!this.children.some((e=>!e.isEmpty()))}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{const t=this.children;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[i.bm](){yield*this.messages;for(const e of this.children)yield*e}}var xl,Cl,kl,Tl=i.b1,El=i.bg,Ll=(0,i.a_)("species"),Il=function(e,t){var n,i=Tl(e).constructor;return void 0===i||null==(n=Tl(i)[Ll])?t:El(n)},Dl=i.b3,Ml=function(e,t,n){var i=void 0===n;switch(t.length){case 0:return i?e():e.call(n);case 1:return i?e(t[0]):e.call(n,t[0]);case 2:return i?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return i?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return i?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3])}return e.apply(n,t)},Pl=i.bq,Al=i.br,Rl=i.b5,Nl=Rl.process,Vl=Rl.setImmediate,Ol=Rl.clearImmediate,Bl=Rl.MessageChannel,_l=Rl.Dispatch,Fl=0,zl={},Ul="onreadystatechange",Gl=function(){var e=+this;if(zl.hasOwnProperty(e)){var t=zl[e];delete zl[e],t()}},Wl=function(e){Gl.call(e.data)};(!Vl||!Ol)&&(Vl=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return zl[++Fl]=function(){Ml("function"==typeof e?e:Function(e),t)},xl(Fl),Fl},Ol=function(e){delete zl[e]},"process"==(0,i.a$)(Nl)?xl=function(e){Nl.nextTick(Dl(Gl,e,1))}:_l&&_l.now?xl=function(e){_l.now(Dl(Gl,e,1))}:Bl?(kl=(Cl=new Bl).port2,Cl.port1.onmessage=Wl,xl=Dl(kl.postMessage,kl,1)):Rl.addEventListener&&"function"==typeof postMessage&&!Rl.importScripts?(xl=function(e){Rl.postMessage(e+"","*")},Rl.addEventListener("message",Wl,!1)):xl=Ul in Al("script")?function(e){Pl.appendChild(Al("script"))[Ul]=function(){Pl.removeChild(this),Gl.call(e)}}:function(e){setTimeout(Dl(Gl,e,1),0)});var $l={set:Vl,clear:Ol},jl=i.b5,Hl=$l.set,Jl=jl.MutationObserver||jl.WebKitMutationObserver,ql=jl.process,Yl=jl.Promise,Zl="process"==(0,i.a$)(ql),Xl={},Kl=i.bg;function Ql(e){var t,n;this.promise=new e((function(e,i){if(void 0!==t||void 0!==n)throw TypeError("Bad Promise constructor");t=e,n=i})),this.resolve=Kl(t),this.reject=Kl(n)}Xl.f=function(e){return new Ql(e)};var ec,tc,nc,ic,rc=function(e){try{return{e:!1,v:e()}}catch(t){return{e:!0,v:t}}},sc=i.b5.navigator,oc=sc&&sc.userAgent||"",ac=i.b1,lc=i.b8,cc=Xl,dc=function(e,t){if(ac(e),lc(t)&&t.constructor===e)return t;var n=cc.f(e);return(0,n.resolve)(t),n.promise},uc=i.bs,hc=i.b5,pc=i.b3,fc=y,gc=i.aV,mc=i.b8,vc=i.bg,yc=F,bc=oe,Sc=Il,wc=$l.set,xc=function(){var e,t,n,i=function(){var i,r;for(Zl&&(i=ql.domain)&&i.exit();e;){r=e.fn,e=e.next;try{r()}catch(s){throw e?n():t=void 0,s}}t=void 0,i&&i.enter()};if(Zl)n=function(){ql.nextTick(i)};else if(!Jl||jl.navigator&&jl.navigator.standalone)if(Yl&&Yl.resolve){var r=Yl.resolve(void 0);n=function(){r.then(i)}}else n=function(){Hl.call(jl,i)};else{var s=!0,o=document.createTextNode("");new Jl(i).observe(o,{characterData:!0}),n=function(){o.data=s=!s}}return function(i){var r={fn:i,next:void 0};t&&(t.next=r),e||(e=r,n()),t=r}}(),Cc=Xl,kc=rc,Tc=oc,Ec=dc,Lc="Promise",Ic=hc.TypeError,Dc=hc.process,Mc=Dc&&Dc.versions,Pc=Mc&&Mc.v8||"",Ac=hc[Lc],Rc="process"==fc(Dc),Nc=function(){},Vc=tc=Cc.f,Oc=!!function(){try{var e=Ac.resolve(1),t=(e.constructor={})[(0,i.a_)("species")]=function(e){e(Nc,Nc)};return(Rc||"function"==typeof PromiseRejectionEvent)&&e.then(Nc)instanceof t&&0!==Pc.indexOf("6.6")&&-1===Tc.indexOf("Chrome/66")}catch{}}(),Bc=function(e){var t;return!(!mc(e)||"function"!=typeof(t=e.then))&&t},_c=function(e,t){if(!e._n){e._n=!0;var n=e._c;xc((function(){for(var i=e._v,r=1==e._s,s=0,o=function(t){var n,s,o,a=r?t.ok:t.fail,l=t.resolve,c=t.reject,d=t.domain;try{a?(r||(2==e._h&&Uc(e),e._h=1),!0===a?n=i:(d&&d.enter(),n=a(i),d&&(d.exit(),o=!0)),n===t.promise?c(Ic("Promise-chain cycle")):(s=Bc(n))?s.call(n,l,c):l(n)):c(i)}catch(u){d&&!o&&d.exit(),c(u)}};n.length>s;)o(n[s++]);e._c=[],e._n=!1,t&&!e._h&&Fc(e)}))}},Fc=function(e){wc.call(hc,(function(){var t,n,i,r=e._v,s=zc(e);if(s&&(t=kc((function(){Rc?Dc.emit("unhandledRejection",r,e):(n=hc.onunhandledrejection)?n({promise:e,reason:r}):(i=hc.console)&&i.error&&i.error("Unhandled promise rejection",r)})),e._h=Rc||zc(e)?2:1),e._a=void 0,s&&t.e)throw t.v}))},zc=function(e){return 1!==e._h&&0===(e._a||e._c).length},Uc=function(e){wc.call(hc,(function(){var t;Rc?Dc.emit("rejectionHandled",e):(t=hc.onrejectionhandled)&&t({promise:e,reason:e._v})}))},Gc=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),_c(t,!0))},Wc=function(e){var t,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===e)throw Ic("Promise can't be resolved itself");(t=Bc(e))?xc((function(){var i={_w:n,_d:!1};try{t.call(e,pc(Wc,i,1),pc(Gc,i,1))}catch(r){Gc.call(i,r)}})):(n._v=e,n._s=1,_c(n,!1))}catch(i){Gc.call({_w:n,_d:!1},i)}}};Oc||(Ac=function(e){yc(this,Ac,Lc,"_h"),vc(e),ec.call(this);try{e(pc(Wc,this,1),pc(Gc,this,1))}catch(t){Gc.call(this,t)}},(ec=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=_(Ac.prototype,{then:function(e,t){var n=Vc(Sc(this,Ac));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=Rc?Dc.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&_c(this,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),nc=function(){var e=new ec;this.promise=e,this.resolve=pc(Wc,e,1),this.reject=pc(Gc,e,1)},Cc.f=Vc=function(e){return e===Ac||e===ic?new nc(e):tc(e)}),gc(gc.G+gc.W+gc.F*!Oc,{Promise:Ac}),(0,i.bf)(Ac,Lc),he(Lc),ic=i.aW[Lc],gc(gc.S+gc.F*!Oc,Lc,{reject:function(e){var t=Vc(this);return(0,t.reject)(e),t.promise}}),gc(gc.S+gc.F*uc,Lc,{resolve:function(e){return Ec(this===ic?Ac:this,e)}}),gc(gc.S+gc.F*!(Oc&&yt()((function(e){Ac.all(e).catch(Nc)}))),Lc,{all:function(e){var t=this,n=Vc(t),i=n.resolve,r=n.reject,s=kc((function(){var n=[],s=0,o=1;bc(e,!1,(function(e){var a=s++,l=!1;n.push(void 0),o++,t.resolve(e).then((function(e){l||(l=!0,n[a]=e,--o||i(n))}),r)})),--o||i(n)}));return s.e&&r(s.v),n.promise},race:function(e){var t=this,n=Vc(t),i=n.reject,r=kc((function(){bc(e,!1,(function(e){t.resolve(e).then(n.resolve,i)}))}));return r.e&&i(r.v),n.promise}});var $c=i.aV,jc=i.aW,Hc=i.b5,Jc=Il,qc=dc;$c($c.P+$c.R,"Promise",{finally:function(e){var t=Jc(this,jc.Promise||Hc.Promise),n="function"==typeof e;return this.then(n?function(n){return qc(t,e()).then((function(){return n}))}:e,n?function(n){return qc(t,e()).then((function(){throw n}))}:e)}});var Yc=i.aV,Zc=Xl,Xc=rc;Yc(Yc.S,"Promise",{try:function(e){var t=Zc.f(this),n=Xc(e);return(n.e?t.reject:t.resolve)(n.v),t.promise}});var Kc={default:i.aW.Promise,__esModule:!0};const Qc=(0,i.g)(Kc);const ed=new class{constructor(){this.name="CancellationError",this.message="CANCELED"}toString(){return"CANCELED"}};function td(e){if(!0===e.isCanceled)throw ed}const nd=()=>{},id={isCanceled:!1,add:()=>nd,remove:nd};class rd{cancel(){const e=this.handlers;if(null!==e&&(this.handlers=null,void 0!==e))for(let t of e)t()}get isCanceled(){return null===this.handlers}add(e){let t=this.handlers;return null===t?(e(),nd):(void 0===t&&(t=this.handlers=new Rt),t.add(e),()=>{this.remove(e)})}remove(e){const t=this.handlers;t?.delete(e)}}class sd extends rd{constructor(){super(...arguments),this.consumers=new Rt}addConsumer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:id;const t=this.consumers;t.has(e)||e.isCanceled||(t.add(e),e.add((()=>{t.delete(e),0===t.size&&this.cancel()})))}}const od=!(typeof Window<"u"&&self instanceof Window),ad="rpc.promise.response",ld="rpc.promise.cancel";var cd=new pt;function dd(e,t){cd.set(e,t)}class ud extends Error{constructor(e,t){super(t),this.name=e,this.message=t}}function hd(e,t){dd(e,(function(e){let n=e.id;const i=new rd;let r=t.call(this,e,i);this.set(n,{promise:r,cancellationToken:i}),r.then((e=>{let{value:t,transfers:i}=e;this.delete(n),this.invoke(ad,{id:n,value:t},i)}),(e=>{this.delete(n),this.invoke(ad,{id:n,error:e.message,errorName:e.name})}))}))}dd(ld,(function(e){let t=e.id;const n=this.get(t);void 0!==n&&n.cancellationToken.cancel()})),dd(ad,(function(e){let t=e.id;var n=this.get(t);let i=n.resolve,r=n.reject;this.delete(t),e.hasOwnProperty("value")?i(e.value):e.errorName===ed.name?r(ed):r(new ud(e.errorName,e.error))}));const pd=od?-1:0;class fd{constructor(e){this.target=e,this.objects=new pt,this.nextId=pd,e.onmessage=e=>{let t=e.data;cd.get(t.functionName).call(this,t)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){let t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}getOptionalRef(e){if(void 0===e)return;let t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}invoke(e,t,n){t.functionName=e,this.target.postMessage(t,n)}promiseInvoke(e,t){let n=arguments.length>3?arguments[3]:void 0;return function(e,t){return new Qc(((n,i)=>{if(e===id)return void t(n,i,id);const r=new rd,s=e.add((()=>{r.cancel()}));t((e=>{s(),n(e)}),(e=>{s(),i(e)}),r)}))}(arguments.length>2&&void 0!==arguments[2]?arguments[2]:id,((i,r,s)=>{const o=t.id=this.newId();this.set(o,{resolve:i,reject:r}),this.invoke(e,t,n),s.add((()=>{this.invoke(ld,{id:o})}))}))}newId(){return od?this.nextId--:this.nextId++}}class gd extends Sn{constructor(){super(...arguments),this.rpc=null,this.rpcId=null}initializeSharedObject(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.newId();this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){!0===this.isOwner?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():!1===this.isOwner?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){let e=this.rpc,t=this.rpcId;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,0===this.refCount&&e===this.referencedGeneration&&this.ownerDispose()}}class md extends gd{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};null!=t&&e.initializeSharedObject(t,n.id)}(this,e,t)}}dd("SharedObject.dispose",(function(e){let t=this.get(e.id);if(0!==t.refCount)throw new Error("Attempted to dispose object with non-zero reference count.");t.disposed(),this.delete(t.rpcId),t.rpcId=null,t.rpc=null}));dd("Worker",(function(e){const t=e.port,n=e.path;new Worker(n).postMessage({port:t},[t])})),dd("SharedObject.refCountReachedZero",(function(e){let t=this.get(e.id),n=e.gen;t.counterpartRefCountReachedZero(n)}));const vd=new pt;function yd(e){return t=>{t.prototype.RPC_TYPE_ID=e}}function bd(e){return t=>{if(void 0!==e)t.prototype.RPC_TYPE_ID=e;else if(void 0===(e=t.prototype.RPC_TYPE_ID))throw new Error("RPC_TYPE_ID should have already been defined");vd.set(e,t)}}dd("SharedObject.new",(function(e){let t=e.type;--new(vd.get(t))(this,e).refCount}));var Sd,wd=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};const xd="SharedWatchableValue.changed";let Cd=Sd=class extends md{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,t),this.updatingValue_=!1,void 0!==e&&(this.base=new En(t.value),this.setupChangedHandler())}initializeCounterpart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.value=this.value,super.initializeCounterpart(e,t)}setupChangedHandler(){this.registerDisposer(this.base.changed.add((()=>{if(this.updatingValue_)this.updatingValue_=!1;else{const e=this.rpc;null!==e&&e.invoke(xd,{id:this.rpcId,value:this.value})}})))}static makeFromExisting(e,t){let n=new Sd;return n.base=t,n.setupChangedHandler(),n.initializeCounterpart(e),n}static make(e,t){return Sd.makeFromExisting(e,new En(t))}get value(){return this.base.value}set value(e){this.base.value=e}get changed(){return this.base.changed}};Cd=Sd=wd([bd("SharedWatchableValue")],Cd),dd(xd,(function(e){const t=this.get(e.id);t.updatingValue_=!0,t.base.value=e.value,t.updatingValue_=!1}));class kd extends En{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.NEGATIVE_INFINITY)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}}kd.VISIBLE=Number.POSITIVE_INFINITY,kd.IGNORED=Number.NEGATIVE_INFINITY;class Td extends kd{constructor(){super(...arguments),this.contributors=new pt}add(e){const t=this.contributors,n=e.changed.add((()=>{this.update()})),i=()=>{t.delete(i),n(),this.update()};return t.set(i,e),this.update(),i}update(){let e=Number.NEGATIVE_INFINITY;for(const t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function Ed(e){return class extends e{constructor(){super(...arguments),this.visibility=new Td}initializeCounterpart(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.visibility=this.registerDisposer(Cd.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var Ld,Id=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a},Dd=globalThis&&globalThis.__rest||function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof qa){var r=0;for(i=qa(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n};!function(e){e[e.DATA=0]="DATA",e[e.ANNOTATION=1]="ANNOTATION",e[e.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION"}(Ld||(Ld={}));class Md extends Sn{constructor(){super(...arguments),this.role=Ld.DATA,this.messages=new wl,this.layerChanged=new kn,this.redrawNeeded=new kn,this.layerChunkProgressInfo=new ol}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,n,i){}}class Pd extends Md{constructor(){super(...arguments),this.visibility=new Td}attach(e){}}function Ad(e,t,n){let i=n.state;if(void 0===i||i.transform!==e||i.displayDimensionRenderInfo!==t){if(n.messages.clearMessages(),i=n.state={transform:e,displayDimensionRenderInfo:t,modelTransform:void 0},void 0!==e.error)return void n.messages.addMessage({severity:Sl.error,message:e.error});try{const n=qn();(function(e,t,n){e.fill(0),e[15]=1;let i=!0;const r=t.displayDimensionIndices,s=n.globalToRenderLayerDimensions,o=n.modelToRenderLayerTransform,a=n.rank;for(let l=0;l<3;++l){const t=r[l];if(-1===t){i=!1;continue}const n=s[t];if(-1!==n){e[l+12]=o[n+a*(a+1)];for(let t=0;t<3;++t)e[l+4*t]=o[n+(a+1)*t]}else i=!1}if(!i){const e=t.globalDimensionNames,i=It(r.filter((e=>-1!==e)),(t=>e[t])).join(",\xa0");throw new Error(`Transform from model dimensions (${n.modelDimensionNames.join(",\xa0")}) to display dimensions (${i}) does not have full rank`)}})(n,t,e),i.modelTransform=n}catch(r){n.messages.addMessage({severity:Sl.error,message:r.message})}}return i.modelTransform}class Rd extends Sn{constructor(e){super(),this.renderViewport=new dl,this.changed=new Cn;var t=e.parametersConstructor;const n=void 0===t?vl:t,r=e.navigationState,s=e.update;var o=e.isEqual;const a=void 0===o?yl:o;this.oldValue_=new n,this.value_=new n;const l=()=>{const e=this.oldValue_,t=this.value_;e.displayDimensionRenderInfo=r.displayDimensionRenderInfo.value,(0,i.bn)(e,this.renderViewport);let n=e.globalPosition;const o=r.position.value,l=o.length;n.length!==l&&(e.globalPosition=n=new Float32Array(l)),n.set(o),s(e,r),!a(e,t)&&(this.value_=e,this.oldValue_=t,this.changed.dispatch(t,e))},c=this.update=this.registerCancellable(mn(l,0));this.registerDisposer(r.changed.add(c)),l()}setViewport(e){hl(e,this.renderViewport)||((0,i.bn)(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}}let Nd=class extends gd{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;super(),this.base=t,this.updateInterval=n,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable(mn(((e,t)=>{let n;t.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo?(n=t,this.prevDisplayDimensionRenderInfo=t.displayDimensionRenderInfo):(t.displayDimensionRenderInfo,n=Dd(t,["displayDimensionRenderInfo"])),this.rpc.invoke("SharedProjectionParameters.changed",{id:this.rpcId,value:n})}),this.updateInterval)),this.initializeCounterpart(e,{value:t.value}),this.registerDisposer(t.changed.add(this.update))}flush(){this.update.flush()}};Nd=Id([yd("SharedProjectionParameters")],Nd);class Vd{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;this.value_=e,this.defaultValue=t,this.changed=new kn}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){if(this.value_!==this.defaultValue)return this.value_}restoreState(e){this.value=!0!==e&&!1!==e?this.defaultValue:e}reset(){this.value=this.defaultValue}}class Od extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.model=e,this.element=document.createElement("input");let n=this.element;n.type="checkbox";const i=()=>{var e;const n=this.model.value;this.element.checked=n,(void 0!==t.enableTitle||void 0!==t.disableTitle)&&(this.element.title=null!==(e=n?t.enableTitle:t.disableTitle)&&void 0!==e?e:"")};this.registerDisposer(e.changed.add(i)),i(),this.registerEventListener(n,"change",(function(t){e.value=this.checked})),n.addEventListener("mousedown",(e=>{e.preventDefault()}))}disposed(){let e=this.element,t=e.parentElement;t&&t.removeChild(e),super.disposed()}}class Bd extends Sn{constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable(mn((()=>this.updateVisibility()),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}function _d(e){try{return e()}catch(t){return{error:t.message}}}class Fd extends Sn{constructor(e,t){if(super(),this.register=e,this.changed=new kn,this.disposerMap=new pt,void 0===t)this.map=new pt;else{const i=this.map=new pt(t),r=this.disposerMap;for(const t of i){var n=O(t,2);const i=n[0],s=n[1],o=new Sn;r.set(i,o),e(o,s,i)}}}get value(){return this.map}set(e,t){const n=this.map,i=this.disposerMap;let r=i.get(e);return void 0!==r&&r.dispose(),r=new Sn,i.set(e,r),n.set(e,t),this.register(r,t,e),this.changed.dispatch(),this}delete(e){const t=this.map,n=this.disposerMap,i=n.get(e);return void 0!==i&&(i.dispose(),n.delete(e),t.delete(e),this.changed.dispatch(),!0)}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[i.bm](){return A(this.map)}clear(){const e=this.map,t=this.disposerMap;if(e.size>0){for(const e of t.values())e.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){const e=this.map,t=this.disposerMap;for(const n of t.values())n.dispose();e.clear(),t.clear(),super.disposed()}}const zd=(0,i.bu)("objectId");let Ud=0;function Gd(e){if(e instanceof Object){let t=e[zd];return void 0===t&&(t=e[zd]=Ud++),`o${t}`}return""+Bt(e)}var Wd;!function(e){e[e.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",e[e.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT"}(Wd||(Wd={}));class $d extends Error{constructor(e,t,n,i){const r=`Error compiling ${Wd[e].toLowerCase()} shader: ${n}`;super(r),this.name="ShaderCompilationError",this.log=n,this.message=r,this.shaderType=e,this.source=t,this.errorMessages=i}}class jd extends Error{constructor(e,t,n){const i=`Error linking shader: ${n}`;super(i),this.name="ShaderLinkError",this.log=n,this.message=i,this.vertexSource=e,this.fragmentSource=t}}function Hd(e,t,n){var i=e.createShader(n);if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){let r=e.getShaderInfoLog(i)||"";throw new $d(n,t,r,function(e){e=e.replace("\0","");let t=[];for(let n of e.split("\n")){let e=n.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);null!==e?t.push({message:e[3].trim(),file:parseInt(e[1],10),line:parseInt(e[2],10)}):(e=n.match(/^ERROR:\s*(.+)$/),null!==e?t.push({message:e[1]}):(n=n.trim(),n&&t.push({message:n})))}return t}(r))}return i}class Jd extends Sn{constructor(e,t,n,i,r,s){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=n,this.attributes=new pt,this.uniforms=new pt,this.vertexShaderInputBinders={};let o=this.vertexShader=Hd(e,t,e.VERTEX_SHADER),a=this.fragmentShader=Hd(e,n,e.FRAGMENT_SHADER),l=e.createProgram();if(e.attachShader(l,o),e.attachShader(l,a),e.linkProgram(l),!e.getProgramParameter(l,e.LINK_STATUS)){let i=e.getProgramInfoLog(l)||"";throw new jd(t,n,i)}this.program=l;let c=this.uniforms,d=this.attributes;if(i)for(let u of i)c.set(u,e.getUniformLocation(l,u));if(r)for(let u of r)d.set(u,e.getAttribLocation(l,u))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){this.gl.useProgram(this.program)}disposed(){let e=this.gl;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}}class qd{constructor(){this.code="",this.parts=new Rt}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(!Array.isArray(e))throw console.log("Invalid code type",e),new Error("Invalid code type");for(let t of e)this.add(t)}}toString(){return this.code}}const Yd={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D};class Zd{constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new Rt,this.fragmentExtensions="",this.vertexCode=new qd,this.vertexMain="",this.fragmentCode=new qd,this.outputBufferCode="",this.fragmentMain="",this.required=new Rt,this.uniforms=new Array,this.attributes=new Array,this.initializers=[],this.textureUnits=new pt,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());let n=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,n),n}addTextureSampler(e,t,n,i){let r=this.allocateTextureUnit(n,i);return this.addUniform(`highp ${e}`,t,i),this.addInitializer((e=>{if(i){let n=new Int32Array(i);for(let e=0;e<i;++e)n[e]=e+r;e.gl.uniform1iv(e.uniform(t),n)}else e.gl.uniform1i(e.uniform(t),r)})),r}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,n){return this.attributes.push(t),void 0!==n&&(this.attributesCode+=`layout(location = ${n})`),this.attributesCode+=`in ${e} ${t};\n`,t}addVarying(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";this.varyingsCodeVS+=`${n} out ${e} ${t};\n`,this.varyingsCodeFS+=`${n} in ${e} ${t};\n`}addOutputBuffer(e,t,n){null!==n&&(this.outputBufferCode+=`layout(location = ${n}) `),this.outputBufferCode+=`out ${e} ${t};\n`}addUniform(e,t,n){return this.uniforms.push(t),this.uniformsCode+=null!=n?`uniform ${e} ${t}[${n}];\n`:`uniform ${e} ${t};\n`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require\n`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {\n${e}\n}\n`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){let e=`#version 300 es\nprecision highp float;\nprecision highp int;\n${this.uniformsCode}\n${this.attributesCode}\n${this.varyingsCodeVS}\n${this.vertexCode}\nvoid main() {\n${this.vertexMain}\n}\n`,t=`#version 300 es\n${this.fragmentExtensions}\nprecision highp float;\nprecision highp int;\n${this.uniformsCode}\n${this.varyingsCodeFS}\n${this.outputBufferCode}\n${this.fragmentCode}\n${this.fragmentMain}\n`,n=new Jd(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);n.textureUnits=this.textureUnits;let i=this.initializers;if(i.length>0){n.bind();for(let e of i)e(n)}return n}}function Xd(){return new En(void 0)}function Kd(e){return new Ln(e,es)}function Qd(e,t,n){const i=new pt,r=n.parameters,s=n.fallbackParameters,o=n.shaderError;var a=n.encodeParameters;const l=void 0===a?e=>e:a;var c=n.extraParameters;const d=void 0===c?_n(void 0):c;var u=n.encodeExtraParameters;const h=void 0===u?e=>e:u,p=n.getContextKey,f=n.defineShader;void 0!==o&&(o.value=void 0);var g=n.encodeContext;const m=void 0===g?p:g,v=Pr(n.memoizeKey);function y(e,n,i){const r=Bt({id:v,context:m(e),parameters:l(n),extraParameters:h(i)});return t.memoize.get(r,(()=>{const r=new Zd(t);return f(r,e,n,i),r.build()}))}return e.registerDisposer((()=>{for(const e of i.values()){const t=e.shader;null!==t&&t.dispose()}})),function(e){const t=p(e);let n=i.get(t);void 0===n&&(n={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:r.value,extraParameters:d.value},i.set(t,n));const a=r.changed.count,l=d.changed.count;if(a===n.parametersGeneration&&l===n.extraParametersGeneration)return n;const c=n.parameters=r.value,u=n.extraParameters=d.value,h=n.shader;n.parametersGeneration=a,n.extraParametersGeneration=l;let f=null;try{f=y(e,c,u),n.fallback=!1,void 0!==s&&(s.value=c),void 0!==o&&(o.value=null)}catch(g){if(void 0!==o&&(o.value=g),void 0!==s)try{const t=s.value;f=y(e,t,u),n.parameters=t,n.fallback=!0}catch{}}return null!==h&&h.dispose(),n.shader=f,n}}function eu(e,t,n){return Qd(e,t,(0,i.bn)((0,i.bn)({},n),{getContextKey:e=>e,encodeContext:e=>Gd(e),defineShader:(e,t,i,r)=>(e.require(t),n.defineShader(e,i,r))}))}function tu(e){return`\n#line ${arguments.length>2&&void 0!==arguments[2]?arguments[2]:0} ${arguments.length>1&&void 0!==arguments[1]?arguments[1]:1}\n`+e}class nu{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:WebGL2RenderingContext.ARRAY_BUFFER;this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:WebGL2RenderingContext.FLOAT,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,n,i,r,s)}bindToVertexAttribI(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:WebGL2RenderingContext.UNSIGNED_INT,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,n,i,r)}setData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:WebGL2RenderingContext.STATIC_DRAW,n=this.gl;this.bind(),n.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,n,i){let r=new nu(e,n);return r.setData(t,i),r}}function iu(e,t,n){for(var i=arguments.length,r=new Array(i>3?i-3:0),s=3;s<i;s++)r[s-3]=arguments[s];return e.memoize.get(Pr({id:"getMemoizedBuffer",getter:Gd(n),args:r}),(()=>{const i=new wn(nu.fromData(e,n(...r),t,WebGL2RenderingContext.STATIC_DRAW));return i.registerDisposer(i.value),i}))}function ru(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return Ft(new Float32Array([e,t,e,i,n,i,n,t]),2,r,s)}function su(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;return iu(e,WebGL2RenderingContext.ARRAY_BUFFER,ru,t,n,i,r,s,o).value}function ou(e){e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function au(e){e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = getValue0();")}class lu extends Sn{constructor(){super(...arguments),this.width=Number.NaN,this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}}class cu extends lu{constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){let e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){let t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class du extends cu{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){let e=this.gl;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class uu extends du{constructor(e){super(e,!0)}}class hu extends Sn{constructor(e){super(),this.gl=e,this.framebuffer=this.gl.createFramebuffer()}disposed(){this.gl.deleteFramebuffer(this.framebuffer)}bind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){let e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class pu extends lu{constructor(e,t,n,i){super(),this.gl=e,this.internalFormat=t,this.format=n,this.dataType=i,this.texture=e.createTexture()}performResize(){!function(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:WebGL2RenderingContext.RGBA8,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:WebGL2RenderingContext.RGBA,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:WebGL2RenderingContext.UNSIGNED_BYTE;e.activeTexture(WebGL2RenderingContext.TEXTURE0+e.tempTextureUnit),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),ou(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,n,i,0,s,o,null),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){let t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class fu extends pu{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:WebGL2RenderingContext.DEPTH_COMPONENT16,arguments.length>2&&void 0!==arguments[2]?arguments[2]:WebGL2RenderingContext.DEPTH_COMPONENT,arguments.length>3&&void 0!==arguments[3]?arguments[3]:WebGL2RenderingContext.UNSIGNED_SHORT)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function gu(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:WebGL2RenderingContext.RGBA8,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:WebGL2RenderingContext.RGBA,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:WebGL2RenderingContext.UNSIGNED_BYTE,s=new Array;for(let o=0;o<t;++o)s[o]=new pu(e,n,i,r);return s}class mu extends Sn{constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=new Array,this.attachmentVerified=!1,this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];var n=t.framebuffer;let i=void 0===n?new hu(e):n,r=t.colorBuffers,s=t.depthBuffer;this.framebuffer=this.registerDisposer(i),this.colorBuffers=r,this.depthBuffer=s,void 0!==s&&this.registerDisposer(s);let o=this.fullAttachmentList;r.forEach(((t,n)=>{this.registerDisposer(t),o[n]=e.COLOR_ATTACHMENT0+n}))}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();let n=this.gl,i=this.depthBuffer;void 0!==i?(i.resize(e,t),i.attachToFramebuffer()):n.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach(((i,r)=>{i.resize(e,t),i.attachToFramebuffer(n.COLOR_ATTACHMENT0+r)})),n.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),n.viewport(0,0,e,t)}bindSingle(e){let t=this.gl;this.framebuffer.bind(),0!==e&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=this.gl;try{this.bindSingle(e),o.readPixels(t,n,r,s,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,i)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;let e=this.gl,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class vu extends Sn{constructor(e,t){super(),this.gl=e,this.shader=t,this.copyVertexPositionsBuffer=su(this.gl),this.copyTexCoordsBuffer=su(this.gl,0,0,1,1),this.registerDisposer(t)}draw(){let e=this.gl,t=this.shader;t.bind();let n=arguments.length;for(let s=0;s<n;++s)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,s<0||arguments.length<=s?void 0:arguments[s]);e.uniformMatrix4fv(t.uniform("uProjectionMatrix"),!1,Ii);let i=t.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(i,2);let r=t.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(r,2),e.drawArrays(e.TRIANGLE_FAN,0,4),e.disableVertexAttribArray(i),e.disableVertexAttribArray(r);for(let s=0;s<n;++s)e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,null)}static get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:au,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return e.memoize.get(`OffscreenCopyHelper:${n}:${Gd(t)}`,(()=>new vu(e,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:au,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return e.memoize.get(`elementWiseTextureShader:${n}:${Gd(t)}`,(()=>{let i=new Zd(e);i.addVarying("vec2","vTexCoord"),i.addUniform("sampler2D","uSampler",n),i.addInitializer((t=>{let i=[];for(let e=0;e<n;++e)i[e]=e;e.uniform1iv(t.uniform("uSampler"),i)}));for(let e=0;e<n;++e)i.addFragmentCode(`\nvec4 getValue${e}() {\n  return texture(uSampler[${e}], vTexCoord);\n}\n`);return i.addUniform("mat4","uProjectionMatrix"),i.require(t),i.addAttribute("vec4","aVertexPosition"),i.addAttribute("vec2","aTexCoord"),i.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),i.build()}))}(e,t,n))))}}const yu="\nstruct uint64_t {\n  highp uvec2 value;\n};\nstruct uint64x2_t {\n  highp uvec4 value;\n};\nuint64_t mixLinear(uint64_t x, uint64_t y, float a) {\n  return x;\n}\nuint64_t toUint64(uint64_t x) { return x; }\n",bu=[yu,"\nuint64_t unpackUint64leFromUint32(highp uvec2 x) {\n  uint64_t result;\n  result.value = x;\n  return result;\n}\nuint64x2_t unpackUint64leFromUint32(highp uvec4 x) {\n  uint64x2_t result;\n  result.value = x;\n  return result;\n}\n"],Su=[yu,"\nbool equals(uint64_t a, uint64_t b) {\n  return a.value == b.value;\n}\n"],wu=[yu,"\nbool compareLessThan(uint64_t a, uint64_t b) {\n  return (a.value[1] < b.value[1])||\n         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);\n}\n"],xu=[yu,"\nuint64_t subtract(uint64_t a, uint64_t b) {\n  if (a.value[0] < b.value[0]) {\n    --a.value[1];\n  }\n  a.value -= b.value;\n  return a;\n}\n"],Cu=[[yu,"\nuint64_t add(uint64_t a, uint64_t b) {\n  a.value[0] += b.value[0];\n  if (a.value[0] < b.value[0]) {\n    ++a.value[1];\n  }\n  a.value[1] += b.value[1];\n  return a;\n}\n"],wu,"\nuint64_t addSaturate(uint64_t a, uint64_t b) {\n  a = add(a, b);\n  if (compareLessThan(a, b)) {\n    a.value = uvec2(0xffffffffu, 0xffffffffu);\n  }\n  return a;\n}\n"],ku=[xu,wu,"\nuint64_t subtractSaturate(uint64_t a, uint64_t b) {\n  b = subtract(a, b);\n  if (compareLessThan(a, b)) {\n    b.value = uvec2(0u, 0u);\n  }\n  return b;\n}\n"],Tu=[yu,"\nuint64_t shiftRight(uint64_t a, int shift) {\n  if (shift >= 32) {\n    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));\n  } else if (shift == 0) {\n    return a;\n  } else {\n    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));\n  }\n}\n"],Eu=[yu,"\nuint64_t shiftLeft(uint64_t a, int shift) {\n  if (shift >= 32) {\n    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));\n  } else if (shift == 0) {\n    return a;\n  } else {\n    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));\n  }\n}\n"],Lu=[yu,"\nstruct uint8_t {\n  highp uint value;\n};\nstruct uint8x2_t {\n  highp uvec2 value;\n};\nstruct uint8x3_t {\n  highp uvec3 value;\n};\nstruct uint8x4_t {\n  highp uvec4 value;\n};\nuint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {\n  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));\n}\nhighp uint toRaw(uint8_t x) { return x.value; }\nhighp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }\nhighp uvec2 toRaw(uint8x2_t x) { return x.value; }\nhighp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }\nhighp uvec3 toRaw(uint8x3_t x) { return x.value; }\nvec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }\nhighp uvec4 toRaw(uint8x4_t x) { return x.value; }\nvec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }\nuint64_t toUint64(uint8_t x) {\n  uint64_t result;\n  result.value[0] = x.value;\n  result.value[1] = 0u;\n  return result;\n}\nuint8_t uint8FromFloat(highp float x) {\n  return uint8_t(uint(clamp(x, 0.0, 255.0)));\n}\n"],Iu=[yu,"\nstruct int8_t {\n  highp int value;\n};\nstruct int8x2_t {\n  highp ivec2 value;\n};\nstruct int8x3_t {\n  highp ivec3 value;\n};\nstruct int8x4_t {\n  highp ivec4 value;\n};\nint8_t mixLinear(int8_t x, int8_t y, highp float a) {\n  return int8_t(int(round(mix(float(x.value), float(y.value), a))));\n}\nhighp int toRaw(int8_t x) { return x.value; }\nhighp ivec2 toRaw(int8x2_t x) { return x.value; }\nhighp ivec3 toRaw(int8x3_t x) { return x.value; }\nhighp ivec4 toRaw(int8x4_t x) { return x.value; }\nuint64_t toUint64(int8_t x) {\n  uint64_t result;\n  result.value[0] = uint(x.value);\n  result.value[1] = uint(x.value >> 31);\n  return result;\n}\nint8_t int8FromFloat(highp float x) {\n  return int8_t(int(clamp(x, -128.0, 127.0)));\n}\n"],Du="\nhighp float toRaw(highp float x) { return x; }\nhighp float toNormalized(highp float x) { return x; }\nvec2 toRaw(vec2 x) { return x; }\nvec2 toNormalized(vec2 x) { return x; }\nvec3 toRaw(vec3 x) { return x; }\nvec3 toNormalized(vec3 x) { return x; }\nvec4 toRaw(vec4 x) { return x; }\nvec4 toNormalized(vec4 x) { return x; }\n",Mu=[yu,"\nstruct uint16_t {\n  highp uint value;\n};\nstruct uint16x2_t {\n  highp uvec2 value;\n};\nuint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {\n  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));\n}\nhighp uint toRaw(uint16_t x) { return x.value; }\nhighp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }\nhighp uvec2 toRaw(uint16x2_t x) { return x.value; }\nhighp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }\nuint64_t toUint64(uint16_t x) {\n  uint64_t result;\n  result.value[0] = x.value;\n  result.value[1] = 0u;\n  return result;\n}\nuint16_t uint16FromFloat(highp float x) {\n  return uint16_t(uint(clamp(x, 0.0, 65535.0)));\n}\n"],Pu=[yu,"\nstruct int16_t {\n  highp int value;\n};\nstruct int16x2_t {\n  highp ivec2 value;\n};\nint16_t mixLinear(int16_t x, int16_t y, highp float a) {\n  return int16_t(int(round(mix(float(x.value), float(y.value), a))));\n}\nhighp int toRaw(int16_t x) { return x.value; }\nhighp ivec2 toRaw(int16x2_t x) { return x.value; }\nuint64_t toUint64(int16_t x) {\n  uint64_t result;\n  result.value[0] = uint(x.value);\n  result.value[1] = uint(x.value >> 31);\n  return result;\n}\nint16_t int16FromFloat(highp float x) {\n  return int16_t(int(clamp(x, -32768.0, 32767.0)));\n}\n"],Au=[yu,"\nstruct uint32_t {\n  highp uint value;\n};\nuint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {\n  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));\n}\nhighp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }\nhighp uint toRaw(uint32_t x) { return x.value; }\nuint64_t toUint64(uint32_t x) {\n  uint64_t result;\n  result.value[0] = x.value;\n  result.value[1] = 0u;\n  return result;\n}\nuint32_t uint32FromFloat(highp float x) {\n  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));\n}\n"],Ru=[yu,"\nstruct int32_t {\n  highp int value;\n};\nint32_t mixLinear(int32_t x, int32_t y, highp float a) {\n  return int32_t(int(round(mix(float(x.value), float(y.value), a))));\n}\nhighp int toRaw(int32_t x) { return x.value; }\nuint64_t toUint64(int32_t x) {\n  uint64_t result;\n  result.value[0] = uint(x.value);\n  result.value[1] = uint(x.value >> 31);\n  return result;\n}\nint32_t int32FromFloat(highp float x) {\n  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));\n}\n"];const Nu="\nhighp uint addSaturate(highp uint x, highp uint y) {\n  highp uint result = x + y;\n  if (result < x) return 0xffffffffu;\n  return result;\n}\n",Vu=[Nu,"\nhighp int addSaturate(highp int x, highp uint y) {\n  if (x >= 0) {\n    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));\n  } else if (y >= uint(-x)) {\n    return int(min(y - uint(-x), 0x7fffffffu));\n  } else {\n    return -int(min(uint(-x) - y, 0x80000000u));\n  }\n}\n"],Ou=[Nu,"\nhighp int subtractSaturate(highp int x, highp uint y) {\n  if (x < 0) {\n    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));\n  } else if (uint(x) >= y) {\n    return x - int(y);\n  } else {\n    return -int(min(y - uint(x), 0x80000000u));\n  }\n}\n"];function Bu(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;switch(e){case sr.FLOAT32:if(1===t)return"float";if(t>1&&t<=4)return`vec${t}`;break;case sr.UINT8:case sr.INT8:case sr.UINT16:case sr.INT16:case sr.UINT32:case sr.INT32:case sr.UINT64:{const n=ar[e]?"":"u",i=8*lr[e];if(1===t)return`${n}int${i}_t`;if(t>1&&t*i<=32)return`${n}int${i}x${t}_t`;break}}throw new Error(`No shader type for ${sr[e]}[${t}].`)}const _u={[sr.UINT8]:Lu,[sr.INT8]:Iu,[sr.UINT16]:Mu,[sr.INT16]:Pu,[sr.UINT32]:Au,[sr.INT32]:Ru,[sr.UINT64]:yu,[sr.FLOAT32]:Du};function Fu(e,t){return 1===t?e:"float"===e?`vec${t}`:`${e[0]}vec${t}`}const zu={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function Uu(e,t,n,i,r,s){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,a=0,l=s*o;for(;l>0;){const n=Math.min(4,l),i=Fu(t,n);l-=n,e.addAttribute("highp "+i,`a${r}${a}`),++a}l=s*o;let c="";for(let u=0;u<o;++u){c+=`highp ${t}[${s}] get${r}${u}() {\n  highp ${t}[${s}] result;\n`;for(let e=0;e<s;++e){const t=u*s+e,n=Math.floor(t/4),i=t%4;c+=`  result[${e}] = a${r}${n}`,(0!==i||t!==l-1)&&(c+=`[${i}]`),c+=";\n"}c+="  return result;\n",c+="}\n"}e.addVertexCode(c);const d=zu[n];e.addInitializer((e=>{const s=[];for(let t=0;t<a;++t)s[t]=e.attribute(`a${r}${t}`);e.vertexShaderInputBinders[r]={enable(t){const n=e.gl;for(let e=0;e<a;++e){const i=s[e];n.enableVertexAttribArray(i),n.vertexAttribDivisor(i,t)}},disable(){const t=e.gl;for(let e=0;e<a;++e){const n=s[e];t.vertexAttribDivisor(n,0),t.disableVertexAttribArray(n)}},bind(r,o){const c=e.gl;for(let e=0;e<a;++e){const a=s[e],u=Math.min(4,l-4*e);"float"===t?c.vertexAttribPointer(a,u,n,i,r,o):c.vertexAttribIPointer(a,Math.min(4,l-4*e),n,r,o),o+=d*u}}}}))}class Gu extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Td;super(),this.channels=e,this.bounds=t,this.visibility=n,this.framebuffers=[],this.producerVisibility=new Td,this.frameNumber=-1}getFramebuffers(e){const t=this.framebuffers;for(;t.length<this.channels.value.length;){const n=new mu(e,{colorBuffers:gu(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(n)}return t}disposed(){for(const e of this.framebuffers)e.dispose();this.framebuffers.length=0}}const Wu=(0,i.bu)("histogramDataSamplerTextureUnit"),$u=(0,i.bu)("histogramDepthTextureUnit"),ju=4096;class Hu extends Sn{constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{const e=new Zd(this.gl);return e.addOutputBuffer("vec4","outputValue",0),e.addAttribute("float","aInput1"),e.addTextureSampler("sampler2D","uDataSampler",Wu),e.addTextureSampler("sampler2D","uDepthSampler",$u),e.addVertexCode("\nhighp float simpleFloatHash(highp vec2 co) {\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n"),e.setVertexMain("\nfloat uRandomSeed = 0.0;\nvec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),\n              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));\nfloat dataValue = texture(uDataSampler, p).x;\nfloat stencilValue = texture(uDepthSampler, p).x;\nif (stencilValue == 1.0) {\n  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);\n} else {\n  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);\n}\ngl_PointSize = 1.0;\n"),e.setFragmentMain("\noutputValue = vec4(1.0, 1.0, 1.0, 1.0);\n"),e.build()})()),this.inputIndexBuffer=this.registerDisposer(iu(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,(()=>new Uint8Array(ju))))}static get(e){return e.memoize.get("textureHistogramGeneration",(()=>new Hu(e)))}compute(e,t,n,i,r){const s=this.gl,o=this.shader,a=i.getFramebuffers(s);o.bind(),s.enable(WebGL2RenderingContext.BLEND),s.disable(WebGL2RenderingContext.SCISSOR_TEST),s.disable(WebGL2RenderingContext.DEPTH_TEST),s.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(o.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const l=o.textureUnit(Wu),c=o.textureUnit($u);s.activeTexture(WebGL2RenderingContext.TEXTURE0+c),s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),ou(s),s.activeTexture(WebGL2RenderingContext.TEXTURE0+l);const d=i.frameNumber;i.frameNumber=r;for(let u=0;u<e;++u)s.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n[u].texture),ou(s),a[u].bind(256,1),r!==d&&(s.clearColor(0,0,0,0),s.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),s.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,ju,4);s.disable(WebGL2RenderingContext.BLEND)}}const Ju={[sr.UINT8]:"vec2",[sr.INT8]:"vec2",[sr.UINT16]:"vec2",[sr.INT16]:"vec2",[sr.FLOAT32]:"vec2",[sr.UINT32]:"Uint32LerpParameters",[sr.INT32]:"Int32LerpParameters",[sr.UINT64]:"Uint64LerpParameters"},qu={[sr.UINT8]:"",[sr.INT8]:"",[sr.UINT16]:"",[sr.INT16]:"",[sr.FLOAT32]:"",[sr.UINT32]:"\nstruct Uint32LerpParameters {\n  uint offset;\n  int shift;\n  float multiplier;\n};\n",[sr.INT32]:"\nstruct Int32LerpParameters {\n  int offset;\n  int shift;\n  float multiplier;\n};\n",[sr.UINT64]:[yu,"\nstruct Uint64LerpParameters {\n  uint64_t offset;\n  int shift;\n  float multiplier;\n};\n"]};function Yu(e){let t=`\nfloat computeInvlerp(${Bu(e)} inputValue, vec2 p) {\n  float outputValue = float(toRaw(inputValue));\n  outputValue = (outputValue - p[0]) * p[1];\n  return outputValue;\n}\n`;return[_u[e],t]}function Zu(e){const t=Bu(e);let n=e===sr.INT32?"int":"uint";return[_u[e],qu[e],`\nfloat computeInvlerp(${t} inputValue, ${Ju[e]} p) {\n  ${n} v = toRaw(inputValue);\n  uint x;\n  if (v >= p.offset) {\n    x = uint(v - p.offset);\n  } else {\n    x = uint(p.offset - v);\n    p.multiplier = -p.multiplier;\n  }\n  x >>= p.shift;\n  return float(x) * p.multiplier;\n}\n`]}const Xu={[sr.UINT8]:Yu(sr.UINT8),[sr.INT8]:Yu(sr.INT8),[sr.UINT16]:Yu(sr.UINT16),[sr.INT16]:Yu(sr.INT16),[sr.FLOAT32]:Yu(sr.FLOAT32),[sr.UINT32]:Zu(sr.UINT32),[sr.INT32]:Zu(sr.INT32),[sr.UINT64]:[yu,wu,xu,Tu,qu[sr.UINT64],"\nfloat computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {\n  if (compareLessThan(inputValue, p.offset)) {\n    inputValue = subtract(p.offset, inputValue);\n    p.multiplier = -p.multiplier;\n  } else {\n    inputValue = subtract(inputValue, p.offset);\n  }\n  uint shifted = shiftRight(inputValue, p.shift).value[0];\n  return float(shifted) * p.multiplier;\n}\n"]};function Ku(e){let t=`\n${Bu(e)} computeLerp(float inputValue, vec2 p) {\n  inputValue = inputValue / p[1] + p[0];\n`;return e===sr.FLOAT32?t+="return inputValue;\n":t+=`return ${sr[e].toLowerCase()}FromFloat(round(inputValue));\n`,t+="\n}\n",[_u[e],t]}function Qu(e){const t=Bu(e);let n=Ju[e];return[_u[e],qu[e],"\nhighp uint shiftLeftSaturate(highp uint x, int shiftAmount) {\n  highp uint result = x << shiftAmount;\n  if ((result >> shiftAmount) != x) return 0xffffffffu;\n  return result;\n}\n",e===sr.UINT32?Nu:Vu,e===sr.UINT32?"\nhighp uint subtractSaturate(highp uint x, highp uint y) {\n  highp uint result = x - y;\n  if (result > x) return 0u;\n  return result;\n}\n":Ou,`\n${t} computeLerp(float inputValue, ${n} p) {\n  inputValue = inputValue / p.multiplier;\n  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));\n  uint xShifted = shiftLeftSaturate(x, p.shift);\n  if (inputValue >= 0.0) {\n    return ${t}(addSaturate(p.offset, xShifted));\n  } else {\n    return ${t}(subtractSaturate(p.offset, xShifted));\n  }\n}\n`]}const eh={[sr.UINT8]:Ku(sr.UINT8),[sr.INT8]:Ku(sr.INT8),[sr.UINT16]:Ku(sr.UINT16),[sr.INT16]:Ku(sr.INT16),[sr.FLOAT32]:Ku(sr.FLOAT32),[sr.UINT32]:Qu(sr.UINT32),[sr.INT32]:Qu(sr.INT32),[sr.UINT64]:[yu,wu,Su,Cu,ku,Tu,Eu,qu[sr.UINT64],"\nuint64_t computeLerp(float inputValue, Uint64LerpParameters p) {\n  inputValue = inputValue / p.multiplier;\n  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));\n  uint64_t shifted = shiftLeft(x, p.shift);\n  if (!equals(shiftRight(shifted, p.shift), x)) {\n    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));\n  }\n  if (inputValue >= 0.0) {\n    return addSaturate(p.offset, shifted);\n  } else {\n    return subtractSaturate(p.offset, shifted);\n  }\n}\n"]};function th(e,t,n){const i=`uLerpParams_${t}`,r=`uLerpBounds_${t}`,s=`uLerpScalar_${t}`;let o="";switch(n){case sr.INT8:case sr.UINT8:case sr.INT16:case sr.UINT16:case sr.FLOAT32:e.addUniform("vec2",i);break;case sr.INT32:case sr.UINT32:{const t=Ju[n];e.addUniform((n===sr.INT32?"i":"u")+"vec2",r),e.addUniform("float",s),o+=`\n#define ${i} ${t}(${r}[0], int(${r}[1]), ${s})\n`;break}case sr.UINT64:e.addUniform("uvec3",r),e.addUniform("float",s),o+=`\n#define ${i} Uint64LerpParameters(uint64_t(${r}.xy), int(${r}[2]), ${s})\n`}return[qu[n],o]}function nh(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return[_u[n],th(e,t,n),Xu[n],`\nfloat ${t}(${Bu(n)} inputValue) {\n  float v = computeInvlerp(inputValue, uLerpParams_${t});\n  ${i?"v = clamp(v, 0.0, 1.0);":""}\n  return v;\n}\n`]}const ih=new Ds;function rh(e,t,n,i){const r=e.gl;switch(n){case sr.INT8:case sr.UINT8:case sr.INT16:case sr.UINT16:case sr.FLOAT32:r.uniform2f(e.uniform(`uLerpParams_${t}`),i[0],1/(i[1]-i[0]));break;case sr.INT32:case sr.UINT32:{const s=i[0],o=i[1]-s,a=Math.max(0,Math.ceil(ks(Math.abs(o)))-24),l=Math.pow(2,a)/o,c=e.uniform(`uLerpBounds_${t}`);n===sr.UINT32?r.uniform2ui(c,s,a):r.uniform2i(c,s,a),r.uniform1f(e.uniform(`uLerpScalar_${t}`),l);break}case sr.UINT64:{const n=i[0],s=i[1];Ds.absDifference(ih,s,n);const o=ih.high>0?32+Math.ceil(ks(ih.high)):Math.ceil(ks(ih.low)),a=Math.max(0,o-24);Ds.rshift(ih,ih,a);let l=1/ih.low;Ds.compare(n,s)>0&&(l*=-1);const c=e.uniform(`uLerpBounds_${t}`);r.uniform3ui(c,n.low,n.high,a),r.uniform1f(e.uniform(`uLerpScalar_${t}`),l)}}}function sh(e){const t=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/;let n=0,i=e;e:for(;e.length;){const i=e.match(t);if(null===i)break;const r=i[0];switch(r.charAt(0)){case"[":case"{":++n;break;case"]":case"}":if(--n<0)return-1;break;case",":if(0===n)break e;break;default:if(0===n){e=e.substring(r.length);break e}}e=e.substring(r.length)}return 0!==n?-1:i.length-e.length}function oh(e,t){"number"==typeof e&&(e=[e]);const n=new Array(t);return qr(n,e,(e=>{if(!mr(e)||e<0)throw new Error(`Expected non-negative integer, but received: ${Bt(e)}`);return e})),n}const ah=new pt([["slider",function(e,t){let n,i,r,s,o=[];"float"!==e&&"uint"!==e&&"int"!==e&&o.push("type must be float, int, or uint");for(const l of t){var a=O(l,2);const t=a[0],c=a[1],d=()=>{if("number"==typeof c)return("int"===e||"uint"===e)&&(mr(c)||o.push(`Expected ${t} argument to be an integer`),"uint"===e&&c<0&&o.push(`Expected ${t} argument to be an unsigned integer`)),c;o.push(`Expected ${t} argument to be a number`)};"min"===t?n=d():"max"===t?i=d():"default"===t?s=d():"step"===t?r=d():o.push(`Invalid parameter: ${t}`)}return void 0===n&&o.push("min must be specified"),void 0===i&&o.push("max must be specified"),void 0!==n&&void 0!==i&&(n>i&&o.push("min must be less than max"),void 0===r&&(r="float"===e?(i-n)/100:1),void 0!==s?(s<n||s>i)&&o.push("default must be within valid range"):s="float"===e?(n+i)/2:n),o.length>0?{errors:o}:{control:{type:"slider",valueType:e,min:n,max:i,step:r,default:s},errors:void 0}}],["color",function(e,t){let n="white",i=[];"vec3"!==e&&i.push("type must be vec3");for(const s of t){var r=O(s,2);const e=r[0],t=r[1];"default"===e?"string"!=typeof t?i.push("Expected default argument to be a string"):n=t:i.push(`Invalid parameter: ${e}`)}return i.length>0?{errors:i}:{control:{type:"color",valueType:e,defaultString:n,default:qi(n)},errors:void 0}}],["invlerp",function(e,t,n){let i=[];const r=n.imageData;if(void 0===r)return i.push("invlerp control not supported"),{errors:i};"invlerp"!==e&&i.push("type must be invlerp");let s=new Array(r.channelRank).fill(0);const o=r.dataType;let a,l=!0,c=Ps[o];for(let h of t){var d=O(h,2);let e=d[0],t=d[1];try{switch(e){case"range":c=Gs(t,o);break;case"window":a=Os(Gs(t,o));break;case"clamp":"boolean"!=typeof t?i.push(`Invalid clamp value: ${Bt(t)}`):l=t;break;case"channel":s=oh(t,s.length);break;default:i.push(`Invalid parameter: ${e}`)}}catch(u){i.push(`Invalid ${e} value: ${u.message}`)}}return i.length>0?{errors:i}:{control:{type:"invlerp",dataType:o,clamp:l,default:{range:c,window:a??Bs(c),channel:s}},errors:void 0}}],["checkbox",function(e,t){let n=!1,i=[];"bool"!==e&&i.push("type must be bool");for(const s of t){var r=O(s,2);const e=r[0],t=r[1];if("default"===e){if("boolean"!=typeof t){i.push(`Expected ${e} argument to be a boolean`);continue}n=t}else i.push(`Invalid parameter: ${e}`)}return i.length>0?{errors:i}:{control:{type:"checkbox",valueType:e,default:n},errors:void 0}}]]);function lh(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=function(e){return e.replace(/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/gm,(e=>e.startsWith("/")?e.replace(/[^\s]/g," "):e))}(e);const n=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/;let i=[];const r=new pt,s=e.replace(/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/gm,((s,o,a)=>{var l;const c=o.match(n),d=()=>Math.max(0,e.substring(0,a).split("\n").length-1);if(null===c)return i.push({line:d(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";const u=c[1],h=c[2],p=null!==(l=c[3])&&void 0!==l?l:u;var f=function(e){let t=[],n=new pt;if(void 0===e)return{errors:t,parameters:n};const i=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;0!=(e=e.trim()).length;){const r=e.match(i);if(null===r){t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}const s=r[1];let o,a=sh(e=e.substring(r[0].length));if(a<=0){t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}try{o=JSON.parse(e.substring(0,a))}catch{t.push(`Invalid #uicontrol parameter value for ${s}: ${o}`);break}n.has(s)?t.push(`Duplicate #uicontrol parameter: ${s}`):n.set(s,o),(e=(e=e.substring(a)).trim()).length>0&&!e.startsWith(",")&&t.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),e=e.substring(1)}return{parameters:n,errors:t}}(c[4]);const g=f.parameters,m=f.errors;for(const e of m)i.push({line:d(),message:e});if(r.has(h)&&i.push({line:d(),message:`Duplicate definition for control ${h}`}),m.length>0)return"";const v=ah.get(p);if(void 0===v)return i.push({line:d(),message:`Invalid control type ${p}`}),"";const y=v(u,g,t);if(void 0!==y.errors){for(const e of y.errors)i.push({line:d(),message:e});return""}return r.set(h,y.control),""}));return{source:e,code:s,errors:i,controls:r}}function ch(e){return`u_shaderControl_${e}`}function dh(e,t){const n=e.builderValues;for(const r of e.parseResult.controls){var i=O(r,2);const e=i[0],s=i[1],o=ch(e),a=n[e];switch(s.type){case"invlerp":{const n=[nh(t,o,s.dataType,s.clamp),`\nfloat ${o}() {\n  return ${o}(getDataValue(${a.channel.join(",")}));\n}\n`];t.addFragmentCode(n),t.addFragmentCode(`#define ${e} ${o}\n`);break}case"checkbox":{const n=`#define ${e} ${a.value}\n`;t.addFragmentCode(n),t.addVertexCode(n);break}default:t.addUniform(`highp ${s.valueType}`,o),t.addVertexCode(`#define ${e} ${o}\n`),t.addFragmentCode(`#define ${e} ${o}\n`)}}}function uh(e){if(void 0!==e)return Bt(function(e){const t={};for(const i of e){var n=O(i,2);const e=n[0],r=n[1];t[e]=r}return t}(e))}class hh{constructor(){this.changed=new kn,this.controls=void 0}get value(){return this.controls}set value(e){uh(e)!==uh(this.controls)&&(this.controls=e,this.changed.dispatch())}}class ph extends Ln{constructor(e,t){super(t,(n=>function(e,t,n){return void 0===e?n:(Yr(e),{range:is(e,"range",(e=>Gs(e,t)),n.range),window:is(e,"window",(e=>Os(Gs(e,t))),n.window),channel:is(e,"channel",(e=>oh(e,n.channel.length)),n.channel)})}(n,e,t))),this.dataType=e,this.defaultValue=t}toJSON(){var e=this.value;const t=e.range,n=e.window,i=e.channel,r=this.dataType,s=this.defaultValue,o=$s(t,r,s.range),a=$s(n,r,s.window),l=Ut(s.channel,i)?void 0:i;if(void 0!==o||void 0!==a||void 0!==l)return{range:o,window:a,channel:l}}}function fh(e){switch(e.type){case"slider":return{trackable:new Ln(e.default,(t=>{let n;if(n="float"===e.valueType?Tr(t):Zr(t),n<e.min||n>e.max)throw new Error(`${Bt(t)} is outside valid range [${e.min}, ${e.max}]`);return n})),getBuilderValue:()=>null};case"color":return{trackable:new nr(e.default),getBuilderValue:()=>null};case"invlerp":return{trackable:new ph(e.dataType,e.default),getBuilderValue:t=>({channel:t.channel,dataType:e.dataType})};case"checkbox":return{trackable:new Vd(e.default),getBuilderValue:e=>({value:e})}}}function gh(e,t){return Bt(e)+"\0"+t.source}function mh(e){const t={};for(const r of e.controls){var n=O(r,2);const e=n[0];var i=fh(n[1]);const s=i.trackable,o=i.getBuilderValue;t[e]=o(s.value)}return{builderValues:t,parseResult:e,key:gh(t,e)}}class vh extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_n({}),n=arguments.length>2?arguments[2]:void 0;super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=n,this.changed=new kn,this.controls=new hh,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new kn,this.state_=new pt,this.unparsedJson=void 0,this.registerDisposer(e.changed.add((()=>this.handleFragmentMainChanged()))),this.registerDisposer(this.controls.changed.add((()=>this.handleControlsChanged()))),this.registerDisposer(this.dataContext.changed.add((()=>this.handleFragmentMainChanged()))),this.handleFragmentMainChanged();const i=this;this.parseErrors={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return i.handleFragmentMainChanged(),i.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return i.parseResult_}},this.builderState=Rn(((e,t)=>{const n={};for(const s of t){var i=O(s,2);const e=i[0];var r=i[1];const t=r.trackable,o=(0,r.getBuilderValue)(t.value);n[e]=o}return{key:gh(n,e),parseResult:e,builderValues:n}}),[this.parseResult,this],((e,t)=>e.key===t.key));const r=Rn((e=>{const t=[];for(const n of e.values()){const e=n.control,i=n.trackable;"invlerp"===e.type&&t.push({channel:i.value.channel})}return t}),[this],((e,t)=>Gt(e,t,((e,t)=>Ut(e.channel,t.channel))))),s=Pn((e=>{const t=[];for(const n of e.values()){const e=n.control,i=n.trackable;"invlerp"===e.type&&t.push(i.value.window)}return t}),this);this.histogramSpecifications=this.registerDisposer(new Gu(r,s))}handleFragmentMainChanged(){const e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;const n=this.dataContext.value;if(null===n)this.parseResult_={source:"",code:"",controls:new pt,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{const e=this.parseResult_=lh(this.fragmentMain.value,n);this.parseErrors_=e.errors,this.processedFragmentMain_=e.code,0===e.errors.length&&(this.controls.value=e.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){const e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;const t=this.controls.value;if(void 0===t)return;let n=!1;const i=this.state_,r=this.unparsedJson;for(const l of i){var s=O(l,2);const e=s[0],r=s[1];void 0!==t.get(e)||(r.trackable.changed.remove(this.changed.dispatch),i.delete(e),n=!0)}for(const l of t){var o=O(l,2);const e=o[0],t=o[1];let s=i.get(e);if(void 0!==s&&Bt(s.control)!==Bt(t)&&(s.trackable.changed.remove(this.changed.dispatch),s=void 0),void 0===s){var a=fh(t);s={control:t,trackable:a.trackable,getBuilderValue:a.getBuilderValue},s.trackable.changed.add(this.changed.dispatch),i.set(e,s),n=!0}if(void 0!==r&&r.hasOwnProperty(e)){n=!0;try{s.trackable.restoreState(r[e])}catch{}}}void 0!==r&&(n=!0),this.unparsedJson=void 0,n&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(void 0===e)return;const t=this.state;if(Yr(e),void 0===this.controls.value)return this.unparsedJson=e,void this.changed.dispatch();for(const i of t){var n=O(i,2);const t=n[0],r=n[1].trackable;if(r.reset(),e.hasOwnProperty(t))try{r.restoreState(e[t])}catch{}}this.unparsedJson=void 0}reset(){for(const e of this.state.values())e.trackable.reset();void 0!==this.unparsedJson&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){const e=this.state,t=this.unparsedJson;if(void 0!==t)return t;const n={};let i=!0;for(const s of e){var r=O(s,2);const e=r[0],t=r[1].trackable.toJSON();void 0!==t&&(n[e]=t,i=!1)}return i?void 0:n}}function yh(e,t,n,i,r){const s=ch(n),o=t.uniform(s);switch(i.type){case"slider":switch(i.valueType){case"int":case"uint":e.uniform1i(o,r);break;case"float":e.uniform1f(o,r)}break;case"color":e.uniform3fv(o,r);break;case"invlerp":rh(t,s,i.dataType,r.range)}}function bh(e,t,n,i){const r=n.state;if(n.controls.value===i)for(const a of r){var s=O(a,2);const n=s[0],i=s[1];yh(e,t,n,i.control,i.trackable.value)}else for(const a of i){var o=O(a,2);const n=o[0],i=o[1],s=r.get(n);yh(e,t,n,i,void 0!==s&&Bt(s.control)===Bt(i)?s.trackable.value:i.default)}}class Sh extends En{}class wh extends Fd{constructor(){super(((e,t)=>{let{showMatches:n,segmentationState:i}=t;e.registerDisposer(n.changed.add(this.changed.dispatch)),e.registerDisposer(i.changed.add(this.changed.dispatch)),e.registerDisposer(On(((e,t)=>{if(null==t)return;const n=t.segmentationGroupState;e.registerDisposer(n.changed.add(this.changed.dispatch)),e.registerDisposer(On(((e,t)=>{const n=t.visibleSegments;let i=0===n.size;e.registerDisposer(n.changed.add((()=>{const e=0===n.size;e!==i&&(i=e,this.changed.dispatch())})))}),n))}),i))}))}get(e){let t=super.get(e);return void 0===t&&(t={segmentationState:new En(void 0),showMatches:new Vd(!1)},super.set(e,t)),t}}const xh="\nvoid main() {\n  setColor(defaultColor());\n}\n";class Ch extends Sn{constructor(){super(...arguments),this.shader=Kd(xh),this.shaderControls=new vh(this.shader),this.fallbackShaderControls=new En(mh(lh(xh))),this.shaderError=Xd(),this.color=new nr(ii(1,1,0)),this.relationshipStates=this.registerDisposer(new wh),this.ignoreNullSegmentFilter=new Vd(!0),this.displayUnfiltered=Pn(((e,t)=>{for(const n of e.values())if(n.showMatches.value){if(!t)return!1;const e=n.segmentationState.value;if(null!=e&&e.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0}),this.relationshipStates,this.ignoreNullSegmentFilter),this.hoverState=new Sh(void 0)}}class kh extends Sn{constructor(e){super();const t=e.transform,n=e.localPosition,i=e.source;var r=e.role;const s=void 0===r?Ld.ANNOTATION:r;this.transform=t,this.localPosition=n,this.source=this.registerDisposer(i),this.role=s,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(Pn((e=>_d((()=>Wa(function(e){if(void 0!==e.error)throw new Error(e.error);return e}(e))))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex}get sourceIndex(){const e=this.dataSource;return e.layer.dataSources.indexOf(e)}}class Th{constructor(e,t,n){this.size=ni(e),this.transform=function(e){var t=new $n(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}(t),this.finiteRank=n;const i=qn(),r=Lo(i,4,t,4,4);if(0===r)throw new Error("Transform is singular");this.invTransform=i,this.detTransform=r}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new Th(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return pi(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return function(e,t,n){let i=t[0],r=t[1],s=t[2];return e[0]=n[0]*i+n[4]*r+n[8]*s,e[1]=n[1]*i+n[5]*r+n[9]*s,e[2]=n[2]*i+n[6]*r+n[10]*s,e}(e,t,this.transform)}globalToLocalNormal(e,t){return Vi(e,t,this.transform)}}const Eh=qn();function Lh(e,t){let n=0,i=Math.abs(e.detTransform);const r=e.transform,s=e.size;for(let o=0;o<3;++o){let e=0;for(let n=0;n<3;++n)e+=t[4*n+2]*r[4*o+n];const a=s[o];n+=Math.abs(e)*a,i*=a}return i/n}function Ih(e,t,n){const i=e.curPositionInChunks,r=e.fixedPositionWithinChunk,s=e.nonDisplayLowerClipBound,o=e.nonDisplayUpperClipBound;var a=e.source.spec;const l=a.rank,c=a.chunkDataSize;if(!Ha(i,t,n,e.layerRank,e.fixedLayerToChunkTransform))return!1;for(let d=0;d<l;++d){const e=i[d];if(e<s[d]||e>=o[d])return!1;const t=c[d],n=i[d]=Math.floor(e/t);r[d]=e-n*t}return!0}function Dh(e,t){let n=t.length,i=0;if(n>1){let r=0;for(let s=0;s<n;++s){let n=Lh(t[s].chunkLayout,e);n>r&&(r=n,i=s)}}return i}const Mh=new Th(ti(),qn(),0);class Ph extends vl{constructor(){super(...arguments),this.viewportNormalInGlobalCoordinates=ti(),this.viewportNormalInCanonicalCoordinates=ti(),this.centerDataPosition=ti(),this.pixelSize=0}}class Ah extends gd{constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new pt,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add(((e,t)=>{(function(e,t){if(e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo||e.pixelSize!==t.pixelSize)return!0;const n=e.viewMatrix,i=t.viewMatrix;for(let r=0;r<12;++r)if(n[r]!==i[r])return!0;return!1})(e,t)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()})))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;const e=this.projectionParameters.value.displayDimensionRenderInfo,t=this.visibleLayers;for(const r of t){var n=O(r,2);const t=n[0];var i=n[1];const s=i.allSources,o=i.visibleSources,a=i.displayDimensionRenderInfo;if(o.length=0,a!==e||0===s.length)continue;const l=Dh(this.projectionParameters.value.viewMatrix,s.map((e=>e[0]))),c=s[l];for(const e of t.filterVisibleSources(this,c))o.push(e);o.reverse()}}}function Rh(e){let t=e.rank,n=e.upperVoxelBound;var i=e.maxVoxelsPerChunkLog2;let r=void 0===i?18:i,s=e.chunkToViewTransform,o=e.displayRank,a=e.minBlockSize,l=e.maxBlockSize;var c=e.lowerVoxelBound;const d=void 0===c?new Uint32Array(t):c,u=new Float32Array(t);for(let g=0;g<t;++g){let e=0;for(let t=0;t<o;++t){const n=s[g*o+t];e+=n*n}u[g]=Math.sqrt(e)}const h=new Uint32Array(t);void 0!==a?h.set(a):h.fill(1);const p=new Array(t);for(let g=0;g<t;++g){let e=Number.POSITIVE_INFINITY;0===u[g]?e=h[g]:(void 0!==n&&(e=Math.pow(2,Math.floor(ks(n[g]-d[g])))),void 0!==l&&(e=Math.min(e,l[g]))),p[g]=e}function f(){let e=1/0,n=-1;for(let i=0;i<t;++i){if(h[i]>=p[i])continue;let t=h[i]*u[i];t<e&&(e=t,n=i)}return n}r-=ks(jo(h));for(let g=0;g<r;++g){let e=f();if(-1===e)break;h[e]*=2}return h}var Nh;function Vh(e){if(void 0!==e.chunkDataSizes)return e.chunkDataSizes;var t=e.chunkLayoutPreference;switch(void 0===t?Nh.ISOTROPIC:t){case Nh.ISOTROPIC:return[Rh(e)];case Nh.FLAT:return function(e){const t=[],n=e.displayRank,r=e.chunkToViewTransform,s=e.rank;if(n>3)throw new Error("Unsupported view transform");if(n<3)return[Rh(e)];for(let o=0;o<3;++o){const a=(o+2)%3,l=new Float32Array(r);for(let e=0;e<s;++e)l[e*n+a]=0;t[o]=Rh((0,i.bn)((0,i.bn)({},e),{chunkToViewTransform:l}))}return t}(e)}}function Oh(e){const t=e.rank,n=e.chunkDataSize,i=e.upperVoxelBound;var r=e.lowerVoxelBound;const s=void 0===r?new Float32Array(t):r,o=new Float32Array(t),a=new Float32Array(t);for(let l=0;l<t;++l)o[l]=Math.floor(s[l]/n[l]),a[l]=Math.floor((i[l]-1)/n[l]+1);return{rank:t,chunkDataSize:n,lowerChunkBound:o,upperChunkBound:a,lowerVoxelBound:s,upperVoxelBound:i}}!function(e){e[e.ISOTROPIC=0]="ISOTROPIC",e[e.FLAT=1]="FLAT"}(Nh||(Nh={}));const Bh=new Float32Array(3),_h=new Float32Array(3),Fh=qn(),zh=new Float32Array(24);function Uh(e,t,n,i){const r=Bh,s=_h,o=t.lowerChunkDisplayBound,a=t.upperChunkDisplayBound;for(let d=0;d<3;++d)r[d]=Math.max(r[d],o[d]),s[d]=Math.min(s[d],a[d]);const l=t.curPositionInChunks,c=t.chunkDisplayDimensionIndices;!function t(){if(!i(r[0],r[1],r[2],s[0],s[1],s[2],e))return;let o=0,a=Math.max(0,s[0]-r[0]),d=a;for(let e=1;e<3;++e){const t=Math.max(0,s[e]-r[e]);d*=t,t>a&&(a=t,o=e)}if(0===d)return;if(1===d)return l[c[0]]=r[0],l[c[1]]=r[1],l[c[2]]=r[2],void n(r,e);const u=r[o],h=s[o],p=Math.floor(.5*(u+h));s[o]=p,t(),s[o]=h,r[o]=p,t(),r[o]=u}()}function Gh(e,t,n,i){if(!Ih(n,e.globalPosition,t))return;const r=n.chunkLayout.size,s=Qn(Fh,e.viewProjectionMat,n.chunkLayout.transform);for(let l=0;l<3;++l){const e=r[l];for(let t=0;t<4;++t)s[4*l+t]*=e}const o=zh;_i(o,s);const a=_h;Bh.fill(Number.NEGATIVE_INFINITY),a.fill(Number.POSITIVE_INFINITY),Uh(o,n,i,Fi)}function Wh(e,t){const n=t.finiteRank;if(3===n)return t;Mh.finiteRank=n,function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2]}(Mh.size,t.size);const i=Yn(Mh.transform,t.transform),r=Yn(Mh.invTransform,t.invTransform);Mh.detTransform=t.detTransform;const s=e.invViewMatrix,o=e.width,a=e.height,l=Wi(e.projectionMat);for(let c=n;c<3;++c){const e=s[12+c];let t=e,n=e;const r=Math.abs(s[c]*o);t-=r,n+=r;const d=Math.abs(s[c+4]*a);t-=d,n+=d;const u=Math.abs(s[c+8]*l);t-=u,n+=u;const h=Math.max(1,n-t);i[12+c]=t,i[5*c]=h}return Kn(r,i),Mh}const $h=jn();function jh(e,t,n,i,r,s){const o=e.displayDimensionRenderInfo,a=e.viewMatrix,l=e.projectionMat,c=e.width,d=e.height,u=o.voxelPhysicalScales,h=Math.abs(Hn(Bi($h,a))),p=Ri(u),f=function(e){if(1===e[15]){const t=2/Math.abs(e[10]);return 2/Math.abs(e[0])*(2/Math.abs(e[5]))*t}const t=e[10],n=2*e[14]/(2*t-2),i=(t-1)*n/(t+1);return 4/(e[0]*e[5])/3*(Math.abs(i)**3-Math.abs(n)**3)}(l)/h*p;if(0===i.length)return;const g=i[0];let m=Math.abs(g.chunkLayout.detTransform)*p;const v=g.lowerClipDisplayBound,y=g.upperClipDisplayBound;for(let C=0;C<3;++C)m*=y[C]-v[C];const b=Math.min(m,f),S=c*d,w=S/n**2/b;let x=0;for(let C=i.length-1;C>=0&&x<w;--C){const n=i[C],o=n.source.spec,a=n.chunkLayout,l=Ri(a.size)*Math.abs(a.detTransform)*p,c=o.limit,d=o.rank,u=n.nonDisplayLowerClipBound,h=n.nonDisplayUpperClipBound;let f=1;for(let e=0;e<d;++e){const t=h[e]-u[e];Sr(t)&&(f/=t)}let g=!0;const m=x+c*f/l,v=Math.pow(1/m,1/3),y=Math.sqrt(S/(m*b)),k=(w-x)*l/f,T=Math.min(1,k/o.limit);Gh(e,t,n,(()=>{g&&(r(n,C),g=!1),s(n,C,T,v,y)})),x=m}}const Hh="vec3 colormapJet(float x) {\n  vec3 result;\n  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);\n  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);\n  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);\n  return clamp(result, 0.0, 1.0);\n}\nvec3 colormapCubehelix(float x) {\n  float xclamp = clamp(x, 0.0, 1.0);\n  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);\n  float amp = xclamp * (1.0 - xclamp) / 2.0;\n  vec3 result;\n  float cosangle = cos(angle);\n  float sinangle = sin(angle);\n  result.r = -0.14861 * cosangle + 1.78277 * sinangle;\n  result.g = -0.29227 * cosangle + -0.90649 * sinangle;\n  result.b = 1.97294 * cosangle;\n  result = clamp(xclamp + amp * result, 0.0, 1.0);\n  return result;\n}\n";function Jh(e,t){return{defineShader(n,i){const r=`prop_${i}`,s=`a_${r}`;n.addAttribute(`${e}`,s),n.addVertexCode(`${e} ${r}() { return ${s}; }`),n.addInitializer((e=>{const n=e.attribute(s),i=e.gl;e.vertexShaderInputBinders[r]=-1===n?{enable(){},disable(){},bind(){}}:{enable(e){i.enableVertexAttribArray(n),i.vertexAttribDivisor(n,e)},disable(){i.vertexAttribDivisor(n,0),i.disableVertexAttribArray(n)},bind(e,r){t(i,n,e,r)}}}))}}}function qh(e,t,n,i){return Jh(e,((e,r,s,o)=>{e.vertexAttribPointer(r,t,n,i,s,o)}))}function Yh(e,t,n){return Jh(e,((e,i,r,s)=>{e.vertexAttribIPointer(i,t,n,r,s)}))}const Zh={rgb:qh("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:qh("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:qh("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:Yh("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:Yh("highp int",1,WebGL2RenderingContext.INT),uint16:Yh("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:Yh("highp int",1,WebGL2RenderingContext.SHORT),uint8:Yh("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:Yh("highp int",1,WebGL2RenderingContext.BYTE)};class Xh extends Sn{constructor(e,t,n,i,r,s,o){super(),this.gl=e,this.annotationType=t,this.rank=n,this.properties=i,this.shaderControlState=r,this.fallbackShaderParameters=s,this.shaderError=o;var a=Qs(n,this.serializedGeometryBytesPerAnnotation=po[t].serializedBytes(n),i);const l=a.offsets,c=a.serializedBytes,d=a.propertyGroupBytes;this.serializedBytesPerAnnotation=c,this.propertyOffsets=l,this.propertyGroupBytes=d,this.geometryDataStride=d[0]}getDependentShader(e,t){return eu(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(e,n)=>{const i=this.rank,r=this.properties,s=[],o=n.parseResult.code;for(let t=0,h=r.length;t<h;++t){const n=r[t],a=`prop_${n.identifier}`;o.match(new RegExp(`\\b${a}\\b`))&&(s.push(t),Zh[n.type].defineShader(e,n.identifier,i))}const a=this.propertyOffsets,l=this.propertyGroupBytes,c=new Array(l.length);c[0]=0;for(let t=1;t<l.length;++t)c[t]=c[t-1]+l[t-1];e.addInitializer((e=>{const t=s.map((t=>e.vertexShaderInputBinders[`prop_${r[t].identifier}`])),n=t.length;e.vertexShaderInputBinders.properties={enable(e){for(let i=0;i<n;++i)t[i].enable(e)},bind(e,i){for(let o=0;o<n;++o){var r=a[s[o]];let n=r.group,d=r.offset;t[o].bind(l[n],i+d+c[n]*e)}},disable(){for(let e=0;e<n;++e)t[e].disable()}}})),e.addUniform("highp vec3","uColor"),e.addUniform("highp uint","uSelectedIndex"),e.addVarying("highp vec4","vColor"),e.addUniform("highp vec3","uSubspaceMatrix",i),e.addUniform("highp mat4","uModelViewProjection"),e.addUniform("highp float","uModelClipBounds",2*i),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexCode(Hh),e.addVertexCode(`\nvec3 defaultColor() { return uColor; }\nhighp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }\n`),e.addFragmentCode("\nvoid emitAnnotation(vec4 color) {\n  emit(color, vPickID);\n}\n");const d=`\nfloat getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {\n  float coefficient = 1.0;\n  for (int i = 0; i < ${i}; ++i) {\n    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${i} + i];\n    coefficient *= max(0.0, 1.0 - d);\n  }\n  return coefficient;\n}\n`;e.addVertexCode(d),e.addFragmentCode(d),e.addVertexCode(`\nvec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {\n  vec3 result = vec3(0.0, 0.0, 0.0);\n  for (int i = 0; i < ${i}; ++i) {\n    result += uSubspaceMatrix[i] * modelPoint[i];\n  }\n  return result;\n}\n\nfloat getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {\n  float coefficient = 1.0;\n  for (int i = 0; i < ${i}; ++i) {\n    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${i} + i];\n    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${i} + i];\n    coefficient *= max(0.0, 1.0 - min(dA, dB));\n  }\n  return coefficient;\n}\n\nfloat getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {\n  float coefficient = 1.0;\n  for (int i = 0; i < ${i}; ++i) {\n    float a = modelPointA[i];\n    float b = modelPointB[i];\n    float c = uModelClipBounds[i];\n    float x = clamp(c, min(a, b), max(a, b));\n    float d = abs(x - c) * uModelClipBounds[${i} + i];\n    coefficient *= max(0.0, 1.0 - d);\n  }\n  return coefficient;\n}\n\n`),dh(n,e),e.addVertexCode(`\nconst bool PROJECTION_VIEW = ${!this.targetIsSliceView};\nbool ng_discardValue;\n#define discard ng_discard()\nvoid ng_discard() {\n  ng_discardValue = true;\n}\nvoid setLineColor(vec4 startColor, vec4 endColor);\nvoid setLineWidth(float width);\n\nvoid setAxisColor(vec4 startColor, vec4 endColor);\nvoid setAxisWidth(float width);\nvoid setSphereColor(vec4 color);\n\nvoid setEndpointMarkerColor(vec4 startColor, vec4 endColor);\nvoid setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);\nvoid setEndpointMarkerSize(float startSize, float endSize);\nvoid setEndpointMarkerBorderWidth(float startSize, float endSize);\n\nvoid setPointMarkerColor(vec4 color);\nvoid setPointMarkerBorderColor(vec4 color);\nvoid setPointMarkerSize(float size);\nvoid setPointMarkerBorderWidth(float size);\nvoid setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }\n\nvoid setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor);\nvoid setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);\nvoid setAxisEndpointMarkerSize(float startSize, float endSize);\nvoid setAxisEndpointMarkerBorderWidth(float startSize, float endSize);\n\nvoid setAxisPointMarkerColor(vec4 color);\nvoid setAxisPointMarkerBorderColor(vec4 color);\nvoid setAxisPointMarkerSize(float size);\nvoid setAxisPointMarkerBorderWidth(float size);\n\nvoid setEllipsoidFillColor(vec4 color);\n\nvoid setBoundingBoxBorderColor(vec4 color);\nvoid setBoundingBoxBorderWidth(float size);\nvoid setBoundingBoxFillColor(vec4 color);\n\nvoid setEndpointMarkerColor(vec3 startColor, vec3 endColor) {\n  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));\n}\nvoid setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {\n  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));\n}\nvoid setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }\nvoid setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }\nvoid setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }\nvoid setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }\nvoid setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }\nvoid setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }\nvoid setLineColor(vec4 color) { setLineColor(color, color); }\nvoid setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }\nvoid setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }\nvoid setAxisColor(vec4 color) { setAxisColor(color, color); }\nvoid setAxisColor(vec3 color) { setAxisColor(vec4(color, 1.0)); }\nvoid setAxisColor(vec3 startColor, vec3 endColor) { setAxisColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }\nvoid setAxisEndpointMarkerColor(vec3 startColor, vec3 endColor) {\n  setAxisEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));\n}\nvoid setAxisEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {\n  setAxisEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));\n}\nvoid setAxisEndpointMarkerColor(vec3 color) { setAxisEndpointMarkerColor(color, color); }\nvoid setAxisEndpointMarkerColor(vec4 color) { setAxisEndpointMarkerColor(color, color); }\nvoid setAxisEndpointMarkerBorderColor(vec3 color) { setAxisEndpointMarkerBorderColor(color, color); }\nvoid setAxisEndpointMarkerBorderColor(vec4 color) { setAxisEndpointMarkerBorderColor(color, color); }\nvoid setAxisEndpointMarkerSize(float size) { setAxisEndpointMarkerSize(size, size); }\nvoid setAxisEndpointMarkerBorderWidth(float size) { setAxisEndpointMarkerBorderWidth(size, size); }\nvoid setColor(vec4 color) {\n  setPointMarkerColor(color);\n  setLineColor(color);\n  setEndpointMarkerColor(color);\n  setBoundingBoxBorderColor(color);\n  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));\n  setAxisColor(color);\n  setAxisEndpointMarkerColor(color);\n  setSphereColor(color);\n}\nvoid setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }\n\nvoid setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }\nvoid setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }\n\nvoid setColor(vec3 color) { setColor(vec4(color, 1.0)); }\nvoid userMain();\n`);for(const t of Kh){var u=O(t,2);const n=u[0],i=u[1];n!==this.annotationType&&i.defineShaderNoOpSetters(e)}t(e),e.addVertexCode("\n#define main userMain\n"+tu(n.parseResult.code)+"\n#undef main\n")}})}setPartIndex(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];let r=`\nvoid setPartIndex(${n.map(((e,t)=>`highp uint partIndex${t}`)).join()}) {\n  highp uint pickID = uPickID;\n  highp uint pickBaseOffset = getPickBaseOffset();\n${n.map(((e,t)=>`highp uint pickOffset${t} = pickBaseOffset + partIndex${t};`)).join("\n")}\n`;return 0===n.length&&(r+="\n  highp uint pickOffset0 = pickBaseOffset;\n"),r+=`\n  vPickID = pickID + pickOffset0;\n  highp uint selectedIndex = uSelectedIndex;\nif (selectedIndex == pickBaseOffset${n.map(((e,t)=>` || selectedIndex == pickOffset${t}`)).join("")}) {\n    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);\n  }\n}\n`,e.addVertexCode(r),`setPartIndex(${n.join()})`}get invokeUserMain(){return"\nng_discardValue = false;\nuserMain();\nif (ng_discardValue) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\n"}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,n){var i=e(t.renderContext.emitter);const r=i.shader,s=i.parameters;if(null===r)return;r.bind();const o=this.gl,a=t.renderContext,l=t.annotationLayer;if(bh(o,r,this.shaderControlState,s.parseResult.controls),o.uniform3fv(r.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(r.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(r.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),a.emitPickID&&o.uniform1ui(r.uniform("uPickID"),t.basePickId),a.emitColor){const e=l.state.displayState.color.value;o.uniform3f(r.uniform("uColor"),e[0],e[1],e[2]),o.uniform1ui(r.uniform("uSelectedIndex"),t.selectedIndex)}const c=r.vertexShaderInputBinders.properties;c.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),c.bind(t.count,t.bufferOffset),n(r),c.disable()}}const Kh=new pt;function Qh(e,t){Kh.set(e,t)}function ep(e){return Kh.get(e)}var tp=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};class np{constructor(e){this.source=e,this.state=el.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=el.GPU_MEMORY}freeGPUMemory(e){this.state=el.SYSTEM_MEMORY}}function ip(e){if("number"!=typeof e||e<0)throw new Error(`Expected non-negative number as limit, but received: ${Bt(e)}`);return e}class rp{constructor(){let{defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.sizeLimit=new Ln(t,ip),this.itemLimit=new Ln(e,ip)}}let sp=class extends gd{constructor(e,t,n,i){super(),this.gl=t,this.frameNumberCounter=n,this.capacities=i,this.visibleChunksChanged=new kn,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new Vd(!0,!0);const r=t=>({itemLimit:this.registerDisposer(Cd.makeFromExisting(e,t.itemLimit)).rpcId,sizeLimit:this.registerDisposer(Cd.makeFromExisting(e,t.sizeLimit)).rpcId});this.initializeCounterpart(e,{gpuMemoryCapacity:r(i.gpuMemory),systemMemoryCapacity:r(i.systemMemory),downloadCapacity:r(i.download),computeCapacity:r(i.compute),enablePrefetch:this.registerDisposer(Cd.makeFromExisting(e,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){let e,t=this.chunkUpdateDeadline;e=null===t||Date.now()<t?0:this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.chunkUpdateDeadline;!e&&null===t&&(t=Date.now()+30);let n=!1,i=0;for(;;){if(!e&&Date.now()>t){this.chunkUpdateDeadline=null,setTimeout((()=>this.processPendingChunkUpdates()),this.chunkUpdateDelay);break}let r=this.pendingChunkUpdates;if(null==r)break;if(this.applyChunkUpdate(r)&&(n=!0),++i,null==(this.pendingChunkUpdates=r.nextUpdate)){this.pendingChunkUpdatesTail=null;break}}return n&&this.visibleChunksChanged.dispatch(),i}handleFetch_(e,t){var n=t.promise;const i=n.resolve,r=n.reject;if(n.cancellationToken.isCanceled)return void r(ed);const s=t.key,o=e.chunks.get(s);if(!o)return void r(new Error(`No chunk found at ${s} for source ${e.constructor.name}`));const a=o.data;a?i({value:a}):r(new Error(`At ${s} for source ${e.constructor.name}: chunk has no data`))}applyChunkUpdate(e){let t=!1;const n=this.rpc.get(e.source);if(void 0!==e.promise)this.handleFetch_(n,e);else if(void 0===e.id){for(const e of n.chunks.keys())n.deleteChunk(e);t=!0}else{let i=e.state;if(i===el.EXPIRED)n.deleteChunk(e.id);else{let r,s=e.id;if(e.new?(r=n.getChunk(e),n.addChunk(s,r)):r=n.chunks.get(s),i!==r.state)switch(i){case el.GPU_MEMORY:r.copyToGPU(this.gl),t=!0;break;case el.SYSTEM_MEMORY:r.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${el[i]}`)}}}return t}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){const e=this.rpc,t=await e.promiseInvoke("ChunkQueueManager.requestChunkStatistics",{queue:this.rpcId}),n=new pt;for(const r of t){var i=O(r,2);const t=i[0],s=i[1],o=e.get(t);void 0!==o&&n.set(o,s)}return n}};function op(e,t){let n=e.get(t.source),i=n.chunkManager.chunkQueueManager;if(n.immediateChunkUpdates)return void(i.applyChunkUpdate(t)&&i.visibleChunksChanged.dispatch());let r=i.pendingChunkUpdatesTail;null==r?(i.pendingChunkUpdates=t,i.pendingChunkUpdatesTail=t,i.scheduleChunkUpdate()):(r.nextUpdate=t,i.pendingChunkUpdatesTail=t)}sp=tp([yd("ChunkQueueManager")],sp),dd("Chunk.update",(function(e){op(this,e)})),hd("Chunk.retrieve",(function(e,t){return new Qc(((n,i)=>{e.promise={resolve:n,reject:i,cancellationToken:t},op(this,e)}))})),dd("ChunkManager.chunkLayerStatistics",(function(e){const t=this.get(e.id);for(const n of t.prevStatisticsLayers)n.numVisibleChunksNeeded=0,n.numVisibleChunksAvailable=0,n.numPrefetchChunksNeeded=0,n.numPrefetchChunksAvailable=0;t.prevStatisticsLayers.length=0;for(const n of e.layers){const e=this.get(n.id);if(void 0===e)continue;const i=e.layerChunkProgressInfo;i.numVisibleChunksAvailable=n.numVisibleChunksAvailable,i.numVisibleChunksNeeded=n.numVisibleChunksNeeded,i.numPrefetchChunksAvailable=n.numPrefetchChunksAvailable,i.numPrefetchChunksNeeded=n.numPrefetchChunksNeeded,t.prevStatisticsLayers.push(i)}t.layerChunkStatisticsUpdated.dispatch()}));let ap=class extends gd{constructor(e){super(),this.chunkQueueManager=e,this.memoize=new cl,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new kn,this.registerDisposer(e.addRef()),this.initializeCounterpart(e.rpc,{chunkQueueManager:e.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(e,t){const n=e.encodeOptions(t);n.constructorId=Gd(e);const i=Pr(n);return this.memoize.get(i,(()=>{const i=new e(this,t);return i.initializeCounterpart(this.rpc,{}),i.key=n,i}))}};ap=tp([yd("ChunkManager")],ap);class lp extends gd{constructor(e){super(),this.chunkManager=e,this.chunks=new pt,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){const t=this.chunks.get(e);t.state===el.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke("ChunkSource.invalidate",{id:this.rpcId})}static encodeOptions(e){return{}}}function cp(e,t){let n=class extends e{constructor(){super(...arguments);const e=arguments.length<=1?void 0:arguments[1];this.parameters=e.parameters}initializeCounterpart(e,t){t.parameters=this.parameters,super.initializeCounterpart(e,t)}static encodeOptions(e){return(0,i.bn)({parameters:e.parameters},super.encodeOptions(e))}};return n=tp([yd(t.RPC_ID)],n),n}class dp extends gd{constructor(e){super(),this.layerChunkProgressInfo=e}}var up;!function(e){e[e.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",e[e.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",e[e.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",e[e.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED"}(up||(up={}));class hp{}class pp extends Sn{constructor(e,t,n){super(),this.graph=e,this.segmentsState=t,this.transform=n}createRenderLayers(e,t,n){return[]}}const fp=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function gp(e){return`${e.low},${e.high}`}function mp(e){return!!(e.high>>>31)}function vp(e){return e.useTemporaryVisibleSegments.value?e.temporaryVisibleSegments:e.visibleSegments}function yp(e,t){const n=vp(e),i=function(e){return e.useTemporarySegmentEquivalences.value?e.temporarySegmentEquivalences:e.segmentEquivalences}(e);if(i.disjointSets){const e=i.disjointSets.visibleSegmentEquivalencePolicy.value;for(let r of n.unsafeKeys())if(e&up.NONREPRESENTATIVE_EXCLUDED){t(r,i.get(r))}else{if(void 0===i.disjointSets||!i.disjointSets.isMinElement(r))continue;for(let n of i.setElements(r))e&up.REPRESENTATIVE_EXCLUDED&&e&up.MAX_REPRESENTATIVE&&mp(n)||t(n,r)}}}const bp=40;function Sp(e){return(ks(e)- -4)/.5}function wp(e){return new Ln(e,Lr)}class xp{constructor(){this.visibility=new Td,this.changed=new kn,this.frameNumber=-1,this.spatialScales=new pt,this.numHistogramRows=1,this.value=new Uint32Array(bp*this.numHistogramRows*2)}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.changed.dispatch())}add(e,t,n,i){let r=this.spatialScales,s=this.numHistogramRows,o=this.value,a=r.get(e);if(void 0===a&&(a=r.size,r.set(e,a)),a>=s){this.numHistogramRows=s*=2;const e=new Uint32Array(s*bp*2);e.set(o),this.value=o=e}const l=a*bp*2+Math.min(Math.max(0,Math.round(Sp(t))),39);o[l]+=n,o[l+bp]+=i}}class Cp extends Md{constructor(e,t,n){var i;super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new pt,this.visibleSourcesList_=[];var r=n.renderScaleTarget;const s=void 0===r?wp(1):r;this.renderScaleTarget=s,this.renderScaleHistogram=n.renderScaleHistogram,this.transform=n.transform,this.localPosition=n.localPosition,this.rpcTransfer=n.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer(null!==(i=n.dataHistogramSpecifications)&&void 0!==i?i:new Gu(_n([]),_n([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){const e=this.dataHistogramSpecifications;return e.visibility.visible?e.bounds.value.length:0}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){const n=this.visibleSources,i=n.get(e);void 0!==i?(++i.refCount,i.chunkTransform=t):(n.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){const t=this.visibleSources,n=t.get(e);1!==n.refCount?--n.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){const e=this.visibleSources,t=this.visibleSourcesList_;if(0===t.length&&0!==e.size){for(const n of e.values())t.push(n);t.sort(((e,t)=>e.chunkTransform.chunkToLayerTransformDet-t.chunkTransform.chunkToLayerTransformDet))}return t}initializeCounterpart(){const e=this.registerDisposer(new dp(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,(0,i.bn)({localPosition:this.registerDisposer(Cd.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Cd.makeFromExisting(t,this.renderScaleTarget)).rpcId},this.rpcTransfer)),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return function*(e,t,n){const i=1.1*e.projectionParameters.value.pixelSize,r=n[0].effectiveVoxelSize,s=t.renderScaleTarget.value,o=e=>{const t=i*s;for(let n=0;n<3;++n){const i=e[n];if(i>t&&i>1.01*r[n])return!0}return!1},a=(e,t)=>{const n=i*s;for(let i=0;i<3;++i){const r=e[i],s=t[i];if(Math.abs(n-r)<Math.abs(n-s)&&r<1.01*s)return!0}return!1};let l,c=n.length-1;for(;;){const e=n[c];if(void 0!==l&&!a(e.effectiveVoxelSize,l)||(yield e,0===c||!o(e.effectiveVoxelSize)))break;l=e.effectiveVoxelSize,--c}}(e,this,t)}}Cp.prototype.RPC_TYPE_ID="sliceview/RenderLayer";class kp extends Pd{draw(e,t){}isReady(e,t){return!0}}var Tp=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};const Ep=Ed(class extends Ah{});function Lp(e){return{source:e.source.addCounterpartRef(),effectiveVoxelSize:e.effectiveVoxelSize,layerRank:e.layerRank,nonDisplayLowerClipBound:e.nonDisplayLowerClipBound,nonDisplayUpperClipBound:e.nonDisplayUpperClipBound,lowerClipBound:e.lowerClipBound,upperClipBound:e.upperClipBound,lowerClipDisplayBound:e.lowerClipDisplayBound,upperClipDisplayBound:e.upperClipDisplayBound,chunkDisplayDimensionIndices:e.chunkDisplayDimensionIndices,lowerChunkDisplayBound:e.lowerChunkDisplayBound,upperChunkDisplayBound:e.upperChunkDisplayBound,fixedLayerToChunkTransform:e.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:e.combinedGlobalLocalToChunkTransform,chunkLayout:e.chunkLayout.toObject()}}function Ip(e){return e.map((e=>e.map(Lp)))}function Dp(e,t){for(const n of t)for(const t of n){const n=t.source;e.removeSource(n),n.dispose()}}let Mp=class extends Ep{constructor(e,t,n,i){super(new Rd({parametersConstructor:Ph,navigationState:n,update:(e,t)=>{const n=e.invViewMatrix,i=e.centerDataPosition;t.toMat4(n);var r=e.displayDimensionRenderInfo;const s=r.canonicalVoxelFactors,o=r.voxelPhysicalScales;for(let g=0;g<3;++g)i[g]=n[12+g];const a=e.logicalWidth,l=e.logicalHeight,c=e.projectionMat,d=e.viewportNormalInGlobalCoordinates,u=e.viewportNormalInCanonicalCoordinates,h=t.relativeDepthRange;ei(c,-a/2,a/2,l/2,-l/2,-h,h),ul(e,c),bl(e);const p=e.viewMatrix;for(let g=0;g<3;++g){const e=d[g]=p[4*g+2];u[g]=e/s[g]}ui(d,d),ui(u,u);let f=0;for(let g=0;g<3;++g){f+=(o[g]*n[g])**2}f=Math.sqrt(f),e.pixelSize=f}})),this.chunkManager=e,this.layerManager=t,this.navigationState=n,this.wireFrame=i,this.gl=this.chunkManager.gl,this.viewChanged=new kn,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=new Array,this.offscreenFramebuffer=this.registerDisposer(new mu(this.gl,{colorBuffers:gu(this.gl,1),depthBuffer:new fu(this.gl)})),this.histogramInputTextures=[],this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=Hu.get(this.gl),this.updateVisibleLayers=this.registerCancellable(mn((()=>{this.updateVisibleLayersNow()}),0)),this.registerDisposer(n),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add(((e,t)=>{e.displayDimensionRenderInfo!==t.displayDimensionRenderInfo&&this.updateVisibleLayers()})));const r=this.chunkManager.rpc,s=this.sharedProjectionParameters=this.registerDisposer(new Nd(r,this.projectionParameters));this.initializeCounterpart(r,{chunkManager:e.rpcId,projectionParameters:s.rpcId}),this.registerDisposer(t.layersChanged.add((()=>{this.updateVisibleLayers()}))),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add((()=>{this.renderingStale=!0})),this.registerDisposer(e.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(e,t){this.histogramGenerator.compute(e,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,t,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(e,t,n){!function(e,t,n,i,r){if(!Ih(n,e.globalPosition,t))return;const s=i.size,o=Qn(Fh,e.viewProjectionMat,i.transform);for(let u=0;u<3;++u){const e=s[u];for(let t=0;t<4;++t)o[4*u+t]*=e}const a=Eh;Kn(a,o);const l=Bh,c=_h;for(let u=0;u<3;++u){const e=a[12+u]+.001/s[u],t=Math.abs(a[u]),n=Math.abs(a[4+u]);l[u]=Math.floor(e-t-n),c[u]=Math.floor(e+t+n+1)}const d=zh;for(let u=0;u<3;++u){const e=o[4*u],t=o[4*u+1],n=o[4*u+2];d[u]=e,d[4+u]=-e,d[8+u]=+t,d[12+u]=-t,d[16+u]=+n,d[20+u]=-n}{const e=o[12],t=o[13],n=o[14];d[3]=1+e,d[7]=1-e,d[11]=1+t,d[15]=1-t,d[19]=n,d[23]=-n}Uh(d,n,r,zi)}(this.projectionParameters.value,e.renderLayer.localPosition.value,e,t,(()=>{n(e.curPositionInChunks.join())}))}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let e=0,t=0;for(const n of this.visibleLayers.values()){const i=n.visibleSources;for(const n of i){const i=Wh(this.projectionParameters.value,n.chunkLayout),r=n.source.chunks;this.forEachVisibleChunk(n,i,(n=>{const i=r.get(n);++t,i&&i.state===el.GPU_MEMORY&&++e}))}}return e===t}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(e,t){t.push(e.localPosition.changed.add((()=>this.invalidateVisibleChunks()))),t.push(e.redrawNeeded.add(this.viewChanged.dispatch)),t.push(e.transform.changed.add(this.updateVisibleLayers)),t.push(e.renderScaleTarget.changed.add((()=>this.invalidateVisibleSources())));const n=e.renderScaleHistogram;void 0!==n&&t.push(n.visibility.add(this.visibility)),t.push(e.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;const e=Date.now(),t=this.visibleLayers,n=this.visibleLayerList,i=this.projectionParameters.value.displayDimensionRenderInfo;let r=this.rpc,s={id:this.rpcId},o=!1;n.length=0;for(let l of this.layerManager.readyRenderLayers())if(l instanceof Cp){n.push(l);let a=t.get(l);if(void 0===a){const n=[],r=new wl;a={messages:r,allSources:this.getTransformedSources(l,r),transformGeneration:l.transform.changed.count,visibleSources:[],disposers:n,lastSeenGeneration:e,displayDimensionRenderInfo:i},n.push(l.messages.addChild(a.messages)),t.set(l.addRef(),a),this.bindVisibleRenderLayer(l,n)}else{a.lastSeenGeneration=e;const t=l.transform.changed.count;if(a.transformGeneration===t&&a.displayDimensionRenderInfo===i)continue;const n=a.allSources;a.allSources=this.getTransformedSources(l,a.messages),Dp(l,n),a.visibleSources.length=0,a.displayDimensionRenderInfo=i,a.transformGeneration=t}s.layerId=l.rpcId,s.sources=Ip(a.allSources),this.flushBackendProjectionParameters(),r.invoke("SliceView.addVisibleLayer",s),o=!0}for(const l of t){var a=O(l,2);const n=a[0],i=a[1];i.lastSeenGeneration!==e&&(s.layerId=n.rpcId,r.invoke("SliceView.removeVisibleLayer",s),t.delete(n),Dp(n,i.allSources),yn(i.disposers),n.dispose(),o=!0)}return o&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),o}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(e){const t=this.offscreenFramebuffersWithHistograms;let n=t[e];if(void 0===n){const i=this.gl,r=this.histogramInputTextures,s=this.offscreenFramebuffer;r.length<e&&r.push(...gu(i,e-r.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));let o=[s.colorBuffers[0].addRef()];for(let t=0;t<e;++t)o.push(r[t].addRef());n=this.registerDisposer(new mu(i,{colorBuffers:o,depthBuffer:s.depthBuffer.addRef()})),t[e]=n}return n}updateRendering(){const e=this.projectionParameters.value,t=e.width,n=e.height;if(!this.renderingStale||!this.valid||0===t||0===n)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();let i=this.gl,r=this.offscreenFramebuffer;r.bind(t,n),i.disable(i.SCISSOR_TEST),i.clearColor(0,0,0,0),i.colorMask(!0,!0,!0,!0),i.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let s=0;const o=this.wireFrame.value,a={sliceView:this,projectionParameters:e,wireFrame:o};for(let l of this.visibleLayerList){const e=o?0:l.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(e).bind(t,n);for(let t=0;t<e;++t)i.clearBufferfv(WebGL2RenderingContext.COLOR,1+t,Pi);i.enable(WebGL2RenderingContext.DEPTH_TEST),i.depthFunc(WebGL2RenderingContext.LESS),i.clearDepth(1),i.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),l.setGLBlendMode(i,s),l.draw(a),++s}i.disable(WebGL2RenderingContext.BLEND),i.disable(WebGL2RenderingContext.DEPTH_TEST),r.unbind()}disposed(){for(const t of this.visibleLayers){var e=O(t,2);const n=e[0],i=e[1];Dp(n,i.allSources),yn(i.disposers),n.dispose()}this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(e,t){const n=Vp(this.projectionParameters.value.displayDimensionRenderInfo,e.transform.value,(t=>e.getSources(t)),t,e);for(const i of n)for(const t of i)e.addSource(t.source,t.chunkTransform);return n}};Mp=Tp([yd("SliceView")],Mp);class Pp extends lp{constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:It(e.chunkDataSize),lowerVoxelBound:It(e.lowerVoxelBound),upperVoxelBound:It(e.upperVoxelBound)}}static encodeOptions(e){const t=super.encodeOptions(e);return t.spec=this.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}}class Ap extends np{constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=el.SYSTEM_MEMORY}}let Rp=class e extends Sn{constructor(e,t){super(),this.gl=e,this.copyVertexPositionsBuffer=su(this.gl),this.textureCoordinateAdjustment=new Float32Array(4);let n=new Zd(e);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler"),n.addInitializer((t=>{e.uniform1i(t.uniform("uSampler"),0)})),n.addUniform("vec4","uColorFactor"),n.addUniform("vec4","uBackgroundColor"),n.addUniform("mat4","uProjectionMatrix"),n.addUniform("vec4","uTextureCoordinateAdjustment"),n.require(t),n.setFragmentMain("\nvec4 sampledColor = texture(uSampler, vTexCoord);\nif (sampledColor.a == 0.0) {\n  sampledColor = uBackgroundColor;\n}\nemit(sampledColor * uColorFactor, 0u);\n"),n.addAttribute("vec4","aVertexPosition"),n.setVertexMain("\nvTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;\ngl_Position = uProjectionMatrix * aVertexPosition;\n"),this.shader=this.registerDisposer(n.build())}draw(e,t,n,i,r,s,o,a){let l=this.gl,c=this.shader,d=this.textureCoordinateAdjustment;d[0]=r,d[1]=s,d[2]=o-r,d[3]=a-s,c.bind(),l.activeTexture(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,e),l.disable(WebGL2RenderingContext.BLEND),l.uniformMatrix4fv(c.uniform("uProjectionMatrix"),!1,t),l.uniform4fv(c.uniform("uColorFactor"),n),l.uniform4fv(c.uniform("uBackgroundColor"),i),l.uniform4fv(c.uniform("uTextureCoordinateAdjustment"),d);let u=c.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(u,2),l.drawArrays(l.TRIANGLE_FAN,0,4),l.disableVertexAttribArray(u),l.bindTexture(l.TEXTURE_2D,null)}static get(t,n){return t.memoize.get(`sliceview/SliceViewRenderHelper:${Gd(n)}`,(()=>new e(t,n)))}};class Np{constructor(e){this.chunkManager=e}}function Vp(e,t,n,i,r){i.clearMessages();const s=e=>(i.addMessage({severity:Sl.error,message:e}),[]);if(void 0!==t.error)return s(t.error);const o=t.rank,a=t.unpaddedRank,l=e.displayDimensionIndices,c=e.displayRank,d=e.canonicalVoxelFactors,u=$a(t,l),h=u.displayToLayerDimensionIndices,p=new Float32Array(c*a),f=t.modelToRenderLayerTransform;for(let y=0;y<c;++y){const e=h[y];if(-1===e)continue;const t=d[y];for(let n=0;n<a;++n)p[c*n+y]=f[(o+1)*n+e]*t}const g=n({displayRank:c,multiscaleToViewTransform:p,modelChannelDimensionIndices:t.channelToRenderLayerDimensions}),m=e.voxelPhysicalScales;try{const e=e=>{const n=e.chunkSource,i=n.spec;var s=e.lowerClipBound;const o=void 0===s?i.lowerVoxelBound:s;var l=e.upperClipBound;const d=void 0===l?i.upperVoxelBound:l,h=Wa(t,e.chunkToMultiscaleTransform),p=i.chunkDataSize,f=h.channelToChunkDimensionIndices,g=new Float32Array(a),v=new Float32Array(a);g.set(o),v.set(d);const y=f.length,b=t.channelSpaceShape;for(let r=0;r<y;++r){const e=f[r];if(-1===e)continue;const n=b[r];if(p[e]!==n)throw new Error("Channel dimension "+t.layerDimensionNames[t.channelToRenderLayerDimensions[r]]+` has extent ${n} but corresponding chunk dimension has extent ${p[e]}`);g[e]=Number.NEGATIVE_INFINITY,v[e]=Number.POSITIVE_INFINITY}const S=ja(h,u),w=ti(),x=ti(),C=ti(),k=ti(),T=ti(),E=S.numChunkDisplayDims,L=S.chunkDisplayDimensionIndices,I=h.combinedGlobalLocalToChunkTransform,D=h.layerRank,M=h.combinedGlobalLocalRank,P=new Float32Array(I);for(let t=0;t<E;++t){const e=L[t];for(let t=0;t<=M;++t)P[e+t*D]=0;e<a?(T[t]=i.chunkDataSize[e],w[t]=i.lowerChunkBound[e],x[t]=i.upperChunkBound[e],C[t]=o[e],k[t]=d[e],g[e]=Number.NEGATIVE_INFINITY,v[e]=Number.POSITIVE_INFINITY):(T[t]=1,w[t]=0,x[t]=1,C[t]=0,k[t]=1)}T.fill(1,E),w.fill(0,E),x.fill(1,E),C.fill(0,E),k.fill(1,E);const A=new Th(T,S.displaySubspaceModelMatrix,E),R=A.localSpatialVectorToGlobal(ti(),Ai);for(let t=0;t<c;++t)R[t]=Math.abs(R[t]*m[t]);return R.fill(1,c),{layerRank:D,lowerClipBound:o,upperClipBound:d,nonDisplayLowerClipBound:g,nonDisplayUpperClipBound:v,renderLayer:r,source:n,lowerChunkDisplayBound:w,upperChunkDisplayBound:x,lowerClipDisplayBound:C,upperClipDisplayBound:k,effectiveVoxelSize:R,chunkLayout:A,chunkDisplayDimensionIndices:L,fixedLayerToChunkTransform:P,curPositionInChunks:new Float32Array(a),combinedGlobalLocalToChunkTransform:h.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(a),chunkTransform:h,chunkDisplayTransform:S}};return g.map((t=>t.map((t=>e(t)))))}catch(v){for(const e of g)for(const t of e)t.chunkSource.dispose();const t=e.globalDimensionNames;return s(`Cannot render (${It(e.displayDimensionIndices.filter((e=>-1!==e)),(e=>t[e])).join(",\xa0")}) cross section: ${v.message}`)}}let Op=null;class Bp{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(null===Op){Op=document.createElement("ul"),Op.id="statusContainer";const e=document.getElementById("neuroglancer-container");e?e.appendChild(Op):document.body.appendChild(Op)}let t=document.createElement("li");this.element=t,!0===e&&(e=200),!1!==e?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,Op.appendChild(t)}dispose(){Op.removeChild(this.element),this.element=void 0,null!==this.timer&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){null!==this.timer&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){let n=new Bp(t.delay);n.setText(t.initialMessage);let i=n.dispose.bind(n);return e.then(i,(e=>{let i;i=e instanceof Error?e.message:""+e;var r=t.errorPrefix;let s=void 0===r?"":r;n.setErrorMessage(s+i),n.setVisible(!0)})),e}setErrorMessage(e){this.element.textContent=e+" ";let t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",(()=>{this.dispose()})),this.element.appendChild(t)}static showMessage(e){const t=new Bp;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2e3;const n=this.showMessage(e);return window.setTimeout((()=>n.dispose()),t),n}}var _p=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};function Fp(e){let t=0;const n=e.typeToIds;for(const i of Xs)t+=ep(i).pickIdsPerInstance*n[i].length;return t}class zp{constructor(e){this.bufferValid=!1,this.numPickIds=0,this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){const t=this.buffer;void 0!==t&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class Up extends np{constructor(e,t){super(e),void 0!==t.data&&(this.data=new zp(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;void 0!==t&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class Gp extends Ap{constructor(e,t){super(e,t),void 0!==t.data&&(this.data=new zp(t))}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.data;void 0!==t&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}let Wp=class extends Pp{constructor(e,t){super(e,t),this.immediateChunkUpdates=!0,(this.parent=t.parent).spatiallyIndexedSources.add(this);var n=this.spec;const i=n.rank,r=n.chunkDataSize,s=this.multiscaleToChunkTransform=new Float32Array((i+1)**2);Lo(s,i+1,this.spec.chunkToMultiscaleTransform,i+1,i+1);for(let o=0;o<i;++o)for(let e=0;e<i+1;++e)s[(i+1)*e+o]/=r[o]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(e,t){t.parent=this.parent.rpcId,super.initializeCounterpart(e,t)}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new Gp(this,e)}};Wp=_p([yd("annotation.GeometryChunkSource")],Wp);let $p=class extends lp{constructor(e,t,n){super(e,{}),this.parent=t,this.relationshipIndex=n,this.immediateChunkUpdates=!0}addChunk(e,t){super.addChunk(e,t)}getChunk(e){return new Up(this,e)}};$p=_p([yd("annotation.SubsetGeometryChunkSource")],$p);class jp extends np{constructor(e,t){super(e),this.annotation=So(t.annotation)}}let Hp=class extends lp{constructor(e,t){super(e),this.parent=t}getChunk(e){return new jp(this,e)}addChunk(e,t){super.addChunk(e,t);const n=this.parent.references.get(e);void 0!==n&&(n.value=t.annotation,n.changed.dispatch())}deleteChunk(e){const t=this.parent.references.get(e);void 0!==t&&(t.value=void 0,t.changed.dispatch())}};function Jp(e,t,n,i){const r=new Uint8Array(e.data.length+i);for(const s of Xs){if(s===n)continue;let o=e.typeToOffset[s],a=o;s>n&&(a+=i,e.typeToOffset[s]=a),r.set(e.data.subarray(o,o+e.typeToIds[s].length*t[s].serializedBytes),a)}return r}function qp(e,t,n,i,r,s,o,a){const l=e.typeToOffset[n];let c=l,d=l;const u=t[n].propertyGroupBytes,h=u.length,p=e.typeToIds[n].length;for(let f=0;f<h;++f){const t=u[f];i.set(e.data.subarray(c+r*t,c+s*t),d+o*t),c+=t*p,d+=t*a}}function Yp(e,t,n){const i=t.type,r=n[i].rank,s=e.serializedAnnotations,o=s.typeToIds[i],a=s.typeToIdMaps[i],l=po[i],c=n[i].serializedBytes;let d=a.get(t.id);if(void 0===d){d=a.size,a.set(t.id,d);const e=Jp(s,n,i,c);qp(s,n,i,e,0,d,0,d+1),o.push(t.id),s.data=e}const u=s.typeToOffset[i],h=new DataView(s.data.buffer,s.data.byteOffset,s.data.byteLength),p=ur===dr.LITTLE,f=n[i];l.serialize(h,u+f.propertyGroupBytes[0]*d,p,r,t),f.serialize(h,u,d,o.length,p,t.properties),e.bufferValid=!1}function Zp(e,t,n,i){const r=e.serializedAnnotations,s=r.typeToIdMaps[t],o=s.get(n);if(void 0===o)return!1;const a=r.typeToIds[t],l=Jp(r,i,t,-i[t].serializedBytes);qp(r,i,t,l,0,o,0,a.length-1),qp(r,i,t,l,o+1,a.length,o,a.length-1),a.splice(o,1),s.delete(n);for(let c=o,d=a.length;c<d;++c)s.set(a[c],c);return r.data=l,e.bufferValid=!1,!0}Hp=_p([yd("annotation.MetadataChunkSource")],Hp);class Xp extends gd{constructor(e,t){super(),this.chunkManager=e,this.metadataChunkSource=this.registerDisposer(new Hp(this.chunkManager,this)),this.spatiallyIndexedSources=new Rt,this.temporary=function(){const e=[],t=[],n=[];for(const i of Xs)e[i]=[],t[i]=0,n[i]=new pt;return new Gp(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:t,typeToIds:e,typeToIdMaps:n})}(),this.references=new pt,this.localUpdates=new pt,this.numCommitsInProgress=0,this.changed=new kn,this.referencesChanged=new Cn,this.readonly=!1,this.childRefreshed=new kn,this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=to(this.rank,this.properties);const n=this.segmentFilteredSources=[],i=t.relationships;this.relationships=i;for(let r=0,s=i.length;r<s;++r)n.push(this.registerDisposer(new $p(e,this,r)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(const n of this.segmentFilteredSources)n.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map((e=>e.addCounterpartRef())),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e.id=vo();const n=new Ys(e.id);return n.value=e,this.references.set(n.id,n),this.referencesChanged.dispatch({action:"adding",id:n.id}),n.registerDisposer((()=>{this.references.delete(n.id),this.referencesChanged.dispatch({action:"deref",id:n.id})})),this.applyLocalUpdate(n,!1,t,e),n}applyLocalUpdate(e,t,n,i){const r=this.localUpdates,s=e.id;let o=this.localUpdates.get(s);const a=e.value;if(null==a)throw new Error("Cannot create local update from null annotation");if(void 0===o?(o={type:a.type,reference:e.addRef(),existingAnnotation:t?a:void 0,pendingCommit:void 0,commitInProgress:void 0},r.set(s,o),this.forEachPossibleChunk(a,(e=>{const t=e.data;if(void 0===t)return;Zp(t,a.type,s,this.annotationPropertySerializers)})),null!==i&&Yp(this.temporary.data,i,this.annotationPropertySerializers)):(null===i?Zp(this.temporary.data,a.type,a.id,this.annotationPropertySerializers):Yp(this.temporary.data,i,this.annotationPropertySerializers),e.value=i),n)if(void 0!==o.commitInProgress)o.pendingCommit=i;else{if(null===i&&void 0===o.existingAnnotation)return r.delete(s),void o.reference.dispose();this.sendCommitRequest(o,i)}this.notifyChanged(e.id,i||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke("annotation.commit",{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){const n=this.references.get(e),i=this.metadataChunkSource.chunks.get(e);void 0!==i&&(i.annotation=t||null),void 0!==n&&(n.value=t||null,n.changed.dispatch(),this.referencesChanged.dispatch({action:"changed",id:e})),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}updateReference(e){let t=this.references.get(e.id);if(void 0!==t)t.value=e;else{let t=new Ys(e.id);this.references.set(e.id,t),t.value=e,this.referencesChanged.dispatch({action:"update",id:t.id}),t.registerDisposer((()=>{this.references.delete(t.id),this.referencesChanged.dispatch({action:"deref",id:t.id})}))}}hasReference(e){return this.references.has(e)}getReference(e){let t=this.references.get(e);if(void 0!==t)return t.addRef();t=new Ys(e),this.references.set(e,t),this.referencesChanged.dispatch({action:"get",id:e}),this.rpc.invoke("annotation.reference.add",{id:this.rpcId,annotation:e}),t.registerDisposer((()=>{this.references.delete(e),this.referencesChanged.dispatch({action:"deref",id:e}),this.rpc.invoke("annotation.reference.delete",{id:this.rpcId,annotation:e})}));const n=this.metadataChunkSource.chunks.get(e);return void 0!==n&&null!==n.annotation&&(t.value=n.annotation),t}forEachPossibleChunk(e,t){const n=e.relatedSegments;if(void 0!==n){const e=n.length,i=this.segmentFilteredSources;for(let r=0;r<e;++r){const e=n[r];if(void 0===e)return;const s=i[r];for(const n of e){const e=s.chunks.get(gp(n));void 0!==e&&t(e)}}}const i=this.rank,r=new Float32Array(i),s=new Float32Array(i),o=new Float32Array(i);for(const a of this.spatiallyIndexedSources){switch(e.type){case Zs.POINT:Io(r,a.multiscaleToChunkTransform,i+1,e.point,i),s.set(r);break;case Zs.LINE:case Zs.SPHERE:case Zs.AXIS_ALIGNED_BOUNDING_BOX:Io(r,a.multiscaleToChunkTransform,i+1,e.pointA,i),Io(s,a.multiscaleToChunkTransform,i+1,e.pointB,i);break;case Zs.ELLIPSOID:Io(r,a.multiscaleToChunkTransform,i+1,e.center,i),Do(s,a.multiscaleToChunkTransform,i+1,e.radii,i);for(let e=0;e<i;++e){const t=r[e],n=s[e];r[e]=t-n,s[e]=t+n}}let n=1;for(let e=0;e<i;++e){const t=r[e],i=s[e],o=Math.min(t,i),a=Math.max(t,i);r[e]=Math.ceil(o-1),s[e]=Math.floor(a+1),n*=s[e]-r[e]}const l=a.chunks;for(let e=0;e<n;++e){let n=e;for(let e=0;e<i;++e){const t=r[e],i=s[e]-t;n=(n-(o[e]=n%i))/i}const a=l.get(o.join());void 0!==a&&t(a)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){const n=this.localUpdates.get(e);if(void 0===n||void 0===n.commitInProgress)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),null!==t&&n.reference.id!==t.id){if(null===n.commitInProgress)throw new Error("Received invalid successful update notification");n.reference.id=t.id,this.references.delete(e),this.references.set(t.id,n.reference.addRef()),this.localUpdates.delete(e),this.localUpdates.set(t.id,n),null!==n.reference.value&&(n.reference.value.id=t.id,Zp(this.temporary.data,n.type,e,this.annotationPropertySerializers),Yp(this.temporary.data,n.reference.value,this.annotationPropertySerializers)),n.reference.changed.dispatch()}let i=void 0===n.existingAnnotation;n.existingAnnotation=t||void 0,n.commitInProgress=void 0;let r=n.pendingCommit;n.pendingCommit=void 0,null===t&&(r=void 0),void 0!==r?(null!==r&&(r.id=t.id),this.sendCommitRequest(n,r)):(this.revertLocalUpdate(n),i?(this.childAdded.dispatch(t),this.referencesChanged.dispatch({action:"added",id:t.id})):null===t?(this.references.get(e).dispose(),this.childDeleted.dispatch(e),this.referencesChanged.dispatch({action:"deleted",id:e})):(this.childUpdated.dispatch(t),this.referencesChanged.dispatch({action:"updated",id:t.id})))}disposed(){const e=this.commitStatus;void 0!==e&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,0===this.numCommitsInProgress?void 0!==this.commitStatus&&(this.commitStatus.dispose(),this.commitStatus=void 0):void 0===this.commitStatus&&(this.commitStatus=new Bp(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){const n=this.localUpdates.get(e);if(void 0===n||void 0===n.commitInProgress)throw new Error("Received invalid update notification");(new Bp).setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(n),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){Zp(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);const t=e.existingAnnotation;void 0!==t&&this.forEachPossibleChunk(t,(e=>{const n=e.data;void 0!==n&&Yp(n,t,this.annotationPropertySerializers)}));const n=e.reference,i=n.id;n.value=t||null,n.changed.dispatch(),n.dispose(),this.localUpdates.delete(i)}*[i.bm](){}}function Kp(e,t){return e<t?-1:e>t?1:0}dd("annotation.commit",(function(e){const t=this.get(e.id),n=e.annotationId,i=e.error;if(void 0!==i)t.handleFailedUpdate(n,i);else{const i=So(e.newAnnotation);t.handleSuccessfulUpdate(n,i)}}));const Qp={offset:0,completions:[]};function ef(e,t){return t.offset+=e,t}function tf(e,t){let n=[];for(let i of t)i.startsWith(e)&&n.push({value:i});return n.sort(((e,t)=>Kp(e.value,t.value))),n}function nf(e,t,n,i){let r=[];for(let s of t){let t=n(s);t.startsWith(e)&&r.push({value:t,description:i(s)})}return r.sort(((e,t)=>Kp(e.value,t.value))),r}async function rf(e,t){return async function(e,t,n){if(e.startsWith("{"))return Qp;const r=e.match(/^(?:(.*)[&;])?([^&;]*)$/)[2];let s=e.length-r.length;const o=r.indexOf("=");if(-1===o){const e=await t(r);return{offset:e.offset+s,completions:e.completions.map((e=>(0,i.bn)((0,i.bn)({},e),{value:`${e.value}=`})))}}return ef(s+o+1,await n(r.substring(0,o),r.substring(o+1)))}(e,(async e=>{const n=[];for(const i of t){const t=i.key;t.value.startsWith(e)&&n.push(t)}return{offset:0,completions:n}}),(async(e,n)=>{for(const i of t)if(i.key.value===e)return{offset:0,completions:i.values.filter((e=>e.value.startsWith(n)))};return Qp}))}class sf extends Error{constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function of(e,t){void 0===t&&(t=-1===e.indexOf("/")?":":"/");let n=e.lastIndexOf(t);return-1===n?0:n+1}var af;function lf(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new pt}}!function(e){e[e.annotations=0]="annotations",e[e.equivalences=1]="equivalences"}(af||(af={}));class cf extends Sn{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}const df="local://annotations",uf="local://equivalences";class hf extends cf{get description(){return"Local in-memory"}async get(e){switch(e.url){case df:{let t;if(void 0===e.transform){const n=e.globalCoordinateSpace.value,i=n.rank,r=n.names,s=n.scales,o=n.units;t={rank:i,sourceRank:i,inputSpace:ia({rank:i,scales:s,units:o,names:r.map(((e,t)=>`${t}`))}),outputSpace:ia({rank:i,scales:s,units:o,names:r}),transform:xo(Float64Array,i+1)}}else t=ma(sa);return{modelTransform:t,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:af.annotations}}]}}case uf:return{modelTransform:ma(sa),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:af.equivalences}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:nf(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],(e=>e.value),(e=>e.description))}}}const pf=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class ff extends Sn{constructor(e){super(),this.credentialsManager=e,this.dataSources=new pt([["local",new hf]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){const t=e.match(pf);if(null===t||void 0===t[1])throw new Error('Data source URL must have the form "<protocol>://<path>".');var n=O(t,3);const i=n[1],r=n[2],s=this.dataSources.get(i);if(void 0===s)throw new Error(`Unsupported data source: ${Bt(i)}.`);return[s,r,i]}async get(e){const t=new Rt;var n=e.cancellationToken;const r=void 0===n?id:n;let s=e.url;for(;;){var o=this.getProvider(e.url),a=O(o,3);const n=a[0],c=a[1],d=a[2];t.add(e.url);try{return n.get((0,i.bn)((0,i.bn)({},e),{url:s,providerProtocol:d,providerUrl:c,registry:this,cancellationToken:r,credentialsManager:this.credentialsManager}))}catch(l){if(l instanceof sf){const e=l.redirectTarget;if(t.has(e))throw Error(`Layer source redirection contains loop: ${Bt(It(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${Bt(It(t))}`);s=e;continue}throw l}}}convertLegacyUrl(e){try{var t=this.getProvider(e.url),n=O(t,3);const r=n[0],s=n[1],o=n[2];return r.convertLegacyUrl((0,i.bn)((0,i.bn)({},e),{providerUrl:s,providerProtocol:o,registry:this}))}catch{return e.url}}normalizeUrl(e){try{var t=this.getProvider(e.url),n=O(t,3);const r=n[0],s=n[1],o=n[2];return r.normalizeUrl((0,i.bn)((0,i.bn)({},e),{providerUrl:s,providerProtocol:o,registry:this}))}catch{return e.url}}async completeUrl(e){const t=e.url;var n=e.cancellationToken;const i=void 0===n?id:n;let r=t.match(pf),s=r[1];if(void 0===s)return Qc.resolve({offset:0,completions:nf(t,this.dataSources,(e=>{let[t]=e;return`${t}://`}),(e=>{let[,t]=e;return t.description}))});{const n=this.dataSources.get(s);if(void 0!==n){const o=await n.completeUrl({registry:this,url:t,providerUrl:r[2],chunkManager:e.chunkManager,cancellationToken:i,credentialsManager:this.credentialsManager});return ef(s.length+3,o)}throw null}}suggestLayerName(e){var t=this.getProvider(e),n=O(t,2);let i=n[0],r=n[1];r.endsWith("/")&&(r=r.substring(0,r.length-1));let s=i.suggestLayerName;return void 0!==s?s(r):function(e,t){let n=of(e,t);return e.substring(n)}(r)}findSourceGroup(e){var t=this.getProvider(e),n=O(t,3);let i=n[0],r=n[1],s=n[2];return(i.findSourceGroup||of)(r)+s.length+3}}var gf=i.b7,mf=i.aZ,vf=i.bp,yf=i.bv.f,bf=function(e){return function(t){for(var n,i=vf(t),r=mf(i),s=r.length,o=0,a=[];s>o;)n=r[o++],(!gf||yf.call(i,n))&&a.push(e?[n,i[n]]:i[n]);return a}},Sf=i.aV,wf=bf(!0);Sf(Sf.S,"Object",{entries:function(e){return wf(e)}});var xf={default:i.aW.Object.entries,__esModule:!0};const Cf=(0,i.g)(xf);var kf=_,Tf=i.b9.getWeak,Ef=i.b1,Lf=i.b8,If=F,Df=oe,Mf=Fe,Pf=i.bw,Af=fe,Rf=Mf(5),Nf=Mf(6),Vf=0,Of=function(e){return e._l||(e._l=new Bf)},Bf=function(){this.a=[]},_f=function(e,t){return Rf(e.a,(function(e){return e[0]===t}))};Bf.prototype={get:function(e){var t=_f(this,e);if(t)return t[1]},has:function(e){return!!_f(this,e)},set:function(e,t){var n=_f(this,e);n?n[1]=t:this.a.push([e,t])},delete:function(e){var t=Nf(this.a,(function(t){return t[0]===e}));return~t&&this.a.splice(t,1),!!~t}};var Ff={getConstructor:function(e,t,n,i){var r=e((function(e,s){If(e,r,t,"_i"),e._t=t,e._i=Vf++,e._l=void 0,null!=s&&Df(s,n,e[i],e)}));return kf(r.prototype,{delete:function(e){if(!Lf(e))return!1;var n=Tf(e);return!0===n?Of(Af(this,t)).delete(e):n&&Pf(n,this._i)&&delete n[this._i]},has:function(e){if(!Lf(e))return!1;var n=Tf(e);return!0===n?Of(Af(this,t)).has(e):n&&Pf(n,this._i)}}),r},def:function(e,t,n){var i=Tf(Ef(t),!0);return!0===i?Of(e).set(t,n):i[e._i]=n,e},ufstore:Of},zf=Ff,Uf=fe,Gf="WeakSet";Qe(Gf,(function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}}),{add:function(e){return zf.def(Uf(this,Gf),e,!0)}},zf,!1,!0),ot("WeakSet"),ut("WeakSet");var Wf={default:i.aW.WeakSet,__esModule:!0};const $f=(0,i.g)(Wf);var jf=gn,Hf=i.bl;var Jf=function(e,t,n){var i=!0,r=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Hf(n)&&(i="leading"in n?!!n.leading:i,r="trailing"in n?!!n.trailing:r),jf(e,t,{leading:i,maxWait:t,trailing:r})};const qf=(0,i.g)(Jf);function Yf(e){return"boolean"==typeof e?{enabled:e}:(Yr(e),{enabled:is(e,"enabled",hs)})}function Zf(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return"string"==typeof e?{url:e,transform:t,enableDefaultSubsources:!0,subsources:new pt}:(Yr(e),{url:ns(e,"url",es),transform:ns(e,"transform",Na)||t,enableDefaultSubsources:is(e,"enableDefaultSubsources",hs,!0),subsources:is(e,"subsources",(e=>rs(e,Yf)),new pt)})}function Xf(e){return e.enabled}function Kf(e){const t=Va(e.transform),n={};let i=!0;for(const s of e.subsources){var r=O(s,2);const e=r[0],t=Xf(r[1]);void 0!==t&&(n[e]=t,i=!1)}return void 0===t&&i&&!0===e.enableDefaultSubsources?e.url:{url:e.url,transform:t,subsources:i?void 0:n,enableDefaultSubsources:!0===e.enableDefaultSubsources&&void 0}}class Qf{constructor(e,t,n,i,r){let s;this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=n,this.subsourceIndex=i,this.activated=void 0,this.guardValues=[],this.messages=new wl,this.isActiveChanged=new kn,s=void 0===n||void 0===n.enabled?t.default&&r:n.enabled;const o=e.dataSource.modelTransform.sourceRank;let a=t.modelSubspaceDimensionIndices;if(void 0===a){a=new Array(o);for(let e=0;e<o;++e)a[e]=e}var l=t.subsourceToModelSubspaceTransform;const c=void 0===l?xo(Float32Array,a.length+1):l;this.enabled=s,this.subsourceToModelSubspaceTransform=c,this.modelSubspaceDimensionIndices=a,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(this.messages.clearMessages(),void 0!==this.activated){if(Ut(n,this.guardValues))return;this.activated.dispose()}this.guardValues=n;e(this.activated=new Sn),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:Sl.error,message:e});const t=this.activated;void 0!==t&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){const t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){const t=this.activated;var n=this.loadedDataSource;const i=n.layer,r=n.transform;return t.registerDisposer(Ga(i.manager.root.coordinateSpace,i.localPosition.coordinateSpace,r,this,e))}}class eg extends Sn{constructor(e,t,n){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new kn,this.activatedSubsourcesChanged=new kn,this.messages=new wl,t.canChangeModelSpaceRank?(this.transform=new Da(ma(ia({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new Da(t.modelTransform),void 0!==n.transform&&(this.transform.spec=n.transform);const i=n.subsources;this.enableDefaultSubsources=n.enableDefaultSubsources,this.subsources=t.subsources.map(((e,t)=>new Qf(this,e,i.get(e.id),t,this.enableDefaultSubsources)))}get enabledSubsources(){return this.subsources.filter((e=>e.enabled))}get layer(){return this.layerDataSource.layer}disposed(){for(const e of this.subsources){const t=e.activated;void 0!==t&&(e.activated=void 0,t.dispose())}}}class tg extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;super(),this.layer=e,this.changed=new kn,this.messages=new wl,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),void 0===t?this.spec_=lf():this.spec=t}get spec(){const e=this.loadState;if(void 0!==e&&void 0===e.error){const t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new pt(It(e.subsources,(t=>{const n=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==n?t.enabled:void 0}]})))})}return this.spec_}get loadState(){return this.loadState_}set spec(e){const t=this.layer;if(this.messages.clearMessages(),0===e.url.length){if(1!==t.dataSources.length){const e=t.dataSources.indexOf(this);if(-1!==e)return t.dataSources.splice(e,1),t.dataSourcesChanged.dispatch(),void this.dispose()}return this.spec_=e,void(void 0!==this.refCounted_&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch()))}const n=new Sn,i=n.registerDisposer(xn(t.markLoading()));void 0!==this.refCounted_&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=n,this.spec_=e;const r=t.manager.chunkManager,s=t.manager.dataSourceProviderRegistry,o=new rd;this.messages.addMessage({severity:Sl.info,message:"Loading data source"}),s.get({chunkManager:r,url:e.url,cancellationToken:o,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform}).then((r=>{if(n.wasDisposed)return;this.messages.clearMessages();const s=n.registerDisposer(new eg(this,r,e));s.registerDisposer(t.addCoordinateSpace(s.transform.outputSpace)),s.registerDisposer(s.transform.changed.add(this.changed.dispatch)),this.loadState_=s,s.registerDisposer(s.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),i()})).catch((e=>{this.wasDisposed||(this.loadState_={error:e},this.messages.clearMessages(),this.messages.addMessage({severity:Sl.error,message:e.message}),this.changed.dispatch())})),n.registerDisposer((()=>{o.cancel()})),this.changed.dispatch()}disposed(){const e=this.refCounted_;void 0!==e&&e.dispose()}toJSON(){const e=this.loadState;return void 0===e||void 0!==e.error?Kf(this.spec):Kf({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new pt(It(e.subsources,(t=>{const n=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==n?t.enabled:void 0}]})))})}}var ng,ig;var rg=i.aV;rg(rg.S,"Object",{is:(ig||(ig=1,ng=Object.is||function(e,t){return e===t?0!==e||1/e===1/t:e!=e&&t!=t}),ng)});var sg={default:i.aW.Object.is,__esModule:!0};const og=(0,i.g)(sg);var ag,lg;var cg=i.aV;cg(cg.S,"Math",{sign:(lg||(lg=1,ag=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}),ag)});var dg={default:i.aW.Math.sign,__esModule:!0};const ug=(0,i.g)(dg);var hg,pg=i.b5,fg=Fe(0),gg=i.bx,mg=i.b9,vg=i.by,yg=Ff,bg=i.b8,Sg=fe,wg=fe,xg=!pg.ActiveXObject&&"ActiveXObject"in pg,Cg="WeakMap",kg=mg.getWeak,Tg=Object.isExtensible,Eg=yg.ufstore,Lg=function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}},Ig={get:function(e){if(bg(e)){var t=kg(e);return!0===t?Eg(Sg(this,Cg)).get(e):t?t[this._i]:void 0}},set:function(e,t){return yg.def(Sg(this,Cg),e,t)}},Dg=Qe(Cg,Lg,Ig,yg,!0,!0);wg&&xg&&(vg((hg=yg.getConstructor(Lg,Cg)).prototype,Ig),mg.NEED=!0,fg(["delete","has","get","set"],(function(e){var t=Dg.prototype,n=t[e];gg(t,e,(function(t,i){if(bg(t)&&!Tg(t)){this._f||(this._f=new hg);var r=this._f[e](t,i);return"set"==e?this:r}return n.call(this,t,i)}))}))),ot("WeakMap"),ut("WeakMap");var Mg={default:i.aW.WeakMap,__esModule:!0};const Pg=(0,i.g)(Mg);function Ag(e,t,n){is(e,t,(e=>n.restoreState(e)))}class Rg extends Sn{constructor(){super(...arguments),this.children=new pt,this.changed=new kn}add(e,t){if(this.children.has(e))throw new Error(`Key ${Bt(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){const t=this.children;if(t.has(e))throw new Error(`Key ${Bt(e)} not registered.`);const n=t.get(e);this.children.delete(e),n.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){const e=this.changed;for(let t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){const e=this.baseJSON();for(let n of this.children){var t=O(n,2);let i=t[0],r=t[1];e[i]=r.toJSON()}return e}baseJSON(){return{}}reset(){for(let e of this.children.values())e.reset()}restoreState(e){Yr(e);for(let i of this.children){var t=O(i,2);let r=t[0],s=t[1];try{if(e.hasOwnProperty(r)){const t=e[r];if(void 0===t)continue;s.restoreState(t)}}catch(n){throw new Error(`Error restoring property ${Bt(r)}: ${n.message}`)}}}}const Ng=new Pg;function Vg(e){let t=Ng.get(e);const n=e.changed.count;if(void 0!==t&&t.generation===n)return t;let i;if(e instanceof Rg){i=e.baseJSON();for(let t of e.children){var r=O(t,2);let e=r[0],n=r[1];i[e]=Vg(n).value}}else i=e.toJSON();return void 0===t?(t={generation:n,value:i},Ng.set(e,t)):(t.generation=n,t.value=i),t}class Og{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;this.enumType=e,this.value_=t,this.defaultValue=n,this.changed=new kn}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=ls(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}}var Bg,_g;!function(e){e[e.LINKED=0]="LINKED",e[e.RELATIVE=1]="RELATIVE",e[e.UNLINKED=2]="UNLINKED"}(Bg||(Bg={})),function(e){e[e.LINKED=0]="LINKED",e[e.UNLINKED=2]="UNLINKED"}(_g||(_g={}));class Fg extends Og{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Bg.LINKED;super(Bg,e)}}class zg extends Og{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_g.LINKED;super(_g,e)}}const Ug=ti(),Gg=bi();function Wg(e,t,n,i){let r,s=!1;e.registerDisposer(t);let o=Bg.UNLINKED;const a=()=>{const s=n.value;if(s!==o)switch(s){case Bg.UNLINKED:r=void 0;break;case Bg.LINKED:r=void 0,i.assign(e,t);break;case Bg.RELATIVE:r=i.difference(e,t)}o=s,e.changed.dispatch()};return e.registerDisposer(e.changed.add((()=>{if(!s)switch(n.value){case Bg.UNLINKED:break;case Bg.LINKED:i.assign(t,e);break;case Bg.RELATIVE:i.subtract(t,e,r)}}))),e.registerDisposer(t.changed.add((()=>{switch(s=!0,n.value){case Bg.UNLINKED:if(i.isValid(e))break;case Bg.LINKED:i.assign(e,t);break;case Bg.RELATIVE:i.add(e,t,r)}s=!1}))),e.registerDisposer(n.changed.add(a)),a(),e}function $g(e,t,n,i){return Wg(e,t,n,i)}class jg extends Sn{constructor(e){super(),this.coordinateSpace=e,this.coordinates_=Jo,this.changed=new kn,this.registerDisposer(e.changed.add((()=>{this.handleCoordinateSpaceChanged()})))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=Jo,this.changed.dispatch()}set value(e){const t=this.curCoordinateSpace;void 0!==t&&t.valid&&t.rank===e.length&&(this.coordinates_.set(e),this.changed.dispatch())}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const n=e.rank;if(!e.valid)return;if(void 0===t||!t.valid){let t=this.coordinates_;if(void 0===t||t.length!==n){t=this.coordinates_=new Float32Array(n),function(e,t){const n=t.lowerBounds,i=t.upperBounds,r=e.length;for(let s=0;s<r;++s)e[s]=da(n[s],i[s])}(t,e.bounds);for(let e=0;e<n;++e)t[e]=Math.floor(t[e])+.5}return void this.changed.dispatch()}const i=new Float32Array(n),r=this.coordinates_,s=e.ids,o=e.scales,a=t.ids,l=t.scales;for(let c=0;c<n;++c){const t=s[c],n=a.indexOf(t);i[c]=-1===n?da(e.bounds.lowerBounds[c],e.bounds.upperBounds[c]):r[n]*(l[n]/o[c])}this.coordinates_=i,this.changed.dispatch()}toJSON(){if(!this.valid&&0===this.coordinates_.length)return;this.handleCoordinateSpaceChanged();const e=this.value;return 0!==e.length?It(e):void 0}restoreState(e){void 0!==e?(this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(Jr(e,Tr)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()):this.reset()}snapToVoxel(){this.handleCoordinateSpaceChanged();const e=this.coordinates_,t=e.length;for(let n=0;n<t;++n)e[n]=Math.floor(e[n])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();const t=e.curCoordinateSpace,n=e.coordinates_;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(n),this.changed.dispatch()}static getOffset(e,t){const n=e.coordinates_,i=t.coordinates_;if(n.length===i.length)return $o(new Float32Array(n.length),n,i)}static addOffset(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.handleCoordinateSpaceChanged();const r=t.value;void 0!==n&&r.length===n.length&&(function(e,t,n,i){const r=e.length;for(let s=0;s<r;++s)e[s]=t[s]+n[s]*i}(e.value,r,n,i),e.changed.dispatch())}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset(){e.reset()},restoreState(t){void 0===t||Array.isArray(t)?e.restoreState(t):(Yr(t),Ag(t,"voxelCoordinates",e))}}}}function Hg(e,t,n){void 0!==n&&0!==f(n).length?(Yr(n),e.value=Bg.UNLINKED,ns(n,"value",(e=>{void 0!==e&&t.restoreState(e)})),ns(n,"link",(t=>e.restoreState(t)))):e.value=Bg.LINKED}class Jg{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Fg;this.peer=e,this.link=t}get changed(){return this.value.changed}toJSON(){const e=this.link;if(e.value!==Bg.LINKED)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=Bg.LINKED}restoreState(e){Hg(this.link,this.value,e)}copyToPeer(){this.link.value!==Bg.LINKED&&(this.link.value=Bg.UNLINKED,this.peer.assign(this.value),this.link.value=Bg.LINKED)}}class qg extends Jg{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:new zg)}}class Yg extends Jg{constructor(){super(...arguments),this.value=Wg(new jg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:jg.getOffset,add:jg.addOffset,subtract:(e,t,n)=>{jg.addOffset(e,t,n,-1)}})}}class Zg extends Sn{constructor(e){super(),this.changed=new kn,null==e&&(e=bi()),this.orientation=e}toJSON(){let e=this.orientation;if(Ei(this.orientation,this.orientation),!function(e){return 0===e[0]&&0===e[1]&&0===e[2]&&1===e[3]}(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{Dr(this.orientation,e),Ei(this.orientation,this.orientation)}catch{Si(this.orientation)}this.changed.dispatch()}reset(){Si(this.orientation),this.changed.dispatch()}snap(){let e=jn();Jn(e,this.orientation);let t=[!1,!1,!1];for(let n=0;n<3;++n){let i=0,r=0;for(let s=0;s<3;++s){let o=e[3*n+s];e[3*n+s]=0,!t[s]&&Math.abs(o)>Math.abs(i)&&(i=o,r=s)}e[3*n+r]=ug(i),t[r]=!0}ki(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){let n=new Zg(xi(bi(),e.orientation,t)),i=!1;n.registerDisposer(e.changed.add((()=>{i||(r=!0,xi(n.orientation,e.orientation,t),n.changed.dispatch(),r=!1)})));let r=!1;const s=Ci(bi(),t);return n.registerDisposer(n.changed.add((()=>{r||(i=!0,xi(e.orientation,n.orientation,s),e.changed.dispatch(),i=!1)}))),n}assign(e){Ti(this.orientation,e.orientation),this.changed.dispatch()}}class Xg extends Jg{constructor(){super(...arguments),this.value=Wg(new Zg,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{const n=bi();return xi(n,Ci(n,t.orientation),e.orientation)},add:(e,t,n)=>{xi(e.orientation,t.orientation,n),e.changed.dispatch()},subtract:(e,t,n)=>{xi(e.orientation,t.orientation,Ci(Gg,n)),e.changed.dispatch()}})}}class Kg extends Sn{constructor(e){super(),this.coordinateSpace=e,this.changed=new kn,this.curCoordinateSpace=ra,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add((()=>this.update()))),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=ra,this.changed.dispatch()}toJSON(){const e={};let t=!1;const n=this.value.factors;var i=this.curCoordinateSpace;const r=i.names,s=i.rank;for(let o=0;o<s;++o){const i=n[o];1!==i&&(e[r[o]]=i,t=!0)}if(t)return e}restoreState(e){const t=this.coordinateSpace.value,n=t.names,i=t.rank,r=new Float64Array(i);if(r.fill(-1),void 0!==e){const t=Yr(e);for(let e=0;e<i;++e)r[e]=ns(t,n[e],(e=>void 0===e?1:Lr(e)))}this.value_={factors:r},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){const t=this.coordinateSpace.value;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){const e=this.coordinateSpace.value;let t=this.value_;const n=this.curCoordinateSpace;if(n===e)return t;const i=n.ids,r=e.ids,s=e.rank,o=t.factors,a=new Float64Array(s);a.fill(1);for(let l=0;l<s;++l){const e=r[l],t=i.indexOf(e);-1!==t&&(a[l]=o[t])}return Ut(a,o)||(t=this.value_={factors:a},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function Qg(e,t,n,i,r){if(n===i)return t;const s=n.ids,o=i.rank,a=i.ids,l=new e(o);for(let c=0;c<o;++c){const e=a[c],n=s.indexOf(e);l[c]=-1===n?r(c):t[n]}return l}class em extends Jg{constructor(){super(...arguments),this.value=Wg(new Kg(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{const n=e.value.factors,i=e.coordinateSpace.value,r=t.value.factors;return{coordinateSpace:i,offsets:$o(new Float64Array(n.length),n,r)}},add:(e,t,n)=>{const i=Qg(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,(()=>0));e.setFactors(Wo(new Float64Array(i.length),i,t.value.factors))},subtract:(e,t,n)=>{const i=Qg(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,(()=>0));e.setFactors($o(new Float64Array(i.length),t.value.factors,i))},isValid:()=>!0})}}function tm(e,t,n){const i=e.rank,r=e.names,s=e.units,o=t.displayRank,a=t.displayDimensionIndices,l=new Float64Array(3);let c,d=new Float64Array(3);const u=n.factors,h=new Array(3),p=new Float64Array(3);if(l.fill(1),d.fill(1),p.fill(1),h.fill(""),0===o)c=1;else{c=Number.POSITIVE_INFINITY;const t=e.scales;for(let e=0;e<o;++e){const n=a[e],i=d[e]=u[n]*t[n];c=Math.min(c,i),h[e]=s[n],p[e]=t[n]}for(let e=0;e<o;++e)l[e]=d[e]/c}return{globalRank:i,globalDimensionNames:r,displayRank:o,displayDimensionIndices:a,displayDimensionUnits:h,displayDimensionScales:p,canonicalVoxelFactors:l,voxelPhysicalScales:d,canonicalVoxelPhysicalSize:c}}class nm extends Sn{constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new kn,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=tm(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);const n=()=>{this.value};this.registerDisposer(e.changed.add(n)),this.registerDisposer(t.changed.add(n))}get value(){var e=this.relativeDisplayScales;const t=e.value,n=e.coordinateSpace.value,i=this.displayDimensions.value,r=this.curRelativeDisplayScales,s=this.curDisplayDimensions,o=this.curCoordinateSpace;let a=this.value_;if(r!==t||s!==i||o!==n){this.curRelativeDisplayScales=t,this.curDisplayDimensions=i,this.curCoordinateSpace=n;const e=tm(n,i,t);(function(e,t){return Ut(e.globalDimensionNames,t.globalDimensionNames)&&Ut(e.displayDimensionIndices,t.displayDimensionIndices)&&Ut(e.canonicalVoxelFactors,t.canonicalVoxelFactors)&&Ut(e.voxelPhysicalScales,t.voxelPhysicalScales)&&e.canonicalVoxelPhysicalSize===t.canonicalVoxelPhysicalSize&&Ut(e.displayDimensionUnits,t.displayDimensionUnits)&&Ut(e.displayDimensionScales,t.displayDimensionScales)})(a,e)||(this.value_=a=e,this.changed.dispatch())}return a}}class im extends Sn{constructor(e){super(),this.coordinateSpace=e,this.changed=new kn,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){const e=this.coordinateSpace.value,t=this.value_;if(void 0!==t&&t.coordinateSpace===e)return;if(void 0===t||this.default_)return void this.setToDefault(e);const n=new Int32Array(3),i=t.coordinateSpace.ids,r=e.ids,s=t.displayDimensionIndices,o=t.displayRank;let a=0;for(let l=0;l<o;++l){const e=r.indexOf(i[s[l]]);-1!==e&&(n[a]=e,++a)}if(n.fill(-1,a),0===a)return this.default_=!0,void this.setToDefault(e);this.assignValue(e,a,n),this.changed.dispatch()}setToDefault(e){const t=Math.min(e.rank,3),n=new Int32Array(3);n.fill(-1);for(let i=0;i<t;++i)n[i]=i;this.assignValue(e,t,n)}assignValue(e,t,n){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:n},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(void 0===e)return void this.reset();const t=Ma(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");const n=this.coordinateSpace.value,i=new Int32Array(3);i.fill(-1);const r=n.names;let s=0;for(const o of t){const e=r.indexOf(o);-1!==e&&(i[s++]=e)}0!==s?(this.default_=!1,this.assignValue(n,s,i)):this.reset()}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;const e=this.value,t=[],n=e.displayRank,i=e.displayDimensionIndices,r=e.coordinateSpace.names;if(0!==n){for(let e=0;e<n;++e)t[e]=r[i[e]];return t}}assign(e){if(e.default)this.default=!0;else{var t=e.value;const n=t.displayRank,i=t.displayDimensionIndices;this.setDimensionIndices(n,i)}}}class rm extends qg{constructor(e){super(e),this.value=$g(new im(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}}class sm extends Sn{constructor(e,t,n){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=n,this.changed=new kn,this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(n.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ug;var n=this.position;const i=n.coordinateSpace.value,r=n.value;var s=this.displayDimensions.value;const o=s.displayDimensionIndices,a=s.displayRank;if(void 0===i)return!1;t.fill(0);for(let l=0;l<a;++l){const e=o[l];t[l]=r[e]}if(!1!==e(t)){for(let e=0;e<a;++e){r[o[e]]=t[e]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){!function(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=n+n,a=i+i,l=r+r,c=n*o,d=i*o,u=i*a,h=r*o,p=r*a,f=r*l,g=s*o,m=s*a,v=s*l;e[0]=1-u-f,e[1]=d+v,e[2]=h-m,e[3]=0,e[4]=d-v,e[5]=1-c-f,e[6]=p+g,e[7]=0,e[8]=h+m,e[9]=p-g,e[10]=1-c-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e,this.orientation.orientation);const n=this.position.value;var i=this.displayDimensionRenderInfo.value;const r=i.canonicalVoxelFactors,s=i.displayDimensionIndices;for(let o=0;o<3;++o){const i=s[o],a=t/r[o];e[o]*=a,e[4+o]*=a,e[8+o]*=a,e[12+o]=n[i]||0}}toMat3(e,t){Jn(e,this.orientation.orientation);var n=this.displayDimensionRenderInfo.value;const i=n.canonicalVoxelFactors,r=n.displayRank;for(let s=0;s<r;++s){const n=t/i[s];e[s]*=n,e[3+s]*=n,e[6+s]*=n}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;const n=this.position,i=n.value;var r=n.coordinateSpace.value.bounds;const s=r.lowerBounds,o=r.upperBounds;let a=i[e]+t;if(t>0){const t=o[e];Sr(t)&&(a=Math.min(a,Math.ceil(t-1)))}else{const t=s[e];Sr(t)&&(a=Math.max(a,Math.floor(t)))}i[e]=a,n.changed.dispatch()}translateVoxelsRelative(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.valid)return;const n=fi(Ug,e,this.orientation.orientation),i=this.position,r=i.value;var s=this.displayDimensions.value;const o=s.displayDimensionIndices,a=s.displayRank;var l=i.coordinateSpace.value.bounds;const c=l.lowerBounds,d=l.upperBounds;for(let u=0;u<a;++u){const e=o[u],i=n[u];if(0===i)continue;let s=r[e]+i;if(i>0){const t=d[e];Sr(t)&&(s=Math.min(s,Math.ceil(t-1)))}else{const t=c[e];Sr(t)&&(s=Math.max(s,Math.floor(t)))}t&&(s=Math.floor(s)+.5),r[e]=s}this.position.changed.dispatch()}rotateRelative(e,t){var n=bi();wi(n,e,t);var i=this.orientation.orientation;xi(i,i,n),this.orientation.changed.dispatch()}rotateAbsolute(e,t,n){var i=this.position;const r=i.coordinateSpace.value,s=i.value;if(void 0===r)return;const o=this.relativeDisplayScales.value.factors;var a=this.displayDimensions.value;const l=a.displayDimensionIndices,c=a.displayRank,d=r.scales,u=bi();wi(u,e,t);const h=this.orientation.orientation,p=Ug;Ug.fill(0);for(let f=0;f<c;++f){const e=l[f],t=n[e]-s[e];p[f]=t*d[e]*o[e]}fi(p,p,Ci(Gg,h)),xi(h,u,h),fi(p,p,h);for(let f=0;f<c;++f){const e=l[f];s[e]=n[e]-p[f]/(d[e]*o[e])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;const n=this.displayDimensions.value.displayDimensionIndices,i=this.position.coordinateSpace.value.rank;for(let r=0;r<i;++r)if(-1===n.indexOf(r)&&0===e--)return void this.translateDimensionRelative(r,t)}}class om extends Jg{constructor(e,t){super(e),this.value=(()=>{const n=new e.constructor(t);return Wg(n,this.peer,this.link,{assign:(e,t)=>{e.assign(t)},isValid:e=>e.coordinateSpaceValue.valid&&0!==e.canonicalVoxelPhysicalSize,difference:(e,t)=>e.value/t.value*(e.canonicalVoxelPhysicalSize/t.canonicalVoxelPhysicalSize),add:(e,t,n)=>{e.setPhysicalScale(t.value*n,t.canonicalVoxelPhysicalSize)},subtract:(e,t,n)=>{e.setPhysicalScale(t.value/n,t.canonicalVoxelPhysicalSize)}}),n})()}}function am(e){return{changed:e.changed,toJSON:()=>e.toJSON(),restoreState(t){Hg(e.link,e.value.legacyJsonView,t)},reset(){e.reset()}}}class lm extends Sn{constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new kn,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add((()=>this.handleCoordinateSpaceChanged()))),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add((()=>this.handleCoordinateSpaceChanged()))),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){const t=this.canonicalVoxelPhysicalSize;og(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){og(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){const e=this.value_;var t=this.displayDimensionRenderInfo;const n=t.value.canonicalVoxelPhysicalSize,i=t.relativeDisplayScales.coordinateSpace.value,r=this.curCanonicalVoxelPhysicalSize;if(Cr(e)||n!==r){if(!Cr(e))return void(0!==r&&(this.value_=e*(r/n),this.curCanonicalVoxelPhysicalSize=n,this.changed.dispatch()));!i.valid||0===n||(this.curCanonicalVoxelPhysicalSize=n,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){const e=this.value;return Cr(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,this.value_=void 0===e?Number.NaN:Lr(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON:()=>e.toJSON(),reset:()=>e.reset(),restoreState(t){e.legacyValue=Lr(t)}}}setPhysicalScale(e,t){const n=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/n)}assign(e){const t=e.legacyValue;Cr(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class cm extends lm{getDefaultValue(){const e=this.legacyValue_;if(Cr(e))return 1;const t=this.canonicalVoxelPhysicalSize;return 1e-9*this.legacyValue_/t}}class dm extends lm{getDefaultValue(){const e=this.legacyValue_;if(!Cr(e)){this.legacyValue_=Number.NaN;const t=this.canonicalVoxelPhysicalSize;return 200*Math.tan(Math.PI/8)*1e-9*e/t}var t=this.coordinateSpaceValue.bounds;const n=t.lowerBounds,i=t.upperBounds;var r=this.displayDimensionRenderInfo.value;const s=r.canonicalVoxelFactors,o=r.displayDimensionIndices;let a=s.reduce(((e,t,r)=>{const s=o[r],a=(i[s]-n[s])*t;return Math.max(e,a)}),0);return a=Sr(a)?2**Math.ceil(ks(a)):1024,a}}class um extends Sn{constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new kn,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add((()=>{this.value})))}get value(){let e=this.value_;if(e>0){const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize,n=this.canonicalVoxelPhysicalSize;t!==n&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=n/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;const t=this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){const e=this.value;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){"number"==typeof e&&Sr(e)&&0!==e?this.value=e:this.value=this.defaultValue}setValueAbsolute(e,t){if(e>0){e*=t/this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class hm extends qg{constructor(e,t){super(e),this.value=$g(new um(e.defaultValue,t),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}}class pm extends Sn{constructor(e,t,n){super(),this.pose=e,this.zoomFactor=t,this.depthRange=n,this.changed=new kn,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(n),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Cr(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}var fm;function gm(e,t,n,i,r,s,o){const a=e.octree,l=e.lodScales,c=e.chunkGridSpatialOrigin,d=e.chunkShape,u=l.length-1,h=t[0],p=t[4],f=t[8],g=t[1],m=t[5],v=t[9],y=t[3],b=t[7],S=t[11],w=t[15],x=y>0?0:1,C=b>0?0:1,k=S>0?0:1,T=n[16],E=n[17],L=n[18],I=n[19];function D(e,t,n){return y*e+b*t+S*n+w}const M=D(-I*T,-I*E,-I*L),P=e.clipLowerBound[0],A=e.clipLowerBound[1],R=e.clipLowerBound[2],N=e.clipUpperBound[0],V=e.clipUpperBound[1],O=e.clipUpperBound[2],B=Math.sqrt((h*r)**2+(g*s)**2),_=Math.sqrt((p*r)**2+(m*s)**2),F=Math.sqrt((f*r)**2+(v*s)**2),z=Math.max(B,_,F);!function e(t,r,s){const u=1<<t,h=5*r,p=a[h],f=a[h+1],g=a[h+2],m=a[h+3],v=a[h+4];let y=p*u*d[0]+c[0],b=f*u*d[1]+c[1],S=g*u*d[2]+c[2],w=y+u*d[0],T=b+u*d[1],E=S+u*d[2];if(y=Math.max(y,P),b=Math.max(b,A),S=Math.max(S,R),w=Math.min(w,N),T=Math.min(T,V),E=Math.min(E,O),Fi(y,b,S,w,T,E,n)){const n=Math.max(M,function(e,t,n,i,r,s){return D(e+x*(i-e),t+C*(r-t),n+k*(s-n))}(y,b,S,w,T,E))/z;if(0===s||n*i<s){const a=l[t];if(0!==a&&o(t,r,a/n,v>>>31),t>0&&(0===a||n*i<a)){const n=0===a?s:a,i=(2147483647&v)>>>0;for(let r=m;r<i;++r)e(t-1,r,n)}}}}(u,a.length/5-1,0)}function mm(e,t,n,i,r,s,o,a){const l=e.lodScales;let c=0;for(;c+1<l.length&&0!==l[c+1];)++c;const d=[];let u=0,h=0;function p(e,t){for(;;){if(0===u)return;const n=u-1,i=c-n,r=d[3*n],s=0===i?1:8,o=d[3*n+1],l=d[3*n+2];if(e===u){const e=t&s-1;return h!==e&&-1!==r&&a(i,r,h,e,l),void(h=e+1)}h!==s&&-1!==r&&a(i,r,h,s,l),h=o+1,--u}}let f=0;const g=e.octree;gm(e,t,n,i,r,s,((e,t,n,i)=>{if(!i&&!o(e,t,n))return void(f=Math.max(e,f));if(e<f)return;f=0;const r=5*t,s=function(e,t,n){return 1&e|t<<1&2|n<<2&4}(g[r],g[r+1],g[r+2]),a=c-e;p(a,s);const l=3*a;d[l]=i?-1:t,d[l+1]=s,d[l+2]=n,h=0,u=a+1})),p(0,0)}function vm(e,t,n){return`${e}/${t}:${n}`}!function(e){e[e.float32=0]="float32",e[e.uint10=1]="uint10",e[e.uint16=2]="uint16"}(fm||(fm={}));class ym extends Pd{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}function bm(e,t){return e>>>=0,t=ws(t>>>=0,3432918353)>>>0,e=5*(e=((e=(e^(t=ws(t=(t<<15|t>>>17)>>>0,461845907)>>>0))>>>0)<<13|e>>>19)>>>0)+3864292196>>>0}var Sm={default:i.aW.Symbol.for,__esModule:!0};const wm=(0,i.g)(Sm);let xm=0,Cm=0,km=0,Tm=0;class Em{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Em.generateHashSeeds(3);this.hashSeeds=e,this.loadFactor=.8,this.size=0,this.emptyLow=4294967295,this.emptyHigh=4294967295,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=Em.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){const t=this.hashSeeds.length,n=new Array(t);for(let a=0;a<t;++a)n[a]=this.getHash(a,this.emptyLow,this.emptyHigh);let i=this.mungedEmptyKey;if(-1===i)e:for(;;){i=16777216*Math.random()>>>0;for(let e=0;e<t;++e){let r=this.getHash(e,i,i);for(let e=0;e<t;++e)if(n[e]===r)continue e}this.mungedEmptyKey=i;break}let r=this.table,s=this.emptyLow,o=this.emptyHigh;for(let a=0;a<t;++a){let e=n[a];r[e]===s&&r[e+1]===o&&(r[e]=i,r[e+1]=i)}try{e(r)}finally{for(let e=0;e<t;++e){let t=n[e];r[t]===i&&r[t+1]===i&&(r[t]=s,r[t+1]=o)}}}static generateHashSeeds(){return function(e){let t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let n=0,i=t.length;n<i;n+=65536)crypto.getRandomValues(t.subarray(n,Math.min(i,n+65536)));return e}(new Uint32Array(arguments.length>0&&void 0!==arguments[0]?arguments[0]:3))}getHash(e,t,n){let i=this.hashSeeds[e];return i=bm(i,t),i=bm(i,n),this.entryStride*(i&this.tableSize-1)}*keys(){let e=this.emptyLow,t=this.emptyHigh,n=this.entryStride,i=this.table;for(let r=0,s=i.length;r<s;r+=n){let n=i[r],s=i[r+1];(n!==e||s!==t)&&(yield new Ds(n,s))}}unsafeKeys(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Ds;return function*(){let n=e.emptyLow,i=e.emptyHigh,r=e.entryStride,s=e.table;for(let e=0,o=s.length;e<o;e+=r){let r=s[e],o=s[e+1];(r!==n||o!==i)&&(t.low=r,t.high=o,yield t)}}()}indexOfPair(e,t){let n=this.table,i=this.emptyLow,r=this.emptyHigh;if(e===i&&t===r)return-1;for(let s=0,o=this.hashSeeds.length;s<o;++s){let i=this.getHash(s,e,t);if(n[i]===e&&n[i+1]===t)return i}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){let e,t,n=this.emptyLow,i=this.emptyHigh,r=this.table,s=this.entryStride;for(;e=4294967296*Math.random()>>>0,t=4294967296*Math.random()>>>0,e===n&&t===i||this.hasPair(e,t););this.emptyLow=e,this.emptyHigh=t;for(let o=0,a=r.length;o<a;o+=s)r[o]===n&&r[o+1]===i&&(r[o]=e,r[o+1]=t)}has(e){return-1!==this.indexOf(e)}hasPair(e,t){return-1!==this.indexOfPair(e,t)}delete(e){let t=this.indexOf(e);if(-1!==t){let e=this.table;return e[t]=this.emptyLow,e[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){let e=this.table,t=this.entryStride,n=this.emptyLow,i=this.emptyHigh,r=e.length;for(let s=0;s<r;s+=t)e[s]=n,e[s+1]=i}clear(){return 0!==this.size&&(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity&&(this.backupPending(),this.grow(e),this.restorePending(),!0)}swapPending(e,t){let n=xm,i=Cm;this.storePending(e,t),e[t]=n,e[t+1]=i}storePending(e,t){xm=e[t],Cm=e[t+1]}backupPending(){km=xm,Tm=Cm}restorePending(){xm=km,Cm=Tm}tryToInsert(){let e=0,t=this.emptyLow,n=this.emptyHigh,i=this.maxAttempts,r=this.table,s=this.hashSeeds.length,o=Math.floor(Math.random()*s);for(;;){let a=this.getHash(o,xm,Cm);if(this.swapPending(r,a),xm===t&&Cm===n)return!0;if(++e===i)break;o=(o+Math.floor(Math.random()*(s-1))+1)%s}return!1}allocate(e){this.tableSize=e;let t=this.entryStride;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);let n=this.emptyLow,i=this.emptyHigh,r=this.entryStride;for(let s=0,o=e.length;s<o;s+=r){let t=e[s],r=e[s+1];if((t!==n||r!==i)&&(this.storePending(e,s),!this.tryToInsert()))return!1}return!0}grow(e){let t=this.table,n=this.tableSize;for(;n<e;)n*=2;for(;;){for(let e=0;e<this.maxRehashAttempts;++e)if(this.rehash(t,n))return;n*=2}}insertInternal(){for(++this.generation,xm===this.emptyLow&&Cm===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(2*this.tableSize),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class Lm extends Em{add(e){let t=e.low,n=e.high;return!this.hasPair(t,n)&&(xm=t,Cm=n,this.insertInternal(),!0)}[i.bm](){return this.unsafeKeys()}}Lm.prototype.entryStride=2;let Im=0,Dm=0,Mm=0,Pm=0;class Am extends Em{set(e,t){let n=e.low,i=e.high;return!this.hasPair(n,i)&&(xm=n,Cm=i,Im=t.low,Dm=t.high,this.insertInternal(),!0)}get(e,t){let n=this.indexOf(e);if(-1===n)return!1;let i=this.table;return t.low=i[n+2],t.high=i[n+3],!0}swapPending(e,t){let n=Im,i=Dm;super.swapPending(e,t),e[t+2]=n,e[t+3]=i}storePending(e,t){super.storePending(e,t),Im=e[t+2],Dm=e[t+3]}backupPending(){super.backupPending(),Mm=Im,Pm=Dm}restorePending(){super.restorePending(),Im=Mm,Dm=Pm}[i.bm](){return this.unsafeEntries()}*entries(){let e=this.emptyLow,t=this.emptyHigh,n=this.entryStride,i=this.table;for(let r=0,s=i.length;r<s;r+=n){let n=i[r],s=i[r+1];if(n!==e||s!==t){let e=new Ds(n,s),t=new Ds(i[r+2],i[r+3]);yield[e,t]}}}unsafeEntries(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[new Ds,new Ds];return function*(){let n=e.emptyLow,i=e.emptyHigh,r=e.entryStride,s=e.table;var o=O(t,2);let a=o[0],l=o[1];for(let e=0,c=s.length;e<c;e+=r){let r=s[e],o=s[e+1];(r!==n||o!==i)&&(a.low=r,a.high=o,l.low=s[e+2],l.high=s[e+3],yield t)}}()}}Am.prototype.entryStride=4;class Rm{}const Nm=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],Vm=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],Om=["","r","rg","rgb","rgba"],Bm=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],_m=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],Fm=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],zm=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],Um=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],Gm=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],Wm=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function $m(e){return e===sr.FLOAT32?"":ar[e]?"i":"u"}function jm(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;switch(t){case sr.UINT8:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=Bm[n],e.textureFormat=Nm[n],e.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,e.arrayElementsPerTexel=n,e.arrayConstructor=Uint8Array,e.samplerPrefix="u",e;case sr.INT8:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=_m[n],e.textureFormat=Nm[n],e.texelType=WebGL2RenderingContext.BYTE,e.arrayElementsPerTexel=n,e.arrayConstructor=Int8Array,e.samplerPrefix="i",e;case sr.UINT16:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=Fm[n],e.textureFormat=Nm[n],e.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,e.arrayElementsPerTexel=n,e.arrayConstructor=Uint16Array,e.samplerPrefix="u",e;case sr.INT16:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=zm[n],e.textureFormat=Nm[n],e.texelType=WebGL2RenderingContext.SHORT,e.arrayElementsPerTexel=n,e.arrayConstructor=Int16Array,e.samplerPrefix="i",e;case sr.UINT32:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=Um[n],e.textureFormat=Nm[n],e.texelType=WebGL2RenderingContext.UNSIGNED_INT,e.arrayElementsPerTexel=1,e.arrayConstructor=Uint32Array,e.samplerPrefix="u",e;case sr.INT32:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=Gm[n],e.textureFormat=Nm[n],e.texelType=WebGL2RenderingContext.INT,e.arrayElementsPerTexel=1,e.arrayConstructor=Int32Array,e.samplerPrefix="i",e;case sr.UINT64:if(n<1||n>2)break;return e.texelsPerElement=1,e.textureInternalFormat=Um[2*n],e.textureFormat=Nm[2*n],e.texelType=WebGL2RenderingContext.UNSIGNED_INT,e.arrayElementsPerTexel=2*n,e.arrayConstructor=Uint32Array,e.samplerPrefix="u",e;case sr.FLOAT32:if(n<1||n>4)break;return e.texelsPerElement=1,e.textureInternalFormat=Wm[n],e.textureFormat=Vm[n],e.texelType=WebGL2RenderingContext.FLOAT,e.arrayElementsPerTexel=n,e.arrayConstructor=Float32Array,e.samplerPrefix="",e}throw new Error(`No supported texture format for ${sr[t]}[${n}].`)}function Hm(e,t,n){const i=t.arrayConstructor,r=t.arrayElementsPerTexel,s=t.textureInternalFormat,o=t.textureFormat,a=t.texelsPerElement,l=e.maxTextureSize,c=n.length/r;if(c*a>l*l)throw new Error("Number of elements exceeds maximum texture size: "+a+" * "+c);const d=Math.ceil(c/l),u=Math.ceil(ks(d)),h=(1<<u)*a,p=Math.ceil(c/(1<<u)),f=h*p*r;n.constructor!==i&&(n=new i(n.buffer,n.byteOffset,n.byteLength/i.BYTES_PER_ELEMENT));let g=function(e,t){if(e.length===t)return e;let n=new e.constructor(t);return n.set(e),n}(n,f);e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),ou(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,h,p,0,o,t.texelType,g)}function Jm(e,t,n,i,r){const s=t.arrayConstructor,o=t.textureInternalFormat,a=t.textureFormat,l=t.texelsPerElement;n.constructor!==s&&(n=new s(n.buffer,n.byteOffset,n.byteLength/s.BYTES_PER_ELEMENT)),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),ou(e),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,i*l,r,0,a,t.texelType,n)}function qm(e,t,n,i,r,s){const o=t.arrayConstructor,a=t.textureInternalFormat,l=t.textureFormat,c=t.texelsPerElement;n.constructor!==o&&(n=new o(n.buffer,n.byteOffset,n.byteLength/o.BYTES_PER_ELEMENT)),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),function(e){e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}(e),e.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,a,i*c,r,s,0,l,t.texelType,n)}function Ym(e){switch(e){case sr.UINT8:return Lu;case sr.INT8:return Iu;case sr.UINT16:return Mu;case sr.INT16:return Pu;case sr.UINT32:return Au;case sr.INT32:return Ru;case sr.UINT64:return yu;case sr.FLOAT32:return Du}}function Zm(e,t,n,i,r,s){const o=Bu(r,s);let a=[Ym(r)],l=`\n${o} ${e}(${i} index) {\n`;switch(r){case sr.UINT8:case sr.UINT16:case sr.UINT32:l+=`\n  ${o} result;\n  highp uvec4 temp;\n  ${t}(${n}, index, temp);\n  result.value = temp.${Om[s]};\n  return result;\n`;break;case sr.INT8:case sr.INT16:case sr.INT32:l+=`\n  ${o} result;\n  highp ivec4 temp;\n  ${t}(${n}, index, temp);\n  result.value = temp.${Om[s]};\n  return result;\n`;break;case sr.UINT64:a.push(bu),l+=`\n  highp uvec4 temp;\n  ${t}(${n}, index, temp);\n  return unpackUint64leFromUint32(temp.${Om[2*s]});\n`;break;case sr.FLOAT32:a.push(Du),l+=`\n  highp vec4 temp;\n  ${t}(${n}, index, temp);\n  return temp.${Om[s]};\n`}return l+="\n}\n",a.push(l),a}class Xm{constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let n=`\nvoid ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let i=0;i<e;++i)n+=`, out ${t}vec4 output${i}`;n+=`) {\n  highp int width = textureSize(sampler, 0).x / ${e};\n  highp uint log2width = log2Exact(uint(width));\n  highp int y = int(index >> log2width);\n  highp int x = int((index - (uint(y) << log2width)) * ${e}u);\n`;for(let i=0;i<e;++i)n+=`\n  output${i} = texelFetch(sampler, ivec2(x + ${i}, y), 0);\n`;return n+="\n}\n",["\nhighp uint log2Exact(highp uint i) {\n  highp uint r;\n  r = uint((i & 0xAAAAAAAAu) != 0u);\n  r |= uint((i & 0xFFFF0000u) != 0u) << 4;\n  r |= uint((i & 0xFF00FF00u) != 0u) << 3;\n  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;\n  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;\n  return r;\n}\n",n]}getAccessor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const r=$m(n);return[this.getReadTextureValueCode(1,r),...Zm(e,this.readTextureValue,t,"highp uint",n,i)]}}class Km{constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){const n=this.textureDims;let i=`\nvoid ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${n} p`;for(let r=0;r<e;++r)i+=`, out ${t}vec4 output${r}`;i+=") {\n";for(let r=0;r<e;++r)i+=`\n  output${r} = texelFetch(sampler, ivec${n}(p.x * ${e} + ${r}, p.y\n                                         ${3===n?", p.z":""}), 0);\n`;return i+="\n}\n",i}getAccessor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const r=$m(n);return[this.getReadTextureValueCode(1,r),...Zm(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,n,i)]}}const Qm=[yu,"\nhighp uint hashCombine(highp uint state, highp uint value) {\n  value *= 0xcc9e2d51u;\n  value = (value << 15u) | (value >> 17u);\n  value *= 0x1b873593u;\n  state ^= value;\n  state = (state << 13u) | (state >> 19u);\n  state = (state * 5u) + 0xe6546b64u;\n  return state;\n}\nhighp uint hashCombine(highp uint state, uint64_t x) {\n  state = hashCombine(state, x.value[0]);\n  return hashCombine(state, x.value[1]);\n}\n"],ev=jm(new Rm,sr.UINT64,1);class tv extends Sn{constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){let e=this.hashTable,t=e.generation;if(this.generation===t)return;const n=this.gl,i=this.texture;this.generation=t,n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,i),e.tableWithMungedEmptyKey((e=>{Hm(this.gl,ev,e)})),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,(()=>new this(e,t)))}}class nv{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=wm(`gpuhashtable:${this.prefix}`),this.accessHelper=new Xm(`gpuhashtable_${this.prefix}`),this.samplerName=this.prefix+"_sampler",this.hashSeedsName=this.prefix+"_seeds",this.hashKeyMask=this.prefix+"_keyMask",this.readTable=this.prefix+"_readTable"}defineShader(e){let t=this.hashSeedsName,n=this.samplerName,i=this.numAlternatives,r=this.hashKeyMask;e.addUniform("highp uint",t,i),e.addUniform("highp uint",r),e.addTextureSampler("usampler2D",n,this.textureUnitSymbol),e.addFragmentCode(Qm),e.addFragmentCode(yu),e.addFragmentCode(Su),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,sr.UINT64,1));let s="";s+=`\nbool ${this.hasFunctionName}(uint64_t x) {\n`;for(let o=0;o<i;++o)s+=`\n  {\n    uint h = hashCombine(${t}[${o}], x) & ${r};\n    uint64_t key = ${this.readTable}(h);\n    if (equals(key, x)) {\n      return true;\n    }\n  }\n`;s+="\n  return false;\n}\n",e.addFragmentCode(s)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,n){n.copyToGPU();const i=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+i),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n.texture),e.uniform1ui(t.uniform(this.hashKeyMask),n.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),n.hashTable.hashSeeds)}disable(e,t){const n=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class iv extends nv{defineShader(e){super.defineShader(e);let t=this.numAlternatives,n=this.hashSeedsName,i=this.hashKeyMask,r=`\nbool ${this.getFunctionName}(uint64_t x, out uint64_t value) {\n`;for(let s=0;s<t;++s)r+=`\n  {\n    uint h = hashCombine(${n}[${s}], x) & ${i};\n    uint64_t key = ${this.readTable}(h * 2u);\n    if (equals(key, x)) {\n      value = ${this.readTable}(h * 2u + 1u);\n      return true;\n    }\n  }\n`;r+="\n  return false;\n}\n",e.addFragmentCode(r)}get getFunctionName(){return`${this.prefix}_get`}}function rv(e,t,n,i){t*=6;let r=Math.floor(t),s=t-r,o=i*(1-n),a=i*(1-n*s),l=i*(1-n*(1-s));switch(r%6){case 0:e[0]=i,e[1]=l,e[2]=o;break;case 1:e[0]=a,e[1]=i,e[2]=o;break;case 2:e[0]=o,e[1]=i,e[2]=l;break;case 3:e[0]=o,e[1]=a,e[2]=i;break;case 4:e[0]=l,e[1]=o,e[2]=i;break;case 5:e[0]=i,e[1]=o,e[2]=a}return e}class sv{constructor(e){this.prefix=e,this.seedName=this.prefix+"_seed"}defineShader(e){const t=this.seedName;e.addUniform("highp uint",t),e.addFragmentCode(yu),e.addFragmentCode(Qm),e.addFragmentCode("\nvec3 hueToRgb(float hue) {\n  float hue6 = hue * 6.0;\n  float r = abs(hue6 - 3.0) - 1.0;\n  float g = 2.0 - abs(hue6 - 2.0);\n  float b = 2.0 - abs(hue6 - 4.0);\n  return clamp(vec3(r, g, b), 0.0, 1.0);\n}\nvec3 hsvToRgb(vec3 c) {\n  vec3 hueRgb = hueToRgb(c.x);\n  return c.z * ((hueRgb - 1.0) * c.y + 1.0);\n}\n");let n=`\nvec3 ${this.prefix}(uint64_t x) {\n  uint h = hashCombine(${t}, x);\n  vec2 v;\n`;for(let i=0;i<2;++i)n+=`\n  v[${i}] = float(h & 0xFFu) / 255.0;\n  h >>= 8u;\n`;n+="\n  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);\n  return hsvToRgb(hsv);\n}\n",e.addFragmentCode(n)}enable(e,t,n){e.uniform1ui(t.uniform(this.seedName),n)}}let ov=new Float32Array(3);function av(e){return`rgb(${100*e[0]}%,${100*e[1]}%,${100*e[2]}%)`}class lv{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:qs();this.hashSeed=e,this.changed=new kn}static getDefault(){return new lv(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let n=bm(this.hashSeed,t.low);n=bm(n,t.high);return rv(e,(255&n)/255,.5+.5*((n>>8&255)/255),1),e}computeCssColor(e){return this.compute(ov,e),av(ov)}randomize(){this.hashSeed=qs(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return 0===this.hashSeed?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){const t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class cv{constructor(e){this.prefix=e,this.hashMapShaderManager=new iv("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);let t=`\nbool ${this.getFunctionName}(uint64_t x, out vec3 value) {\n  uint64_t uint64Value;\n  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {\n    uint uintValue = uint64Value.value[0];\n    value.r = float((uintValue & 0x0000ffu))       / 255.0;\n    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;\n    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;\n    return true;\n  }\n  return false;\n}\n`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,n){this.hashMapShaderManager.enable(e,t,n)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}const dv="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYXJyb3dMZWZ0SWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iYXJyb3dMZWZ0SWNvblRpdGxlIj5BcnJvdyBMZWZ0PC90aXRsZT4gICAgCiAgICA8cGF0aCBkPSJNOSA2bC02IDYgNiA2Ii8+CiAgICA8cGF0aCBkPSJNMjEgMTJINCIvPgogICAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBkPSJNMyAxMmgxIi8+Cjwvc3ZnPg==",uv="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYXJyb3dSaWdodEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImFycm93UmlnaHRJY29uVGl0bGUiPkFycm93IFJpZ2h0PC90aXRsZT4gICAgCiAgICA8cGF0aCBkPSJNMTUgMThsNi02LTYtNiIvPgogICAgPHBhdGggZD0iTTMgMTJoMTciLz4KICAgIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTIxIDEyaC0xIi8+Cjwvc3ZnPg==";class hv{constructor(e){if(this.parents=new Array,this.parentPriorities=new Array,this.bindings=new pt,void 0!==e){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(const n of e.bindings){var t=O(n,2);const e=t[0],i=t[1];this.bindings.set(e,i)}}}addParent(e,t){const n=this.parents,i=this.parentPriorities;let r=0;const s=n.length;for(;r<s&&t<i[r];)++r;return n.splice(r,0,e),i.splice(r,0,t),()=>{this.removeParent(e)}}removeParent(e){const t=this.parents.indexOf(e);if(-1===t)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){const t=this.parents,n=this.parentPriorities,i=n.length;let r,s=0;for(;s<i&&n[s]>0;++s)if(r=t[s].get(e),void 0!==r)return r;if(r=this.bindings.get(e),void 0!==r)return r;for(;s<i;++s)if(r=t[s].get(e),void 0!==r)return r}*getAll(e){const t=this.parents,n=this.parentPriorities,i=n.length;let r;for(;0<i&&n[0]>0;)r=t[0].get(e),void 0!==r&&(yield r);for(r=this.bindings.get(e),void 0!==r&&(yield r);0<i;)r=t[0].get(e),void 0!==r&&(yield r)}*entries(){const e=this.parents,t=this.parentPriorities,n=t.length;let i=0;for(;i<n&&t[i]>0;++i)yield*e[i].entries();for(yield*this.bindings.entries();i<n;++i)yield*e[i].entries()}}var pv;function fv(e){return(e.ctrlKey?1:0)|(e.altKey?2:0)|(e.metaKey?4:0)|(e.shiftKey?8:0)}function gv(e,t){let n="";return 1&t&&(n+="control+"),2&t&&(n+="alt+"),4&t&&(n+="meta+"),8&t&&(n+="shift+"),n+=e,n}function mv(e){const t=e.indexOf(":");let n;if(-1!==t&&(n=e.substring(0,t),"at"!==n&&"bubble"!==n))throw new Error(`Invalid event phase: ${Bt(n)}`);const i=e.substring(t+1).split("+");let r,s=0,o=0;e:for(let a of i)switch(a){case"control":s|=1;break;case"control?":o|=1;break;case"alt":s|=2;break;case"alt?":o|=2;break;case"meta":s|=4;break;case"meta?":o|=4;break;case"shift":s|=8;break;case"shift?":o|=8;break;default:if(void 0!==r){r=void 0;break e}r=a}if(void 0===r||s&o)throw new Error(`Invalid event identifier: ${Bt(e)}`);return{phase:n,keyName:r,modifiers:s,optionalModifiers:o}}function*vv(e){const t=e.phase,n=function*(e,t,n){0===n&&(yield gv(e,t));for(let i=0;i<16;++i)(i&(t|n))===i&&(i&t)===t&&(yield gv(e,i))}(e.keyName,e.modifiers,e.optionalModifiers);if(void 0===t)for(const i of n)yield`at:${i}`,yield`bubble:${i}`;else for(const i of n)yield`${t}:${i}`}!function(e){e[e.CONTROL=1]="CONTROL",e[e.ALT=2]="ALT",e[e.META=4]="META",e[e.SHIFT=8]="SHIFT"}(pv||(pv={}));class yv extends hv{static fromObject(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new yv;if(n.label=t.label,void 0!==t.parents)for(const r of t.parents){var i=O(r,2);const e=i[0],t=i[1];n.addParent(e,t)}for(const r of f(e))n.set(r,e[r]);return n}setFromObject(e){for(const t of f(e))this.set(t,e[t])}set(e,t){const n=mv(e),r=function(e,t){const n=function(e,t,n){let i="";return 1&t&&(i+="control+"),1&n&&(i+="control?+"),2&t&&(i+="alt+"),2&n&&(i+="alt?+"),4&t&&(i+="meta+"),4&n&&(i+="meta?+"),8&t&&(i+="shift+"),8&n&&(i+="shift?+"),i+=e,i}(e.keyName,e.modifiers,e.optionalModifiers);return"string"==typeof t?{action:t,originalEventIdentifier:n}:(0,i.bn)((0,i.bn)({},t),{originalEventIdentifier:n})}(n,t);for(const i of vv(n))super.set(i,r)}delete(e){for(const t of vv(mv(e)))super.delete(t)}describe(){const e=[],t=new pt;for(const i of this.entries()){const e=O(i,2)[1];t.set(e.originalEventIdentifier,e.action)}for(const i of t){var n=O(i,2);const t=n[0],r=n[1];e.push(`${t}\u2192${r}`)}return e.join(", ")}}function bv(e,t,n){if(void 0===n)return;!1!==n.stopPropagation&&e.stopPropagation();const i=new CustomEvent("action:"+n.action,{bubbles:!0,detail:t,cancelable:!0}),r=!e.target.dispatchEvent(i);(!1!==n.preventDefault||r)&&e.preventDefault()}const Sv=[];function wv(e,t,n,i,r){const s=Sv[n]+":"+e;bv(t,i,r.get(s))}function xv(e,t,n,i){wv(gv(e,fv(t)),t,t.eventPhase,n,i)}function Cv(e,t,n,i){return bn(e,`action:${t}`,n,i)}let kv,Tv,Ev,Lv,Iv,Dv;function Mv(){return void 0===Tv&&(Tv=yv.fromObject({"control+mousedown2":"select-position"})),Tv}function Pv(){return void 0===Lv&&(Lv=yv.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:alt+mousedown2":"copy-segment-id","at:alt+shift+mousedown2":"add-copy-segment-id","at:dblclick0":"select","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[Mv(),0]]})),Lv}function Av(e){e.global.addParent(function(){if(void 0===kv){const e=new yv;e.set("keyl","recolor"),e.set("keyx","clear-segments"),e.set("keys","toggle-show-slices"),e.set("keyb","toggle-scale-bar"),e.set("keyv","toggle-default-annotations"),e.set("keya","toggle-axis-lines"),e.set("keyo","toggle-orthographic-projection");for(let t=1;t<=9;++t)e.set("digit"+t,"toggle-layer-"+t),e.set("control+digit"+t,"select-layer-"+t),e.set("alt+digit"+t,"toggle-pick-layer-"+t);for(let t=0;t<26;++t){const n=String.fromCharCode(97+t),i=String.fromCharCode(65+t);e.set(`alt?+control?+shift+key${n}`,`tool-${i}`)}e.set("keyn","add-layer"),e.set("keyh","help"),e.set("space","toggle-layout"),e.set("shift+space","toggle-layout-alternative"),e.set("backslash","toggle-show-statistics"),kv=e}return kv}(),Number.NEGATIVE_INFINITY),e.sliceView.addParent((void 0===Dv&&(Dv=yv.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[Pv(),Number.NEGATIVE_INFINITY]]})),Dv),Number.NEGATIVE_INFINITY),e.perspectiveView.addParent((void 0===Iv&&(Iv=yv.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[Pv(),Number.NEGATIVE_INFINITY]]})),Iv),Number.NEGATIVE_INFINITY)}function Rv(e){for(;;){let t=e.firstChild;if(!t)break;e.removeChild(t)}}function Nv(e){let t=e.parentElement;return!!t&&(t.removeChild(e),!0)}function Vv(e){const t=`${arguments.length>1&&void 0!==arguments[1]?arguments[1]:Math.max(1,e.value.length)}ch`;e.style.width!==t&&(e.style.width="0px",e.offsetWidth,e.style.width=t)}function Ov(e,t){let n=e.firstElementChild;for(const i of t)i!==n&&e.insertBefore(i,n),n=i.nextElementSibling;for(;null!==n;){let t=n.nextElementSibling;e.removeChild(n),n=t}}function Bv(e){return e instanceof HTMLElement&&!!(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e.isContentEditable)}Sv[Event.AT_TARGET]="at",Sv[Event.CAPTURING_PHASE]="capture",Sv[Event.BUBBLING_PHASE]="bubble";let _v,Fv=[];function zv(e){const t=function(){if(void 0===_v){const e=_v=document.createElement("div");e.classList.add("neuroglancer-drag-status"),document.body.appendChild(e)}return _v}();Rv(t),"string"==typeof e?t.appendChild(document.createTextNode(e)):t.appendChild(e()),t.style.display=""}function Uv(e,t){_t(Fv,(n=>!(n.target===e&&n.operation===t)))}function Gv(e,t,n){Uv(e,t),Fv.push({target:e,operation:t,status:n}),zv(n)}function Wv(e,t){Uv(e,t);const n=0===Fv.length?void 0:Fv[Fv.length-1];void 0===n?void 0!==_v&&(Rv(_v),_v.style.display="none"):zv(n.status)}const $v={side:"right",col:0,row:1/0,flex:1,size:300,minSize:100,visible:!1};class jv{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$v,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;this.defaultValue=e,this.value=t,this.changed=new Cn,this.locationChanged=new Cn,this.locationChanged.add(this.changed.dispatch);const n=this;this.watchableVisible={get value(){return n.visible},set value(e){n.visible=e},changed:n.locationChanged}}toJSON(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultValue;const t={},n=this.value;for(const i in n)n[i]!==e[i]&&(t[i]=n[i]);return t}get visible(){return this.value.visible}set visible(e){const t=this.value;t.visible!==e&&(this.value=(0,i.bn)((0,i.bn)({},t),{visible:e}),this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultValue;if(void 0===e)return;Yr(e);const n={side:is(e,"side",(e=>{if("left"!==e&&"right"!==e&&"top"!==e&&"bottom"!==e)throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${Bt(e)}`);return e}),t.side),col:is(e,"col",Tr,t.col),row:is(e,"row",Tr,t.row),flex:is(e,"flex",Tr,t.flex),size:is(e,"size",Xr,t.size),visible:is(e,"visible",hs,t.visible),minSize:t.minSize};this.value=n,this.locationChanged.dispatch()}}function Hv(e,t,n){const i=e.view.document;let r=e.clientX,s=e.clientY;const o=e=>{const n=e.clientX-r,i=e.clientY-s;r=e.clientX,s=e.clientY,t(e,n,i)},a=e.button,l=e=>{i.removeEventListener("pointermove",o,!0),i.removeEventListener("pointerup",c,!1),void 0!==n&&n(e,e.clientX-r,e.clientY-s)},c=e=>{e.button===a&&l(e)};i.addEventListener("pointermove",o,!0),i.addEventListener("pointerup",c,!1),i.addEventListener("pointercancel",l,!1)}function Jv(e){const t=e.title,n=e.onClick,i=e.href;let r;void 0!==i?(r=document.createElement("a"),r.href=i,r.target="_blank"):r=document.createElement("div"),void 0!==t&&(r.title=t),void 0!==n&&r.addEventListener("click",n);const s=e.svg;return r.className="neuroglancer-icon",void 0!==s&&(r.innerHTML=s),void 0!==e.text&&r.appendChild(document.createTextNode(e.text)),r}function qv(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iY2xvc2VJY29uVGl0bGUiPgogICAgPHRpdGxlIGlkPSJjbG9zZUljb25UaXRsZSI+Q2xvc2U8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik02LjM0MzE0NTc1IDYuMzQzMTQ1NzVMMTcuNjU2ODU0MiAxNy42NTY4NTQyTTYuMzQzMTQ1NzUgMTcuNjU2ODU0MkwxNy42NTY4NTQyIDYuMzQzMTQ1NzUiLz4KPC9zdmc+"},e))}const Yv="neuroglancer-drag-over",Zv={row:"row",column:"col"},Xv={left:"right",right:"left",top:"bottom",bottom:"top"},Kv={left:"column",right:"column",top:"row",bottom:"row"},Qv={left:"row",right:"row",top:"column",bottom:"column"},ey={row:"width",column:"height"},ty={row:"left",column:"top"},ny={row:"right",column:"bottom"},iy={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},ry={left:-1,right:1,top:-1,bottom:1};class sy extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new jv;super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new kd(kd.VISIBLE);const n=this.element;n.classList.add("neuroglancer-side-panel"),n.draggable=!0,n.addEventListener("dragstart",(e=>{this.sidePanelManager.startDrag(this.makeDragSource(),e),n.style.backgroundColor="black",setTimeout((()=>{n.style.backgroundColor=""}),0),Gv(n,"drag",(()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel")))})),n.addEventListener("dragend",(e=>{this.sidePanelManager.endDrag(),Wv(n,"drag")}))}makeDragSource(){return{dropAsNewPanel:e=>{const t=this.location.value;this.location.value=(0,i.bn)((0,i.bn)({},t),e),this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){const t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");const n=e.title;let i;void 0!==n&&(i=document.createElement("div"),i.classList.add("neuroglancer-side-panel-title"),i.textContent=n,t.appendChild(i));const r=qv({title:"Close panel",onClick:()=>{this.close()}});return r.style.order="100",t.appendChild(r),this.element.appendChild(t),{titleBar:t,titleElement:i,closeButton:r}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",(e=>{e.preventDefault(),e.stopPropagation()})),this.element.appendChild(e)}}class oy extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new kd(kd.VISIBLE);super(),this.display=e,this.center=t,this.visibility=n,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new Cn,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new Rt,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};const i=this.element,r=this.centerColumn;i.style.display="flex",i.style.flex="1",i.style.flexDirection="row",r.style.display="flex",r.style.flex="1",r.style.flexDirection="column",r.style.flexBasis="0px",r.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add((()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)}))),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,ry[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return void 0!==this.dragSource}startDrag(e,t){setTimeout((()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")}),0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const s=document.createElement("div");s.className="neuroglancer-side-panel-drop-zone";const o=Kv[i],a=Qv[i];return s.style[ey[a]]="10px",s.style[ey[o]]="100%",r?(s.style.position="absolute",s.style[i]="50%",s.style[iy[i]]="-${size/2}px"):(s.style.position="relative",s.style[iy[Xv[i]]]="-10px"),s.addEventListener("dragenter",(e=>{this.hasDroppablePanel()&&(s.classList.add(Yv),e.preventDefault(),Gv(s,"drop",(()=>document.createTextNode(`Drop side panel as new ${o}`))))})),s.addEventListener("dragleave",(()=>{Wv(s,"drop"),s.classList.remove(Yv)})),s.addEventListener("dragover",(e=>{this.hasDroppablePanel()&&e.preventDefault()})),s.addEventListener("drop",(i=>{const r=this.dragSource;if(void 0===r)return;Wv(s,"drop"),s.classList.remove(Yv);const o=Kv[e];r.dropAsNewPanel({side:e,row:"column"===o?n:t,col:"row"===o?n:t}),this.dragSource=void 0,i.preventDefault(),i.stopPropagation()})),s}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),null===(t=e.panel)||void 0===t||t.dispose(),this.invalidateLayout()}disposed(){for(const e of this.registeredPanels){const t=e.panel;t?.dispose()}super.disposed()}render(){this.layoutNeedsUpdate=!1;const e={left:[],right:[],top:[],bottom:[]};for(const i of this.registeredPanels)e[i.location.value.side].push(i);const t=t=>this.renderSide(t,this.sides[t].flexGroups,e[t]),n=this;Ov(this.element,function*(){yield n.sides.left.outerDropZoneElement,yield*t("left"),yield n.centerColumn,yield*t("right"),yield n.sides.right.outerDropZoneElement}()),Ov(this.centerColumn,function*(){yield n.sides.top.outerDropZoneElement,yield*t("top"),yield n.center,yield*t("bottom"),yield n.sides.bottom.outerDropZoneElement}())}makeCrossGutter(e,t){const n=document.createElement("div");n.style.position="relative";const i=Qv[e];n.className="neuroglancer-resize-gutter-"+("row"===i?"horizontal":"vertical"),n.addEventListener("pointerdown",(r=>{if("button"in r&&0!==r.button)return;r.preventDefault();const s=this.sides[e].flexGroups[t];if(void 0===s||!s.visible)return;let o=s.element.getBoundingClientRect()[ey[i]];const a=s.minSize,l=()=>{Gv(n,"drag",`Drag to resize, current ${ey[i]} is ${s.crossSize}px`)};l(),Hv(r,((t,n,r)=>{o-=ry[e]*("row"===i?n:r),s.crossSize=Math.max(a,Math.round(o)),l(),this.invalidateLayout()}),(()=>{Wv(n,"drag")}))}));const r=this.makeDropZone(e,t-.5*ry[e],0,e,!0);return n.appendChild(r),n}makeFlexGutter(e,t,n){const r=document.createElement("div");r.style.position="relative";const s=Kv[e];r.className="neuroglancer-resize-gutter-"+("row"===s?"horizontal":"vertical"),r.addEventListener("pointerdown",(o=>{if("button"in o&&0!==o.button)return;o.preventDefault();const a=this.sides[e].flexGroups[t];if(void 0===a||!a.visible)return;const l=a.cells,c=l[n];if(void 0===c||!c.registeredPanel.location.visible)return;let d=n+1;for(;d<l.length&&!l[d].registeredPanel.location.visible;)++d;if(d===l.length)return;const u=l[d],h=()=>{Gv(r,"drag",`Drag to resize, current ${ey[s]} ratio is ${c.registeredPanel.location.value.flex} : ${u.registeredPanel.location.value.flex}`)};h(),Hv(o,(e=>{const t=c.registeredPanel.panel,n=u.registeredPanel.panel;if(void 0===t||void 0===n)return;const r=t.element.getBoundingClientRect(),o=n.element.getBoundingClientRect(),a=Math.max(.1,Math.min(.9,"column"===s?(e.clientY-r.top)/(o.bottom-r.top):(e.clientX-r.left)/(o.right-r.left))),l=c.registeredPanel.location.value,d=u.registeredPanel.location.value,p=l.flex+d.flex;c.registeredPanel.location.value=(0,i.bn)((0,i.bn)({},l),{flex:Math.round(a*p*100)/100}),u.registeredPanel.location.value=(0,i.bn)((0,i.bn)({},d),{flex:Math.round((1-a)*p*100)/100}),h(),c.registeredPanel.location.locationChanged.dispatch(),u.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()}),(()=>{Wv(r,"drag")}))}));const o=this.makeDropZone(e,t,n+.5,ty[Kv[e]],!0);return r.appendChild(o),r}renderSide(e,t,n){const r=Zv[Qv[e]],s=Zv[Kv[e]];n.sort(((e,t)=>{const n=e.location.value,i=t.location.value,o=n[s]-i[s];return 0!==o?o:n[r]-i[r]}));const o=this;return function*(){let a=0,l=n.length,c=0;for(;a<l;){const d=n[a].location.value[s];let u=a,h=0,p=0;do{const v=n[u].location.value;if(v[s]!==d)break;v.visible&&(++h,p=Math.max(p,v.minSize)),++u}while(u<l);const f=h>0;let g=t[c];if(void 0===g){const y=o.makeCrossGutter(e,c),b=document.createElement("div");b.className=`neuroglancer-side-panel-${Kv[e]}`,g=t[c]={element:b,gutterElement:y,cells:[],crossSize:-1,minSize:p,visible:f,beginDropZone:o.makeDropZone(e,c,-1/0,ty[Kv[e]]),endDropZone:o.makeDropZone(e,c,1/0,ny[Kv[e]])}}else g.visible=f,g.minSize=p,g.crossSize=Math.max(g.crossSize,p);function*m(){yield g.beginDropZone;let t=0;for(let l=a,d=0;l<u;++l,++d){const a=n[l];let u=g.cells[d];void 0===u?u=g.cells[d]={registeredPanel:a,gutterElement:void 0}:u.registeredPanel=a;const f=u.registeredPanel.location.value;-1==g.crossSize&&(g.crossSize=Math.max(p,f.size)),(f[s]!==c||f[r]!==d||f.visible&&f.size!==g.crossSize)&&(u.registeredPanel.location.value=(0,i.bn)((0,i.bn)({},f),{[s]:c,[r]:d,size:f.visible?g.crossSize:f.size}),u.registeredPanel.location.changed.dispatch());const m=f.visible&&o.visibility.visible;let v=a.panel;m?(++t,void 0===v&&(v=a.panel=a.makePanel()),v.element.style.flex=h>1?`${f.flex}`:"1",yield v.element,t===h?u.gutterElement=void 0:(void 0===u.gutterElement&&(u.gutterElement=o.makeFlexGutter(e,c,d)),yield u.gutterElement)):void 0!==v&&(v.dispose(),a.panel=void 0)}yield g.endDropZone}Ov(g.element,m()),g.cells.length=u-a,f&&(g.element.style[ey[Qv[e]]]=`${g.crossSize}px`,ry[e]>0?(yield g.gutterElement,yield g.element):(yield g.element,yield g.gutterElement)),a=u,++c}t.length=c}()}}function ay(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"text/plain",n=!1;const i=bn(document,"copy",(i=>{const r=i.clipboardData;null!==r&&(r.setData(t,e),n=!0),i.stopPropagation(),i.preventDefault()}),!0);try{document.execCommand("copy")}finally{i()}return n}class ly extends Sn{constructor(e,t,n){super(),this.target=e,this.eventMap=t,this.registerEventListener(e,"wheel",(e=>{void 0!==n&&n(e),this.dispatch("wheel",e)})),this.registerEventListener(e,"click",(e=>{void 0!==n&&n(e),this.dispatch(`click${e.button}`,e)})),this.registerEventListener(e,"dblclick",(e=>{void 0!==n&&n(e),this.dispatch(`dblclick${e.button}`,e)})),this.registerEventListener(e,"mousedown",(e=>{void 0!==n&&n(e);let t=e.button;2===t&&1===(3&e.buttons)&&(t=0),this.dispatch(`mousedown${t}`,e)})),this.registerEventListener(e,"mouseup",(e=>{void 0!==n&&n(e),this.dispatch(`mouseup${e.button}`,e)}))}dispatch(e,t){xv(e,t,t,this.eventMap)}}class cy extends Sn{constructor(e,t){super(),this.element=Jv((0,i.bn)((0,i.bn)({},t),{onClick:()=>{e.value=!e.value}})),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add("dark"===t.backgroundScheme?"dark-background":"light-background");const n=()=>{const n=e.value;this.element.dataset.checked=n?"true":"false",this.element.title=(n?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(n)),n()}}function dy(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iY29weUljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImNvcHlJY29uVGl0bGUiPkNvcHk8L3RpdGxlPiAgICAKICAgIDxyZWN0IHdpZHRoPSIxMiIgaGVpZ2h0PSIxNCIgeD0iOCIgeT0iNyIvPgogICAgPHBvbHlsaW5lIHBvaW50cz0iMTYgMyA0IDMgNCAxNyIvPgo8L3N2Zz4="},e))}class uy extends Sn{constructor(e){super(),this.redraw=e}}class hy extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new kd(kd.VISIBLE);super(),this.model=e,this.render=t,this.visibility=n,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable(al((()=>this.updateView()))),this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(n.changed.add((()=>{this.visible&&this.debouncedUpdateView()}))),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;const e=this.model;if(e.changed.count===this.generation)return;this.disposeCurrentView();const t=this.currentViewDisposer=new uy(this.debouncedUpdateView);this.render(e.value,this.element,t)}disposeCurrentView(){let e=this.currentViewDisposer;void 0!==e&&e.dispose(),Rv(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}function py(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({text:"\u2197"},e))}function fy(e){return e.closest(".neuroglancer-selection-details")}class gy extends sy{constructor(e,t,n,i){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=n,this.selectedLayer=i,this.body=document.createElement("div");const r=this.element,s=this.body;r.classList.add("neuroglancer-selection-details"),this.registerDisposer(new ly(this.element,Mv()));const o=this.addTitleBar({title:"Selection"}).titleBar,a=Jv({svg:dv,title:"Previous selection",onClick:()=>{this.state.goBack()}}),l=Jv({svg:uv,title:"Next selection",onClick:()=>{this.state.goForward()}});o.appendChild(a),o.appendChild(l),o.appendChild(this.registerDisposer(new cy(t.pin,{text:"\ud83d\udccc\ufe0e",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),s.classList.add("neuroglancer-selection-details-body"),this.addBody(s),s.appendChild(this.registerDisposer(new hy(t,((e,n,i)=>{if(t.location.visible&&(a.style.visibility=t.canGoBack()?"visible":"hidden",l.style.visibility=t.canGoForward()?"visible":"hidden",void 0!==e)){if(void 0!==e.position){const t=document.createElement("div");t.classList.add("neuroglancer-selection-details-position");const i=dy({title:"Copy position",onClick:()=>{ay(a.map((e=>Math.floor(e))).join(", "))}});t.appendChild(i);var r=e.coordinateSpace;const s=r.rank,o=r.names,a=e.position;for(let e=0;e<s;++e){const n=document.createElement("span");n.classList.add("neuroglancer-selection-details-position-dimension");const i=document.createElement("span");i.classList.add("neuroglancer-selection-details-position-dimension-name"),i.textContent=o[e];const r=document.createElement("span");r.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),r.textContent=Math.floor(a[e]).toString(),n.appendChild(i),n.appendChild(r),t.appendChild(n)}const l=py({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=a}});t.appendChild(l),n.appendChild(t)}for(const t of e.layers){const e=t.layer;n.appendChild(i.registerDisposer(new hy({value:void 0,changed:e.managedLayer.layerChanged},((n,i,r)=>{if(e.wasDisposed||!e.isReady)return;const s=document.createElement("div");if(s.classList.add("neuroglancer-selection-details-layer-body"),!e.displaySelectionState(t.state,s,r))return;const o=document.createElement("div");i.appendChild(o),o.classList.add("neuroglancer-selection-details-layer");const a=document.createElement("div");a.classList.add("neuroglancer-selection-details-layer-title"),a.textContent=e.managedLayer.name,a.addEventListener("click",(()=>{this.selectedLayer.layer=e.managedLayer,this.selectedLayer.visible=!0})),a.title="Click to show layer side panel",o.appendChild(a),o.appendChild(s)}))).element)}}}))).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}class my{constructor(e,t,n){this.key=e,this.value=t,this.label=n}toString(){const e=this.key,t=this.value,n=this.label;let i;return i=void 0===t?`${e}`:`${e}\u2192${t}`,void 0===n?i:`${i} ${n}`}}class vy extends Sn{constructor(){super(...arguments),this.selectedSegment=new Ds,this.baseSelectedSegment=new Ds,this.hasSelectedSegment=!1,this.changed=new kn}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=this.selectedSegment,i=this.baseSelectedSegment;let r,s=0,o=0,a=0,l=0;if(null==e)r=!1;else if("number"==typeof e)s=a=e>>>0,o=l=e<0?4294967295:0,r=!0;else if(e instanceof my){const t=e.value||e.key;s=t.low,o=t.high,a=e.key.low,l=e.key.high,r=!0}else e instanceof Ds?(s=a=e.low,o=l=e.high,r=!0):r=!1;t&&0===s&&0===o&&(r=!1),r?r&&(!this.hasSelectedSegment||n.low!==s||n.high!==o||i.low!==a||i.high!==l)&&(n.low=s,n.high=o,i.low=a,i.high=l,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&Ds.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add((()=>{const n=e.get(t);let i;void 0!==n&&(i=n.value),this.set(i,t.displayState.segmentationGroupState.value.hideSegmentZero.value)})))}}function yy(e){e.useTemporarySegmentEquivalences.value=!1,e.useTemporaryVisibleSegments.value=!1,e.temporaryVisibleSegments.clear(),e.temporarySegmentEquivalences.clear()}function by(e,t){let n,i,r,s,o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(n="number"==typeof t?new Ds(t>>>0,t<0?4294967295:0):"string"==typeof t?Ds.parseString(t):o?t.clone():t,null==e)return n;var a=e.segmentationGroupState.value;const l=a.segmentEquivalences,c=a.segmentPropertyMap.value;return 0!==l.size?(i=l.get(n),r=Ds.equal(i,n)?void 0:i):i=n,s=c?.getSegmentLabel(i),void 0===s&&null==r?n:new my(n,r,s)}function Sy(e,t){if(t instanceof my)return t;let n=by(e,t);return n instanceof Ds?new my(n):n}function wy(e,t){const n=t.length;e.value<n&&(e.value=n)}function xy(e,t){return Fn((e=>t.style.setProperty("--neuroglancer-segment-list-width",`${e}ch`)),e.segmentationGroupState.value.maxIdLength)}const Cy=(()=>{const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry");const t=document.createElement("div");t.classList.add("neuroglancer-segment-list-entry-sticky"),e.appendChild(t);const n=dy({title:"Copy segment ID"});n.classList.add("neuroglancer-segment-list-entry-copy");const r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-copy-container");const s=r.childElementCount;r.appendChild(n);const o=t.childElementCount;t.appendChild(r);const a=t.childElementCount,l=document.createElement("input");l.type="checkbox",l.title="Toggle segment visibility",l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),t.appendChild(l);const c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");const d=t.childElementCount;t.appendChild(c);const u=document.createElement("div");u.classList.add("neuroglancer-segment-list-entry-id");const h=c.childElementCount;c.appendChild(u);const p=document.createElement("span");p.classList.add("neuroglancer-segment-list-entry-name");const f=e.childElementCount;e.appendChild(p);const g=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iZmlsdGVySWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iZmlsdGVySWNvblRpdGxlIj5GaWx0ZXI8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0xMCAxMi4yNjFMNC4wMjggMy45NzJoMTZMMTQgMTIuMzI5VjE3bC00IDN6Ii8+Cjwvc3ZnPg=="},e))}({title:"Filter by label"});g.classList.add("neuroglancer-segment-list-entry-filter");const m=e.childElementCount;return e.appendChild(g),{template:e,copyContainerIndex:o,copyIndex:s,visibleIndex:a,idContainerIndex:d,idIndex:h,labelIndex:f,filterIndex:m,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),ky=(()=>{const e=Cy,t=e.template.cloneNode(!0),n=t.children[0],r=n.children[e.idContainerIndex],s=r.childElementCount,o=r.children[e.idIndex].cloneNode(!0);o.classList.add("neuroglancer-segment-list-entry-unmapped-id"),r.appendChild(o);const a=n.children[e.copyContainerIndex],l=a.childElementCount;return a.appendChild(a.children[e.copyIndex].cloneNode(!0)),(0,i.bn)((0,i.bn)({},e),{template:t,unmappedIdIndex:s,unmappedCopyIndex:l})})();function Ty(e){let t=Cy;const n=t.template.cloneNode(!0),r=[];for(let i=0;i<e;++i){r.push(n.childElementCount);const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-extra-property"),e.style.width=`max(var(--neuroglancer-column-${i}-width), var(--neuroglancer-column-${i}-label-width))`,n.appendChild(e)}return(0,i.bn)((0,i.bn)({},t),{template:n,numericalPropertyIndices:r})}const Ey=new Pg;class Ly{constructor(e,t){if(this.displayState=e,this.template=t,void 0!==e){let t=Ey.get(e);void 0===t&&(t=function(e){const t=t=>{const n=t.currentTarget,i=n.dataset.id,r=Oy;r.tryParseString(i),e.segmentSelectionState.set(r),fy(n)||e.selectSegment(r,!1)},n=t=>{const n=t.currentTarget,i=n.dataset.id,r=Oy;r.tryParseString(i),e.selectSegment(r,!fy(n)||"toggle")},i=()=>{e.segmentSelectionState.set(null)},r=e=>e.currentTarget.closest(".neuroglancer-segment-list-entry"),s=e=>{ay(r(e).dataset.id),e.stopPropagation()},o=e=>{ay(r(e).dataset.unmappedId),e.stopPropagation()},a=t=>{const n=r(t).dataset.id,i=Oy;i.tryParseString(n);const s=e.segmentationGroupState.value.visibleSegments;s.set(i,!s.has(i)),t.stopPropagation()},l=t=>{const n=r(t).dataset.id,i=Oy;i.tryParseString(n),e.filterBySegmentLabel(i),t.stopPropagation()},c=t=>{if(2!==t.button||t.ctrlKey||t.altKey||t.metaKey||t.shiftKey)return;const n=t.currentTarget.dataset.id,i=Oy;i.tryParseString(n),e.moveToSegment(i)};return(e,r)=>{const d=e.children,u=d[0].children;e.addEventListener("mousedown",c);const h=u[r.copyContainerIndex];-1!==r.unmappedCopyIndex&&h.children[r.unmappedCopyIndex].addEventListener("click",o),h.children[r.copyIndex].addEventListener("click",s),e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",i),u[r.visibleIndex].addEventListener("click",a),d[r.filterIndex].addEventListener("click",l),e.addEventListener("action:select-position",n)}}(e),Ey.set(e,t)),this.registerEventHandlers=t}}static make(e,t){return new Ly(e,t?ky:Cy)}get(e){const t=this.displayState;return this.getWithNormalizedId(Sy(t,e))}getWithNormalizedId(e){var t,n;const i=this.displayState,r=this.template,s=r.template.cloneNode(!0),o=e.key,a=null!==(t=e.value)&&void 0!==t?t:o,l=a.toString();s.dataset.id=l;const c=s.children,d=c[0].children,u=d[r.idContainerIndex];u.children[r.idIndex].textContent=l;const h=r.unmappedIdIndex;if(void 0!==i?this.registerEventHandlers(s,r):d[r.visibleIndex].style.display="none",-1!==h){const e=u.children[h];if(Ds.equal(o,a)){e.style.display="none";d[r.copyContainerIndex].children[r.unmappedCopyIndex].style.display="none"}else{const t=o.toString();s.dataset.unmappedId=t,e.textContent=t,void 0!==i&&wy(i.segmentationGroupState.value.maxIdLength,t)}}return c[r.labelIndex].textContent=null!==(n=e.label)&&void 0!==n?n:"",void 0!==i&&(this.updateWithId(s,a),wy(i.segmentationGroupState.value.maxIdLength,l)),s}update(e){const t=Oy,n=e.dataset.id;void 0!==n&&(t.parseString(n),this.updateWithId(e,t))}updateWithId(e,t){const n=e.children[0].children,i=this.template,r=this.displayState,s=r.segmentSelectionState,o=r.segmentationGroupState.value.visibleSegments;n[i.visibleIndex].checked=o.has(t),e.dataset.selected=(s.hasSelectedSegment&&Ds.equal(s.selectedSegment,t)).toString();const a=n[i.idContainerIndex];Iy(a.children[i.idIndex],By(this.displayState,t));const l=i.unmappedIdIndex;if(-1!==l){let t,n;if(r.baseSegmentColoring.value&&void 0!==(t=e.dataset.unmappedId)){const e=Oy;e.parseString(t),n=By(this.displayState,e)}else n=Ai;Iy(a.children[l],n)}}}function Iy(e,t){e.style.backgroundColor=av(t),e.style.color=tr(t)?"white":"black"}class Dy extends Ly{constructor(e,t,n){var i;const r=e.segmentationGroupState.value.segmentPropertyMap.value,s=(null!==(i=r?.numericalProperties)&&void 0!==i?i:[]).filter(n);super(e,Ty(s.length)),this.parentElement=t,this.segmentPropertyMap=r,this.numericalProperties=s,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var t,n,i;const r=super.getWithNormalizedId(e),s=this.numericalProperties,o=this.template.numericalPropertyIndices;if(o.length>0){const a=null!==(i=null===(t=this.segmentPropertyMap)||void 0===t?void 0:t.getSegmentInlineIndex(null!==(n=e.value)&&void 0!==n?n:e.key))&&void 0!==i?i:-1;if(-1!==a){const e=this.numericalPropertyWidths;for(let t=0,n=o.length;t<n;++t){const n=s[t].values[a];if(!isNaN(n)){const i=n.toString(),s=i.length;s>e[t]&&(e[t]=s,this.parentElement.style.setProperty(`--neuroglancer-column-${t}-width`,`${s}ch`)),r.children[o[t]].textContent=i}}}}return r}makeHeaderLabel(e,t,n){const i=document.createElement("span");i.textContent=e,i.classList.add("neuroglancer-segment-list-header-label"),i.classList.add("neuroglancer-segment-list-header-label"),"label"===e&&(n.style.textAlign="left");const r=document.createElement("span");r.classList.add("neuroglancer-segment-list-header-label-sort"),i.appendChild(r),r.textContent="\u25b2";const s=function(e){const t=e.cloneNode(!0);return t.style.position="absolute",document.body.appendChild(t),t.getBoundingClientRect()}(i).width;return this.parentElement.style.setProperty(t,`${s}px`),n.appendChild(i),{id:e,label:i,sortIcon:r}}getHeader(){const e=this.template,t=e.template.cloneNode(!0),n=t.children,i=n[0].children;i[e.copyContainerIndex].style.visibility="hidden",i[e.visibleIndex].style.visibility="hidden",n[e.filterIndex].style.visibility="hidden";const r=i[e.idContainerIndex],s=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",r.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",n[e.labelIndex])],o=this.numericalProperties,a=this.template.numericalPropertyIndices;for(let l=0,c=a.length;l<c;++l){const e=o[l],n=this.makeHeaderLabel(e.id,`--neuroglancer-column-${l}-label-width`,t.children[a[l]]),i=e.description;i&&(n.label.title=i),s.push(n)}return{container:t,propertyLabels:s}}}function My(e,t){return Ly.make(e??void 0,!0).getWithNormalizedId(t)}function Py(e,t,n){t.registerDisposer(Bn(((e,t)=>{!function(e,t,n){e.registerDisposer(t.visibleSegments.changed.add(n)),e.registerDisposer(t.segmentEquivalences.changed.add(n))}(e,t,n)}),e.segmentationGroupState)),t.registerDisposer(Bn(((e,t)=>{e.registerDisposer(t.segmentColorHash.changed.add(n)),e.registerDisposer(t.segmentDefaultColor.changed.add(n))}),e.segmentationColorGroupState)),t.registerDisposer(e.saturation.changed.add(n)),t.registerDisposer(e.segmentSelectionState.changed.add(n)),t.registerDisposer(e.baseSegmentColoring.changed.add(n))}function Ay(e,t){const n=t.redrawNeeded.dispatch;Py(e,t,n),t.registerDisposer(Bn(((e,t)=>{!function(e,t,n){e.registerDisposer(t.temporaryVisibleSegments.changed.add(n)),e.registerDisposer(t.temporarySegmentEquivalences.changed.add(n)),e.registerDisposer(t.useTemporaryVisibleSegments.changed.add(n)),e.registerDisposer(t.useTemporarySegmentEquivalences.changed.add(n))}(e,t,n)}),e.segmentationGroupState))}function Ry(e,t){Ay(e,t),t.registerDisposer(e.objectAlpha.changed.add(t.redrawNeeded.dispatch))}function Ny(e,t){Ry(e,t),t.registerDisposer(e.transform.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.renderScaleTarget.changed.add(t.redrawNeeded.dispatch)),t.registerDisposer(e.transparentPickEnabled.changed.add(t.redrawNeeded.dispatch))}const Vy=vi(),Oy=new Ds;function By(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Vy;if(null==e)return n.fill(1),n;const i=e.segmentationColorGroupState.value;if(0!==i.segmentStatedColors.size&&i.segmentStatedColors.get(t,Oy))return n[0]=(255&Oy.low)/255,n[1]=((65280&Oy.low)>>>8)/255,n[2]=((16711680&Oy.low)>>>16)/255,n;const r=i.segmentDefaultColor.value;return void 0!==r?(n[0]=r[0],n[1]=r[1],n[2]=r[2],n):(i.segmentColorHash.compute(n,t),n)}function _y(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const i=Vy;i[3]=n,By(e,t,i);let r=e.saturation.value;e.segmentSelectionState.isSelected(t)&&(r>.5?r=r-=.5:r+=.5);for(let s=0;s<3;++s)i[s]=i[s]*r+(1-r);return i[0]*=n,i[1]*=n,i[2]*=n,i}function Fy(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(const n of fp)t[n]=e[n].rpcId;return t}const zy=Ed(dp);class Uy extends zy{constructor(e,t,n){super(n),this.chunkManager=e,this.displayState=t}initializeCounterpartWithChunkManager(e){let t=this.displayState;e.chunkManager=this.chunkManager.rpcId,Fy(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(Cd.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(Cd.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function Gy(e,t,n,i,r){const s=Math.min(1,e.objectAlpha.value),o=e.baseSegmentColoring.value;yp(e.segmentationGroupState.value,((a,l)=>{let c=i?.registerUint64(t,a),d=n?_y(e,o?a:l,s):void 0;r(a,d,c,l)}))}const Wy=Object.freeze(Object.defineProperty({__proto__:null,SegmentSelectionState:vy,SegmentWidgetFactory:Ly,SegmentWidgetWithExtraColumnsFactory:Dy,SegmentationLayerSharedObject:Uy,Uint64MapEntry:my,augmentSegmentId:Sy,bindSegmentListWidth:xy,forEachVisibleSegmentToDraw:Gy,getBaseObjectColor:By,getObjectColor:_y,makeSegmentWidget:My,maybeAugmentSegmentId:by,registerCallbackWhenSegmentationDisplayStateChanged:Py,registerRedrawWhenSegmentationDisplayState3DChanged:Ny,registerRedrawWhenSegmentationDisplayStateChanged:Ay,registerRedrawWhenSegmentationDisplayStateWithAlphaChanged:Ry,resetTemporaryVisibleSegmentsState:yy,segmentWidgetTemplateWithExtraColumns:Ty,sendVisibleSegmentsState:Fy,updateIdStringWidth:wy},Symbol.toStringTag,{value:"Module"}));var $y=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};const jy=qn(),Hy=jn();function Jy(e,t){t.vertexBuffer=nu.fromData(e,t.meshData.vertexPositions,e.ARRAY_BUFFER,e.STATIC_DRAW),t.indexBuffer=nu.fromData(e,t.meshData.indices,e.ELEMENT_ARRAY_BUFFER,e.STATIC_DRAW),t.normalBuffer=nu.fromData(e,t.meshData.vertexNormals,e.ARRAY_BUFFER,e.STATIC_DRAW)}function qy(e){e.vertexBuffer.dispose(),e.indexBuffer.dispose(),e.normalBuffer.dispose()}function Yy(e){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(t,n,i){i.vertexBuffer.bindToVertexAttrib(n.attribute("aVertexPosition"),3,e,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}const Zy={[fm.float32]:Yy(WebGL2RenderingContext.FLOAT),[fm.uint16]:Yy(WebGL2RenderingContext.UNSIGNED_SHORT),[fm.uint10]:{defineShader:e=>{e.addAttribute("highp uint","aVertexPosition"),e.addVertexCode("\nhighp vec3 getVertexPosition() {\n  return vec3(float(aVertexPosition & 1023u),\n              float((aVertexPosition >> 10) & 1023u),\n              float((aVertexPosition >> 20) & 1023u)) / 1023.0;\n}\n")},bind(e,t,n){n.vertexBuffer.bindToVertexAttribI(t.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}};class Xy{constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=Zy[this.vertexPositionFormat]}beginLayer(e,t,n,i){let r=n.lightDirection,s=n.ambientLighting,o=n.directionalLighting,a=this.tempLightVec;di(a,r,o),a[3]=s,e.uniform4fv(t.uniform("uLightDirection"),a);const l=i.silhouetteRendering.value;l>0&&e.uniform1f(t.uniform("uSilhouettePower"),l)}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginModel(e,t,n,i){const r=n.projectionParameters;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,Qn(jy,r.viewProjectionMat,i)),Bi(Hy,i),Gi(Hy,Hy,r.displayDimensionRenderInfo.canonicalVoxelFactors),function(e,t){var n=t[0],i=t[1],r=t[2],s=t[3],o=t[4],a=t[5],l=t[6],c=t[7],d=t[8],u=d*o-a*c,h=-d*s+a*l,p=c*s-o*l,f=n*u+i*h+r*p;f&&(f=1/f,e[0]=u*f,e[1]=(-d*i+r*c)*f,e[2]=(a*i-r*o)*f,e[3]=h*f,e[4]=(d*n-r*l)*f,e[5]=(-a*n+r*s)*f,e[6]=p*f,e[7]=(-c*n+i*l)*f,e[8]=(o*n-i*s)*f)}(Hy,Hy),function(e,t){if(e===t){var n=t[1],i=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=i,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(Hy,Hy),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,Hy)}drawFragmentHelper(e,t,n,i,r){this.vertexPositionHandler.bind(e,t,n);const s=n.meshData;n.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),n.indexBuffer.bind();const o=s.indices;e.drawElements(s.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,r-i,2===o.BYTES_PER_ELEMENT?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,i*o.BYTES_PER_ELEMENT)}drawFragment(e,t,n){const i=n.meshData.indices;this.drawFragmentHelper(e,t,n,0,i.length)}drawMultiscaleFragment(e,t,n,i,r){const s=n.meshData.subChunkOffsets[i],o=n.meshData.subChunkOffsets[r];this.drawFragmentHelper(e,t,n,s,o)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){const t=e.registerDisposer(Rn((e=>e>0),[e.displayState.silhouetteRendering]));return eu(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(e,t)=>{this.vertexPositionHandler.defineShader(e),e.addAttribute("highp vec2","aVertexNormal"),e.addVarying("highp vec4","vColor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat3","uNormalMatrix"),e.addUniform("highp mat4","uModelViewProjection"),e.addUniform("highp uint","uPickID"),t&&e.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(e.addUniform("highp vec3","uFragmentOrigin"),e.addUniform("highp vec3","uFragmentShape")),e.addVertexCode("\nhighp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {\n  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\n  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);\n  return normalize(v);\n}\n");let n="";this.fragmentRelativeVertices?n+="\nhighp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();\nhighp vec3 normalMultiplier = 1.0 / uFragmentShape;\n":n+="\nhighp vec3 vertexPosition = getVertexPosition();\nhighp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);\n",n+="\ngl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);\nvec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);\nvec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));\nfloat absCosAngle = abs(dot(normal, uLightDirection.xyz));\nfloat lightingFactor = absCosAngle + uLightDirection.w;\nvColor = vec4(lightingFactor * uColor.rgb, uColor.a);\n",t&&(n+="\nvColor *= pow(1.0 - absCosAngle, uSilhouettePower);\n"),e.setVertexMain(n),e.setFragmentMain("emit(vColor, uPickID);")}})}}class Ky extends ym{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new Xy(!1,fm.float32),this.getShader=this.meshShaderManager.makeGetter(this),Ny(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new Uy(e,n,this.layerChunkProgressInfo));i.RPC_TYPE_ID="mesh/MeshLayer",i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=this.gl,i=this.displayState,r=this.meshShaderManager;if(i.objectAlpha.value<=0)return;const s=Ad(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===s)return;const o=this.getShader(e.emitter).shader;if(null===o)return;o.bind(),r.beginLayer(n,o,e,this.displayState),r.beginModel(n,o,e,s);const a=this.source.chunks;let l=0,c=0;const d=this.displayState.renderScaleHistogram,u=this.source.fragmentSource.chunks;Gy(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,((t,i,s)=>{const d=gp(t),h=a.get(d);if(++l,void 0!==h){++c,e.emitColor&&r.setColor(n,o,i),e.emitPickID&&r.setPickID(n,o,s),l+=h.fragmentIds.length;for(const e of h.fragmentIds){const t=this.source.getFragmentKey(d,e).key,i=u.get(t);void 0!==i&&i.state===el.GPU_MEMORY&&(r.drawFragment(n,o,i),++c)}}})),e.emitColor&&(d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),d.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,l-c)),r.endLayer(n,o)}isReady(){const e=this.displayState,t=this.source;let n=!0;const i=t.fragmentSource.chunks;return yp(e.segmentationGroupState.value,(e=>{const r=gp(e),s=t.chunks.get(r);if(void 0!==s)for(const t of s.fragmentIds){const e=this.source.getFragmentKey(r,t).key,s=i.get(e);if(void 0===s||s.state!==el.GPU_MEMORY)return void(n=!1)}else n=!1})),n}}class Qy extends np{constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class eb extends np{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),Jy(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),qy(this)}}class tb extends lp{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new nb(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new Qy(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}let nb=class extends lp{constructor(e,t){super(e),this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new eb(this,e)}};function ib(e,t,n,i){const r=e.get(vm(t,n,i));return void 0!==r&&r.state===el.GPU_MEMORY}nb=$y([yd("mesh/FragmentSource")],nb);class rb extends ym{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new Xy(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),Ny(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));let i=this.backend=this.registerDisposer(new Uy(e,n,this.layerChunkProgressInfo));i.RPC_TYPE_ID="mesh/MultiscaleMeshLayer",i.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),i.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const e=this.displayState;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=this.gl,i=this.displayState,r=this.meshShaderManager;if(i.objectAlpha.value<=0)return;const s=Ad(i.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===s)return;const o=this.getShader(e.emitter).shader;if(null===o)return;o.bind(),r.beginLayer(n,o,e,this.displayState);const a=this.displayState.renderScaleHistogram;e.emitColor&&a.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),Bi(Hy,s),Gi(Hy,Hy,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);const l=Math.pow(Math.abs(Hn(Hy)),1/3),c=this.source.chunks,d=this.source.fragmentSource.chunks,u=e.projectionParameters,h=Qn(qn(),u.viewProjectionMat,s),p=_i(new Float32Array(24),h),f=this.displayState.renderScaleTarget.value,g=this.source.format.fragmentRelativeVertices;r.beginModel(n,o,e,s);let m=0,v=0;Gy(i,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,((t,i,s)=>{const y=gp(t),b=c.get(y);if(++m,void 0===b)return;++v;const S=b.manifest,w=S.octree,x=S.chunkShape,C=S.chunkGridSpatialOrigin,k=S.vertexOffsets;e.emitColor&&r.setColor(n,o,i),e.emitPickID&&r.setPickID(n,o,s),mm(S,h,p,f,u.width,u.height,((t,n,i)=>{const r=ib(d,y,t,n);return e.emitColor&&a.add(S.lodScales[t]*l,i,r?1:0,r?0:1),r}),((e,t,i,s)=>{const a=vm(y,e,t),l=d.get(a),c=w[5*t],u=w[5*t+1],h=w[5*t+2],p=1<<e;g&&(n.uniform3f(o.uniform("uFragmentOrigin"),C[0]+c*x[0]*p+k[3*e+0],C[1]+u*x[1]*p+k[3*e+1],C[2]+h*x[2]*p+k[3*e+2]),n.uniform3f(o.uniform("uFragmentShape"),x[0]*p,x[1]*p,x[2]*p)),r.drawMultiscaleFragment(n,o,l,i,s)}))})),a.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,v,m-v),r.endLayer(n,o)}isReady(e,t){let n=this.displayState;if(n.objectAlpha.value<=0)return!0;const i=Ad(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(void 0===i)return!1;const r=this.source.chunks,s=this.source.fragmentSource.chunks,o=e.projectionParameters,a=Qn(qn(),o.viewProjectionMat,i),l=_i(new Float32Array(24),a),c=this.displayState.renderScaleTarget.value;let d=!0;return yp(n.segmentationGroupState.value,(e=>{if(!d)return;const t=gp(e),n=r.get(t);if(void 0===n)return void(d=!1);mm(n.manifest,a,l,c,o.width,o.height,((e,n)=>(d=d&&ib(s,t,e,n),d)),(()=>{}))})),d}getObjectPosition(e){const t=this.displayState.transform.value;if(void 0!==t.error)return;const n=this.source.chunks.get(gp(e));if(void 0===n)return;const i=n.manifest,r=i.clipLowerBound,s=i.clipUpperBound,o=t.rank,a=new Float32Array(o);for(let c=0;c<3;++c)a[c]=(r[c]+s[c])/2;const l=new Float32Array(o);return Io(l,t.modelToRenderLayerTransform,o+1,a,o),l}}class sb extends np{constructor(e,t){super(e),this.manifest=t.manifest}}class ob extends np{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),Jy(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),qy(this)}}class ab extends lp{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new lb(this.chunkManager,this)),this.format=t.format}static encodeOptions(e){return(0,i.bn)({format:e.format},super.encodeOptions(e))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new sb(this,e)}}let lb=class extends lp{constructor(e,t){super(e),this.meshSource=t}get key(){return this.meshSource.key}getChunk(e){return new ob(this,e)}};lb=$y([yd("mesh/MultiscaleFragmentSource")],lb);var cb=i.aV,db=bf(!1);cb(cb.S,"Object",{values:function(e){return db(e)}});var ub={default:i.aW.Object.values,__esModule:!0};const hb=(0,i.g)(ub),pb="\nvec2 getQuadVertexPosition(vec2 lower, vec2 upper) {\n  const vec2 coeffs[] = vec2[](\n    vec2(0.0, 0.0),\n    vec2(0.0, 1.0),\n    vec2(1.0, 1.0),\n    vec2(1.0, 1.0),\n    vec2(1.0, 0.0),\n    vec2(0.0, 0.0)\n  );\n  int v = gl_VertexID % 6;\n  return mix(lower, upper, coeffs[v]);\n}\n";function fb(e,t,n){e.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*t,n)}function gb(e,t){const n=new Float32Array((e+1)*(t+1)*3);let i=0;for(let r=0;r<=e;++r){const s=r*Math.PI/e,o=Math.sin(s),a=Math.cos(s);for(let e=0;e<=t;++e){const r=2*e*Math.PI/t,s=Math.sin(r),l=Math.cos(r);n[i++]=l*o,n[i++]=a,n[i++]=s*o}}return n}function mb(e,t){const n=new Uint16Array(e*t*6);let i=0;for(let r=0;r<e;r++)for(let e=0;e<t;e++){const s=r*(t+1)+e,o=s+t+1;n[i++]=s,n[i++]=o,n[i++]=s+1,n[i++]=o,n[i++]=o+1,n[i++]=s+1}return n}class vb extends Sn{constructor(e,t,n){super(),this.vertexBuffer=this.registerDisposer(iu(e,WebGL2RenderingContext.ARRAY_BUFFER,gb,t,n)).value,this.indexBuffer=this.registerDisposer(iu(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,mb,t,n)).value,this.numIndices=t*n*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode("\nvoid emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {\n  vec3 vertexPosition = aSphereVertex * radii + centerPosition;\n  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);\n  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);\n  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;\n}\n")}draw(e,t){const n=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(n,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(n)}}function yb(e,t){e.addVertexCode(pb),e.addUniform("highp vec3","uCircleParams"),e.addVarying("highp vec4","vCircleCoord"),e.addVertexCode("\nvoid emitCircle(vec4 position, float diameter, float borderWidth) {\n  gl_Position = position;\n  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);\n  if (diameter == 0.0) totalDiameter = 0.0;\n  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));\n  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;\n  vCircleCoord.xy = circleCornerOffset;\n  if (borderWidth == 0.0) {\n    vCircleCoord.z = totalDiameter;\n    vCircleCoord.w = 1e-6;\n  } else {\n    vCircleCoord.z = diameter / totalDiameter;\n    vCircleCoord.w = uCircleParams.z / totalDiameter;\n  }\n}\n"),t?e.addFragmentCode("\nfloat getCircleAlphaMultiplier() {\n  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);\n}\n"):e.addFragmentCode("\nfloat getCircleAlphaMultiplier() {\n  return 1.0;\n}\n"),e.addFragmentCode("\nvec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {\n  float radius = length(vCircleCoord.xy);\n  if (radius > 1.0) {\n    discard;\n  }\n\n  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);\n  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);\n  vec4 color = mix(interiorColor, borderColor, borderColorFraction);\n\n  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());\n}\n")}function bb(e,t,n){e.gl.uniform3f(e.uniform("uCircleParams"),1/t.width,1/t.height,Math.max(1e-6,n.featherWidthInPixels))}function Sb(e,t,n){fb(e,t,n)}class wb extends Sn{constructor(e){super(),this.lightDirection=new Float32Array([1,0,0,0]),this.sphereHelper=this.registerDisposer(new vb(e,20,20))}defineShader(e){e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVertexCode("\nfloat getRadiusAdjustment(vec3 vertex, float r) {\n  float radiusAdjustment = 1.0;\n  for (int i = 0; i < 3; ++i) {\n    if (r != 0.0) {\n      float d = vertex[i] - uModelClipBounds[i];\n      radiusAdjustment -= d * d / (r * r);\n    }\n  }\n\n  return sqrt(max(0.1, radiusAdjustment));\n}\n    "),this.sphereHelper.defineShader(e)}draw(e,t,n){const i=e.gl;i.uniformMatrix4fv(e.uniform("uNormalTransform"),!1,Xn(qn(),t.renderSubspaceInvModelMatrix)),i.uniform4f(e.uniform("uLightDirection"),this.lightDirection[0],this.lightDirection[1],this.lightDirection[2],this.lightDirection[3]),this.sphereHelper.draw(e,n)}}function xb(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.addVertexCode(pb),e.addUniform("highp vec3","uLineParams"),e.addVarying("highp float","vLineCoord"),e.addVarying("highp float","vLineFeatherFraction"),t&&(e.addVarying("highp float","vEndpointFraction"),e.addVarying("highp float","vLineCoordT"),e.addVarying("highp float","vLineBorderStartFraction")),e.addVertexCode("\nbool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {\n  highp float tmin = 0.0, tmax = 1.0;\n  highp float k1 = b.w - a.w + a.z - b.z;\n  highp float k2 = a.w - b.w + a.z - b.z;\n  highp float q1 = (a.z - a.w) / k1;\n  highp float q2 = (a.z + a.w) / k2;\n  if (k1 > 0.0) tmin = max(tmin, q1);\n  else if (k1 < 0.0) tmax = min(tmax, q1);\n  if (k2 > 0.0) tmax = min(tmax, q2);\n  else if (k2 < 0.0) tmin = max(tmin, q2);\n  if (tmin <= tmax) {\n    highp vec4 tempA = a;\n    highp vec4 tempB = b;\n    a = mix(tempA, tempB, tmin);\n    b = mix(tempA, tempB, tmax);\n    return true;\n  }\n  return false;\n}\n"),e.addVertexCode(`\nvec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }\nfloat getLineEndpointCoefficient() { return getLineOffset().x; }\nuint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }\nvoid emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels\n              ${t?", float borderWidth":""}) {\n  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {\n    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);\n    return;\n  }\n  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;\n  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;\n\n  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;\n  vec2 lineDirection;\n  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);\n\n  if (linePixelLength < 1e-3) {\n    lineDirection = vec2(1.0, 0.0);\n    vertexADevice.z = vertexBDevice.z = 0.0;\n  } else {\n    lineDirection = normalize(lineDirectionUnnormalized);\n  }\n  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);\n\n  vec2 lineOffset = getLineOffset();\n  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);\n  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${t?" + 2.0 * borderWidth":""};\n  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;\n  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;\n  gl_Position.xy += (lineOffset.y * lineNormal\n                     ${t?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})\n                  * totalLineWidth * uLineParams.xy;\n  vLineCoord = lineOffset.y;\n  ${t?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}\n  ${t?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}\n}\nvoid emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels\n              ${t?", float borderWidth":""}) {\n  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),\n           lineWidthInPixels\n           ${t?", borderWidth":""});\n}\n`),t&&e.addFragmentCode("\nvec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {\n  float radius;\n  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {\n    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,\n                         vLineCoord));\n    if (radius > 1.0) {\n      discard;\n    }\n  } else {\n    radius = abs(vLineCoord);\n  }\n  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);\n  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);\n  vec4 color = mix(interiorColor, borderColor, borderColorFraction);\n  return vec4(color.rgb, color.a * feather);\n}\n"),e.addFragmentCode("\nfloat getLineAlpha() {\n  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);\n}\n")}function Cb(e,t,n){fb(e,t,n)}function kb(e,t,n){e.gl.uniform3f(e.uniform("uLineParams"),1/t.width,1/t.height,n)}function Tb(e){e.addAttribute("int","aDummyVertexId",0),e.addVertexCode("\nint getVertexId () {\n  return aDummyVertexId + gl_VertexID;\n}\n#define gl_VertexID (getVertexId())\n")}class Eb extends Sn{constructor(e){super(),this.buffer=new nu(e),this.size=0}disposed(){this.buffer.dispose()}enable(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:256;const t=this.buffer,n=t.gl;t.bind(),e>this.size&&(this.size=e,n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),n.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),n.vertexAttribDivisor(0,0),n.enableVertexAttribArray(0)}disable(){this.buffer.gl.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",(()=>new Eb(e)))}}const Lb=qn(),Ib="void main() {\n  emitDefault();\n}\n",Db=[],Mb=jm(new Rm,sr.FLOAT32,3);let Pb=class extends Sn{constructor(e,t){super(),this.base=e,this.targetIsSliceView=t,this.textureAccessHelper=new Xm("vertexData"),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl)),this.edgeShaderGetter=eu(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),xb(e),e.addAttribute("highp uvec2","aVertexIndex"),e.addUniform("highp float","uLineWidth");let n="\nhighp vec3 vertexA = readAttribute0(aVertexIndex.x);\nhighp vec3 vertexB = readAttribute0(aVertexIndex.y);\nemitLine(uProjection, vertexA, vertexB, uLineWidth);\nhighp uint lineEndpointIndex = getLineEndpointIndex();\nhighp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);\n";e.addFragmentCode(`\nvec4 segmentColor() {\n  return uColor;\n}\nvoid emitRGB(vec3 color) {\n  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);\n}\nvoid emitDefault() {\n  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);\n}\n`),e.addFragmentCode(Hh);const i=this.vertexAttributes,r=i.length;for(let s=1;s<r;++s){const t=i[s];e.addVarying(`highp ${t.glslDataType}`,`vCustom${s}`),n+=`vCustom${s} = readAttribute${s}(vertexIndex);\n`,e.addFragmentCode(`#define ${t.name} vCustom${s}\n`)}e.setVertexMain(n),dh(t,e),e.setFragmentMainFunction(tu(t.parseResult.code))}}),this.nodeShaderGetter=eu(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(e,t)=>{if(0!==t.parseResult.errors.length)throw new Error("Invalid UI control specification");this.defineCommonShader(e),this.defineAttributeAccess(e),yb(e,this.targetIsSliceView),e.addUniform("highp float","uNodeDiameter");let n="\nhighp uint vertexIndex = uint(gl_InstanceID);\nhighp vec3 vertexPosition = readAttribute0(vertexIndex);\nemitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);\n";e.addFragmentCode("\nvec4 segmentColor() {\n  return uColor;\n}\nvoid emitRGBA(vec4 color) {\n  vec4 borderColor = color;\n  emit(getCircleColor(color, borderColor), uPickID);\n}\nvoid emitRGB(vec3 color) {\n  emitRGBA(vec4(color, 1.0));\n}\nvoid emitDefault() {\n  emitRGBA(uColor);\n}\n"),e.addFragmentCode(Hh);const i=this.vertexAttributes,r=i.length;for(let s=1;s<r;++s){const t=i[s];e.addVarying(`highp ${t.glslDataType}`,`vCustom${s}`),n+=`vCustom${s} = readAttribute${s}(vertexIndex);\n`,e.addFragmentCode(`#define ${t.name} vCustom${s}\n`)}e.setVertexMain(n),dh(t,e),e.setFragmentMainFunction(tu(t.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){Tb(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){const t=this.textureAccessHelper;t.defineShader(e);const n=this.vertexAttributes.length;for(let r=Db.length;r<n;++r)Db[r]=(0,i.bu)(`SkeletonShader.vertexAttributeTextureUnit${r}`);this.vertexAttributes.forEach(((n,i)=>{e.addTextureSampler(`${$m(n.dataType)}sampler2D`,`uVertexAttributeSampler${i}`,Db[i]),e.addVertexCode(t.getAccessor(`readAttribute${i}`,`uVertexAttributeSampler${i}`,n.dataType,n.numComponents))}))}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,n,i){const r=n.projectionParameters.viewProjectionMat;let s=Qn(Lb,r,i);e.uniformMatrix4fv(t.uniform("uProjection"),!1,s),this.vertexIdHelper.enable()}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}drawSkeleton(e,t,n,i,r){const s=this.vertexAttributes.length,o=i.vertexAttributeTextures;for(let a=0;a<s;++a){const n=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Db[a]);e.activeTexture(n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o[a])}{t.bind();const n=t.attribute("aVertexIndex");i.indexBuffer.bindToVertexAttribI(n,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(n,1),kb(t,r,this.targetIsSliceView?1:0),Cb(e,1,i.numIndices/2),e.vertexAttribDivisor(n,0),e.disableVertexAttribArray(n)}null!==n&&(n.bind(),bb(n,r,{featherWidthInPixels:this.targetIsSliceView?1:0}),Sb(n.gl,2,i.numVertices))}endLayer(e,t){const n=this.vertexAttributes.length;for(let i=0;i<n;++i){let n=t.textureUnit(Db[i])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(n),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}};var Ab;!function(e){e[e.LINES=0]="LINES",e[e.LINES_AND_POINTS=1]="LINES_AND_POINTS"}(Ab||(Ab={}));class Rb extends Og{constructor(e){super(Ab,e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:e)}}class Nb extends Ln{constructor(e){super(e,Lr,arguments.length>1&&void 0!==arguments[1]?arguments[1]:e)}}class Vb{constructor(){this.compound=new Rg,this.shader=Kd(Ib),this.shaderControlState=new vh(this.shader),this.params2d={mode:new Rb(Ab.LINES_AND_POINTS),lineWidth:new Nb(2)},this.params3d={mode:new Rb(Ab.LINES),lineWidth:new Nb(1)};const e=this.compound;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){void 0!==e&&this.compound.restoreState(e)}toJSON(){const e=this.compound.toJSON();for(const t of hb(e))if(void 0!==t)return e}}class Ob extends Sn{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.layerChunkProgressInfo=new ol,this.redrawNeeded=new kn,this.fallbackShaderParameters=new En(mh(lh(Ib))),Ny(n,this),this.displayState.shaderError.value=void 0;const i=n.skeletonRenderingOptions;this.registerDisposer(i.shader.changed.add((()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()})));let r=this.sharedObject=this.registerDisposer(new Uy(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID="skeleton/SkeletonLayer",r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});const s=this.vertexAttributes=[zb];for(let a of t.vertexAttributes){var o=O(a,2);let e=o[0],t=o[1];s.push({name:e,dataType:t.dataType,numComponents:t.numComponents,webglDataType:Fb(t.dataType),glslDataType:t.numComponents>1?`vec${t.numComponents}`:"float"})}}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,n,i,r){let s=i.lineWidth.value;const o=this.gl,a=this.source,l=this.displayState;if(l.objectAlpha.value<=0)return;const c=Ad(l.transform.value,e.projectionParameters.displayDimensionRenderInfo,r);if(void 0===c)return;let d;d=i.mode.value===Ab.LINES_AND_POINTS?Math.max(5,2*s):s;const u=n.edgeShaderGetter(e.emitter),h=n.nodeShaderGetter(e.emitter),p=u.shader,f=u.parameters,g=h.shader,m=h.parameters;if(null===p||null===g)return;const v=this.displayState.skeletonRenderingOptions.shaderControlState;p.bind(),n.beginLayer(o,p,e,c),bh(o,p,v,f.parseResult.controls),o.uniform1f(p.uniform("uLineWidth"),s),g.bind(),n.beginLayer(o,g,e,c),o.uniform1f(g.uniform("uNodeDiameter"),d),bh(o,g,v,m.parseResult.controls);const y=a.chunks;Gy(l,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,((t,i,r)=>{const s=gp(t),a=y.get(s);void 0===a||a.state!==el.GPU_MEMORY||(void 0!==i&&(p.bind(),n.setColor(o,p,i),g.bind(),n.setColor(o,g,i)),void 0!==r&&(p.bind(),n.setPickID(o,p,r),g.bind(),n.setPickID(o,g,r)),n.drawSkeleton(o,p,g,a,e.projectionParameters))})),n.endLayer(o,p)}isReady(){const e=this.source,t=this.displayState;if(t.objectAlpha.value<=0)return!0;const n=e.chunks;let i=!0;return yp(t.segmentationGroupState.value,(e=>{const t=gp(e),r=n.get(t);void 0!==r&&r.state===el.GPU_MEMORY||(i=!1)})),i}}class Bb extends ym{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new Pb(this.base,!1)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class _b extends kp{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new Pb(this.base,!0)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);const t=this.renderOptions;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}function Fb(e){if(e===sr.FLOAT32)return WebGL2RenderingContext.FLOAT;throw new Error(`Data type not supported by WebGL: ${sr[e]}`)}const zb={dataType:sr.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class Ub extends np{constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;let n=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=n.length}copyToGPU(e){super.copyToGPU(e);const t=this.source.attributeTextureFormats,n=this.vertexAttributes,i=this.vertexAttributeOffsets,r=this.vertexAttributeTextures=[];for(let s=0,o=i.length;s<o;++s){const a=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,a),Hm(e,t[s],n.subarray(i[s],s+1!==o?i[s+1]:n.length)),r[s]=a}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=nu.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);const t=this.vertexAttributeTextures;for(const n of t)e.deleteTexture(n);t.length=0,this.indexBuffer.dispose()}}const Gb=new pt;class Wb extends lp{constructor(e,t){super(e,t)}get attributeTextureFormats(){let e=this.attributeTextureFormats_;return void 0===e&&(e=this.attributeTextureFormats_=function(e){const t=[Mb];for(const n of e.values())t.push(jm(new Rm,n.dataType,n.numComponents));return t}(this.vertexAttributes)),e}getChunk(e){return new Ub(this,e)}get vertexAttributes(){return Gb}}function $b(e,t,n,i){const r=t.dataType;t.defineShader(e,n);let s="",o="";if(0===n)s+="highp int ignoredChannelIndex";else for(let l=0;l<n;++l)0!==l&&(s+=", "),s+=`highp int channelIndex${l}`,o+=`, channelIndex${l}`;e.addFragmentCode("\nfloat mixLinear(float x, float y, float a) { return mix(x, y, a); }\n");let a=`\n${Bu(r)} getDataValue(${s}) {\n  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${i}), uChunkDataSize - 1.0)));\n  return getDataValueAt(p${o});\n}\n${Bu(r)} getInterpolatedDataValue(${s}) {\n  highp vec3 positionWithinChunk = ${i};\n  highp ivec3[2] points;\n  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));\n  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));\n  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);\n  ${Bu(r)} xvalues[2];\n  for (int ix = 0; ix < 2; ++ix) {\n    ${Bu(r)} yvalues[2];\n    for (int iy = 0; iy < 2; ++iy) {\n      ${Bu(r)} zvalues[2];\n      for (int iz = 0; iz < 2; ++iz) {\n        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)\n                                     ${o});\n      }\n      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);\n    }\n    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);\n  }\n  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);\n}\n`;e.addFragmentCode(a),n<=1&&e.addFragmentCode(`\n${Bu(r)} getDataValue() { return getDataValue(0); }\n${Bu(r)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }\n`)}var jb=new Array;function Hb(e){jb.push(e)}class Jb extends Pp{constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(function(e,t){for(let n of jb){let i=n(e,t);if(null!=i)return i}throw new Error("No chunk format handler found.")}(e.chunkQueueManager.gl,this.spec));const n=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(n),this.tempPositionWithinChunk=new Uint32Array(n)}static encodeSpec(e){const t=e;return(0,i.bn)((0,i.bn)({},super.encodeSpec(e)),{dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&It(t.compressedSegmentationBlockSize),baseVoxelOffset:It(t.baseVoxelOffset)})}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){const n=this.spec.rank,i=this.tempChunkGridPosition,r=this.tempPositionWithinChunk;{const t=this.spec.chunkDataSize;for(let s=0;s<n;++s){const n=e[s],o=t[s],a=Math.floor(n/o);i[s]=a,r[s]=Math.floor(n-o*a)}}const s=this.chunks.get(i.join());if(void 0===s)return null;const o=s.chunkDataSize;for(let p=0;p<3;++p)if(r[p]>=o[p])return;if(0===t.channelSpaceShape.length)return s.getValueAt(r);const a=t.numChannels,l=t.chunkChannelCoordinates,c=t.chunkChannelDimensionIndices,d=c.length;let u=0;const h=new Array(a);for(let p=0;p<a;++p){for(let e=0;e<d;++e)r[c[e]]=l[u++];h[p]=s.getValueAt(r)}return h}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class qb extends Ap{constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}get chunkFormat(){return this.source.chunkFormat}}let Yb=class extends Np{};const Zb="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0icGx1c0ljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9InBsdXNJY29uVGl0bGUiPlBsdXM8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0yMCAxMkw0IDEyTTEyIDRMMTIgMjAiLz4KPC9zdmc+";function Xb(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({svg:Zb},e))}const Kb=new En(0);window.addEventListener("keydown",(e=>{Kb.value=fv(e)})),window.addEventListener("keyup",(e=>{Kb.value=fv(e)}));const Qb=new Rt(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),eS=new Rt(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class tS extends Sn{constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var n=t.target;let i=n.tagName;if(n===this.target)return!1;var r="TEXTAREA"===i||"INPUT"===i||"BUTTON"===i||"SELECT"===i,s=!r&&(n.isContentEditable||n.ownerDocument&&"on"===n.ownerDocument.designMode);return!(!r&&!s||this.allShortcutsAreGlobal||Qb.has(e))&&(!!(s||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey))||("INPUT"===i&&eS.has(n.type)?"enter"!==e:"INPUT"!==i&&"BUTTON"!==i||!this.allowSpaceKeyOnButtons&&"space"===e))}handleKeyDown(e){const t=function(e){return e.code.toLowerCase()}(e);this.shouldIgnoreEvent(t,e)||xv(t,e,e,this.eventMap)}}function nS(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.value;e.style.minWidth=t.length+1+"ch"}const iS="neuroglancer-coordinate-space-transform-singleton";function rS(e,t){let n,i;return n=e===Number.NEGATIVE_INFINITY?"(-\u221e,":`[${Math.floor(e)},`,i=t===Number.POSITIVE_INFINITY?"+\u221e)":`${Math.floor(t)})`,{lower:n,upper:i}}const sS=yv.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function oS(){const e=document.createElement("div"),t=document.createElement("input");e.classList.add("neuroglancer-coordinate-space-transform-scale-container"),t.spellcheck=!1,t.autocomplete="off",t.size=1,t.classList.add("neuroglancer-coordinate-space-transform-scale"),e.appendChild(t);const n=document.createElement("div"),i=document.createElement("span");i.innerHTML="data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYXJyb3dVcEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImFycm93VXBJY29uVGl0bGUiPkFycm93IFVwPC90aXRsZT4gICAgCiAgICA8cGF0aCBkPSJNMTggOWwtNi02LTYgNiIvPgogICAgPHBhdGggZD0iTTEyIDIxVjQiLz4KICAgIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTEyIDN2MSIvPgo8L3N2Zz4=",n.appendChild(i);const r=document.createTextNode("");return n.appendChild(r),n.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),e.appendChild(n),{cellElement:e,inputElement:t,suggestionElement:n}}function aS(e,t,n,i,r){if(void 0===t||t.scale===n&&t.unit===i)e.style.display="none";else{e.style.display="";const n=Fo(t.scale,t.unit,{elide1:!1});e.lastChild.textContent=n,e.title=`${r}${n}`}}function lS(){const e=document.createElement("input");return e.spellcheck=!1,e.autocomplete="off",e.size=1,e.placeholder=" ",e.classList.add("neuroglancer-coordinate-space-transform-output-name"),e}function cS(e,t,n){const i=e.map((e=>zo(e.value)));if(i.includes(void 0))return!1;const r=Float64Array.from(i,(e=>e.scale)),s=It(i,(e=>e.unit)),o=n.value,a=o.scales,l=o.units,c=o.rank;for(let h=0;h<c;++h)t[h]||(r[h]=a[h],s[h]=l[h]);if(Ut(a,r)&&Ut(l,s))return!1;const d=o.timestamps.map(((e,t)=>r[t]===a[t]&&s[t]===l[t]?e:Date.now())),u=ia({valid:o.valid,rank:o.rank,scales:r,units:s,timestamps:d,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return n.value=u,!0}function dS(e,t,n,r){const s=new Float64Array(e.scales),o=It(e.units);if(s[t]===n&&o[t]===r)return e;const a=It(e.timestamps);return s[t]=n,o[t]=r,a[t]=Date.now(),(0,i.bn)((0,i.bn)({},e),{scales:s,units:o,timestamps:a})}class uS extends Sn{constructor(e,t,n){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=n,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=Jv({svg:Zb,text:"S"}),this.addOutputDimensionIcon=Jv({svg:Zb,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=lS(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=Jv({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{const e=this.transform,t=e.value.rank;e.transform=xo(Float64Array,t+1)}}),this.resetToDefaultButton=Jv({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{const e=this.transform;if(e.mutableSourceRank)return;const t=e.defaultTransform;let n=t.outputSpace;const r=n.ids.map((()=>Zo()));e.value=(0,i.bn)((0,i.bn)({},t),{outputSpace:(0,i.bn)((0,i.bn)({},n),{ids:r})})}});const r=this.element;this.registerDisposer(new tS(r,sS)).allShortcutsAreGlobal=!0,r.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new ly(r,sS));const s=al((()=>this.updateView()));this.registerDisposer(e.changed.add(s));const o=this.coefficientContainer,a=this.translationContainer,l=this.outputNameContainer,c=this.inputNameContainer,d=this.inputScaleContainer,u=this.inputLowerBoundsContainer,h=this.inputUpperBoundsContainer,p=this.outputScaleContainer,f=this.addOutputDimensionCell,g=this.addOutputDimensionIcon,m=this.addSourceDimensionIcon,v=this.resetToIdentityButton,y=this.resetToDefaultButton;o.style.display="contents",a.style.display="contents",l.style.display="contents",c.style.display="contents",d.style.display="contents",p.style.display="contents",u.style.display="contents",h.style.display="contents";const b=document.createElement("div");b.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),v.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),y.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),b.appendChild(v),b.appendChild(y),r.appendChild(b);for(const i of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){var S=O(i,2);const e=S[0],t=S[1],n=document.createElement("div");n.classList.add(`neuroglancer-coordinate-space-transform-${e}-label`),n.classList.add("neuroglancer-coordinate-space-transform-label"),n.textContent=t,r.appendChild(n)}e.mutableSourceRank&&f.appendChild(m),f.appendChild(g),f.classList.add("neuroglancer-coordinate-space-transform-output-extend");const w="Embed in additional output dimension",x="Extend to additional source dimension";g.title=w,m.title=x,f.appendChild(this.addOutputDimensionInput),f.dataset.isActive="false",g.addEventListener("click",(()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=w,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()})),m.addEventListener("click",(()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=x,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()})),this.addOutputDimensionInput.addEventListener("blur",(()=>{this.updateAddOutputDimensionCellStyle()})),r.appendChild(o),r.appendChild(l),r.appendChild(c),r.appendChild(d),r.appendChild(p),r.appendChild(u),r.appendChild(h),o.appendChild(a),r.addEventListener("input",(e=>{const t=e.target;if(t instanceof HTMLInputElement){nS(t);let e=this.inputScaleElements.indexOf(t);if(-1!==e)return this.inputScaleModified[e]=!0,void this.updateScaleValidity(t);if(e=this.outputScaleElements.indexOf(t),-1!==e)return this.outputScaleModified[e]=!0,void this.updateScaleValidity(t);if(e=this.outputNameElements.indexOf(t),-1!==e)return void this.updateOutputNameValidity();if(this.coefficientContainer.contains(t))return void this.updateCoefficientValidity(t)}}));const C=(e,t,n)=>{Cv(r,e,(e=>{e.stopPropagation();const i=e.target;if(!(i instanceof HTMLInputElement)||0!==n&&(i.selectionStart!==i.selectionEnd||i.selectionStart!==(1===n?i.value.length:0)))return;const r=this.getElementGridPosition(i);if(void 0===r)return;const s=this.getElementByGridPosition(r.row+t,r.col+n);null!==s&&(s.focus(),e.preventDefault())}))};C("move-up",-1,0),C("move-down",1,0),C("move-left",0,-1),C("move-right",0,1);const k=(e,t)=>{e.addEventListener("focusout",(n=>{const i=n.relatedTarget;i instanceof Node&&e.contains(i)||t(n)}))};k(o,(()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()})),k(l,(()=>{this.updateModelOutputNames()||this.updateViewOutputNames()})),k(d,(()=>{this.updateModelInputScales()||this.updateViewInputScales()})),k(p,(()=>{this.updateModelOutputScales()||this.updateViewOutputScales()})),Cv(r,"cancel",(e=>{this.curTransform=void 0,this.updateView(),e.target.blur()})),Cv(o,"commit",(()=>{this.updateModelTransform()})),Cv(l,"commit",(()=>{this.updateModelOutputNames()})),Cv(d,"commit",(()=>{this.updateModelInputScales()})),Cv(p,"commit",(()=>{this.updateModelOutputScales()})),r.addEventListener("focusin",(e=>{const t=e.target;t instanceof HTMLInputElement&&t.select()})),this.updateView()}updateWillBeDeletedAttributes(e){const t=this.transform.value.rank;void 0===e&&(e=new Array(t)).fill(!1);const n=this.coefficientElements,i=this.inputBoundsElements,r=this.inputScaleElements;for(let o=0;o<t;++o){const a=e[o];for(let i=0;i<=t;++i){const r=n[t*i+o],s=i<t&&e[i];r.dataset.willBeDeleted=(a||s).toString()}r[o].dataset.willBeDeleted=a.toString();var s=i[o];const l=s.lower,c=s.upper;l.dataset.willBeDeleted=a.toString(),c.dataset.willBeDeleted=a.toString()}}updateAddOutputDimensionCellStyle(){const e=this.addOutputDimensionInput;this.addOutputDimensionCell.dataset.isActive=(0!==e.value.length||document.activeElement===e).toString()}updateOutputNameValidity(){const e=this.outputNameElements,t=e.map((e=>e.value));var n=this.transform,i=n.value;const r=i.sourceRank,s=i.rank,o=n.mutableSourceRank;if(e.length!==s+1)return;const a=wa(t);let l=new Array(s);l.fill(!1);for(let c=0;c<=s;++c){let n=a[c];0===t[c].length&&(o||c>=r)&&(n=!0,l[c]=!0),e[c].dataset.isValid=n.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){const t=void 0!==zo(e.value);e.dataset.isValid=t.toString()}updateCoefficientValidity(e){const t=Sr(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{const t=this.outputNameElements.indexOf(e);if(-1!==t)return{row:t,col:-2}}{const t=this.inputScaleElements.indexOf(e);if(-1!==t)return{row:-1,col:t}}{const t=this.coefficientElements.indexOf(e),n=this.transform.value.rank;if(-1!==t)return{row:t%n,col:Math.floor(t/n)}}{const t=this.outputScaleElements.indexOf(e);if(-1!==t)return{row:t,col:-1}}}getElementByGridPosition(e,t){const n=this.transform.value.rank;return-1===e?t<0||t>=n?null:this.inputScaleElements[t]:-2===t?e<0||e>n?null:this.outputNameElements[e]:-1===t?e<0||e>=n?null:this.outputScaleElements[e]:e<0||e>=n||t<0||t>n?null:this.coefficientElements[t*n+e]}dimensionRefCount(e){return(xa(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return cS(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return cS(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){const e=this.outputNameElements.map((e=>e.value));var t=this.transform;const n=t.value,r=t.mutableSourceRank,s=n.outputSpace,o=n.rank,a=n.sourceRank;if(e.length!==o+1)return;const l=[],c=[],d=0!==e[o].length;let u=a;for(let i=0;i<=o;++i){const t=e[i];if(0!==t.length)c.push(t),l.push(i);else if(i<a){if(!r)return!1;--u}}if(!Sa(c))return!1;const h=s.names;if(!d&&Ut(h,c))return!0;let p=n.inputSpace,f=n.outputSpace,g=n.transform;if(d){this.addingSourceDimension&&++u;const t=e[o],n=(xa(t)?this.localCombiner:this.globalCombiner).combined.value,i=n.names.indexOf(t);let r,a;-1!==i?(r=n.units[i],a=n.scales[i]):(r="",a=1);const l=p.boundingBoxes.map((e=>ga(e,o,o+1)));this.addingSourceDimension||l.push(fa(o+1,o)),p=ia({valid:p.valid,rank:o+1,names:[...p.names,""],ids:[...p.ids,Zo()],timestamps:[...p.timestamps,Date.now()],scales:Float64Array.from([...p.scales,a]),units:[...p.units,r],boundingBoxes:l,coordinateArrays:[...p.coordinateArrays,void 0]}),f=ia({valid:s.valid,rank:o+1,names:[...s.names,t],ids:[...s.ids,Zo()],timestamps:[...s.timestamps,Date.now()],scales:Float64Array.from([...s.scales,a]),units:[...s.units,r],coordinateArrays:[...s.coordinateArrays,void 0]}),g=To(new Float64Array((o+2)**2),o+1,g,o)}g=Aa(Float64Array,g,p.rank,l,l),p=Oa(p,l),f=Oa(f,l);const m=f.ids.map(((e,t)=>{const n=l[t];if(n===o)return e;const i=c[t],r=h[n];return i===r||1===this.dimensionRefCount(r)&&this.dimensionRefCount(i)===(h.includes(i)?1:0)?e:Zo()})),v=f.timestamps.map(((e,t)=>{const n=l[t];return n===o||c[t]===h[n]?e:Date.now()}));f=(0,i.bn)((0,i.bn)({},f),{names:c,ids:m,timestamps:v});let y={rank:f.rank,sourceRank:u,outputSpace:f,inputSpace:p,transform:g};return this.transform.value=y,!0}updateModelTransform(){const e=this.coefficientElements,t=this.transform.value.rank,n=new Float64Array((t+1)**2);n[n.length-1]=1;for(let i=0;i<t;++i)for(let r=0;r<=t;++r){const s=e[r*t+i],o=parseFloat(s.value);if(!Sr(o))return!1;n[r*(t+1)+i]=o}return this.transform.transform=n,!0}updateViewOutputNames(){var e=this.transform.value;const t=e.outputSpace,n=e.rank;if(n!==this.curRank)return;const i=this.outputNameElements,r=t.names;for(let s=0;s<n;++s){const e=i[s];e.value=r[s],e.dataset.isValid="true",nS(e)}i[n].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){var e=this.transform.value;const t=e.transform,n=e.rank,i=this.coefficientElements;for(let r=0;r<n;++r)for(let e=0;e<=n;++e){const s=i[e*n+r];s.value=t[e*(n+1)+r].toString(),s.dataset.isValid="true",nS(s)}}ensureViewRankUpdated(){const e=this.transform.value,t=e.rank,n=e.sourceRank;if(this.curSourceRank===n&&this.curRank===t)return;const i=this.inputBoundsElements,r=this.inputNameElements,s=this.inputScaleElements,o=this.element,a=this.coefficientElements,l=this.outputNameElements,c=this.outputScaleElements,d=this.outputScaleSuggestionElements,u=this.inputScaleSuggestionElements,h=this.outputBoundsElements,p=this.coefficientContainer,f=this.translationContainer,g=this.outputNameContainer,m=this.inputNameContainer,v=this.inputScaleContainer,y=this.inputLowerBoundsContainer,b=this.inputUpperBoundsContainer,S=this.outputScaleContainer;o.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,o.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Rv(p),Rv(f),p.appendChild(f),Rv(g),Rv(m),Rv(v),Rv(y),Rv(b),Rv(S),r.length=0,s.length=0,i.length=0,c.length=0,d.length=0,u.length=0,a.length=0,l.length=0,h.length=0;for(let C=0;C<t;++C){const e=e=>{e.classList.add("neuroglancer-coordinate-space-transform-input"),C>=n&&e.classList.add(iS)};{const t=document.createElement("div");t.classList.add("neuroglancer-coordinate-space-transform-input-name"),e(t),t.style.gridRowStart="sourceNames",t.style.gridColumnStart=`sourceDim ${C+1}`,m.appendChild(t),r.push(t)}{var w=oS();const t=w.cellElement,n=w.inputElement,i=w.suggestionElement;t.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),e(t),t.style.gridRowStart="sourceScales",t.style.gridColumnStart=`sourceDim ${C+1}`,v.appendChild(t),s.push(n),u.push(i);const r=C;i.addEventListener("click",(()=>{const e=Fa(this.transform,r);void 0!==e&&(this.transform.inputSpace.value=dS(this.transform.inputSpace.value,r,e.scale,e.unit))}))}{const t=document.createElement("div");e(t),t.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),t.style.gridRowStart="sourceLower",t.style.gridColumnStart=`sourceDim ${C+1}`,y.appendChild(t);const n=document.createElement("div");e(n),n.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),n.style.gridRowStart="sourceUpper",n.style.gridColumnStart=`sourceDim ${C+1}`,b.appendChild(n),i.push({lower:t,upper:n})}}for(let C=0;C<t;++C){for(let e=0;e<=t;++e){const i=document.createElement("input");i.classList.add("neuroglancer-coordinate-space-transform-coeff"),i.spellcheck=!1,i.autocomplete="off",i.size=1,i.style.gridRowStart=`outputDim ${C+1}`,i.placeholder=" ",i.style.gridColumnStart=`sourceDim ${e+1}`,a[e*t+C]=i,e===t?i.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):e==n&&i.classList.add(iS),(e===t?f:p).appendChild(i)}{var x=oS();const e=x.cellElement,t=x.suggestionElement,n=x.inputElement;e.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),e.style.gridRowStart=`outputDim ${C+1}`,e.style.gridColumnStart="outputScales";const i=C;t.addEventListener("click",(()=>{const e=this.transform.value,t=_a(e,i);void 0!==t&&(this.transform.outputSpace.value=dS(e.outputSpace,i,t.scale,t.unit))})),d.push(t),S.appendChild(e),c.push(n)}{const e=document.createElement("div");e.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),e.style.gridRowStart=`outputDim ${C+1}`,e.style.gridColumnStart="outputNames";const t=lS();t.title="Rebind to a different dimension",C>=n?t.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(t.title+=", or delete to remove source dimension"),t.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",l.push(t),g.appendChild(e),e.appendChild(t);const i=document.createElement("div");i.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),e.appendChild(i);const r=document.createElement("div");r.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),e.appendChild(r),h.push({lower:i,upper:r}),e.addEventListener("mousedown",(e=>{e.target!==t&&(t.focus(),e.preventDefault())}))}}l.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",g.appendChild(this.addOutputDimensionCell),this.curSourceRank=n,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;var e=this.transform.value;const t=e.inputSpace,n=e.rank,i=e.sourceRank,r=this.inputBoundsElements,s=this.inputNameElements,o=this.inputScaleElements,a=this.inputScaleSuggestionElements,l=t.names,c=t.scales,d=t.units;var u=t.bounds;const h=u.lowerBounds,p=u.upperBounds;for(let g=0;g<n;++g){const e=o[g],t=c[g],n=d[g];let u;if(e.value=Fo(t,n,{elide1:!1}),e.dataset.isValid="true",nS(e),g<i){let t=l[g];t||(t=`${g}`),s[g].textContent=t,u=`source dimension ${t}`,e.title=`Override scale of ${u}`}else u="singleton dimension",e.title=`Set extent of ${u}`;var f=rS(h[g],p[g]);const m=f.lower,v=f.upper,y=r[g];y.lower.textContent=m,y.lower.title=`Lower bound of ${u}`,y.upper.title=`Upper bound of ${u}`,y.upper.textContent=v,aS(a[g],Fa(this.transform,g),t,n,`Revert scale of ${u} to `)}}updateViewOutputScales(){const e=this.transform.value;var t=e.outputSpace;const n=t.rank,i=t.names,r=t.units,s=t.scales;var o=t.bounds;const a=o.lowerBounds,l=o.upperBounds,c=this.outputScaleElements,d=this.outputBoundsElements,u=this.outputScaleSuggestionElements;for(let p=0;p<n;++p){const t=c[p],n=s[p],o=r[p];t.value=Fo(n,o,{elide1:!1}),nS(t);const f=i[p];t.dataset.isValid="true";const g=`Change coordinates of ${xa(f)?"local":"global"} dimension ${f}`;t.title=`${g} (does not rescale the source)`;var h=rS(a[p],l[p]);const m=h.lower,v=h.upper,y=d[p];y.lower.textContent=m,y.upper.textContent=v,aS(u[p],_a(e,p),n,o,`${g} to inferred scale of `)}}updateResetButtonVisibility(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];var n=this.transform;const i=n.value,r=n.mutableSourceRank,s=n.defaultTransform,o=i.rank;this.resetToIdentityButton.style.visibility=e||!function(e,t,n){for(let i=0;i<n;++i)for(let r=0;r<n;++r)if(e[i*t+r]!=(i===r?1:0))return!1;return!0}(i.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=r||!e&&!t&&function(e,t){const n=e.rank,i=e.sourceRank;if(n!==t.rank||i!==t.sourceRank)return!1;const r=e.inputSpace,s=t.inputSpace;return!!(Ut(s.scales,r.scales)&&Ut(s.units,r.units)&&Ut(t.outputSpace.names,e.outputSpace.names))&&Ea(e.transform,n,e.outputSpace.scales,t.transform,n,t.outputSpace.scales)}(s,i)?"hidden":"visible"}updateView(){const e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){Nv(this.element),super.disposed()}}const hS=.5;class pS{constructor(){this.anchorIndex=0,this.anchorClientOffset=0}splice(e){let t=this.anchorIndex,n=0;for(const i of e){if(n+=i.retainCount,t<n)break;const e=i.deleteCount;if(t<n+e){t=n;break}const r=i.insertCount;t=t-e+r,n+=r-r}this.anchorIndex=t}}class fS{constructor(){this.startIndex=0,this.endIndex=0,this.anchorIndex=0,this.anchorOffset=0,this.scrollOffset=0}}class gS{constructor(){this.itemSize=[],this.totalKnownSize=0,this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){var t;return null!==(t=this.itemSize[e])&&void 0!==t?t:this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(;t<e;++t)n+=this.getEstimatedSize(t);for(;t>e;--t)n-=this.getEstimatedSize(t-1);return n}getRangeSize(e,t){var n;let i=0;const r=this.itemSize,s=this.averageSize;for(let o=e;o<t;++o)i+=null!==(n=r[o])&&void 0!==n?n:s;return i}splice(e){let t=this.itemSize;t=this.itemSize=function(e,t){const n=[];let i=0;for(let s=0,o=t.length;s<o;++s){var r=t[s];const o=r.retainCount,a=r.deleteCount,l=r.insertCount;0!==o&&(n.push(e.slice(i,i+o)),i+=o),i+=a,0!==l&&n.push(new Array(l))}return i!==e.length&&n.push(e.slice(i)),new Array(0).concat(...n)}(t,e),this.totalKnownSize=t.reduce(((e,t)=>e+t),0),this.numItemsInTotalKnownSize=t.reduce((e=>e+1),0)}}function mS(e,t,n,i,r,s){let o,a,l,c,d,u=s.anchorIndex,h=s.anchorClientOffset,p=r.getEstimatedOffset(u);if(0===i||0===r.totalKnownSize)o=Math.max(0,u-5),a=Math.min(n,o+10),d=u,l=0,c=h;else{const e=r.getEstimatedTotalSize(),s=Math.max(0,e-i);c=p-h,c=Math.max(0,Math.min(s,c));const f=c-1*i,g=c-hS*i,m=c+i+hS*i,v=p-h+i+1*i;o=Math.min(n,t.startIndex);let y=r.getEstimatedOffset(o,u,p);if(y<f)for(;o+1<n;++o){const e=r.getEstimatedSize(o);if(y+e>=g)break;y+=e}if(y>=g)for(;y>f&&o>0;--o){y-=r.getEstimatedSize(o-1)}a=Math.min(n,t.endIndex);let b=r.getEstimatedOffset(a,u,p);if(b<m)for(;b<=v&&a+1<=n;++a){b+=r.getEstimatedSize(a)}else if(b>=v)for(;a>o;--a){const e=r.getEstimatedSize(a-1);if(b-e<m)break;b-=e}for(d=u,l=p;d<o;++d){l+=r.getEstimatedSize(d)}for(;d>a;--d){l-=r.getEstimatedSize(d-1)}}e.startIndex=o,e.endIndex=a,e.anchorIndex=d,e.anchorOffset=l,e.scrollOffset=c}function vS(e,t){return e.startIndex<t.startIndex||e.endIndex>t.endIndex}class yS extends Sn{constructor(e){super(),this.element=document.createElement("div"),this.scrollContent=document.createElement("div"),this.header=document.createElement("div"),this.body=document.createElement("div"),this.topItems=document.createElement("div"),this.bottomItems=document.createElement("div"),this.renderedItems=[],this.renderGeneration=-1,this.listGeneration=-1,this.newRenderedItems=[],this.state=new pS,this.renderParams=new fS,this.newRenderParams=new fS,this.sizes=new gS,this.debouncedUpdateView=this.registerCancellable(al((()=>this.updateView()))),this.resizeObserver=new ResizeObserver((()=>this.updateView()));const t=e.selectedIndex;void 0!==t&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);const n=this.source=e.source;this.sizes.itemSize.length=n.length;const i=this.element,r=this.header,s=this.body,o=this.scrollContent,a=this.topItems,l=this.bottomItems;this.resizeObserver.observe(i),this.registerDisposer((()=>this.resizeObserver.disconnect())),i.appendChild(o),i.style.overflowAnchor="none",o.appendChild(r),o.appendChild(s),r.style.position="sticky",r.style.zIndex="1",r.style.top="0",e.horizontalScroll?(o.style.width="min-content",o.style.minWidth="100%",r.style.width="min-content",r.style.minWidth="100%",l.style.width="min-content",l.style.minWidth="100%"):(o.style.width="100%",r.style.width="100%",l.style.width="100%"),s.appendChild(a),s.appendChild(l),a.style.width="min-content",a.style.position="relative",a.style.height="0",a.style.minWidth="100%",l.style.height="0",l.style.position="relative",i.addEventListener("scroll",(()=>{const e=i.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-e,this.renderParams.scrollOffset=e,this.debouncedUpdateView()})),void 0!==n.changed&&this.registerDisposer(n.changed.add((e=>{this.sizes.splice(e),this.state.splice(e),this.renderedItems.length=0,this.debouncedUpdateView()}))),void 0!==n.renderChanged&&this.registerDisposer(n.renderChanged.add(this.debouncedUpdateView))}updateView(){const e=this.element;if(0===e.offsetHeight)return;const t=e.clientHeight-this.header.offsetHeight,n=this.source,i=this.state,r=this.sizes,s=n.length,o=this.body,a=this.topItems,l=this.bottomItems,c=n.changed,d=n.renderChanged;let u;for(;;){u=this.newRenderParams;const g=this.renderParams;let m;if(mS(u,g,s,t,r,i),void 0!==d&&d.count!==this.renderGeneration||void 0!==c&&c.count!==this.listGeneration?(this.renderGeneration=void 0===d?-1:d.count,this.listGeneration=void 0===c?-1:c.count,m=!0,this.renderedItems.length=0):m=!1,!m&&!vS(u,g)){g.scrollOffset=u.scrollOffset,u=g;break}this.renderParams=u,this.newRenderParams=g;const v=this.renderedItems,y=this.newRenderedItems;y.length=0,this.renderedItems=y,this.newRenderedItems=v;const b=this.source,S=b.render;var h=u;const w=h.startIndex,x=h.endIndex,C=h.anchorIndex;function*k(e,t){for(let n=e;n<t;++n){let e=v[n];void 0===e&&(e=S.call(b,n)),y[n]=e,yield e}}Ov(a,k(w,C)),Ov(l,k(C,x));for(let T=w;T<x;++T){const E=y[T].getBoundingClientRect().height,L=r.itemSize[T];void 0!==L&&(r.totalKnownSize-=L,--r.numItemsInTotalKnownSize),r.itemSize[T]=E,r.totalKnownSize+=E,++r.numItemsInTotalKnownSize}}(function(e,t){const n=t.getEstimatedOffset(e.anchorIndex),i=e.anchorOffset;e.anchorOffset=n,e.scrollOffset+=n-i})(u,r),i.anchorIndex=u.anchorIndex,i.anchorClientOffset=u.anchorOffset-u.scrollOffset;const p=r.getRangeSize(u.startIndex,u.anchorIndex),f=r.getEstimatedTotalSize();o.style.height=`${f}px`,a.style.top=u.anchorOffset-p+"px",l.style.top=`${u.anchorOffset}px`,e.scrollTop=u.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){var t=this.renderParams;const n=t.startIndex,i=t.endIndex,r=this.renderedItems;for(let s=n;s<i;++s){const t=r[s];void 0!==t&&e(t,s)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){const t=this.sizes.getEstimatedOffset(e),n=t+this.sizes.getEstimatedSize(e),i=this.element.scrollTop;if(t<i)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else{if(!(t>i&&n>i+this.element.offsetHeight))return;this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight}this.debouncedUpdateView()}disposed(){Nv(this.element)}}const bS="neuroglancer-multiline-autocomplete-completion-active";function SS(e){let t=document.createElement("div");return t.textContent=e.value,t}function*wS(e){for(;e.length>0;){const t=e.match(/[:/_]+/);if(null===t)return void(yield e);const n=t.index+t[0].length;yield e.substring(0,n),e=e.substring(n)}}function xS(e){let t=document.createElement("div");t.className="neuroglancer-multiline-autocomplete-completion-with-description",t.textContent=e.value;let n=document.createElement("div");return n.className="neuroglancer-multiline-autocomplete-completion-description",n.textContent=e.description||"",t.appendChild(n),t}const CS=yv.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}});class kS extends Sn{constructor(e){super(),this.element=document.createElement("div"),this.inputElement=document.createElement("span"),this.hintElement=document.createElement("span"),this.completionsVirtualList=void 0,this.onCommit=new Cn,this.onInput=new Cn,this.prevInputValue="",this.completionsVisible=!1,this.activeCompletionPromise=null,this.activeCompletionCancellationToken=void 0,this.hasFocus=!1,this.completionResult=null,this.dropdownContentsStale=!0,this.hasResultForDropdown=!1,this.commonPrefix="",this.completionDisabled=-1,this.activeIndex=-1,this.dropdownStyleStale=!0,this.resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()},this.resizeObserver=new ResizeObserver(this.resizeHandler),this.debouncedUpdateHintState=this.registerCancellable(mn((()=>this.updateHintState()),0)),this.completer=e.completer;var t=e.delay;const n=void 0===t?200:t;let i=this.scheduleUpdateCompletions=mn((()=>{const e=this.activeCompletionCancellationToken=new rd;let t=this.activeCompletionPromise=this.completer(this.value,e);null!==t&&t.then((e=>{this.activeCompletionPromise===t&&(this.setCompletions(e),this.activeCompletionPromise=null)}))}),n);this.registerDisposer((()=>{i.cancel()}));const r=this.element,s=this.inputElement,o=this.hintElement;r.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(r),this.registerDisposer((()=>this.resizeObserver.unobserve(s))),s.contentEditable="true",s.spellcheck=!1,r.appendChild(document.createTextNode("\u200b")),r.appendChild(s),r.appendChild(o),s.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),s.addEventListener("input",(()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()})),s.addEventListener("copy",(e=>{const t=e.clipboardData;if(null!==t){const e=window.getSelection();null!==e&&!e.isCollapsed&&e.containsNode(s,!0)&&t.setData("text/plain",e.toString())}e.preventDefault(),e.stopPropagation()})),this.registerEventListener(document,"selectionchange",(()=>{const e=this.getSelectionRange(),t=this.completionDisabled;void 0!==e&&e.begin===t&&e.end===t||(this.completionDisabled=-1,this.debouncedUpdateHintState())})),this.setValueAndSelection(""),this.updateHintState(),r.addEventListener("pointerdown",(e=>{const t=e.target;if(t instanceof Node){if(s.contains(t))return;const e=this.completionsVirtualList;if(void 0!==e&&e.element.contains(t))return}s===document.activeElement&&(this.moveCaretToEndOfInput(),e.stopPropagation(),e.preventDefault())})),r.addEventListener("click",(()=>{s.focus()})),this.registerEventListener(this.inputElement,"focus",(()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();const e=document.createRange(),t=s.childNodes;e.setStart(s,0),0===t.length?e.setEnd(s,0):e.setEndAfter(t[t.length-1]);const n=window.getSelection();null!==n&&(n.removeAllRanges(),n.addRange(e)),this.debouncedUpdateHintState()}})),this.registerEventListener(this.inputElement,"blur",(()=>{this.hasFocus&&(this.hasFocus=!1,this.updateDropdown()),this.debouncedUpdateHintState();const e=window.getSelection();null!==e&&e.containsNode(this.inputElement,!0)&&e.removeAllRanges(),this.onCommit.dispatch(this.value,!1)})),this.registerEventListener(window,"resize",(()=>{this.dropdownStyleStale=!0})),this.registerEventListener(window,"scroll",(()=>{this.dropdownStyleStale=!0}));this.registerDisposer(new tS(s,CS)).allShortcutsAreGlobal=!0,Cv(s,"cycle-next-active-completion",(()=>{this.cycleActiveCompletion(1)})),Cv(s,"cycle-prev-active-completion",(()=>{this.cycleActiveCompletion(-1)})),Cv(s,"home",(()=>{this.moveCaretToBeginningOfInput()})),Cv(s,"end",(()=>{this.moveCaretToEndOfInput()})),Cv(s,"choose-active-completion-or-prefix",(e=>{this.selectActiveCompletion(!0)&&e.preventDefault()})),Cv(s,"commit",(e=>{if(this.selectActiveCompletion(!1))e.stopPropagation();else{let e=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,e)}})),Cv(s,"cancel",(e=>{e.stopPropagation(),this.cancel()&&(e.detail.preventDefault(),e.detail.stopPropagation())}))}disableCompletion(){const e=this.getSelectionRange();this.completionDisabled=void 0!==e&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){const e=window.getSelection();if(null===e||0===e.rangeCount)return;const t=e.getRangeAt(0),n=this.inputElement,i=document.createRange();i.setStart(n,0),i.setEnd(t.startContainer,t.startOffset);const r=i.toString().length;return{begin:r,end:r+e.toString().length}}setValueAndSelection(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;const n=-1!==this.completionDisabled;this.onInput.dispatch(e);const i=this.inputElement;Rv(i);let r=0;const s=void 0!==t?document.createRange():void 0;let o=!0;for(const a of wS(e)){o||i.appendChild(document.createElement("wbr")),o=!1;const e=r+a.length,n=document.createTextNode(a);if(i.appendChild(n),void 0!==s){const i=t.begin,o=t.end;i>=r&&i<=e&&s.setStart(n,i-r),o>=r&&o<=e&&s.setEnd(n,o-r)}r=e}if(void 0!==s){o&&(s.setStart(i,0),s.setEnd(i,0));const e=window.getSelection();null!==e&&(e.removeAllRanges(),e.addRange(s))}this.completionDisabled=n&&void 0!==t&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){const e=this.inputElement;if(document.activeElement!==e)return!1;const t=this.getSelectionRange();return void 0!==t&&t.end===t.begin&&t.end!=this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),this.shouldAttemptCompletion()){const e=this.value;if(e===this.prevInputValue)return;this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions()}else this.hideCompletions()}handleDropdownClick(e){let t=this.completionsVirtualList;if(void 0===t)return;const n=t.element;for(let i=e.target;i instanceof HTMLElement&&i!==n;i=i.parentElement){const e=i.dataset.completionIndex;if(void 0!==e){this.selectCompletion(Number(e));break}}}cycleActiveCompletion(e){if(null===this.completionResult)return;let t=this.activeIndex,n=this.completionResult.completions.length;t=-1===t?e>0?0:n-1:(t+e+n)%n,this.setActiveIndex(t)}shouldShowDropdown(){return!(null===this.completionResult||!this.hasFocus)&&this.hasResultForDropdown}updateDropdownStyle(){const e=this.completionsVirtualList,t=this.element;void 0!==e&&function(e,t){let{horizontal:n=!1,vertical:i=!0,topMargin:r=6,bottomMargin:s=6,leftMargin:o=6,rightMargin:a=6,maxHeight:l=!0,maxWidth:c=!0}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const d=t.getBoundingClientRect();if(n){const t=e.ownerDocument.documentElement.clientWidth;let n=d.right,i=t-d.left;n>i?(e.style.left="",e.style.right=t-d.right+"px",c&&(e.style.maxWidth=n-o+"px")):(e.style.right="",e.style.left=`${d.left}px`,c&&(e.style.maxWidth=i-a+"px"))}if(i){const t=e.ownerDocument.documentElement.clientHeight;let n=d.top-r,i=t-d.bottom-s;e.style.left=`${d.left}px`,e.style.width=`${d.width}px`,n>3*i?(e.style.top="",e.style.bottom=t-d.top+"px",l&&(e.style.maxHeight=n+"px")):(e.style.top=`${d.bottom}px`,e.style.bottom="",l&&(e.style.maxHeight=i+"px"))}}(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let e=this.completionsVirtualList;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){void 0!==e&&e.dispose();const n=this.completionResult;var t=n.makeElement;const i=void 0===t?SS:t;e=this.completionsVirtualList=new yS({source:{length:n.completions.length,render:e=>{const t=n.completions[e],r=i.call(n,t);return r.classList.add("neuroglancer-multiline-autocomplete-completion"),r.dataset.completionIndex=`${e}`,this.activeIndex===e&&r.classList.add(bS),r}},selectedIndex:-1===this.activeIndex?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",(e=>{this.inputElement.focus(),e.preventDefault()})),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);const n=this.activeIndex;-1!==n&&this.completionsVirtualList.scrollItemIntoView(n)}else this.completionsVisible&&(void 0!==e&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();let t=e.completions;if(0===t.length)return;const n=this.prevInputValue;if(void 0!==n){if(this.completionResult=e,1===t.length){let i=t[0];e.showSingleResult?this.hasResultForDropdown=!0:i.value.startsWith(n)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;let t=function(e){let t=A(e);var n=t.next();let i=n.value;if(n.done)return"";let r=i.length;for(;r>0;){var s=t.next();let e=s.value;if(s.done)break;let n=0;for(;n<r&&i.charCodeAt(n)===e.charCodeAt(n);++n);r=n}return i.substring(0,r)}(function*(){for(let t of e.completions)yield t.value}()),i=this.getCompletedValue(t);i.startsWith(n)&&(this.commonPrefix=i,this.setHintValue(i))}this.updateDropdown()}}setHintValue(e){const t=this.prevInputValue;if(void 0===t)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);const n=this.hintElement;Rv(n);let i=!0;for(const r of wS(e)){i||n.appendChild(document.createElement("wbr")),i=!1;const e=document.createTextNode(r);n.appendChild(e)}}setActiveIndex(e){if(!this.dropdownContentsStale){let t=this.activeIndex;const n=this.completionsVirtualList;if(void 0!==n){if(-1!==t){const e=n.getItemElement(t);void 0!==e&&e.classList.remove(bS)}if(-1!==e){let t=n.getItemElement(e);void 0!==t&&t.classList.add(bS),n.scrollItemIntoView(e)}}}-1!==e&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){let t=this.completionResult,n=this.prevInputValue;return void 0===n?"":n.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){const e=document.createRange(),t=this.inputElement;e.setStart(t,0),e.setEnd(t,0);const n=window.getSelection();null!==n&&(n.removeAllRanges(),n.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){const e=document.createRange(),t=this.inputElement,n=t.childNodes,i=n[n.length-1];void 0===i?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(i),e.setEndAfter(i));const r=window.getSelection();null!==r&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let t=this.activeIndex;if(-1===t){if(!e)return!1;let n=this.completionResult;if(null===n||1!==n.completions.length){let e=this.commonPrefix;return e.length>this.value.length&&(this.value=e,this.moveCaretToEndOfInput(),!0)}t=0}let n=this.getCompletedValueByIndex(t);return this.value!==n&&(this.value=n,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;const e=this.activeCompletionCancellationToken;void 0!==e&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(null!==this.completionResult){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";const e=this.completionsVirtualList;void 0!==e&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){const e=this.completionsVirtualList;void 0!==e&&e.dispose(),Nv(this.element),this.cancelActiveCompletion(),super.disposed()}}class TS extends Sn{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new kd(kd.VISIBLE);super(),this.visibility=e,this.element=document.createElement("div"),this.element.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){Nv(this.element),super.disposed()}}class ES extends Sn{constructor(){super(...arguments),this.changed=new kn,this.options=new pt,this.optionsChanged=new kn,this.selectedValue=void 0,this.defaultValue=void 0,this.ready_=!0}get value(){const e=this.selectedValue;return void 0!==e?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){void 0!==e&&this.ready_&&!this.options.has(e)&&(e=void 0),this.selectedValue!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){const e=this.selectedValue;return void 0!==e&&this.options.has(e)?e:this.defaultValue}add(e,t){const n=this.options;if(n.has(e))throw new Error(`Option already defined: ${Bt(e)}.`);n.set(e,t),this.optionsChanged.dispatch(),void 0===this.defaultValue&&(this.default=e)}toJSON(){const e=this.value;if(e!==this.defaultValue)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){"string"!=typeof e&&(e=void 0),this.value=e}}class LS extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new kd(kd.VISIBLE),i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(),this.getter=e,this.selected=t,this.visibility=n,this.invalidateByDefault=i,this.element=document.createElement("div"),this.tabs=new pt,this.tabVisibilityChanged=new Cn,this.debouncedUpdateSelectedTab=this.registerCancellable(al((()=>this.updateSelectedTab())));this.element.className="neuroglancer-stack-view",this.registerDisposer(n.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){const t=this.tabs,n=t.get(e);void 0!==n&&(n.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){const t=this.tabs.get(e);void 0!==t&&(t.visibility.value=kd.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){const t=this.tabs;let n=t.get(e);void 0===n&&(n=this.getter(e),this.element.appendChild(n.element),t.set(e,n)),n.element.style.display="",n.visibility.value=kd.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){const e=this.displayedTab,t=this.visible?this.selected.value:void 0;t===e&&(void 0===t||this.tabs.has(t))||(void 0!==e&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,void 0!==t&&this.showTab(t))}invalidateAll(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;const t=this.tabs;for(const i of t){var n=O(i,2);const r=n[0],s=n[1];void 0!==e&&e(r)||(t.delete(r),s.dispose())}this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),Nv(this.element),super.disposed()}}class IS extends ES{}function DS(e,t){const n="neuroglancer-selected-tab-label";t?e.classList.add(n):e.classList.remove(n)}class MS extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new kd(kd.VISIBLE);super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new pt,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable(al((()=>this.updateTabs()))),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;const n=this.element,i=this.tabBar;n.className="neuroglancer-tab-view",i.className="neuroglancer-tab-view-bar",n.appendChild(i),this.registerDisposer(t.changed.add(this.debouncedUpdateView));const r=this.stack=this.registerDisposer(new LS(e.makeTab,e.selectedTab,this.visibility));n.appendChild(r.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView)),this.registerDisposer(e.selectedTab.changed.add((()=>this.updateTabLabelStyles()))),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){const e=this.selectedTab.value;for(const n of this.tabLabels){var t=O(n,2);const i=t[0];DS(t[1],i===e)}}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(-1!==this.tabsGeneration){if(this.tabLabels.clear(),this.visible){const e=this.tabs.value;this.stack.invalidateAll((t=>void 0!==e.find((e=>{let{id:n}=e;return n===t}))))}else this.stack.invalidateAll();Rv(this.tabBar),this.tabsGeneration=-1}}makeTabs(){const e=this.tabBar,t=this.tabLabels,n=this.handleTabElement;for(const i of this.tabs.value){const r=i.id,s=i.label,o=document.createElement("div");o.classList.add("neuroglancer-tab-label"),o.textContent=s,o.addEventListener("click",(()=>{this.selectedTab.value=r})),void 0!==n&&n(r,o),t.set(r,o),e.appendChild(o)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Rv(this.tabBar),this.tabLabels.clear(),Nv(this.element),super.disposed()}}class PS extends kS{constructor(e){const t=e.source.layer.manager;super({completer:(e,n)=>t.dataSourceProviderRegistry.completeUrl({url:e,chunkManager:t.chunkManager,cancellationToken:n}).then((e=>({completions:e.completions,makeElement:xS,offset:e.offset,showSingleResult:!0}))),delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new En(!1);const n=e=>{e!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};n(""),this.onInput.add(n)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class AS extends Sn{constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");const t=this.registerCancellable(al((()=>this.updateView())));this.registerDisposer(e.changed.add(t)),this.registerDisposer((()=>Nv(this.element))),this.updateView()}updateView(){const e=this.model,t=e.changed.count;if(t===this.generation)return;this.generation=t;const n=this.element;Rv(n);const i=new Rt;for(const r of e){const e=`${r.severity} ${r.message}`;if(i.has(e))continue;i.add(e);const t=document.createElement("li");n.appendChild(t),t.classList.add("neuroglancer-message"),t.classList.add(`neuroglancer-message-${Sl[r.severity]}`),t.textContent=r.message}}}class RS extends Sn{constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");const n=this.element;n.classList.add("neuroglancer-layer-data-source-subsource");const i=document.createElement("label"),r=document.createElement("span"),s=()=>{i.dataset.isActive=(void 0!==t.activated||!t.enabled).toString()};s(),this.registerDisposer(t.isActiveChanged.add(s)),this.registerDisposer(e.enabledSubsourcesChanged.add(s));const o=this.registerDisposer(new Od({get value(){return t.enabled},set value(n){t.enabled=n,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));i.classList.add("neuroglancer-layer-data-sources-info-line"),i.appendChild(o.element);const a=document.createElement("span");a.classList.add("neuroglancer-layer-data-sources-source-id");const l=t.subsourceEntry.id;"default"!==l&&(a.textContent=l),i.appendChild(a),r.classList.add("neuroglancer-layer-data-sources-source-type");const c=this.registerDisposer(new AS(this.loadedSubsource.messages));n.appendChild(i),i.appendChild(r),n.appendChild(c.element);let d="";const u=t.subsourceEntry.subsource,h=u.volume;if(h instanceof Yb)d=`${sr[h.dataType].toLowerCase()} volume`;else if(u.mesh instanceof tb)d="meshes (single-res.)";else if(u.mesh instanceof ab)d="meshes (multi-res.)";else if(u.mesh instanceof Wb)d="skeletons";else if(void 0!==u.segmentPropertyMap)d="segment property map";else if(void 0!==u.local)switch(u.local){case af.annotations:d="Local annotations";break;case af.equivalences:d="local segmentation graph"}else void 0!==u.staticAnnotations?d="default annotations":void 0!==u.annotation?d="annotations":void 0!==u.singleMesh?d="single mesh":void 0!==u.segmentationGraph&&(d="segmentation graph");r.textContent=d}}class NS extends Sn{constructor(e){super(),this.source=e,this.element=document.createElement("div");const t=this.element,n=document.createElement("label");n.classList.add("neuroglancer-layer-data-sources-source-default"),n.appendChild(this.registerDisposer(new Od({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(t){if(e.enableDefaultSubsources!==t){if(e.enableDefaultSubsources=t,t)for(const t of e.subsources)t.enabled=t.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),n.appendChild(document.createTextNode("Enable default subsource set")),n.title="Enable the default set of subsources for this data source.",t.appendChild(n);for(const r of e.subsources)t.appendChild(this.registerDisposer(new RS(e,r)).element);const i=e.transform;if(i.mutableSourceRank||0!==i.value.sourceRank){const t=this.registerDisposer(new uS(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(t.element)}this.registerDisposer((()=>Nv(this.element)))}}class VS extends Sn{constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;const n=this.urlInput=this.registerDisposer(new PS(this));n.onCommit.add(((t,r)=>{const s=this.source,o=s.spec,a=this.source.layer;if((t=a.manager.dataSourceProviderRegistry.normalizeUrl({url:t}))!==n.value&&(n.disableCompletion(),n.setValueAndSelection(t,{begin:t.length,end:t.length})),n.dirty.value=!1,t&&t===o.url)r&&void 0!==e.detectedLayerConstructor&&OS(s.layer);else{if(a instanceof qT)try{const e=a.manager.dataSourceProviderRegistry.suggestLayerName(t);WT(a.managedLayer,e)}catch{}s.spec=(0,i.bn)((0,i.bn)({},o),{url:t})}}));const r=this.element;r.classList.add("neuroglancer-layer-data-source"),r.appendChild(n.element),r.appendChild(this.registerDisposer(new AS(t.messages)).element),this.updateView()}updateView(){const e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;const t=this.source.loadState;let n=this.loadedView;if(void 0!==n){if(n.source===t)return;n.dispose(),n=this.loadedView=void 0}t instanceof eg&&(n=this.loadedView=new NS(t),this.element.appendChild(n.element))}disposed(){const e=this.loadedView;void 0!==e&&e.dispose(),Nv(this.element),super.disposed()}}function OS(e){if(e instanceof qT){const t=e.detectedLayerConstructor;if(void 0!==t)return GT(e.managedLayer,t),!0}return!1}class BS extends TS{constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new pt,this.addDataSourceIcon=Xb({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;const t=this.element,n=this.dataSourcesContainer;t.classList.add("neuroglancer-layer-data-sources-tab"),n.classList.add("neuroglancer-layer-data-sources-container");const i=this.addDataSourceIcon;if(i.style.alignSelf="start",i.addEventListener("click",(()=>{const e=this.layer.addDataSource(void 0);this.updateView();const t=this.sourceViews.get(e);void 0!==t&&t.urlInput.inputElement.focus()})),t.appendChild(this.dataSourcesContainer),e instanceof qT){const n=this.layerTypeDetection,i=this.layerTypeElement;n.style.display="none",i.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),n.appendChild(document.createTextNode("Create as ")),n.appendChild(i),n.appendChild(document.createTextNode(" layer")),t.appendChild(n),n.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),n.addEventListener("click",(()=>{OS(e)}))}const r=this.reRender=al((()=>this.updateView()));this.registerDisposer(e.dataSourcesChanged.add(r)),this.registerDisposer(this.visibility.changed.add(r)),this.updateView()}updateLayerTypeDetection(){const e=(()=>{const e=this.layer;if(!(e instanceof qT))return;const t=e.detectedLayerConstructor;if(void 0!==t){for(const e of this.sourceViews.values())if(e.urlInput.dirty.value)return;return t}})();if(e===this.detectedLayerConstructor)return;const t=this.layerTypeDetection;if(this.detectedLayerConstructor=e,void 0!==e){this.layerTypeElement.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){const e=this.sourceViews;for(const t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;const e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;const n=Date.now(),i=this.sourceViews,r=this.layer;function*s(){let e=!0;const t=r.dataSources;for(const r of t){let s=i.get(r);void 0===s&&(s=new VS(this,r),s.registerDisposer(s.urlInput.dirty.changed.add(this.reRender)),i.set(r,s)),s.seenGeneration=n,s.updateView();const o=r.spec.url;1===t.length&&""===o&&setTimeout((()=>{s.urlInput.inputElement.focus()}),0),e=0===r.spec.url.length,yield s.element}e||(yield this.addDataSourceIcon)}Ov(this.dataSourcesContainer,s.call(this));for(const o of i){var t=O(o,2);const a=t[0],l=t[1];l.seenGeneration!==n&&(l.dispose(),i.delete(a))}}this.updateLayerTypeDetection()}}const _S="tab",FS="tabs",zS="panels",US=(0,i.bn)((0,i.bn)({},$v),{row:0}),GS=(0,i.bn)((0,i.bn)({},$v),{visible:!0,row:0});class WS extends Sn{constructor(e){super(),this.panels=e,this.layer=this.panels.layer,this.location=new jv(GS),this.tabsChanged=new Cn,this.selectedTab=new En(void 0),this.tabs=[]}initialize(){const e=this.panels;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add((()=>{var t;e.specificationChanged.dispatch();const n=this.layer,i=n.manager.root.selectedLayer;if((null===(t=i.layer)||void 0===t?void 0:t.layer)!==n||this!==n.panels.panels[0])return;const r=this.location.value;i.location.value!==r&&(i.location.value=r,i.location.locationChanged.dispatch())})),this.location.locationChanged.add((()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)}))}normalizeTabs(){const e=this.tabs;if(0===e.length)return void(this.selectedTab.value=void 0);const t=this.layer.tabs.options,n=e=>{var n;return null!==(n=t.get(e).order)&&void 0!==n?n:0};e.sort(((e,t)=>n(e)-n(t)));const i=this.selectedTab,r=i.value;(void 0===r||!e.includes(r))&&(i.value=e[0])}pin(){var e;const t=this.layer,n=t.manager.root.selectedLayer;if((null===(e=n.layer)||void 0===e?void 0:e.layer)!==t||this!==t.panels.panels[0]||0===this.tabs.length)return;const i=this.panels,r=t.registerDisposer(new WS(i));i.panels.splice(0,1,r),i.panels.push(this),i.updateTabs(),r.initialize(),n.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var e;const t=this.panels,n=t.panels.indexOf(this);if(-1===n||0===n)return;const i=this.layer,r=i.manager.root.selectedLayer,s=null===(e=r.layer)||void 0===e?void 0:e.layer;r.visible&&null!=s&&s!=i&&s.panels.panels[0].pin(),t.panels.splice(n,1);var o=t.panels.splice(0,1,this);const a=O(o,1)[0];if(void 0===this.explicitTabs)i.unregisterDisposer(a);else{t.panels.push(a);for(let e=1,n=t.panels.length;e<n;++e){const n=t.panels[e];void 0===n.explicitTabs&&(n.explicitTabs=new Rt(n.tabs))}}this.explicitTabs=void 0,t.updateTabs(),r.layer=i.managedLayer,r.location.value=this.location.value,r.location.locationChanged.dispatch(),r.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;const n=this.panels;{const t=this.explicitTabs;void 0!==t&&t.delete(e)}const i=this.layer,r=i.registerDisposer(new WS(n));r.location.value=t,r.explicitTabs=new Rt([e]),n.panels.splice(1,0,r),n.updateTabs(),r.initialize(),i.manager.root.layerManager.layersChanged.dispatch(),n.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{const t=this.explicitTabs;void 0!==t&&t.delete(e)}{const n=t.explicitTabs;void 0!==n&&n.add(e)}const n=this.panels;n.updateTabs(),t.selectedTab.value=e,n.specificationChanged.dispatch()}mergeInto(e){const t=e.explicitTabs;if(void 0!==t)for(const n of this.tabs)t.add(n);this.panels.removePanel(this)}}class $S{constructor(e){this.layer=e,this.specificationChanged=new Cn,this.updating=!1,this.panels=[e.registerDisposer(new WS(this))]}restoreState(e){const t=this.panels;t[0].selectedTab.value=is(e,_S,es);const n=this.layer,i=n.tabs,r=new Rt(i.options.keys());is(e,zS,(e=>Jr(e,(e=>{Yr(e);const i=new WS(this);i.location.restoreState(e),i.location.visible&&(i.selectedTab.value=is(e,_S,es),i.explicitTabs=is(e,FS,(e=>{const t=new Rt;for(const n of ds(e))r.has(n)&&(r.delete(n),t.add(n));return t})),void 0===i.explicitTabs?(i.tabs=It(r),r.clear()):i.tabs=It(i.explicitTabs),0!==i.tabs.length&&(i.normalizeTabs(),n.registerDisposer(i),i.initialize(),t.push(i)))})))),t[0].tabs=It(r),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;const t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var e;const t=this.layer,n=t.tabs,i=new Rt(n.options.keys()),r=this.panels;this.updating=!0;const s=e=>{const t=e.tabs;if(void 0===e.explicitTabs)e.tabs=It(i),i.clear();else{e.tabs=It(e.explicitTabs);for(const t of e.tabs)i.delete(t)}Ut(t,e.tabs)||(e.normalizeTabs(),e.tabsChanged.dispatch())};for(let o=1;o<r.length;){const e=r[o];e.location.visible&&(s(e),0!==e.tabs.length)?++o:(r.splice(o,1),t.unregisterDisposer(e))}if(s(r[0]),0===r[0].tabs.length){const t=this.layer.manager.root.selectedLayer;(null===(e=t.layer)||void 0===e?void 0:e.layer)===this.layer&&(t.location.visible=!1)}this.updating=!1}toJSON(){var e;const t=this.panels,n={};if(n[_S]=t[0].selectedTab.value,t.length>1){const i=[];for(let n=1,r=t.length;n<r;++n){const r=t[n],s=null!==(e=r.location.toJSON())&&void 0!==e?e:{};s[_S]=r.selectedTab.value;const o=r.explicitTabs;void 0!==o&&(s[FS]=It(o)),i.push(s)}n[zS]=i}return n}}const jS=/^[A-Z]$/;class HS extends Sn{constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(Cv(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){this==this.tool.layer.manager.root.toolBinder.activeTool_&&this.tool.layer.manager.root.toolBinder.deactivate_()}}class JS extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(),this.layer=e,this.toggle=t,this.changed=new Cn,this.keyBinding=void 0}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}unbind(){const e=this.layer,t=this.keyBinding;void 0!==t&&e.toolBinder.set(t,void 0)}}class qS extends Sn{constructor(e){super(),this.layer=e,this.changed=new Cn}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){const e=this.layer;e.tool.value===this&&(e.tool.value=void 0)}}function YS(e,t){var n;if(void 0===t)return;"string"==typeof t&&(t={type:t}),Yr(t);const i=ns(t,"type",es);let r=null===(n=KS.get(e.constructor))||void 0===n?void 0:n.get(i);if(void 0===r&&(r=XS.get(i)),void 0===r)throw new Error(`Invalid tool type: ${Bt(t)}.`);return r(e,t)}const ZS=new pt,XS=new pt,KS=new pt;function QS(e,t){ZS.set(e,t)}function ew(e,t,n){let i=KS.get(e);void 0===i&&(i=new pt,KS.set(e,i)),i.set(t,n)}class tw extends Sn{constructor(e){super(),this.layer=e,this.changed=new Cn}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),void 0!==e&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){const e=this.value_;void 0!==e&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=function(e,t){if(void 0===t)return;"string"==typeof t&&(t={type:t}),Yr(t);const n=ns(t,"type",es),i=ZS.get(n);if(void 0===i)throw new Error(`Invalid tool type: ${Bt(t)}.`);return i(e,t)}(this.layer,e)}reset(){this.value=void 0}toJSON(){const e=this.value_;if(void 0!==e)return e.toJSON()}}class nw extends Sn{constructor(e){super(),this.inputEventMapBinder=e,this.bindings=new pt,this.changed=new Cn,this.debounceDeactivate=this.registerCancellable(mn((()=>this.deactivate_()),100)),this.debounceReactivate=this.registerCancellable(mn((()=>this.reactivateQueuedTool()),100))}get(e){return this.bindings.get(e)}set(e,t){const n=this.bindings,i=n.get(e);if(void 0!==i){i.keyBinding=void 0,n.delete(e);const t=i.layer.toolBinder;t.bindings.delete(e),t.jsonToKey.delete(Bt(i.toJSON())),this.destroyTool(i),t.changed.dispatch()}if(void 0!==t){const i=t.layer.toolBinder,r=Bt(t.toJSON()),s=i.jsonToKey.get(r);if(void 0!==s){const e=i.bindings.get(s);e.keyBinding=void 0,n.delete(s),i.bindings.delete(s),i.jsonToKey.delete(r),this.destroyTool(e)}i.bindings.set(e,t),t.keyBinding=e,i.jsonToKey.set(r,e),n.set(e,t),i.changed.dispatch()}this.changed.dispatch()}activate(e){const t=this.get(e);if(void 0===t)return void this.deactivate_();this.debounceDeactivate.cancel(),this.debounceReactivate.cancel();const n=this.activeTool_;if(t===n?.tool)return void(t.toggle&&this.deactivate_());void 0!==n&&(n.tool.toggle&&!t.toggle&&(this.queuedTool=n.tool),this.deactivate_());const i=new HS(t,this.inputEventMapBinder);if(this.activeTool_=i,!t.toggle){const t=`Key${e}`;i.registerEventListener(window,"keyup",(e=>{e.code===t&&(this.debounceDeactivate(),this.debounceReactivate())})),i.registerEventListener(window,"blur",(()=>{this.debounceDeactivate(),this.debounceReactivate()}))}return t.activate(i),t}reactivateQueuedTool(){if(this.queuedTool){const e=new HS(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),(null===(t=this.activeTool_)||void 0===t?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();const e=this.activeTool_;void 0!==e&&(this.activeTool_=void 0,e.dispose())}}class iw{constructor(e){this.layer=e,this.bindings=new pt,this.jsonToKey=new pt,this.changed=new Cn,e.registerDisposer((()=>this.clear()))}get globalBinder(){return this.layer.manager.root.toolBinder}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){const n=YS(this.layer,t);void 0!==n&&this.set(e,n)}removeJsonString(e){const t=this.jsonToKey.get(e);void 0!==t&&this.set(t,void 0)}toJSON(){const e=this.bindings;if(0===e.size)return;const t={};for(const i of e){var n=O(i,2);const e=n[0],r=n[1];t[e]=r.toJSON()}return t}clear(){const e=this.globalBinder,t=this.bindings;if(0!==t.size){for(const i of t){var n=O(i,2);const t=n[0],r=n[1];r.keyBinding=void 0,e.bindings.delete(t),e.destroyTool(r)}t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(void 0!==e){Yr(e);for(const n of Cf(e)){var t=O(n,2);const e=t[0],i=t[1];if(!e.match(jS))throw new Error(`Invalid tool key: ${Bt(e)}`);const r=YS(this.layer,i);if(void 0===r)return;this.set(e,r)}}}}class rw extends Sn{constructor(e,t){super(),this.layer=e,this.toolJson=t,this.element=document.createElement("div"),this.toolJsonString=Bt(this.toolJson);const n=this.element;n.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.toolBinder.changed.add(this.registerCancellable(al((()=>this.updateView()))))),this.updateView(),n.title="click \u2192 bind key, dbclick \u2192 unbind",n.addEventListener("dblclick",(()=>{this.layer.toolBinder.removeJsonString(this.toolJsonString)})),sw(this,n,(e=>this.layer.toolBinder.setJson(e,this.toolJson)))}updateView(){const e=this.layer.toolBinder.jsonToKey.get(this.toolJsonString);this.element.textContent=e??" "}}function sw(e,t,n){let i;t.addEventListener("mousedown",(t=>{0===t.button&&void 0===i&&(t.preventDefault(),t.stopPropagation(),i=new Sn,e.registerDisposer(i),i.registerDisposer(new Bp(!1)).setText("Press A-Z to bind key"),i.registerEventListener(window,"keydown",(e=>{const t=e.code.match(/^Key([A-Z])$/);if(null===t)return;e.stopPropagation(),e.preventDefault();const i=t[1];n(i)}),{capture:!0}),i.registerEventListener(window,"mouseup",(t=>{0!==t.button||void 0===i||(t.preventDefault(),t.stopPropagation(),e.unregisterDisposer(i),i.dispose(),i=void 0)})))})),t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation()}))}function ow(e,t,n){const i=document.createElement("div");i.classList.add("neuroglancer-tool-button"),i.appendChild(e.registerDisposer(new rw(t,n.toolJson)).element);const r=document.createElement("div");return r.classList.add("neuroglancer-tool-button-label"),r.textContent=n.label,n.title&&(r.title=n.title),i.appendChild(r),i}function aw(e){var t=function(e){const t=e.registerDisposer(new Bp(!1));t.element.classList.add("neuroglancer-tool-status");const n=document.createElement("div");n.classList.add("neuroglancer-tool-status-content"),t.element.appendChild(n);const i=e.inputEventMapBinder;return e.inputEventMapBinder=(e,n)=>{const r=document.createElement("div");r.textContent=e.describe(),r.classList.add("neuroglancer-tool-status-bindings"),t.element.appendChild(r),i(e,n)},{message:t,content:n}}(e);const n=t.message,i=t.content,r=document.createElement("div");r.classList.add("neuroglancer-tool-status-header");const s=document.createElement("div");s.classList.add("neuroglancer-tool-status-header-container"),s.appendChild(r),i.appendChild(s);const o=document.createElement("div");return o.classList.add("neuroglancer-tool-status-body"),i.appendChild(o),{message:n,body:o,header:r}}function lw(e,t){e.remove(t)}function cw(e,t){e.add(t)}const dw="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImNvbnRyb2xzQWx0SWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iY29udHJvbHNBbHRJY29uVGl0bGUiPkNvbnRyb2xzPC90aXRsZT4KICAgIDxjaXJjbGUgY3g9IjkiIGN5PSI2IiByPSIyIi8+CiAgICA8cGF0aCBkPSJNNCA2SDciLz4KICAgIDxwYXRoIGQ9Ik0xMSA2SDIwIi8+CiAgICA8Y2lyY2xlIGN4PSI5IiBjeT0iMTgiIHI9IjIiLz4KICAgIDxwYXRoIGQ9Ik00IDE4SDciLz4KICAgIDxwYXRoIGQ9Ik0xMSAxOEgyMCIvPgogICAgPGNpcmNsZSBjeD0iMTUiIGN5PSIxMiIgcj0iMiIvPgogICAgPHBhdGggZD0iTTQgMTJIMTMiLz4KICAgIDxwYXRoIGQ9Ik0xNyAxMkwyMCAxMiIvPgo8L3N2Zz4=";class uw extends Sn{}function hw(e){let t,n,i;return(r,s)=>void 0===n||void 0!==t&&void 0!==r&&t.generation===r.generation?(t=void 0,i=new sd,n=e(r,i).then((e=>(t=e,i=void 0,e)),(e=>{throw i.isCanceled&&(i=void 0,n=void 0),e})),n):(void 0===t&&i.addConsumer(s),n)}function pw(e){let t=0;return hw(((n,i)=>e(i).then((e=>({generation:++t,credentials:e})))))}class fw{constructor(){this.providers=new pt,this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){const n=this.providers.get(e);if(void 0===n)throw new Error(`No registered credentials provider: ${Bt(e)}`);return n(t,this.topLevelManager)}}class gw extends Sn{constructor(e){super(),this.base=e,this.memoize=new cl}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},(()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef())))}}class mw extends gw{constructor(){super(new fw),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class vw extends uw{constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=hw((e=>this.anonymous&&void 0===e?Qc.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(e))))}}const yw=new mw;function bw(e,t){return n=>{n.style.flex=e,t(n)}}function Sw(e,t){return n=>{n.style.display="flex",n.style.flexDirection=e;for(let e of t){let t=n.ownerDocument.createElement("div");n.appendChild(t),e(t)}}}const ww=qn();function xw(e,t){const n=Zn(ww),i=e.globalPosition;var r=e.displayDimensionRenderInfo;const s=r.canonicalVoxelFactors,o=r.displayDimensionIndices;for(let a=0;a<3;++a){const e=o[a];n[12+a]=-1===e?0:i[e],n[5*a]=t/s[a]}return Qn(n,e.viewProjectionMat,n),n}class Cw extends Sn{constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer(nu.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));let t=.5;this.colorBuffer=this.registerDisposer(nu.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer(function(e){return e.memoize.get("trivialColorShader",(()=>{let t=new Zd(e);return t.addVarying("vec4","vColor"),t.addOutputBuffer("vec4","v4f_fragColor",null),t.setFragmentMain("v4f_fragColor = vColor;"),t.addAttribute("vec4","aVertexPosition"),t.addAttribute("vec4","aColor"),t.addUniform("mat4","uProjectionMatrix"),t.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),t.build()}))}(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",(()=>new Cw(e)))}draw(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.trivialColorShader,i=this.gl;n.bind(),i.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,e);let r=n.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(r,4);let s=n.attribute("aColor");this.colorBuffer.bindToVertexAttrib(s,4),t&&(i.colorMask(!1,!1,!1,!0),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.colorMask(!0,!0,!0,!0),i.enable(i.BLEND),i.blendFunc(i.ONE_MINUS_DST_ALPHA,i.DST_ALPHA)),i.lineWidth(1),i.drawArrays(i.LINES,0,6),t&&i.disable(i.BLEND),i.disableVertexAttribArray(r),i.disableVertexAttribArray(s)}}class kw{constructor(){this.renderLayers=[null],this.pickData=[null],this.values=[0,0,0],this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this.register(e,n,t.low,t.high,i)}register(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=this.renderLayers,o=this.values,a=this.nextPickID;this.nextPickID+=t;let l=s.length;s[l]=e;let c=3*l;return o[c]=a,o[c+1]=n,o[c+2]=i,this.pickData[l]=r,a}setMouseState(e,t){const n=this.renderLayers,i=this.values;let r=0,s=n.length-1;for(;r<s;){const e=Math.ceil(r+(s-r)/2);i[3*e]>t?s=e-1:r=e}const o=e.pickedRenderLayer=n[r],a=3*r,l=e.pickedOffset=t-i[a];let c=e.pickedValue;c.low=i[a+1],c.high=i[a+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;const d=this.pickData[r];null!==o&&o.updateMouseState(e,c,l,d)}}class Tw{static insertAfter(e,t){let n=e.next0;t.next0=n,t.prev0=e,e.next0=t,n.prev0=t}static insertBefore(e,t){let n=e.prev0;t.prev0=n,t.next0=e,e.prev0=t,n.next0=t}static front(e){let t=e.next0;return t===e?null:t}static back(e){let t=e.prev0;return t===e?null:t}static pop(e){let t=e.next0,n=e.prev0;return t.prev0=n,n.next0=t,e.next0=null,e.prev0=null,e}static*iterator(e){for(let t=e.next0;t!==e;t=t.next0)yield t}static*reverseIterator(e){for(let t=e.prev0;t!==e;t=t.prev0)yield t}static initializeHead(e){e.next0=e.prev0=e}}const Ew=new class{constructor(){Tw.initializeHead(this)}},Lw=window.top===window,Iw=mn((()=>{if(!Lw)return;const e=document.activeElement;if(null===e||e===document.body){const e=Tw.front(Ew);null!==e&&e.element.focus({preventScroll:!0})}}));window.addEventListener("focus",(()=>{Iw()}),!0),window.addEventListener("blur",(()=>{Iw()}),!0);class Dw extends Sn{constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable(mn((()=>{const e=document.activeElement,t=this.element;t.contains(e)||Bv(e)||(null!=e&&(e===this.lastFocusedElement||e.contains(t))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)}),0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",(t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))})),this.registerEventListener(e,"mouseenter",(()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()})),this.registerEventListener(e,"mouseleave",(()=>{this.scheduleUpdateFocus.cancel()})),Tw.insertBefore(Ew,this),this.registerEventListener(e,"focus",(()=>{Tw.pop(this),Tw.insertAfter(Ew,this)})),Iw()}disposed(){Tw.pop(this),super.disposed()}}const Mw=Math.PI/20;function Pw(e,t){return Math.sqrt(e*e+t*t)}function Aw(e){var t=O(e,2);let n=t[0],i=t[1];if(n.identifier>i.identifier){var r=[n,i];i=r[0],n=r[1]}const s=n.clientX-i.clientX,o=n.clientY-i.clientY;return{distance:Pw(s,o),angle:Math.atan2(s,o)}}class Rw extends Sn{constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new pt,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable(qf(((e,t,n,i)=>{const r={event:e,centerX:n,centerY:i};this.dispatch(`touchhold${e.targetTouches.length}`,e,r,t)}),1e3,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",(e=>{this.handleTouchEvent(e)})),this.registerEventListener(e,"touchmove",(e=>{this.handleTouchEvent(e)})),this.registerEventListener(e,"touchend",(e=>{this.handleTouchEvent(e)}))}dispatch(e,t,n){wv(e,t,arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.eventPhase,n,this.eventMap)}handleTouchEvent(e){if(e.target!==this.target)return;e.preventDefault();const t=new pt,n=this.prevTouches,i=this.prevEvent;let r=0,s=0;for(const f of e.targetTouches)t.set(f.identifier,f),r+=f.clientX,s+=f.clientY;r/=t.size,s/=t.size;for(const f of n.entries()){var o=O(f,2);const e=o[0],i=o[1],r=t.get(e);if(void 0===r)n.delete(e);else{const e=r.clientX-i.clientX,t=r.clientY-i.clientY;(Math.abs(e)>=10||Math.abs(t)>=10)&&(this.moved=!0)}}if(void 0===i||i.targetTouches.length!==t.size||0==t.size){if(this.moved=!1,"touchstart"===e.type)this.startHold(e,e.eventPhase,r,s),(void 0===i||0===i.targetTouches.length)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if("touchend"==e.type){const t=Date.now();if(0===e.targetTouches.length&&t-this.tapStartTime<400){(this.curTapNumTouches!==this.priorTapNumTouches||t-this.tapEndTime>=500)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=t,this.priorTapNumTouches=this.curTapNumTouches;const n={event:e,centerX:r,centerY:s};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,n)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=r,this.prevCenterY=s,this.translated=!1,2===t.size){var a=Aw(t.values());const e=a.distance,n=a.angle;this.prevDistance=e,this.prevAngle=n,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let l=this.prevCenterX,c=this.prevCenterY,d=this.translated;const u=r-l,h=s-c;if(!1===d&&Pw(u,h)>=10&&(d=this.translated=!0),!0===d&&(0!==u||0!==h)){this.prevCenterX=r,this.prevCenterY=s;const n={event:e,deltaX:u,deltaY:h,centerX:r,centerY:s};this.dispatch(`touchtranslate${t.size}`,e,n)}if(2===t.size){var p=Aw(t.values());const n=p.distance,i=p.angle;let o=this.pinched,a=this.rotated,l=this.prevDistance,c=this.prevAngle;!1===o&&Math.abs(n-l)>=20&&(this.pinched=o=!0);const d=function(e,t){const n=2*Math.PI,i=Math.abs(e-t)%n;return Math.min(i,n-i)}(i,c);if(!1===a&&d>=Mw&&(this.rotated=a=!0),!0===o&&n!=l){this.prevDistance=n;const t={event:e,distance:n,prevDistance:l,centerX:r,centerY:s};this.dispatch("touchpinch",e,t)}!0===a&&i!==c&&(this.prevAngle=i,this.dispatch("touchrotate",e,{event:e,centerX:r,centerY:s,angle:i,prevAngle:c}))}}}function Nw(e){let t=0;switch(e.deltaMode){case 0:t=.005;break;case 1:t=.1;break;case 2:t=2}return Math.exp(e.deltaY*t)}const Vw=ti();class Ow{constructor(){this.pickIDs=new kw,this.viewportWidth=0,this.viewportHeight=0,this.invTransform=qn(),this.frameNumber=-1}}class Bw{constructor(){this.buffer=null,this.glWindowX=0,this.glWindowY=0}}const _w=11,Fw=(()=>{const e=(e,t)=>(e-5)**2+(t-5)**2;let t=new Uint32Array(121),n=0;for(let i=0;i<_w;++i)for(let r=0;r<_w;++r)e(i,r)>25||(t[n++]=r*_w+i);return t=t.subarray(0,n),t.sort(((t,n)=>{const i=t%_w,r=n%_w,s=(n-r)/_w;return e(i,(t-i)/_w)-e(r,s)})),t})();function zw(e,t,n,i,r,s,o){const a=i-5,l=r-5;if(!(a>=0&&l>=0&&a+_w<=s&&l+_w<=o))for(let c=0;c<_w;++c)for(let i=0;i<_w;++i){const r=a+i,d=l+c;(r<0||d<0||r>=s||d>=o)&&(e[t+(d*_w+r)*n]=0)}}class Uw extends pl{constructor(e,t,n){super(e,t,n.visibility),this.viewer=n,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.pickingData=[new Ow,new Ow],this.pickRequests=[new Bw,new Bw],this.pickBufferContents=new Float32Array(968),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.inputEventMap=n.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP<"u"&&!0===NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new Dw(t)),this.registerDisposer(new tS(t,this.inputEventMap)),this.registerDisposer(new ly(t,this.inputEventMap,(e=>{this.onMousemove(e)}))),this.registerDisposer(new Rw(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",(()=>this.onMouseout())),this.registerEventListener(t,"mouseover",(e=>{e.target!==t&&this.onMouseout()}),!0),Cv(t,"select-position",(()=>{this.viewer.selectionDetailsState.select(!1)})),Cv(t,"snap",(()=>{this.navigationState.pose.snap()})),Cv(t,"zoom-in",(()=>{this.navigationState.zoomBy(.5)})),Cv(t,"zoom-out",(()=>{this.navigationState.zoomBy(2)})),Cv(t,"depth-range-decrease",(()=>{this.navigationState.depthRange.value*=.5})),Cv(t,"depth-range-increase",(()=>{this.navigationState.depthRange.value*=2}));for(let i=0;i<3;++i){let e=Di[i];for(let n of[-1,1]){let r=n<0?"-":"+";Cv(t,`rotate-relative-${e}${r}`,(()=>{this.navigationState.pose.rotateRelative(Mi[i],.1*n)}));let s=ti();Cv(t,`${e}${r}`,(()=>{let e=this.navigationState,t=s;t[0]=0,t[1]=0,t[2]=0,t[i]=n,e.pose.translateVoxelsRelative(t,!0)}))}}Cv(t,"zoom-via-wheel",(e=>{const t=e.detail;this.onMousemove(t,!1),this.zoomByMouse(Nw(t))})),Cv(t,"adjust-depth-range-via-wheel",(e=>{const t=e.detail;this.navigationState.depthRange.value*=Nw(t)})),Cv(t,"translate-via-mouse-drag",(e=>{Hv(e.detail,((e,t,n)=>{this.translateByViewportPixels(t,n)}))})),Cv(t,"translate-in-plane-via-touchtranslate",(e=>{const t=e.detail;this.translateByViewportPixels(t.deltaX,t.deltaY)})),Cv(t,"translate-z-via-touchtranslate",(e=>{const t=e.detail;let n=this.navigationState,i=Vw;i[0]=0,i[1]=0,i[2]=t.deltaY+t.deltaX,n.pose.translateVoxelsRelative(i,!0)}));for(const i of[1,10])Cv(t,`z+${i}-via-wheel`,(e=>{const t=e.detail;let n=this.navigationState,r=Vw,s=0!==t.deltaY?t.deltaY:t.deltaX;r[0]=0,r[1]=0,r[2]=(s>0?-1:1)*i,n.pose.translateVoxelsRelative(r,!0)}));Cv(t,"move-to-mouse-position",(()=>{const e=this.viewer.mouseState;e.updateUnconditionally()&&(this.navigationState.position.value=e.position)})),Cv(t,"snap",(()=>this.navigationState.pose.snap())),Cv(t,"move-annotation",(e=>{const t=this.viewer.mouseState,n=t.pickedAnnotationId,i=t.pickedAnnotationLayer;if(void 0!==i&&void 0!==n){e.stopPropagation();let r=i.source.getReference(n),s=r.value;const o=ep(s.type),a=t.pickedOffset,l=i.chunkTransform.value;if(void 0!==l.error)return;const c=l.layerRank,d=new Float32Array(c);o.getRepresentativePoint(d,s,t.pickedOffset);let u=function(e,t,n){return e[0]=t,e[1]=n,e}(Li(),0,0);t.updateUnconditionally()&&Hv(e.detail,((e,t,n)=>{!function(e,t,n){e[0]=t[0]+n[0],e[1]=t[1]+n[1]}(u,u,[t,n]);const h=new Float32Array(c);Io(h,l.chunkToLayerTransform,c+1,d,c);const p=Vw,f=this.navigationState.pose.displayDimensions.value.displayDimensionIndices;(function(e,t,n,i){const r=n.globalToRenderLayerDimensions;for(let s=0;s<3;++s){let n=0;const o=i[s];if(-1!==o){const e=r[o];-1!==e&&(n=t[e])}e[s]=n}})(p,h,l.modelTransform,f),this.translateDataPointByViewportPixels(p,p,u[0],u[1]),function(e,t,n,i){const r=n.globalToRenderLayerDimensions;for(let s=0;s<3;++s){const n=i[s];if(-1!==n){const i=r[n];-1!==i&&(e[i]=t[s])}}}(h,p,l.modelTransform,f);const g=new Float32Array(c);Io(g,l.layerToChunkTransform,c+1,h,c);let m=o.updateViaRepresentativePoint(s,g,a);i.source.update(r,m)}),(e=>{i.source.commit(r),r.dispose()}))}})),Cv(t,"delete-annotation",(()=>{const e=this.viewer.mouseState,t=e.pickedAnnotationId,n=e.pickedAnnotationLayer;if(void 0!==n&&!n.source.readonly&&void 0!==t){const e=n.source.getReference(t);try{n.source.delete(e)}finally{e.dispose()}}})),Cv(t,"zoom-via-touchpinch",(e=>{const t=e.detail;this.handleMouseMove(t.centerX,t.centerY);const n=t.prevDistance/t.distance;n>.1&&n<10&&this.zoomByMouse(n)}))}cancelPickRequests(){const e=this.gl;for(const t of this.pickRequests){const n=t.sync;null!==n&&e.deleteSync(n),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){const t=this.gl;let n=e.buffer;null===n?(n=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,3872,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n);const i=this.renderViewport;let r=this.mouseX-i.visibleLeftFraction*i.logicalWidth,s=i.height-(this.mouseY-i.visibleTopFraction*i.logicalHeight);this.issuePickRequest(r,s),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=r,e.glWindowY=s,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),-1===this.pickTimerId&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;const o=this.pickRequests;e!==o[0]&&(o[1]=o[0],o[0]=e),this.nextPickRequestTime=Date.now()+30}completePickInternal(e){const t=this.gl,n=this.pickBufferContents;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,n),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);const i=this.pickingData,r=e.frameNumber;this.completePickRequest(e.glWindowX,e.glWindowY,n,i[0].frameNumber===r?i[0]:i[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout((()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()}),0)}checkForPickRequestCompletion(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.context.frameNumber,i=-1;e&&(--n,i=n-1);const r=this.pickRequests,s=this.gl;let o,a=!1,l=!1;for(const d of r){const e=d.sync;if(null===e)continue;const r=d.frameNumber;if(!l&&r>=n-1)if(t||s.getSyncParameter(e,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(d),l=!0;else if(r!==i){a=!0;continue}s.deleteSync(e),d.sync=null,o=d}const c=this.pickTimerId;a&&-1===c?this.scheduleCheckForPickRequestCompletion():!a&&-1!==c&&(window.clearTimeout(c),this.pickTimerId=-1),!e&&void 0!==o&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(o)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){var e=this.renderViewport;const t=e.width,n=e.height;this.checkForPickRequestCompletion(!0);const i=this.pickingData;i[0]=i[1];const r=this.context.frameNumber,s=i[1];s.frameNumber=r,s.viewportWidth=t,s.viewportHeight=n,s.pickIDs.clear(),this.drawWithPicking(s)?(this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()):s.frameNumber=-1}canIssuePickRequest(){const e=Date.now(),t=this.nextPickRequestTime,n=this.pendingPickRequestTimerId;return!(e<t)||(-1==n&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1)}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;const e=this.context.frameNumber,t=this.gl,n=this.pickRequests;for(const i of n){let n=i.sync;if(null!==n){if(!(i.frameNumber<e-1))continue;t.deleteSync(n)}return void this.issuePickRequestInternal(i)}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0)return this.pickRequestPending=!1,void this.cancelPickRequests();const n=this.context.frameNumber,i=this.pickingData[1];i.frameNumber!==n||this.renderViewport.width!==i.viewportWidth||this.renderViewport.height!==i.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){const n=this.element,i=n.getBoundingClientRect(),r=e-(i.left+n.clientLeft),s=t-(i.top+n.clientTop),o=this.viewer.mouseState;o.pageX=e+window.scrollX,o.pageY=t+window.scrollY,o.setForcer(this.mouseStateForcer),this.updateMousePosition(r,s)}onMousemove(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const n=this.element;t&&e.target!==n||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){let t=this.element;if(e.target!==t||1!==e.targetTouches.length)return;var n=e.targetTouches[0];const i=n.clientX,r=n.clientY;this.handleMouseMove(i,r)}disposed(){this.viewer.mouseState.removeForcer(this.mouseStateForcer);const e=this.gl;this.cancelPickRequests();const t=this.pendingPickRequestTimerId;-1!==t&&window.clearTimeout(t);for(const n of this.pickRequests)e.deleteBuffer(n.buffer);super.disposed()}}const Gw=[1.5,2,3,5,7.5,10];class Ww{constructor(){this.allowedSignificands=Gw,this.targetLengthInPixels=0,this.physicalSizePerPixel=0,this.prevPhysicalSizePerPixel=0,this.prevTargetLengthInPixels=0,this.prevPhysicalUnit="\0"}update(){let e=this.physicalSizePerPixel,t=this.targetLengthInPixels;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;const n=t*e,i=Math.floor(Ao(n)),r=10**i,s=n/r;let o=1;for(let c of this.allowedSignificands){if(!(Math.abs(c-s)<Math.abs(o-s)))break;o=c}const a=o*r,l=Bo(a);return this.lengthInPixels=Math.round(a/e),this.physicalUnit=`${l.prefix}${this.physicalBaseUnit}`,this.physicalLength=o*10**(i-l.exponent),!0}}function $w(e,t,n,i,r){const s=document.createElement("canvas"),o=s.getContext("2d"),a=r.textHeightInPixels*r.scaleFactor,l=`bold ${a}px ${r.fontName}`;o.font=l,o.fillStyle="white";const c=`${i}${e.physicalLength} ${e.physicalUnit}`,d=o.measureText(c),u=Math.max(e.lengthInPixels,d.width),h=r.barHeightInPixels*r.scaleFactor,p=r.barTopMarginInPixels*r.scaleFactor,f=h+p+a,g=r.paddingInPixels*r.scaleFactor,m=f+2*g,v=u+2*g;return s.width=v,s.height=m,o.font=l,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,v,m),o.fillStyle="white",o.fillText(c,v/2,m-g-h-p),o.fillRect(g,m-g-h,e.lengthInPixels,h),function(e,t,n){e.activeTexture(WebGL2RenderingContext.TEXTURE0+e.tempTextureUnit),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),e.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),e.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),e.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),e.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,n),e.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}(t,n,s),{width:v,height:m}}class jw extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Ww;super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){const t=this.dimensions,n=this.label;let i=this.texture;if(!t.update()&&null!==i&&e===this.priorOptions&&n==this.prevLabel)return;null===i&&(i=this.texture=this.gl.createTexture());var r=$w(t,this.gl,i,n,e);const s=r.width,o=r.height;this.priorOptions=e,this.prevLabel=n,this.width=s,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class Hw extends Sn{constructor(e){super(),this.gl=e,this.scaleBarCopyHelper=this.registerDisposer(vu.get(this.gl)),this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new jw(e)))}draw(e,t,n,i,r){const s=this.scaleBars,o=t.displayRank,a=t.displayDimensionIndices,l=t.canonicalVoxelFactors,c=t.globalDimensionNames,d=t.displayDimensionUnits,u=t.displayDimensionScales,h=n.factors,p=Math.min(r.maxWidthFraction*e.logicalWidth,r.maxWidthInPixels*r.scaleFactor);let f=0;for(let y=0;y<o;++y){const e=a[y],t=d[y],n=h[e];let r,o,g;for(r=0;r<f&&(o=s[r],g=o.dimensions,g.physicalBaseUnit!==t||o.factor!==n);++r);r===f&&(++f,o=s[r],o.label="",g=o.dimensions,o.factor=n,g.physicalBaseUnit=t,g.targetLengthInPixels=p,g.physicalSizePerPixel=u[y]*i/l[y]),o.label+=`${c[e]} `}const g=this.gl,m=this.scaleBarCopyHelper;let v=r.bottomPixelOffset*r.scaleFactor;for(let y=f-1;y>=0;--y){const t=s[y];1===f?t.label="":t.label+=": ",t.update(r),g.viewport(r.leftPixelOffset*r.scaleFactor-e.visibleLeftFraction*e.logicalWidth,v-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,t.width,t.height),m.draw(t.texture),v+=t.height+r.marginPixelsBetweenScaleBars*r.scaleFactor}}}const Jw=(0,i.bn)((0,i.bn)({},{scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2}),{maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5});function qw(e){const t=(0,i.bn)({},Jw);for(const n of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])ns(e,n,(e=>{void 0!==e&&(t[n]=kr(e))}));return ns(e,"fontName",(e=>{void 0!==e&&(t.fontName=es(e))})),t}class Yw extends Ln{constructor(){super(Jw,qw)}}var Zw;!function(e){e[e.COLOR=0]="COLOR",e[e.Z=1]="Z",e[e.PICK=2]="PICK",e[e.NUM_TEXTURES=3]="NUM_TEXTURES"}(Zw||(Zw={}));const Xw=["\nfloat computeOITWeight(float alpha) {\n  float a = min(1.0, alpha) * 8.0 + 0.01;\n  float b = -gl_FragCoord.z * 0.95 + 1.0;\n  return a * a * a * b * b * b;\n}\n","\nvoid emit(vec4 color, highp uint pickId) {\n  float weight = computeOITWeight(color.a);\n  vec4 accum = color * weight;\n  v4f_fragData0 = vec4(accum.rgb, color.a);\n  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);\n}\n"];function Kw(e){e.addOutputBuffer("vec4","out_color",Zw.COLOR),e.addOutputBuffer("highp vec4","out_z",Zw.Z),e.addOutputBuffer("highp vec4","out_pickId",Zw.PICK),e.addFragmentCode("\nvoid emit(vec4 color, highp uint pickId) {\n  out_color = color;\n  float zValue = 1.0 - gl_FragCoord.z;\n  out_z = vec4(zValue, zValue, zValue, 1.0);\n  float pickIdFloat = float(pickId);\n  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);\n}\n")}function Qw(e){e.addOutputBuffer("vec4","v4f_fragData0",0),e.addOutputBuffer("vec4","v4f_fragData1",1),e.addFragmentCode(Xw)}const ex=ti(),tx=vi(),nx=qn();function ix(e){e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("\nvec4 v0 = getValue0();\nvec4 v1 = getValue1();\nvec4 accum = vec4(v0.rgb, v1.r);\nfloat revealage = v0.a;\n\nv4f_fragColor = vec4(accum.rgb / accum.a, revealage);\n")}const rx=Ed(gd);class sx extends rx{constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new Nd(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class ox extends Uw{constructor(e,t,n){super(e,t,n),this.sliceViews=this.registerDisposer(new Fd(((e,t,n)=>{e.registerDisposer(n),e.registerDisposer(n.visibility.add(this.visibility))}))),this.axesLineHelper=this.registerDisposer(Cw.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(Rp.get(this.gl,Kw)),this.offscreenFramebuffer=this.registerDisposer(new mu(this.gl,{colorBuffers:[new pu(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new pu(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new pu(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new uu(this.gl)})),this.offscreenCopyHelper=this.registerDisposer(vu.get(this.gl)),this.transparencyCopyHelper=this.registerDisposer(vu.get(this.gl,ix,2)),this.scaleBars=this.registerDisposer(new Hw(this.gl)),this.projectionParameters=this.registerDisposer(new Rd({navigationState:this.navigationState,update:(e,t)=>{const n=e.invViewMatrix,i=e.projectionMat,r=e.logicalWidth/e.logicalHeight,s=Math.PI/4;let o=t.relativeDepthRange,a=t.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){ei(i,-r,r,-1,1,Math.max(.1,1-o),1+o)}else{const e=1/Math.tan(s/2);o/=e;a*=e,function(e,t,n,i,r){var s,o=1/Math.tan(t/2);e[0]=o/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(s=1/(i-r),e[10]=(r+i)*s,e[14]=2*r*i*s):(e[10]=-1,e[14]=-2*i)}(i,s,r,Math.max(.1,1-o),1+o)}ul(e,i),t.pose.toMat4(n,a),function(e,t,n){var i=n[0],r=n[1],s=n[2];e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}(n,n,ri(ex,1,-1,-1)),function(e,t,n){var i,r,s,o,a,l,c,d,u,h,p,f,g=n[0],m=n[1],v=n[2];t===e?(e[12]=t[0]*g+t[4]*m+t[8]*v+t[12],e[13]=t[1]*g+t[5]*m+t[9]*v+t[13],e[14]=t[2]*g+t[6]*m+t[10]*v+t[14],e[15]=t[3]*g+t[7]*m+t[11]*v+t[15]):(i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],l=t[5],c=t[6],d=t[7],u=t[8],h=t[9],p=t[10],f=t[11],e[0]=i,e[1]=r,e[2]=s,e[3]=o,e[4]=a,e[5]=l,e[6]=c,e[7]=d,e[8]=u,e[9]=h,e[10]=p,e[11]=f,e[12]=i*g+a*m+u*v+t[12],e[13]=r*g+l*m+h*v+t[13],e[14]=s*g+c*m+p*v+t[14],e[15]=o*g+d*m+f*v+t[15])}(n,n,Mi[2]),bl(e)}})),this.projectionParameters.changed.add((()=>this.context.scheduleRedraw()));const i=this.sharedObject=this.registerDisposer(new sx(this));if(i.RPC_TYPE_ID="perspective_view/PerspectiveView",i.initializeCounterpart(n.rpc,{}),i.visibility.add(this.visibility),this.visibleLayerTracker=kT(this.viewer.layerManager,ym,this.viewer.visibleLayerRoles,this),Cv(t,"rotate-via-mouse-drag",(e=>{Hv(e.detail,((e,t,n)=>{this.navigationState.pose.rotateRelative(Mi[1],t/4*Math.PI/180),this.navigationState.pose.rotateRelative(Mi[0],-n/4*Math.PI/180)}))})),Cv(t,"rotate-in-plane-via-touchrotate",(e=>{const t=e.detail;this.navigationState.pose.rotateRelative(Mi[2],t.angle-t.prevAngle)})),Cv(t,"rotate-out-of-plane-via-touchtranslate",(e=>{const t=e.detail;this.navigationState.pose.rotateRelative(Mi[1],t.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Mi[0],-t.deltaY/4*Math.PI/180)})),n.showSliceViewsCheckbox){let e=this.registerDisposer(new Od(n.showSliceViews));e.element.className="perspective-panel-show-slice-views neuroglancer-noselect";let t=document.createElement("label");t.className="perspective-panel-show-slice-views neuroglancer-noselect",t.appendChild(document.createTextNode("Sections")),t.appendChild(e.element),this.element.appendChild(t)}this.registerDisposer(n.orthographicProjection.changed.add((()=>{this.projectionParameters.update(),this.scheduleRedraw()}))),this.registerDisposer(n.showScaleBar.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.scaleBarOptions.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.showSliceViews.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.showAxisLines.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.crossSectionBackgroundColor.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.perspectiveViewBackgroundColor.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.wireFrame.changed.add((()=>this.scheduleRedraw()))),this.sliceViews.changed.add((()=>this.scheduleRedraw()))}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){const n=ex;var i=this.projectionParameters.value;const r=i.viewProjectionMat,s=i.invViewProjectionMat,o=i.logicalWidth,a=i.logicalHeight;this.viewer.navigationState.pose.updateDisplayPosition((i=>{pi(n,i,r),n[0]+=-2*e/o,n[1]+=2*t/a,pi(i,n,s)}))}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(const a of this.sliceViews){var e=O(a,2);const t=e[0];if((e[1]||this.viewer.showSliceViews.value)&&!t.isReady())return!1}this.ensureBoundsUpdated();var t=this.renderViewport;const n=t.width,i=t.height;if(0===n||0===i)return!0;const r={projectionParameters:this.projectionParameters.value},s=this.visibleLayerTracker.visibleLayers;for(const a of s){var o=O(a,2);const e=o[0],t=o[1];if(!e.isReady(r,t))return!1}return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;const e=this.offscreenFramebuffer;var t=this.renderViewport;const n=t.width,i=t.height,r=n*i,s=new Float32Array(4*r);try{e.bindSingle(Zw.Z),this.gl.readPixels(0,0,n,i,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,s)}finally{e.framebuffer.unbind()}const o=new Float32Array(r);for(let a=0;a<r;++a)o[a]=s[4*a];return o}issuePickRequest(e,t){const n=this.offscreenFramebuffer;n.readPixelFloat32IntoBuffer(Zw.Z,e-5,t-5,0,_w,_w),n.readPixelFloat32IntoBuffer(Zw.PICK,e-5,t-5,1936,_w,_w)}completePickRequest(e,t,n,i){const r=this.viewer.mouseState;r.pickedRenderLayer=null,zw(n,0,4,e,t,i.viewportWidth,i.viewportHeight);const s=Fw.length;for(let o=0;o<s;++o){const s=Fw[o];let a=n[4*s];if(0===a)continue;const l=s%_w,c=(s-l)/_w;let d=1-a;ex[0]=2*(e+l-5)/i.viewportWidth-1,ex[1]=2*(t+c-5)/i.viewportHeight-1,ex[2]=2*d-1,pi(ex,ex,i.invTransform);let u=r.position,h=r.unsnappedPosition;const p=this.navigationState.position.value,f=p.length;u.length!==f&&(u=r.position=new Float32Array(f)),h.length!==f&&(h=r.unsnappedPosition=new Float32Array(f)),u.set(p),r.coordinateSpace=this.navigationState.coordinateSpace.value;const g=this.navigationState.pose.displayDimensions.value,m=g.displayDimensionIndices;for(let e=0,t=m.length;e<t;++e)u[m[e]]=ex[e];h.set(u);const v=n[484+4*s];return i.pickIDs.setMouseState(r,v),r.displayDimensions=g,void r.setActive(!0)}r.setActive(!1)}translateDataPointByViewportPixels(e,t,n,i){const r=ex;var s=this.projectionParameters.value;const o=s.viewProjectionMat,a=s.invViewProjectionMat,l=s.width,c=s.height;return pi(r,t,o),r[0]+=2*n/l,r[1]+=-2*i/c,pi(e,r,a)}get transparentConfiguration(){let e=this.transparentConfiguration_;return void 0===e&&(e=this.transparentConfiguration_=this.registerDisposer(new mu(this.gl,{colorBuffers:gu(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;var t=this.renderViewport;const n=t.width,i=t.height,r=this.viewer.showSliceViews.value;for(const b of this.sliceViews){var s=O(b,2);const e=s[0];(s[1]||r)&&e.updateRendering()}let o=this.gl;this.offscreenFramebuffer.bind(n,i),o.disable(o.SCISSOR_TEST),o.enable(WebGL2RenderingContext.STENCIL_TEST),o.stencilMask(4294967295),o.clearStencil(0),o.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),o.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),o.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);const a=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(a[0],a[1],a[2],0),o.clear(o.DEPTH_BUFFER_BIT),o.clearBufferfv(WebGL2RenderingContext.COLOR,Zw.COLOR,[a[0],a[1],a[2],0]),o.clearBufferfv(WebGL2RenderingContext.COLOR,Zw.Z,Pi),o.clearBufferfv(WebGL2RenderingContext.COLOR,Zw.PICK,Pi),o.enable(o.DEPTH_TEST);const l=this.projectionParameters.value;let c=ti();fi(c,Mi[2],this.navigationState.pose.orientation.orientation),di(c,c,-1);const d={wireFrame:this.viewer.wireFrame.value,projectionParameters:l,lightDirection:c,ambientLighting:.2,directionalLighting:.8,pickIDs:e.pickIDs,emitter:Kw,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1};Yn(e.invTransform,l.invViewProjectionMat);const u=this.visibleLayerTracker.visibleLayers;let h=!1,p=!1;for(const b of u){var f=O(b,2);const e=f[0],t=f[1];e.isTransparent?h=!0:e.isAnnotation?p=!0:e.draw(d,t)}if(this.drawSliceViews(d),p){o.enable(WebGL2RenderingContext.BLEND),o.depthFunc(WebGL2RenderingContext.LEQUAL),o.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const e of u){var g=O(e,2);const t=g[0],n=g[1];t.isAnnotation&&t.draw(d,n)}o.depthFunc(WebGL2RenderingContext.LESS),o.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),o.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),h){o.depthMask(!1),o.enable(WebGL2RenderingContext.BLEND);const e=this.transparentConfiguration;e.bind(n,i),this.gl.clearColor(0,0,0,1),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),d.emitter=Qw,o.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),d.emitPickID=!1;for(const t of u){var m=O(t,2);const e=m[0],n=m[1];e.isTransparent&&e.draw(d,n)}o.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(Zw.COLOR),o.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(e.colorBuffers[0].texture,e.colorBuffers[1].texture),o.depthMask(!0),o.disable(WebGL2RenderingContext.BLEND),o.enable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bind(n,i),o.enable(WebGL2RenderingContext.STENCIL_TEST),o.drawBuffers([o.NONE,o.COLOR_ATTACHMENT1,o.COLOR_ATTACHMENT2]),d.emitter=Kw,d.emitPickID=!0,d.emitColor=!1,o.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),o.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),o.stencilMask(2);for(const t of u){var v=O(t,2);const e=v[0],n=v[1];!e.isTransparent||!e.transparentPickEnabled||e.draw(d,n)}o.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),o.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),o.stencilMask(0);for(const t of u){var y=O(t,2);const e=y[0],n=y[1];!e.isTransparent||e.transparentPickEnabled||e.draw(d,n)}}if(o.stencilMask(4294967295),o.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){o.drawBuffers([o.COLOR_ATTACHMENT0]),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.enable(WebGL2RenderingContext.BLEND),o.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);const e=this.scaleBars,t=this.viewer.scaleBarOptions.value;e.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,t),o.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[Zw.COLOR].texture),!0}drawSliceViews(e){let t=this.sliceViewRenderHelper,n=e.lightDirection,i=e.ambientLighting,r=e.directionalLighting,s=e.projectionParameters.viewProjectionMat;const o=this.viewer.showSliceViews.value;for(const c of this.sliceViews){var a=O(c,2);const e=a[0];if(!a[1]&&!o)continue;var l=e.projectionParameters.value;const d=l.width,u=l.height,h=l.invViewMatrix,p=l.viewportNormalInCanonicalCoordinates;if(0===d||0===u||!e.valid)continue;let f=i+Math.abs(hi(n,p))*r,g=nx;Zn(g),g[0]=d/2,g[5]=-u/2,Qn(g,h,g),Qn(g,s,g);const m=tx,v=this.viewer.crossSectionBackgroundColor.value;m[0]=v[0],m[1]=v[1],m[2]=v[2],m[3]=1,t.draw(e.offscreenFramebuffer.colorBuffers[0].texture,g,yi(f,f,f,1),tx,0,0,1,1)}}drawAxisLines(){const e=this.viewer.navigationState.zoomFactor.value,t=this.projectionParameters.value,n=e*(Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4),i=this.gl;i.drawBuffers([i.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(xw(t,n),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}var ax;function lx(e){e.addOutputBuffer("vec4","out_fragColor",0),e.addOutputBuffer("highp vec4","out_pickId",1),e.addFragmentCode("\nvoid emit(vec4 color, highp uint pickId) {\n  out_fragColor = color;\n  float pickIdFloat = float(pickId);\n  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);\n}\n")}function cx(e){e.addOutputBuffer("vec4","out_fragColor",null),e.addFragmentCode("\nvoid emit(vec4 color, highp uint pickId) {\n  out_fragColor = color;\n}\n")}!function(e){e[e.COLOR=0]="COLOR",e[e.PICK=1]="PICK",e[e.NUM_TEXTURES=2]="NUM_TEXTURES"}(ax||(ax={}));const dx=ti(),ux=ti(),hx=vi();class px extends Uw{constructor(e,t,n,i){super(e,t,i),this.sliceView=n,this.axesLineHelper=this.registerDisposer(Cw.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(Rp.get(this.gl,cx)),this.colorFactor=yi(1,1,1,1),this.pickIDs=new kw,this.offscreenFramebuffer=this.registerDisposer(new mu(this.gl,{colorBuffers:[new pu(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new pu(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(vu.get(this.gl)),this.scaleBars=this.registerDisposer(new Hw(this.gl)),i.wireFrame.changed.add((()=>this.scheduleRedraw())),Cv(t,"rotate-via-mouse-drag",(e=>{const t=this.viewer.mouseState;if(t.updateUnconditionally()){const n=Float32Array.from(t.position);Hv(e.detail,((e,t,i)=>{const r=this.navigationState.pose,s=fi(dx,Mi[0],r.orientation.orientation),o=fi(ux,Mi[1],r.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(o,-t/4*Math.PI/180,n),this.viewer.navigationState.pose.rotateAbsolute(s,-i/4*Math.PI/180,n)}))}})),Cv(t,"rotate-in-plane-via-touchrotate",(e=>{const t=e.detail,n=this.viewer.mouseState;this.handleMouseMove(t.centerX,t.centerY),n.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,t.angle-t.prevAngle,n.position)})),this.registerDisposer(n),this.visibleLayerTracker=kT(this.viewer.layerManager,kp,this.viewer.visibleLayerRoles,this),this.registerDisposer(i.crossSectionBackgroundColor.changed.add((()=>this.scheduleRedraw()))),this.registerDisposer(n.visibility.add(this.visibility)),this.registerDisposer(n.viewChanged.add((()=>{this.visible&&e.scheduleRedraw()}))),this.registerDisposer(i.showAxisLines.changed.add((()=>{this.visible&&this.scheduleRedraw()}))),this.registerDisposer(i.showScaleBar.changed.add((()=>{this.visible&&this.context.scheduleRedraw()}))),this.registerDisposer(i.scaleBarOptions.changed.add((()=>{this.visible&&this.context.scheduleRedraw()})))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){this.viewer.navigationState.pose.updateDisplayPosition((n=>{ri(n,-e,-t,0),pi(n,n,this.sliceView.projectionParameters.value.invViewMatrix)}))}translateDataPointByViewportPixels(e,t,n,i){const r=this.sliceView.projectionParameters.value;return pi(e,t,r.viewMatrix),ri(e,e[0]+n,e[1]+i,e[2]),pi(e,e,r.invViewMatrix),e}isReady(){if(!this.visible)return!1;const e=this.sliceView;if(this.ensureBoundsUpdated(),!e.isReady())return!1;const t={projectionParameters:e.projectionParameters.value,sliceView:e};for(const i of this.visibleLayerTracker.visibleLayers){var n=O(i,2);const e=n[0],r=n[1];if(!e.isReady(t,r))return!1}return!0}drawWithPicking(e){const t=this.sliceView;if(!t.valid)return!1;t.updateRendering();const n=t.projectionParameters.value,i=n.width,r=n.height,s=n.invViewProjectionMat;Yn(e.invTransform,s);const o=this.gl;this.offscreenFramebuffer.bind(i,r),o.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const a=hx,l=this.viewer.crossSectionBackgroundColor.value;a[0]=l[0],a[1]=l[1],a[2]=l[2],a[3]=1,this.offscreenFramebuffer.bindSingle(ax.COLOR),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,Ii,this.colorFactor,a,0,0,1,1);const c=this.visibleLayerTracker.visibleLayers;let d=this.pickIDs;d.clear();const u={wireFrame:this.viewer.wireFrame.value,projectionParameters:n,pickIDs:d,emitter:lx,emitColor:!0,emitPickID:!0,sliceView:t};this.offscreenFramebuffer.bind(i,r),o.enable(WebGL2RenderingContext.BLEND),o.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const p of c){var h=O(p,2);const e=h[0],t=h[1];e.draw(u,t)}if(o.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(ax.COLOR),this.viewer.showAxisLines.value){const e=Math.min(n.logicalWidth,n.logicalHeight)/4*1.5,t=this.viewer.navigationState.zoomFactor.value;this.axesLineHelper.draw(function(e){return e[2]=0,e[6]=0,e[10]=0,e[14]=0,e}(xw(n,e*t)))}this.viewer.showScaleBar.value&&(o.enable(WebGL2RenderingContext.BLEND),o.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(n,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),o.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[ax.COLOR].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){this.offscreenFramebuffer.readPixelFloat32IntoBuffer(ax.PICK,e-5,t-5,0,_w,_w)}completePickRequest(e,t,n,i){const r=this.viewer.mouseState;r.pickedRenderLayer=null,zw(n,0,4,e,t,i.viewportWidth,i.viewportHeight);const s=i.viewportWidth,o=i.viewportHeight,a=Fw.length,l=this.navigationState.position.value,c=l.length,d=this.navigationState.pose.displayDimensions.value,u=d.displayRank,h=d.displayDimensionIndices,p=(n,r,a)=>{const c=e+n,d=t+r;dx[0]=2*c/s-1,dx[1]=2*d/o-1,dx[2]=0,pi(dx,dx,i.invTransform),a.set(l);for(let e=0;e<u;++e)a[h[e]]=dx[e]};let f=r.unsnappedPosition;f.length!==c&&(f=r.unsnappedPosition=new Float32Array(c)),r.coordinateSpace=this.navigationState.coordinateSpace.value,r.displayDimensions=d,p(0,0,f);const g=(e,t,n)=>{let i=r.position;i.length!==c&&(i=r.position=new Float32Array(c)),p(e-5,t-5,i),this.pickIDs.setMouseState(r,n),r.setActive(!0)};for(let m=0;m<a;++m){const e=Fw[m],t=n[4*m];if(0===t)continue;const i=e%_w;return void g(i,(e-i)/_w,t)}g(5,5,0)}zoomByMouse(e){const t=this.navigationState;if(!t.valid)return;var n=this.sliceView.projectionParameters.value;const i=n.width,r=n.height,s=n.invViewMatrix;var o=n.displayDimensionRenderInfo;const a=o.displayDimensionIndices,l=o.displayRank;let c=this.mouseX,d=this.mouseY;c-=i/2,d-=r/2;const u=this.navigationState.position.value;for(let h=0;h<l;++h){const t=a[h],n=s[h]*c+s[4+h]*d;u[t]+=n*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}function fx(e,t){let n="";for(let i=0;i<=t&&(n=e.toFixed(i),parseFloat(n)!==e);++i);return n}const gx=["#f00","#0f0","#00f"],mx=yv.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function vx(e){if(e<1||e>1024){const t=0|ks(e);return`${fx(e/2**t,1)}p${t}`}return e.toString()}const yx=[e=>e.name,e=>e.scaleFactor];class bx extends Sn{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"px";super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=n,this.displayUnit=i,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=It(Array(3),((e,t)=>{const n=document.createElement("div");n.classList.add("neuroglancer-display-dimensions-widget-dimension"),n.style.display="contents",Cv(n,"adjust-via-wheel",(e=>{const n=e.detail.deltaY;0!==n&&this.zoomDimension(t,ug(n))}));const i=document.createElement("input");i.classList.add("neuroglancer-display-dimensions-widget-name"),i.title="Change display dimensions",i.spellcheck=!1,i.autocomplete="off",i.style.color=gx[t],i.style.gridColumn="1",i.style.gridRow=`${t+1}`,i.addEventListener("focus",(()=>{i.select()})),n.appendChild(i);const r=document.createElement("span");r.classList.add("neuroglancer-display-dimensions-widget-scale-factor");const s=document.createElement("input");s.spellcheck=!1,s.title="Change relative scale at which dimension is displayed",s.autocomplete="off",r.style.gridColumn="2",r.style.gridRow=`${t+1}`,s.addEventListener("focus",(()=>{s.select()})),r.appendChild(s),n.appendChild(r);const o=document.createElement("span");o.classList.add("neuroglancer-display-dimensions-widget-scale"),o.style.gridColumn="3",o.style.gridRow=`${t+1}`,n.appendChild(o),this.dimensionGridContainer.appendChild(n);const a={name:i,container:n,scaleFactor:s,scale:o,scaleFactorModified:!1};i.addEventListener("input",(()=>{Vv(i),this.updateNameValidity()})),Cv(i,"commit",(()=>{this.updateNames()})),i.addEventListener("blur",(e=>{const t=e.relatedTarget;this.dimensionElements.some((e=>e.name===t))||this.updateNames()||this.updateView()})),r.addEventListener("click",(e=>{e.target!==s&&(s.focus(),e.preventDefault())})),s.addEventListener("input",(()=>{Vv(s),a.scaleFactorModified=!0})),Cv(s,"commit",(()=>{this.updateScaleFactors()})),s.addEventListener("blur",(()=>{this.updateScaleFactors()||this.updateView()}));for(const l of yx)Cv(l(a),"move-up",(()=>{0!==t&&l(this.dimensionElements[t-1]).focus()})),Cv(l(a),"move-down",(()=>{2!==t&&l(this.dimensionElements[t+1]).focus()}));return a})),this.scheduleUpdateView=al((()=>this.updateView()));const r=this.element,s=this.dimensionGridContainer,o=this.defaultCheckbox,a=document.createElement("label"),l=this.registerCancellable(mn((()=>{r.dataset.active="false"}),2e3)),c=()=>{r.dataset.active="true",l()};this.registerDisposer(t.changed.add(c)),this.registerDisposer(e.relativeDisplayScales.changed.add(c)),this.registerDisposer(n.changed.add(c)),r.classList.add("neuroglancer-display-dimensions-widget"),r.appendChild(s),s.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),r.addEventListener("pointerleave",(()=>{const e=document.activeElement;e instanceof HTMLElement&&r.contains(e)&&e.blur()})),o.type="checkbox",a.appendChild(o),a.appendChild(document.createTextNode("Default")),a.title="Display first 3 dimensions",a.classList.add("neuroglancer-display-dimensions-widget-default"),o.addEventListener("change",(()=>{this.updateDefault()})),s.appendChild(a),this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));this.registerDisposer(new tS(r,mx)).allShortcutsAreGlobal=!0,this.registerDisposer(new ly(r,mx)),Cv(s,"cancel",(()=>{this.updateView();const e=document.activeElement;e instanceof HTMLElement&&r.contains(e)&&e.blur()}));const d=this.depthGridContainer;d.classList.add("neuroglancer-depth-range-widget-grid"),r.appendChild(d);const u=document.createElement("label"),h=document.createElement("input");h.type="checkbox",u.classList.add("neuroglancer-depth-range-relative-checkbox-label"),h.classList.add("neuroglancer-depth-range-relative-checkbox"),u.appendChild(h),u.appendChild(document.createTextNode("Zoom-relative")),h.addEventListener("change",(()=>{const e=h.checked;let t=this.depthRange.value;e!==t<0&&(t=e?-t/this.zoom.value:-t*this.zoom.value,this.depthRange.value=t)})),u.title="Depth range is multiplied by scale",r.appendChild(u),Cv(d,"adjust-via-wheel",(e=>{const t=e.detail.deltaY;if(0===t)return;const n=this.depthRange.value;this.depthRange.value=n*2**ug(t)})),this.registerDisposer(On(((e,t,n)=>{let{factors:i}=n;Rv(d);const r=t.displayRank,s=t.globalDimensionNames,o=t.displayDimensionIndices,a=t.displayDimensionUnits,l=t.displayDimensionScales,c=t.canonicalVoxelFactors,u=[],p=()=>{h.checked=this.depthRange.value<0;let e=this.depthRange.value;e<0&&(e*=-this.zoom.value);for(const t of u){const n=t.input;n.value=Fo(e*t.scale,t.unit,{precision:2,elide1:!1}),Vv(n)}},f=e=>{const t=zo(e.input.value);if(void 0===t||t.unit!==e.unit)return!1;let n=t.scale/e.scale;return this.depthRange.value<0&&(n=-n/this.zoom.value),this.depthRange.value=n,!0};for(let h=0;h<r;++h){const e=o[h],t=s[e],n=a[h],r=i[e];let g=u.find((e=>e.unit===n&&e.factor===r));if(void 0===g){const e=document.createElement("div");e.title="Visible depth range",e.style.display="contents",d.appendChild(e);const t=document.createElement("span");t.textContent="\xb1",e.appendChild(t);const i=document.createElement("input");i.spellcheck=!1,i.autocomplete="off",i.addEventListener("focus",(()=>{i.select()})),Cv(i,"commit",(()=>{f(g)})),i.addEventListener("change",(()=>{f(g)||p()})),i.addEventListener("input",(()=>{Vv(i)})),e.appendChild(i);const s=document.createElement("span");s.classList.add("neuroglancer-depth-range-widget-dimension-names"),e.appendChild(s),g={unit:n,factor:r,dimensionNames:[],input:i,label:s,scale:l[h]/c[h]},u.push(g)}g.dimensionNames.push(t)}for(const d of u)d.dimensionNames.length!==r&&(d.label.textContent=d.dimensionNames.join(" "));e.registerDisposer(Cv(d,"cancel",(()=>{p();const e=document.activeElement;e instanceof HTMLElement&&d.contains(e)&&e.blur()})));const g=e.registerCancellable(al(p));e.registerDisposer(this.depthRange.changed.add(g)),e.registerDisposer(this.zoom.changed.add(g)),p()}),e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();const n=this.displayDimensions,i=this.relativeDisplayScales,r=n.value.displayDimensionIndices[e];if(-1===r)return;const s=i.value.factors,o=new Float64Array(s);o[r]*=2**-t,i.setFactors(o)}updateNameValidity(){const e=this.dimensionElements,t=this.displayDimensions.value.displayDimensionIndices,n=e.map((e=>e.name.value)),i=wa(n),r=this.displayDimensions.coordinateSpace.value.names,s=n.length;for(let o=0;o<s;++o){let s=i[o];const a=n[o];let l=-1;0===a.length?s=!0:(l=r.indexOf(a),-1===l&&(s=!1));const c=e[o];c.name.dataset.isValid=s.toString(),c.container.dataset.isModified=(l!==t[o]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){const e=this.dimensionElements.map((e=>e.name.value)).filter((e=>e.length>0));if(!Sa(e))return!1;const t=this.displayDimensionRenderInfo.displayDimensions;if(0===e.length)return t.reset(),!0;const n=new Int32Array(3);n.fill(-1);const i=t.coordinateSpace.value.names,r=e.length;for(let s=0;s<r;++s){const t=i.indexOf(e[s]);if(-1===t)return!1;n[s]=t}return Ut(n,t.value.displayDimensionIndices)||t.setDimensionIndices(r,n),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){const e=this.displayDimensions,t=this.relativeDisplayScales;var n=e.value;const i=n.displayDimensionIndices,r=n.displayRank,s=t.value.factors,o=this.dimensionElements,a=new Float64Array(s);for(let l=0;l<r;++l){const e=o[l];if(!e.scaleFactorModified)continue;const t=Number(e.scaleFactor.value),n=i[l];!Sr(t)||t<=0||(a[n]=t)}return Ut(a,s)||t.setFactors(a),!0}updateView(){const e=this.dimensionElements,t=this.displayDimensions.default;var n=this.displayDimensionRenderInfo.value;const i=n.displayDimensionIndices,r=n.canonicalVoxelFactors,s=n.displayDimensionUnits,o=n.displayDimensionScales,a=n.globalDimensionNames,l=this.relativeDisplayScales.value.factors;this.defaultCheckbox.checked=t;const c=this.zoom.value,d=i[0];let u=!0;if(-1!==d){const e=s[0],t=l[d];for(let n=1;n<3;++n){const r=i[n];if(-1!==r&&(s[n]!==e||l[r]!==t)){u=!1;break}}}for(let h=0;h<3;++h){const t=i[h],n=e[h];if(delete n.name.dataset.isValid,n.container.dataset.isModified=(-1===t).toString(),-1===t)n.name.value="",n.scale.textContent="",n.scaleFactor.value="";else{n.name.value=a[t];const e=o[h]*c/r[h];if(0!==h&&u)n.scale.textContent="";else{const t=Fo(e,s[h],{precision:2,elide1:!1});n.scale.textContent=`${t}/${this.displayUnit}`}n.scaleFactor.value=vx(l[t])}Vv(n.name),Vv(n.scaleFactor)}}disposed(){Nv(this.element),super.disposed()}}const Sx=new pt([["xy",void 0],["xz",function(e,t,n){n*=.5;var i=t[0],r=t[1],s=t[2],o=t[3],a=Math.sin(n),l=Math.cos(n);return e[0]=i*l+o*a,e[1]=r*l+s*a,e[2]=s*l-r*a,e[3]=o*l-i*a,e}(bi(),bi(),Math.PI/2)],["yz",function(e,t,n){n*=.5;var i=t[0],r=t[1],s=t[2],o=t[3],a=Math.sin(n),l=Math.cos(n);return e[0]=i*l-s*a,e[1]=r*l+o*a,e[2]=s*l+i*a,e[3]=o*l-r*a,e}(bi(),bi(),Math.PI/2)]]),wx=new pt([["4panel","\u25f1"],["3d","\u25fb"]]);function xx(e,t){return function(e,t){let n;return n=void 0===t?e.navigationState.addRef():new pm(new sm(e.navigationState.pose.position.addRef(),e.navigationState.pose.displayDimensionRenderInfo.addRef(),Zg.makeRelative(e.navigationState.pose.orientation,t)),e.navigationState.zoomFactor.addRef(),e.navigationState.depthRange.addRef()),new Mp(e.chunkManager,e.layerManager,n,e.wireFrame)}(e,Sx.get(t))}function Cx(e){return{crossSectionBackgroundColor:e.crossSectionBackgroundColor,perspectiveViewBackgroundColor:e.perspectiveViewBackgroundColor,selectionDetailsState:e.selectionDetailsState,mouseState:e.mouseState,layerManager:e.layerManager,showAxisLines:e.showAxisLines,wireFrame:e.wireFrame,visibleLayerRoles:e.visibleLayerRoles,selectedLayer:e.selectedLayer,visibility:e.visibility,scaleBarOptions:e.scaleBarOptions}}function kx(e){const t=e.viewer;return(0,i.bn)((0,i.bn)({},Cx(t)),{navigationState:t.perspectiveNavigationState,inputEventMap:t.inputEventBindings.perspectiveView,orthographicProjection:e.specification.orthographicProjection,showScaleBar:t.showScaleBar,rpc:t.chunkManager.rpc})}function Tx(e){return(0,i.bn)((0,i.bn)({},Cx(e)),{navigationState:e.navigationState,inputEventMap:e.inputEventBindings.sliceView})}function Ex(e,t){const n=t.navigationState;t.element.appendChild(e.registerDisposer(new bx(n.pose.displayDimensionRenderInfo.addRef(),n.zoomFactor,n.depthRange.addRef(),t instanceof px?"px":"vh")).element)}function Lx(e,t,n){const i=document.createElement("div");i.className="neuroglancer-data-panel-layout-controls",e.registerDisposer((()=>Nv(i)));for(let r=0;r<2;++r){const i=n[Math.min(n.length-1,r)];e.registerDisposer(Cv(t.element,0===r?"toggle-layout":"toggle-layout-alternative",(t=>{e.container.name=i,t.stopPropagation()})))}for(const r of n){const t=document.createElement("button"),n=document.createElement("div");t.appendChild(n),n.textContent=wx.get(r),t.title=`Switch to ${r} layout.`,t.addEventListener("click",(()=>{e.container.name=r})),i.appendChild(t)}t.element.appendChild(i)}function Ix(e,t){const n=new Mp(e.chunkManager,e.layerManager,t.navigationState.addRef(),e.wireFrame),i=()=>{const e=t.width.value,i=t.height.value;n.projectionParameters.setViewport({width:e,height:i,logicalWidth:e,logicalHeight:i,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return n.registerDisposer(t.width.changed.add(i)),n.registerDisposer(t.height.changed.add(i)),i(),n}function Dx(e,t,n){const i=new pt;(()=>{const r=new Rt;for(const o of n.values()){if(r.add(o),i.has(o))continue;const n=Ix(e,o);t.sliceViews.set(n,!0),i.set(o,n)}for(const e of i){var s=O(e,2);const n=s[0],i=s[1];r.has(n)||t.sliceViews.delete(i)}})()}class Mx extends Sn{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=function(e){return new pt([["xy",xx(e,"xy")],["xz",xx(e,"xz")],["yz",xx(e,"yz")]])}(n),o=n.display;const a=(0,i.bn)((0,i.bn)({},kx(e)),{showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),l=(0,i.bn)((0,i.bn)({},Tx(n)),{showScaleBar:n.showScaleBar}),c=(0,i.bn)((0,i.bn)({},Tx(n)),{showScaleBar:new Vd(!1,!1)}),d=(e,t,n,i)=>{const r=this.registerDisposer(new px(o,t,s.get(e),n));return i&&Ex(this,r),Lx(this,r,[e,`${e}-3d`]),r};let u=[bw(1,Sw("column",[bw(1,Sw("row",[bw(1,(e=>{d("xy",e,l,!0)})),bw(1,(e=>{d("xz",e,c,!1)}))])),bw(1,Sw("row",[bw(1,(e=>{let t=this.registerDisposer(new ox(o,e,a));for(let n of s.values())t.sliceViews.set(n.addRef(),!1);Ex(this,t),Dx(n,t,r),Lx(this,t,["3d"])})),bw(1,(e=>{d("yz",e,c,!1)}))]))]))];Sw("row",u)(t)}disposed(){Rv(this.rootElement),super.disposed()}}class Px extends Sn{constructor(e,t,n,r,s,o){super(),this.container=e,this.rootElement=t,this.viewer=n,this.direction=r;let a=xx(n,s),l=n.display;const c=(0,i.bn)((0,i.bn)({},kx(e)),{showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0}),d=(0,i.bn)((0,i.bn)({},Tx(n)),{showScaleBar:n.showScaleBar});bw(1,Sw(r,[bw(1,(e=>{const t=this.registerDisposer(new px(l,e,a,d));Ex(this,t),Lx(this,t,[s,"4panel"])})),bw(1,(e=>{let t=this.registerDisposer(new ox(l,e,c));t.sliceViews.set(a.addRef(),!1),Dx(n,t,o),Ex(this,t),Lx(this,t,["3d","4panel"])}))]))(t)}disposed(){Rv(this.rootElement),super.disposed()}}class Ax extends Sn{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=xx(n,r);const o=(0,i.bn)((0,i.bn)({},Tx(n)),{showScaleBar:n.showScaleBar});Sw("row",[bw(1,(e=>{const t=this.registerDisposer(new px(n.display,e,s,o));Ex(this,t),Lx(this,t,["4panel",`${r}-3d`])}))])(t)}disposed(){Rv(this.rootElement),super.disposed()}}class Rx extends Sn{constructor(e,t,n,r){super(),this.container=e,this.rootElement=t,this.viewer=n;let s=(0,i.bn)((0,i.bn)({},kx(e)),{showSliceViews:new Vd(!1,!1)});Sw("row",[bw(1,(e=>{const t=this.registerDisposer(new ox(n.display,e,s));Dx(n,t,r),Ex(this,t),Lx(this,t,["4panel"])}))])(t)}disposed(){Rv(this.rootElement),super.disposed()}}const Nx=new pt([["4panel",{factory:(e,t,n,i)=>new Mx(e,t,n,i)}],["3d",{factory:(e,t,n,i)=>new Rx(e,t,n,i)}]]);for(const iV of Sx.keys()){Nx.set(iV,{factory:(e,t,n)=>new Ax(e,t,n,iV)});const e=`${iV}-3d`;wx.set(iV,"\u25fb"),wx.set(e,"\u25eb"),Nx.set(e,{factory:(e,t,n,i)=>new Px(e,t,n,"row",iV,i)})}function Vx(e){let t=Nx.get(e);if(void 0===t)throw new Error(`Invalid layout name: ${Bt(e)}.`);return t}function Ox(e){return Vx(e),e}class Bx extends Sn{constructor(e){super(),this.width=new Ln(1e3,Xr),this.height=new Ln(1e3,Xr),this.changed=new kn,this.position=new Yg(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new Xg(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new om(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new pm(new sm(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){Yr(e),Ag(e,"width",this.width),Ag(e,"height",this.height),Ag(e,"position",am(this.position)),Ag(e,"orientation",this.orientation),Ag(e,"scale",this.scale),Ag(e,"zoom",am(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class _x extends Fd{constructor(e){super(((e,t)=>e.registerDisposer(e.registerDisposer(t).changed.add(this.changed.dispatch)))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){Yr(e);for(const t of f(e)){const n=new Bx(this.parentNavigationState);try{this.set(t,n.addRef()),n.restoreState(e[t])}finally{n.dispose()}}}reset(){this.clear()}toJSON(){if(0===this.size)return;const e={};for(const n of this){var t=O(n,2);const i=t[0],r=t[1];e[i]=r.toJSON()}return e}}class Fx extends Sn{constructor(e,t){super(),this.changed=new kn,this.orthographicProjection=new Vd(!1),this.type=new Ln(t,Ox),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new _x(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),"string"==typeof e?this.type.restoreState(e):(Yr(e),ns(e,"type",(e=>this.type.restoreState(e))),ns(e,"orthographicProjection",(e=>this.orthographicProjection.restoreState(e))),ns(e,"crossSections",(e=>void 0!==e&&this.crossSections.restoreState(e))))}toJSON(){const e=this.type,t=this.crossSections,n=this.orthographicProjection.toJSON();return 0===t.size&&void 0===n?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:n}}}class zx extends Sn{constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new Fx(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";const n=this.registerCancellable(mn((()=>this.updateLayout()),0));this.specification.type.changed.add(n),Cv(this.element,"toggle-orthographic-projection",(()=>this.specification.orthographicProjection.toggle())),this.registerDisposer(this.viewer.display.updateStarted.add((()=>n.flush()))),n()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){let e=this.layout;void 0!==e&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=Vx(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}const Ux=new pt;function Gx(e,t){Ux.set(e,t)}class Wx extends Error{constructor(e,t,n,i){let r=`Fetching ${Bt(e)} resulted in HTTP error ${t}`;n&&(r+=`: ${n}`),r+=".",super(r),this.name="HttpError",this.message=r,this.url=e,this.status=t,this.statusText=n,i&&(this.response=i)}static fromResponse(e){return new Wx(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let t;return t="string"==typeof e?e:e.url,new Wx(t,0,"Network or CORS error")}return t}}async function $x(e,t){let n;try{n=await fetch(e,t)}catch(i){throw Wx.fromRequestError(e,i)}if(!n.ok)throw Wx.fromResponse(n);return n}function jx(e){return e.arrayBuffer()}function Hx(e){return e.json()}async function Jx(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:id;if(r===id){const i=await $x(e,t);return await n(i)}const s=new AbortController,o=r.add((()=>s.abort()));try{const r=await $x(e,(0,i.bn)((0,i.bn)({},t),{signal:s.signal}));return await n(r)}finally{o()}}function qx(e){let t=e.match(/^([^:\/]+):\/\/([^\/]+)((?:\/.*)?)$/);if(null===t)throw new Error(`Invalid URL: ${Bt(e)}`);return{protocol:t[1],host:t[2],path:t[3]}}function Yx(e){return e instanceof Wx&&(0===e.status||403===e.status||404===e.status)}function Zx(e){return Math.min(2**e*500,5e3)*(1+Math.random())}async function Xx(e,t,n,i,r,s){let o,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:id;e:for(let c=0;;){td(a),c>1&&await new Qc((e=>setTimeout(e,Zx(c-2)))),o=await e.get(o,a);t:for(let e=0;;)try{return await Jx("function"==typeof t?t(o.credentials):t,r(o.credentials,n),i,a)}catch(l){if(l instanceof Wx){if("refresh"===s(l,o.credentials)){if(3===++c)throw l;continue e}if(32===++e)throw l;await new Qc((t=>setTimeout(t,Zx(e-1))));continue t}throw l}}}function Kx(e,t,n,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:id;return void 0===e?Jx(t,n,r,s):Xx(e,t,n,r,((e,t)=>{if(!e.accessToken)return t;const n=new Headers(t.headers);return n.set("Authorization",`${e.tokenType} ${e.accessToken}`),(0,i.bn)((0,i.bn)({},t),{headers:n})}),((e,t)=>{const n=e.status;if(401===n)return"refresh";if(504===n||503===n)return"retry";if(403===n&&!t.accessToken)return"refresh";throw e}),s)}async function Qx(e,t,n,i,r){if(!i.startsWith("/"))throw null;const s=await async function(e,t,n,i,r){const s=await Kx(e,`${t}?prefix=${encodeURIComponent(n)}&delimiter=${encodeURIComponent(i)}`,{},(e=>e.text()),r),o=(new DOMParser).parseFromString(s,"application/xml"),a=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let d=0,u=a.snapshotLength;d<u;++d)l.push(a.snapshotItem(d).textContent||"");const c=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let d=0,u=c.snapshotLength;d<u;++d)l.push(c.snapshotItem(d).textContent||"");return l}(e,n,i.substring(1),"/",r);let o=i.lastIndexOf("/");return{offset:o+t.length+1,completions:s.map((e=>({value:e.substring(o)})))}}class eC extends uw{constructor(e){super(),this.bucket=e,this.get=pw((async()=>{var e;const t=this.bucket,n=await Jx(`https://s3.amazonaws.com/${t}?location`,{},(e=>e.text())),i=(new DOMParser).parseFromString(n,"application/xml").querySelector("LocationConstraint");if(null===i)throw new Error(`Unable to determine location of S3 bucket: ${t}`);return{region:(null===(e=i.textContent)||void 0===e?void 0:e.trim())||"us-east-1"}}))}}let tC;function nC(e){return void 0===tC&&(tC=new mw,tC.register("s3",(e=>new eC(e)))),tC.getCredentialsProvider("s3",e)}function iC(e,t){return e.getCredentialsProvider("middleauthapp",new URL(t).origin)}function rC(e,t,n){const i=n.match(/^\/([^\/]+)/);if(null!==i)return typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?e.getCredentialsProvider("gcs",{bucket:i[1]}):e.getCredentialsProvider("ngauth_gcs",{authServer:t,bucket:i[1]})}function sC(e,t){const n=qx(e);switch(n.protocol){case"gs":case"gs+json":case"gs+xml":return{credentialsProvider:typeof NEUROGLANCER_PYTHON_INTEGRATION<"u"?t.getCredentialsProvider("gcs",{bucket:n.host}):void 0,url:e};case"gs+ngauth+http":return{credentialsProvider:rC(t,`http://${n.host}`,n.path),url:"gs:/"+n.path};case"gs+ngauth+https":return{credentialsProvider:rC(t,`https://${n.host}`,n.path),url:"gs:/"+n.path};case"gs+xml+ngauth+http":return{credentialsProvider:rC(t,`http://${n.host}`,n.path),url:"gs+xml:/"+n.path};case"gs+xml+ngauth+https":return{credentialsProvider:rC(t,`https://${n.host}`,n.path),url:"gs+xml:/"+n.path};case"middleauth+https":return{credentialsProvider:iC(t,e=e.substr(11)),url:e};case"s3":return{credentialsProvider:nC(n.host),url:e};default:return{credentialsProvider:void 0,url:e}}}async function oC(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:id;const s=qx(t);switch(s.protocol){case"gs":return Kx(e,`https://www.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,n,i,r);case"gs+json":return Kx(e,`https://storage.googleapis.com/storage/v1/b/${s.host}/o/${encodeURIComponent(s.path.substring(1))}?alt=media`,n,i,r);case"gs+xml":return Kx(e,`https://storage.googleapis.com/${s.host}${s.path}`,n,i,r);case"s3":return async function(e,t,n,i,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:id;const o=(await e.get()).credentials.region;return await Jx(`https://${t}.s3.${o}.amazonaws.com${n}`,i,r,s)}(e,s.host,s.path,n,i,r);default:return Kx(e,t,n,i,r)}}const aC=typeof STATE_SERVERS<"u"&&f(STATE_SERVERS).length>0;class lC extends Sn{constructor(e){if(super(),this.element=document.createElement("div"),this.button=Jv({text:"Share",title:"Share State"}),typeof STATE_SERVERS>"u")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(f(STATE_SERVERS).length>1){const n=document.createElement("select");n.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add((()=>{const t=e.selectedStateServer.value;hb(STATE_SERVERS).map((e=>e.url)).includes(t)&&(n.value=t)}))),this.registerEventListener(n,"change",(()=>{e.selectedStateServer.value=n.value}));for(let e of Cf(STATE_SERVERS)){var t=O(e,2);let i=t[0],r=t[1];const s=document.createElement("option");s.textContent=i,s.value=r.url,s.selected=!!r.default,n.appendChild(s)}this.element.appendChild(n),this.selectStateServerElement=n}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",(()=>{const t=this.selectStateServerElement?this.selectStateServerElement.value:hb(STATE_SERVERS)[0].url,n=new URL(t).protocol;var i=sC(t,yw);const r=i.url,s=i.credentialsProvider;Bp.forPromise(oC(s,r,{method:"POST",headers:{"Content-Type":"application/json"},body:Bt(e.state.toJSON())},Hx).then((e=>{const t=new URL(e);t.protocol=n;const i=`${window.location.origin}/#!${t}`;navigator.clipboard.writeText(i).then((()=>{Bp.showTemporaryMessage("Share link copied to clipboard")}))})).catch((()=>{Bp.showTemporaryMessage("Could not access state server.",4e3)})),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})}))}disposed(){this.element.remove(),super.disposed()}}function cC(e){return e.startsWith("key")?e.substring(3):e.startsWith("digit")||e.startsWith("arrow")?e.substring(5):e}function dC(e){return e.split("+").map(cC).join("+")}const uC=(0,i.bn)((0,i.bn)({},$v),{side:"left",row:1});class hC{constructor(){this.location=new jv(uC)}get changed(){return this.location.changed}toJSON(){return ps(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class pC extends sy{constructor(e,t,n,i,r){super(e,t.location),this.bindings=n,this.toolBinder=r,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});const s=document.createElement("div");s.classList.add("neuroglancer-help-body");const o=this.scroll;o.classList.add("neuroglancer-help-scroll-container"),s.appendChild(o),this.addBody(s);const a=this.registerCancellable(al((()=>this.updateView())));this.registerDisposer(r.changed.add(a)),this.registerDisposer(i.layersChanged.add(a)),this.updateView()}updateView(){const e=this.scroll,t=this.bindings,n=this.toolBinder;Rv(e);const i=new pt;function r(e,t){for(const i of e.parents)void 0!==i.label?s(i.label,i):r(i,t);for(const i of e.bindings.entries()){var n=O(i,2);const e=n[0],r=n[1],s=e.indexOf(":"),o=e.substring(s+1);t.set(o,r.action)}}function s(e,t){if(i.has(t))return;const n={label:e,entries:new pt};r(t,n.entries),i.set(t,n)}for(const h of t){var o=O(h,2);s(o[0],o[1])}const a=(t,n)=>{let i=document.createElement("h2");i.textContent=t,e.appendChild(i);for(const s of n){var r=O(s,2);const t=r[0],n=r[1];let i=document.createElement("div");i.className="dt",i.textContent=dC(t);let o=document.createElement("div");o.className="dd",o.textContent=n,e.appendChild(i),e.appendChild(o)}},l=new pt;for(const h of n.bindings){var c=O(h,2);const e=c[0],t=c[1];let n=l.get(t.layer);void 0===n&&(n=[],l.set(t.layer,n)),n.push([`shift+key${e.toLowerCase()}`,t.description])}const d=It(l.entries());d.length>0&&(d[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),d.sort(((e,t)=>e[0].managedLayer.nonArchivedLayerIndex-t[0].managedLayer.nonArchivedLayerIndex)));for(const h of d){var u=O(h,2);const e=u[0],t=u[1];t.sort(),a(`Tool bindings for layer ${e.managedLayer.nonArchivedLayerIndex+1}: ${e.managedLayer.name}`,t)}for(const h of i.values())a(h.label,h.entries)}}class fC extends Sn{constructor(e){super(),this.element=document.createElement("div"),this.parentDisposers=new pt,this.disabledValue=!1,this.opened=new kn,this.closed=new kn;const t=this.element;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),void 0!==e&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return void 0!==this.menuDisposer}registerParent(e){const t=this.parentDisposers;t.has(e)||t.set(e,bn(e,"contextmenu",(e=>{this.show(e),e.stopPropagation(),e.preventDefault()})))}show(e){if(this.disabledValue)return;this.hide();const t=this.element,n=bn(document,"mousedown",(e=>{e.target instanceof Node&&!t.contains(e.target)&&this.hide()}),!0),i=bn(document,"keydown",(e=>{"Escape"===e.code&&this.hide()}),!0);this.opened.dispatch(),function(e,t){e.style.display="block";const n=e.offsetWidth,i=e.offsetHeight,r=document.documentElement.clientWidth,s=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(r-n,t.clientX),a=document.documentElement.scrollTop+Math.min(s-i,t.clientY);e.style.left=o+"px",e.style.top=a+"px"}(t,e),this.menuDisposer=()=>{i(),n(),t.style.display="none"}}unregisterParent(e){const t=this.parentDisposers,n=t.get(e);void 0!==n&&(n(),t.delete(e))}disposed(){const e=this.parentDisposers;for(const t of e.values())t();e.clear(),Nv(this.element)}hide(){void 0!==this.menuDisposer&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}function gC(e){return function(e){return Array.prototype.map.call(e,ji).join("")}((new TextEncoder).encode(e))}function mC(e){return(new TextDecoder).decode(function(e){if(!/^(?:[0-9a-fA-F]{2})*$/.test(e))throw new Error("Invalid hex-encoded string");const t=e.length/2,n=new Uint8Array(t);for(let i=0;i<t;++i)n[i]=parseInt(e.substr(2*i,2),16);return n}(e))}function vC(e,t){if(e.startsWith(t))try{const n=mC(e.substring(t.length));return JSON.parse(n)}catch{return}}let yC;function bC(e,t){return e.dataTransfer.dropEffect=t,yC=t,t}function SC(){return yC}const wC="neuroglancer-layer\0";let xC;function CC(e,t){var n;e.dataTransfer.setData(function(e,t){return e+gC(Bt(t))}(wC,t.layers.map((e=>({name:e.name,visible:e.visible})))),Bt({layers:t.layers.map((e=>e.toJSON())),layout:t.layoutSpec})),void 0!==xC&&xC.disposer();let i,r=()=>{t.manager.unregisterDisposer(r);for(const e of t.layers)e.dispose();t.manager.dispose(),xC===i&&(xC=void 0)};xC=i={manager:t.manager.addRef(),layers:t.layers.map((e=>e.addRef())),layoutSpec:t.layoutSpec,isLayerListPanel:null!==(n=t.isLayerListPanel)&&void 0!==n&&n,disposer:r}}function kC(){if(void 0!==xC){if("move"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"none")){const e=new Rt(xC.layers);xC.manager.layerManager.filter((t=>!e.has(t)))}xC.disposer()}}function TC(e){return function(e,t){for(const n of e){const e=vC(n,t);if(void 0!==e)return{parameters:e,dragType:n}}}(e.dataTransfer.types,wC)}function EC(e){if(void 0!==xC&&xC.manager.rootLayers===e.rootLayers)return xC}class LC{initializeExternalLayers(e){const t=this.dragType;if(void 0!==t)try{var n=JSON.parse(e.dataTransfer.getData(t));const r=n.layers,s=n.layout;if(!Array.isArray(r)||this.numSourceLayers!==r.length)throw new Error("Invalid layer drop data");this.layoutSpec=s;for(const e of this.layers){var i=O(e,2);const t=i[0];PT(t,r[i[1]])}}catch{return!1}return!0}updateArchiveStates(e){const t=this.targetIsLayerListPanel,n=e.dataTransfer.dropEffect;for(const i of this.layers.keys()){let e=t;t&&!i.archived&&"copy"!==n&&this.sourceIsLayerListPanel&&(e=!1),(i.archived!==e||e&&i.visible)&&(i.archived=e,e&&(i.visible=!1),i.layerChanged.dispatch())}}get method(){return void 0!==this.sourceManager?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e||(!this.forceCopy||"copy"===e)&&(!this.moveSupported&&"move"===e)}}function IC(e,t,n){let i;i=e.shiftKey?"copy":e.ctrlKey&&n?"move":t;let r="";const s=e=>{""!==r&&(r+=", "),r+=e};return"none"!==t&&i!==t&&(e.shiftKey?s(`release SHIFT to ${t}`):s(`release CONTROL to ${t}`)),"copy"!==i&&s("hold SHIFT to copy"),"move"!==i&&n&&"move"!==t&&s("hold CONTROL to move"),{dropEffect:i,dropEffectMessage:r}}function DC(e,t,n,i){const r=EC(t);let s,o=!1;return void 0===r?s="copy":i?(r.isLayerListPanel||(o=!0),s="link"):r.manager===t&&r.isLayerListPanel===n?(s="move",o=!0):n?s="none":(r.isLayerListPanel||(o=!0),s="link"),IC(e,s,o)}function MC(e,t,n){const i=n.forceCopy,r=n.newTarget;var s=n.isLayerListPanel;const o=void 0!==s&&s,a=EC(t);if(!i&&void 0!==a){const e=!r&&a.manager===t&&(a.isLayerListPanel===o||a.isLayerListPanel),n=new LC;return n.manager=t,n.numSourceLayers=a.layers.length,n.sourceManager=a.manager,n.targetIsLayerListPanel=o,n.sourceIsLayerListPanel=a.isLayerListPanel,n.moveSupported=e,n.layers=new pt,n.forceCopy=!1,n.layoutSpec=a.layoutSpec,e?a.layers.forEach(((e,t)=>{n.layers.set(e,t)})):a.layers.forEach(((e,i)=>{(r||!t.layerManager.has(e))&&n.layers.set(e.addRef(),i)})),n}const l=TC(e);if(void 0!==l)try{const e=Jr(l.parameters,((e,n)=>{const i=ns(e,"name",es);let r=ns(e,"visible",hs);const s=new fT(i,t);return o&&(r=!1),s.visible=r,s.archived=o,[s,n]})),n=new LC;return n.numSourceLayers=e.length,n.targetIsLayerListPanel=o,n.sourceIsLayerListPanel=!1,n.sourceManager=void 0,n.moveSupported=!1,n.forceCopy=void 0!==a,n.manager=t,n.dragType=l.dragType,n.layers=new pt(e),n}catch{}}function PC(e,t){return!e.moveSupported&&(e.manager.layerManager.filter((t=>!e.layers.has(t))),void 0!==t&&e.layers.has(t))}function AC(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];function r(t,r){let s=e.dropLayers;var o=r?DC(t,e.manager,i,!1):{dropEffect:SC(),dropEffectMessage:""};const a=o.dropEffect,l=o.dropEffectMessage;if(void 0===a)return;bC(t,a);let c=!0;if(void 0===s||s.compatibleWithMethod(a)||(e.dropLayers=void 0,!PC(s,n))){if(void 0===s){if(s=e.dropLayers=MC(t,e.manager,{forceCopy:"copy"===a,newTarget:!1,isLayerListPanel:i}),void 0===s)return;c="move"===s.method}if(void 0!==n&&s.layers.has(n))return{dropLayers:s,dropEffect:a,dropEffectMessage:l};if(c){const t=e.manager.layerManager,i=new Rt;let r=Number.POSITIVE_INFINITY;const o=t.managedLayers=t.managedLayers.filter(((e,t)=>!s.layers.has(e)||(r===Number.POSITIVE_INFINITY&&(r=t),i.add(e),!1)));let a;void 0!==n?(a=o.indexOf(n),r<=a&&++a):a=o.length;for(const e of s.layers.keys())i.has(e)||s.layers.delete(e);o.splice(a,0,...s.layers.keys()),t.layersChanged.dispatch()}else{let t;void 0!==n&&(t=e.manager.layerManager.managedLayers.indexOf(n));for(const n of s.layers.keys())e.manager.add(n,t)}return{dropLayers:s,dropEffect:a,dropEffectMessage:l}}}t.addEventListener("dragenter",(t=>{void 0!==r(t,!0)?t.preventDefault():Wv(e.element,"drop")})),t.addEventListener("drop",(t=>{var n;t.preventDefault(),e.dragEnterCount=0,Wv(e.element,"drop");const i=null===(n=r(t,!1))||void 0===n?void 0:n.dropLayers;if(e.dropLayers=void 0,void 0!==i){if(!i.initializeExternalLayers(t))return void PC(i);i.updateArchiveStates(t),kC("move"===i.method?void 0:t.dataTransfer.dropEffect)}})),t.addEventListener("dragover",(t=>{const n=r(t,!0);if(void 0===n)return void Wv(e.element,"drop");const i=n.dropLayers,s=n.dropEffect,o=n.dropEffectMessage,a=i.layers.size;let l="";const c=1===i.numSourceLayers?"":"s",d=i.numSourceLayers;if("none"===s)l=`Cannot link dragged layer${c} here`;else{l=`Drop to ${s} ${d===a?`${d}`:`${a}/${d}`} layer${c}`}o&&(l+=` (${o})`),Gv(e.element,"drop",l),t.preventDefault(),t.stopPropagation()}))}function RC(e,t,n,i){t.draggable=!0,t.addEventListener("dragstart",(r=>{Gv(t,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),CC(r,{manager:e.manager,layers:[n],layoutSpec:i.getLayoutSpec(),isLayerListPanel:i.isLayerListPanel}),r.stopPropagation()})),t.addEventListener("dragend",(()=>{Wv(t,"drag"),kC()}))}function NC(e){e.element.addEventListener("dragenter",(()=>{++e.dragEnterCount})),e.element.addEventListener("dragleave",(()=>{if(0!==--e.dragEnterCount)return;Wv(e.element,"drop");const t=e.dropLayers;void 0!==t&&(PC(t),e.manager.layerManager.layersChanged.dispatch(),e.dropLayers=void 0)}))}function VC(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=Jv((0,i.bn)({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iYmluSWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iYmluSWNvblRpdGxlIj5CaW48L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0xOSA2TDUgNk0xNCA1TDEwIDVNNiAxMEw2IDIwQzYgMjAuNjY2NjY2NyA2LjMzMzMzMzMzIDIxIDcgMjEgNy42NjY2NjY2NyAyMSAxMSAyMSAxNyAyMSAxNy42NjY2NjY3IDIxIDE4IDIwLjY2NjY2NjcgMTggMjAgMTggMTkuMzMzMzMzMyAxOCAxNiAxOCAxMCIvPgo8L3N2Zz4="},e));return t.firstElementChild.style.fill="white",t}var OC=i.aV,BC=i.bp,_C=i.b4;OC(OC.S,"String",{raw:function(e){for(var t=BC(e.raw),n=_C(t.length),i=arguments.length,r=[],s=0;n>s;)r.push(String(t[s++])),s<i&&r.push(String(arguments[s]));return r.join("")}});var FC={default:i.aW.String.raw,__esModule:!0};const zC=(0,i.g)(FC),UC="neuroglancer-position",GC=yv.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),WC=[e=>e.nameElement,e=>e.coordinate,e=>e.scaleElement];function $C(e,t){const n=e.coordinateArrays[t];return void 0===n?n:""!=e.units[t]||1!==e.scales[t]?null:n}let jC=class{constructor(e,t){this.coordinateSpace=e,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.coordinateLabelWidth=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;const n=this.container,i=this.scaleElement,r=this.scaleContainer,s=this.coordinate,o=this.nameElement,a=this.nameContainer,l=this.coordinateLabel;n.title="",n.classList.add("neuroglancer-position-dimension"),n.draggable=!0,n.tabIndex=-1,n.appendChild(a),n.appendChild(i),a.appendChild(o),a.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",r.appendChild(i),o.classList.add("neuroglancer-position-dimension-name"),o.disabled=!0,o.spellcheck=!1,o.autocomplete="off",o.required=!0,o.placeholder=" ",r.classList.add("neuroglancer-position-dimension-scale-container"),i.classList.add("neuroglancer-position-dimension-scale"),i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",n.appendChild(r),n.appendChild(s),s.type="text",s.classList.add("neuroglancer-position-dimension-coordinate"),s.spellcheck=!1,s.autocomplete="off",s.pattern=zC`(-?\d+(?:\.(?:\d+)?)?)`;const c=$C(e,t);if(null!=c){let e=0;for(const t of c.labels)e=Math.max(e,t.length);this.coordinateLabelWidth=e,l.style.width=`${e+2}ch`,n.appendChild(l)}s.required=!0,s.placeholder=" ",l.classList.add("neuroglancer-position-dimension-coordinate-label")}};function HC(e,t,n,i){return Math.floor((e-t)*(i-1)/(n-t))}function JC(e,t){Vv(e,t.length+1)}function qC(e){const t=e.value;Vv(e),e.parentElement.dataset.isEmpty=""===t?"true":"false"}class YC extends Sn{constructor(e,t){let{copyButton:n=!0}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new pt,this.dimensionWidgetList=[],this.dragSource=void 0;const i=this.element,r=this.dimensionContainer;if(this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(al((()=>this.updateDimensions()))))),i.className="neuroglancer-position-widget",r.style.display="contents",i.appendChild(r),n){const t=dy({title:"Copy position to clipboard",onClick:()=>{const e=ay(this.getPositionText());Bp.showTemporaryMessage(e?"Position copied to clipboard":"Failed to copy position to clipboard")}});t.addEventListener("dragstart",(t=>{t.dataTransfer.setData(UC,Bt({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),t.dataTransfer.setData("text",this.getPositionText()),t.stopPropagation()})),t.draggable=!0,i.appendChild(t)}this.registerDisposer(e.changed.add(this.registerCancellable(al((()=>this.updateView())))));this.registerDisposer(new tS(i,GC)).allShortcutsAreGlobal=!0,this.registerDisposer(new ly(i,GC)),this.registerDisposer(Cv(i,"cancel",(e=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();const t=e.target;t instanceof HTMLElement&&t.blur()}))),this.updateView()}openRegularDropdown(e,t){t.classList.add("neuroglancer-position-dimension-dropdown");const n=document.createElement("canvas"),i=n.getContext("2d"),r=document.createElement("div"),s=document.createElement("div");s.appendChild(r);const o=document.createTextNode("");r.appendChild(o);const a=document.createElement("div"),l=document.createElement("div");s.classList.add("neuroglancer-position-dimension-dropdown-lowerbound"),a.classList.add("neuroglancer-position-dimension-dropdown-upperbound"),l.classList.add("neuroglancer-position-dimension-dropdown-hoverposition"),t.appendChild(s),t.appendChild(a),t.appendChild(l),t.appendChild(n);const c=100;let d,u,h;n.width=35,n.height=c,a.style.marginTop="99px";const p=()=>{const s=this.dimensionWidgetList.indexOf(e);if(-1===s)return;const p=e.coordinateSpace,f=function(e,t,n){const i=e.boundingBoxes,r=e.bounds,s=Math.floor(r.lowerBounds[t]),o=Math.ceil(r.upperBounds[t]-1);if(!Sr(s)||!Sr(o))return;const a=[],l=e=>HC(e,s,o,n),c=e.rank;for(const d of i){const e=ha(d,t,c);void 0!==e&&(e.lower=l(e.lower),e.upper=l(Math.ceil(e.upper-1)),a.push(e))}return a.sort(((e,t)=>{const n=e.lower-t.lower;return 0!==n?n:t.upper-t.upper})),_t(a,((e,t)=>{if(0===t)return!0;const n=a[t-1];return n.lower!==e.lower||n.upper!==e.upper})),{lowerBound:s,upperBound:o,normalizedBounds:a}}(p,s,c);if(void 0===f||p.bounds.lowerBounds[s]+1===p.bounds.upperBounds[s])return t.style.display="none",void(e.container.dataset.dropdownVisible=void 0);e.container.dataset.dropdownVisible="true",t.style.display="";const g=f.lowerBound,m=f.upperBound;d=g,u=m,o.textContent=g.toString(),a.textContent=m.toString(),function(e,t,n){t.clearRect(0,0,e.width,e.height);const i=n.normalizedBounds;function r(e){t.fillRect(0,e,10,1)}t.fillStyle="#fff";for(const a of i){const e=a.lower,t=a.upper;r(e),r(t)}const s=i.length;t.fillStyle="#ccc";for(let a=0;a<s;++a){var o=i[a];const e=o.lower,n=o.upper,r=Math.floor(15*a/s),l=Math.max(1,15/s);t.fillRect(r+10,e,l,n+1-e)}}(n,i,f);const v=this.position.value[s];if(v>=g&&v<=m&&(i.fillStyle="#f66",i.fillRect(0,HC(v,g,m,c),35,1)),void 0!==h&&h>=g&&h<=m){i.fillStyle="#66f";const e=HC(h,g,m,c);i.fillRect(0,e,35,1),l.textContent=h.toString();const t=r.clientHeight;r.style.visibility=e>t?"":"hidden",a.style.visibility=e<c-t?"":"hidden",l.style.display="",l.style.visibility="visible",l.style.marginTop=`${e}px`}else r.style.visibility="",l.style.display="none",a.style.visibility=""},f=e.dropdownOwner,g=f.registerCancellable(al(p));f.registerDisposer(this.position.changed.add(g));const m=e=>{if(void 0===d||void 0===u)return;const t=n.getBoundingClientRect();let i=(e.clientY-t.top)/t.height;return i=Math.max(0,i),i=Math.min(1,i),Math.round(i*(u-d))+d},v=t=>{const n=this.dimensionWidgetList.indexOf(e);if(-1===n)return;const i=m(t);if(void 0===i)return;const r=this.position,s=r.value;s[n]=i+.5,e.modified=!1,r.value=s};n.addEventListener("pointermove",(e=>{h=m(e),g()})),n.addEventListener("pointerleave",(()=>{h=void 0,g()})),n.addEventListener("pointerdown",(t=>{t.preventDefault(),t.stopPropagation(),!(t.ctrlKey||t.altKey||t.shiftKey||t.metaKey)&&(Hv(t,(t=>{void 0!==e.dropdownOwner&&(h=void 0,v(t),g(),e.draggingPosition=!0)}),(()=>{e.draggingPosition=!1,this.updateDropdownVisibility(e)})),v(t))})),p()}openCoordinateArrayDropdown(e,t,n){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");const i=n.coordinates,r=n.labels,s=i.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let o=0;o<s;++o){const n=document.createElement("div");n.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");const s=document.createElement("div");s.classList.add("neuroglancer-dimension-dropdown-coordinate");const a=document.createElement("div");a.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),a.textContent=r[o],s.textContent=i[o].toString(),n.appendChild(s),n.appendChild(a),n.addEventListener("click",(()=>{const t=this.dimensionWidgetList.indexOf(e);if(-1===t)return;const n=this.position,r=n.value;r[t]=i[o]+.5,e.modified=!1,n.value=r})),t.appendChild(n)}}openDropdown(e){if(void 0!==e.dropdownOwner)return;const t=this.dimensionWidgetList.indexOf(e);if(-1===t)return;this.closeDropdown();const n=e.dropdownOwner=new Sn,i=document.createElement("div");i.draggable=!0,i.addEventListener("dragstart",(e=>{e.stopPropagation(),e.preventDefault()})),i.addEventListener("pointerenter",(()=>{e.hasFocus=!0})),i.tabIndex=-1,e.container.appendChild(i);const r=$C(e.coordinateSpace,t);null==r?this.openRegularDropdown(e,i):this.openCoordinateArrayDropdown(e,i,r),this.widgetWithOpenDropdown=e,n.registerDisposer((()=>{Nv(i),e.dropdownOwner=void 0,delete e.container.dataset.dropdownVisible,this.widgetWithOpenDropdown=void 0})),n.registerEventListener(document,"pointerdown",(t=>{const n=t.target;n instanceof Node&&e.container.contains(n)||this.closeDropdown(e)}),{capture:!0})}closeDropdown(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.widgetWithOpenDropdown;if(void 0===e)return;const t=e.dropdownOwner;void 0!==t&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();const n=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(null===n)break;if(void 0!==n[1]&&document.execCommand("insertText",void 0,n[1]),void 0===n[2])break;{const i=this.dimensionWidgetList,r=i.indexOf(e);if(-1===r||r+1===i.length)break;const s=t.substring(n[0].length);e=i[r+1],t=s}}}reorderDimensionTo(e,t){if(e===t)return;const n=this.position.coordinateSpace;n.value=Ba(n.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t){const n=new jC(e,t);n.container.addEventListener("dragstart",(e=>{this.dragSource=n,e.stopPropagation(),e.dataTransfer.setData("neuroglancer-dimension","")})),n.container.addEventListener("dragenter",(e=>{const t=this.dragSource;if(void 0===t||t===n)return;const i=this.dimensionWidgetList,r=i.indexOf(t),s=i.indexOf(n);-1===r||-1===s||(e.preventDefault(),this.reorderDimensionTo(s,r))})),n.container.addEventListener("dragend",(e=>{this.dragSource===n&&(this.dragSource=void 0)})),n.nameContainer.addEventListener("dblclick",(()=>{n.nameElement.disabled=!1,n.nameElement.focus(),n.nameElement.select()})),n.scaleContainer.addEventListener("dblclick",(()=>{n.scaleElement.disabled=!1,n.scaleElement.focus(),n.scaleElement.select()})),n.coordinate.addEventListener("focus",(()=>{n.coordinate.select()})),n.container.addEventListener("focusin",(()=>{n.hasFocus=!0,this.updateDropdownVisibility(n)})),n.container.addEventListener("focusout",(e=>{const t=e.relatedTarget;t instanceof Node&&n.container.contains(t)||(n.hasFocus=!1,this.updateDropdownVisibility(n))})),n.container.addEventListener("click",(e=>{(!(e.target instanceof HTMLInputElement)||e.target.disabled)&&n.coordinate.focus()})),n.coordinate.addEventListener("paste",(e=>{const t=n.coordinate,i=t.value,r=e.clipboardData;if(null===r)return;let s=r.getData("text"),o=t.selectionEnd,a=t.selectionStart;if(0!==a||o!==i.length){null==a&&(a=0),null==o&&(o=0);const e=s.match(/[^\-0-9\.]/);null!==e&&(s=s.substring(0,e.index)),s.length>0&&document.execCommand("insertText",void 0,s)}else this.pasteString(n,s);e.preventDefault(),e.stopPropagation()})),n.coordinate.addEventListener("input",(()=>{n.modified=!0;const e=n.coordinate,t=e.value;let i=e.selectionDirection,r=e.selectionEnd,s=e.selectionStart;null===s&&(s=0),null===r&&(r=s);let o="";const a=/[^\-0-9\.]/g;o+=t.substring(0,s).replace(a,"");const l=o.length;o+=t.substring(s,r).replace(a,"");const c=o.length;o+=t.substring(r).replace(a,""),e.value=o,e.selectionStart=l,e.selectionEnd=c,e.selectionDirection=i,JC(e,o),r===s&&r===t.length&&t.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(n,1)})),n.nameElement.addEventListener("input",(()=>{Vv(n.nameElement),this.updateNameValidity()})),n.scaleElement.addEventListener("input",(()=>{qC(n.scaleElement),this.updateScaleValidity(n)})),n.coordinate.addEventListener("blur",(e=>{const t=e.relatedTarget;this.dimensionWidgetList.some((e=>e.coordinate===t))||n.modified&&this.updatePosition()})),n.nameElement.addEventListener("blur",(e=>{n.nameElement.disabled=!0;const t=e.relatedTarget;this.dimensionWidgetList.some((e=>e.nameElement===t))||this.updateNames()||this.forceUpdateDimensions()})),n.scaleElement.addEventListener("blur",(e=>{n.scaleElement.disabled=!0;const t=e.relatedTarget;this.dimensionWidgetList.some((e=>e.scaleElement===t))||this.updateScales()||this.forceUpdateDimensions()})),Cv(n.container,"adjust-via-wheel",(e=>{const t=e.detail.deltaY;0!==t&&this.adjustDimension(n,ug(t))})),Cv(n.container,"adjust-up",(()=>{this.adjustDimension(n,-1)})),Cv(n.container,"adjust-down",(()=>{this.adjustDimension(n,1)}));for(const i of WC){const e=i(n);Cv(e,"maybe-tab-forward",(e=>{this.handleLeftRightMovement(e,n,1,i)})),Cv(e,"maybe-tab-backward",(e=>{this.handleLeftRightMovement(e,n,-1,i)})),Cv(e,"tab-forward",(()=>{this.selectAdjacentField(n,1,i)})),Cv(e,"tab-backward",(()=>{this.selectAdjacentField(n,-1,i)}))}return Cv(n.coordinate,"commit",(()=>{this.updatePosition()})),Cv(n.nameElement,"commit",(()=>{this.updateNames()})),Cv(n.scaleElement,"commit",(()=>{this.updateScales()})),Cv(n.coordinate,"delete-backward",(e=>{e.stopPropagation();const t=n.coordinate;t.selectionStart===t.selectionEnd&&0===t.selectionStart&&(e.preventDefault(),this.selectAdjacentCoordinate(n,-1))})),n}forceUpdateDimensions(){let e=this.position.coordinateSpace.value;e.valid||(e=ra),this.coordinateSpace=e;const t=this.dimensionWidgets,n=this.dimensionWidgetList;n.length=0;var i=e;const r=i.names,s=i.ids,o=i.scales,a=i.units;Ov(this.dimensionContainer,s.map(((i,s)=>{let l=t.get(i);void 0===l?(l=this.newDimension(e,s),t.set(i,l)):l.coordinateSpace=e;const c=r[s];l.nameElement.value=c,delete l.nameElement.dataset.isValid,Vv(l.nameElement);const d=$C(e,s);l.container.dataset.coordinateArray=void 0===d?"none":null===d?"invalid":"valid",l.scaleContainer.title="Drag to reorder, double click to change scale",null===d&&(l.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");var u=_o(o[s],a[s]);const h=`${u.scale}${u.prefix}${u.unit}`;return l.scaleElement.value=h,delete l.scaleElement.dataset.isValid,qC(l.scaleElement),n.push(l),l.container})));for(const c of t){var l=O(c,2);const n=l[0],i=l[1];i.coordinateSpace!==e&&(this.closeDropdown(i),t.delete(n))}}updateDimensions(){this.position.coordinateSpace.value!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,n){const i=this.dimensionWidgetList;let r=i.indexOf(e);if(-1!==r)for(;;){if(r+=t,r<0||r>=i.length)return!1;const e=n(i[r]);if("none"!==e.style.display)return e.disabled=!1,e.focus(),e.selectionStart=0,e.selectionEnd=e.value.length,e.selectionDirection=1===t?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,(e=>e.coordinate))}handleLeftRightMovement(e,t,n,i){e.stopPropagation();const r=i(t);r.selectionStart!==r.selectionEnd||r.selectionStart!==(1===n?r.value.length:0)||this.selectAdjacentField(t,n,i)&&e.preventDefault()}updateNameValidity(){const e=this.dimensionWidgetList,t=e.map((e=>e.nameElement.value)),n=t.length,i=this.combiner.getRenameValidity(t);for(let r=0;r<n;++r)e[r].nameElement.dataset.isValid=!1===i[r]?"false":"true"}updateScaleValidity(e){const t=void 0!==zo(e.scaleElement.value);e.scaleElement.dataset.isValid=t.toString()}adjustDimension(e,t){const n=this.dimensionWidgetList.indexOf(e);if(-1===n)return;this.updatePosition();const i=this.position;if(!i.valid)return;const r=i.coordinateSpace.value.bounds,s=Float32Array.from(i.value);let o=Math.floor(s[n]+t);if(t>0){const e=r.upperBounds[n];Sr(e)&&(o=Math.min(o,Math.ceil(e-1)))}else{const e=r.lowerBounds[n];Sr(e)&&(o=Math.max(o,Math.floor(e)))}s[n]=o+.5,this.position.value=s,this.updateView()}updatePosition(){const e=this.dimensionWidgetList,t=this.position,n=t.value;if(void 0===n)return;const i=e.length;for(let r=0;r<i;++r){const t=e[r];t.modified=!1;const i=Number(t.coordinate.value);Sr(i)&&(n[r]=i+(mr(i)?.5:0))}t.value=n}updateNames(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,n=t.value,r=e.map((e=>e.nameElement.value));if(this.combiner.getRenameValidity(r).includes(!1))return!1;const s=n.names;if(Ut(s,r))return!1;const o=n.timestamps.map(((e,t)=>s[t]===r[t]?e:Date.now())),a=(0,i.bn)((0,i.bn)({},n),{names:r,timestamps:o});return t.value=a,!0}updateScales(){const e=this.dimensionWidgetList,t=this.position.coordinateSpace,n=t.value,i=e.map((e=>zo(e.scaleElement.value)));if(i.includes(void 0))return!1;const r=Float64Array.from(i,(e=>e.scale)),s=It(i,(e=>e.unit)),o=n.scales,a=n.units;if(Ut(o,r)&&Ut(a,s))return!1;const l=n.timestamps.map(((e,t)=>r[t]===o[t]&&s[t]===a[t]?e:Date.now())),c=ia({valid:n.valid,rank:n.rank,scales:r,units:s,timestamps:l,ids:n.ids,names:n.names,boundingBoxes:n.boundingBoxes,coordinateArrays:n.coordinateArrays});return t.value=c,!0}getPositionText(){const e=this.position;return e.valid?e.value.map((e=>Math.floor(e))).join(", "):""}updateView(){this.updateDimensions();const e=this.position.value,t=this.dimensionWidgetList,n=t.length;if(void 0===e)return;const i=this.coordinateSpace;for(let r=0;r<n;++r){const n=t[r],s=n.coordinate,o=Math.floor(e[r]),a=o.toString();JC(s,a),s.value=a;const l=$C(i,r);let c="";if(null!=l){const e=l.coordinates,t=zt(e,o,((e,t)=>e-t));t!==e.length&&(c=l.labels[t])}n.coordinateLabel.textContent=c}}disposed(){this.closeDropdown(),Nv(this.element),super.disposed()}}class ZC extends Sn{constructor(e,t,n){super(),this.element=e,this.mouseState=t,this.coordinateSpace=n,this.tempPosition=ti(),e.className="neuroglancer-mouse-position-widget";const i=this.registerCancellable(al((()=>this.updateView())));this.registerDisposer(t.changed.add(i)),this.registerDisposer(n.changed.add(i))}updateView(){let e="";const t=this.mouseState,n=this.coordinateSpace.value;if(t.active&&void 0!==n){const i=t.position,r=n.rank,s=n.names;for(let t=0;t<r;++t)0!==t&&(e+="  "),e+=`${s[t]} ${Math.floor(i[t])}`}this.element.textContent=e}disposed(){Nv(this.element),super.disposed()}}class XC extends Sn{constructor(e,t){var n;super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";const r=this.element,s=this.labelElement,o=this.layerNumberElement,a=this.valueElement,l=this.visibleProgress,c=this.prefetchProgress,d=this.labelElementText;r.className="neuroglancer-layer-item neuroglancer-noselect",r.appendChild(l),r.appendChild(c),s.className="neuroglancer-layer-item-label",s.appendChild(d),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",o.className="neuroglancer-layer-item-number",a.className="neuroglancer-layer-item-value";const u=document.createElement("div");u.className="neuroglancer-layer-item-value-container";const h=document.createElement("div");h.className="neuroglancer-layer-item-button-container";const p=qv();p.title="Remove layer from this layer group";const f=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0icmVmcmVzaEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9InJlZnJlc2hJY29uVGl0bGUiPlJlZnJlc2g8L3RpdGxlPiAgICAKICAgIDxwb2x5bGluZSBwb2ludHM9IjIyIDEyIDE5IDE1IDE2IDEyIi8+CiAgICA8cGF0aCBkPSJNMTEsMjAgQzYuNTgxNzIyLDIwIDMsMTYuNDE4Mjc4IDMsMTIgQzMsNy41ODE3MjIgNi41ODE3MjIsNCAxMSw0IEMxNS40MTgyNzgsNCAxOSw3LjU4MTcyMiAxOSwxMiBMMTksMTQiLz4KPC9zdmc+"},e))}();f.title="Refresh data",this.registerEventListener(f,"click",(e=>{e.stopPropagation();const t=this.layer.layer;if(t&&t.dataSources&&t.dataSources[0].loadState){const e=t.dataSources[0].loadState;if(e instanceof eg){const t=e.dataSource;if(t&&t.subsources[0]&&t.subsources[0].subsource){const e=t.subsources[0].subsource.annotation;e?.invalidateCache&&e.invalidateCache()}}}})),p.addEventListener("click",(e=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),e.stopPropagation()}));const g=VC();g.title="Delete this layer",g.addEventListener("click",(e=>{$T(this.layer),e.stopPropagation()})),r.appendChild(o),u.appendChild(a),u.appendChild(h),h.appendChild(p),h.appendChild(g),r.appendChild(s),!(null===(n=e.layer)||void 0===n)&&n.allowingRefresh&&r.appendChild(f),r.appendChild(u);const m=this.registerDisposer(new YC(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1}));r.appendChild(m.element),m.element.addEventListener("click",(e=>{e.stopPropagation()})),m.element.addEventListener("dblclick",(e=>{e.stopPropagation()})),r.addEventListener("click",(n=>{n.ctrlKey?t.selectedLayer.toggle(e):n.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)})),r.addEventListener("contextmenu",(n=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,n.stopPropagation(),n.preventDefault()})),RC(t,r,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),AC(this.panel,r,this.layer)}update(){const e=this.layer,t=this.element;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let n=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(n+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),n+=", drag to move, shift+drag to copy",t.title=n}disposed(){this.element.remove(),super.disposed()}}class KC extends Sn{constructor(e,t,n,i,r,s){super(),this.display=e,this.manager=t,this.viewerNavigationState=n,this.selectedLayer=i,this.getLayoutSpecForDrag=r,this.showLayerHoverValues=s,this.layerWidgets=new pt,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.positionWidget=this.registerDisposer(new YC(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner)),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable(al((()=>this.update()))),this.registerDisposer(i);const o=this.element;o.className="neuroglancer-layer-panel",this.registerDisposer(t.layerSelectedValues.changed.add((()=>{this.handleLayerValuesChanged()}))),this.registerDisposer(t.layerManager.layersChanged.add((()=>{this.handleLayersChanged()}))),this.registerDisposer(i.changed.add((()=>{this.handleLayersChanged()}))),this.registerDisposer(s.changed.add((()=>{this.handleLayerItemValueChanged()}))),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);let a=Jv({svg:Zb,title:"Click to add layer, control+click/right click/\u2318+click to add local annotation layer."});a.classList.add("neuroglancer-layer-add-button");let l=this.dropZone=document.createElement("div");l.className="neuroglancer-layer-panel-drop-zone";const c=e=>{if(e.ctrlKey||e.metaKey||"contextmenu"===e.type){const e=AT(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(e),this.selectedLayer.layer=e,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(a,"click",c),this.registerEventListener(a,"contextmenu",c),o.appendChild(a),o.appendChild(l),this.registerDisposer(function(e){return e.draggable=!0,bn(e,"dragstart",(e=>{e.stopPropagation(),e.preventDefault()}))}(a)),o.appendChild(this.positionWidget.element);const d=()=>{const e=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=e===Bg.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(d)),d(),this.update(),this.updateChunkStatistics(),NC(this),AC(this,l,void 0),this.registerDisposer(e.updateStarted.add((()=>this.updateLayers()))),this.registerDisposer(t.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(al((()=>this.updateChunkStatistics())))))}get layerManager(){return this.manager.layerManager}disposed(){this.layerWidgets.forEach((e=>e.dispose())),this.layerWidgets=void 0,Nv(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),!1===this.showLayerHoverValues.value)return;let e=this.manager.layerSelectedValues;for(let n of this.layerWidgets){var t=O(n,2);let i=t[0],r=t[1],s=i.layer,o="";if(null!==s){let t=e.get(s);if(void 0!==t){const e=t.value;void 0!==e&&(o=""+e)}}if(o!==r.prevValueText){if(r.prevValueText=o,o.length>r.maxLength){const e=r.maxLength=o.length;r.valueElement.style.width=`${e}ch`}r.valueElement.textContent=o}}}updateChunkStatistics(){for(const t of this.layerWidgets){var e=O(t,2);const n=e[0],i=e[1];let r=0,s=0,o=0,a=0;const l=n.layer;if(null!==l)for(const e of l.renderLayers){const t=e.layerChunkProgressInfo;r+=t.numVisibleChunksNeeded,s+=t.numVisibleChunksAvailable,o+=t.numPrefetchChunksNeeded,a+=t.numPrefetchChunksAvailable}i.visibleProgress.style.width=s/Math.max(1,r)*100+"%",i.prefetchProgress.style.width=a/Math.max(1,o)*100+"%"}}updateLayers(){var e;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;let t=this.element,n=new Rt,i=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(const s of this.manager.layerManager.managedLayers){if(s.archived&&(null===(e=this.dropLayers)||void 0===e||!e.layers.has(s)))continue;n.add(s);let r=this.layerWidgets.get(s);const o=s.nonArchivedLayerIndex;void 0===r&&(r=new XC(s,this),this.layerWidgets.set(s,r)),r.layerNumberElement.textContent=""+(1+o),r.update();let a=r.element;a!==i&&t.insertBefore(r.element,i),i=a.nextElementSibling}for(let s of this.layerWidgets){var r=O(s,2);let e=r[0],t=r[1];n.has(e)||(this.layerWidgets.delete(e),t.dispose())}}addLayerMenu(){ZT(this.manager,this.selectedLayer)}}function QC(e,t){const n=bn(e,"drop",(e=>{if(e.preventDefault(),-1!==e.dataTransfer.types.indexOf(UC)){e.stopPropagation();const n=Yr(JSON.parse(e.dataTransfer.getData(UC))),i=ns(n,"dimensions",Ma),r=ns(n,"position",(e=>Jr(e,Tr)));if(r.length!==i.length)throw new Error("length mismatch between position and dimensions");const s=r.length,o=t.coordinateSpace.value.names,a=t.value;for(let e=0;e<s;++e){const t=o.indexOf(i[e]);-1!==t&&(a[t]=r[e])}t.changed.dispatch()}})),i=e=>{-1!==e.dataTransfer.types.indexOf(UC)&&(e.dataTransfer.dropEffect="link",e.preventDefault(),e.stopPropagation())},r=bn(e,"dragenter",i),s=bn(e,"dragover",i);return()=>{r(),s(),n()}}class ek extends Sn{constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new pt;const t=this.element,n=this.valueIndexMap;let i=0;for(const r of f(e.enumType))if(isNaN(Number(r))){const s=document.createElement("option");s.textContent=s.value=r.toLowerCase(),t.appendChild(s),n.set(e.enumType[r],i),++i}this.registerDisposer(e.changed.add((()=>this.updateView()))),this.registerEventListener(t,"change",(()=>this.updateModel())),this.registerEventListener(t,"wheel",(e=>{e.preventDefault(),e.stopPropagation(),this.adjustViaWheel(e)})),this.updateView()}adjustViaWheel(e){const t=this.element;let n=e.deltaY;n>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):n<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){this.element.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}const tk="neuroglancer-layer-group-viewer";function nk(e){return-1!==e.dataTransfer.types.indexOf(tk)}let ik;function rk(e,t){const n=function(e){if(ik&&ik.viewer.layerSpecification.rootLayers===e.rootLayers)return ik.viewer}(t);let i,r=!1;return void 0===n||n.layerSpecification===n.layerSpecification.root?i="copy":(r=!0,i="move"),IC(e,i,r)}class sk extends Sn{constructor(e){super(),this.relativeDisplayScales=new em(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new rm(e.navigationState.pose.displayDimensions.addRef()),this.position=new Yg(e.navigationState.position.addRef()),this.crossSectionOrientation=new Xg(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new nm(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new om(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new hm(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new hm(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new pm(new sm(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new Xg(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new om(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new pm(new sm(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(const e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",am(this.position)),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}class ok extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.element=e,this.viewerState=t,this.state=new Rg,this.options=(0,i.bn)({showLayerPanel:new Vd(!0),showViewerMenu:!1,showLayerHoverValues:new Vd(!0)},n),this.layerSpecification=this.registerDisposer(t.layerSpecification),this.viewerNavigationState=this.registerDisposer(new sk(t)),this.viewerNavigationState.register(this.state),this.layerSpecification instanceof VT?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map((e=>e.name)),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new Dw(e)),this.layout=this.registerDisposer(new zx(this,"xy")),this.state.add("layout",this.layout),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(QC(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable(mn((()=>this.updateUI()),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(Cv(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",(()=>{this.layerPanel&&this.layerPanel.addLayerMenu()})),this.bindAction("t-",(()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)})),this.bindAction("t+",(()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)}))}toJSON(){return(0,i.bn)({type:"viewer"},this.state.toJSON())}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),Ag(e,"crossSectionZoom",am(this.viewerNavigationState.crossSectionScale)),Ag(e,"perspectiveZoom",am(this.viewerNavigationState.projectionScale)),Ag(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){const e=this.options,t=e.showLayerPanel.value;if(void 0!==this.layerPanel&&!t)return this.layerPanel.dispose(),void(this.layerPanel=void 0);if(t&&void 0===this.layerPanel){const t=this.layerPanel=new KC(this.display,this.layerSpecification,this.viewerNavigationState,this.viewerState.selectedLayer.addRef(),(()=>this.layout.toJSON()),this.options.showLayerHoverValues);if(e.showViewerMenu?(t.registerDisposer(function(e,t){const n=new fC(e),i=n.element;i.classList.add("neuroglancer-layer-group-viewer-context-menu");const r=document.createElement("button");r.textContent="Remove layer group",i.appendChild(r),n.registerEventListener(r,"click",(()=>{t.layerSpecification.layerManager.clear()}));const s=t.viewerNavigationState;for(const a of[["Render scale factors",s.relativeDisplayScales.link],["Render dimensions",s.displayDimensions.link],["Position",s.position.link],["Cross-section orientation",s.crossSectionOrientation.link],["Cross-section zoom",s.crossSectionScale.link],["Cross-section depth range",s.crossSectionDepthRange.link],["3-D projection orientation",s.projectionOrientation.link],["3-D projection zoom",s.projectionScale.link],["3-D projection depth range",s.projectionDepthRange.link]]){var o=O(a,2);const e=o[0],t=o[1],r=n.registerDisposer(new ek(t)),s=document.createElement("label");s.style.display="flex",s.style.flexDirection="row",s.style.whiteSpace="nowrap",s.textContent=e,s.appendChild(r.element),i.appendChild(s)}return n}(t.element,this)),t.element.title="Right click for options, drag to move/copy layer group."):t.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS<"u"&&!0===NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS){{const e=document.createElement("button");e.textContent="Clear segments",e.title='De-select all objects ("x")',e.addEventListener("click",(e=>{bv(e,e,{action:"clear-segments"})})),t.element.appendChild(e)}for(const e of["3d","xy","xz","yz"]){const n=document.createElement("button");n.textContent=e,n.title=`Switch to ${e} layout`,n.addEventListener("click",(()=>{let t;t=this.layout.name===e?"3d"!==e?`${e}-3d`:"4panel":e,this.layout.name=t})),t.element.appendChild(n)}}t.element.draggable=!0;const n=t.element;n.addEventListener("dragstart",(e=>{Gv(t.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),CC(e,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});const n=()=>{ik&&ik.viewer===this&&(ik=void 0),this.unregisterDisposer(n)};ik={viewer:this,disposer:n},this.registerDisposer(n);const i=this.toJSON();delete i.layers,e.dataTransfer.setData(tk,Bt(i)),t.element.style.backgroundColor="black",setTimeout((()=>{t.element.style.backgroundColor=""}),0)})),t.element.addEventListener("dragend",(()=>{Wv(n,"drag"),kC(),void 0!==ik&&ik.viewer===this&&ik.disposer()})),this.element.insertBefore(n,this.element.firstChild)}}disposed(){Rv(this.element);const e=this.layerPanel;void 0!==e&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}const ak=(0,i.bu)("layoutComponentContainer");class lk extends Sn{constructor(e,t,n){super(),this.viewer=e,this.parent=n,this.changed=new kn,this.element=document.createElement("div");const i=this.element;i.style.display="flex",i.style.flex="1",i.style.position="relative",i.style.alignItems="stretch",i[ak]=this,this.setSpecification(t);const r=[],s=e=>{const t=document.createElement("div");let n;switch(t.className="neuroglancer-layout-split-drop-zone",t.style[e]="0",e){case"left":case"right":n="row",t.style.width="10px",t.style.height="100%";break;case"top":case"bottom":n="column",t.style.height="10px",t.style.width="100%"}t.style.display="none",r.push({element:t,direction:n,orientation:e}),i.appendChild(t),uk(t,this.viewer.layerSpecification,(()=>this.split(e).newContainer.component),"row"===n?"column":"row")};s("left"),s("right"),s("top"),s("bottom");let o=!1;i.addEventListener("dragenter",(e=>{if(!o&&void 0!==TC(e)){o=!0;for(const e of r){const t=e.element,i=e.direction,r=e.orientation;if(void 0!==n&&i===n.direction&&(("left"===r||"top"===r)&&n.get(0)!==this||("bottom"===r||"right"===r)&&n.get(n.length-1)!==this))continue;const s=this.component;s instanceof hk&&s.direction===i||(t.style.display="block")}}}),!0),i.addEventListener("drop",(e=>{if(o){o=!1;for(const e of r){e.element.style.display="none"}}}),!0),i.addEventListener("dragleave",(e=>{const t=e.relatedTarget;if(o&&!(t instanceof HTMLElement&&this.element.contains(t))){o=!1;for(const e of r){e.element.style.display="none"}}}),!0)}unsetComponent(){const e=this.componentValue;void 0!==e&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof ok){const t=e.layerManager,n=e.registerCancellable(mn((()=>{0===t.managedLayers.length&&this.dispose()}),0));e.registerDisposer(t.layersChanged.add((()=>{0===t.managedLayers.length&&n()}))),n()}else if(e instanceof hk){const t=e.registerCancellable(mn((()=>{const t=e.length;if(0===t&&void 0!==this.parent)this.dispose();else if(1===t){const t=e.get(0).component;let n;if(void 0===this.parent&&t instanceof ok){n=t.layout.specification.toJSON(),t.viewerNavigationState.copyToParent();const e=t.layerManager.managedLayers,i=new Rt(e),r=t.layerSpecification;r.rootLayers.filter((e=>i.has(e)||e.archived));const s=[],o=r.rootLayers.managedLayers;for(let t=0,n=o.length;t<n;++t)i.has(o[t])&&s.push(t);for(let t=0,n=e.length;t<n;++t)o[s[t]]=e[t];r.rootLayers.layersChanged.dispatch()}else n=t.toJSON();this.setSpecification(n)}}),0));e.registerDisposer(e.changed.add((()=>{e.length<2&&t()}))),t()}this.changed.dispatch()}toJSON(){return this.component.toJSON()}setSpecification(e){this.setComponent(function(e,t){const n=document.createElement("div");if(n.style.flex="1",n.style.width="0px","string"==typeof t){if(void 0!==e.parent)throw new Error(`Invalid layout component specification: ${Bt(t)}`);return new dk(n,t,e.viewer)}Yr(t);const r=ns(t,"type",es);switch(r){case"row":case"column":return new hk(n,r,ns(t,"children",(t=>{const n=Jr(t,(e=>e));if(void 0===e.parent&&0===n.length)throw new Error("Stack layout requires at least one child.");return n})),e);case"viewer":{const r=e.viewer,o=new VT(r.layerSpecification.addRef()),a=new ok(n,(0,i.bn)({display:r.display,layerSpecification:o},ck(r)),{showLayerPanel:r.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:r.uiControlVisibility.showLayerHoverValues});try{a.restoreState(t)}catch(s){throw a.dispose(),s}return a}default:return new dk(n,t,e.viewer)}}(this,e))}static getFromElement(e){return e[ak]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){const t={type:"viewer"},n=this.parent;if(void 0!==n){if("left"===e&&"row"===n.direction||"top"===e&&"column"===n.direction)return{newContainer:n.insertChild(t,this),existingContainer:this};if("right"===e&&"row"===n.direction||"bottom"===e&&"column"===n.direction)return{newContainer:n.insertChild(t),existingContainer:this}}let i;const r=this.component;let s,o;i=r instanceof dk?r.layerGroupViewer.toJSON():r.toJSON();const a="left"===e||"right"===e?"row":"column";switch(e){case"left":case"top":s={type:a,children:[t,i]},o=0;break;case"right":case"bottom":s={type:a,children:[i,t]},o=1}this.setSpecification(s);const l=this.component;return{newContainer:l.get(o),existingContainer:l.get(1-o)}}}function ck(e){return{mouseState:e.mouseState,showAxisLines:e.showAxisLines,wireFrame:e.wireFrame,showScaleBar:e.showScaleBar,scaleBarOptions:e.scaleBarOptions,showPerspectiveSliceViews:e.showPerspectiveSliceViews,inputEventBindings:e.inputEventBindings,visibility:e.visibility,selectedLayer:e.selectedLayer,visibleLayerRoles:e.visibleLayerRoles,navigationState:e.navigationState.addRef(),perspectiveNavigationState:e.perspectiveNavigationState.addRef(),crossSectionBackgroundColor:e.crossSectionBackgroundColor,perspectiveViewBackgroundColor:e.perspectiveViewBackgroundColor}}class dk extends Sn{constructor(e,t,n){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new ok(e,(0,i.bn)({display:n.display,layerSpecification:n.layerSpecification.addRef()},ck(n)),{showLayerPanel:n.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:n.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function uk(e,t,n,i){e.addEventListener("dragenter",(t=>{void 0!==TC(t)&&e.classList.add("neuroglancer-drag-over")})),e.addEventListener("dragleave",(()=>{Wv(e,"drop"),e.classList.remove("neuroglancer-drag-over")})),e.addEventListener("dragover",(n=>{const r=(t,i)=>{t.dropEffectMessage&&(i+=` (${t.dropEffectMessage})`),Gv(e,"drop",i),n.stopPropagation(),n.preventDefault()};if(nk(n)){const e=rk(n,t);return bC(n,e.dropEffect),void r(e,`Drop to ${e.dropEffect} layer group as new ${i}`)}if(void 0===TC(n));else{const e=function(e,t,n,i){const r=DC(e,t,n,i);return bC(e,r.dropEffect),r}(n,t,!1,!0);r(e,`Drop to ${e.dropEffect} layer as new ${i}`)}})),e.addEventListener("drop",(i=>{let r,s;if(e.classList.remove("neuroglancer-drag-over"),Wv(e,"drop"),nk(i)){i.stopPropagation();try{s=JSON.parse(i.dataTransfer.getData(tk))}catch{return}if(r=MC(i,t,{forceCopy:!1,newTarget:!0}),void 0===r)return}else{if(r=MC(i,t,{forceCopy:"copy"===SC(),newTarget:!0}),void 0===r)return;s=r.layoutSpec}if(!r.initializeExternalLayers(i)){if(!r.moveSupported)for(const e of r.layers.keys())e.dispose();return}i.preventDefault();kC(i.dataTransfer.dropEffect=SC());const o=n();r.updateArchiveStates(i);for(const e of r.layers.keys())o.layerSpecification.add(e);try{o.restoreState(s)}catch{o.layout.reset()}}))}class hk extends Sn{constructor(e,t,n,i){super(),this.element=e,this.direction=t,this.container=i,this.changed=new kn,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(const r of n)this.insertChild(r)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){const t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",uk(t,this.viewer.layerSpecification,(()=>{const e=t.nextElementSibling;let n;return null!==e&&(n=lk.getFromElement(e)),this.insertChild({type:"viewer",layers:[]},n).component}),"row"===this.direction?"column":"row"),e.registerDisposer((()=>{Nv(t)})),t}get viewer(){return this.container.viewer}get(e){return lk.getFromElement(this.element.children[2*e+1])}insertChild(e,t){const n=new lk(this.viewer,e,this),i=this.makeDropPlaceholder(n);n.element.classList.add("neuroglancer-stack-layout-child"),n.registerDisposer(n.changed.add(this.changed.dispatch)),n.registerDisposer((()=>{this.element.removeChild(n.element),this.changed.dispatch()}));const r=void 0!==t?t.element:null;return this.element.insertBefore(n.element,r),this.element.insertBefore(i,r),this.changed.dispatch(),n}disposed(){this.clear(),super.disposed()}clear(){for(;0!==this.length;)this.get(0).dispose()}*[i.bm](){const e=this.length;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:It(this).map((e=>e.toJSON()))}}}class pk extends Sn{constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new lk(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}let fk=0;const gk=yv.fromObject({escape:{action:"close"}});class mk extends Sn{constructor(){super(),this.keyMap=new yv,this.keyMap.addParent(gk,Number.NEGATIVE_INFINITY),++fk;let e=this.container=document.createElement("div");e.className="overlay";let t=this.content=document.createElement("div");this.registerDisposer(new Dw(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new tS(this.container,this.keyMap)),this.registerEventListener(e,"action:close",(()=>{this.dispose()})),t.focus()}disposed(){--fk,document.body.removeChild(this.container),super.disposed()}}const vk=yv.fromObject({escape:{action:"cancel"}});class yk extends Sn{constructor(e){super(),this.layer=e,this.element=document.createElement("input");const t=this.element;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";this.registerDisposer(new tS(t,vk)).allShortcutsAreGlobal=!0,Cv(t,"cancel",(e=>{this.updateView(),t.blur(),e.stopPropagation(),e.preventDefault()})),t.title="Rename layer",this.registerDisposer(e.layerChanged.add((()=>this.updateView()))),t.addEventListener("change",(()=>this.updateModel())),t.addEventListener("blur",(()=>this.updateModel())),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){WT(this.layer,this.element.value)}}class bk extends Sn{constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");const t=this.element,n=this.measureElement;t.classList.add("neuroglancer-layer-side-panel-type"),n.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(n);for(const r of OT){var i=O(r,2);const e=i[0],n=i[1];if(n.type!==e)continue;const s=document.createElement("option");s.textContent=n.typeAbbreviation,s.value=e,t.appendChild(s)}t.addEventListener("change",(()=>{const e=t.value,n=OT.get(e);GT(this.layer.managedLayer,n)})),this.updateView()}updateView(){const e=this.layer.type,t=this.element,n=this.measureElement;n.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${n.offsetWidth}px`}disposed(){this.measureElement.remove()}}class Sk extends sy{constructor(e,t){super(e,t.location),this.panelState=t;const n=this.layer=t.layer,r=this.element;const s=this.addTitleBar({}).titleBar;s.classList.add("neuroglancer-layer-side-panel-title"),s.appendChild(this.registerDisposer(new bk(n)).element),s.appendChild(this.registerDisposer(new yk(n.managedLayer)).element),this.registerDisposer(Fn((e=>{r.dataset.neuroglancerLayerVisible=e.toString()}),{get value(){return n.managedLayer.visible},changed:n.managedLayer.layerChanged}));const o=this.registerDisposer(new cy({get value(){return n.managedLayer.pickEnabled},set value(e){n.managedLayer.pickEnabled=e},changed:n.managedLayer.layerChanged},{svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0iY3Vyc29ySWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0iY3Vyc29ySWNvblRpdGxlIj5DdXJzb3I8L3RpdGxlPiAgICAKICAgIDxwb2x5Z29uIHBvaW50cz0iNyAyMCA3IDQgMTkgMTYgMTIgMTYgNyAyMSIvPgo8L3N2Zz4=",enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new Bd({get value(){return n.managedLayer.supportsPickOption},changed:n.managedLayer.layerChanged},o.element)),s.appendChild(o.element);const a={get value(){return t!==n.panels.panels[0]},set value(e){e?t.pin():t.unpin()},changed:n.manager.root.layerManager.layersChanged};s.appendChild(this.registerDisposer(new cy(a,{text:"\ud83d\udccc\ufe0e",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(Fn((e=>{r.dataset.neuroglancerLayerPanelPinned=e.toString()}),a)),s.appendChild(VC({title:"Delete layer",onClick:()=>{$T(this.layer.managedLayer)}})),this.tabView=new MS({makeTab:e=>n.tabs.options.get(e).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new An({get value(){return t.tabs.map((e=>({id:e,label:n.tabs.options.get(e).label})))},changed:t.tabsChanged})),handleTabElement:(e,r)=>{r.draggable=!0,r.addEventListener("dragstart",(s=>{s.stopPropagation(),s.dataTransfer.setData("neuroglancer-side-panel","");let o="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find((e=>e!==t&&e.location.visible))&&(o+=`, or move tab to other ${Bt(n.managedLayer.name)} panel`),Gv(r,"drag",o),this.sidePanelManager.startDrag({dropAsNewPanel:t=>{this.panelState.splitOffTab(e,(0,i.bn)((0,i.bn)({},GS),t))},canDropAsTabs:e=>e instanceof Sk&&e.layer===this.layer&&e!==this?1:0,dropAsTab:t=>{this.panelState.moveTabTo(e,t.panelState)}},s)})),r.addEventListener("dragend",(e=>{Wv(r,"drag"),this.sidePanelManager.endDrag()}))}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add((()=>{0===t.tabs.length&&(this.location.visible=!1)})))}makeDragSource(){return(0,i.bn)((0,i.bn)({},super.makeDragSource()),{canDropAsTabs:e=>e instanceof Sk&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}})}makeTabDropZone(){const e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",(t=>{var n;const i=this.sidePanelManager.dragSource,r=null===(n=i?.canDropAsTabs)||void 0===n?void 0:n.call(i,this);r&&(e.classList.add(Yv),Gv(e,"drop",`Move ${r} ${1===r?"tab":"tabs"} to this panel`),t.preventDefault())})),e.addEventListener("dragleave",(()=>{Wv(e,"drop"),e.classList.remove(Yv)})),e.addEventListener("dragover",(e=>{var t;const n=this.sidePanelManager.dragSource;null!==(t=n?.canDropAsTabs)&&void 0!==t&&t.call(n,this)&&e.preventDefault()})),e.addEventListener("drop",(t=>{var n;Wv(e,"drop");const i=this.sidePanelManager.dragSource;null!==(n=i?.canDropAsTabs)&&void 0!==n&&n.call(i,this)&&(e.classList.remove(Yv),i.dropAsTab(this),t.preventDefault(),t.stopPropagation())})),e}}class wk extends Sn{constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new pt,this.generation=0,this.layersNeedUpdate=!0;const n=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(n)),this.registerDisposer(t.layerManager.layersChanged.add(n)),this.registerDisposer(e.beforeRender.add((()=>this.update())))}getSelectedUserLayer(){var e,t;return null!==(t=null===(e=this.selectedLayerState.layer)||void 0===e?void 0:e.layer)&&void 0!==t?t:void 0}update(){var e;if(!this.layersNeedUpdate)return;const t=this.selectedLayerState.layerManager;let n=++this.generation;this.layersNeedUpdate=!1;const i=this.layerSidePanels,r=e=>{let t=i.get(e);void 0===t?(t={generation:n,unregister:this.sidePanelManager.registerPanel({location:e.location,makePanel:()=>new Sk(this.sidePanelManager,e)})},i.set(e,t)):t.generation=n};{const t=this.getSelectedUserLayer(),n=this.selectedLayerState.location;if(void 0!==t&&n.visible){null===(e=this.placeholderSelectedLayerPanel)||void 0===e||e.call(this),this.placeholderSelectedLayerPanel=void 0;const i=t.panels.panels[0];i.location.value=n.value,r(i)}else void 0===this.placeholderSelectedLayerPanel&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:n,makePanel:()=>new sy(this.sidePanelManager,n)}))}for(const o of t.managedLayers){const e=o.layer;if(null===e)continue;const t=e.panels.panels;for(let n=1,i=t.length;n<i;++n)r(t[n])}for(const o of i){var s=O(o,2);const e=s[0],t=s[1];t.generation!==n&&(t.unregister(),i.delete(e))}}disposed(){var e;null===(e=this.placeholderSelectedLayerPanel)||void 0===e||e.call(this);for(const t of this.layerSidePanels.values()){(0,t.unregister)()}}}const xk=(0,i.bn)((0,i.bn)({},$v),{side:"left",row:0});class Ck{constructor(){this.location=new jv(xk)}get changed(){return this.location.changed}restoreState(e){void 0!==e&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return ps(this.location.toJSON())}}class kk extends Sn{constructor(e){super(),this.layer=e,this.element=document.createElement("div");const t=this.element,n=Jv({svg:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImV5ZUljb25UaXRsZSI+Cgk8dGl0bGUgaWQ9ImV5ZUljb25UaXRsZSI+VmlzaWJsZSAoZXllKTwvdGl0bGU+Cgk8cGF0aCBkPSJNMjIgMTJDMjIgMTIgMTkgMTggMTIgMThDNSAxOCAyIDEyIDIgMTJDMiAxMiA1IDYgMTIgNkMxOSA2IDIyIDEyIDIyIDEyWiIvPgoJPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIvPgo8L3N2Zz4=",title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),i=Jv({svg:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImV5ZUNyb3NzZWRJY29uVGl0bGUiPgoJPHRpdGxlIGlkPSJleWVDcm9zc2VkSWNvblRpdGxlIj5IaWRkZW4gKGNyb3NzZWQgZXllKTwvdGl0bGU+Cgk8cGF0aCBkPSJNMjIgMTJDMjIgMTIgMTkgMTggMTIgMThDNSAxOCAyIDEyIDIgMTJDMiAxMiA1IDYgMTIgNkMxOSA2IDIyIDEyIDIyIDEyWiIvPgoJPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMyIvPgoJPHBhdGggZD0iTTMgMjFMMjAgNCIvPgo8L3N2Zz4=",title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(i),t.appendChild(n);const r=()=>{const e=this.layer.visible;n.style.display=e?"":"none",i.style.display=e?"none":""};r(),this.registerDisposer(e.layerChanged.add(r))}}class Tk extends Sn{constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;const n=this.element,i=this.numberElement;n.classList.add("neuroglancer-layer-list-panel-item"),i.classList.add("neuroglancer-layer-list-panel-item-number"),n.appendChild(this.registerDisposer(new Od({get value(){return!t.archived},set value(e){t.setArchived(!e)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),n.appendChild(i),n.appendChild(this.registerDisposer(new kk(t)).element),n.appendChild(this.registerDisposer(new yk(t)).element),n.appendChild(this.registerDisposer(function(e){const t=e.manager.root.selectedLayer,n=new cy({get value(){return t.layer===e&&t.visible},set value(n){n?(t.layer=e,t.visible=!0):t.visible=!1},changed:t.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:dw});return n.element.classList.add("neuroglancer-layer-list-panel-item-controls"),n}(t)).element);const r=VC({title:"Delete layer",onClick:()=>{$T(this.layer)}});r.classList.add("neuroglancer-layer-list-panel-item-delete"),n.appendChild(r),RC(e,n,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),AC(e,n,t,!0),n.addEventListener("click",(n=>{n.ctrlKey?(e.selectedLayer.toggle(t),n.preventDefault()):n.altKey&&(t.pickEnabled=!t.pickEnabled,n.preventDefault())})),n.addEventListener("contextmenu",(n=>{e.selectedLayer.toggle(t),n.stopPropagation(),n.preventDefault()}))}}class Ek extends sy{constructor(e,t,n){super(e,n.location),this.manager=t,this.state=n,this.items=new pt,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;const i=this.itemContainer,r=this.layerDropZone;const s=this.addTitleBar({title:""}).titleElement;this.titleElement=s,i.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(i),r.style.flex="1";const o=this.registerCancellable(al((()=>this.render())));this.visibility.changed.add(o),this.registerDisposer(this.layerManager.layersChanged.add(o)),this.registerDisposer(this.selectedLayer.changed.add(o)),NC(this),AC(this,r,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){const e=this,t=this.selectedLayer.layer,n=++this.generation;let i=0,r=0,s=0;this.layerManager.updateNonArchivedLayerIndices(),Ov(this.itemContainer,function*(){const o=e.items;let a=0;for(const t of e.layerManager.managedLayers)t.archived||++a;const l=`${(a+1).toString().length}ch`;for(const d of e.layerManager.managedLayers){d.visible?++i:d.archived?++s:++r;let a=o.get(d);void 0===a&&(a=e.registerDisposer(new Tk(e,d)),o.set(d,a)),a.generation=n;const c=d.nonArchivedLayerIndex;a.numberElement.style.width=l,-1===c?a.numberElement.style.visibility="hidden":(a.numberElement.style.visibility="",a.numberElement.textContent=`${c+1}`),a.element.dataset.selected=(d===t).toString(),a.element.dataset.archived=d.archived.toString(),yield a.element}for(const t of o){var c=O(t,2);const i=c[0],r=c[1];n!==r.generation&&(o.delete(i),e.unregisterDisposer(r),r.dispose())}yield e.layerDropZone}());let o="Layers";if(i||r||s){o+=" (";let e="";i+r&&(o+=`${i}/${r+i} visible`,e=", "),s&&(o+=`${e}${s} archived`),o+=")"}this.titleElement.textContent=o}}class Lk extends Sn{constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");const t=this.registerCancellable(al((()=>this.render())));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0;const t=this.layerManager.managedLayers;for(const i of t)i.archived&&++e;const n=this.element;if(0!==e){const i=t.length;n.textContent=`${i-e}/${i}`}else n.textContent=""}}var Ik,Dk={exports:{}};function Mk(){return Ik||(Ik=1,function(e){i.aT,e.exports=function(){var e=navigator.userAgent,t=navigator.platform,n=/gecko\/\d/i.test(e),i=/MSIE \d/.test(e),r=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(e),s=/Edge\/(\d+)/.exec(e),o=i||r||s,a=o&&(i?document.documentMode||6:+(s||r)[1]),l=!s&&/WebKit\//.test(e),c=l&&/Qt\/\d+\.\d+/.test(e),d=!s&&/Chrome\/(\d+)/.exec(e),u=d&&+d[1],h=/Opera\//.test(e),p=/Apple Computer/.test(navigator.vendor),f=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(e),g=/PhantomJS/.test(e),m=p&&(/Mobile\/\w+/.test(e)||navigator.maxTouchPoints>2),v=/Android/.test(e),y=m||v||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(e),b=m||/Mac/.test(t),S=/\bCrOS\b/.test(e),w=/win/i.test(t),x=h&&e.match(/Version\/(\d*\.\d*)/);x&&(x=Number(x[1])),x&&x>=15&&(h=!1,l=!0);var C=b&&(c||h&&(null==x||x<12.11)),k=n||o&&a>=9;function T(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}var E,L=function(e,t){var n=e.className,i=T(t).exec(n);if(i){var r=n.slice(i.index+i[0].length);e.className=n.slice(0,i.index)+(r?i[1]+r:"")}};function I(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function D(e,t){return I(e).appendChild(t)}function M(e,t,n,i){var r=document.createElement(e);if(n&&(r.className=n),i&&(r.style.cssText=i),"string"==typeof t)r.appendChild(document.createTextNode(t));else if(t)for(var s=0;s<t.length;++s)r.appendChild(t[s]);return r}function P(e,t,n,i){var r=M(e,t,n,i);return r.setAttribute("role","presentation"),r}function A(e,t){if(3==t.nodeType&&(t=t.parentNode),e.contains)return e.contains(t);do{if(11==t.nodeType&&(t=t.host),t==e)return!0}while(t=t.parentNode)}function R(e){var t,n=e.ownerDocument||e;try{t=e.activeElement}catch{t=n.body||null}for(;t&&t.shadowRoot&&t.shadowRoot.activeElement;)t=t.shadowRoot.activeElement;return t}function N(e,t){var n=e.className;T(t).test(n)||(e.className+=(n?" ":"")+t)}function V(e,t){for(var n=e.split(" "),i=0;i<n.length;i++)n[i]&&!T(n[i]).test(t)&&(t+=" "+n[i]);return t}E=document.createRange?function(e,t,n,i){var r=document.createRange();return r.setEnd(i||e,n),r.setStart(e,t),r}:function(e,t,n){var i=document.body.createTextRange();try{i.moveToElementText(e.parentNode)}catch{return i}return i.collapse(!0),i.moveEnd("character",n),i.moveStart("character",t),i};var O=function(e){e.select()};function B(e){return e.display.wrapper.ownerDocument}function _(e){return F(e.display.wrapper)}function F(e){return e.getRootNode?e.getRootNode():e.ownerDocument}function z(e){return B(e).defaultView}function U(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function G(e,t,n){for(var i in t||(t={}),e)e.hasOwnProperty(i)&&(!1!==n||!t.hasOwnProperty(i))&&(t[i]=e[i]);return t}function W(e,t,n,i,r){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var s=i||0,o=r||0;;){var a=e.indexOf("\t",s);if(a<0||a>=t)return o+(t-s);o+=a-s,o+=n-o%n,s=a+1}}m?O=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:o&&(O=function(e){try{e.select()}catch{}});var $=function(){this.id=null,this.f=null,this.time=0,this.handler=U(this.onTimeout,this)};function j(e,t){for(var n=0;n<e.length;++n)if(e[n]==t)return n;return-1}$.prototype.onTimeout=function(e){e.id=0,e.time<=+new Date?e.f():setTimeout(e.handler,e.time-+new Date)},$.prototype.set=function(e,t){this.f=t;var n=+new Date+e;(!this.id||n<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,e),this.time=n)};var H=50,J={toString:function(){return"CodeMirror.Pass"}},q={scroll:!1},Y={origin:"*mouse"},Z={origin:"+move"};function X(e,t,n){for(var i=0,r=0;;){var s=e.indexOf("\t",i);-1==s&&(s=e.length);var o=s-i;if(s==e.length||r+o>=t)return i+Math.min(o,t-r);if(r+=s-i,i=s+1,(r+=n-r%n)>=t)return i}}var K=[""];function Q(e){for(;K.length<=e;)K.push(ee(K)+" ");return K[e]}function ee(e){return e[e.length-1]}function te(e,t){for(var n=[],i=0;i<e.length;i++)n[i]=t(e[i],i);return n}function ne(e,t,n){for(var i=0,r=n(t);i<e.length&&n(e[i])<=r;)i++;e.splice(i,0,t)}function ie(){}function re(e,t){var n;return Object.create?n=Object.create(e):(ie.prototype=e,n=new ie),t&&G(t,n),n}var se=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function oe(e){return/\w/.test(e)||e>"\x80"&&(e.toUpperCase()!=e.toLowerCase()||se.test(e))}function ae(e,t){return t?!!(t.source.indexOf("\\w")>-1&&oe(e))||t.test(e):oe(e)}function le(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}var ce=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function de(e){return e.charCodeAt(0)>=768&&ce.test(e)}function ue(e,t,n){for(;(n<0?t>0:t<e.length)&&de(e.charAt(t));)t+=n;return t}function he(e,t,n){for(var i=t>n?-1:1;;){if(t==n)return t;var r=(t+n)/2,s=i<0?Math.ceil(r):Math.floor(r);if(s==t)return e(s)?t:n;e(s)?n=s:t=s+i}}function pe(e,t,n,i){if(!e)return i(t,n,"ltr",0);for(var r=!1,s=0;s<e.length;++s){var o=e[s];(o.from<n&&o.to>t||t==n&&o.to==t)&&(i(Math.max(o.from,t),Math.min(o.to,n),1==o.level?"rtl":"ltr",s),r=!0)}r||i(t,n,"ltr")}var fe=null;function ge(e,t,n){var i;fe=null;for(var r=0;r<e.length;++r){var s=e[r];if(s.from<t&&s.to>t)return r;s.to==t&&(s.from!=s.to&&"before"==n?i=r:fe=r),s.from==t&&(s.from!=s.to&&"before"!=n?i=r:fe=r)}return i??fe}var me=function(){var e="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",t="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function n(n){return n<=247?e.charAt(n):1424<=n&&n<=1524?"R":1536<=n&&n<=1785?t.charAt(n-1536):1774<=n&&n<=2220?"r":8192<=n&&n<=8203?"w":8204==n?"b":"L"}var i=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,r=/[stwN]/,s=/[LRr]/,o=/[Lb1n]/,a=/[1n]/;function l(e,t,n){this.level=e,this.from=t,this.to=n}return function(e,t){var c="ltr"==t?"L":"R";if(0==e.length||"ltr"==t&&!i.test(e))return!1;for(var d=e.length,u=[],h=0;h<d;++h)u.push(n(e.charCodeAt(h)));for(var p=0,f=c;p<d;++p){var g=u[p];"m"==g?u[p]=f:f=g}for(var m=0,v=c;m<d;++m){var y=u[m];"1"==y&&"r"==v?u[m]="n":s.test(y)&&(v=y,"r"==y&&(u[m]="R"))}for(var b=1,S=u[0];b<d-1;++b){var w=u[b];"+"==w&&"1"==S&&"1"==u[b+1]?u[b]="1":","==w&&S==u[b+1]&&("1"==S||"n"==S)&&(u[b]=S),S=w}for(var x=0;x<d;++x){var C=u[x];if(","==C)u[x]="N";else if("%"==C){var k=void 0;for(k=x+1;k<d&&"%"==u[k];++k);for(var T=x&&"!"==u[x-1]||k<d&&"1"==u[k]?"1":"N",E=x;E<k;++E)u[E]=T;x=k-1}}for(var L=0,I=c;L<d;++L){var D=u[L];"L"==I&&"1"==D?u[L]="L":s.test(D)&&(I=D)}for(var M=0;M<d;++M)if(r.test(u[M])){var P=void 0;for(P=M+1;P<d&&r.test(u[P]);++P);for(var A="L"==(M?u[M-1]:c),R=A==("L"==(P<d?u[P]:c))?A?"L":"R":c,N=M;N<P;++N)u[N]=R;M=P-1}for(var V,O=[],B=0;B<d;)if(o.test(u[B])){var _=B;for(++B;B<d&&o.test(u[B]);++B);O.push(new l(0,_,B))}else{var F=B,z=O.length,U="rtl"==t?1:0;for(++B;B<d&&"L"!=u[B];++B);for(var G=F;G<B;)if(a.test(u[G])){F<G&&(O.splice(z,0,new l(1,F,G)),z+=U);var W=G;for(++G;G<B&&a.test(u[G]);++G);O.splice(z,0,new l(2,W,G)),z+=U,F=G}else++G;F<B&&O.splice(z,0,new l(1,F,B))}return"ltr"==t&&(1==O[0].level&&(V=e.match(/^\s+/))&&(O[0].from=V[0].length,O.unshift(new l(0,0,V[0].length))),1==ee(O).level&&(V=e.match(/\s+$/))&&(ee(O).to-=V[0].length,O.push(new l(0,d-V[0].length,d)))),"rtl"==t?O.reverse():O}}();function ve(e,t){var n=e.order;return null==n&&(n=e.order=me(e.text,t)),n}var ye=[],be=function(e,t,n){if(e.addEventListener)e.addEventListener(t,n,!1);else if(e.attachEvent)e.attachEvent("on"+t,n);else{var i=e._handlers||(e._handlers={});i[t]=(i[t]||ye).concat(n)}};function Se(e,t){return e._handlers&&e._handlers[t]||ye}function we(e,t,n){if(e.removeEventListener)e.removeEventListener(t,n,!1);else if(e.detachEvent)e.detachEvent("on"+t,n);else{var i=e._handlers,r=i&&i[t];if(r){var s=j(r,n);s>-1&&(i[t]=r.slice(0,s).concat(r.slice(s+1)))}}}function xe(e,t){var n=Se(e,t);if(n.length)for(var i=Array.prototype.slice.call(arguments,2),r=0;r<n.length;++r)n[r].apply(null,i)}function Ce(e,t,n){return"string"==typeof t&&(t={type:t,preventDefault:function(){this.defaultPrevented=!0}}),xe(e,n||t.type,e,t),De(t)||t.codemirrorIgnore}function ke(e){var t=e._handlers&&e._handlers.cursorActivity;if(t)for(var n=e.curOp.cursorActivityHandlers||(e.curOp.cursorActivityHandlers=[]),i=0;i<t.length;++i)-1==j(n,t[i])&&n.push(t[i])}function Te(e,t){return Se(e,t).length>0}function Ee(e){e.prototype.on=function(e,t){be(this,e,t)},e.prototype.off=function(e,t){we(this,e,t)}}function Le(e){e.preventDefault?e.preventDefault():e.returnValue=!1}function Ie(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}function De(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Me(e){Le(e),Ie(e)}function Pe(e){return e.target||e.srcElement}function Ae(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),b&&e.ctrlKey&&1==t&&(t=3),t}var Re,Ne,Ve=function(){if(o&&a<9)return!1;var e=M("div");return"draggable"in e||"dragDrop"in e}();function Oe(e){if(null==Re){var t=M("span","\u200b");D(e,M("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Re=t.offsetWidth<=1&&t.offsetHeight>2&&!(o&&a<8))}var n=Re?M("span","\u200b"):M("span","\xa0",null,"display: inline-block; width: 1px; margin-right: -1px");return n.setAttribute("cm-text",""),n}function Be(e){if(null!=Ne)return Ne;var t=D(e,document.createTextNode("A\u062eA")),n=E(t,0,1).getBoundingClientRect(),i=E(t,1,2).getBoundingClientRect();return I(e),!(!n||n.left==n.right)&&(Ne=i.right-n.right<3)}var _e=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,n=[],i=e.length;t<=i;){var r=e.indexOf("\n",t);-1==r&&(r=e.length);var s=e.slice(t,"\r"==e.charAt(r-1)?r-1:r),o=s.indexOf("\r");-1!=o?(n.push(s.slice(0,o)),t+=o+1):(n.push(s),t=r+1)}return n}:function(e){return e.split(/\r\n?|\n/)},Fe=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch{return!1}}:function(e){var t;try{t=e.ownerDocument.selection.createRange()}catch{}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},ze=function(){var e=M("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),Ue=null;function Ge(e){if(null!=Ue)return Ue;var t=D(e,M("span","x")),n=t.getBoundingClientRect(),i=E(t,0,1).getBoundingClientRect();return Ue=Math.abs(n.left-i.left)>1}var We={},$e={};function je(e,t){arguments.length>2&&(t.dependencies=Array.prototype.slice.call(arguments,2)),We[e]=t}function He(e,t){$e[e]=t}function Je(e){if("string"==typeof e&&$e.hasOwnProperty(e))e=$e[e];else if(e&&"string"==typeof e.name&&$e.hasOwnProperty(e.name)){var t=$e[e.name];"string"==typeof t&&(t={name:t}),(e=re(t,e)).name=t.name}else{if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+xml$/.test(e))return Je("application/xml");if("string"==typeof e&&/^[\w\-]+\/[\w\-]+\+json$/.test(e))return Je("application/json")}return"string"==typeof e?{name:e}:e||{name:"null"}}function qe(e,t){t=Je(t);var n=We[t.name];if(!n)return qe(e,"text/plain");var i=n(e,t);if(Ye.hasOwnProperty(t.name)){var r=Ye[t.name];for(var s in r)r.hasOwnProperty(s)&&(i.hasOwnProperty(s)&&(i["_"+s]=i[s]),i[s]=r[s])}if(i.name=t.name,t.helperType&&(i.helperType=t.helperType),t.modeProps)for(var o in t.modeProps)i[o]=t.modeProps[o];return i}var Ye={};function Ze(e,t){G(t,Ye.hasOwnProperty(e)?Ye[e]:Ye[e]={})}function Xe(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var n={};for(var i in t){var r=t[i];r instanceof Array&&(r=r.concat([])),n[i]=r}return n}function Ke(e,t){for(var n;e.innerMode&&(n=e.innerMode(t))&&n.mode!=e;)t=n.state,e=n.mode;return n||{mode:e,state:t}}function Qe(e,t,n){return!e.startState||e.startState(t,n)}var et=function(e,t,n){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=n};function tt(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var n=e;!n.lines;)for(var i=0;;++i){var r=n.children[i],s=r.chunkSize();if(t<s){n=r;break}t-=s}return n.lines[t]}function nt(e,t,n){var i=[],r=t.line;return e.iter(t.line,n.line+1,(function(e){var s=e.text;r==n.line&&(s=s.slice(0,n.ch)),r==t.line&&(s=s.slice(t.ch)),i.push(s),++r})),i}function it(e,t,n){var i=[];return e.iter(t,n,(function(e){i.push(e.text)})),i}function rt(e,t){var n=t-e.height;if(n)for(var i=e;i;i=i.parent)i.height+=n}function st(e){if(null==e.parent)return null;for(var t=e.parent,n=j(t.lines,e),i=t.parent;i;t=i,i=i.parent)for(var r=0;i.children[r]!=t;++r)n+=i.children[r].chunkSize();return n+t.first}function ot(e,t){var n=e.first;e:do{for(var i=0;i<e.children.length;++i){var r=e.children[i],s=r.height;if(t<s){e=r;continue e}t-=s,n+=r.chunkSize()}return n}while(!e.lines);for(var o=0;o<e.lines.length;++o){var a=e.lines[o].height;if(t<a)break;t-=a}return n+o}function at(e,t){return t>=e.first&&t<e.first+e.size}function lt(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function ct(e,t,n){if(void 0===n&&(n=null),!(this instanceof ct))return new ct(e,t,n);this.line=e,this.ch=t,this.sticky=n}function dt(e,t){return e.line-t.line||e.ch-t.ch}function ut(e,t){return e.sticky==t.sticky&&0==dt(e,t)}function ht(e){return ct(e.line,e.ch)}function pt(e,t){return dt(e,t)<0?t:e}function ft(e,t){return dt(e,t)<0?e:t}function gt(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function mt(e,t){if(t.line<e.first)return ct(e.first,0);var n=e.first+e.size-1;return t.line>n?ct(n,tt(e,n).text.length):vt(t,tt(e,t.line).text.length)}function vt(e,t){var n=e.ch;return null==n||n>t?ct(e.line,t):n<0?ct(e.line,0):e}function yt(e,t){for(var n=[],i=0;i<t.length;i++)n[i]=mt(e,t[i]);return n}et.prototype.eol=function(){return this.pos>=this.string.length},et.prototype.sol=function(){return this.pos==this.lineStart},et.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},et.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},et.prototype.eat=function(e){var t=this.string.charAt(this.pos);if("string"==typeof e?t==e:t&&(e.test?e.test(t):e(t)))return++this.pos,t},et.prototype.eatWhile=function(e){for(var t=this.pos;this.eat(e););return this.pos>t},et.prototype.eatSpace=function(){for(var e=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>e},et.prototype.skipToEnd=function(){this.pos=this.string.length},et.prototype.skipTo=function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},et.prototype.backUp=function(e){this.pos-=e},et.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=W(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?W(this.string,this.lineStart,this.tabSize):0)},et.prototype.indentation=function(){return W(this.string,null,this.tabSize)-(this.lineStart?W(this.string,this.lineStart,this.tabSize):0)},et.prototype.match=function(e,t,n){if("string"!=typeof e){var i=this.string.slice(this.pos).match(e);return i&&i.index>0?null:(i&&!1!==t&&(this.pos+=i[0].length),i)}var r=function(e){return n?e.toLowerCase():e};if(r(this.string.substr(this.pos,e.length))==r(e))return!1!==t&&(this.pos+=e.length),!0},et.prototype.current=function(){return this.string.slice(this.start,this.pos)},et.prototype.hideFirstChars=function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}},et.prototype.lookAhead=function(e){var t=this.lineOracle;return t&&t.lookAhead(e)},et.prototype.baseToken=function(){var e=this.lineOracle;return e&&e.baseToken(this.pos)};var bt=function(e,t){this.state=e,this.lookAhead=t},St=function(e,t,n,i){this.state=t,this.doc=e,this.line=n,this.maxLookAhead=i||0,this.baseTokens=null,this.baseTokenPos=1};function wt(e,t,n,i){var r=[e.state.modeGen],s={};Mt(e,t.text,e.doc.mode,n,(function(e,t){return r.push(e,t)}),s,i);for(var o=n.state,a=function(i){n.baseTokens=r;var a=e.state.overlays[i],l=1,c=0;n.state=!0,Mt(e,t.text,a.mode,n,(function(e,t){for(var n=l;c<e;){var i=r[l];i>e&&r.splice(l,1,e,r[l+1],i),l+=2,c=Math.min(e,i)}if(t)if(a.opaque)r.splice(n,l-n,e,"overlay "+t),l=n+2;else for(;n<l;n+=2){var s=r[n+1];r[n+1]=(s?s+" ":"")+"overlay "+t}}),s),n.state=o,n.baseTokens=null,n.baseTokenPos=1},l=0;l<e.state.overlays.length;++l)a(l);return{styles:r,classes:s.bgClass||s.textClass?s:null}}function xt(e,t,n){if(!t.styles||t.styles[0]!=e.state.modeGen){var i=Ct(e,st(t)),r=t.text.length>e.options.maxHighlightLength&&Xe(e.doc.mode,i.state),s=wt(e,t,i);r&&(i.state=r),t.stateAfter=i.save(!r),t.styles=s.styles,s.classes?t.styleClasses=s.classes:t.styleClasses&&(t.styleClasses=null),n===e.doc.highlightFrontier&&(e.doc.modeFrontier=Math.max(e.doc.modeFrontier,++e.doc.highlightFrontier))}return t.styles}function Ct(e,t,n){var i=e.doc,r=e.display;if(!i.mode.startState)return new St(i,!0,t);var s=Pt(e,t,n),o=s>i.first&&tt(i,s-1).stateAfter,a=o?St.fromSaved(i,o,s):new St(i,Qe(i.mode),s);return i.iter(s,t,(function(n){kt(e,n.text,a);var i=a.line;n.stateAfter=i==t-1||i%5==0||i>=r.viewFrom&&i<r.viewTo?a.save():null,a.nextLine()})),n&&(i.modeFrontier=a.line),a}function kt(e,t,n,i){var r=e.doc.mode,s=new et(t,e.options.tabSize,n);for(s.start=s.pos=i||0,""==t&&Tt(r,n.state);!s.eol();)Et(r,s,n.state),s.start=s.pos}function Tt(e,t){if(e.blankLine)return e.blankLine(t);if(e.innerMode){var n=Ke(e,t);if(n.mode.blankLine)return n.mode.blankLine(n.state)}}function Et(e,t,n,i){for(var r=0;r<10;r++){i&&(i[0]=Ke(e,n).mode);var s=e.token(t,n);if(t.pos>t.start)return s}throw new Error("Mode "+e.name+" failed to advance stream.")}St.prototype.lookAhead=function(e){var t=this.doc.getLine(this.line+e);return null!=t&&e>this.maxLookAhead&&(this.maxLookAhead=e),t},St.prototype.baseToken=function(e){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=e;)this.baseTokenPos+=2;var t=this.baseTokens[this.baseTokenPos+1];return{type:t&&t.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-e}},St.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},St.fromSaved=function(e,t,n){return t instanceof bt?new St(e,Xe(e.mode,t.state),n,t.lookAhead):new St(e,Xe(e.mode,t),n)},St.prototype.save=function(e){var t=!1!==e?Xe(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new bt(t,this.maxLookAhead):t};var Lt=function(e,t,n){this.start=e.start,this.end=e.pos,this.string=e.current(),this.type=t||null,this.state=n};function It(e,t,n,i){var r,s,o=e.doc,a=o.mode,l=tt(o,(t=mt(o,t)).line),c=Ct(e,t.line,n),d=new et(l.text,e.options.tabSize,c);for(i&&(s=[]);(i||d.pos<t.ch)&&!d.eol();)d.start=d.pos,r=Et(a,d,c.state),i&&s.push(new Lt(d,r,Xe(o.mode,c.state)));return i?s:new Lt(d,r,c.state)}function Dt(e,t){if(e)for(;;){var n=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!n)break;e=e.slice(0,n.index)+e.slice(n.index+n[0].length);var i=n[1]?"bgClass":"textClass";null==t[i]?t[i]=n[2]:new RegExp("(?:^|\\s)"+n[2]+"(?:$|\\s)").test(t[i])||(t[i]+=" "+n[2])}return e}function Mt(e,t,n,i,r,s,o){var a=n.flattenSpans;null==a&&(a=e.options.flattenSpans);var l,c=0,d=null,u=new et(t,e.options.tabSize,i),h=e.options.addModeClass&&[null];for(""==t&&Dt(Tt(n,i.state),s);!u.eol();){if(u.pos>e.options.maxHighlightLength?(a=!1,o&&kt(e,t,i,u.pos),u.pos=t.length,l=null):l=Dt(Et(n,u,i.state,h),s),h){var p=h[0].name;p&&(l="m-"+(l?p+" "+l:p))}if(!a||d!=l){for(;c<u.start;)r(c=Math.min(u.start,c+5e3),d);d=l}u.start=u.pos}for(;c<u.pos;){var f=Math.min(u.pos,c+5e3);r(f,d),c=f}}function Pt(e,t,n){for(var i,r,s=e.doc,o=n?-1:t-(e.doc.mode.innerMode?1e3:100),a=t;a>o;--a){if(a<=s.first)return s.first;var l=tt(s,a-1),c=l.stateAfter;if(c&&(!n||a+(c instanceof bt?c.lookAhead:0)<=s.modeFrontier))return a;var d=W(l.text,null,e.options.tabSize);(null==r||i>d)&&(r=a-1,i=d)}return r}function At(e,t){if(e.modeFrontier=Math.min(e.modeFrontier,t),!(e.highlightFrontier<t-10)){for(var n=e.first,i=t-1;i>n;i--){var r=tt(e,i).stateAfter;if(r&&(!(r instanceof bt)||i+r.lookAhead<t)){n=i+1;break}}e.highlightFrontier=Math.min(e.highlightFrontier,n)}}var Rt=!1,Nt=!1;function Vt(){Rt=!0}function Ot(){Nt=!0}function Bt(e,t,n){this.marker=e,this.from=t,this.to=n}function _t(e,t){if(e)for(var n=0;n<e.length;++n){var i=e[n];if(i.marker==t)return i}}function Ft(e,t){for(var n,i=0;i<e.length;++i)e[i]!=t&&(n||(n=[])).push(e[i]);return n}function zt(e,t,n){var i=n&&window.WeakSet&&(n.markedSpans||(n.markedSpans=new WeakSet));i&&e.markedSpans&&i.has(e.markedSpans)?e.markedSpans.push(t):(e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],i&&i.add(e.markedSpans)),t.marker.attachLine(e)}function Ut(e,t,n){var i;if(e)for(var r=0;r<e.length;++r){var s=e[r],o=s.marker;if(null==s.from||(o.inclusiveLeft?s.from<=t:s.from<t)||s.from==t&&"bookmark"==o.type&&(!n||!s.marker.insertLeft)){var a=null==s.to||(o.inclusiveRight?s.to>=t:s.to>t);(i||(i=[])).push(new Bt(o,s.from,a?null:s.to))}}return i}function Gt(e,t,n){var i;if(e)for(var r=0;r<e.length;++r){var s=e[r],o=s.marker;if(null==s.to||(o.inclusiveRight?s.to>=t:s.to>t)||s.from==t&&"bookmark"==o.type&&(!n||s.marker.insertLeft)){var a=null==s.from||(o.inclusiveLeft?s.from<=t:s.from<t);(i||(i=[])).push(new Bt(o,a?null:s.from-t,null==s.to?null:s.to-t))}}return i}function Wt(e,t){if(t.full)return null;var n=at(e,t.from.line)&&tt(e,t.from.line).markedSpans,i=at(e,t.to.line)&&tt(e,t.to.line).markedSpans;if(!n&&!i)return null;var r=t.from.ch,s=t.to.ch,o=0==dt(t.from,t.to),a=Ut(n,r,o),l=Gt(i,s,o),c=1==t.text.length,d=ee(t.text).length+(c?r:0);if(a)for(var u=0;u<a.length;++u){var h=a[u];if(null==h.to){var p=_t(l,h.marker);p?c&&(h.to=null==p.to?null:p.to+d):h.to=r}}if(l)for(var f=0;f<l.length;++f){var g=l[f];null!=g.to&&(g.to+=d),null==g.from?_t(a,g.marker)||(g.from=d,c&&(a||(a=[])).push(g)):(g.from+=d,c&&(a||(a=[])).push(g))}a&&(a=$t(a)),l&&l!=a&&(l=$t(l));var m=[a];if(!c){var v,y=t.text.length-2;if(y>0&&a)for(var b=0;b<a.length;++b)null==a[b].to&&(v||(v=[])).push(new Bt(a[b].marker,null,null));for(var S=0;S<y;++S)m.push(v);m.push(l)}return m}function $t(e){for(var t=0;t<e.length;++t){var n=e[t];null!=n.from&&n.from==n.to&&!1!==n.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function jt(e,t,n){var i=null;if(e.iter(t.line,n.line+1,(function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var n=e.markedSpans[t].marker;n.readOnly&&(!i||-1==j(i,n))&&(i||(i=[])).push(n)}})),!i)return null;for(var r=[{from:t,to:n}],s=0;s<i.length;++s)for(var o=i[s],a=o.find(0),l=0;l<r.length;++l){var c=r[l];if(!(dt(c.to,a.from)<0||dt(c.from,a.to)>0)){var d=[l,1],u=dt(c.from,a.from),h=dt(c.to,a.to);(u<0||!o.inclusiveLeft&&!u)&&d.push({from:c.from,to:a.from}),(h>0||!o.inclusiveRight&&!h)&&d.push({from:a.to,to:c.to}),r.splice.apply(r,d),l+=d.length-3}}return r}function Ht(e){var t=e.markedSpans;if(t){for(var n=0;n<t.length;++n)t[n].marker.detachLine(e);e.markedSpans=null}}function Jt(e,t){if(t){for(var n=0;n<t.length;++n)t[n].marker.attachLine(e);e.markedSpans=t}}function qt(e){return e.inclusiveLeft?-1:0}function Yt(e){return e.inclusiveRight?1:0}function Zt(e,t){var n=e.lines.length-t.lines.length;if(0!=n)return n;var i=e.find(),r=t.find(),s=dt(i.from,r.from)||qt(e)-qt(t);return s?-s:dt(i.to,r.to)||Yt(e)-Yt(t)||t.id-e.id}function Xt(e,t){var n,i=Nt&&e.markedSpans;if(i)for(var r=void 0,s=0;s<i.length;++s)(r=i[s]).marker.collapsed&&null==(t?r.from:r.to)&&(!n||Zt(n,r.marker)<0)&&(n=r.marker);return n}function Kt(e){return Xt(e,!0)}function Qt(e){return Xt(e,!1)}function en(e,t){var n,i=Nt&&e.markedSpans;if(i)for(var r=0;r<i.length;++r){var s=i[r];s.marker.collapsed&&(null==s.from||s.from<t)&&(null==s.to||s.to>t)&&(!n||Zt(n,s.marker)<0)&&(n=s.marker)}return n}function tn(e,t,n,i,r){var s=tt(e,t),o=Nt&&s.markedSpans;if(o)for(var a=0;a<o.length;++a){var l=o[a];if(l.marker.collapsed){var c=l.marker.find(0),d=dt(c.from,n)||qt(l.marker)-qt(r),u=dt(c.to,i)||Yt(l.marker)-Yt(r);if(!(d>=0&&u<=0||d<=0&&u>=0)&&(d<=0&&(l.marker.inclusiveRight&&r.inclusiveLeft?dt(c.to,n)>=0:dt(c.to,n)>0)||d>=0&&(l.marker.inclusiveRight&&r.inclusiveLeft?dt(c.from,i)<=0:dt(c.from,i)<0)))return!0}}}function nn(e){for(var t;t=Kt(e);)e=t.find(-1,!0).line;return e}function rn(e){for(var t;t=Qt(e);)e=t.find(1,!0).line;return e}function sn(e){for(var t,n;t=Qt(e);)e=t.find(1,!0).line,(n||(n=[])).push(e);return n}function on(e,t){var n=tt(e,t),i=nn(n);return n==i?t:st(i)}function an(e,t){if(t>e.lastLine())return t;var n,i=tt(e,t);if(!ln(e,i))return t;for(;n=Qt(i);)i=n.find(1,!0).line;return st(i)+1}function ln(e,t){var n=Nt&&t.markedSpans;if(n)for(var i=void 0,r=0;r<n.length;++r)if((i=n[r]).marker.collapsed){if(null==i.from)return!0;if(!i.marker.widgetNode&&0==i.from&&i.marker.inclusiveLeft&&cn(e,t,i))return!0}}function cn(e,t,n){if(null==n.to){var i=n.marker.find(1,!0);return cn(e,i.line,_t(i.line.markedSpans,n.marker))}if(n.marker.inclusiveRight&&n.to==t.text.length)return!0;for(var r=void 0,s=0;s<t.markedSpans.length;++s)if((r=t.markedSpans[s]).marker.collapsed&&!r.marker.widgetNode&&r.from==n.to&&(null==r.to||r.to!=n.from)&&(r.marker.inclusiveLeft||n.marker.inclusiveRight)&&cn(e,t,r))return!0}function dn(e){for(var t=0,n=(e=nn(e)).parent,i=0;i<n.lines.length;++i){var r=n.lines[i];if(r==e)break;t+=r.height}for(var s=n.parent;s;s=(n=s).parent)for(var o=0;o<s.children.length;++o){var a=s.children[o];if(a==n)break;t+=a.height}return t}function un(e){if(0==e.height)return 0;for(var t,n=e.text.length,i=e;t=Kt(i);){var r=t.find(0,!0);i=r.from.line,n+=r.from.ch-r.to.ch}for(i=e;t=Qt(i);){var s=t.find(0,!0);n-=i.text.length-s.from.ch,n+=(i=s.to.line).text.length-s.to.ch}return n}function hn(e){var t=e.display,n=e.doc;t.maxLine=tt(n,n.first),t.maxLineLength=un(t.maxLine),t.maxLineChanged=!0,n.iter((function(e){var n=un(e);n>t.maxLineLength&&(t.maxLineLength=n,t.maxLine=e)}))}var pn=function(e,t,n){this.text=e,Jt(this,t),this.height=n?n(this):1};function fn(e,t,n,i){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),Ht(e),Jt(e,n);var r=i?i(e):1;r!=e.height&&rt(e,r)}function gn(e){e.parent=null,Ht(e)}pn.prototype.lineNo=function(){return st(this)},Ee(pn);var mn={},vn={};function yn(e,t){if(!e||/^\s*$/.test(e))return null;var n=t.addModeClass?vn:mn;return n[e]||(n[e]=e.replace(/\S+/g,"cm-$&"))}function bn(e,t){var n=P("span",null,null,l?"padding-right: .1px":null),i={pre:P("pre",[n],"CodeMirror-line"),content:n,col:0,pos:0,cm:e,trailingSpace:!1,splitSpaces:e.getOption("lineWrapping")};t.measure={};for(var r=0;r<=(t.rest?t.rest.length:0);r++){var s=r?t.rest[r-1]:t.line,o=void 0;i.pos=0,i.addToken=wn,Be(e.display.measure)&&(o=ve(s,e.doc.direction))&&(i.addToken=Cn(i.addToken,o)),i.map=[],Tn(s,i,xt(e,s,t!=e.display.externalMeasured&&st(s))),s.styleClasses&&(s.styleClasses.bgClass&&(i.bgClass=V(s.styleClasses.bgClass,i.bgClass||"")),s.styleClasses.textClass&&(i.textClass=V(s.styleClasses.textClass,i.textClass||""))),0==i.map.length&&i.map.push(0,0,i.content.appendChild(Oe(e.display.measure))),0==r?(t.measure.map=i.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(i.map),(t.measure.caches||(t.measure.caches=[])).push({}))}if(l){var a=i.content.lastChild;(/\bcm-tab\b/.test(a.className)||a.querySelector&&a.querySelector(".cm-tab"))&&(i.content.className="cm-tab-wrap-hack")}return xe(e,"renderLine",e,t.line,i.pre),i.pre.className&&(i.textClass=V(i.pre.className,i.textClass||"")),i}function Sn(e){var t=M("span","\u2022","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t.setAttribute("aria-label",t.title),t}function wn(e,t,n,i,r,s,l){if(t){var c,d=e.splitSpaces?xn(t,e.trailingSpace):t,u=e.cm.state.specialChars,h=!1;if(u.test(t)){c=document.createDocumentFragment();for(var p=0;;){u.lastIndex=p;var f=u.exec(t),g=f?f.index-p:t.length-p;if(g){var m=document.createTextNode(d.slice(p,p+g));o&&a<9?c.appendChild(M("span",[m])):c.appendChild(m),e.map.push(e.pos,e.pos+g,m),e.col+=g,e.pos+=g}if(!f)break;p+=g+1;var v=void 0;if("\t"==f[0]){var y=e.cm.options.tabSize,b=y-e.col%y;(v=c.appendChild(M("span",Q(b),"cm-tab"))).setAttribute("role","presentation"),v.setAttribute("cm-text","\t"),e.col+=b}else"\r"==f[0]||"\n"==f[0]?((v=c.appendChild(M("span","\r"==f[0]?"\u240d":"\u2424","cm-invalidchar"))).setAttribute("cm-text",f[0]),e.col+=1):((v=e.cm.options.specialCharPlaceholder(f[0])).setAttribute("cm-text",f[0]),o&&a<9?c.appendChild(M("span",[v])):c.appendChild(v),e.col+=1);e.map.push(e.pos,e.pos+1,v),e.pos++}}else e.col+=t.length,c=document.createTextNode(d),e.map.push(e.pos,e.pos+t.length,c),o&&a<9&&(h=!0),e.pos+=t.length;if(e.trailingSpace=32==d.charCodeAt(t.length-1),n||i||r||h||s||l){var S=n||"";i&&(S+=i),r&&(S+=r);var w=M("span",[c],S,s);if(l)for(var x in l)l.hasOwnProperty(x)&&"style"!=x&&"class"!=x&&w.setAttribute(x,l[x]);return e.content.appendChild(w)}e.content.appendChild(c)}}function xn(e,t){if(e.length>1&&!/  /.test(e))return e;for(var n=t,i="",r=0;r<e.length;r++){var s=e.charAt(r);" "==s&&n&&(r==e.length-1||32==e.charCodeAt(r+1))&&(s="\xa0"),i+=s,n=" "==s}return i}function Cn(e,t){return function(n,i,r,s,o,a,l){r=r?r+" cm-force-border":"cm-force-border";for(var c=n.pos,d=c+i.length;;){for(var u=void 0,h=0;h<t.length&&!((u=t[h]).to>c&&u.from<=c);h++);if(u.to>=d)return e(n,i,r,s,o,a,l);e(n,i.slice(0,u.to-c),r,s,null,a,l),s=null,i=i.slice(u.to-c),c=u.to}}}function kn(e,t,n,i){var r=!i&&n.widgetNode;r&&e.map.push(e.pos,e.pos+t,r),!i&&e.cm.display.input.needsContentAttribute&&(r||(r=e.content.appendChild(document.createElement("span"))),r.setAttribute("cm-marker",n.id)),r&&(e.cm.display.input.setUneditable(r),e.content.appendChild(r)),e.pos+=t,e.trailingSpace=!1}function Tn(e,t,n){var i=e.markedSpans,r=e.text,s=0;if(i)for(var o,a,l,c,d,u,h,p=r.length,f=0,g=1,m="",v=0;;){if(v==f){l=c=d=a="",h=null,u=null,v=1/0;for(var y=[],b=void 0,S=0;S<i.length;++S){var w=i[S],x=w.marker;if("bookmark"==x.type&&w.from==f&&x.widgetNode)y.push(x);else if(w.from<=f&&(null==w.to||w.to>f||x.collapsed&&w.to==f&&w.from==f)){if(null!=w.to&&w.to!=f&&v>w.to&&(v=w.to,c=""),x.className&&(l+=" "+x.className),x.css&&(a=(a?a+";":"")+x.css),x.startStyle&&w.from==f&&(d+=" "+x.startStyle),x.endStyle&&w.to==v&&(b||(b=[])).push(x.endStyle,w.to),x.title&&((h||(h={})).title=x.title),x.attributes)for(var C in x.attributes)(h||(h={}))[C]=x.attributes[C];x.collapsed&&(!u||Zt(u.marker,x)<0)&&(u=w)}else w.from>f&&v>w.from&&(v=w.from)}if(b)for(var k=0;k<b.length;k+=2)b[k+1]==v&&(c+=" "+b[k]);if(!u||u.from==f)for(var T=0;T<y.length;++T)kn(t,0,y[T]);if(u&&(u.from||0)==f){if(kn(t,(null==u.to?p+1:u.to)-f,u.marker,null==u.from),null==u.to)return;u.to==f&&(u=!1)}}if(f>=p)break;for(var E=Math.min(p,v);;){if(m){var L=f+m.length;if(!u){var I=L>E?m.slice(0,E-f):m;t.addToken(t,I,o?o+l:l,d,f+I.length==v?c:"",a,h)}if(L>=E){m=m.slice(E-f),f=E;break}f=L,d=""}m=r.slice(s,s=n[g++]),o=yn(n[g++],t.cm.options)}}else for(var D=1;D<n.length;D+=2)t.addToken(t,r.slice(s,s=n[D]),yn(n[D+1],t.cm.options))}function En(e,t,n){this.line=t,this.rest=sn(t),this.size=this.rest?st(ee(this.rest))-n+1:1,this.node=this.text=null,this.hidden=ln(e,t)}function Ln(e,t,n){for(var i,r=[],s=t;s<n;s=i){var o=new En(e.doc,tt(e.doc,s),s);i=s+o.size,r.push(o)}return r}var In=null;function Dn(e){In?In.ops.push(e):e.ownsGroup=In={ops:[e],delayedCallbacks:[]}}function Mn(e){var t=e.delayedCallbacks,n=0;do{for(;n<t.length;n++)t[n].call(null);for(var i=0;i<e.ops.length;i++){var r=e.ops[i];if(r.cursorActivityHandlers)for(;r.cursorActivityCalled<r.cursorActivityHandlers.length;)r.cursorActivityHandlers[r.cursorActivityCalled++].call(null,r.cm)}}while(n<t.length)}function Pn(e,t){var n=e.ownsGroup;if(n)try{Mn(n)}finally{In=null,t(n)}}var An=null;function Rn(e,t){var n=Se(e,t);if(n.length){var i,r=Array.prototype.slice.call(arguments,2);In?i=In.delayedCallbacks:An?i=An:(i=An=[],setTimeout(Nn,0));for(var s=function(e){i.push((function(){return n[e].apply(null,r)}))},o=0;o<n.length;++o)s(o)}}function Nn(){var e=An;An=null;for(var t=0;t<e.length;++t)e[t]()}function Vn(e,t,n,i){for(var r=0;r<t.changes.length;r++){var s=t.changes[r];"text"==s?Fn(e,t):"gutter"==s?Un(e,t,n,i):"class"==s?zn(e,t):"widget"==s&&Gn(e,t,i)}t.changes=null}function On(e){return e.node==e.text&&(e.node=M("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),o&&a<8&&(e.node.style.zIndex=2)),e.node}function Bn(e,t){var n=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(n&&(n+=" CodeMirror-linebackground"),t.background)n?t.background.className=n:(t.background.parentNode.removeChild(t.background),t.background=null);else if(n){var i=On(t);t.background=i.insertBefore(M("div",null,n),i.firstChild),e.display.input.setUneditable(t.background)}}function _n(e,t){var n=e.display.externalMeasured;return n&&n.line==t.line?(e.display.externalMeasured=null,t.measure=n.measure,n.built):bn(e,t)}function Fn(e,t){var n=t.text.className,i=_n(e,t);t.text==t.node&&(t.node=i.pre),t.text.parentNode.replaceChild(i.pre,t.text),t.text=i.pre,i.bgClass!=t.bgClass||i.textClass!=t.textClass?(t.bgClass=i.bgClass,t.textClass=i.textClass,zn(e,t)):n&&(t.text.className=n)}function zn(e,t){Bn(e,t),t.line.wrapClass?On(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");var n=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=n||""}function Un(e,t,n,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){var r=On(t);t.gutterBackground=M("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,"left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px; width: "+i.gutterTotalWidth+"px"),e.display.input.setUneditable(t.gutterBackground),r.insertBefore(t.gutterBackground,t.text)}var s=t.line.gutterMarkers;if(e.options.lineNumbers||s){var o=On(t),a=t.gutter=M("div",null,"CodeMirror-gutter-wrapper","left: "+(e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth)+"px");if(a.setAttribute("aria-hidden","true"),e.display.input.setUneditable(a),o.insertBefore(a,t.text),t.line.gutterClass&&(a.className+=" "+t.line.gutterClass),e.options.lineNumbers&&(!s||!s["CodeMirror-linenumbers"])&&(t.lineNumber=a.appendChild(M("div",lt(e.options,n),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+i.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),s)for(var l=0;l<e.display.gutterSpecs.length;++l){var c=e.display.gutterSpecs[l].className,d=s.hasOwnProperty(c)&&s[c];d&&a.appendChild(M("div",[d],"CodeMirror-gutter-elt","left: "+i.gutterLeft[c]+"px; width: "+i.gutterWidth[c]+"px"))}}}function Gn(e,t,n){t.alignable&&(t.alignable=null);for(var i=T("CodeMirror-linewidget"),r=t.node.firstChild,s=void 0;r;r=s)s=r.nextSibling,i.test(r.className)&&t.node.removeChild(r);$n(e,t,n)}function Wn(e,t,n,i){var r=_n(e,t);return t.text=t.node=r.pre,r.bgClass&&(t.bgClass=r.bgClass),r.textClass&&(t.textClass=r.textClass),zn(e,t),Un(e,t,n,i),$n(e,t,i),t.node}function $n(e,t,n){if(jn(e,t.line,t,n,!0),t.rest)for(var i=0;i<t.rest.length;i++)jn(e,t.rest[i],t,n,!1)}function jn(e,t,n,i,r){if(t.widgets)for(var s=On(n),o=0,a=t.widgets;o<a.length;++o){var l=a[o],c=M("div",[l.node],"CodeMirror-linewidget"+(l.className?" "+l.className:""));l.handleMouseEvents||c.setAttribute("cm-ignore-events","true"),Hn(l,c,n,i),e.display.input.setUneditable(c),r&&l.above?s.insertBefore(c,n.gutter||n.text):s.appendChild(c),Rn(l,"redraw")}}function Hn(e,t,n,i){if(e.noHScroll){(n.alignable||(n.alignable=[])).push(t);var r=i.wrapperWidth;t.style.left=i.fixedPos+"px",e.coverGutter||(r-=i.gutterTotalWidth,t.style.paddingLeft=i.gutterTotalWidth+"px"),t.style.width=r+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-i.gutterTotalWidth+"px"))}function Jn(e){if(null!=e.height)return e.height;var t=e.doc.cm;if(!t)return 0;if(!A(document.body,e.node)){var n="position: relative;";e.coverGutter&&(n+="margin-left: -"+t.display.gutters.offsetWidth+"px;"),e.noHScroll&&(n+="width: "+t.display.wrapper.clientWidth+"px;"),D(t.display.measure,M("div",[e.node],null,n))}return e.height=e.node.parentNode.offsetHeight}function qn(e,t){for(var n=Pe(t);n!=e.wrapper;n=n.parentNode)if(!n||1==n.nodeType&&"true"==n.getAttribute("cm-ignore-events")||n.parentNode==e.sizer&&n!=e.mover)return!0}function Yn(e){return e.lineSpace.offsetTop}function Zn(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function Xn(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=D(e.measure,M("pre","x","CodeMirror-line-like")),n=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,i={left:parseInt(n.paddingLeft),right:parseInt(n.paddingRight)};return!isNaN(i.left)&&!isNaN(i.right)&&(e.cachedPaddingH=i),i}function Kn(e){return H-e.display.nativeBarWidth}function Qn(e){return e.display.scroller.clientWidth-Kn(e)-e.display.barWidth}function ei(e){return e.display.scroller.clientHeight-Kn(e)-e.display.barHeight}function ti(e,t,n){var i=e.options.lineWrapping,r=i&&Qn(e);if(!t.measure.heights||i&&t.measure.width!=r){var s=t.measure.heights=[];if(i){t.measure.width=r;for(var o=t.text.firstChild.getClientRects(),a=0;a<o.length-1;a++){var l=o[a],c=o[a+1];Math.abs(l.bottom-c.bottom)>2&&s.push((l.bottom+c.top)/2-n.top)}}s.push(n.bottom-n.top)}}function ni(e,t,n){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};if(e.rest){for(var i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i]};for(var r=0;r<e.rest.length;r++)if(st(e.rest[r])>n)return{map:e.measure.maps[r],cache:e.measure.caches[r],before:!0}}}function ii(e,t){var n=st(t=nn(t)),i=e.display.externalMeasured=new En(e.doc,t,n);i.lineN=n;var r=i.built=bn(e,i);return i.text=r.pre,D(e.display.lineMeasure,r.pre),i}function ri(e,t,n,i){return ai(e,oi(e,t),n,i)}function si(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[zi(e,t)];var n=e.display.externalMeasured;return n&&t>=n.lineN&&t<n.lineN+n.size?n:void 0}function oi(e,t){var n=st(t),i=si(e,n);i&&!i.text?i=null:i&&i.changes&&(Vn(e,i,n,Vi(e)),e.curOp.forceUpdate=!0),i||(i=ii(e,t));var r=ni(i,t,n);return{line:t,view:i,rect:null,map:r.map,cache:r.cache,before:r.before,hasHeights:!1}}function ai(e,t,n,i,r){t.before&&(n=-1);var s,o=n+(i||"");return t.cache.hasOwnProperty(o)?s=t.cache[o]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(ti(e,t.view,t.rect),t.hasHeights=!0),(s=hi(e,t,n,i)).bogus||(t.cache[o]=s)),{left:s.left,right:s.right,top:r?s.rtop:s.top,bottom:r?s.rbottom:s.bottom}}var li,ci={left:0,right:0,top:0,bottom:0};function di(e,t,n){for(var i,r,s,o,a,l,c=0;c<e.length;c+=3)if(a=e[c],l=e[c+1],t<a?(r=0,s=1,o="left"):t<l?s=1+(r=t-a):(c==e.length-3||t==l&&e[c+3]>t)&&(r=(s=l-a)-1,t>=l&&(o="right")),null!=r){if(i=e[c+2],a==l&&n==(i.insertLeft?"left":"right")&&(o=n),"left"==n&&0==r)for(;c&&e[c-2]==e[c-3]&&e[c-1].insertLeft;)i=e[2+(c-=3)],o="left";if("right"==n&&r==l-a)for(;c<e.length-3&&e[c+3]==e[c+4]&&!e[c+5].insertLeft;)i=e[(c+=3)+2],o="right";break}return{node:i,start:r,end:s,collapse:o,coverStart:a,coverEnd:l}}function ui(e,t){var n=ci;if("left"==t)for(var i=0;i<e.length&&(n=e[i]).left==n.right;i++);else for(var r=e.length-1;r>=0&&(n=e[r]).left==n.right;r--);return n}function hi(e,t,n,i){var r,s=di(t.map,n,i),l=s.node,c=s.start,d=s.end,u=s.collapse;if(3==l.nodeType){for(var h=0;h<4;h++){for(;c&&de(t.line.text.charAt(s.coverStart+c));)--c;for(;s.coverStart+d<s.coverEnd&&de(t.line.text.charAt(s.coverStart+d));)++d;if((r=o&&a<9&&0==c&&d==s.coverEnd-s.coverStart?l.parentNode.getBoundingClientRect():ui(E(l,c,d).getClientRects(),i)).left||r.right||0==c)break;d=c,c-=1,u="right"}o&&a<11&&(r=pi(e.display.measure,r))}else{var p;c>0&&(u=i="right"),r=e.options.lineWrapping&&(p=l.getClientRects()).length>1?p["right"==i?p.length-1:0]:l.getBoundingClientRect()}if(o&&a<9&&!c&&(!r||!r.left&&!r.right)){var f=l.parentNode.getClientRects()[0];r=f?{left:f.left,right:f.left+Ni(e.display),top:f.top,bottom:f.bottom}:ci}for(var g=r.top-t.rect.top,m=r.bottom-t.rect.top,v=(g+m)/2,y=t.view.measure.heights,b=0;b<y.length-1&&!(v<y[b]);b++);var S=b?y[b-1]:0,w=y[b],x={left:("right"==u?r.right:r.left)-t.rect.left,right:("left"==u?r.left:r.right)-t.rect.left,top:S,bottom:w};return!r.left&&!r.right&&(x.bogus=!0),e.options.singleCursorHeightPerLine||(x.rtop=g,x.rbottom=m),x}function pi(e,t){if(!window.screen||null==screen.logicalXDPI||screen.logicalXDPI==screen.deviceXDPI||!Ge(e))return t;var n=screen.logicalXDPI/screen.deviceXDPI,i=screen.logicalYDPI/screen.deviceYDPI;return{left:t.left*n,right:t.right*n,top:t.top*i,bottom:t.bottom*i}}function fi(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function gi(e){e.display.externalMeasure=null,I(e.display.lineMeasure);for(var t=0;t<e.display.view.length;t++)fi(e.display.view[t])}function mi(e){gi(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function vi(e){return d&&v?-(e.body.getBoundingClientRect().left-parseInt(getComputedStyle(e.body).marginLeft)):e.defaultView.pageXOffset||(e.documentElement||e.body).scrollLeft}function yi(e){return d&&v?-(e.body.getBoundingClientRect().top-parseInt(getComputedStyle(e.body).marginTop)):e.defaultView.pageYOffset||(e.documentElement||e.body).scrollTop}function bi(e){var t=nn(e).widgets,n=0;if(t)for(var i=0;i<t.length;++i)t[i].above&&(n+=Jn(t[i]));return n}function Si(e,t,n,i,r){if(!r){var s=bi(t);n.top+=s,n.bottom+=s}if("line"==i)return n;i||(i="local");var o=dn(t);if("local"==i?o+=Yn(e.display):o-=e.display.viewOffset,"page"==i||"window"==i){var a=e.display.lineSpace.getBoundingClientRect();o+=a.top+("window"==i?0:yi(B(e)));var l=a.left+("window"==i?0:vi(B(e)));n.left+=l,n.right+=l}return n.top+=o,n.bottom+=o,n}function wi(e,t,n){if("div"==n)return t;var i=t.left,r=t.top;if("page"==n)i-=vi(B(e)),r-=yi(B(e));else if("local"==n||!n){var s=e.display.sizer.getBoundingClientRect();i+=s.left,r+=s.top}var o=e.display.lineSpace.getBoundingClientRect();return{left:i-o.left,top:r-o.top}}function xi(e,t,n,i,r){return i||(i=tt(e.doc,t.line)),Si(e,i,ri(e,i,t.ch,r),n)}function Ci(e,t,n,i,r,s){function o(t,o){var a=ai(e,r,t,o?"right":"left",s);return o?a.left=a.right:a.right=a.left,Si(e,i,a,n)}i=i||tt(e.doc,t.line),r||(r=oi(e,i));var a=ve(i,e.doc.direction),l=t.ch,c=t.sticky;if(l>=i.text.length?(l=i.text.length,c="before"):l<=0&&(l=0,c="after"),!a)return o("before"==c?l-1:l,"before"==c);function d(e,t,n){return o(n?e-1:e,1==a[t].level!=n)}var u=ge(a,l,c),h=fe,p=d(l,u,"before"==c);return null!=h&&(p.other=d(l,h,"before"!=c)),p}function ki(e,t){var n=0;t=mt(e.doc,t),e.options.lineWrapping||(n=Ni(e.display)*t.ch);var i=tt(e.doc,t.line),r=dn(i)+Yn(e.display);return{left:n,right:n,top:r,bottom:r+i.height}}function Ti(e,t,n,i,r){var s=ct(e,t,n);return s.xRel=r,i&&(s.outside=i),s}function Ei(e,t,n){var i=e.doc;if((n+=e.display.viewOffset)<0)return Ti(i.first,0,null,-1,-1);var r=ot(i,n),s=i.first+i.size-1;if(r>s)return Ti(i.first+i.size-1,tt(i,s).text.length,null,1,1);t<0&&(t=0);for(var o=tt(i,r);;){var a=Mi(e,o,r,t,n),l=en(o,a.ch+(a.xRel>0||a.outside>0?1:0));if(!l)return a;var c=l.find(1);if(c.line==r)return c;o=tt(i,r=c.line)}}function Li(e,t,n,i){i-=bi(t);var r=t.text.length,s=he((function(t){return ai(e,n,t-1).bottom<=i}),r,0);return{begin:s,end:r=he((function(t){return ai(e,n,t).top>i}),s,r)}}function Ii(e,t,n,i){return n||(n=oi(e,t)),Li(e,t,n,Si(e,t,ai(e,n,i),"line").top)}function Di(e,t,n,i){return!(e.bottom<=n)&&(e.top>n||(i?e.left:e.right)>t)}function Mi(e,t,n,i,r){r-=dn(t);var s=oi(e,t),o=bi(t),a=0,l=t.text.length,c=!0,d=ve(t,e.doc.direction);if(d){var u=(e.options.lineWrapping?Ai:Pi)(e,t,n,s,d,i,r);a=(c=1!=u.level)?u.from:u.to-1,l=c?u.to:u.from-1}var h,p,f=null,g=null,m=he((function(t){var n=ai(e,s,t);return n.top+=o,n.bottom+=o,!!Di(n,i,r,!1)&&(n.top<=r&&n.left<=i&&(f=t,g=n),!0)}),a,l),v=!1;if(g){var y=i-g.left<g.right-i,b=y==c;m=f+(b?0:1),p=b?"after":"before",h=y?g.left:g.right}else{!c&&(m==l||m==a)&&m++,p=0==m?"after":m==t.text.length?"before":ai(e,s,m-(c?1:0)).bottom+o<=r==c?"after":"before";var S=Ci(e,ct(n,m,p),"line",t,s);h=S.left,v=r<S.top?-1:r>=S.bottom?1:0}return Ti(n,m=ue(t.text,m,1),p,v,i-h)}function Pi(e,t,n,i,r,s,o){var a=he((function(a){var l=r[a],c=1!=l.level;return Di(Ci(e,ct(n,c?l.to:l.from,c?"before":"after"),"line",t,i),s,o,!0)}),0,r.length-1),l=r[a];if(a>0){var c=1!=l.level,d=Ci(e,ct(n,c?l.from:l.to,c?"after":"before"),"line",t,i);Di(d,s,o,!0)&&d.top>o&&(l=r[a-1])}return l}function Ai(e,t,n,i,r,s,o){var a=Li(e,t,i,o),l=a.begin,c=a.end;/\s/.test(t.text.charAt(c-1))&&c--;for(var d=null,u=null,h=0;h<r.length;h++){var p=r[h];if(!(p.from>=c||p.to<=l)){var f=ai(e,i,1!=p.level?Math.min(c,p.to)-1:Math.max(l,p.from)).right,g=f<s?s-f+1e9:f-s;(!d||u>g)&&(d=p,u=g)}}return d||(d=r[r.length-1]),d.from<l&&(d={from:l,to:d.to,level:d.level}),d.to>c&&(d={from:d.from,to:c,level:d.level}),d}function Ri(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==li){li=M("pre",null,"CodeMirror-line-like");for(var t=0;t<49;++t)li.appendChild(document.createTextNode("x")),li.appendChild(M("br"));li.appendChild(document.createTextNode("x"))}D(e.measure,li);var n=li.offsetHeight/50;return n>3&&(e.cachedTextHeight=n),I(e.measure),n||1}function Ni(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=M("span","xxxxxxxxxx"),n=M("pre",[t],"CodeMirror-line-like");D(e.measure,n);var i=t.getBoundingClientRect(),r=(i.right-i.left)/10;return r>2&&(e.cachedCharWidth=r),r||10}function Vi(e){for(var t=e.display,n={},i={},r=t.gutters.clientLeft,s=t.gutters.firstChild,o=0;s;s=s.nextSibling,++o){var a=e.display.gutterSpecs[o].className;n[a]=s.offsetLeft+s.clientLeft+r,i[a]=s.clientWidth}return{fixedPos:Oi(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:n,gutterWidth:i,wrapperWidth:t.wrapper.clientWidth}}function Oi(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function Bi(e){var t=Ri(e.display),n=e.options.lineWrapping,i=n&&Math.max(5,e.display.scroller.clientWidth/Ni(e.display)-3);return function(r){if(ln(e.doc,r))return 0;var s=0;if(r.widgets)for(var o=0;o<r.widgets.length;o++)r.widgets[o].height&&(s+=r.widgets[o].height);return n?s+(Math.ceil(r.text.length/i)||1)*t:s+t}}function _i(e){var t=e.doc,n=Bi(e);t.iter((function(e){var t=n(e);t!=e.height&&rt(e,t)}))}function Fi(e,t,n,i){var r=e.display;if(!n&&"true"==Pe(t).getAttribute("cm-not-content"))return null;var s,o,a=r.lineSpace.getBoundingClientRect();try{s=t.clientX-a.left,o=t.clientY-a.top}catch{return null}var l,c=Ei(e,s,o);if(i&&c.xRel>0&&(l=tt(e.doc,c.line).text).length==c.ch){var d=W(l,l.length,e.options.tabSize)-l.length;c=ct(c.line,Math.max(0,Math.round((s-Xn(e.display).left)/Ni(e.display))-d))}return c}function zi(e,t){if(t>=e.display.viewTo||(t-=e.display.viewFrom)<0)return null;for(var n=e.display.view,i=0;i<n.length;i++)if((t-=n[i].size)<0)return i}function Ui(e,t,n,i){null==t&&(t=e.doc.first),null==n&&(n=e.doc.first+e.doc.size),i||(i=0);var r=e.display;if(i&&n<r.viewTo&&(null==r.updateLineNumbers||r.updateLineNumbers>t)&&(r.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=r.viewTo)Nt&&on(e.doc,t)<r.viewTo&&Wi(e);else if(n<=r.viewFrom)Nt&&an(e.doc,n+i)>r.viewFrom?Wi(e):(r.viewFrom+=i,r.viewTo+=i);else if(t<=r.viewFrom&&n>=r.viewTo)Wi(e);else if(t<=r.viewFrom){var s=$i(e,n,n+i,1);s?(r.view=r.view.slice(s.index),r.viewFrom=s.lineN,r.viewTo+=i):Wi(e)}else if(n>=r.viewTo){var o=$i(e,t,t,-1);o?(r.view=r.view.slice(0,o.index),r.viewTo=o.lineN):Wi(e)}else{var a=$i(e,t,t,-1),l=$i(e,n,n+i,1);a&&l?(r.view=r.view.slice(0,a.index).concat(Ln(e,a.lineN,l.lineN)).concat(r.view.slice(l.index)),r.viewTo+=i):Wi(e)}var c=r.externalMeasured;c&&(n<c.lineN?c.lineN+=i:t<c.lineN+c.size&&(r.externalMeasured=null))}function Gi(e,t,n){e.curOp.viewChanged=!0;var i=e.display,r=e.display.externalMeasured;if(r&&t>=r.lineN&&t<r.lineN+r.size&&(i.externalMeasured=null),!(t<i.viewFrom||t>=i.viewTo)){var s=i.view[zi(e,t)];if(null!=s.node){var o=s.changes||(s.changes=[]);-1==j(o,n)&&o.push(n)}}}function Wi(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function $i(e,t,n,i){var r,s=zi(e,t),o=e.display.view;if(!Nt||n==e.doc.first+e.doc.size)return{index:s,lineN:n};for(var a=e.display.viewFrom,l=0;l<s;l++)a+=o[l].size;if(a!=t){if(i>0){if(s==o.length-1)return null;r=a+o[s].size-t,s++}else r=a-t;t+=r,n+=r}for(;on(e.doc,n)!=n;){if(s==(i<0?0:o.length-1))return null;n+=i*o[s-(i<0?1:0)].size,s+=i}return{index:s,lineN:n}}function ji(e,t,n){var i=e.display;0==i.view.length||t>=i.viewTo||n<=i.viewFrom?(i.view=Ln(e,t,n),i.viewFrom=t):(i.viewFrom>t?i.view=Ln(e,t,i.viewFrom).concat(i.view):i.viewFrom<t&&(i.view=i.view.slice(zi(e,t))),i.viewFrom=t,i.viewTo<n?i.view=i.view.concat(Ln(e,i.viewTo,n)):i.viewTo>n&&(i.view=i.view.slice(0,zi(e,n)))),i.viewTo=n}function Hi(e){for(var t=e.display.view,n=0,i=0;i<t.length;i++){var r=t[i];!r.hidden&&(!r.node||r.changes)&&++n}return n}function Ji(e){e.display.input.showSelection(e.display.input.prepareSelection())}function qi(e,t){void 0===t&&(t=!0);var n=e.doc,i={},r=i.cursors=document.createDocumentFragment(),s=i.selection=document.createDocumentFragment(),o=e.options.$customCursor;o&&(t=!0);for(var a=0;a<n.sel.ranges.length;a++)if(t||a!=n.sel.primIndex){var l=n.sel.ranges[a];if(!(l.from().line>=e.display.viewTo||l.to().line<e.display.viewFrom)){var c=l.empty();if(o){var d=o(e,l);d&&Yi(e,d,r)}else(c||e.options.showCursorWhenSelecting)&&Yi(e,l.head,r);c||Xi(e,l,s)}}return i}function Yi(e,t,n){var i=Ci(e,t,"div",null,null,!e.options.singleCursorHeightPerLine),r=n.appendChild(M("div","\xa0","CodeMirror-cursor"));if(r.style.left=i.left+"px",r.style.top=i.top+"px",r.style.height=Math.max(0,i.bottom-i.top)*e.options.cursorHeight+"px",/\bcm-fat-cursor\b/.test(e.getWrapperElement().className)){var s=xi(e,t,"div",null,null),o=s.right-s.left;r.style.width=(o>0?o:e.defaultCharWidth())+"px"}if(i.other){var a=n.appendChild(M("div","\xa0","CodeMirror-cursor CodeMirror-secondarycursor"));a.style.display="",a.style.left=i.other.left+"px",a.style.top=i.other.top+"px",a.style.height=.85*(i.other.bottom-i.other.top)+"px"}}function Zi(e,t){return e.top-t.top||e.left-t.left}function Xi(e,t,n){var i=e.display,r=e.doc,s=document.createDocumentFragment(),o=Xn(e.display),a=o.left,l=Math.max(i.sizerWidth,Qn(e)-i.sizer.offsetLeft)-o.right,c="ltr"==r.direction;function d(e,t,n,i){t<0&&(t=0),t=Math.round(t),i=Math.round(i),s.appendChild(M("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px;\n                             top: "+t+"px; width: "+(n??l-e)+"px;\n                             height: "+(i-t)+"px"))}function u(t,n,i){var s,o,u=tt(r,t),h=u.text.length;function p(n,i){return xi(e,ct(t,n),"div",u,i)}function f(t,n,i){var r=Ii(e,u,null,t),s="ltr"==n==("after"==i)?"left":"right";return p("after"==i?r.begin:r.end-(/\s/.test(u.text.charAt(r.end-1))?2:1),s)[s]}var g=ve(u,r.direction);return pe(g,n||0,i??h,(function(e,t,r,u){var m="ltr"==r,v=p(e,m?"left":"right"),y=p(t-1,m?"right":"left"),b=null==n&&0==e,S=null==i&&t==h,w=0==u,x=!g||u==g.length-1;if(y.top-v.top<=3){var C=(c?S:b)&&x,k=(c?b:S)&&w?a:(m?v:y).left,T=C?l:(m?y:v).right;d(k,v.top,T-k,v.bottom)}else{var E,L,I,D;m?(E=c&&b&&w?a:v.left,L=c?l:f(e,r,"before"),I=c?a:f(t,r,"after"),D=c&&S&&x?l:y.right):(E=c?f(e,r,"before"):a,L=!c&&b&&w?l:v.right,I=!c&&S&&x?a:y.left,D=c?f(t,r,"after"):l),d(E,v.top,L-E,v.bottom),v.bottom<y.top&&d(a,v.bottom,null,y.top),d(I,y.top,D-I,y.bottom)}(!s||Zi(v,s)<0)&&(s=v),Zi(y,s)<0&&(s=y),(!o||Zi(v,o)<0)&&(o=v),Zi(y,o)<0&&(o=y)})),{start:s,end:o}}var h=t.from(),p=t.to();if(h.line==p.line)u(h.line,h.ch,p.ch);else{var f=tt(r,h.line),g=tt(r,p.line),m=nn(f)==nn(g),v=u(h.line,h.ch,m?f.text.length+1:null).end,y=u(p.line,m?0:null,p.ch).start;m&&(v.top<y.top-2?(d(v.right,v.top,null,v.bottom),d(a,y.top,y.left,y.bottom)):d(v.right,v.top,y.left-v.right,v.bottom)),v.bottom<y.top&&d(a,v.bottom,null,y.top)}n.appendChild(s)}function Ki(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var n=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0?t.blinker=setInterval((function(){e.hasFocus()||nr(e),t.cursorDiv.style.visibility=(n=!n)?"":"hidden"}),e.options.cursorBlinkRate):e.options.cursorBlinkRate<0&&(t.cursorDiv.style.visibility="hidden")}}function Qi(e){e.hasFocus()||(e.display.input.focus(),e.state.focused||tr(e))}function er(e){e.state.delayingBlurEvent=!0,setTimeout((function(){e.state.delayingBlurEvent&&(e.state.delayingBlurEvent=!1,e.state.focused&&nr(e))}),100)}function tr(e,t){e.state.delayingBlurEvent&&!e.state.draggingText&&(e.state.delayingBlurEvent=!1),"nocursor"!=e.options.readOnly&&(e.state.focused||(xe(e,"focus",e,t),e.state.focused=!0,N(e.display.wrapper,"CodeMirror-focused"),!e.curOp&&e.display.selForContextMenu!=e.doc.sel&&(e.display.input.reset(),l&&setTimeout((function(){return e.display.input.reset(!0)}),20)),e.display.input.receivedFocus()),Ki(e))}function nr(e,t){e.state.delayingBlurEvent||(e.state.focused&&(xe(e,"blur",e,t),e.state.focused=!1,L(e.display.wrapper,"CodeMirror-focused")),clearInterval(e.display.blinker),setTimeout((function(){e.state.focused||(e.display.shift=!1)}),150))}function ir(e){for(var t=e.display,n=t.lineDiv.offsetTop,i=Math.max(0,t.scroller.getBoundingClientRect().top),r=t.lineDiv.getBoundingClientRect().top,s=0,l=0;l<t.view.length;l++){var c=t.view[l],d=e.options.lineWrapping,u=void 0,h=0;if(!c.hidden){if(r+=c.line.height,o&&a<8){var p=c.node.offsetTop+c.node.offsetHeight;u=p-n,n=p}else{var f=c.node.getBoundingClientRect();u=f.bottom-f.top,!d&&c.text.firstChild&&(h=c.text.firstChild.getBoundingClientRect().right-f.left-1)}var g=c.line.height-u;if((g>.005||g<-.005)&&(r<i&&(s-=g),rt(c.line,u),rr(c.line),c.rest))for(var m=0;m<c.rest.length;m++)rr(c.rest[m]);if(h>e.display.sizerWidth){var v=Math.ceil(h/Ni(e.display));v>e.display.maxLineLength&&(e.display.maxLineLength=v,e.display.maxLine=c.line,e.display.maxLineChanged=!0)}}}Math.abs(s)>2&&(t.scroller.scrollTop+=s)}function rr(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t){var n=e.widgets[t],i=n.node.parentNode;i&&(n.height=i.offsetHeight)}}function sr(e,t,n){var i=n&&null!=n.top?Math.max(0,n.top):e.scroller.scrollTop;i=Math.floor(i-Yn(e));var r=n&&null!=n.bottom?n.bottom:i+e.wrapper.clientHeight,s=ot(t,i),o=ot(t,r);if(n&&n.ensure){var a=n.ensure.from.line,l=n.ensure.to.line;a<s?(s=a,o=ot(t,dn(tt(t,a))+e.wrapper.clientHeight)):Math.min(l,t.lastLine())>=o&&(s=ot(t,dn(tt(t,l))-e.wrapper.clientHeight),o=l)}return{from:s,to:Math.max(o,s+1)}}function or(e,t){if(!Ce(e,"scrollCursorIntoView")){var n=e.display,i=n.sizer.getBoundingClientRect(),r=null,s=n.wrapper.ownerDocument;if(t.top+i.top<0?r=!0:t.bottom+i.top>(s.defaultView.innerHeight||s.documentElement.clientHeight)&&(r=!1),null!=r&&!g){var o=M("div","\u200b",null,"position: absolute;\n                         top: "+(t.top-n.viewOffset-Yn(e.display))+"px;\n                         height: "+(t.bottom-t.top+Kn(e)+n.barHeight)+"px;\n                         left: "+t.left+"px; width: "+Math.max(2,t.right-t.left)+"px;");e.display.lineSpace.appendChild(o),o.scrollIntoView(r),e.display.lineSpace.removeChild(o)}}}function ar(e,t,n,i){var r;null==i&&(i=0),!e.options.lineWrapping&&t==n&&(n="before"==t.sticky?ct(t.line,t.ch+1,"before"):t,t=t.ch?ct(t.line,"before"==t.sticky?t.ch-1:t.ch,"after"):t);for(var s=0;s<5;s++){var o=!1,a=Ci(e,t),l=n&&n!=t?Ci(e,n):a,c=cr(e,r={left:Math.min(a.left,l.left),top:Math.min(a.top,l.top)-i,right:Math.max(a.left,l.left),bottom:Math.max(a.bottom,l.bottom)+i}),d=e.doc.scrollTop,u=e.doc.scrollLeft;if(null!=c.scrollTop&&(mr(e,c.scrollTop),Math.abs(e.doc.scrollTop-d)>1&&(o=!0)),null!=c.scrollLeft&&(yr(e,c.scrollLeft),Math.abs(e.doc.scrollLeft-u)>1&&(o=!0)),!o)break}return r}function lr(e,t){var n=cr(e,t);null!=n.scrollTop&&mr(e,n.scrollTop),null!=n.scrollLeft&&yr(e,n.scrollLeft)}function cr(e,t){var n=e.display,i=Ri(e.display);t.top<0&&(t.top=0);var r=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:n.scroller.scrollTop,s=ei(e),o={};t.bottom-t.top>s&&(t.bottom=t.top+s);var a=e.doc.height+Zn(n),l=t.top<i,c=t.bottom>a-i;if(t.top<r)o.scrollTop=l?0:t.top;else if(t.bottom>r+s){var d=Math.min(t.top,(c?a:t.bottom)-s);d!=r&&(o.scrollTop=d)}var u=e.options.fixedGutter?0:n.gutters.offsetWidth,h=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:n.scroller.scrollLeft-u,p=Qn(e)-n.gutters.offsetWidth,f=t.right-t.left>p;return f&&(t.right=t.left+p),t.left<10?o.scrollLeft=0:t.left<h?o.scrollLeft=Math.max(0,t.left+u-(f?0:10)):t.right>p+h-3&&(o.scrollLeft=t.right+(f?0:10)-p),o}function dr(e,t){null!=t&&(fr(e),e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+t)}function ur(e){fr(e);var t=e.getCursor();e.curOp.scrollToPos={from:t,to:t,margin:e.options.cursorScrollMargin}}function hr(e,t,n){(null!=t||null!=n)&&fr(e),null!=t&&(e.curOp.scrollLeft=t),null!=n&&(e.curOp.scrollTop=n)}function pr(e,t){fr(e),e.curOp.scrollToPos=t}function fr(e){var t=e.curOp.scrollToPos;t&&(e.curOp.scrollToPos=null,gr(e,ki(e,t.from),ki(e,t.to),t.margin))}function gr(e,t,n,i){var r=cr(e,{left:Math.min(t.left,n.left),top:Math.min(t.top,n.top)-i,right:Math.max(t.right,n.right),bottom:Math.max(t.bottom,n.bottom)+i});hr(e,r.scrollLeft,r.scrollTop)}function mr(e,t){Math.abs(e.doc.scrollTop-t)<2||(n||Jr(e,{top:t}),vr(e,t,!0),n&&Jr(e),Fr(e,100))}function vr(e,t,n){t=Math.max(0,Math.min(e.display.scroller.scrollHeight-e.display.scroller.clientHeight,t)),(e.display.scroller.scrollTop!=t||n)&&(e.doc.scrollTop=t,e.display.scrollbars.setScrollTop(t),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t))}function yr(e,t,n,i){t=Math.max(0,Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth)),(!(n?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)||i)&&(e.doc.scrollLeft=t,Xr(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbars.setScrollLeft(t))}function br(e){var t=e.display,n=t.gutters.offsetWidth,i=Math.round(e.doc.height+Zn(e.display));return{clientHeight:t.scroller.clientHeight,viewHeight:t.wrapper.clientHeight,scrollWidth:t.scroller.scrollWidth,clientWidth:t.scroller.clientWidth,viewWidth:t.wrapper.clientWidth,barLeft:e.options.fixedGutter?n:0,docHeight:i,scrollHeight:i+Kn(e)+t.barHeight,nativeBarWidth:t.nativeBarWidth,gutterWidth:n}}var Sr=function(e,t,n){this.cm=n;var i=this.vert=M("div",[M("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),r=this.horiz=M("div",[M("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");i.tabIndex=r.tabIndex=-1,e(i),e(r),be(i,"scroll",(function(){i.clientHeight&&t(i.scrollTop,"vertical")})),be(r,"scroll",(function(){r.clientWidth&&t(r.scrollLeft,"horizontal")})),this.checkedZeroWidth=!1,o&&a<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Sr.prototype.update=function(e){var t=e.scrollWidth>e.clientWidth+1,n=e.scrollHeight>e.clientHeight+1,i=e.nativeBarWidth;if(n){this.vert.style.display="block",this.vert.style.bottom=t?i+"px":"0";var r=e.viewHeight-(t?i:0);this.vert.firstChild.style.height=Math.max(0,e.scrollHeight-e.clientHeight+r)+"px"}else this.vert.scrollTop=0,this.vert.style.display="",this.vert.firstChild.style.height="0";if(t){this.horiz.style.display="block",this.horiz.style.right=n?i+"px":"0",this.horiz.style.left=e.barLeft+"px";var s=e.viewWidth-e.barLeft-(n?i:0);this.horiz.firstChild.style.width=Math.max(0,e.scrollWidth-e.clientWidth+s)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&e.clientHeight>0&&(0==i&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:n?i:0,bottom:t?i:0}},Sr.prototype.setScrollLeft=function(e){this.horiz.scrollLeft!=e&&(this.horiz.scrollLeft=e),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Sr.prototype.setScrollTop=function(e){this.vert.scrollTop!=e&&(this.vert.scrollTop=e),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Sr.prototype.zeroWidthHack=function(){var e=b&&!f?"12px":"18px";this.horiz.style.height=this.vert.style.width=e,this.horiz.style.visibility=this.vert.style.visibility="hidden",this.disableHoriz=new $,this.disableVert=new $},Sr.prototype.enableZeroWidthBar=function(e,t,n){function i(){var r=e.getBoundingClientRect();("vert"==n?document.elementFromPoint(r.right-1,(r.top+r.bottom)/2):document.elementFromPoint((r.right+r.left)/2,r.bottom-1))!=e?e.style.visibility="hidden":t.set(1e3,i)}e.style.visibility="",t.set(1e3,i)},Sr.prototype.clear=function(){var e=this.horiz.parentNode;e.removeChild(this.horiz),e.removeChild(this.vert)};var wr=function(){};function xr(e,t){t||(t=br(e));var n=e.display.barWidth,i=e.display.barHeight;Cr(e,t);for(var r=0;r<4&&n!=e.display.barWidth||i!=e.display.barHeight;r++)n!=e.display.barWidth&&e.options.lineWrapping&&ir(e),Cr(e,br(e)),n=e.display.barWidth,i=e.display.barHeight}function Cr(e,t){var n=e.display,i=n.scrollbars.update(t);n.sizer.style.paddingRight=(n.barWidth=i.right)+"px",n.sizer.style.paddingBottom=(n.barHeight=i.bottom)+"px",n.heightForcer.style.borderBottom=i.bottom+"px solid transparent",i.right&&i.bottom?(n.scrollbarFiller.style.display="block",n.scrollbarFiller.style.height=i.bottom+"px",n.scrollbarFiller.style.width=i.right+"px"):n.scrollbarFiller.style.display="",i.bottom&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(n.gutterFiller.style.display="block",n.gutterFiller.style.height=i.bottom+"px",n.gutterFiller.style.width=t.gutterWidth+"px"):n.gutterFiller.style.display=""}wr.prototype.update=function(){return{bottom:0,right:0}},wr.prototype.setScrollLeft=function(){},wr.prototype.setScrollTop=function(){},wr.prototype.clear=function(){};var kr={native:Sr,null:wr};function Tr(e){e.display.scrollbars&&(e.display.scrollbars.clear(),e.display.scrollbars.addClass&&L(e.display.wrapper,e.display.scrollbars.addClass)),e.display.scrollbars=new kr[e.options.scrollbarStyle]((function(t){e.display.wrapper.insertBefore(t,e.display.scrollbarFiller),be(t,"mousedown",(function(){e.state.focused&&setTimeout((function(){return e.display.input.focus()}),0)})),t.setAttribute("cm-not-content","true")}),(function(t,n){"horizontal"==n?yr(e,t):mr(e,t)}),e),e.display.scrollbars.addClass&&N(e.display.wrapper,e.display.scrollbars.addClass)}var Er=0;function Lr(e){e.curOp={cm:e,viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++Er,markArrays:null},Dn(e.curOp)}function Ir(e){var t=e.curOp;t&&Pn(t,(function(e){for(var t=0;t<e.ops.length;t++)e.ops[t].cm.curOp=null;Dr(e)}))}function Dr(e){for(var t=e.ops,n=0;n<t.length;n++)Mr(t[n]);for(var i=0;i<t.length;i++)Pr(t[i]);for(var r=0;r<t.length;r++)Ar(t[r]);for(var s=0;s<t.length;s++)Rr(t[s]);for(var o=0;o<t.length;o++)Nr(t[o])}function Mr(e){var t=e.cm,n=t.display;Gr(t),e.updateMaxLine&&hn(t),e.mustUpdate=e.viewChanged||e.forceUpdate||null!=e.scrollTop||e.scrollToPos&&(e.scrollToPos.from.line<n.viewFrom||e.scrollToPos.to.line>=n.viewTo)||n.maxLineChanged&&t.options.lineWrapping,e.update=e.mustUpdate&&new Ur(t,e.mustUpdate&&{top:e.scrollTop,ensure:e.scrollToPos},e.forceUpdate)}function Pr(e){e.updatedDisplay=e.mustUpdate&&jr(e.cm,e.update)}function Ar(e){var t=e.cm,n=t.display;e.updatedDisplay&&ir(t),e.barMeasure=br(t),n.maxLineChanged&&!t.options.lineWrapping&&(e.adjustWidthTo=ri(t,n.maxLine,n.maxLine.text.length).left+3,t.display.sizerWidth=e.adjustWidthTo,e.barMeasure.scrollWidth=Math.max(n.scroller.clientWidth,n.sizer.offsetLeft+e.adjustWidthTo+Kn(t)+t.display.barWidth),e.maxScrollLeft=Math.max(0,n.sizer.offsetLeft+e.adjustWidthTo-Qn(t))),(e.updatedDisplay||e.selectionChanged)&&(e.preparedSelection=n.input.prepareSelection())}function Rr(e){var t=e.cm;null!=e.adjustWidthTo&&(t.display.sizer.style.minWidth=e.adjustWidthTo+"px",e.maxScrollLeft<t.doc.scrollLeft&&yr(t,Math.min(t.display.scroller.scrollLeft,e.maxScrollLeft),!0),t.display.maxLineChanged=!1);var n=e.focus&&e.focus==R(_(t));e.preparedSelection&&t.display.input.showSelection(e.preparedSelection,n),(e.updatedDisplay||e.startHeight!=t.doc.height)&&xr(t,e.barMeasure),e.updatedDisplay&&Zr(t,e.barMeasure),e.selectionChanged&&Ki(t),t.state.focused&&e.updateInput&&t.display.input.reset(e.typing),n&&Qi(e.cm)}function Nr(e){var t=e.cm,n=t.display,i=t.doc;e.updatedDisplay&&Hr(t,e.update),null!=n.wheelStartX&&(null!=e.scrollTop||null!=e.scrollLeft||e.scrollToPos)&&(n.wheelStartX=n.wheelStartY=null),null!=e.scrollTop&&vr(t,e.scrollTop,e.forceScroll),null!=e.scrollLeft&&yr(t,e.scrollLeft,!0,!0),e.scrollToPos&&or(t,ar(t,mt(i,e.scrollToPos.from),mt(i,e.scrollToPos.to),e.scrollToPos.margin));var r=e.maybeHiddenMarkers,s=e.maybeUnhiddenMarkers;if(r)for(var o=0;o<r.length;++o)r[o].lines.length||xe(r[o],"hide");if(s)for(var a=0;a<s.length;++a)s[a].lines.length&&xe(s[a],"unhide");n.wrapper.offsetHeight&&(i.scrollTop=t.display.scroller.scrollTop),e.changeObjs&&xe(t,"changes",t,e.changeObjs),e.update&&e.update.finish()}function Vr(e,t){if(e.curOp)return t();Lr(e);try{return t()}finally{Ir(e)}}function Or(e,t){return function(){if(e.curOp)return t.apply(e,arguments);Lr(e);try{return t.apply(e,arguments)}finally{Ir(e)}}}function Br(e){return function(){if(this.curOp)return e.apply(this,arguments);Lr(this);try{return e.apply(this,arguments)}finally{Ir(this)}}}function _r(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);Lr(t);try{return e.apply(this,arguments)}finally{Ir(t)}}}function Fr(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,U(zr,e))}function zr(e){var t=e.doc;if(!(t.highlightFrontier>=e.display.viewTo)){var n=+new Date+e.options.workTime,i=Ct(e,t.highlightFrontier),r=[];t.iter(i.line,Math.min(t.first+t.size,e.display.viewTo+500),(function(s){if(i.line>=e.display.viewFrom){var o=s.styles,a=s.text.length>e.options.maxHighlightLength?Xe(t.mode,i.state):null,l=wt(e,s,i,!0);a&&(i.state=a),s.styles=l.styles;var c=s.styleClasses,d=l.classes;d?s.styleClasses=d:c&&(s.styleClasses=null);for(var u=!o||o.length!=s.styles.length||c!=d&&(!c||!d||c.bgClass!=d.bgClass||c.textClass!=d.textClass),h=0;!u&&h<o.length;++h)u=o[h]!=s.styles[h];u&&r.push(i.line),s.stateAfter=i.save(),i.nextLine()}else s.text.length<=e.options.maxHighlightLength&&kt(e,s.text,i),s.stateAfter=i.line%5==0?i.save():null,i.nextLine();if(+new Date>n)return Fr(e,e.options.workDelay),!0})),t.highlightFrontier=i.line,t.modeFrontier=Math.max(t.modeFrontier,i.line),r.length&&Vr(e,(function(){for(var t=0;t<r.length;t++)Gi(e,r[t],"text")}))}}var Ur=function(e,t,n){var i=e.display;this.viewport=t,this.visible=sr(i,e.doc,t),this.editorIsHidden=!i.wrapper.offsetWidth,this.wrapperHeight=i.wrapper.clientHeight,this.wrapperWidth=i.wrapper.clientWidth,this.oldDisplayWidth=Qn(e),this.force=n,this.dims=Vi(e),this.events=[]};function Gr(e){var t=e.display;!t.scrollbarsClipped&&t.scroller.offsetWidth&&(t.nativeBarWidth=t.scroller.offsetWidth-t.scroller.clientWidth,t.heightForcer.style.height=Kn(e)+"px",t.sizer.style.marginBottom=-t.nativeBarWidth+"px",t.sizer.style.borderRightWidth=Kn(e)+"px",t.scrollbarsClipped=!0)}function Wr(e){if(e.hasFocus())return null;var t=R(_(e));if(!t||!A(e.display.lineDiv,t))return null;var n={activeElt:t};if(window.getSelection){var i=z(e).getSelection();i.anchorNode&&i.extend&&A(e.display.lineDiv,i.anchorNode)&&(n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset)}return n}function $r(e){if(e&&e.activeElt&&e.activeElt!=R(F(e.activeElt))&&(e.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(e.activeElt.nodeName)&&e.anchorNode&&A(document.body,e.anchorNode)&&A(document.body,e.focusNode))){var t=e.activeElt.ownerDocument,n=t.defaultView.getSelection(),i=t.createRange();i.setEnd(e.anchorNode,e.anchorOffset),i.collapse(!1),n.removeAllRanges(),n.addRange(i),n.extend(e.focusNode,e.focusOffset)}}function jr(e,t){var n=e.display,i=e.doc;if(t.editorIsHidden)return Wi(e),!1;if(!t.force&&t.visible.from>=n.viewFrom&&t.visible.to<=n.viewTo&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo)&&n.renderedView==n.view&&0==Hi(e))return!1;Kr(e)&&(Wi(e),t.dims=Vi(e));var r=i.first+i.size,s=Math.max(t.visible.from-e.options.viewportMargin,i.first),o=Math.min(r,t.visible.to+e.options.viewportMargin);n.viewFrom<s&&s-n.viewFrom<20&&(s=Math.max(i.first,n.viewFrom)),n.viewTo>o&&n.viewTo-o<20&&(o=Math.min(r,n.viewTo)),Nt&&(s=on(e.doc,s),o=an(e.doc,o));var a=s!=n.viewFrom||o!=n.viewTo||n.lastWrapHeight!=t.wrapperHeight||n.lastWrapWidth!=t.wrapperWidth;ji(e,s,o),n.viewOffset=dn(tt(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var l=Hi(e);if(!a&&0==l&&!t.force&&n.renderedView==n.view&&(null==n.updateLineNumbers||n.updateLineNumbers>=n.viewTo))return!1;var c=Wr(e);return l>4&&(n.lineDiv.style.display="none"),qr(e,n.updateLineNumbers,t.dims),l>4&&(n.lineDiv.style.display=""),n.renderedView=n.view,$r(c),I(n.cursorDiv),I(n.selectionDiv),n.gutters.style.height=n.sizer.style.minHeight=0,a&&(n.lastWrapHeight=t.wrapperHeight,n.lastWrapWidth=t.wrapperWidth,Fr(e,400)),n.updateLineNumbers=null,!0}function Hr(e,t){for(var n=t.viewport,i=!0;;i=!1){if(i&&e.options.lineWrapping&&t.oldDisplayWidth!=Qn(e))i&&(t.visible=sr(e.display,e.doc,n));else if(n&&null!=n.top&&(n={top:Math.min(e.doc.height+Zn(e.display)-ei(e),n.top)}),t.visible=sr(e.display,e.doc,n),t.visible.from>=e.display.viewFrom&&t.visible.to<=e.display.viewTo)break;if(!jr(e,t))break;ir(e);var r=br(e);Ji(e),xr(e,r),Zr(e,r),t.force=!1}t.signal(e,"update",e),(e.display.viewFrom!=e.display.reportedViewFrom||e.display.viewTo!=e.display.reportedViewTo)&&(t.signal(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo),e.display.reportedViewFrom=e.display.viewFrom,e.display.reportedViewTo=e.display.viewTo)}function Jr(e,t){var n=new Ur(e,t);if(jr(e,n)){ir(e),Hr(e,n);var i=br(e);Ji(e),xr(e,i),Zr(e,i),n.finish()}}function qr(e,t,n){var i=e.display,r=e.options.lineNumbers,s=i.lineDiv,o=s.firstChild;function a(t){var n=t.nextSibling;return l&&b&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),n}for(var c=i.view,d=i.viewFrom,u=0;u<c.length;u++){var h=c[u];if(!h.hidden)if(h.node&&h.node.parentNode==s){for(;o!=h.node;)o=a(o);var p=r&&null!=t&&t<=d&&h.lineNumber;h.changes&&(j(h.changes,"gutter")>-1&&(p=!1),Vn(e,h,d,n)),p&&(I(h.lineNumber),h.lineNumber.appendChild(document.createTextNode(lt(e.options,d)))),o=h.node.nextSibling}else{var f=Wn(e,h,d,n);s.insertBefore(f,o)}d+=h.size}for(;o;)o=a(o)}function Yr(e){var t=e.gutters.offsetWidth;e.sizer.style.marginLeft=t+"px",Rn(e,"gutterChanged",e)}function Zr(e,t){e.display.sizer.style.minHeight=t.docHeight+"px",e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=t.docHeight+e.display.barHeight+Kn(e)+"px"}function Xr(e){var t=e.display,n=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var i=Oi(t)-t.scroller.scrollLeft+e.doc.scrollLeft,r=t.gutters.offsetWidth,s=i+"px",o=0;o<n.length;o++)if(!n[o].hidden){e.options.fixedGutter&&(n[o].gutter&&(n[o].gutter.style.left=s),n[o].gutterBackground&&(n[o].gutterBackground.style.left=s));var a=n[o].alignable;if(a)for(var l=0;l<a.length;l++)a[l].style.left=s}e.options.fixedGutter&&(t.gutters.style.left=i+r+"px")}}function Kr(e){if(!e.options.lineNumbers)return!1;var t=e.doc,n=lt(e.options,t.first+t.size-1),i=e.display;if(n.length!=i.lineNumChars){var r=i.measure.appendChild(M("div",[M("div",n)],"CodeMirror-linenumber CodeMirror-gutter-elt")),s=r.firstChild.offsetWidth,o=r.offsetWidth-s;return i.lineGutter.style.width="",i.lineNumInnerWidth=Math.max(s,i.lineGutter.offsetWidth-o)+1,i.lineNumWidth=i.lineNumInnerWidth+o,i.lineNumChars=i.lineNumInnerWidth?n.length:-1,i.lineGutter.style.width=i.lineNumWidth+"px",Yr(e.display),!0}return!1}function Qr(e,t){for(var n=[],i=!1,r=0;r<e.length;r++){var s=e[r],o=null;if("string"!=typeof s&&(o=s.style,s=s.className),"CodeMirror-linenumbers"==s){if(!t)continue;i=!0}n.push({className:s,style:o})}return t&&!i&&n.push({className:"CodeMirror-linenumbers",style:null}),n}function es(e){var t=e.gutters,n=e.gutterSpecs;I(t),e.lineGutter=null;for(var i=0;i<n.length;++i){var r=n[i],s=r.className,o=r.style,a=t.appendChild(M("div",null,"CodeMirror-gutter "+s));o&&(a.style.cssText=o),"CodeMirror-linenumbers"==s&&(e.lineGutter=a,a.style.width=(e.lineNumWidth||1)+"px")}t.style.display=n.length?"":"none",Yr(e)}function ts(e){es(e.display),Ui(e),Xr(e)}function ns(e,t,i,r){var s=this;this.input=i,s.scrollbarFiller=M("div",null,"CodeMirror-scrollbar-filler"),s.scrollbarFiller.setAttribute("cm-not-content","true"),s.gutterFiller=M("div",null,"CodeMirror-gutter-filler"),s.gutterFiller.setAttribute("cm-not-content","true"),s.lineDiv=P("div",null,"CodeMirror-code"),s.selectionDiv=M("div",null,null,"position: relative; z-index: 1"),s.cursorDiv=M("div",null,"CodeMirror-cursors"),s.measure=M("div",null,"CodeMirror-measure"),s.lineMeasure=M("div",null,"CodeMirror-measure"),s.lineSpace=P("div",[s.measure,s.lineMeasure,s.selectionDiv,s.cursorDiv,s.lineDiv],null,"position: relative; outline: none");var c=P("div",[s.lineSpace],"CodeMirror-lines");s.mover=M("div",[c],null,"position: relative"),s.sizer=M("div",[s.mover],"CodeMirror-sizer"),s.sizerWidth=null,s.heightForcer=M("div",null,null,"position: absolute; height: "+H+"px; width: 1px;"),s.gutters=M("div",null,"CodeMirror-gutters"),s.lineGutter=null,s.scroller=M("div",[s.sizer,s.heightForcer,s.gutters],"CodeMirror-scroll"),s.scroller.setAttribute("tabIndex","-1"),s.wrapper=M("div",[s.scrollbarFiller,s.gutterFiller,s.scroller],"CodeMirror"),d&&u>=105&&(s.wrapper.style.clipPath="inset(0px)"),s.wrapper.setAttribute("translate","no"),o&&a<8&&(s.gutters.style.zIndex=-1,s.scroller.style.paddingRight=0),!l&&!(n&&y)&&(s.scroller.draggable=!0),e&&(e.appendChild?e.appendChild(s.wrapper):e(s.wrapper)),s.viewFrom=s.viewTo=t.first,s.reportedViewFrom=s.reportedViewTo=t.first,s.view=[],s.renderedView=null,s.externalMeasured=null,s.viewOffset=0,s.lastWrapHeight=s.lastWrapWidth=0,s.updateLineNumbers=null,s.nativeBarWidth=s.barHeight=s.barWidth=0,s.scrollbarsClipped=!1,s.lineNumWidth=s.lineNumInnerWidth=s.lineNumChars=null,s.alignWidgets=!1,s.cachedCharWidth=s.cachedTextHeight=s.cachedPaddingH=null,s.maxLine=null,s.maxLineLength=0,s.maxLineChanged=!1,s.wheelDX=s.wheelDY=s.wheelStartX=s.wheelStartY=null,s.shift=!1,s.selForContextMenu=null,s.activeTouch=null,s.gutterSpecs=Qr(r.gutters,r.lineNumbers),es(s),i.init(s)}Ur.prototype.signal=function(e,t){Te(e,t)&&this.events.push(arguments)},Ur.prototype.finish=function(){for(var e=0;e<this.events.length;e++)xe.apply(null,this.events[e])};var is=0,rs=null;function ss(e){var t=e.wheelDeltaX,n=e.wheelDeltaY;return null==t&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(t=e.detail),null==n&&e.detail&&e.axis==e.VERTICAL_AXIS?n=e.detail:null==n&&(n=e.wheelDelta),{x:t,y:n}}function os(e){var t=ss(e);return t.x*=rs,t.y*=rs,t}function as(e,t){d&&102==u&&(null==e.display.chromeScrollHack?e.display.sizer.style.pointerEvents="none":clearTimeout(e.display.chromeScrollHack),e.display.chromeScrollHack=setTimeout((function(){e.display.chromeScrollHack=null,e.display.sizer.style.pointerEvents=""}),100));var i=ss(t),r=i.x,s=i.y,o=rs;0===t.deltaMode&&(r=t.deltaX,s=t.deltaY,o=1);var a=e.display,c=a.scroller,p=c.scrollWidth>c.clientWidth,f=c.scrollHeight>c.clientHeight;if(r&&p||s&&f){if(s&&b&&l)e:for(var g=t.target,m=a.view;g!=c;g=g.parentNode)for(var v=0;v<m.length;v++)if(m[v].node==g){e.display.currentWheelTarget=g;break e}if(r&&!n&&!h&&null!=o)return s&&f&&mr(e,Math.max(0,c.scrollTop+s*o)),yr(e,Math.max(0,c.scrollLeft+r*o)),(!s||s&&f)&&Le(t),void(a.wheelStartX=null);if(s&&null!=o){var y=s*o,S=e.doc.scrollTop,w=S+a.wrapper.clientHeight;y<0?S=Math.max(0,S+y-50):w=Math.min(e.doc.height,w+y+50),Jr(e,{top:S,bottom:w})}is<20&&0!==t.deltaMode&&(null==a.wheelStartX?(a.wheelStartX=c.scrollLeft,a.wheelStartY=c.scrollTop,a.wheelDX=r,a.wheelDY=s,setTimeout((function(){if(null!=a.wheelStartX){var e=c.scrollLeft-a.wheelStartX,t=c.scrollTop-a.wheelStartY,n=t&&a.wheelDY&&t/a.wheelDY||e&&a.wheelDX&&e/a.wheelDX;a.wheelStartX=a.wheelStartY=null,n&&(rs=(rs*is+n)/(is+1),++is)}}),200)):(a.wheelDX+=r,a.wheelDY+=s))}}o?rs=-.53:n?rs=15:d?rs=-.7:p&&(rs=-1/3);var ls=function(e,t){this.ranges=e,this.primIndex=t};ls.prototype.primary=function(){return this.ranges[this.primIndex]},ls.prototype.equals=function(e){if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var t=0;t<this.ranges.length;t++){var n=this.ranges[t],i=e.ranges[t];if(!ut(n.anchor,i.anchor)||!ut(n.head,i.head))return!1}return!0},ls.prototype.deepCopy=function(){for(var e=[],t=0;t<this.ranges.length;t++)e[t]=new cs(ht(this.ranges[t].anchor),ht(this.ranges[t].head));return new ls(e,this.primIndex)},ls.prototype.somethingSelected=function(){for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].empty())return!0;return!1},ls.prototype.contains=function(e,t){t||(t=e);for(var n=0;n<this.ranges.length;n++){var i=this.ranges[n];if(dt(t,i.from())>=0&&dt(e,i.to())<=0)return n}return-1};var cs=function(e,t){this.anchor=e,this.head=t};function ds(e,t,n){var i=e&&e.options.selectionsMayTouch,r=t[n];t.sort((function(e,t){return dt(e.from(),t.from())})),n=j(t,r);for(var s=1;s<t.length;s++){var o=t[s],a=t[s-1],l=dt(a.to(),o.from());if(i&&!o.empty()?l>0:l>=0){var c=ft(a.from(),o.from()),d=pt(a.to(),o.to()),u=a.empty()?o.from()==o.head:a.from()==a.head;s<=n&&--n,t.splice(--s,2,new cs(u?d:c,u?c:d))}}return new ls(t,n)}function us(e,t){return new ls([new cs(e,t||e)],0)}function hs(e){return e.text?ct(e.from.line+e.text.length-1,ee(e.text).length+(1==e.text.length?e.from.ch:0)):e.to}function ps(e,t){if(dt(e,t.from)<0)return e;if(dt(e,t.to)<=0)return hs(t);var n=e.line+t.text.length-(t.to.line-t.from.line)-1,i=e.ch;return e.line==t.to.line&&(i+=hs(t).ch-t.to.ch),ct(n,i)}function fs(e,t){for(var n=[],i=0;i<e.sel.ranges.length;i++){var r=e.sel.ranges[i];n.push(new cs(ps(r.anchor,t),ps(r.head,t)))}return ds(e.cm,n,e.sel.primIndex)}function gs(e,t,n){return e.line==t.line?ct(n.line,e.ch-t.ch+n.ch):ct(n.line+(e.line-t.line),e.ch)}function ms(e,t,n){for(var i=[],r=ct(e.first,0),s=r,o=0;o<t.length;o++){var a=t[o],l=gs(a.from,r,s),c=gs(hs(a),r,s);if(r=a.to,s=c,"around"==n){var d=e.sel.ranges[o],u=dt(d.head,d.anchor)<0;i[o]=new cs(u?c:l,u?l:c)}else i[o]=new cs(l,l)}return new ls(i,e.sel.primIndex)}function vs(e){e.doc.mode=qe(e.options,e.doc.modeOption),ys(e)}function ys(e){e.doc.iter((function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)})),e.doc.modeFrontier=e.doc.highlightFrontier=e.doc.first,Fr(e,100),e.state.modeGen++,e.curOp&&Ui(e)}function bs(e,t){return 0==t.from.ch&&0==t.to.ch&&""==ee(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function Ss(e,t,n,i){function r(e){return n?n[e]:null}function s(e,n,r){fn(e,n,r,i),Rn(e,"change",e,t)}function o(e,t){for(var n=[],s=e;s<t;++s)n.push(new pn(c[s],r(s),i));return n}var a=t.from,l=t.to,c=t.text,d=tt(e,a.line),u=tt(e,l.line),h=ee(c),p=r(c.length-1),f=l.line-a.line;if(t.full)e.insert(0,o(0,c.length)),e.remove(c.length,e.size-c.length);else if(bs(e,t)){var g=o(0,c.length-1);s(u,u.text,p),f&&e.remove(a.line,f),g.length&&e.insert(a.line,g)}else if(d==u)if(1==c.length)s(d,d.text.slice(0,a.ch)+h+d.text.slice(l.ch),p);else{var m=o(1,c.length-1);m.push(new pn(h+d.text.slice(l.ch),p,i)),s(d,d.text.slice(0,a.ch)+c[0],r(0)),e.insert(a.line+1,m)}else if(1==c.length)s(d,d.text.slice(0,a.ch)+c[0]+u.text.slice(l.ch),r(0)),e.remove(a.line+1,f);else{s(d,d.text.slice(0,a.ch)+c[0],r(0)),s(u,h+u.text.slice(l.ch),p);var v=o(1,c.length-1);f>1&&e.remove(a.line+1,f-1),e.insert(a.line+1,v)}Rn(e,"change",e,t)}function ws(e,t,n){function i(e,r,s){if(e.linked)for(var o=0;o<e.linked.length;++o){var a=e.linked[o];if(a.doc!=r){var l=s&&a.sharedHist;n&&!l||(t(a.doc,l),i(a.doc,e,l))}}}i(e,null,!0)}function xs(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,_i(e),vs(e),Cs(e),e.options.direction=t.direction,e.options.lineWrapping||hn(e),e.options.mode=t.modeOption,Ui(e)}function Cs(e){("rtl"==e.doc.direction?N:L)(e.display.lineDiv,"CodeMirror-rtl")}function ks(e){Vr(e,(function(){Cs(e),Ui(e)}))}function Ts(e){this.done=[],this.undone=[],this.undoDepth=e?e.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e?e.maxGeneration:1}function Es(e,t){var n={from:ht(t.from),to:hs(t),text:nt(e,t.from,t.to)};return Rs(e,n,t.from.line,t.to.line+1),ws(e,(function(e){return Rs(e,n,t.from.line,t.to.line+1)}),!0),n}function Ls(e){for(;e.length&&ee(e).ranges;)e.pop()}function Is(e,t){return t?(Ls(e.done),ee(e.done)):e.done.length&&!ee(e.done).ranges?ee(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),ee(e.done)):void 0}function Ds(e,t,n,i){var r=e.history;r.undone.length=0;var s,o,a=+new Date;if((r.lastOp==i||r.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&r.lastModTime>a-(e.cm?e.cm.options.historyEventDelay:500)||"*"==t.origin.charAt(0)))&&(s=Is(r,r.lastOp==i)))o=ee(s.changes),0==dt(t.from,t.to)&&0==dt(t.from,o.to)?o.to=hs(t):s.changes.push(Es(e,t));else{var l=ee(r.done);for((!l||!l.ranges)&&As(e.sel,r.done),s={changes:[Es(e,t)],generation:r.generation},r.done.push(s);r.done.length>r.undoDepth;)r.done.shift(),r.done[0].ranges||r.done.shift()}r.done.push(n),r.generation=++r.maxGeneration,r.lastModTime=r.lastSelTime=a,r.lastOp=r.lastSelOp=i,r.lastOrigin=r.lastSelOrigin=t.origin,o||xe(e,"historyAdded")}function Ms(e,t,n,i){var r=t.charAt(0);return"*"==r||"+"==r&&n.ranges.length==i.ranges.length&&n.somethingSelected()==i.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}function Ps(e,t,n,i){var r=e.history,s=i&&i.origin;n==r.lastSelOp||s&&r.lastSelOrigin==s&&(r.lastModTime==r.lastSelTime&&r.lastOrigin==s||Ms(e,s,ee(r.done),t))?r.done[r.done.length-1]=t:As(t,r.done),r.lastSelTime=+new Date,r.lastSelOrigin=s,r.lastSelOp=n,i&&!1!==i.clearRedo&&Ls(r.undone)}function As(e,t){var n=ee(t);n&&n.ranges&&n.equals(e)||t.push(e)}function Rs(e,t,n,i){var r=t["spans_"+e.id],s=0;e.iter(Math.max(e.first,n),Math.min(e.first+e.size,i),(function(n){n.markedSpans&&((r||(r=t["spans_"+e.id]={}))[s]=n.markedSpans),++s}))}function Ns(e){if(!e)return null;for(var t,n=0;n<e.length;++n)e[n].marker.explicitlyCleared?t||(t=e.slice(0,n)):t&&t.push(e[n]);return t?t.length?t:null:e}function Vs(e,t){var n=t["spans_"+e.id];if(!n)return null;for(var i=[],r=0;r<t.text.length;++r)i.push(Ns(n[r]));return i}function Os(e,t){var n=Vs(e,t),i=Wt(e,t);if(!n)return i;if(!i)return n;for(var r=0;r<n.length;++r){var s=n[r],o=i[r];if(s&&o)e:for(var a=0;a<o.length;++a){for(var l=o[a],c=0;c<s.length;++c)if(s[c].marker==l.marker)continue e;s.push(l)}else o&&(n[r]=o)}return n}function Bs(e,t,n){for(var i=[],r=0;r<e.length;++r){var s=e[r];if(s.ranges)i.push(n?ls.prototype.deepCopy.call(s):s);else{var o=s.changes,a=[];i.push({changes:a});for(var l=0;l<o.length;++l){var c=o[l],d=void 0;if(a.push({from:c.from,to:c.to,text:c.text}),t)for(var u in c)(d=u.match(/^spans_(\d+)$/))&&j(t,Number(d[1]))>-1&&(ee(a)[u]=c[u],delete c[u])}}}return i}function _s(e,t,n,i){if(i){var r=e.anchor;if(n){var s=dt(t,r)<0;s!=dt(n,r)<0?(r=t,t=n):s!=dt(t,n)<0&&(t=n)}return new cs(r,t)}return new cs(n||t,t)}function Fs(e,t,n,i,r){null==r&&(r=e.cm&&(e.cm.display.shift||e.extend)),js(e,new ls([_s(e.sel.primary(),t,n,r)],0),i)}function zs(e,t,n){for(var i=[],r=e.cm&&(e.cm.display.shift||e.extend),s=0;s<e.sel.ranges.length;s++)i[s]=_s(e.sel.ranges[s],t[s],null,r);js(e,ds(e.cm,i,e.sel.primIndex),n)}function Us(e,t,n,i){var r=e.sel.ranges.slice(0);r[t]=n,js(e,ds(e.cm,r,e.sel.primIndex),i)}function Gs(e,t,n,i){js(e,us(t,n),i)}function Ws(e,t,n){var i={ranges:t.ranges,update:function(t){this.ranges=[];for(var n=0;n<t.length;n++)this.ranges[n]=new cs(mt(e,t[n].anchor),mt(e,t[n].head))},origin:n&&n.origin};return xe(e,"beforeSelectionChange",e,i),e.cm&&xe(e.cm,"beforeSelectionChange",e.cm,i),i.ranges!=t.ranges?ds(e.cm,i.ranges,i.ranges.length-1):t}function $s(e,t,n){var i=e.history.done,r=ee(i);r&&r.ranges?(i[i.length-1]=t,Hs(e,t,n)):js(e,t,n)}function js(e,t,n){Hs(e,t,n),Ps(e,e.sel,e.cm?e.cm.curOp.id:NaN,n)}function Hs(e,t,n){(Te(e,"beforeSelectionChange")||e.cm&&Te(e.cm,"beforeSelectionChange"))&&(t=Ws(e,t,n));var i=n&&n.bias||(dt(t.primary().head,e.sel.primary().head)<0?-1:1);Js(e,Ys(e,t,i,!0)),(!n||!1!==n.scroll)&&e.cm&&"nocursor"!=e.cm.getOption("readOnly")&&ur(e.cm)}function Js(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=1,e.cm.curOp.selectionChanged=!0,ke(e.cm)),Rn(e,"cursorActivity",e))}function qs(e){Js(e,Ys(e,e.sel,null,!1))}function Ys(e,t,n,i){for(var r,s=0;s<t.ranges.length;s++){var o=t.ranges[s],a=t.ranges.length==e.sel.ranges.length&&e.sel.ranges[s],l=Xs(e,o.anchor,a&&a.anchor,n,i),c=o.head==o.anchor?l:Xs(e,o.head,a&&a.head,n,i);(r||l!=o.anchor||c!=o.head)&&(r||(r=t.ranges.slice(0,s)),r[s]=new cs(l,c))}return r?ds(e.cm,r,t.primIndex):t}function Zs(e,t,n,i,r){var s=tt(e,t.line);if(s.markedSpans)for(var o=0;o<s.markedSpans.length;++o){var a=s.markedSpans[o],l=a.marker,c="selectLeft"in l?!l.selectLeft:l.inclusiveLeft,d="selectRight"in l?!l.selectRight:l.inclusiveRight;if((null==a.from||(c?a.from<=t.ch:a.from<t.ch))&&(null==a.to||(d?a.to>=t.ch:a.to>t.ch))){if(r&&(xe(l,"beforeCursorEnter"),l.explicitlyCleared)){if(s.markedSpans){--o;continue}break}if(!l.atomic)continue;if(n){var u=l.find(i<0?1:-1),h=void 0;if((i<0?d:c)&&(u=Ks(e,u,-i,u&&u.line==t.line?s:null)),u&&u.line==t.line&&(h=dt(u,n))&&(i<0?h<0:h>0))return Zs(e,u,t,i,r)}var p=l.find(i<0?-1:1);return(i<0?c:d)&&(p=Ks(e,p,i,p.line==t.line?s:null)),p?Zs(e,p,t,i,r):null}}return t}function Xs(e,t,n,i,r){var s=i||1;return Zs(e,t,n,s,r)||!r&&Zs(e,t,n,s,!0)||Zs(e,t,n,-s,r)||!r&&Zs(e,t,n,-s,!0)||(e.cantEdit=!0,ct(e.first,0))}function Ks(e,t,n,i){return n<0&&0==t.ch?t.line>e.first?mt(e,ct(t.line-1)):null:n>0&&t.ch==(i||tt(e,t.line)).text.length?t.line<e.first+e.size-1?ct(t.line+1,0):null:new ct(t.line,t.ch+n)}function Qs(e){e.setSelection(ct(e.firstLine(),0),ct(e.lastLine()),q)}function eo(e,t,n){var i={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){return i.canceled=!0}};return n&&(i.update=function(t,n,r,s){t&&(i.from=mt(e,t)),n&&(i.to=mt(e,n)),r&&(i.text=r),void 0!==s&&(i.origin=s)}),xe(e,"beforeChange",e,i),e.cm&&xe(e.cm,"beforeChange",e.cm,i),i.canceled?(e.cm&&(e.cm.curOp.updateInput=2),null):{from:i.from,to:i.to,text:i.text,origin:i.origin}}function to(e,t,n){if(e.cm){if(!e.cm.curOp)return Or(e.cm,to)(e,t,n);if(e.cm.state.suppressEdits)return}if(!(Te(e,"beforeChange")||e.cm&&Te(e.cm,"beforeChange"))||(t=eo(e,t,!0))){var i=Rt&&!n&&jt(e,t.from,t.to);if(i)for(var r=i.length-1;r>=0;--r)no(e,{from:i[r].from,to:i[r].to,text:r?[""]:t.text,origin:t.origin});else no(e,t)}}function no(e,t){if(1!=t.text.length||""!=t.text[0]||0!=dt(t.from,t.to)){var n=fs(e,t);Ds(e,t,n,e.cm?e.cm.curOp.id:NaN),so(e,t,n,Wt(e,t));var i=[];ws(e,(function(e,n){!n&&-1==j(i,e.history)&&(uo(e.history,t),i.push(e.history)),so(e,t,null,Wt(e,t))}))}}function io(e,t,n){var i=e.cm&&e.cm.state.suppressEdits;if(!i||n){for(var r,s=e.history,o=e.sel,a="undo"==t?s.done:s.undone,l="undo"==t?s.undone:s.done,c=0;c<a.length&&(r=a[c],!(n?r.ranges&&!r.equals(e.sel):!r.ranges));c++);if(c!=a.length){for(s.lastOrigin=s.lastSelOrigin=null;;){if(!(r=a.pop()).ranges){if(i)return void a.push(r);break}if(As(r,l),n&&!r.equals(e.sel))return void js(e,r,{clearRedo:!1});o=r}var d=[];As(o,l),l.push({changes:d,generation:s.generation}),s.generation=r.generation||++s.maxGeneration;for(var u=Te(e,"beforeChange")||e.cm&&Te(e.cm,"beforeChange"),h=function(n){var i=r.changes[n];if(i.origin=t,u&&!eo(e,i,!1))return a.length=0,{};d.push(Es(e,i));var s=n?fs(e,i):ee(a);so(e,i,s,Os(e,i)),!n&&e.cm&&e.cm.scrollIntoView({from:i.from,to:hs(i)});var o=[];ws(e,(function(e,t){!t&&-1==j(o,e.history)&&(uo(e.history,i),o.push(e.history)),so(e,i,null,Os(e,i))}))},p=r.changes.length-1;p>=0;--p){var f=h(p);if(f)return f.v}}}}function ro(e,t){if(0!=t&&(e.first+=t,e.sel=new ls(te(e.sel.ranges,(function(e){return new cs(ct(e.anchor.line+t,e.anchor.ch),ct(e.head.line+t,e.head.ch))})),e.sel.primIndex),e.cm)){Ui(e.cm,e.first,e.first-t,t);for(var n=e.cm.display,i=n.viewFrom;i<n.viewTo;i++)Gi(e.cm,i,"gutter")}}function so(e,t,n,i){if(e.cm&&!e.cm.curOp)return Or(e.cm,so)(e,t,n,i);if(t.to.line<e.first)ro(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var r=t.text.length-1-(e.first-t.from.line);ro(e,r),t={from:ct(e.first,0),to:ct(t.to.line+r,t.to.ch),text:[ee(t.text)],origin:t.origin}}var s=e.lastLine();t.to.line>s&&(t={from:t.from,to:ct(s,tt(e,s).text.length),text:[t.text[0]],origin:t.origin}),t.removed=nt(e,t.from,t.to),n||(n=fs(e,t)),e.cm?oo(e.cm,t,i):Ss(e,t,i),Hs(e,n,q),e.cantEdit&&Xs(e,ct(e.firstLine(),0))&&(e.cantEdit=!1)}}function oo(e,t,n){var i=e.doc,r=e.display,s=t.from,o=t.to,a=!1,l=s.line;e.options.lineWrapping||(l=st(nn(tt(i,s.line))),i.iter(l,o.line+1,(function(e){if(e==r.maxLine)return a=!0,!0}))),i.sel.contains(t.from,t.to)>-1&&ke(e),Ss(i,t,n,Bi(e)),e.options.lineWrapping||(i.iter(l,s.line+t.text.length,(function(e){var t=un(e);t>r.maxLineLength&&(r.maxLine=e,r.maxLineLength=t,r.maxLineChanged=!0,a=!1)})),a&&(e.curOp.updateMaxLine=!0)),At(i,s.line),Fr(e,400);var c=t.text.length-(o.line-s.line)-1;t.full?Ui(e):s.line!=o.line||1!=t.text.length||bs(e.doc,t)?Ui(e,s.line,o.line+1,c):Gi(e,s.line,"text");var d=Te(e,"changes"),u=Te(e,"change");if(u||d){var h={from:s,to:o,text:t.text,removed:t.removed,origin:t.origin};u&&Rn(e,"change",e,h),d&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push(h)}e.display.selForContextMenu=null}function ao(e,t,n,i,r){var s;i||(i=n),dt(i,n)<0&&(n=(s=[i,n])[0],i=s[1]),"string"==typeof t&&(t=e.splitLines(t)),to(e,{from:n,to:i,text:t,origin:r})}function lo(e,t,n,i){n<e.line?e.line+=i:t<e.line&&(e.line=t,e.ch=0)}function co(e,t,n,i){for(var r=0;r<e.length;++r){var s=e[r],o=!0;if(s.ranges){s.copied||((s=e[r]=s.deepCopy()).copied=!0);for(var a=0;a<s.ranges.length;a++)lo(s.ranges[a].anchor,t,n,i),lo(s.ranges[a].head,t,n,i)}else{for(var l=0;l<s.changes.length;++l){var c=s.changes[l];if(n<c.from.line)c.from=ct(c.from.line+i,c.from.ch),c.to=ct(c.to.line+i,c.to.ch);else if(t<=c.to.line){o=!1;break}}o||(e.splice(0,r+1),r=0)}}}function uo(e,t){var n=t.from.line,i=t.to.line,r=t.text.length-(i-n)-1;co(e.done,n,i,r),co(e.undone,n,i,r)}function ho(e,t,n,i){var r=t,s=t;return"number"==typeof t?s=tt(e,gt(e,t)):r=st(t),null==r?null:(i(s,r)&&e.cm&&Gi(e.cm,r,n),s)}function po(e){this.lines=e,this.parent=null;for(var t=0,n=0;n<e.length;++n)e[n].parent=this,t+=e[n].height;this.height=t}function fo(e){this.children=e;for(var t=0,n=0,i=0;i<e.length;++i){var r=e[i];t+=r.chunkSize(),n+=r.height,r.parent=this}this.size=t,this.height=n,this.parent=null}cs.prototype.from=function(){return ft(this.anchor,this.head)},cs.prototype.to=function(){return pt(this.anchor,this.head)},cs.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch},po.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var n=e,i=e+t;n<i;++n){var r=this.lines[n];this.height-=r.height,gn(r),Rn(r,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,n){this.height+=n,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var i=0;i<t.length;++i)t[i].parent=this},iterN:function(e,t,n){for(var i=e+t;e<i;++e)if(n(this.lines[e]))return!0}},fo.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){this.size-=t;for(var n=0;n<this.children.length;++n){var i=this.children[n],r=i.chunkSize();if(e<r){var s=Math.min(t,r-e),o=i.height;if(i.removeInner(e,s),this.height-=o-i.height,r==s&&(this.children.splice(n--,1),i.parent=null),0==(t-=s))break;e=0}else e-=r}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof po))){var a=[];this.collapse(a),this.children=[new po(a)],this.children[0].parent=this}},collapse:function(e){for(var t=0;t<this.children.length;++t)this.children[t].collapse(e)},insertInner:function(e,t,n){this.size+=t.length,this.height+=n;for(var i=0;i<this.children.length;++i){var r=this.children[i],s=r.chunkSize();if(e<=s){if(r.insertInner(e,t,n),r.lines&&r.lines.length>50){for(var o=r.lines.length%25+25,a=o;a<r.lines.length;){var l=new po(r.lines.slice(a,a+=25));r.height-=l.height,this.children.splice(++i,0,l),l.parent=this}r.lines=r.lines.slice(0,o),this.maybeSpill()}break}e-=s}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new fo(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var n=j(e.parent.children,e);e.parent.children.splice(n+1,0,t)}else{var i=new fo(e.children);i.parent=e,e.children=[i,t],e=i}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,n){for(var i=0;i<this.children.length;++i){var r=this.children[i],s=r.chunkSize();if(e<s){var o=Math.min(t,s-e);if(r.iterN(e,o,n))return!0;if(0==(t-=o))break;e=0}else e-=s}}};var go=function(e,t,n){if(n)for(var i in n)n.hasOwnProperty(i)&&(this[i]=n[i]);this.doc=e,this.node=t};function mo(e,t,n){dn(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&dr(e,n)}function vo(e,t,n,i){var r=new go(e,n,i),s=e.cm;return s&&r.noHScroll&&(s.display.alignWidgets=!0),ho(e,t,"widget",(function(t){var n=t.widgets||(t.widgets=[]);if(null==r.insertAt?n.push(r):n.splice(Math.min(n.length,Math.max(0,r.insertAt)),0,r),r.line=t,s&&!ln(e,t)){var i=dn(t)<e.scrollTop;rt(t,t.height+Jn(r)),i&&dr(s,r.height),s.curOp.forceUpdate=!0}return!0})),s&&Rn(s,"lineWidgetAdded",s,r,"number"==typeof t?t:st(t)),r}go.prototype.clear=function(){var e=this.doc.cm,t=this.line.widgets,n=this.line,i=st(n);if(null!=i&&t){for(var r=0;r<t.length;++r)t[r]==this&&t.splice(r--,1);t.length||(n.widgets=null);var s=Jn(this);rt(n,Math.max(0,n.height-s)),e&&(Vr(e,(function(){mo(e,n,-s),Gi(e,i,"widget")})),Rn(e,"lineWidgetCleared",e,this,i))}},go.prototype.changed=function(){var e=this,t=this.height,n=this.doc.cm,i=this.line;this.height=null;var r=Jn(this)-t;r&&(ln(this.doc,i)||rt(i,i.height+r),n&&Vr(n,(function(){n.curOp.forceUpdate=!0,mo(n,i,r),Rn(n,"lineWidgetChanged",n,e,st(i))})))},Ee(go);var yo=0,bo=function(e,t){this.lines=[],this.type=t,this.doc=e,this.id=++yo};function So(e,t,n,i,r){if(i&&i.shared)return xo(e,t,n,i,r);if(e.cm&&!e.cm.curOp)return Or(e.cm,So)(e,t,n,i,r);var s=new bo(e,r),o=dt(t,n);if(i&&G(i,s,!1),o>0||0==o&&!1!==s.clearWhenEmpty)return s;if(s.replacedWith&&(s.collapsed=!0,s.widgetNode=P("span",[s.replacedWith],"CodeMirror-widget"),i.handleMouseEvents||s.widgetNode.setAttribute("cm-ignore-events","true"),i.insertLeft&&(s.widgetNode.insertLeft=!0)),s.collapsed){if(tn(e,t.line,t,n,s)||t.line!=n.line&&tn(e,n.line,t,n,s))throw new Error("Inserting collapsed marker partially overlapping an existing one");Ot()}s.addToHistory&&Ds(e,{from:t,to:n,origin:"markText"},e.sel,NaN);var a,l=t.line,c=e.cm;if(e.iter(l,n.line+1,(function(i){c&&s.collapsed&&!c.options.lineWrapping&&nn(i)==c.display.maxLine&&(a=!0),s.collapsed&&l!=t.line&&rt(i,0),zt(i,new Bt(s,l==t.line?t.ch:null,l==n.line?n.ch:null),e.cm&&e.cm.curOp),++l})),s.collapsed&&e.iter(t.line,n.line+1,(function(t){ln(e,t)&&rt(t,0)})),s.clearOnEnter&&be(s,"beforeCursorEnter",(function(){return s.clear()})),s.readOnly&&(Vt(),(e.history.done.length||e.history.undone.length)&&e.clearHistory()),s.collapsed&&(s.id=++yo,s.atomic=!0),c){if(a&&(c.curOp.updateMaxLine=!0),s.collapsed)Ui(c,t.line,n.line+1);else if(s.className||s.startStyle||s.endStyle||s.css||s.attributes||s.title)for(var d=t.line;d<=n.line;d++)Gi(c,d,"text");s.atomic&&qs(c.doc),Rn(c,"markerAdded",c,s)}return s}bo.prototype.clear=function(){if(!this.explicitlyCleared){var e=this.doc.cm,t=e&&!e.curOp;if(t&&Lr(e),Te(this,"clear")){var n=this.find();n&&Rn(this,"clear",n.from,n.to)}for(var i=null,r=null,s=0;s<this.lines.length;++s){var o=this.lines[s],a=_t(o.markedSpans,this);e&&!this.collapsed?Gi(e,st(o),"text"):e&&(null!=a.to&&(r=st(o)),null!=a.from&&(i=st(o))),o.markedSpans=Ft(o.markedSpans,a),null==a.from&&this.collapsed&&!ln(this.doc,o)&&e&&rt(o,Ri(e.display))}if(e&&this.collapsed&&!e.options.lineWrapping)for(var l=0;l<this.lines.length;++l){var c=nn(this.lines[l]),d=un(c);d>e.display.maxLineLength&&(e.display.maxLine=c,e.display.maxLineLength=d,e.display.maxLineChanged=!0)}null!=i&&e&&this.collapsed&&Ui(e,i,r+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,e&&qs(e.doc)),e&&Rn(e,"markerCleared",e,this,i,r),t&&Ir(e),this.parent&&this.parent.clear()}},bo.prototype.find=function(e,t){null==e&&"bookmark"==this.type&&(e=1);for(var n,i,r=0;r<this.lines.length;++r){var s=this.lines[r],o=_t(s.markedSpans,this);if(null!=o.from&&(n=ct(t?s:st(s),o.from),-1==e))return n;if(null!=o.to&&(i=ct(t?s:st(s),o.to),1==e))return i}return n&&{from:n,to:i}},bo.prototype.changed=function(){var e=this,t=this.find(-1,!0),n=this,i=this.doc.cm;!t||!i||Vr(i,(function(){var r=t.line,s=st(t.line),o=si(i,s);if(o&&(fi(o),i.curOp.selectionChanged=i.curOp.forceUpdate=!0),i.curOp.updateMaxLine=!0,!ln(n.doc,r)&&null!=n.height){var a=n.height;n.height=null;var l=Jn(n)-a;l&&rt(r,r.height+l)}Rn(i,"markerChanged",i,e)}))},bo.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(!t.maybeHiddenMarkers||-1==j(t.maybeHiddenMarkers,this))&&(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},bo.prototype.detachLine=function(e){if(this.lines.splice(j(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}},Ee(bo);var wo=function(e,t){this.markers=e,this.primary=t;for(var n=0;n<e.length;++n)e[n].parent=this};function xo(e,t,n,i,r){(i=G(i)).shared=!1;var s=[So(e,t,n,i,r)],o=s[0],a=i.widgetNode;return ws(e,(function(e){a&&(i.widgetNode=a.cloneNode(!0)),s.push(So(e,mt(e,t),mt(e,n),i,r));for(var l=0;l<e.linked.length;++l)if(e.linked[l].isParent)return;o=ee(s)})),new wo(s,o)}function Co(e){return e.findMarks(ct(e.first,0),e.clipPos(ct(e.lastLine())),(function(e){return e.parent}))}function ko(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=i.find(),s=e.clipPos(r.from),o=e.clipPos(r.to);if(dt(s,o)){var a=So(e,s,o,i.primary,i.primary.type);i.markers.push(a),a.parent=i}}}function To(e){for(var t=function(t){var n=e[t],i=[n.primary.doc];ws(n.primary.doc,(function(e){return i.push(e)}));for(var r=0;r<n.markers.length;r++){var s=n.markers[r];-1==j(i,s.doc)&&(s.parent=null,n.markers.splice(r--,1))}},n=0;n<e.length;n++)t(n)}wo.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var e=0;e<this.markers.length;++e)this.markers[e].clear();Rn(this,"clear")}},wo.prototype.find=function(e,t){return this.primary.find(e,t)},Ee(wo);var Eo=0,Lo=function(e,t,n,i,r){if(!(this instanceof Lo))return new Lo(e,t,n,i,r);null==n&&(n=0),fo.call(this,[new po([new pn("",null)])]),this.first=n,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=n;var s=ct(n,0);this.sel=us(s),this.history=new Ts(null),this.id=++Eo,this.modeOption=t,this.lineSep=i,this.direction="rtl"==r?"rtl":"ltr",this.extend=!1,"string"==typeof e&&(e=this.splitLines(e)),Ss(this,{from:s,to:s,text:e}),js(this,us(s),q)};Lo.prototype=re(fo.prototype,{constructor:Lo,iter:function(e,t,n){n?this.iterN(e-this.first,t-e,n):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var n=0,i=0;i<t.length;++i)n+=t[i].height;this.insertInner(e-this.first,t,n)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=it(this,this.first,this.first+this.size);return!1===e?t:t.join(e||this.lineSeparator())},setValue:_r((function(e){var t=ct(this.first,0),n=this.first+this.size-1;to(this,{from:t,to:ct(n,tt(this,n).text.length),text:this.splitLines(e),origin:"setValue",full:!0},!0),this.cm&&hr(this.cm,0,0),js(this,us(t),q)})),replaceRange:function(e,t,n,i){ao(this,e,t=mt(this,t),n=n?mt(this,n):t,i)},getRange:function(e,t,n){var i=nt(this,mt(this,e),mt(this,t));return!1===n?i:""===n?i.join(""):i.join(n||this.lineSeparator())},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(at(this,e))return tt(this,e)},getLineNumber:function(e){return st(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=tt(this,e)),nn(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return mt(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:_r((function(e,t,n){Gs(this,mt(this,"number"==typeof e?ct(e,t||0):e),null,n)})),setSelection:_r((function(e,t,n){Gs(this,mt(this,e),mt(this,t||e),n)})),extendSelection:_r((function(e,t,n){Fs(this,mt(this,e),t&&mt(this,t),n)})),extendSelections:_r((function(e,t){zs(this,yt(this,e),t)})),extendSelectionsBy:_r((function(e,t){zs(this,yt(this,te(this.sel.ranges,e)),t)})),setSelections:_r((function(e,t,n){if(e.length){for(var i=[],r=0;r<e.length;r++)i[r]=new cs(mt(this,e[r].anchor),mt(this,e[r].head||e[r].anchor));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),js(this,ds(this.cm,i,t),n)}})),addSelection:_r((function(e,t,n){var i=this.sel.ranges.slice(0);i.push(new cs(mt(this,e),mt(this,t||e))),js(this,ds(this.cm,i,i.length-1),n)})),getSelection:function(e){for(var t,n=this.sel.ranges,i=0;i<n.length;i++){var r=nt(this,n[i].from(),n[i].to());t=t?t.concat(r):r}return!1===e?t:t.join(e||this.lineSeparator())},getSelections:function(e){for(var t=[],n=this.sel.ranges,i=0;i<n.length;i++){var r=nt(this,n[i].from(),n[i].to());!1!==e&&(r=r.join(e||this.lineSeparator())),t[i]=r}return t},replaceSelection:function(e,t,n){for(var i=[],r=0;r<this.sel.ranges.length;r++)i[r]=e;this.replaceSelections(i,t,n||"+input")},replaceSelections:_r((function(e,t,n){for(var i=[],r=this.sel,s=0;s<r.ranges.length;s++){var o=r.ranges[s];i[s]={from:o.from(),to:o.to(),text:this.splitLines(e[s]),origin:n}}for(var a=t&&"end"!=t&&ms(this,i,t),l=i.length-1;l>=0;l--)to(this,i[l]);a?$s(this,a):this.cm&&ur(this.cm)})),undo:_r((function(){io(this,"undo")})),redo:_r((function(){io(this,"redo")})),undoSelection:_r((function(){io(this,"undo",!0)})),redoSelection:_r((function(){io(this,"redo",!0)})),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,n=0,i=0;i<e.done.length;i++)e.done[i].ranges||++t;for(var r=0;r<e.undone.length;r++)e.undone[r].ranges||++n;return{undo:t,redo:n}},clearHistory:function(){var e=this;this.history=new Ts(this.history),ws(this,(function(t){return t.history=e.history}),!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:Bs(this.history.done),undone:Bs(this.history.undone)}},setHistory:function(e){var t=this.history=new Ts(this.history);t.done=Bs(e.done.slice(0),null,!0),t.undone=Bs(e.undone.slice(0),null,!0)},setGutterMarker:_r((function(e,t,n){return ho(this,e,"gutter",(function(e){var i=e.gutterMarkers||(e.gutterMarkers={});return i[t]=n,!n&&le(i)&&(e.gutterMarkers=null),!0}))})),clearGutter:_r((function(e){var t=this;this.iter((function(n){n.gutterMarkers&&n.gutterMarkers[e]&&ho(t,n,"gutter",(function(){return n.gutterMarkers[e]=null,le(n.gutterMarkers)&&(n.gutterMarkers=null),!0}))}))})),lineInfo:function(e){var t;if("number"==typeof e){if(!at(this,e)||(t=e,!(e=tt(this,e))))return null}else if(null==(t=st(e)))return null;return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},addLineClass:_r((function(e,t,n){return ho(this,e,"gutter"==t?"gutter":"class",(function(e){var i="text"==t?"textClass":"background"==t?"bgClass":"gutter"==t?"gutterClass":"wrapClass";if(e[i]){if(T(n).test(e[i]))return!1;e[i]+=" "+n}else e[i]=n;return!0}))})),removeLineClass:_r((function(e,t,n){return ho(this,e,"gutter"==t?"gutter":"class",(function(e){var i="text"==t?"textClass":"background"==t?"bgClass":"gutter"==t?"gutterClass":"wrapClass",r=e[i];if(!r)return!1;if(null==n)e[i]=null;else{var s=r.match(T(n));if(!s)return!1;var o=s.index+s[0].length;e[i]=r.slice(0,s.index)+(s.index&&o!=r.length?" ":"")+r.slice(o)||null}return!0}))})),addLineWidget:_r((function(e,t,n){return vo(this,e,t,n)})),removeLineWidget:function(e){e.clear()},markText:function(e,t,n){return So(this,mt(this,e),mt(this,t),n,n&&n.type||"range")},setBookmark:function(e,t){var n={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared,handleMouseEvents:t&&t.handleMouseEvents};return So(this,e=mt(this,e),e,n,"bookmark")},findMarksAt:function(e){var t=[],n=tt(this,(e=mt(this,e)).line).markedSpans;if(n)for(var i=0;i<n.length;++i){var r=n[i];(null==r.from||r.from<=e.ch)&&(null==r.to||r.to>=e.ch)&&t.push(r.marker.parent||r.marker)}return t},findMarks:function(e,t,n){e=mt(this,e),t=mt(this,t);var i=[],r=e.line;return this.iter(e.line,t.line+1,(function(s){var o=s.markedSpans;if(o)for(var a=0;a<o.length;a++){var l=o[a];!(null!=l.to&&r==e.line&&e.ch>=l.to||null==l.from&&r!=e.line||null!=l.from&&r==t.line&&l.from>=t.ch)&&(!n||n(l.marker))&&i.push(l.marker.parent||l.marker)}++r})),i},getAllMarks:function(){var e=[];return this.iter((function(t){var n=t.markedSpans;if(n)for(var i=0;i<n.length;++i)null!=n[i].from&&e.push(n[i].marker)})),e},posFromIndex:function(e){var t,n=this.first,i=this.lineSeparator().length;return this.iter((function(r){var s=r.text.length+i;if(s>e)return t=e,!0;e-=s,++n})),mt(this,ct(n,t))},indexFromPos:function(e){var t=(e=mt(this,e)).ch;if(e.line<this.first||e.ch<0)return 0;var n=this.lineSeparator().length;return this.iter(this.first,e.line,(function(e){t+=e.text.length+n})),t},copy:function(e){var t=new Lo(it(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,n=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<n&&(n=e.to);var i=new Lo(it(this,t,n),e.mode||this.modeOption,t,this.lineSep,this.direction);return e.sharedHist&&(i.history=this.history),(this.linked||(this.linked=[])).push({doc:i,sharedHist:e.sharedHist}),i.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],ko(i,Co(this)),i},unlinkDoc:function(e){if(e instanceof Ua&&(e=e.doc),this.linked)for(var t=0;t<this.linked.length;++t)if(this.linked[t].doc==e){this.linked.splice(t,1),e.unlinkDoc(this),To(Co(this));break}if(e.history==this.history){var n=[e.id];ws(e,(function(e){return n.push(e.id)}),!0),e.history=new Ts(null),e.history.done=Bs(this.history.done,n),e.history.undone=Bs(this.history.undone,n)}},iterLinkedDocs:function(e){ws(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(e){return this.lineSep?e.split(this.lineSep):_e(e)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:_r((function(e){"rtl"!=e&&(e="ltr"),e!=this.direction&&(this.direction=e,this.iter((function(e){return e.order=null})),this.cm&&ks(this.cm))}))}),Lo.prototype.eachLine=Lo.prototype.iter;var Io=0;function Do(e){var t=this;if(Ao(t),!Ce(t,e)&&!qn(t.display,e)){Le(e),o&&(Io=+new Date);var n=Fi(t,e,!0),i=e.dataTransfer.files;if(n&&!t.isReadOnly())if(i&&i.length&&window.FileReader&&window.File)for(var r=i.length,s=Array(r),a=0,l=function(){++a==r&&Or(t,(function(){var e={from:n=mt(t.doc,n),to:n,text:t.doc.splitLines(s.filter((function(e){return null!=e})).join(t.doc.lineSeparator())),origin:"paste"};to(t.doc,e),$s(t.doc,us(mt(t.doc,n),mt(t.doc,hs(e))))}))()},c=function(e,n){if(t.options.allowDropFileTypes&&-1==j(t.options.allowDropFileTypes,e.type))l();else{var i=new FileReader;i.onerror=function(){return l()},i.onload=function(){var e=i.result;/[\x00-\x08\x0e-\x1f]{2}/.test(e)||(s[n]=e),l()},i.readAsText(e)}},d=0;d<i.length;d++)c(i[d],d);else{if(t.state.draggingText&&t.doc.sel.contains(n)>-1)return t.state.draggingText(e),void setTimeout((function(){return t.display.input.focus()}),20);try{var u=e.dataTransfer.getData("Text");if(u){var h;if(t.state.draggingText&&!t.state.draggingText.copy&&(h=t.listSelections()),Hs(t.doc,us(n,n)),h)for(var p=0;p<h.length;++p)ao(t.doc,"",h[p].anchor,h[p].head,"drag");t.replaceSelection(u,"around","paste"),t.display.input.focus()}}catch{}}}}function Mo(e,t){if(o&&(!e.state.draggingText||+new Date-Io<100))Me(t);else if(!Ce(e,t)&&!qn(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!p)){var n=M("img",null,null,"position: fixed; left: 0; top: 0;");n.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",h&&(n.width=n.height=1,e.display.wrapper.appendChild(n),n._top=n.offsetTop),t.dataTransfer.setDragImage(n,0,0),h&&n.parentNode.removeChild(n)}}function Po(e,t){var n=Fi(e,t);if(n){var i=document.createDocumentFragment();Yi(e,n,i),e.display.dragCursor||(e.display.dragCursor=M("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),D(e.display.dragCursor,i)}}function Ao(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}function Ro(e){if(document.getElementsByClassName){for(var t=document.getElementsByClassName("CodeMirror"),n=[],i=0;i<t.length;i++){var r=t[i].CodeMirror;r&&n.push(r)}n.length&&n[0].operation((function(){for(var t=0;t<n.length;t++)e(n[t])}))}}var No=!1;function Vo(){No||(Oo(),No=!0)}function Oo(){var e;be(window,"resize",(function(){null==e&&(e=setTimeout((function(){e=null,Ro(Bo)}),100))})),be(window,"blur",(function(){return Ro(nr)}))}function Bo(e){var t=e.display;t.cachedCharWidth=t.cachedTextHeight=t.cachedPaddingH=null,t.scrollbarsClipped=!1,e.setSize()}for(var _o={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},Fo=0;Fo<10;Fo++)_o[Fo+48]=_o[Fo+96]=String(Fo);for(var zo=65;zo<=90;zo++)_o[zo]=String.fromCharCode(zo);for(var Uo=1;Uo<=12;Uo++)_o[Uo+111]=_o[Uo+63235]="F"+Uo;var Go={};function Wo(e){var t=e.split(/-(?!$)/);e=t[t.length-1];for(var n,i,r,s,o=0;o<t.length-1;o++){var a=t[o];if(/^(cmd|meta|m)$/i.test(a))s=!0;else if(/^a(lt)?$/i.test(a))n=!0;else if(/^(c|ctrl|control)$/i.test(a))i=!0;else{if(!/^s(hift)?$/i.test(a))throw new Error("Unrecognized modifier name: "+a);r=!0}}return n&&(e="Alt-"+e),i&&(e="Ctrl-"+e),s&&(e="Cmd-"+e),r&&(e="Shift-"+e),e}function $o(e){var t={};for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];if(/^(name|fallthrough|(de|at)tach)$/.test(n))continue;if("..."==i){delete e[n];continue}for(var r=te(n.split(" "),Wo),s=0;s<r.length;s++){var o=void 0,a=void 0;s==r.length-1?(a=r.join(" "),o=i):(a=r.slice(0,s+1).join(" "),o="...");var l=t[a];if(l){if(l!=o)throw new Error("Inconsistent bindings for "+a)}else t[a]=o}delete e[n]}for(var c in t)e[c]=t[c];return e}function jo(e,t,n,i){var r=(t=Yo(t)).call?t.call(e,i):t[e];if(!1===r)return"nothing";if("..."===r)return"multi";if(null!=r&&n(r))return"handled";if(t.fallthrough){if("[object Array]"!=Object.prototype.toString.call(t.fallthrough))return jo(e,t.fallthrough,n,i);for(var s=0;s<t.fallthrough.length;s++){var o=jo(e,t.fallthrough[s],n,i);if(o)return o}}}function Ho(e){var t="string"==typeof e?e:_o[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t}function Jo(e,t,n){var i=e;return t.altKey&&"Alt"!=i&&(e="Alt-"+e),(C?t.metaKey:t.ctrlKey)&&"Ctrl"!=i&&(e="Ctrl-"+e),(C?t.ctrlKey:t.metaKey)&&"Mod"!=i&&(e="Cmd-"+e),!n&&t.shiftKey&&"Shift"!=i&&(e="Shift-"+e),e}function qo(e,t){if(h&&34==e.keyCode&&e.char)return!1;var n=_o[e.keyCode];return null!=n&&!e.altGraphKey&&(3==e.keyCode&&e.code&&(n=e.code),Jo(n,e,t))}function Yo(e){return"string"==typeof e?Go[e]:e}function Zo(e,t){for(var n=e.doc.sel.ranges,i=[],r=0;r<n.length;r++){for(var s=t(n[r]);i.length&&dt(s.from,ee(i).to)<=0;){var o=i.pop();if(dt(o.from,s.from)<0){s.from=o.from;break}}i.push(s)}Vr(e,(function(){for(var t=i.length-1;t>=0;t--)ao(e.doc,"",i[t].from,i[t].to,"+delete");ur(e)}))}function Xo(e,t,n){var i=ue(e.text,t+n,n);return i<0||i>e.text.length?null:i}function Ko(e,t,n){var i=Xo(e,t.ch,n);return null==i?null:new ct(t.line,i,n<0?"after":"before")}function Qo(e,t,n,i,r){if(e){"rtl"==t.doc.direction&&(r=-r);var s=ve(n,t.doc.direction);if(s){var o,a=r<0?ee(s):s[0],l=r<0==(1==a.level)?"after":"before";if(a.level>0||"rtl"==t.doc.direction){var c=oi(t,n);o=r<0?n.text.length-1:0;var d=ai(t,c,o).top;o=he((function(e){return ai(t,c,e).top==d}),r<0==(1==a.level)?a.from:a.to-1,o),"before"==l&&(o=Xo(n,o,1))}else o=r<0?a.to:a.from;return new ct(i,o,l)}}return new ct(i,r<0?n.text.length:0,r<0?"before":"after")}function ea(e,t,n,i){var r=ve(t,e.doc.direction);if(!r)return Ko(t,n,i);n.ch>=t.text.length?(n.ch=t.text.length,n.sticky="before"):n.ch<=0&&(n.ch=0,n.sticky="after");var s=ge(r,n.ch,n.sticky),o=r[s];if("ltr"==e.doc.direction&&o.level%2==0&&(i>0?o.to>n.ch:o.from<n.ch))return Ko(t,n,i);var a,l=function(e,n){return Xo(t,e instanceof ct?e.ch:e,n)},c=function(n){return e.options.lineWrapping?(a=a||oi(e,t),Ii(e,t,a,n)):{begin:0,end:t.text.length}},d=c("before"==n.sticky?l(n,-1):n.ch);if("rtl"==e.doc.direction||1==o.level){var u=1==o.level==i<0,h=l(n,u?1:-1);if(null!=h&&(u?h<=o.to&&h<=d.end:h>=o.from&&h>=d.begin)){var p=u?"before":"after";return new ct(n.line,h,p)}}var f=function(e,t,i){for(var s=function(e,t){return t?new ct(n.line,l(e,1),"before"):new ct(n.line,e,"after")};e>=0&&e<r.length;e+=t){var o=r[e],a=t>0==(1!=o.level),c=a?i.begin:l(i.end,-1);if(o.from<=c&&c<o.to||(c=a?o.from:l(o.to,-1),i.begin<=c&&c<i.end))return s(c,a)}},g=f(s+i,i,d);if(g)return g;var m=i>0?d.end:l(d.begin,-1);return null==m||i>0&&m==t.text.length||!(g=f(i>0?0:r.length-1,i,c(m)))?null:g}Go.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},Go.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},Go.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},Go.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},Go.default=b?Go.macDefault:Go.pcDefault;var ta={selectAll:Qs,singleSelection:function(e){return e.setSelection(e.getCursor("anchor"),e.getCursor("head"),q)},killLine:function(e){return Zo(e,(function(t){if(t.empty()){var n=tt(e.doc,t.head.line).text.length;return t.head.ch==n&&t.head.line<e.lastLine()?{from:t.head,to:ct(t.head.line+1,0)}:{from:t.head,to:ct(t.head.line,n)}}return{from:t.from(),to:t.to()}}))},deleteLine:function(e){return Zo(e,(function(t){return{from:ct(t.from().line,0),to:mt(e.doc,ct(t.to().line+1,0))}}))},delLineLeft:function(e){return Zo(e,(function(e){return{from:ct(e.from().line,0),to:e.from()}}))},delWrappedLineLeft:function(e){return Zo(e,(function(t){var n=e.charCoords(t.head,"div").top+5;return{from:e.coordsChar({left:0,top:n},"div"),to:t.from()}}))},delWrappedLineRight:function(e){return Zo(e,(function(t){var n=e.charCoords(t.head,"div").top+5,i=e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:n},"div");return{from:t.from(),to:i}}))},undo:function(e){return e.undo()},redo:function(e){return e.redo()},undoSelection:function(e){return e.undoSelection()},redoSelection:function(e){return e.redoSelection()},goDocStart:function(e){return e.extendSelection(ct(e.firstLine(),0))},goDocEnd:function(e){return e.extendSelection(ct(e.lastLine()))},goLineStart:function(e){return e.extendSelectionsBy((function(t){return na(e,t.head.line)}),{origin:"+move",bias:1})},goLineStartSmart:function(e){return e.extendSelectionsBy((function(t){return ra(e,t.head)}),{origin:"+move",bias:1})},goLineEnd:function(e){return e.extendSelectionsBy((function(t){return ia(e,t.head.line)}),{origin:"+move",bias:-1})},goLineRight:function(e){return e.extendSelectionsBy((function(t){var n=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:n},"div")}),Z)},goLineLeft:function(e){return e.extendSelectionsBy((function(t){var n=e.cursorCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:n},"div")}),Z)},goLineLeftSmart:function(e){return e.extendSelectionsBy((function(t){var n=e.cursorCoords(t.head,"div").top+5,i=e.coordsChar({left:0,top:n},"div");return i.ch<e.getLine(i.line).search(/\S/)?ra(e,t.head):i}),Z)},goLineUp:function(e){return e.moveV(-1,"line")},goLineDown:function(e){return e.moveV(1,"line")},goPageUp:function(e){return e.moveV(-1,"page")},goPageDown:function(e){return e.moveV(1,"page")},goCharLeft:function(e){return e.moveH(-1,"char")},goCharRight:function(e){return e.moveH(1,"char")},goColumnLeft:function(e){return e.moveH(-1,"column")},goColumnRight:function(e){return e.moveH(1,"column")},goWordLeft:function(e){return e.moveH(-1,"word")},goGroupRight:function(e){return e.moveH(1,"group")},goGroupLeft:function(e){return e.moveH(-1,"group")},goWordRight:function(e){return e.moveH(1,"word")},delCharBefore:function(e){return e.deleteH(-1,"codepoint")},delCharAfter:function(e){return e.deleteH(1,"char")},delWordBefore:function(e){return e.deleteH(-1,"word")},delWordAfter:function(e){return e.deleteH(1,"word")},delGroupBefore:function(e){return e.deleteH(-1,"group")},delGroupAfter:function(e){return e.deleteH(1,"group")},indentAuto:function(e){return e.indentSelection("smart")},indentMore:function(e){return e.indentSelection("add")},indentLess:function(e){return e.indentSelection("subtract")},insertTab:function(e){return e.replaceSelection("\t")},insertSoftTab:function(e){for(var t=[],n=e.listSelections(),i=e.options.tabSize,r=0;r<n.length;r++){var s=n[r].from(),o=W(e.getLine(s.line),s.ch,i);t.push(Q(i-o%i))}e.replaceSelections(t)},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){return Vr(e,(function(){for(var t=e.listSelections(),n=[],i=0;i<t.length;i++)if(t[i].empty()){var r=t[i].head,s=tt(e.doc,r.line).text;if(s)if(r.ch==s.length&&(r=new ct(r.line,r.ch-1)),r.ch>0)r=new ct(r.line,r.ch+1),e.replaceRange(s.charAt(r.ch-1)+s.charAt(r.ch-2),ct(r.line,r.ch-2),r,"+transpose");else if(r.line>e.doc.first){var o=tt(e.doc,r.line-1).text;o&&(r=new ct(r.line,1),e.replaceRange(s.charAt(0)+e.doc.lineSeparator()+o.charAt(o.length-1),ct(r.line-1,o.length-1),r,"+transpose"))}n.push(new cs(r,r))}e.setSelections(n)}))},newlineAndIndent:function(e){return Vr(e,(function(){for(var t=e.listSelections(),n=t.length-1;n>=0;n--)e.replaceRange(e.doc.lineSeparator(),t[n].anchor,t[n].head,"+input");t=e.listSelections();for(var i=0;i<t.length;i++)e.indentLine(t[i].from().line,null,!0);ur(e)}))},openLine:function(e){return e.replaceSelection("\n","start")},toggleOverwrite:function(e){return e.toggleOverwrite()}};function na(e,t){var n=tt(e.doc,t),i=nn(n);return i!=n&&(t=st(i)),Qo(!0,e,i,t,1)}function ia(e,t){var n=tt(e.doc,t),i=rn(n);return i!=n&&(t=st(i)),Qo(!0,e,n,t,-1)}function ra(e,t){var n=na(e,t.line),i=tt(e.doc,n.line),r=ve(i,e.doc.direction);if(!r||0==r[0].level){var s=Math.max(n.ch,i.text.search(/\S/)),o=t.line==n.line&&t.ch<=s&&t.ch;return ct(n.line,o?0:s,n.sticky)}return n}function sa(e,t,n){if("string"==typeof t&&!(t=ta[t]))return!1;e.display.input.ensurePolled();var i=e.display.shift,r=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),n&&(e.display.shift=!1),r=t(e)!=J}finally{e.display.shift=i,e.state.suppressEdits=!1}return r}function oa(e,t,n){for(var i=0;i<e.state.keyMaps.length;i++){var r=jo(t,e.state.keyMaps[i],n,e);if(r)return r}return e.options.extraKeys&&jo(t,e.options.extraKeys,n,e)||jo(t,e.options.keyMap,n,e)}var aa=new $;function la(e,t,n,i){var r=e.state.keySeq;if(r){if(Ho(t))return"handled";if(/\'$/.test(t)?e.state.keySeq=null:aa.set(50,(function(){e.state.keySeq==r&&(e.state.keySeq=null,e.display.input.reset())})),ca(e,r+" "+t,n,i))return!0}return ca(e,t,n,i)}function ca(e,t,n,i){var r=oa(e,t,i);return"multi"==r&&(e.state.keySeq=t),"handled"==r&&Rn(e,"keyHandled",e,t,n),("handled"==r||"multi"==r)&&(Le(n),Ki(e)),!!r}function da(e,t){var n=qo(t,!0);return!!n&&(t.shiftKey&&!e.state.keySeq?la(e,"Shift-"+n,t,(function(t){return sa(e,t,!0)}))||la(e,n,t,(function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return sa(e,t)})):la(e,n,t,(function(t){return sa(e,t)})))}function ua(e,t,n){return la(e,"'"+n+"'",t,(function(t){return sa(e,t,!0)}))}var ha=null;function pa(e){var t=this;if((!e.target||e.target==t.display.input.getField())&&(t.curOp.focus=R(_(t)),!Ce(t,e))){o&&a<11&&27==e.keyCode&&(e.returnValue=!1);var i=e.keyCode;t.display.shift=16==i||e.shiftKey;var r=da(t,e);h&&(ha=r?i:null,!r&&88==i&&!ze&&(b?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut")),n&&!b&&!r&&46==i&&e.shiftKey&&!e.ctrlKey&&document.execCommand&&document.execCommand("cut"),18==i&&!/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)&&fa(t)}}function fa(e){var t=e.display.lineDiv;function n(e){(18==e.keyCode||!e.altKey)&&(L(t,"CodeMirror-crosshair"),we(document,"keyup",n),we(document,"mouseover",n))}N(t,"CodeMirror-crosshair"),be(document,"keyup",n),be(document,"mouseover",n)}function ga(e){16==e.keyCode&&(this.doc.sel.shift=!1),Ce(this,e)}function ma(e){var t=this;if((!e.target||e.target==t.display.input.getField())&&!(qn(t.display,e)||Ce(t,e)||e.ctrlKey&&!e.altKey||b&&e.metaKey)){var n=e.keyCode,i=e.charCode;if(h&&n==ha)return ha=null,void Le(e);if(!h||e.which&&!(e.which<10)||!da(t,e)){var r=String.fromCharCode(i??n);"\b"!=r&&(ua(t,e,r)||t.display.input.onKeyPress(e))}}}var va,ya,ba=400,Sa=function(e,t,n){this.time=e,this.pos=t,this.button=n};function wa(e,t){var n=+new Date;return ya&&ya.compare(n,e,t)?(va=ya=null,"triple"):va&&va.compare(n,e,t)?(ya=new Sa(n,e,t),va=null,"double"):(va=new Sa(n,e,t),ya=null,"single")}function xa(e){var t=this,n=t.display;if(!(Ce(t,e)||n.activeTouch&&n.input.supportsTouch())){if(n.input.ensurePolled(),n.shift=e.shiftKey,qn(n,e))return void(l||(n.scroller.draggable=!1,setTimeout((function(){return n.scroller.draggable=!0}),100)));if(!Pa(t,e)){var i=Fi(t,e),r=Ae(e),s=i?wa(i,r):"single";z(t).focus(),1==r&&t.state.selectingText&&t.state.selectingText(e),(!i||!Ca(t,r,i,s,e))&&(1==r?i?Ta(t,i,s,e):Pe(e)==n.scroller&&Le(e):2==r?(i&&Fs(t.doc,i),setTimeout((function(){return n.input.focus()}),20)):3==r&&(k?t.display.input.onContextMenu(e):er(t)))}}}function Ca(e,t,n,i,r){var s="Click";return"double"==i?s="Double"+s:"triple"==i&&(s="Triple"+s),la(e,Jo(s=(1==t?"Left":2==t?"Middle":"Right")+s,r),r,(function(t){if("string"==typeof t&&(t=ta[t]),!t)return!1;var i=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),i=t(e,n)!=J}finally{e.state.suppressEdits=!1}return i}))}function ka(e,t,n){var i=e.getOption("configureMouse"),r=i?i(e,t,n):{};if(null==r.unit){var s=S?n.shiftKey&&n.metaKey:n.altKey;r.unit=s?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==r.extend||e.doc.extend)&&(r.extend=e.doc.extend||n.shiftKey),null==r.addNew&&(r.addNew=b?n.metaKey:n.ctrlKey),null==r.moveOnDrag&&(r.moveOnDrag=!(b?n.altKey:n.ctrlKey)),r}function Ta(e,t,n,i){o?setTimeout(U(Qi,e),0):e.curOp.focus=R(_(e));var r,s=ka(e,n,i),a=e.doc.sel;e.options.dragDrop&&Ve&&!e.isReadOnly()&&"single"==n&&(r=a.contains(t))>-1&&(dt((r=a.ranges[r]).from(),t)<0||t.xRel>0)&&(dt(r.to(),t)>0||t.xRel<0)?Ea(e,i,t,s):Ia(e,i,t,s)}function Ea(e,t,n,i){var r=e.display,s=!1,c=Or(e,(function(t){l&&(r.scroller.draggable=!1),e.state.draggingText=!1,e.state.delayingBlurEvent&&(e.hasFocus()?e.state.delayingBlurEvent=!1:er(e)),we(r.wrapper.ownerDocument,"mouseup",c),we(r.wrapper.ownerDocument,"mousemove",d),we(r.scroller,"dragstart",u),we(r.scroller,"drop",c),s||(Le(t),i.addNew||Fs(e.doc,n,null,null,i.extend),l&&!p||o&&9==a?setTimeout((function(){r.wrapper.ownerDocument.body.focus({preventScroll:!0}),r.input.focus()}),20):r.input.focus())})),d=function(e){s=s||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},u=function(){return s=!0};l&&(r.scroller.draggable=!0),e.state.draggingText=c,c.copy=!i.moveOnDrag,be(r.wrapper.ownerDocument,"mouseup",c),be(r.wrapper.ownerDocument,"mousemove",d),be(r.scroller,"dragstart",u),be(r.scroller,"drop",c),e.state.delayingBlurEvent=!0,setTimeout((function(){return r.input.focus()}),20),r.scroller.dragDrop&&r.scroller.dragDrop()}function La(e,t,n){if("char"==n)return new cs(t,t);if("word"==n)return e.findWordAt(t);if("line"==n)return new cs(ct(t.line,0),mt(e.doc,ct(t.line+1,0)));var i=n(e,t);return new cs(i.from,i.to)}function Ia(e,t,n,i){o&&er(e);var r=e.display,s=e.doc;Le(t);var a,l,c=s.sel,d=c.ranges;if(i.addNew&&!i.extend?(l=s.sel.contains(n),a=l>-1?d[l]:new cs(n,n)):(a=s.sel.primary(),l=s.sel.primIndex),"rectangle"==i.unit)i.addNew||(a=new cs(n,n)),n=Fi(e,t,!0,!0),l=-1;else{var u=La(e,n,i.unit);a=i.extend?_s(a,u.anchor,u.head,i.extend):u}i.addNew?-1==l?(l=d.length,js(s,ds(e,d.concat([a]),l),{scroll:!1,origin:"*mouse"})):d.length>1&&d[l].empty()&&"char"==i.unit&&!i.extend?(js(s,ds(e,d.slice(0,l).concat(d.slice(l+1)),0),{scroll:!1,origin:"*mouse"}),c=s.sel):Us(s,l,a,Y):(l=0,js(s,new ls([a],0),Y),c=s.sel);var h=n;function p(t){if(0!=dt(h,t))if(h=t,"rectangle"==i.unit){for(var r=[],o=e.options.tabSize,d=W(tt(s,n.line).text,n.ch,o),u=W(tt(s,t.line).text,t.ch,o),p=Math.min(d,u),f=Math.max(d,u),g=Math.min(n.line,t.line),m=Math.min(e.lastLine(),Math.max(n.line,t.line));g<=m;g++){var v=tt(s,g).text,y=X(v,p,o);p==f?r.push(new cs(ct(g,y),ct(g,y))):v.length>y&&r.push(new cs(ct(g,y),ct(g,X(v,f,o))))}r.length||r.push(new cs(n,n)),js(s,ds(e,c.ranges.slice(0,l).concat(r),l),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{var b,S=a,w=La(e,t,i.unit),x=S.anchor;dt(w.anchor,x)>0?(b=w.head,x=ft(S.from(),w.anchor)):(b=w.anchor,x=pt(S.to(),w.head));var C=c.ranges.slice(0);C[l]=Da(e,new cs(mt(s,x),b)),js(s,ds(e,C,l),Y)}}var f=r.wrapper.getBoundingClientRect(),g=0;function m(t){var n=++g,o=Fi(e,t,!0,"rectangle"==i.unit);if(o)if(0!=dt(o,h)){e.curOp.focus=R(_(e)),p(o);var a=sr(r,s);(o.line>=a.to||o.line<a.from)&&setTimeout(Or(e,(function(){g==n&&m(t)})),150)}else{var l=t.clientY<f.top?-20:t.clientY>f.bottom?20:0;l&&setTimeout(Or(e,(function(){g==n&&(r.scroller.scrollTop+=l,m(t))})),50)}}function v(t){e.state.selectingText=!1,g=1/0,t&&(Le(t),r.input.focus()),we(r.wrapper.ownerDocument,"mousemove",y),we(r.wrapper.ownerDocument,"mouseup",b),s.history.lastSelOrigin=null}var y=Or(e,(function(e){0!==e.buttons&&Ae(e)?m(e):v(e)})),b=Or(e,v);e.state.selectingText=b,be(r.wrapper.ownerDocument,"mousemove",y),be(r.wrapper.ownerDocument,"mouseup",b)}function Da(e,t){var n=t.anchor,i=t.head,r=tt(e.doc,n.line);if(0==dt(n,i)&&n.sticky==i.sticky)return t;var s=ve(r);if(!s)return t;var o=ge(s,n.ch,n.sticky),a=s[o];if(a.from!=n.ch&&a.to!=n.ch)return t;var l,c=o+(a.from==n.ch==(1!=a.level)?0:1);if(0==c||c==s.length)return t;if(i.line!=n.line)l=(i.line-n.line)*("ltr"==e.doc.direction?1:-1)>0;else{var d=ge(s,i.ch,i.sticky),u=d-o||(i.ch-n.ch)*(1==a.level?-1:1);l=d==c-1||d==c?u<0:u>0}var h=s[c+(l?-1:0)],p=l==(1==h.level),f=p?h.from:h.to,g=p?"after":"before";return n.ch==f&&n.sticky==g?t:new cs(new ct(n.line,f,g),i)}function Ma(e,t,n,i){var r,s;if(t.touches)r=t.touches[0].clientX,s=t.touches[0].clientY;else try{r=t.clientX,s=t.clientY}catch{return!1}if(r>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;i&&Le(t);var o=e.display,a=o.lineDiv.getBoundingClientRect();if(s>a.bottom||!Te(e,n))return De(t);s-=a.top-o.viewOffset;for(var l=0;l<e.display.gutterSpecs.length;++l){var c=o.gutters.childNodes[l];if(c&&c.getBoundingClientRect().right>=r)return xe(e,n,e,ot(e.doc,s),e.display.gutterSpecs[l].className,t),De(t)}}function Pa(e,t){return Ma(e,t,"gutterClick",!0)}function Aa(e,t){qn(e.display,t)||Ra(e,t)||Ce(e,t,"contextmenu")||k||e.display.input.onContextMenu(t)}function Ra(e,t){return!!Te(e,"gutterContextMenu")&&Ma(e,t,"gutterContextMenu",!1)}function Na(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),mi(e)}Sa.prototype.compare=function(e,t,n){return this.time+ba>e&&0==dt(t,this.pos)&&n==this.button};var Va={toString:function(){return"CodeMirror.Init"}},Oa={},Ba={};function _a(e){var t=e.optionHandlers;function n(n,i,r,s){e.defaults[n]=i,r&&(t[n]=s?function(e,t,n){n!=Va&&r(e,t,n)}:r)}e.defineOption=n,e.Init=Va,n("value","",(function(e,t){return e.setValue(t)}),!0),n("mode",null,(function(e,t){e.doc.modeOption=t,vs(e)}),!0),n("indentUnit",2,vs,!0),n("indentWithTabs",!1),n("smartIndent",!0),n("tabSize",4,(function(e){ys(e),mi(e),Ui(e)}),!0),n("lineSeparator",null,(function(e,t){if(e.doc.lineSep=t,t){var n=[],i=e.doc.first;e.doc.iter((function(e){for(var r=0;;){var s=e.text.indexOf(t,r);if(-1==s)break;r=s+t.length,n.push(ct(i,s))}i++}));for(var r=n.length-1;r>=0;r--)ao(e.doc,t,n[r],ct(n[r].line,n[r].ch+t.length))}})),n("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\u202d\u202e\u2066\u2067\u2069\ufeff\ufff9-\ufffc]/g,(function(e,t,n){e.state.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),n!=Va&&e.refresh()})),n("specialCharPlaceholder",Sn,(function(e){return e.refresh()}),!0),n("electricChars",!0),n("inputStyle",y?"contenteditable":"textarea",(function(){throw new Error("inputStyle can not (yet) be changed in a running editor")}),!0),n("spellcheck",!1,(function(e,t){return e.getInputField().spellcheck=t}),!0),n("autocorrect",!1,(function(e,t){return e.getInputField().autocorrect=t}),!0),n("autocapitalize",!1,(function(e,t){return e.getInputField().autocapitalize=t}),!0),n("rtlMoveVisually",!w),n("wholeLineUpdateBefore",!0),n("theme","default",(function(e){Na(e),ts(e)}),!0),n("keyMap","default",(function(e,t,n){var i=Yo(t),r=n!=Va&&Yo(n);r&&r.detach&&r.detach(e,i),i.attach&&i.attach(e,r||null)})),n("extraKeys",null),n("configureMouse",null),n("lineWrapping",!1,za,!0),n("gutters",[],(function(e,t){e.display.gutterSpecs=Qr(t,e.options.lineNumbers),ts(e)}),!0),n("fixedGutter",!0,(function(e,t){e.display.gutters.style.left=t?Oi(e.display)+"px":"0",e.refresh()}),!0),n("coverGutterNextToScrollbar",!1,(function(e){return xr(e)}),!0),n("scrollbarStyle","native",(function(e){Tr(e),xr(e),e.display.scrollbars.setScrollTop(e.doc.scrollTop),e.display.scrollbars.setScrollLeft(e.doc.scrollLeft)}),!0),n("lineNumbers",!1,(function(e,t){e.display.gutterSpecs=Qr(e.options.gutters,t),ts(e)}),!0),n("firstLineNumber",1,ts,!0),n("lineNumberFormatter",(function(e){return e}),ts,!0),n("showCursorWhenSelecting",!1,Ji,!0),n("resetSelectionOnContextMenu",!0),n("lineWiseCopyCut",!0),n("pasteLinesPerSelection",!0),n("selectionsMayTouch",!1),n("readOnly",!1,(function(e,t){"nocursor"==t&&(nr(e),e.display.input.blur()),e.display.input.readOnlyChanged(t)})),n("screenReaderLabel",null,(function(e,t){t=""===t?null:t,e.display.input.screenReaderLabelChanged(t)})),n("disableInput",!1,(function(e,t){t||e.display.input.reset()}),!0),n("dragDrop",!0,Fa),n("allowDropFileTypes",null),n("cursorBlinkRate",530),n("cursorScrollMargin",0),n("cursorHeight",1,Ji,!0),n("singleCursorHeightPerLine",!0,Ji,!0),n("workTime",100),n("workDelay",100),n("flattenSpans",!0,ys,!0),n("addModeClass",!1,ys,!0),n("pollInterval",100),n("undoDepth",200,(function(e,t){return e.doc.history.undoDepth=t})),n("historyEventDelay",1250),n("viewportMargin",10,(function(e){return e.refresh()}),!0),n("maxHighlightLength",1e4,ys,!0),n("moveInputWithCursor",!0,(function(e,t){t||e.display.input.resetPosition()})),n("tabindex",null,(function(e,t){return e.display.input.getField().tabIndex=t||""})),n("autofocus",null),n("direction","ltr",(function(e,t){return e.doc.setDirection(t)}),!0),n("phrases",null)}function Fa(e,t,n){if(!t!=!(n&&n!=Va)){var i=e.display.dragFunctions,r=t?be:we;r(e.display.scroller,"dragstart",i.start),r(e.display.scroller,"dragenter",i.enter),r(e.display.scroller,"dragover",i.over),r(e.display.scroller,"dragleave",i.leave),r(e.display.scroller,"drop",i.drop)}}function za(e){e.options.lineWrapping?(N(e.display.wrapper,"CodeMirror-wrap"),e.display.sizer.style.minWidth="",e.display.sizerWidth=null):(L(e.display.wrapper,"CodeMirror-wrap"),hn(e)),_i(e),Ui(e),mi(e),setTimeout((function(){return xr(e)}),100)}function Ua(e,t){var n=this;if(!(this instanceof Ua))return new Ua(e,t);this.options=t=t?G(t):{},G(Oa,t,!1);var i=t.value;"string"==typeof i?i=new Lo(i,t.mode,null,t.lineSeparator,t.direction):t.mode&&(i.modeOption=t.mode),this.doc=i;var r=new Ua.inputStyles[t.inputStyle](this),s=this.display=new ns(e,i,r,t);for(var c in s.wrapper.CodeMirror=this,Na(this),t.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),Tr(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new $,keySeq:null,specialChars:null},t.autofocus&&!y&&s.input.focus(),o&&a<11&&setTimeout((function(){return n.display.input.reset(!0)}),20),Ga(this),Vo(),Lr(this),this.curOp.forceUpdate=!0,xs(this,i),t.autofocus&&!y||this.hasFocus()?setTimeout((function(){n.hasFocus()&&!n.state.focused&&tr(n)}),20):nr(this),Ba)Ba.hasOwnProperty(c)&&Ba[c](this,t[c],Va);Kr(this),t.finishInit&&t.finishInit(this);for(var d=0;d<Wa.length;++d)Wa[d](this);Ir(this),l&&t.lineWrapping&&"optimizelegibility"==getComputedStyle(s.lineDiv).textRendering&&(s.lineDiv.style.textRendering="auto")}function Ga(e){var t=e.display;be(t.scroller,"mousedown",Or(e,xa)),be(t.scroller,"dblclick",o&&a<11?Or(e,(function(t){if(!Ce(e,t)){var n=Fi(e,t);if(n&&!Pa(e,t)&&!qn(e.display,t)){Le(t);var i=e.findWordAt(n);Fs(e.doc,i.anchor,i.head)}}})):function(t){return Ce(e,t)||Le(t)}),be(t.scroller,"contextmenu",(function(t){return Aa(e,t)})),be(t.input.getField(),"contextmenu",(function(n){t.scroller.contains(n.target)||Aa(e,n)}));var n,i={end:0};function r(){t.activeTouch&&(n=setTimeout((function(){return t.activeTouch=null}),1e3),(i=t.activeTouch).end=+new Date)}function s(e){if(1!=e.touches.length)return!1;var t=e.touches[0];return t.radiusX<=1&&t.radiusY<=1}function l(e,t){if(null==t.left)return!0;var n=t.left-e.left,i=t.top-e.top;return n*n+i*i>400}be(t.scroller,"touchstart",(function(r){if(!Ce(e,r)&&!s(r)&&!Pa(e,r)){t.input.ensurePolled(),clearTimeout(n);var o=+new Date;t.activeTouch={start:o,moved:!1,prev:o-i.end<=300?i:null},1==r.touches.length&&(t.activeTouch.left=r.touches[0].pageX,t.activeTouch.top=r.touches[0].pageY)}})),be(t.scroller,"touchmove",(function(){t.activeTouch&&(t.activeTouch.moved=!0)})),be(t.scroller,"touchend",(function(n){var i=t.activeTouch;if(i&&!qn(t,n)&&null!=i.left&&!i.moved&&new Date-i.start<300){var s,o=e.coordsChar(t.activeTouch,"page");s=!i.prev||l(i,i.prev)?new cs(o,o):!i.prev.prev||l(i,i.prev.prev)?e.findWordAt(o):new cs(ct(o.line,0),mt(e.doc,ct(o.line+1,0))),e.setSelection(s.anchor,s.head),e.focus(),Le(n)}r()})),be(t.scroller,"touchcancel",r),be(t.scroller,"scroll",(function(){t.scroller.clientHeight&&(mr(e,t.scroller.scrollTop),yr(e,t.scroller.scrollLeft,!0),xe(e,"scroll",e))})),be(t.scroller,"mousewheel",(function(t){return as(e,t)})),be(t.scroller,"DOMMouseScroll",(function(t){return as(e,t)})),be(t.wrapper,"scroll",(function(){return t.wrapper.scrollTop=t.wrapper.scrollLeft=0})),t.dragFunctions={enter:function(t){Ce(e,t)||Me(t)},over:function(t){Ce(e,t)||(Po(e,t),Me(t))},start:function(t){return Mo(e,t)},drop:Or(e,Do),leave:function(t){Ce(e,t)||Ao(e)}};var c=t.input.getField();be(c,"keyup",(function(t){return ga.call(e,t)})),be(c,"keydown",Or(e,pa)),be(c,"keypress",Or(e,ma)),be(c,"focus",(function(t){return tr(e,t)})),be(c,"blur",(function(t){return nr(e,t)}))}Ua.defaults=Oa,Ua.optionHandlers=Ba;var Wa=[];function $a(e,t,n,i){var r,s=e.doc;null==n&&(n="add"),"smart"==n&&(s.mode.indent?r=Ct(e,t).state:n="prev");var o=e.options.tabSize,a=tt(s,t),l=W(a.text,null,o);a.stateAfter&&(a.stateAfter=null);var c,d=a.text.match(/^\s*/)[0];if(i||/\S/.test(a.text)){if("smart"==n&&((c=s.mode.indent(r,a.text.slice(d.length),a.text))==J||c>150)){if(!i)return;n="prev"}}else c=0,n="not";"prev"==n?c=t>s.first?W(tt(s,t-1).text,null,o):0:"add"==n?c=l+e.options.indentUnit:"subtract"==n?c=l-e.options.indentUnit:"number"==typeof n&&(c=l+n),c=Math.max(0,c);var u="",h=0;if(e.options.indentWithTabs)for(var p=Math.floor(c/o);p;--p)h+=o,u+="\t";if(h<c&&(u+=Q(c-h)),u!=d)return ao(s,u,ct(t,0),ct(t,d.length),"+input"),a.stateAfter=null,!0;for(var f=0;f<s.sel.ranges.length;f++){var g=s.sel.ranges[f];if(g.head.line==t&&g.head.ch<d.length){var m=ct(t,d.length);Us(s,f,new cs(m,m));break}}}Ua.defineInitHook=function(e){return Wa.push(e)};var ja=null;function Ha(e){ja=e}function Ja(e,t,n,i,r){var s=e.doc;e.display.shift=!1,i||(i=s.sel);var o=+new Date-200,a="paste"==r||e.state.pasteIncoming>o,l=_e(t),c=null;if(a&&i.ranges.length>1)if(ja&&ja.text.join("\n")==t){if(i.ranges.length%ja.text.length==0){c=[];for(var d=0;d<ja.text.length;d++)c.push(s.splitLines(ja.text[d]))}}else l.length==i.ranges.length&&e.options.pasteLinesPerSelection&&(c=te(l,(function(e){return[e]})));for(var u=e.curOp.updateInput,h=i.ranges.length-1;h>=0;h--){var p=i.ranges[h],f=p.from(),g=p.to();p.empty()&&(n&&n>0?f=ct(f.line,f.ch-n):e.state.overwrite&&!a?g=ct(g.line,Math.min(tt(s,g.line).text.length,g.ch+ee(l).length)):a&&ja&&ja.lineWise&&ja.text.join("\n")==l.join("\n")&&(f=g=ct(f.line,0)));var m={from:f,to:g,text:c?c[h%c.length]:l,origin:r||(a?"paste":e.state.cutIncoming>o?"cut":"+input")};to(e.doc,m),Rn(e,"inputRead",e,m)}t&&!a&&Ya(e,t),ur(e),e.curOp.updateInput<2&&(e.curOp.updateInput=u),e.curOp.typing=!0,e.state.pasteIncoming=e.state.cutIncoming=-1}function qa(e,t){var n=e.clipboardData&&e.clipboardData.getData("Text");if(n)return e.preventDefault(),!t.isReadOnly()&&!t.options.disableInput&&t.hasFocus()&&Vr(t,(function(){return Ja(t,n,0,null,"paste")})),!0}function Ya(e,t){if(e.options.electricChars&&e.options.smartIndent)for(var n=e.doc.sel,i=n.ranges.length-1;i>=0;i--){var r=n.ranges[i];if(!(r.head.ch>100||i&&n.ranges[i-1].head.line==r.head.line)){var s=e.getModeAt(r.head),o=!1;if(s.electricChars){for(var a=0;a<s.electricChars.length;a++)if(t.indexOf(s.electricChars.charAt(a))>-1){o=$a(e,r.head.line,"smart");break}}else s.electricInput&&s.electricInput.test(tt(e.doc,r.head.line).text.slice(0,r.head.ch))&&(o=$a(e,r.head.line,"smart"));o&&Rn(e,"electricInput",e,r.head.line)}}}function Za(e){for(var t=[],n=[],i=0;i<e.doc.sel.ranges.length;i++){var r=e.doc.sel.ranges[i].head.line,s={anchor:ct(r,0),head:ct(r+1,0)};n.push(s),t.push(e.getRange(s.anchor,s.head))}return{text:t,ranges:n}}function Xa(e,t,n,i){e.setAttribute("autocorrect",n?"on":"off"),e.setAttribute("autocapitalize",i?"on":"off"),e.setAttribute("spellcheck",!!t)}function Ka(){var e=M("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; min-height: 1em; outline: none"),t=M("div",[e],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return l?e.style.width="1000px":e.setAttribute("wrap","off"),m&&(e.style.border="1px solid black"),t}function Qa(e){var t=e.optionHandlers,n=e.helpers={};e.prototype={constructor:e,focus:function(){z(this).focus(),this.display.input.focus()},setOption:function(e,n){var i=this.options,r=i[e];i[e]==n&&"mode"!=e||(i[e]=n,t.hasOwnProperty(e)&&Or(this,t[e])(this,n,r),xe(this,"optionChange",this,e))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](Yo(e))},removeKeyMap:function(e){for(var t=this.state.keyMaps,n=0;n<t.length;++n)if(t[n]==e||t[n].name==e)return t.splice(n,1),!0},addOverlay:Br((function(t,n){var i=t.token?t:e.getMode(this.options,t);if(i.startState)throw new Error("Overlays may not be stateful.");ne(this.state.overlays,{mode:i,modeSpec:t,opaque:n&&n.opaque,priority:n&&n.priority||0},(function(e){return e.priority})),this.state.modeGen++,Ui(this)})),removeOverlay:Br((function(e){for(var t=this.state.overlays,n=0;n<t.length;++n){var i=t[n].modeSpec;if(i==e||"string"==typeof e&&i.name==e)return t.splice(n,1),this.state.modeGen++,void Ui(this)}})),indentLine:Br((function(e,t,n){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),at(this.doc,e)&&$a(this,e,t,n)})),indentSelection:Br((function(e){for(var t=this.doc.sel.ranges,n=-1,i=0;i<t.length;i++){var r=t[i];if(r.empty())r.head.line>n&&($a(this,r.head.line,e,!0),n=r.head.line,i==this.doc.sel.primIndex&&ur(this));else{var s=r.from(),o=r.to(),a=Math.max(n,s.line);n=Math.min(this.lastLine(),o.line-(o.ch?0:1))+1;for(var l=a;l<n;++l)$a(this,l,e);var c=this.doc.sel.ranges;0==s.ch&&t.length==c.length&&c[i].from().ch>0&&Us(this.doc,i,new cs(s,c[i].to()),q)}}})),getTokenAt:function(e,t){return It(this,e,t)},getLineTokens:function(e,t){return It(this,ct(e),t,!0)},getTokenTypeAt:function(e){e=mt(this.doc,e);var t,n=xt(this,tt(this.doc,e.line)),i=0,r=(n.length-1)/2,s=e.ch;if(0==s)t=n[2];else for(;;){var o=i+r>>1;if((o?n[2*o-1]:0)>=s)r=o;else{if(!(n[2*o+1]<s)){t=n[2*o+2];break}i=o+1}}var a=t?t.indexOf("overlay "):-1;return a<0?t:0==a?null:t.slice(0,a-1)},getModeAt:function(t){var n=this.doc.mode;return n.innerMode?e.innerMode(n,this.getTokenAt(t).state).mode:n},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var i=[];if(!n.hasOwnProperty(t))return i;var r=n[t],s=this.getModeAt(e);if("string"==typeof s[t])r[s[t]]&&i.push(r[s[t]]);else if(s[t])for(var o=0;o<s[t].length;o++){var a=r[s[t][o]];a&&i.push(a)}else s.helperType&&r[s.helperType]?i.push(r[s.helperType]):r[s.name]&&i.push(r[s.name]);for(var l=0;l<r._global.length;l++){var c=r._global[l];c.pred(s,this)&&-1==j(i,c.val)&&i.push(c.val)}return i},getStateAfter:function(e,t){var n=this.doc;return Ct(this,(e=gt(n,e??n.first+n.size-1))+1,t).state},cursorCoords:function(e,t){var n=this.doc.sel.primary();return Ci(this,null==e?n.head:"object"==typeof e?mt(this.doc,e):e?n.from():n.to(),t||"page")},charCoords:function(e,t){return xi(this,mt(this.doc,e),t||"page")},coordsChar:function(e,t){return Ei(this,(e=wi(this,e,t||"page")).left,e.top)},lineAtHeight:function(e,t){return e=wi(this,{top:e,left:0},t||"page").top,ot(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t,n){var i,r=!1;if("number"==typeof e){var s=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>s&&(e=s,r=!0),i=tt(this.doc,e)}else i=e;return Si(this,i,{top:0,left:0},t||"page",n||r).top+(r?this.doc.height-dn(i):0)},defaultTextHeight:function(){return Ri(this.display)},defaultCharWidth:function(){return Ni(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,n,i,r){var s=this.display,o=(e=Ci(this,mt(this.doc,e))).bottom,a=e.left;if(t.style.position="absolute",t.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(t),s.sizer.appendChild(t),"over"==i)o=e.top;else if("above"==i||"near"==i){var l=Math.max(s.wrapper.clientHeight,this.doc.height),c=Math.max(s.sizer.clientWidth,s.lineSpace.clientWidth);("above"==i||e.bottom+t.offsetHeight>l)&&e.top>t.offsetHeight?o=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=l&&(o=e.bottom),a+t.offsetWidth>c&&(a=c-t.offsetWidth)}t.style.top=o+"px",t.style.left=t.style.right="","right"==r?(a=s.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==r?a=0:"middle"==r&&(a=(s.sizer.clientWidth-t.offsetWidth)/2),t.style.left=a+"px"),n&&lr(this,{left:a,top:o,right:a+t.offsetWidth,bottom:o+t.offsetHeight})},triggerOnKeyDown:Br(pa),triggerOnKeyPress:Br(ma),triggerOnKeyUp:ga,triggerOnMouseDown:Br(xa),execCommand:function(e){if(ta.hasOwnProperty(e))return ta[e].call(null,this)},triggerElectric:Br((function(e){Ya(this,e)})),findPosH:function(e,t,n,i){var r=1;t<0&&(r=-1,t=-t);for(var s=mt(this.doc,e),o=0;o<t&&!(s=el(this.doc,s,r,n,i)).hitSide;++o);return s},moveH:Br((function(e,t){var n=this;this.extendSelectionsBy((function(i){return n.display.shift||n.doc.extend||i.empty()?el(n.doc,i.head,e,t,n.options.rtlMoveVisually):e<0?i.from():i.to()}),Z)})),deleteH:Br((function(e,t){var n=this.doc.sel,i=this.doc;n.somethingSelected()?i.replaceSelection("",null,"+delete"):Zo(this,(function(n){var r=el(i,n.head,e,t,!1);return e<0?{from:r,to:n.head}:{from:n.head,to:r}}))})),findPosV:function(e,t,n,i){var r=1,s=i;t<0&&(r=-1,t=-t);for(var o=mt(this.doc,e),a=0;a<t;++a){var l=Ci(this,o,"div");if(null==s?s=l.left:l.left=s,(o=tl(this,l,r,n)).hitSide)break}return o},moveV:Br((function(e,t){var n=this,i=this.doc,r=[],s=!this.display.shift&&!i.extend&&i.sel.somethingSelected();if(i.extendSelectionsBy((function(o){if(s)return e<0?o.from():o.to();var a=Ci(n,o.head,"div");null!=o.goalColumn&&(a.left=o.goalColumn),r.push(a.left);var l=tl(n,a,e,t);return"page"==t&&o==i.sel.primary()&&dr(n,xi(n,l,"div").top-a.top),l}),Z),r.length)for(var o=0;o<i.sel.ranges.length;o++)i.sel.ranges[o].goalColumn=r[o]})),findWordAt:function(e){var t=tt(this.doc,e.line).text,n=e.ch,i=e.ch;if(t){var r=this.getHelper(e,"wordChars");"before"!=e.sticky&&i!=t.length||!n?++i:--n;for(var s=t.charAt(n),o=ae(s,r)?function(e){return ae(e,r)}:/\s/.test(s)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!ae(e)};n>0&&o(t.charAt(n-1));)--n;for(;i<t.length&&o(t.charAt(i));)++i}return new cs(ct(e.line,n),ct(e.line,i))},toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?N(this.display.cursorDiv,"CodeMirror-overwrite"):L(this.display.cursorDiv,"CodeMirror-overwrite"),xe(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==R(_(this))},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:Br((function(e,t){hr(this,e,t)})),getScrollInfo:function(){var e=this.display.scroller;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-Kn(this)-this.display.barHeight,width:e.scrollWidth-Kn(this)-this.display.barWidth,clientHeight:ei(this),clientWidth:Qn(this)}},scrollIntoView:Br((function(e,t){null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:ct(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line?pr(this,e):gr(this,e.from,e.to,e.margin)})),setSize:Br((function(e,t){var n=this,i=function(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e};null!=e&&(this.display.wrapper.style.width=i(e)),null!=t&&(this.display.wrapper.style.height=i(t)),this.options.lineWrapping&&gi(this);var r=this.display.viewFrom;this.doc.iter(r,this.display.viewTo,(function(e){if(e.widgets)for(var t=0;t<e.widgets.length;t++)if(e.widgets[t].noHScroll){Gi(n,r,"widget");break}++r})),this.curOp.forceUpdate=!0,xe(this,"refresh",this)})),operation:function(e){return Vr(this,e)},startOperation:function(){return Lr(this)},endOperation:function(){return Ir(this)},refresh:Br((function(){var e=this.display.cachedTextHeight;Ui(this),this.curOp.forceUpdate=!0,mi(this),hr(this,this.doc.scrollLeft,this.doc.scrollTop),Yr(this.display),(null==e||Math.abs(e-Ri(this.display))>.5||this.options.lineWrapping)&&_i(this),xe(this,"refresh",this)})),swapDoc:Br((function(e){var t=this.doc;return t.cm=null,this.state.selectingText&&this.state.selectingText(),xs(this,e),mi(this),this.display.input.reset(),hr(this,e.scrollLeft,e.scrollTop),this.curOp.forceScroll=!0,Rn(this,"swapDoc",this,t),t})),phrase:function(e){var t=this.options.phrases;return t&&Object.prototype.hasOwnProperty.call(t,e)?t[e]:e},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Ee(e),e.registerHelper=function(t,i,r){n.hasOwnProperty(t)||(n[t]=e[t]={_global:[]}),n[t][i]=r},e.registerGlobalHelper=function(t,i,r,s){e.registerHelper(t,i,s),n[t]._global.push({pred:r,val:s})}}function el(e,t,n,i,r){var s=t,o=n,a=tt(e,t.line),l=r&&"rtl"==e.direction?-n:n;function c(){var n=t.line+l;return!(n<e.first||n>=e.first+e.size)&&(t=new ct(n,t.ch,t.sticky),a=tt(e,n))}function d(s){var o;if("codepoint"==i){var d=a.text.charCodeAt(t.ch+(n>0?0:-1));if(isNaN(d))o=null;else{var u=n>0?d>=55296&&d<56320:d>=56320&&d<57343;o=new ct(t.line,Math.max(0,Math.min(a.text.length,t.ch+n*(u?2:1))),-n)}}else o=r?ea(e.cm,a,t,n):Ko(a,t,n);if(null==o){if(s||!c())return!1;t=Qo(r,e.cm,a,t.line,l)}else t=o;return!0}if("char"==i||"codepoint"==i)d();else if("column"==i)d(!0);else if("word"==i||"group"==i)for(var u=null,h="group"==i,p=e.cm&&e.cm.getHelper(t,"wordChars"),f=!0;!(n<0)||d(!f);f=!1){var g=a.text.charAt(t.ch)||"\n",m=ae(g,p)?"w":h&&"\n"==g?"n":!h||/\s/.test(g)?null:"p";if(h&&!f&&!m&&(m="s"),u&&u!=m){n<0&&(n=1,d(),t.sticky="after");break}if(m&&(u=m),n>0&&!d(!f))break}var v=Xs(e,t,s,o,!0);return ut(s,v)&&(v.hitSide=!0),v}function tl(e,t,n,i){var r,s,o=e.doc,a=t.left;if("page"==i){var l=Math.min(e.display.wrapper.clientHeight,z(e).innerHeight||o(e).documentElement.clientHeight),c=Math.max(l-.5*Ri(e.display),3);r=(n>0?t.bottom:t.top)+n*c}else"line"==i&&(r=n>0?t.bottom+3:t.top-3);for(;(s=Ei(e,a,r)).outside;){if(n<0?r<=0:r>=o.height){s.hitSide=!0;break}r+=5*n}return s}var nl=function(e){this.cm=e,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new $,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};function il(e,t){var n=si(e,t.line);if(!n||n.hidden)return null;var i=tt(e.doc,t.line),r=ni(n,i,t.line),s=ve(i,e.doc.direction),o="left";s&&(o=ge(s,t.ch)%2?"right":"left");var a=di(r.map,t.ch,o);return a.offset="right"==a.collapse?a.end:a.start,a}function rl(e){for(var t=e;t;t=t.parentNode)if(/CodeMirror-gutter-wrapper/.test(t.className))return!0;return!1}function sl(e,t){return t&&(e.bad=!0),e}function ol(e,t,n,i,r){var s="",o=!1,a=e.doc.lineSeparator(),l=!1;function c(e){return function(t){return t.id==e}}function d(){o&&(s+=a,l&&(s+=a),o=l=!1)}function u(e){e&&(d(),s+=e)}function h(t){if(1==t.nodeType){var n=t.getAttribute("cm-text");if(n)return void u(n);var s,p=t.getAttribute("cm-marker");if(p){var f=e.findMarks(ct(i,0),ct(r+1,0),c(+p));return void(f.length&&(s=f[0].find(0))&&u(nt(e.doc,s.from,s.to).join(a)))}if("false"==t.getAttribute("contenteditable"))return;var g=/^(pre|div|p|li|table|br)$/i.test(t.nodeName);if(!/^br$/i.test(t.nodeName)&&0==t.textContent.length)return;g&&d();for(var m=0;m<t.childNodes.length;m++)h(t.childNodes[m]);/^(pre|p)$/i.test(t.nodeName)&&(l=!0),g&&(o=!0)}else 3==t.nodeType&&u(t.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;h(t),t!=n;)t=t.nextSibling,l=!1;return s}function al(e,t,n){var i;if(t==e.display.lineDiv){if(!(i=e.display.lineDiv.childNodes[n]))return sl(e.clipPos(ct(e.display.viewTo-1)),!0);t=null,n=0}else for(i=t;;i=i.parentNode){if(!i||i==e.display.lineDiv)return null;if(i.parentNode&&i.parentNode==e.display.lineDiv)break}for(var r=0;r<e.display.view.length;r++){var s=e.display.view[r];if(s.node==i)return ll(s,t,n)}}function ll(e,t,n){var i=e.text.firstChild,r=!1;if(!t||!A(i,t))return sl(ct(st(e.line),0),!0);if(t==i&&(r=!0,t=i.childNodes[n],n=0,!t)){var s=e.rest?ee(e.rest):e.line;return sl(ct(st(s),s.text.length),r)}var o=3==t.nodeType?t:null,a=t;for(!o&&1==t.childNodes.length&&3==t.firstChild.nodeType&&(o=t.firstChild,n&&(n=o.nodeValue.length));a.parentNode!=i;)a=a.parentNode;var l=e.measure,c=l.maps;function d(t,n,i){for(var r=-1;r<(c?c.length:0);r++)for(var s=r<0?l.map:c[r],o=0;o<s.length;o+=3){var a=s[o+2];if(a==t||a==n){var d=st(r<0?e.line:e.rest[r]),u=s[o]+i;return(i<0||a!=t)&&(u=s[o+(i?1:0)]),ct(d,u)}}}var u=d(o,a,n);if(u)return sl(u,r);for(var h=a.nextSibling,p=o?o.nodeValue.length-n:0;h;h=h.nextSibling){if(u=d(h,h.firstChild,0))return sl(ct(u.line,u.ch-p),r);p+=h.textContent.length}for(var f=a.previousSibling,g=n;f;f=f.previousSibling){if(u=d(f,f.firstChild,-1))return sl(ct(u.line,u.ch+g),r);g+=f.textContent.length}}nl.prototype.init=function(e){var t=this,n=this,i=n.cm,r=n.div=e.lineDiv;function s(e){for(var t=e.target;t;t=t.parentNode){if(t==r)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(t.className))break}return!1}function o(e){if(s(e)&&!Ce(i,e)){if(i.somethingSelected())Ha({lineWise:!1,text:i.getSelections()}),"cut"==e.type&&i.replaceSelection("",null,"cut");else{if(!i.options.lineWiseCopyCut)return;var t=Za(i);Ha({lineWise:!0,text:t.text}),"cut"==e.type&&i.operation((function(){i.setSelections(t.ranges,0,q),i.replaceSelection("",null,"cut")}))}if(e.clipboardData){e.clipboardData.clearData();var o=ja.text.join("\n");if(e.clipboardData.setData("Text",o),e.clipboardData.getData("Text")==o)return void e.preventDefault()}var a=Ka(),l=a.firstChild;Xa(l),i.display.lineSpace.insertBefore(a,i.display.lineSpace.firstChild),l.value=ja.text.join("\n");var c=R(F(r));O(l),setTimeout((function(){i.display.lineSpace.removeChild(a),c.focus(),c==r&&n.showPrimarySelection()}),50)}}r.contentEditable=!0,Xa(r,i.options.spellcheck,i.options.autocorrect,i.options.autocapitalize),be(r,"paste",(function(e){!s(e)||Ce(i,e)||qa(e,i)||a<=11&&setTimeout(Or(i,(function(){return t.updateFromDOM()})),20)})),be(r,"compositionstart",(function(e){t.composing={data:e.data,done:!1}})),be(r,"compositionupdate",(function(e){t.composing||(t.composing={data:e.data,done:!1})})),be(r,"compositionend",(function(e){t.composing&&(e.data!=t.composing.data&&t.readFromDOMSoon(),t.composing.done=!0)})),be(r,"touchstart",(function(){return n.forceCompositionEnd()})),be(r,"input",(function(){t.composing||t.readFromDOMSoon()})),be(r,"copy",o),be(r,"cut",o)},nl.prototype.screenReaderLabelChanged=function(e){e?this.div.setAttribute("aria-label",e):this.div.removeAttribute("aria-label")},nl.prototype.prepareSelection=function(){var e=qi(this.cm,!1);return e.focus=R(F(this.div))==this.div,e},nl.prototype.showSelection=function(e,t){!e||!this.cm.display.view.length||((e.focus||t)&&this.showPrimarySelection(),this.showMultipleSelections(e))},nl.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},nl.prototype.showPrimarySelection=function(){var e=this.getSelection(),t=this.cm,i=t.doc.sel.primary(),r=i.from(),s=i.to();if(t.display.viewTo==t.display.viewFrom||r.line>=t.display.viewTo||s.line<t.display.viewFrom)e.removeAllRanges();else{var o=al(t,e.anchorNode,e.anchorOffset),a=al(t,e.focusNode,e.focusOffset);if(!o||o.bad||!a||a.bad||0!=dt(ft(o,a),r)||0!=dt(pt(o,a),s)){var l=t.display.view,c=r.line>=t.display.viewFrom&&il(t,r)||{node:l[0].measure.map[2],offset:0},d=s.line<t.display.viewTo&&il(t,s);if(!d){var u=l[l.length-1].measure,h=u.maps?u.maps[u.maps.length-1]:u.map;d={node:h[h.length-1],offset:h[h.length-2]-h[h.length-3]}}if(!c||!d)return void e.removeAllRanges();var p,f=e.rangeCount&&e.getRangeAt(0);try{p=E(c.node,c.offset,d.offset,d.node)}catch{}p&&(!n&&t.state.focused?(e.collapse(c.node,c.offset),p.collapsed||(e.removeAllRanges(),e.addRange(p))):(e.removeAllRanges(),e.addRange(p)),f&&null==e.anchorNode?e.addRange(f):n&&this.startGracePeriod()),this.rememberSelection()}}},nl.prototype.startGracePeriod=function(){var e=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout((function(){e.gracePeriod=!1,e.selectionChanged()&&e.cm.operation((function(){return e.cm.curOp.selectionChanged=!0}))}),20)},nl.prototype.showMultipleSelections=function(e){D(this.cm.display.cursorDiv,e.cursors),D(this.cm.display.selectionDiv,e.selection)},nl.prototype.rememberSelection=function(){var e=this.getSelection();this.lastAnchorNode=e.anchorNode,this.lastAnchorOffset=e.anchorOffset,this.lastFocusNode=e.focusNode,this.lastFocusOffset=e.focusOffset},nl.prototype.selectionInEditor=function(){var e=this.getSelection();if(!e.rangeCount)return!1;var t=e.getRangeAt(0).commonAncestorContainer;return A(this.div,t)},nl.prototype.focus=function(){"nocursor"!=this.cm.options.readOnly&&((!this.selectionInEditor()||R(F(this.div))!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},nl.prototype.blur=function(){this.div.blur()},nl.prototype.getField=function(){return this.div},nl.prototype.supportsTouch=function(){return!0},nl.prototype.receivedFocus=function(){var e=this,t=this;function n(){t.cm.state.focused&&(t.pollSelection(),t.polling.set(t.cm.options.pollInterval,n))}this.selectionInEditor()?setTimeout((function(){return e.pollSelection()}),20):Vr(this.cm,(function(){return t.cm.curOp.selectionChanged=!0})),this.polling.set(this.cm.options.pollInterval,n)},nl.prototype.selectionChanged=function(){var e=this.getSelection();return e.anchorNode!=this.lastAnchorNode||e.anchorOffset!=this.lastAnchorOffset||e.focusNode!=this.lastFocusNode||e.focusOffset!=this.lastFocusOffset},nl.prototype.pollSelection=function(){if(null==this.readDOMTimeout&&!this.gracePeriod&&this.selectionChanged()){var e=this.getSelection(),t=this.cm;if(v&&d&&this.cm.display.gutterSpecs.length&&rl(e.anchorNode))return this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),void this.focus();if(!this.composing){this.rememberSelection();var n=al(t,e.anchorNode,e.anchorOffset),i=al(t,e.focusNode,e.focusOffset);n&&i&&Vr(t,(function(){js(t.doc,us(n,i),q),(n.bad||i.bad)&&(t.curOp.selectionChanged=!0)}))}}},nl.prototype.pollContent=function(){null!=this.readDOMTimeout&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var e,t,n,i=this.cm,r=i.display,s=i.doc.sel.primary(),o=s.from(),a=s.to();if(0==o.ch&&o.line>i.firstLine()&&(o=ct(o.line-1,tt(i.doc,o.line-1).length)),a.ch==tt(i.doc,a.line).text.length&&a.line<i.lastLine()&&(a=ct(a.line+1,0)),o.line<r.viewFrom||a.line>r.viewTo-1)return!1;o.line==r.viewFrom||0==(e=zi(i,o.line))?(t=st(r.view[0].line),n=r.view[0].node):(t=st(r.view[e].line),n=r.view[e-1].node.nextSibling);var l,c,d=zi(i,a.line);if(d==r.view.length-1?(l=r.viewTo-1,c=r.lineDiv.lastChild):(l=st(r.view[d+1].line)-1,c=r.view[d+1].node.previousSibling),!n)return!1;for(var u=i.doc.splitLines(ol(i,n,c,t,l)),h=nt(i.doc,ct(t,0),ct(l,tt(i.doc,l).text.length));u.length>1&&h.length>1;)if(ee(u)==ee(h))u.pop(),h.pop(),l--;else{if(u[0]!=h[0])break;u.shift(),h.shift(),t++}for(var p=0,f=0,g=u[0],m=h[0],v=Math.min(g.length,m.length);p<v&&g.charCodeAt(p)==m.charCodeAt(p);)++p;for(var y=ee(u),b=ee(h),S=Math.min(y.length-(1==u.length?p:0),b.length-(1==h.length?p:0));f<S&&y.charCodeAt(y.length-f-1)==b.charCodeAt(b.length-f-1);)++f;if(1==u.length&&1==h.length&&t==o.line)for(;p&&p>o.ch&&y.charCodeAt(y.length-f-1)==b.charCodeAt(b.length-f-1);)p--,f++;u[u.length-1]=y.slice(0,y.length-f).replace(/^\u200b+/,""),u[0]=u[0].slice(p).replace(/\u200b+$/,"");var w=ct(t,p),x=ct(l,h.length?ee(h).length-f:0);return u.length>1||u[0]||dt(w,x)?(ao(i.doc,u,w,x,"+input"),!0):void 0},nl.prototype.ensurePolled=function(){this.forceCompositionEnd()},nl.prototype.reset=function(){this.forceCompositionEnd()},nl.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},nl.prototype.readFromDOMSoon=function(){var e=this;null==this.readDOMTimeout&&(this.readDOMTimeout=setTimeout((function(){if(e.readDOMTimeout=null,e.composing){if(!e.composing.done)return;e.composing=null}e.updateFromDOM()}),80))},nl.prototype.updateFromDOM=function(){var e=this;(this.cm.isReadOnly()||!this.pollContent())&&Vr(this.cm,(function(){return Ui(e.cm)}))},nl.prototype.setUneditable=function(e){e.contentEditable="false"},nl.prototype.onKeyPress=function(e){0==e.charCode||this.composing||(e.preventDefault(),this.cm.isReadOnly()||Or(this.cm,Ja)(this.cm,String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),0))},nl.prototype.readOnlyChanged=function(e){this.div.contentEditable=String("nocursor"!=e)},nl.prototype.onContextMenu=function(){},nl.prototype.resetPosition=function(){},nl.prototype.needsContentAttribute=!0;var cl=function(e){this.cm=e,this.prevInput="",this.pollingFast=!1,this.polling=new $,this.hasSelection=!1,this.composing=null,this.resetting=!1};function dl(e,t){if((t=t?G(t):{}).value=e.value,!t.tabindex&&e.tabIndex&&(t.tabindex=e.tabIndex),!t.placeholder&&e.placeholder&&(t.placeholder=e.placeholder),null==t.autofocus){var n=R(F(e));t.autofocus=n==e||null!=e.getAttribute("autofocus")&&n==document.body}function i(){e.value=a.getValue()}var r;if(e.form&&(be(e.form,"submit",i),!t.leaveSubmitMethodAlone)){var s=e.form;r=s.submit;try{var o=s.submit=function(){i(),s.submit=r,s.submit(),s.submit=o}}catch{}}t.finishInit=function(n){n.save=i,n.getTextArea=function(){return e},n.toTextArea=function(){n.toTextArea=isNaN,i(),e.parentNode.removeChild(n.getWrapperElement()),e.style.display="",e.form&&(we(e.form,"submit",i),!t.leaveSubmitMethodAlone&&"function"==typeof e.form.submit&&(e.form.submit=r))}},e.style.display="none";var a=Ua((function(t){return e.parentNode.insertBefore(t,e.nextSibling)}),t);return a}function ul(e){e.off=we,e.on=be,e.wheelEventPixels=os,e.Doc=Lo,e.splitLines=_e,e.countColumn=W,e.findColumn=X,e.isWordChar=oe,e.Pass=J,e.signal=xe,e.Line=pn,e.changeEnd=hs,e.scrollbarModel=kr,e.Pos=ct,e.cmpPos=dt,e.modes=We,e.mimeModes=$e,e.resolveMode=Je,e.getMode=qe,e.modeExtensions=Ye,e.extendMode=Ze,e.copyState=Xe,e.startState=Qe,e.innerMode=Ke,e.commands=ta,e.keyMap=Go,e.keyName=qo,e.isModifierKey=Ho,e.lookupKey=jo,e.normalizeKeyMap=$o,e.StringStream=et,e.SharedTextMarker=wo,e.TextMarker=bo,e.LineWidget=go,e.e_preventDefault=Le,e.e_stopPropagation=Ie,e.e_stop=Me,e.addClass=N,e.contains=A,e.rmClass=L,e.keyNames=_o}cl.prototype.init=function(e){var t=this,n=this,i=this.cm;this.createField(e);var r=this.textarea;function s(e){if(!Ce(i,e)){if(i.somethingSelected())Ha({lineWise:!1,text:i.getSelections()});else{if(!i.options.lineWiseCopyCut)return;var t=Za(i);Ha({lineWise:!0,text:t.text}),"cut"==e.type?i.setSelections(t.ranges,null,q):(n.prevInput="",r.value=t.text.join("\n"),O(r))}"cut"==e.type&&(i.state.cutIncoming=+new Date)}}e.wrapper.insertBefore(this.wrapper,e.wrapper.firstChild),m&&(r.style.width="0px"),be(r,"input",(function(){o&&a>=9&&t.hasSelection&&(t.hasSelection=null),n.poll()})),be(r,"paste",(function(e){Ce(i,e)||qa(e,i)||(i.state.pasteIncoming=+new Date,n.fastPoll())})),be(r,"cut",s),be(r,"copy",s),be(e.scroller,"paste",(function(t){if(!qn(e,t)&&!Ce(i,t)){if(!r.dispatchEvent)return i.state.pasteIncoming=+new Date,void n.focus();var s=new Event("paste");s.clipboardData=t.clipboardData,r.dispatchEvent(s)}})),be(e.lineSpace,"selectstart",(function(t){qn(e,t)||Le(t)})),be(r,"compositionstart",(function(){var e=i.getCursor("from");n.composing&&n.composing.range.clear(),n.composing={start:e,range:i.markText(e,i.getCursor("to"),{className:"CodeMirror-composing"})}})),be(r,"compositionend",(function(){n.composing&&(n.poll(),n.composing.range.clear(),n.composing=null)}))},cl.prototype.createField=function(e){this.wrapper=Ka(),this.textarea=this.wrapper.firstChild;var t=this.cm.options;Xa(this.textarea,t.spellcheck,t.autocorrect,t.autocapitalize)},cl.prototype.screenReaderLabelChanged=function(e){e?this.textarea.setAttribute("aria-label",e):this.textarea.removeAttribute("aria-label")},cl.prototype.prepareSelection=function(){var e=this.cm,t=e.display,n=e.doc,i=qi(e);if(e.options.moveInputWithCursor){var r=Ci(e,n.sel.primary().head,"div"),s=t.wrapper.getBoundingClientRect(),o=t.lineDiv.getBoundingClientRect();i.teTop=Math.max(0,Math.min(t.wrapper.clientHeight-10,r.top+o.top-s.top)),i.teLeft=Math.max(0,Math.min(t.wrapper.clientWidth-10,r.left+o.left-s.left))}return i},cl.prototype.showSelection=function(e){var t=this.cm.display;D(t.cursorDiv,e.cursors),D(t.selectionDiv,e.selection),null!=e.teTop&&(this.wrapper.style.top=e.teTop+"px",this.wrapper.style.left=e.teLeft+"px")},cl.prototype.reset=function(e){if(!(this.contextMenuPending||this.composing&&e)){var t=this.cm;if(this.resetting=!0,t.somethingSelected()){this.prevInput="";var n=t.getSelection();this.textarea.value=n,t.state.focused&&O(this.textarea),o&&a>=9&&(this.hasSelection=n)}else e||(this.prevInput=this.textarea.value="",o&&a>=9&&(this.hasSelection=null));this.resetting=!1}},cl.prototype.getField=function(){return this.textarea},cl.prototype.supportsTouch=function(){return!1},cl.prototype.focus=function(){if("nocursor"!=this.cm.options.readOnly&&(!y||R(F(this.textarea))!=this.textarea))try{this.textarea.focus()}catch{}},cl.prototype.blur=function(){this.textarea.blur()},cl.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},cl.prototype.receivedFocus=function(){this.slowPoll()},cl.prototype.slowPoll=function(){var e=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,(function(){e.poll(),e.cm.state.focused&&e.slowPoll()}))},cl.prototype.fastPoll=function(){var e=!1,t=this;function n(){t.poll()||e?(t.pollingFast=!1,t.slowPoll()):(e=!0,t.polling.set(60,n))}t.pollingFast=!0,t.polling.set(20,n)},cl.prototype.poll=function(){var e=this,t=this.cm,n=this.textarea,i=this.prevInput;if(this.contextMenuPending||this.resetting||!t.state.focused||Fe(n)&&!i&&!this.composing||t.isReadOnly()||t.options.disableInput||t.state.keySeq)return!1;var r=n.value;if(r==i&&!t.somethingSelected())return!1;if(o&&a>=9&&this.hasSelection===r||b&&/[\uf700-\uf7ff]/.test(r))return t.display.input.reset(),!1;if(t.doc.sel==t.display.selForContextMenu){var s=r.charCodeAt(0);if(8203==s&&!i&&(i="\u200b"),8666==s)return this.reset(),this.cm.execCommand("undo")}for(var l=0,c=Math.min(i.length,r.length);l<c&&i.charCodeAt(l)==r.charCodeAt(l);)++l;return Vr(t,(function(){Ja(t,r.slice(l),i.length-l,null,e.composing?"*compose":null),r.length>1e3||r.indexOf("\n")>-1?n.value=e.prevInput="":e.prevInput=r,e.composing&&(e.composing.range.clear(),e.composing.range=t.markText(e.composing.start,t.getCursor("to"),{className:"CodeMirror-composing"}))})),!0},cl.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},cl.prototype.onKeyPress=function(){o&&a>=9&&(this.hasSelection=null),this.fastPoll()},cl.prototype.onContextMenu=function(e){var t=this,n=t.cm,i=n.display,r=t.textarea;t.contextMenuPending&&t.contextMenuPending();var s=Fi(n,e),c=i.scroller.scrollTop;if(s&&!h){n.options.resetSelectionOnContextMenu&&-1==n.doc.sel.contains(s)&&Or(n,js)(n.doc,us(s),q);var d,u=r.style.cssText,p=t.wrapper.style.cssText,f=t.wrapper.offsetParent.getBoundingClientRect();if(t.wrapper.style.cssText="position: static",r.style.cssText="position: absolute; width: 30px; height: 30px;\n      top: "+(e.clientY-f.top-5)+"px; left: "+(e.clientX-f.left-5)+"px;\n      z-index: 1000; background: "+(o?"rgba(255, 255, 255, .05)":"transparent")+";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);",l&&(d=r.ownerDocument.defaultView.scrollY),i.input.focus(),l&&r.ownerDocument.defaultView.scrollTo(null,d),i.input.reset(),n.somethingSelected()||(r.value=t.prevInput=" "),t.contextMenuPending=v,i.selForContextMenu=n.doc.sel,clearTimeout(i.detectingSelectAll),o&&a>=9&&m(),k){Me(e);var g=function(){we(window,"mouseup",g),setTimeout(v,20)};be(window,"mouseup",g)}else setTimeout(v,50)}function m(){if(null!=r.selectionStart){var e=n.somethingSelected(),s="\u200b"+(e?r.value:"");r.value="\u21da",r.value=s,t.prevInput=e?"":"\u200b",r.selectionStart=1,r.selectionEnd=s.length,i.selForContextMenu=n.doc.sel}}function v(){if(t.contextMenuPending==v&&(t.contextMenuPending=!1,t.wrapper.style.cssText=p,r.style.cssText=u,o&&a<9&&i.scrollbars.setScrollTop(i.scroller.scrollTop=c),null!=r.selectionStart)){(!o||o&&a<9)&&m();var e=0,s=function(){i.selForContextMenu==n.doc.sel&&0==r.selectionStart&&r.selectionEnd>0&&"\u200b"==t.prevInput?Or(n,Qs)(n):e++<10?i.detectingSelectAll=setTimeout(s,500):(i.selForContextMenu=null,i.input.reset())};i.detectingSelectAll=setTimeout(s,200)}}},cl.prototype.readOnlyChanged=function(e){e||this.reset(),this.textarea.disabled="nocursor"==e,this.textarea.readOnly=!!e},cl.prototype.setUneditable=function(){},cl.prototype.needsContentAttribute=!1,_a(Ua),Qa(Ua);var hl="iter insert remove copy getEditor constructor".split(" ");for(var pl in Lo.prototype)Lo.prototype.hasOwnProperty(pl)&&j(hl,pl)<0&&(Ua.prototype[pl]=function(e){return function(){return e.apply(this.doc,arguments)}}(Lo.prototype[pl]));return Ee(Lo),Ua.inputStyles={textarea:cl,contenteditable:nl},Ua.defineMode=function(e){!Ua.defaults.mode&&"null"!=e&&(Ua.defaults.mode=e),je.apply(this,arguments)},Ua.defineMIME=He,Ua.defineMode("null",(function(){return{token:function(e){return e.skipToEnd()}}})),Ua.defineMIME("text/plain","null"),Ua.defineExtension=function(e,t){Ua.prototype[e]=t},Ua.defineDocExtension=function(e,t){Lo.prototype[e]=t},Ua.fromTextArea=dl,ul(Ua),Ua.version="5.65.18",Ua}()}(Dk)),Dk.exports}!function(){var e;(e=Mk()).defineMode("javascript",(function(t,n){var i,r,s=t.indentUnit,o=n.statementIndent,a=n.jsonld,l=n.json||a,c=!1!==n.trackScope,d=n.typescript,u=n.wordCharacters||/[\w$\xa1-\uffff]/,h=function(){function e(e){return{type:e,style:"keyword"}}var t=e("keyword a"),n=e("keyword b"),i=e("keyword c"),r=e("keyword d"),s=e("operator"),o={type:"atom",style:"atom"};return{if:e("if"),while:t,with:t,else:n,do:n,try:n,finally:n,return:r,break:r,continue:r,new:e("new"),delete:i,void:i,throw:i,debugger:e("debugger"),var:e("var"),const:e("var"),let:e("var"),function:e("function"),catch:e("catch"),for:e("for"),switch:e("switch"),case:e("case"),default:e("default"),in:s,typeof:s,instanceof:s,true:o,false:o,null:o,undefined:o,NaN:o,Infinity:o,this:e("this"),class:e("class"),super:e("atom"),yield:i,export:e("export"),import:e("import"),extends:i,await:i}}(),p=/[+\-*&%=<>!?|~^@]/,f=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function g(e){for(var t,n=!1,i=!1;null!=(t=e.next());){if(!n){if("/"==t&&!i)return;"["==t?i=!0:i&&"]"==t&&(i=!1)}n=!n&&"\\"==t}}function m(e,t,n){return i=e,r=n,t}function v(e,t){var n=e.next();if('"'==n||"'"==n)return t.tokenize=y(n),t.tokenize(e,t);if("."==n&&e.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return m("number","number");if("."==n&&e.match(".."))return m("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(n))return m(n);if("="==n&&e.eat(">"))return m("=>","operator");if("0"==n&&e.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return m("number","number");if(/\d/.test(n))return e.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),m("number","number");if("/"==n)return e.eat("*")?(t.tokenize=b,b(e,t)):e.eat("/")?(e.skipToEnd(),m("comment","comment")):rt(e,t,1)?(g(e),e.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),m("regexp","string-2")):(e.eat("="),m("operator","operator",e.current()));if("`"==n)return t.tokenize=S,S(e,t);if("#"==n&&"!"==e.peek())return e.skipToEnd(),m("meta","meta");if("#"==n&&e.eatWhile(u))return m("variable","property");if("<"==n&&e.match("!--")||"-"==n&&e.match("->")&&!/\S/.test(e.string.slice(0,e.start)))return e.skipToEnd(),m("comment","comment");if(p.test(n))return(">"!=n||!t.lexical||">"!=t.lexical.type)&&(e.eat("=")?("!"==n||"="==n)&&e.eat("="):/[<>*+\-|&?]/.test(n)&&(e.eat(n),">"==n&&e.eat(n))),"?"==n&&e.eat(".")?m("."):m("operator","operator",e.current());if(u.test(n)){e.eatWhile(u);var i=e.current();if("."!=t.lastType){if(h.propertyIsEnumerable(i)){var r=h[i];return m(r.type,r.style,i)}if("async"==i&&e.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return m("async","keyword",i)}return m("variable","variable",i)}}function y(e){return function(t,n){var i,r=!1;if(a&&"@"==t.peek()&&t.match(f))return n.tokenize=v,m("jsonld-keyword","meta");for(;null!=(i=t.next())&&(i!=e||r);)r=!r&&"\\"==i;return r||(n.tokenize=v),m("string","string")}}function b(e,t){for(var n,i=!1;n=e.next();){if("/"==n&&i){t.tokenize=v;break}i="*"==n}return m("comment","comment")}function S(e,t){for(var n,i=!1;null!=(n=e.next());){if(!i&&("`"==n||"$"==n&&e.eat("{"))){t.tokenize=v;break}i=!i&&"\\"==n}return m("quasi","string-2",e.current())}var w="([{}])";function x(e,t){t.fatArrowAt&&(t.fatArrowAt=null);var n=e.string.indexOf("=>",e.start);if(!(n<0)){if(d){var i=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(e.string.slice(e.start,n));i&&(n=i.index)}for(var r=0,s=!1,o=n-1;o>=0;--o){var a=e.string.charAt(o),l=w.indexOf(a);if(l>=0&&l<3){if(!r){++o;break}if(0==--r){"("==a&&(s=!0);break}}else if(l>=3&&l<6)++r;else if(u.test(a))s=!0;else if(/["'\/`]/.test(a))for(;;--o){if(0==o)return;if(e.string.charAt(o-1)==a&&"\\"!=e.string.charAt(o-2)){o--;break}}else if(s&&!r){++o;break}}s&&!r&&(t.fatArrowAt=o)}}var C={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function k(e,t,n,i,r,s){this.indented=e,this.column=t,this.type=n,this.prev=r,this.info=s,null!=i&&(this.align=i)}function T(e,t){if(!c)return!1;for(var n=e.localVars;n;n=n.next)if(n.name==t)return!0;for(var i=e.context;i;i=i.prev)for(n=i.vars;n;n=n.next)if(n.name==t)return!0}function E(e,t,n,i,r){var s=e.cc;for(L.state=e,L.stream=r,L.marked=null,L.cc=s,L.style=t,e.lexical.hasOwnProperty("align")||(e.lexical.align=!0);;)if((s.length?s.pop():l?j:W)(n,i)){for(;s.length&&s[s.length-1].lex;)s.pop()();return L.marked?L.marked:"variable"==n&&T(e,i)?"variable-2":t}}var L={state:null,column:null,marked:null,cc:null};function I(){for(var e=arguments.length-1;e>=0;e--)L.cc.push(arguments[e])}function D(){return I.apply(null,arguments),!0}function M(e,t){for(var n=t;n;n=n.next)if(n.name==e)return!0;return!1}function P(e){var t=L.state;if(L.marked="def",c){if(t.context)if("var"==t.lexical.info&&t.context&&t.context.block){var i=A(e,t.context);if(null!=i)return void(t.context=i)}else if(!M(e,t.localVars))return void(t.localVars=new V(e,t.localVars));n.globalVars&&!M(e,t.globalVars)&&(t.globalVars=new V(e,t.globalVars))}}function A(e,t){if(t){if(t.block){var n=A(e,t.prev);return n?n==t.prev?t:new N(n,t.vars,!0):null}return M(e,t.vars)?t:new N(t.prev,new V(e,t.vars),!1)}return null}function R(e){return"public"==e||"private"==e||"protected"==e||"abstract"==e||"readonly"==e}function N(e,t,n){this.prev=e,this.vars=t,this.block=n}function V(e,t){this.name=e,this.next=t}var O=new V("this",new V("arguments",null));function B(){L.state.context=new N(L.state.context,L.state.localVars,!1),L.state.localVars=O}function _(){L.state.context=new N(L.state.context,L.state.localVars,!0),L.state.localVars=null}function F(){L.state.localVars=L.state.context.vars,L.state.context=L.state.context.prev}function z(e,t){var n=function(){var n=L.state,i=n.indented;if("stat"==n.lexical.type)i=n.lexical.indented;else for(var r=n.lexical;r&&")"==r.type&&r.align;r=r.prev)i=r.indented;n.lexical=new k(i,L.stream.column(),e,null,n.lexical,t)};return n.lex=!0,n}function U(){var e=L.state;e.lexical.prev&&(")"==e.lexical.type&&(e.indented=e.lexical.indented),e.lexical=e.lexical.prev)}function G(e){function t(n){return n==e?D():";"==e||"}"==n||")"==n||"]"==n?I():D(t)}return t}function W(e,t){return"var"==e?D(z("vardef",t),Ie,G(";"),U):"keyword a"==e?D(z("form"),J,W,U):"keyword b"==e?D(z("form"),W,U):"keyword d"==e?L.stream.match(/^\s*$/,!1)?D():D(z("stat"),Y,G(";"),U):"debugger"==e?D(G(";")):"{"==e?D(z("}"),_,he,U,F):";"==e?D():"if"==e?("else"==L.state.lexical.info&&L.state.cc[L.state.cc.length-1]==U&&L.state.cc.pop()(),D(z("form"),J,W,U,Ne)):"function"==e?D(_e):"for"==e?D(z("form"),_,Ve,W,F,U):"class"==e||d&&"interface"==t?(L.marked="keyword",D(z("form","class"==e?e:t),We,U)):"variable"==e?d&&"declare"==t?(L.marked="keyword",D(W)):d&&("module"==t||"enum"==t||"type"==t)&&L.stream.match(/^\s*\w/,!1)?(L.marked="keyword","enum"==t?D(tt):"type"==t?D(ze,G("operator"),ve,G(";")):D(z("form"),De,G("{"),z("}"),he,U,U)):d&&"namespace"==t?(L.marked="keyword",D(z("form"),j,W,U)):d&&"abstract"==t?(L.marked="keyword",D(W)):D(z("stat"),se):"switch"==e?D(z("form"),J,G("{"),z("}","switch"),_,he,U,U,F):"case"==e?D(j,G(":")):"default"==e?D(G(":")):"catch"==e?D(z("form"),B,$,W,U,F):"export"==e?D(z("stat"),Je,U):"import"==e?D(z("stat"),Ye,U):"async"==e?D(W):"@"==t?D(j,W):I(z("stat"),j,G(";"),U)}function $(e){if("("==e)return D(Ue,G(")"))}function j(e,t){return q(e,t,!1)}function H(e,t){return q(e,t,!0)}function J(e){return"("!=e?I():D(z(")"),Y,G(")"),U)}function q(e,t,n){if(L.state.fatArrowAt==L.stream.start){var i=n?te:ee;if("("==e)return D(B,z(")"),de(Ue,")"),U,G("=>"),i,F);if("variable"==e)return I(B,De,G("=>"),i,F)}var r=n?X:Z;return C.hasOwnProperty(e)?D(r):"function"==e?D(_e,r):"class"==e||d&&"interface"==t?(L.marked="keyword",D(z("form"),Ge,U)):"keyword c"==e||"async"==e?D(n?H:j):"("==e?D(z(")"),Y,G(")"),U,r):"operator"==e||"spread"==e?D(n?H:j):"["==e?D(z("]"),et,U,r):"{"==e?ue(ae,"}",null,r):"quasi"==e?I(K,r):"new"==e?D(ne(n)):D()}function Y(e){return e.match(/[;\}\)\],]/)?I():I(j)}function Z(e,t){return","==e?D(Y):X(e,t,!1)}function X(e,t,n){var i=0==n?Z:X,r=0==n?j:H;if("=>"==e)return D(B,n?te:ee,F);if("operator"==e)return/\+\+|--/.test(t)||d&&"!"==t?D(i):d&&"<"==t&&L.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?D(z(">"),de(ve,">"),U,i):"?"==t?D(j,G(":"),r):D(r);if("quasi"==e)return I(K,i);if(";"!=e){if("("==e)return ue(H,")","call",i);if("."==e)return D(oe,i);if("["==e)return D(z("]"),Y,G("]"),U,i);if(d&&"as"==t)return L.marked="keyword",D(ve,i);if("regexp"==e)return L.state.lastType=L.marked="operator",L.stream.backUp(L.stream.pos-L.stream.start-1),D(r)}}function K(e,t){return"quasi"!=e?I():"${"!=t.slice(t.length-2)?D(K):D(Y,Q)}function Q(e){if("}"==e)return L.marked="string-2",L.state.tokenize=S,D(K)}function ee(e){return x(L.stream,L.state),I("{"==e?W:j)}function te(e){return x(L.stream,L.state),I("{"==e?W:H)}function ne(e){return function(t){return"."==t?D(e?re:ie):"variable"==t&&d?D(Te,e?X:Z):I(e?H:j)}}function ie(e,t){if("target"==t)return L.marked="keyword",D(Z)}function re(e,t){if("target"==t)return L.marked="keyword",D(X)}function se(e){return":"==e?D(U,W):I(Z,G(";"),U)}function oe(e){if("variable"==e)return L.marked="property",D()}function ae(e,t){return"async"==e?(L.marked="property",D(ae)):"variable"==e||"keyword"==L.style?(L.marked="property","get"==t||"set"==t?D(le):(d&&L.state.fatArrowAt==L.stream.start&&(n=L.stream.match(/^\s*:\s*/,!1))&&(L.state.fatArrowAt=L.stream.pos+n[0].length),D(ce))):"number"==e||"string"==e?(L.marked=a?"property":L.style+" property",D(ce)):"jsonld-keyword"==e?D(ce):d&&R(t)?(L.marked="keyword",D(ae)):"["==e?D(j,pe,G("]"),ce):"spread"==e?D(H,ce):"*"==t?(L.marked="keyword",D(ae)):":"==e?I(ce):void 0;var n}function le(e){return"variable"!=e?I(ce):(L.marked="property",D(_e))}function ce(e){return":"==e?D(H):"("==e?I(_e):void 0}function de(e,t,n){function i(r,s){if(n?n.indexOf(r)>-1:","==r){var o=L.state.lexical;return"call"==o.info&&(o.pos=(o.pos||0)+1),D((function(n,i){return n==t||i==t?I():I(e)}),i)}return r==t||s==t?D():n&&n.indexOf(";")>-1?I(e):D(G(t))}return function(n,r){return n==t||r==t?D():I(e,i)}}function ue(e,t,n){for(var i=3;i<arguments.length;i++)L.cc.push(arguments[i]);return D(z(t,n),de(e,t),U)}function he(e){return"}"==e?D():I(W,he)}function pe(e,t){if(d){if(":"==e)return D(ve);if("?"==t)return D(pe)}}function fe(e,t){if(d&&(":"==e||"in"==t))return D(ve)}function ge(e){if(d&&":"==e)return L.stream.match(/^\s*\w+\s+is\b/,!1)?D(j,me,ve):D(ve)}function me(e,t){if("is"==t)return L.marked="keyword",D()}function ve(e,t){return"keyof"==t||"typeof"==t||"infer"==t||"readonly"==t?(L.marked="keyword",D("typeof"==t?H:ve)):"variable"==e||"void"==t?(L.marked="type",D(ke)):"|"==t||"&"==t?D(ve):"string"==e||"number"==e||"atom"==e?D(ke):"["==e?D(z("]"),de(ve,"]",","),U,ke):"{"==e?D(z("}"),be,U,ke):"("==e?D(de(Ce,")"),ye,ke):"<"==e?D(de(ve,">"),ve):"quasi"==e?I(we,ke):void 0}function ye(e){if("=>"==e)return D(ve)}function be(e){return e.match(/[\}\)\]]/)?D():","==e||";"==e?D(be):I(Se,be)}function Se(e,t){return"variable"==e||"keyword"==L.style?(L.marked="property",D(Se)):"?"==t||"number"==e||"string"==e?D(Se):":"==e?D(ve):"["==e?D(G("variable"),fe,G("]"),Se):"("==e?I(Fe,Se):e.match(/[;\}\)\],]/)?void 0:D()}function we(e,t){return"quasi"!=e?I():"${"!=t.slice(t.length-2)?D(we):D(ve,xe)}function xe(e){if("}"==e)return L.marked="string-2",L.state.tokenize=S,D(we)}function Ce(e,t){return"variable"==e&&L.stream.match(/^\s*[?:]/,!1)||"?"==t?D(Ce):":"==e?D(ve):"spread"==e?D(Ce):I(ve)}function ke(e,t){return"<"==t?D(z(">"),de(ve,">"),U,ke):"|"==t||"."==e||"&"==t?D(ve):"["==e?D(ve,G("]"),ke):"extends"==t||"implements"==t?(L.marked="keyword",D(ve)):"?"==t?D(ve,G(":"),ve):void 0}function Te(e,t){if("<"==t)return D(z(">"),de(ve,">"),U,ke)}function Ee(){return I(ve,Le)}function Le(e,t){if("="==t)return D(ve)}function Ie(e,t){return"enum"==t?(L.marked="keyword",D(tt)):I(De,pe,Ae,Re)}function De(e,t){return d&&R(t)?(L.marked="keyword",D(De)):"variable"==e?(P(t),D()):"spread"==e?D(De):"["==e?ue(Pe,"]"):"{"==e?ue(Me,"}"):void 0}function Me(e,t){return"variable"!=e||L.stream.match(/^\s*:/,!1)?("variable"==e&&(L.marked="property"),"spread"==e?D(De):"}"==e?I():"["==e?D(j,G("]"),G(":"),Me):D(G(":"),De,Ae)):(P(t),D(Ae))}function Pe(){return I(De,Ae)}function Ae(e,t){if("="==t)return D(H)}function Re(e){if(","==e)return D(Ie)}function Ne(e,t){if("keyword b"==e&&"else"==t)return D(z("form","else"),W,U)}function Ve(e,t){return"await"==t?D(Ve):"("==e?D(z(")"),Oe,U):void 0}function Oe(e){return"var"==e?D(Ie,Be):"variable"==e?D(Be):I(Be)}function Be(e,t){return")"==e?D():";"==e?D(Be):"in"==t||"of"==t?(L.marked="keyword",D(j,Be)):I(j,Be)}function _e(e,t){return"*"==t?(L.marked="keyword",D(_e)):"variable"==e?(P(t),D(_e)):"("==e?D(B,z(")"),de(Ue,")"),U,ge,W,F):d&&"<"==t?D(z(">"),de(Ee,">"),U,_e):void 0}function Fe(e,t){return"*"==t?(L.marked="keyword",D(Fe)):"variable"==e?(P(t),D(Fe)):"("==e?D(B,z(")"),de(Ue,")"),U,ge,F):d&&"<"==t?D(z(">"),de(Ee,">"),U,Fe):void 0}function ze(e,t){return"keyword"==e||"variable"==e?(L.marked="type",D(ze)):"<"==t?D(z(">"),de(Ee,">"),U):void 0}function Ue(e,t){return"@"==t&&D(j,Ue),"spread"==e?D(Ue):d&&R(t)?(L.marked="keyword",D(Ue)):d&&"this"==e?D(pe,Ae):I(De,pe,Ae)}function Ge(e,t){return"variable"==e?We(e,t):$e(e,t)}function We(e,t){if("variable"==e)return P(t),D($e)}function $e(e,t){return"<"==t?D(z(">"),de(Ee,">"),U,$e):"extends"==t||"implements"==t||d&&","==e?("implements"==t&&(L.marked="keyword"),D(d?ve:j,$e)):"{"==e?D(z("}"),je,U):void 0}function je(e,t){return"async"==e||"variable"==e&&("static"==t||"get"==t||"set"==t||d&&R(t))&&L.stream.match(/^\s+#?[\w$\xa1-\uffff]/,!1)?(L.marked="keyword",D(je)):"variable"==e||"keyword"==L.style?(L.marked="property",D(He,je)):"number"==e||"string"==e?D(He,je):"["==e?D(j,pe,G("]"),He,je):"*"==t?(L.marked="keyword",D(je)):d&&"("==e?I(Fe,je):";"==e||","==e?D(je):"}"==e?D():"@"==t?D(j,je):void 0}function He(e,t){if("!"==t||"?"==t)return D(He);if(":"==e)return D(ve,Ae);if("="==t)return D(H);var n=L.state.lexical.prev;return I(n&&"interface"==n.info?Fe:_e)}function Je(e,t){return"*"==t?(L.marked="keyword",D(Qe,G(";"))):"default"==t?(L.marked="keyword",D(j,G(";"))):"{"==e?D(de(qe,"}"),Qe,G(";")):I(W)}function qe(e,t){return"as"==t?(L.marked="keyword",D(G("variable"))):"variable"==e?I(H,qe):void 0}function Ye(e){return"string"==e?D():"("==e?I(j):"."==e?I(Z):I(Ze,Xe,Qe)}function Ze(e,t){return"{"==e?ue(Ze,"}"):("variable"==e&&P(t),"*"==t&&(L.marked="keyword"),D(Ke))}function Xe(e){if(","==e)return D(Ze,Xe)}function Ke(e,t){if("as"==t)return L.marked="keyword",D(Ze)}function Qe(e,t){if("from"==t)return L.marked="keyword",D(j)}function et(e){return"]"==e?D():I(de(H,"]"))}function tt(){return I(z("form"),De,G("{"),z("}"),de(nt,"}"),U,U)}function nt(){return I(De,Ae)}function it(e,t){return"operator"==e.lastType||","==e.lastType||p.test(t.charAt(0))||/[,.]/.test(t.charAt(0))}function rt(e,t,n){return t.tokenize==v&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(t.lastType)||"quasi"==t.lastType&&/\{\s*$/.test(e.string.slice(0,e.pos-(n||0)))}return B.lex=_.lex=!0,F.lex=!0,U.lex=!0,{startState:function(e){var t={tokenize:v,lastType:"sof",cc:[],lexical:new k((e||0)-s,0,"block",!1),localVars:n.localVars,context:n.localVars&&new N(null,null,!1),indented:e||0};return n.globalVars&&"object"==typeof n.globalVars&&(t.globalVars=n.globalVars),t},token:function(e,t){if(e.sol()&&(t.lexical.hasOwnProperty("align")||(t.lexical.align=!1),t.indented=e.indentation(),x(e,t)),t.tokenize!=b&&e.eatSpace())return null;var n=t.tokenize(e,t);return"comment"==i?n:(t.lastType="operator"!=i||"++"!=r&&"--"!=r?i:"incdec",E(t,n,i,r,e))},indent:function(t,i){if(t.tokenize==b||t.tokenize==S)return e.Pass;if(t.tokenize!=v)return 0;var r,a=i&&i.charAt(0),l=t.lexical;if(!/^\s*else\b/.test(i))for(var c=t.cc.length-1;c>=0;--c){var d=t.cc[c];if(d==U)l=l.prev;else if(d!=Ne&&d!=F)break}for(;("stat"==l.type||"form"==l.type)&&("}"==a||(r=t.cc[t.cc.length-1])&&(r==Z||r==X)&&!/^[,\.=+\-*:?[\(]/.test(i));)l=l.prev;o&&")"==l.type&&"stat"==l.prev.type&&(l=l.prev);var u=l.type,h=a==u;return"vardef"==u?l.indented+("operator"==t.lastType||","==t.lastType?l.info.length+1:0):"form"==u&&"{"==a?l.indented:"form"==u?l.indented+s:"stat"==u?l.indented+(it(t,i)?o||s:0):"switch"!=l.info||h||0==n.doubleIndentSwitch?l.align?l.column+(h?0:1):l.indented+(h?0:s):l.indented+(/^(?:case|default)\b/.test(i)?s:2*s)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:l?null:"/*",blockCommentEnd:l?null:"*/",blockCommentContinue:l?null:" * ",lineComment:l?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:l?"json":"javascript",jsonldMode:a,jsonMode:l,expressionAllowed:rt,skipExpression:function(t){E(t,"atom","atom","true",new e.StringStream("",2,null))}}})),e.registerHelper("wordChars","javascript",/[\w$]/),e.defineMIME("text/javascript","javascript"),e.defineMIME("text/ecmascript","javascript"),e.defineMIME("application/javascript","javascript"),e.defineMIME("application/x-javascript","javascript"),e.defineMIME("application/ecmascript","javascript"),e.defineMIME("application/json",{name:"javascript",json:!0}),e.defineMIME("application/x-json",{name:"javascript",json:!0}),e.defineMIME("application/manifest+json",{name:"javascript",json:!0}),e.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),e.defineMIME("text/typescript",{name:"javascript",typescript:!0}),e.defineMIME("application/typescript",{name:"javascript",typescript:!0})}();!function(e){function t(t,i,s,o){if(s&&s.call){var a=s;s=null}else a=r(t,s,"rangeFinder");"number"==typeof i&&(i=e.Pos(i,0));var l=r(t,s,"minFoldSize");function c(e){var n=a(t,i);if(!n||n.to.line-n.from.line<l)return null;if("fold"===o)return n;for(var r=t.findMarksAt(n.from),s=0;s<r.length;++s)if(r[s].__isFold){if(!e)return null;n.cleared=!0,r[s].clear()}return n}var d=c(!0);if(r(t,s,"scanUp"))for(;!d&&i.line>t.firstLine();)i=e.Pos(i.line-1,0),d=c(!1);if(d&&!d.cleared&&"unfold"!==o){var u=n(t,s,d);e.on(u,"mousedown",(function(t){h.clear(),e.e_preventDefault(t)}));var h=t.markText(d.from,d.to,{replacedWith:u,clearOnEnter:r(t,s,"clearOnEnter"),__isFold:!0});h.on("clear",(function(n,i){e.signal(t,"unfold",t,n,i)})),e.signal(t,"fold",t,d.from,d.to)}}function n(e,t,n){var i=r(e,t,"widget");if("function"==typeof i&&(i=i(n.from,n.to)),"string"==typeof i){var s=document.createTextNode(i);(i=document.createElement("span")).appendChild(s),i.className="CodeMirror-foldmarker"}else i&&(i=i.cloneNode(!0));return i}e.newFoldFunction=function(e,n){return function(i,r){t(i,r,{rangeFinder:e,widget:n})}},e.defineExtension("foldCode",(function(e,n,i){t(this,e,n,i)})),e.defineExtension("isFolded",(function(e){for(var t=this.findMarksAt(e),n=0;n<t.length;++n)if(t[n].__isFold)return!0})),e.commands.toggleFold=function(e){e.foldCode(e.getCursor())},e.commands.fold=function(e){e.foldCode(e.getCursor(),null,"fold")},e.commands.unfold=function(e){e.foldCode(e.getCursor(),{scanUp:!1},"unfold")},e.commands.foldAll=function(t){t.operation((function(){for(var n=t.firstLine(),i=t.lastLine();n<=i;n++)t.foldCode(e.Pos(n,0),{scanUp:!1},"fold")}))},e.commands.unfoldAll=function(t){t.operation((function(){for(var n=t.firstLine(),i=t.lastLine();n<=i;n++)t.foldCode(e.Pos(n,0),{scanUp:!1},"unfold")}))},e.registerHelper("fold","combine",(function(){var e=Array.prototype.slice.call(arguments,0);return function(t,n){for(var i=0;i<e.length;++i){var r=e[i](t,n);if(r)return r}}})),e.registerHelper("fold","auto",(function(e,t){for(var n=e.getHelpers(t,"fold"),i=0;i<n.length;i++){var r=n[i](e,t);if(r)return r}}));var i={rangeFinder:e.fold.auto,widget:"\u2194",minFoldSize:0,scanUp:!1,clearOnEnter:!0};function r(e,t,n){if(t&&void 0!==t[n])return t[n];var r=e.options.foldOptions;return r&&void 0!==r[n]?r[n]:i[n]}e.defineOption("foldOptions",null),e.defineExtension("foldOption",(function(e,t){return r(this,e,t)}))}(Mk());!function(e){e.defineOption("foldGutter",!1,(function(t,r,s){s&&s!=e.Init&&(t.clearGutter(t.state.foldGutter.options.gutter),t.state.foldGutter=null,t.off("gutterClick",c),t.off("changes",u),t.off("viewportChange",h),t.off("fold",p),t.off("unfold",p),t.off("swapDoc",u),t.off("optionChange",d)),r&&(t.state.foldGutter=new n(i(r)),l(t),t.on("gutterClick",c),t.on("changes",u),t.on("viewportChange",h),t.on("fold",p),t.on("unfold",p),t.on("swapDoc",u),t.on("optionChange",d))}));var t=e.Pos;function n(e){this.options=e,this.from=this.to=0}function i(e){return!0===e&&(e={}),null==e.gutter&&(e.gutter="CodeMirror-foldgutter"),null==e.indicatorOpen&&(e.indicatorOpen="CodeMirror-foldgutter-open"),null==e.indicatorFolded&&(e.indicatorFolded="CodeMirror-foldgutter-folded"),e}function r(e,n){for(var i=e.findMarks(t(n,0),t(n+1,0)),r=0;r<i.length;++r)if(i[r].__isFold){var s=i[r].find(-1);if(s&&s.line===n)return i[r]}}function s(e){if("string"==typeof e){var t=document.createElement("div");return t.className=e+" CodeMirror-guttermarker-subtle",t}return e.cloneNode(!0)}function o(e,n,i){var o=e.state.foldGutter.options,l=n-1,c=e.foldOption(o,"minFoldSize"),d=e.foldOption(o,"rangeFinder"),u="string"==typeof o.indicatorFolded&&a(o.indicatorFolded),h="string"==typeof o.indicatorOpen&&a(o.indicatorOpen);e.eachLine(n,i,(function(n){++l;var i=null,a=n.gutterMarkers;if(a&&(a=a[o.gutter]),r(e,l)){if(u&&a&&u.test(a.className))return;i=s(o.indicatorFolded)}else{var p=t(l,0),f=d&&d(e,p);if(f&&f.to.line-f.from.line>=c){if(h&&a&&h.test(a.className))return;i=s(o.indicatorOpen)}}!i&&!a||e.setGutterMarker(n,o.gutter,i)}))}function a(e){return new RegExp("(^|\\s)"+e+"(?:$|\\s)\\s*")}function l(e){var t=e.getViewport(),n=e.state.foldGutter;n&&(e.operation((function(){o(e,t.from,t.to)})),n.from=t.from,n.to=t.to)}function c(e,n,i){var s=e.state.foldGutter;if(s){var o=s.options;if(i==o.gutter){var a=r(e,n);a?a.clear():e.foldCode(t(n,0),o)}}}function d(e,t){"mode"==t&&u(e)}function u(e){var t=e.state.foldGutter;if(t){var n=t.options;t.from=t.to=0,clearTimeout(t.changeUpdate),t.changeUpdate=setTimeout((function(){l(e)}),n.foldOnChangeTimeSpan||600)}}function h(e){var t=e.state.foldGutter;if(t){var n=t.options;clearTimeout(t.changeUpdate),t.changeUpdate=setTimeout((function(){var n=e.getViewport();t.from==t.to||n.from-t.to>20||t.from-n.to>20?l(e):e.operation((function(){n.from<t.from&&(o(e,n.from,t.from),t.from=n.from),n.to>t.to&&(o(e,t.to,n.to),t.to=n.to)}))}),n.updateViewportTimeSpan||400)}}function p(e,t){var n=e.state.foldGutter;if(n){var i=t.line;i>=n.from&&i<n.to&&o(e,i,i+1)}}}(Mk()),function(e){function t(t){return function(n,i){var r=i.line,s=n.getLine(r);function o(t){for(var o,a=i.ch,l=0;;){var c=a<=0?-1:s.lastIndexOf(t[0],a-1);if(-1!=c){if(1==l&&c<i.ch)break;if(o=n.getTokenTypeAt(e.Pos(r,c+1)),!/^(comment|string)/.test(o))return{ch:c+1,tokenType:o,pair:t};a=c-1}else{if(1==l)break;l=1,a=s.length}}}function a(t){var i,s,o=1,a=n.lastLine(),l=t.ch;e:for(var c=r;c<=a;++c)for(var d=n.getLine(c),u=c==r?l:0;;){var h=d.indexOf(t.pair[0],u),p=d.indexOf(t.pair[1],u);if(h<0&&(h=d.length),p<0&&(p=d.length),(u=Math.min(h,p))==d.length)break;if(n.getTokenTypeAt(e.Pos(c,u+1))==t.tokenType)if(u==h)++o;else if(! --o){i=c,s=u;break e}++u}return null==i||r==i?null:{from:e.Pos(r,l),to:e.Pos(i,s)}}for(var l=[],c=0;c<t.length;c++){var d=o(t[c]);d&&l.push(d)}for(l.sort((function(e,t){return e.ch-t.ch})),c=0;c<l.length;c++){var u=a(l[c]);if(u)return u}return null}}e.registerHelper("fold","brace",t([["{","}"],["[","]"]])),e.registerHelper("fold","brace-paren",t([["{","}"],["[","]"],["(",")"]])),e.registerHelper("fold","import",(function(t,n){function i(n){if(n<t.firstLine()||n>t.lastLine())return null;var i=t.getTokenAt(e.Pos(n,1));if(/\S/.test(i.string)||(i=t.getTokenAt(e.Pos(n,i.end+1))),"keyword"!=i.type||"import"!=i.string)return null;for(var r=n,s=Math.min(t.lastLine(),n+10);r<=s;++r){var o=t.getLine(r).indexOf(";");if(-1!=o)return{startCh:i.end,end:e.Pos(r,o)}}}var r,s=n.line,o=i(s);if(!o||i(s-1)||(r=i(s-2))&&r.end.line==s-1)return null;for(var a=o.end;;){var l=i(a.line+1);if(null==l)break;a=l.end}return{from:t.clipPos(e.Pos(s,o.startCh+1)),to:a}})),e.registerHelper("fold","include",(function(t,n){function i(n){if(n<t.firstLine()||n>t.lastLine())return null;var i=t.getTokenAt(e.Pos(n,1));return/\S/.test(i.string)||(i=t.getTokenAt(e.Pos(n,i.end+1))),"meta"==i.type&&"#include"==i.string.slice(0,8)?i.start+8:void 0}var r=n.line,s=i(r);if(null==s||null!=i(r-1))return null;for(var o=r;null!=i(o+1);)++o;return{from:e.Pos(r,s+1),to:t.clipPos(e.Pos(o))}}))}(Mk());var Pk=Mk();const Ak=(0,i.g)(Pk);class Rk extends mk{constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=mn((()=>{const e=this.textEditor.getValue();try{const t=JSON.parse(e);this.parsedValue=t,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(t){this.parsedValue=null,this.applyButton.disabled=!0;let n=0,i=0,r="Unknown parse error";if(t instanceof Error){const s=t.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(null!==s){r=s[1];const t=parseInt(s[2],10),o=e.substring(0,t).split("\n");n=o.length-1,i=o[o.length-1].length}else r=t.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:r,severity:"error",from:Ak.Pos(n,i)}]})}}),100),this.content.classList.add("neuroglancer-state-editor");const t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",(()=>this.applyChanges())),t.disabled=!0;const n=this.closeButton=document.createElement("button");n.classList.add("close-button"),n.textContent="Close",this.content.appendChild(n),n.addEventListener("click",(()=>this.dispose()));const i=this.downloadButton=document.createElement("button");i.textContent="Download",i.title="Download state as a JSON file",this.content.appendChild(i),i.addEventListener("click",(()=>this.downloadState())),this.textEditor=Ak((e=>{}),{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",(()=>{this.debouncedValueUpdater()})),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){const e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),n=URL.createObjectURL(t);e.href=n,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){null!==this.parsedValue&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return Bt(Vg(this.viewer.state).value,null,"  ")}}var Nk=function(e){return e&&e.__esModule?e:{default:e}}(Lt);var Vk=function(e){return Array.isArray(e)?e:(0,Nk.default)(e)};const Ok={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class Bk{constructor(){this.location=new jv(Ok)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return ps(this.location.toJSON())}}function _k(e){const t=new pt;return function e(n,i){if("object"==typeof n)for(const t of f(n))e(n[t],i+"."+t);else t.set(i,""+n)}(e,""),t}function Fk(e){const t=e.map(_k),n=function(e){const t=new Rt;t.add(".type");const n=new Rt;function i(n,i){for(const r of t)if(e[n].get(r)!==e[i].get(r))return!0;return!1}for(let r=0,s=e.length;r<s;++r){for(const t of e[r].keys())n.add(t);let s=[];for(let e=0;e<r;++e)i(r,e)||s.push(e);for(;s.length>0;){let i,o=s;for(const a of n){if(t.has(a))continue;const n=[];for(const t of s)e[t].get(a)===e[r].get(a)&&n.push(t);if(n.length<o.length&&(o=n,i=a),0===n.length)break}if(void 0===i)break;s=o,t.add(i)}}return It(t)}(t);return t.map((e=>function(e,t){const n={};for(const i of t){const t=e.get(i);if(void 0!==t){if(""===i)return t;n[i]=t}}return Bt(n)}(e,n)))}const zk=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:e=>{let t=0;for(let n=0;n<8;++n)t+=e[3*rl(n,tl.VISIBLE)+il.numChunks];return t}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:e=>e[3*rl(el.DOWNLOADING,tl.VISIBLE)+il.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:e=>e[3*rl(el.SYSTEM_MEMORY,tl.VISIBLE)+il.numChunks]+e[3*rl(el.SYSTEM_MEMORY_WORKER,tl.VISIBLE)+il.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:e=>e[3*rl(el.GPU_MEMORY,tl.VISIBLE)+il.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:e=>e[3*rl(el.FAILED,tl.VISIBLE)+il.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:e=>e[3*rl(el.GPU_MEMORY,tl.VISIBLE)+il.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:e=>e[sl(nl.totalTime)]/e[sl(nl.totalChunks)]}];class Uk extends sy{constructor(e,t,n){super(e,n.location),this.chunkQueueManager=t,this.displayState=n,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable(mn((()=>this.updateView()),0));const i=this.body;i.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(i),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;const e=this.chunkQueueManager;this.dataRequested=!0,e.getStatistics().then((e=>{this.dataRequested=!1,this.data=e,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout((()=>{this.requestDataTimerId=-1,this.requestData()}),1e3)}))}updateView(){const e=this.data;if(void 0===e)return;const t=document.createElement("table"),n=[];for(const i of e){var r=O(i,2);const e=r[0],t=r[1],s=[e];for(const n of zk){const e=n.getter;s.push(e(t))}n.push(s)}const s=Fk(n.map((e=>function(e){return(0,i.bn)({type:e.RPC_TYPE_ID},e.key||{})}(e[0])))),o=new pt;s.forEach(((e,t)=>{o.set(n[t][0],e)}));{const e=document.createElement("thead");let n=document.createElement("tr");e.appendChild(n);const i=e=>{const t=document.createElement("td");t.textContent=e,n.appendChild(t)};let r;i("Name");for(const t of zk){const e=t.label,s=e.indexOf("/");let o=e;if(-1!==s){if(o=e.substring(0,s),o===r){++n.lastElementChild.colSpan;continue}r=o}i(o)}n=document.createElement("tr"),e.appendChild(n);{const e=document.createElement("td");n.appendChild(e)}for(const t of zk){const e=t.label,i=e.indexOf("/");let r="";-1!==i&&(r=e.substring(i+1));const s=document.createElement("td");s.textContent=r,n.appendChild(s)}t.appendChild(e)}const a=document.createElement("tbody");for(const i of n){var l=Vk(i);const e=l[0],t=l.slice(1),n=document.createElement("tr"),r=e=>{const t=document.createElement("td");t.textContent=e,n.appendChild(t)};r(o.get(e));for(const i of t)r(""+i);a.appendChild(n)}t.appendChild(a),Rv(this.body),this.body.appendChild(t)}}class Gk extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>ii(1,0,0);super(),this.model=e,this.getDefaultColor=t,this.element=document.createElement("input");const n=this.element;n.classList.add("neuroglancer-color-widget"),n.type="color",n.addEventListener("change",(()=>this.updateModel())),n.addEventListener("input",(()=>this.updateModel())),n.addEventListener("wheel",(e=>{e.stopPropagation(),e.preventDefault(),this.adjustHueViaWheel(e)})),this.registerDisposer(e.changed.add((()=>this.updateView()))),this.updateView()}getRGB(){var e;return null!==(e=this.model.value)&&void 0!==e?e:this.getDefaultColor()}updateView(){this.element.value=Ki(this.getRGB())}updateModel(){this.model.value=qi(this.element.value)}adjustHueViaWheel(e){const t=this.getRGB(),n=ti();!function(e,t,n,i){const r=Math.max(Math.max(t,n),i),s=Math.min(Math.min(t,n),i);if(e[2]=r,s===r)e[0]=0,e[1]=0;else{const o=r-s;e[1]=o/r,e[0]=t===r?(n-i)/o:n===r?2+(i-t)/o:4+(t-n)/o,e[0]/=6,e[0]<0&&(e[0]+=1),e[0]>1&&(e[0]-=1)}}(n,t[0],t[1],t[2]);const i=e.deltaY;let r=Math.round(256*n[0]);r+=i>0?1:i<0?-1:0,r=(r+256)%256,n[0]=r/256,rv(n,n[0],n[1],n[2]),this.model.value=n}}class Wk extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let n=t.validator,i=t.label;const r=this.element,s=this.inputElement;void 0===n&&(n=e instanceof Ln?e.validator:e=>e),this.validator=n,void 0!==i&&(r.textContent=i),r.appendChild(s),r.className="neuroglancer-number-input",s.type="text",this.registerDisposer(this.model.changed.add((()=>this.updateView()))),this.registerEventListener(s,"change",(()=>this.updateModel())),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Cr(e))this.updateView();else try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){Nv(this.element),super.disposed()}}class $k extends Sn{constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add((()=>this.updateView())));const t=this.element;t.type="text",this.registerEventListener(t,"change",(()=>this.updateModel())),this.updateView()}disposed(){Nv(this.element)}updateView(){var e;this.element.value=(null!==(e=this.model.value)&&void 0!==e?e:"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}const jk=(0,i.bn)((0,i.bn)({},$v),{side:"left",row:2});class Hk{constructor(){this.location=new jv(jk)}get changed(){return this.location.changed}toJSON(){return ps(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class Jk extends sy{constructor(e,t,n){super(e,t.location),this.addTitleBar({title:"Settings"});const i=document.createElement("div");i.classList.add("neuroglancer-settings-body");let r=document.createElement("div");r.classList.add("neuroglancer-settings-scroll-container"),i.appendChild(r),this.addBody(i);{const e=this.registerDisposer(new $k(n.title));e.element.placeholder="Title",e.element.classList.add("neuroglancer-settings-title"),r.appendChild(e.element)}const s=(e,t)=>{const n=this.registerDisposer(new Wk(t,{label:e}));n.element.classList.add("neuroglancer-settings-limit-widget"),r.appendChild(n.element)};s("GPU memory limit",n.chunkQueueManager.capacities.gpuMemory.sizeLimit),s("System memory limit",n.chunkQueueManager.capacities.systemMemory.sizeLimit),s("Concurrent chunk requests",n.chunkQueueManager.capacities.download.itemLimit);const o=(e,t)=>{const n=document.createElement("label");n.textContent=e;const i=this.registerDisposer(new Od(t));n.appendChild(i.element),r.appendChild(n)};o("Show axis lines",n.showAxisLines),o("Show scale bar",n.showScaleBar),o("Show cross sections in 3-d",n.showPerspectiveSliceViews),o("Show default annotations",n.showDefaultAnnotations),o("Show chunk statistics",n.statisticsDisplayState.location.watchableVisible),o("Wire frame rendering",n.wireFrame),o("Enable prefetching",n.chunkQueueManager.enablePrefetch);const a=(e,t)=>{const n=document.createElement("label");n.textContent=e;const i=this.registerDisposer(new Gk(t));n.appendChild(i.element),r.appendChild(n)};a("Cross-section background",n.crossSectionBackgroundColor),a("Projection background",n.perspectiveViewBackgroundColor)}}class qk extends Sn{constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable(al((()=>{let e=this.viewContext;void 0!==e&&(this.unregisterDisposer(e),e.dispose()),this.viewContext=e=this.registerDisposer(new Sn),Rv(this.element);const t=this.selectedTool;void 0!==t&&this.element.appendChild(this.makeWidget(e,t));const n=It(this.toolBinder.bindings);n.sort(((e,t)=>{let[n]=e,[i]=t;return Kp(n,i)}));for(const i of n){const t=O(i,2)[1];this.element.appendChild(this.makeWidget(e,t))}})));this.element.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add((()=>this.selectedLayerChanged()))),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){const e=this.selectedLayer.layer;if(void 0===e)return;const t=e.layer;return null!==t?t.tool.value:void 0}selectedLayerChanged(){let e=this.unbindPreviousLayer;void 0!==e&&e();const t=this.selectedLayer.layer;void 0!==t&&(this.unbindPreviousLayer=t.specificationChanged.add((()=>{this.updateView()}))),this.updateView()}disposed(){const e=this.unbindPreviousLayer;void 0!==e&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){const n=document.createElement("div");n.title="dblclick \u2192 unbind",t instanceof JS&&(n.title+=", click \u2192 bind key"),n.className="neuroglancer-annotation-tool-status-widget";const i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-layer-number";const r=t.layer.managedLayer;r.manager.rootLayers.updateNonArchivedLayerIndices();const s=r.nonArchivedLayerIndex;i.textContent=(s+1).toString();const o=document.createElement("div");if(o.className="neuroglancer-annotation-tool-status-widget-description",o.textContent=t.description,n.addEventListener("dblclick",(()=>{t instanceof qS?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)})),t instanceof JS){const i=document.createElement("div");i.className="neuroglancer-annotation-tool-status-widget-key",i.textContent=t.keyBinding,n.appendChild(i),sw(e,n,(e=>t.layer.toolBinder.set(e,t.addRef())))}return n.appendChild(i),n.appendChild(o),n}}function Yk(e){return encodeURI(e).replace(/[!'()*;,]/g,(function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}))}const Zk=Object.freeze(Object.defineProperty({__proto__:null,UrlHashBinding:class extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.root=e,this.credentialsManager=t,this.parseError=new En(void 0);var i=n.updateDelayMilliseconds;const r=void 0===i?200:i;var s=n.defaultFragment;const o=void 0===s?"{}":s;this.registerEventListener(window,"hashchange",(()=>this.updateFromUrlHash()));const a=mn((()=>this.setUrlHash()),r);this.registerDisposer(e.changed.add(a)),this.registerDisposer((()=>a.cancel())),this.defaultFragment=o}setUrlHash(){const e=Vg(this.root);if(e.generation!==this.prevStateGeneration){this.prevStateGeneration=e.generation;let t=Yk(Bt(e.value));t!==this.prevStateString&&(this.prevStateString=t,"{}"===decodeURIComponent(t)?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+t))}}updateFromUrlHash(){try{let t=location.href.replace(/^[^#]+/,"");if((""===t||"#"===t||"#!"===t)&&(t="#!"+this.defaultFragment),t.match(/^#!([a-z][a-z\d+-.]*):\/\//)){const n=t.substring(2);var e=sC(n,this.credentialsManager);const i=e.url,r=e.credentialsProvider;Bp.forPromise(oC(r,i,{},Hx).then((e=>{Yr(e),this.root.reset(),this.root.restoreState(e)})),{initialMessage:`Loading state from ${n}`,errorPrefix:"Error loading state:"})}else if(t.startsWith("#!+")){t=t.slice(3),t=decodeURIComponent(t);let e=$r(t);Yr(e),this.root.restoreState(e),this.prevStateString=void 0}else{if(!t.startsWith("#!"))throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');{if(t=t.slice(2),t=decodeURIComponent(t),t===this.prevStateString)return;this.prevStateString=t,this.root.reset();let e=$r(t);Yr(e),this.root.restoreState(e)}}this.parseError.value=void 0}catch(t){this.parseError.value=t}}},encodeFragment:Yk},Symbol.toStringTag,{value:"Module"}));class Xk extends Sn{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";super(),this.gl=e,this.frameNumberCounter=t;const i=n+"chunk_worker.bundle.js";this.worker="string"==typeof n?new Worker(i):n,this.chunkQueueManager=this.registerDisposer(new sp(new fd(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new rp({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new rp({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new rp({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new rp({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer((()=>this.worker.terminate())),this.chunkManager=this.registerDisposer(new ap(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}}const Kk=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],Qk=[...Kk,"showLayerPanel","showLayerHoverValues"],eT=[...Qk,"showUIControls","showPanelBorders"];const tT=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS<"u"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class nT extends Rg{constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer)}restoreState(e){const t=this.viewer;super.restoreState(e),is(e,"navigation",(e=>{Yr(e),is(e,"pose",(e=>{Yr(e),is(e,"position",(e=>{Yr(e),Ag(e,"voxelCoordinates",t.position),is(e,"voxelSize",(e=>{const n=qr(new Float64Array(3),e,Lr);for(let t=0;t<3;++t)n[t]*=1e-9;t.coordinateSpace.value=ia({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:n})}))})),Ag(e,"orientation",t.crossSectionOrientation)})),Ag(e,"zoomFactor",t.crossSectionScale.legacyJsonView)})),Ag(e,"perspectiveOrientation",t.projectionOrientation),Ag(e,"perspectiveZoom",t.projectionScale.legacyJsonView),Ag(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}const iT={expectingExternalUI:!1};class rT extends Sn{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.display=e,this.title=new Ln(void 0,es),this.coordinateSpace=new ca,this.position=this.registerDisposer(new jg(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new Kg(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new im(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new nm(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new Zg),this.crossSectionScale=this.registerDisposer(new cm(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new Zg),this.crossSectionDepthRange=this.registerDisposer(new um(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new um(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new dm(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new pm(new sm(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new pm(new sm(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new mT,this.layerManager=this.registerDisposer(new gT),this.selectedLayer=this.registerDisposer(new TT(this.layerManager.addRef())),this.showAxisLines=new Vd(!0,!0),this.wireFrame=new Vd(!1,!1),this.showScaleBar=new Vd(!0,!0),this.showPerspectiveSliceViews=new Vd(!0,!0),this.visibleLayerRoles=new Vn([Ld.DATA,Ld.ANNOTATION,Ld.DEFAULT_ANNOTATION]),this.showDefaultAnnotations=new Vd(!0,!0),this.crossSectionBackgroundColor=new nr(ii(.5,.5,.5)),this.perspectiveViewBackgroundColor=new nr(ii(0,0,0)),this.scaleBarOptions=new Yw,this.partialViewport=new gl,this.statisticsDisplayState=new Bk,this.helpPanelState=new hC,this.settingsPanelState=new Hk,this.layerSelectedValues=this.registerDisposer(new vT(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new ST(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new Ln("",es),this.layerListPanelState=new Ck,this.resetInitiated=new kn,this.makeUrlFromState=e=>iT.expectingExternalUI?"/#!"+Yk(Bt(e)):window.location.toString(),this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(e,t)=>{t.registerDisposer(this.inputEventBindings.sliceView.addParent(e,Number.POSITIVE_INFINITY)),t.registerDisposer(this.inputEventBindings.perspectiveView.addParent(e,Number.POSITIVE_INFINITY))},this.toolBinder=this.registerDisposer(new nw(this.toolInputEventMapBinder));var n=t.dataContext;const r=void 0===n?new Xk(e.gl,e,t.bundleRoot):n;var s=t.visibility;const o=void 0===s?new kd(kd.VISIBLE):s;var a=t.inputEventBindings;const l=void 0===a?{global:new yv,sliceView:new yv,perspectiveView:new yv}:a;var c=t.element;const d=void 0===c?e.makeCanvasOverlayElement():c;var u=t.dataSourceProvider;const h=void 0===u?function(e){const t=new ff(e.credentialsManager);for(const i of Ux){var n=O(i,2);const r=n[0],s=n[1];t.register(r,s(e))}return t}({credentialsManager:yw}):u;var p=t.uiConfiguration;const f=void 0===p?Object.fromEntries(eT.map((e=>[e,new Vd(!0)]))):p;this.visibility=o,this.inputEventBindings=l,this.element=d,this.dataSourceProvider=h,this.uiConfiguration=f,this.registerDisposer(Fn((e=>{this.display.applyWindowedViewportToElement(d,e)}),this.partialViewport)),this.registerDisposer((()=>Nv(this.element))),this.dataContext=this.registerDisposer(r),function(e,t){for(const n of eT){const i=t[n];void 0!==i&&(e[n].value=i)}}(f,t);const g=(0,i.bn)((0,i.bn)({},tT),t),m=g.resetStateWhenEmpty,v=g.showLayerDialog;for(const i of Qk)this.uiControlVisibility[i]=this.makeUiControlVisibilityState(i);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add((()=>{this.updateShowBorders()}))),this.showLayerDialog=v,this.resetStateWhenEmpty=m,this.layerSpecification=new NT(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.toolBinder),this.registerDisposer(e.updateStarted.add((()=>{this.onUpdateDisplay()}))),this.showDefaultAnnotations.changed.add((()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(Ld.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(Ld.DEFAULT_ANNOTATION)})),this.registerDisposer(this.navigationState.changed.add((()=>{this.handleNavigationStateChanged()})));const y=this.registerCancellable(mn((()=>{!this.wasDisposed&&0===this.layerManager.managedLayers.length&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!fk&&this.showLayerDialog&&this.visibility.visible&&ZT(this.layerSpecification,this.selectedLayer))})));this.layerManager.layersChanged.add(y),y(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add((()=>{this.layerSelectedValues.handleLayerChange()}))),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add((()=>{this.visible&&e.scheduleRedraw()}))),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(QC(d,this.navigationState.position)),this.state=new nT(this)}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}get expectingExternalUI(){return iT.expectingExternalUI}set expectingExternalUI(e){iT.expectingExternalUI=e}makeUiControlVisibilityState(e){const t=this.uiConfiguration.showUIControls,n=this.uiConfiguration[e];return this.registerDisposer(Dn(((e,t)=>e&&t),t,n))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){const e=this.element,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){const e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";const n=this.registerDisposer(new YC(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner));this.registerDisposer(new Bd(this.uiControlVisibility.showLocation,n.element)),t.appendChild(n.element);const i=this.registerDisposer(new ZC(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(i.element.style.flex="1",i.element.style.alignSelf="center",this.registerDisposer(new Bd(this.uiControlVisibility.showLocation,i.element)),t.appendChild(i.element),typeof NEUROGLANCER_CREDIT_LINK<"u"){let e=NEUROGLANCER_CREDIT_LINK;Array.isArray(e)||(e=[e]);for(const n of e){const e=n.url,i=n.text,r=document.createElement("a");r.style.marginRight="5px",r.href=e,r.textContent=i,r.style.fontFamily="sans-serif",r.style.color="yellow",r.target="_blank",t.appendChild(r)}}const r=this.registerDisposer(new qk(this.selectedLayer,this.toolBinder));if(t.appendChild(r.element),this.registerDisposer(new Bd(this.uiControlVisibility.showAnnotationToolStatus,r.element)),aC){const e=this.registerDisposer(new lC(this));t.appendChild(e.element)}{const e=this.layerListPanelState,n=this.registerDisposer(new cy(e.location.watchableVisible,{svg:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBhcmlhLWxhYmVsbGVkYnk9ImxheWVyc0ljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9ImxheWVyc0ljb25UaXRsZSI+TGF5ZXJzPC90aXRsZT4KICAgIDxwYXRoIGQ9Ik0xMiA0TDIwIDguMDAwMDRMMTIgMTJMNCA4LjAwMDA0TDEyIDRaIi8+CiAgICA8cGF0aCBkPSJNMjAgMTJMMTIgMTZMNCAxMiIvPgogICAgPHBhdGggZD0iTTIwIDE2TDEyIDIwTDQgMTYiLz4KPC9zdmc+",backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));n.element.insertAdjacentElement("afterbegin",this.registerDisposer(new Lk(this.layerManager)).element),this.registerDisposer(new Bd(this.uiControlVisibility.showLayerListPanelButton,n.element)),t.appendChild(n.element)}{const e=this.selectionDetailsState,n=this.registerDisposer(new cy(e.location.watchableVisible,{svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0ibGlzdEljb25UaXRsZSI+CiAgICA8dGl0bGUgaWQ9Imxpc3RJY29uVGl0bGUiLz4KICAgIAogICAgPHBhdGggZD0iTTEwIDdMMTggN00xMCAxMkwxOCAxMk0xMCAxN0wxOCAxNyIvPgogICAgPGxpbmUgeDE9IjciIHkxPSI3IiB4Mj0iNyIgeTI9IjciLz4KICAgIDxsaW5lIHgxPSI3IiB5MT0iMTIiIHgyPSI3IiB5Mj0iMTIiLz4KICAgIDxsaW5lIHgxPSI3IiB5MT0iMTciIHgyPSI3IiB5Mj0iMTciLz4KPC9zdmc+",backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new Bd(this.uiControlVisibility.showSelectionPanelButton,n.element)),t.appendChild(n.element)}{const e=this.selectedLayer,n=this.registerDisposer(new cy({get value(){return e.visible},set value(t){e.visible=t},changed:e.location.locationChanged},{svg:dw,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new Bd(this.uiControlVisibility.showLayerSidePanelButton,n.element)),t.appendChild(n.element)}{const e=Jv({text:"{}",title:"Edit JSON state"});this.registerEventListener(e,"click",(()=>{this.editJsonState()})),this.registerDisposer(new Bd(this.uiControlVisibility.showEditStateButton,e)),t.appendChild(e)}{const e=dy({title:"Copy view URL to clipboard",onClick:()=>{const e=ay(this.makeUrlFromState(this.state.toJSON()));Bp.showTemporaryMessage(e?"URL copied to clipboard":"Failed to copy URL to clipboard")}});t.appendChild(e)}{const e=this.helpPanelState,n=this.registerDisposer(new cy(e.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new Bd(this.uiControlVisibility.showHelpButton,n.element)),t.appendChild(n.element)}{const e=this.settingsPanelState,n=this.registerDisposer(new cy(e.location.watchableVisible,{svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0ic2V0dGluZ3NJY29uVGl0bGUiPgogICAgPHRpdGxlIGlkPSJzZXR0aW5nc0ljb25UaXRsZSI+U2V0dGluZ3M8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik01LjAzNTA2NDI5LDEyLjcwNTAzMzkgQzUuMDExODc0ODQsMTIuNDczMTY5NiA1LDEyLjIzNzk3MTYgNSwxMiBDNSwxMS43NjIwMjg0IDUuMDExODc0ODQsMTEuNTI2ODMwNCA1LjAzNTA2NDI5LDExLjI5NDk2NjEgTDMuMjA1NzcxMzcsOS4yMzIwNTA4MSBMNS4yMDU3NzEzNyw1Ljc2Nzk0OTE5IEw3LjkwNjk3MTMsNi4zMjA3MDkwNCBDOC4yODcyOTEyMyw2LjA0NjEzNDIgOC42OTYyOTI5OCw1LjgwODgyMjEyIDkuMTI4NjI1MzMsNS42MTQxMjQwMiBMMTAsMyBMMTQsMyBMMTQuODcxMzc0Nyw1LjYxNDEyNDAyIEMxNS4zMDM3MDcsNS44MDg4MjIxMiAxNS43MTI3MDg4LDYuMDQ2MTM0MiAxNi4wOTMwMjg3LDYuMzIwNzA5MDQgTDE4Ljc5NDIyODYsNS43Njc5NDkxOSBMMjAuNzk0MjI4Niw5LjIzMjA1MDgxIEwxOC45NjQ5MzU3LDExLjI5NDk2NjEgQzE4Ljk4ODEyNTIsMTEuNTI2ODMwNCAxOSwxMS43NjIwMjg0IDE5LDEyIEMxOSwxMi4yMzc5NzE2IDE4Ljk4ODEyNTIsMTIuNDczMTY5NiAxOC45NjQ5MzU3LDEyLjcwNTAzMzkgTDIwLjc5NDIyODYsMTQuNzY3OTQ5MiBMMTguNzk0MjI4NiwxOC4yMzIwNTA4IEwxNi4wOTMwMjg3LDE3LjY3OTI5MSBDMTUuNzEyNzA4OCwxNy45NTM4NjU4IDE1LjMwMzcwNywxOC4xOTExNzc5IDE0Ljg3MTM3NDcsMTguMzg1ODc2IEwxNCwyMSBMMTAsMjEgTDkuMTI4NjI1MzMsMTguMzg1ODc2IEM4LjY5NjI5Mjk4LDE4LjE5MTE3NzkgOC4yODcyOTEyMywxNy45NTM4NjU4IDcuOTA2OTcxMywxNy42NzkyOTEgTDUuMjA1NzcxMzcsMTguMjMyMDUwOCBMMy4yMDU3NzEzNywxNC43Njc5NDkyIEw1LjAzNTA2NDI5LDEyLjcwNTAzMzkgWiIvPgogICAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMSIvPgo8L3N2Zz4=",backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new Bd(this.uiControlVisibility.showSettingsButton,n.element)),t.appendChild(n.element)}this.registerDisposer(new Bd(Dn((function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.reduce(((e,t)=>e||t),!1)}),...Kk.map((e=>this.uiControlVisibility[e]))),t)),e.appendChild(t),this.layout=this.registerDisposer(new pk(this,"4panel")),this.sidePanelManager=this.registerDisposer(new oy(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new Ek(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new wk(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new gy(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.closeSelectionTab=()=>{for(const e of this.sidePanelManager.registeredPanels)e.panel instanceof gy&&e.panel.close()},this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new Uk(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{const e=this.inputEventBindings;return new pC(this.sidePanelManager,this.helpPanelState,[["Global",e.global],["Cross section view",e.sliceView],["3-D projection view",e.perspectiveView]],this.layerManager,this.toolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new Jk(this.sidePanelManager,this.settingsPanelState,this)}));const s=()=>{const t=this.visibility.visible;t!==this.visible&&(e.style.visibility=t?"inherit":"hidden",this.visible=t)};s(),this.registerDisposer(this.visibility.changed.add(s))}registerEventActionBindings(){const e=this.element;this.registerDisposer(new tS(e,this.inputEventMap)),this.registerDisposer(new Dw(e))}bindAction(e,t){this.registerDisposer(Cv(this.element,e,t))}bindCallback(e,t){this.registerDisposer(Cv(this.element,e,(()=>{t(this)})))}registerActionListeners(){for(const e of["recolor","clear-segments"])this.bindAction(e,(()=>{this.layerManager.invokeAction(e),this.closeSelectionTab&&this.closeSelectionTab()}));for(const e of["select"])this.bindAction(e,(()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)}));for(const e of["copy-segment-id","add-copy-segment-id"])this.bindAction(e,(()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e,this.selectedLayer.layer)}));this.bindAction("help",(()=>this.toggleHelpPanel()));for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,(()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&t.setVisible(!t.visible)})),this.bindAction(`toggle-pick-layer-${e}`,(()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&(t.pickEnabled=!t.pickEnabled)})),this.bindAction(`select-layer-${e}`,(()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);void 0!==t&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)}));for(let e=0;e<26;++e){const t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,(()=>{this.activateTool(t)}))}this.bindAction("annotate",(()=>{const e=this.selectedLayer.layer;if(void 0===e)return void Bp.showTemporaryMessage("The annotate command requires a layer to be selected.");const t=e.layer;null!==t&&void 0!==t.tool.value?t.tool.value.trigger(this.mouseState):Bp.showTemporaryMessage(`The selected layer (${Bt(e.name)}) does not have an active annotation tool.`)})),this.bindAction("toggle-axis-lines",(()=>this.showAxisLines.toggle())),this.bindAction("toggle-scale-bar",(()=>this.showScaleBar.toggle())),this.bindAction("toggle-default-annotations",(()=>this.showDefaultAnnotations.toggle())),this.bindAction("toggle-show-slices",(()=>this.showPerspectiveSliceViews.toggle())),this.bindAction("toggle-show-statistics",(()=>this.showStatistics()))}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.toolBinder.activate(e)}editJsonState(){new Rk(this)}copyJsonStateToUrl(){ay(this.makeUrlFromState(this.state.toJSON()))}showStatistics(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;void 0===e&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){let e=this.dataContext.chunkQueueManager;null===e.chunkUpdateDeadline&&(e.chunkUpdateDeadline=Date.now()+10)}}}const sT="tool",oT="toolBindings",aT="localPosition",lT="localDimensions",cT="source",dT="pick";class uT{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}}class hT extends Sn{constructor(e){super(),this.managedLayer=e,this.pick=new Vd(!0,!0),this.layersChanged=new kn,this.readyStateChanged=new kn,this.specificationChanged=new kn,this.renderLayers=new Array,this.loadingCounter=1,this.tabs=this.registerDisposer(new IS),this.panels=new $S(this),this.tool=this.registerDisposer(new tw(this)),this.toolBinder=new iw(this),this.dataSourcesChanged=new kn,this.dataSources=[],this.allowingRefresh=!1,this.localCoordinateSpaceCombiner.includeDimensionPredicate=Ca,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add((()=>this.updateDataSubsourceActivations())),this.tabs.add("source",{label:"Source",order:-100,getter:()=>new BS(this)})}get localPosition(){return this.managedLayer.localPosition}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=Jo,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){const n=(e.localCoordinateSpace=this.localCoordinateSpace.value).rank;if(0!==n){const i=is(t,aT,(e=>qr(new Float32Array(n),e,Tr)));void 0===i?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=i)}void 0!==(e.annotationId=is(t,"annotationId",es))&&(e.annotationSourceIndex=is(t,"annotationSource",Zr,0),e.annotationPartIndex=is(t,"annotationPart",Zr),e.annotationSubsource=is(t,"annotationSubsource",es)),e.value=t.value}displaySelectionState(e,t,n){return!1}selectionStateToJson(e,t){const n={};if(e.localPositionValid){const t=e.localPosition;t.length>0&&(n.localPosition=It(t))}return void 0!==e.annotationId&&(n.annotationId=e.annotationId,n.annotationPart=e.annotationPartIndex,n.annotationSource=e.annotationSourceIndex,n.annotationSubsource=e.annotationSubsource),null!=e.value&&(n.value=e.value),n}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;const n=this.localPosition.value;let i=e.localPosition;i.length!==n.length?e.localPosition=n.slice():i.set(n),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;const n=t.localPosition;e.localPosition.length!==n.length?e.localPosition=n.slice():e.localPosition.set(n),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return 0===this.loadingCounter}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){const t=new tg(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){this.activateDataSubsources(function*(){for(const e of this.dataSources){const t=e.loadState;if(void 0!==t&&void 0===t.error)for(const e of t.subsources)if(e.enabled)yield e;else{const n=e.activated;e.messages.clearMessages(),void 0!==n&&(n.dispose(),e.activated=void 0,t.activatedSubsourcesChanged.dispatch())}}}.call(this))}decrementLoadingCounter(){0===--this.loadingCounter&&this.readyStateChanged.dispatch()}markLoading(){const e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return 1===++this.loadingCounter&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){const t=this.manager.root.coordinateSpaceCombiner.bind(e),n=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}initializationDone(){const e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,n,i){return void 0===e?[]:[Zf(e,n)]}getDataSourceSpecifications(e){let t,n=ns(e,cT,(e=>Array.isArray(e)?e.map((e=>Zf(e))):"object"==typeof e?[Zf(e)]:(t=e,[])));const i=ns(e,"transform",Ra);return n.push(...this.getLegacyDataSourceSpecifications(t,e,i,n)),n=n.filter((e=>e.url)),0===n.length&&n.push(lf()),n}restoreState(e){this.tool.restoreState(e[sT]),this.toolBinder.restoreState(e[oT]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[lT]),this.localPosition.restoreState(e[aT]),this.constructor.supportsPickOption&&this.pick.restoreState(e[dT]);for(const t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);const t=this.layersChanged;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){const t=this.renderLayers,n=this.layersChanged,i=t.indexOf(e);if(-1===i)throw new Error("Attempted to remove invalid RenderLayer");t.splice(i,1),e.layerChanged.remove(n.dispatch),e.userLayer=void 0,e.dispose(),n.dispatch()}disposed(){const e=this.layersChanged;yn(this.dataSources);for(const t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let n,i=this.renderLayers,r=t.pickedRenderLayer;if(null!==r&&-1!==i.indexOf(r)&&(n=r.transformPickedValue(t),n=this.transformPickedValue(n),null!=n))return n;for(let s of i)if(n=s.getValueAt(e),null!=n)break;return this.transformPickedValue(n)}transformPickedValue(e){return e}toJSON(){return(0,i.bn)({type:this.type,[cT]:pT(this.dataSources),[sT]:this.tool.toJSON(),[oT]:this.toolBinder.toJSON(),[lT]:this.localCoordinateSpace.toJSON(),[aT]:this.localPosition.toJSON(),[dT]:this.pick.toJSON()},this.panels.toJSON())}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){const n=this.manager.root.globalPosition,i=this.localPosition;e?(Wt(n.value,t,e.globalToRenderLayerDimensions),Wt(i.value,t,e.localToRenderLayerDimensions)):n.value.set(t),i.changed.dispatch(),n.changed.dispatch()}}function pT(e){if(0!==e.length)return 1===e.length?e[0].toJSON():e.map((e=>e.toJSON()))}hT.supportsPickOption=!1;class fT extends Sn{constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new ca,this.localCoordinateSpaceCombiner=new Pa(this.localCoordinateSpace,xa),this.localPosition=this.registerDisposer(new jg(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new kn,this.layerChanged=new kn,this.specificationChanged=new kn,this.containers=new Rt,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e}get layer(){return this.layer_}set layer(e){let t=this.layer_;if(null!=t&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,null!=e){const t=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{t.forEach((e=>e()))},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){const e=this.layer;return null!==e&&e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){const e=this.layer;return null!==e&&e.constructor.supportsPickOption}get pickEnabled(){const e=this.layer;return null!==e&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){const t=this.layer;null!==t&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){let e=this.layer;if(null===e)return;let t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived)return this.visible=!0,void this.setArchived(!1);this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(!0===e){this.visible=!1,this.archived=!0;for(const e of this.manager.root.subsets){const t=e.layerManager;t.has(this)&&t.removeManagedLayer(this)}}else{for(const e of this.manager.root.subsets){const t=e.layerManager;t.has(this)||t.addManagedLayer(this.addRef())}this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class gT extends Sn{constructor(){super(),this.managedLayers=new Array,this.layerSet=new Rt,this.layersChanged=new kn,this.readyStateChanged=new kn,this.specificationChanged=new kn,this.boundPositions=new $f,this.numDirectUsers=0,this.nonArchivedLayerIndexGeneration=-1,this.renderLayerToManagedLayerMapGeneration=-1,this.renderLayerToManagedLayerMap_=new pt,this.scheduleRemoveLayersWithSingleRef=this.registerCancellable(mn((()=>this.removeLayersWithSingleRef()),0)),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){const e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(const n of this.managedLayers)n.archived||(n.nonArchivedLayerIndex=t++);for(const n of this.managedLayers)n.archived&&(n.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(const n of this.managedLayers)if(!n.archived){if(t===e)return n;++t}}get renderLayerToManagedLayerMap(){const e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(const e of this.managedLayers){const n=e.layer;if(null!==n)for(const i of n.renderLayers)t.set(i,e)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter((n=>!!e(n)||(this.unbindManagedLayer(n),this.layerSet.delete(n),t=!0,!1))),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter((e=>1!==e.refCount||e.archived))}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return 1===++this.numDirectUsers&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{0===--this.numDirectUsers&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,cw),this.layerSet.add(e),e.containers.add(this),void 0===t&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(let e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,lw),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(let e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){const t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){let t=this.managedLayers.indexOf(e);if(-1===t)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){const n=this.managedLayers.length;if(e===t||e<0||e>=n||t<0||t>=n)return;var i=this.managedLayers.splice(e,1);let r=O(i,1)[0];this.managedLayers.splice(t,0,r),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find((t=>t.name===e))}getUniqueLayerName(e){let t=e,n=0;for(;void 0!==this.getLayerByName(t);)t=e+ ++n;return t}has(e){return this.layerSet.has(e)}get renderLayers(){let e=this;return{*[i.bm](){for(let t of e.managedLayers)if(null!==t.layer)for(let e of t.layer.renderLayers)yield e}}}get visibleRenderLayers(){let e=this;return{*[i.bm](){for(let t of e.managedLayers)if(null!==t.layer&&t.visible)for(let e of t.layer.renderLayers)yield e}}}invokeAction(e,t){const n=new uT;for(let i of this.managedLayers){if(null===i.layer||!i.visible||void 0!==t&&i!==t)continue;let r=i.layer;r.handleAction(e,n);for(let t of r.renderLayers)t.handleAction(e)}for(const i of n.callbacks)i()}}class mT{constructor(){this.changed=new kn,this.coordinateSpace=ra,this.position=Jo,this.unsnappedPosition=Jo,this.active=!1,this.displayDimensions=void 0,this.pickedRenderLayer=null,this.pickedValue=new Ds(0,0),this.pickedOffset=0,this.pickedAnnotationLayer=void 0,this.pickedAnnotationId=void 0,this.pickedAnnotationBuffer=void 0,this.pickedAnnotationBufferBaseOffset=void 0,this.pickedAnnotationIndex=void 0,this.pickedAnnotationCount=void 0,this.pickedAnnotationType=void 0,this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,void 0===e&&this.setActive(!1)}updateUnconditionally(){const e=this.forcerFunction;return void 0!==e&&(e(),this.active)}setActive(e){(this.active!==e||!0===e)&&(this.active=e,this.changed.dispatch())}}class vT extends Sn{constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new kn,this.needsUpdate=!0,this.registerDisposer(t.changed.add((()=>{this.handleChange()}))),this.registerDisposer(e.layersChanged.add((()=>{this.handleLayerChange()})))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;let e=this.mouseState;const t=this.changed.count;if(e.active)for(const n of this.layerManager.managedLayers){const i=n.layer;if(n.visible&&null!==i){const n=i.selectionState;n&&(i.resetSelectionState(n),n.generation=t,i.captureSelectionState(n,e))}}}get(e){this.update();const t=e.selectionState;if(!t||t.generation===this.changed.count)return t}toJSON(){this.update();const e={};for(const t of this.layerManager.managedLayers){const n=t.layer;if(n){const i=this.get(n);void 0!==i&&(e[t.name]=n.selectionStateToJson(i,!0))}}return e}}const yT=(0,i.bn)((0,i.bn)({},$v),{minSize:150,row:1}),bT=(0,i.bn)((0,i.bn)({},yT),{visible:!0});class ST extends Sn{constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new kn,this.history=[],this.historyIndex=0,this.location=new jv(yT),this.pin=new En(!0),this.registerDisposer(On(((e,n)=>{n||(this.capture(!0),e.registerDisposer(t.changed.add(e.registerCancellable(qf((()=>this.capture(!0)),100,{leading:!0,trailing:!0})))))}),this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){const e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return!!this.pin.value&&this.historyIndex+1<this.history.length}goForward(){if(!this.pin.value)return;const e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,void 0!==e&&this.pin.value){const t=this.history;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>10&&t.splice(0,t.length-10),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(!1===n&&(!this.location.visible||this.pin.value))return;const r={};e.initializeSelectionState(r),t(r)&&(i&&(this.location.visible=!0),!0===n?this.pin.value=!0:"toggle"===n&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:r}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){const e=this.value;let t;if(this.location.visible){if(t=this.location.toJSON((0,i.bn)((0,i.bn)({},bT),{visible:!iT.expectingExternalUI})),this.pin.value&&void 0!==e){const n={};for(const t of e.layers){let e=t.layer.selectionStateToJson(t.state,!1);0===f(e).length&&(e=void 0),n[t.layer.managedLayer.name]=e}void 0!==e.position&&(t.position=It(e.position)),t.layers=n}}else t=this.location.toJSON(yT),t=ps(t),void 0!==t&&(t.visible=!1);return t}select(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=this.pin;e&&(this.location.visible=!0),t.value=!t.value,t.value&&this.capture()}capture(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=function(e){const t=e.mouseState;if(!t.active)return;const n=[];for(const i of e.layerManager.managedLayers){const t=i.layer;if(null===t)continue;const r=e.get(t);if(void 0===r)continue;const s={};t.initializeSelectionState(s),t.copySelectionState(s,r),n.push({layer:t,state:s})}return{position:t.position.slice(),coordinateSpace:t.coordinateSpace,layers:n}}(this.layerSelectedValues);e&&void 0===t||(this.value=t)}restoreState(e){if(void 0===e)return this.pin.value=!0,void(this.value=void 0);if(null===e)return this.pin.value=!1,this.location.visible=!0,void(this.value=void 0);Yr(e),this.location.restoreState(e,(0,i.bn)((0,i.bn)({},bT),{visible:!iT.expectingExternalUI}));const t=this.coordinateSpace.value,n=t.rank>0?is(e,"position",(e=>qr(new Float32Array(t.rank),e,Tr))):void 0,r=[];is(e,"layers",(e=>{Yr(e);const t=this.layerSelectedValues.layerManager;for(const i of Cf(e)){var n=O(i,2);const e=n[0],s=n[1],o=t.getLayerByName(e);if(void 0===o)return;const a=o.layer;if(null===a)return;Yr(s);const l={};a.initializeSelectionState(l),a.selectionStateFromJson(l,s),r.push({layer:a,state:l})}})),this.pin.value=r.length>0||void 0!==n,this.value={position:n,coordinateSpace:t,layers:r}}}class wT extends Sn{constructor(e){super(),this.view=e,this.messages=new wl,this.seenGeneration=-1,this.state=void 0}}let xT=0;class CT extends Sn{constructor(e,t,n,i,r,s){super(),this.layerManager=e,this.renderLayerType=t,this.view=n,this.roles=i,this.layerAdded=r,this.visibility=s,this.visibleLayers_=new pt,this.debouncedUpdateVisibleLayers=this.registerCancellable(mn((()=>this.updateVisibleLayers()),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(i.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach((e=>e.dispose())),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){const e=++xT,t=this.visibleLayers_,n=this.renderLayerType,i=this.layerAdded,r=this.roles;for(let o of this.layerManager.readyRenderLayers())if(o instanceof n&&r.has(o.role)){let n=o,r=t.get(n);void 0===r&&(r=new wT(this.view),r.registerDisposer(n.messages.addChild(r.messages)),r.registerDisposer(n.addRef()),r.registerDisposer(n.visibility.add(this.visibility)),t.set(n,r),i(n,r),n.attach(r)),r.seenGeneration=e}for(const o of t){var s=O(o,2);const n=s[0],i=s[1];i.seenGeneration!==e&&(t.delete(n),i.dispose())}}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function kT(e,t,n,i,r){return i.registerDisposer(new CT(e,t,i,n,((e,t)=>{t.registerDisposer(e.redrawNeeded.add((()=>i.scheduleRedraw())));const n=e.backend;n&&(n.rpc.invoke("rendered_view.addLayer",{layer:n.rpcId,view:i.rpcId}),t.registerDisposer((()=>n.rpc.invoke("rendered_view.removeLayer",{layer:n.rpcId,view:i.rpcId})))),void 0!==r&&r(e,t),i.scheduleRedraw(),t.registerDisposer((()=>i.scheduleRedraw()))}),i.visibility))}class TT extends Sn{constructor(e){super(),this.layerManager=e,this.changed=new kn,this.location=new jv(US),this.registerDisposer(e),this.location.changed.add((()=>{var e,t;this.changed.dispatch();const n=null!==(t=null===(e=this.layer)||void 0===e?void 0:e.layer)&&void 0!==t?t:void 0;if(void 0!==n){const e=this.location.value;if(e.visible){const t=n.panels.panels[0];t.location.value!==e&&(t.location.value=e,t.location.locationChanged.dispatch())}}}))}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(!0===e&&void 0===t){const n=this.layerManager.managedLayers;n.length>0?t=this.layer=n[0]:e=!1}if(!0===e&&void 0!==t){const n=t.layer;(null===n||0===n.panels.panels[0].tabs.length)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&void 0!==t&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;const t=e.layer;null!==t&&t instanceof qT&&(t.dataSources.some((e=>0!==e.spec.url.length))||$T(e))}set layer(e){if(e===this.layer_)return;const t=this.layer_;if(void 0!==t&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,void 0!==e){const t=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(t);const n=e.specificationChanged.add((()=>{this.changed.dispatch()}));this.existingLayerDisposer=()=>{const i=e.layer;if(null!==i){const e=i.tool.value;void 0!==e&&e.deactivate()}e.unregisterDisposer(t),n()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){const e=this.location.toJSON();return void 0!==this.layer&&(e.layer=this.layer.name),ps(e)}restoreState(e){if(void 0===e)return void this.reset();Yr(e),this.location.restoreState(e);const t=ns(e,"layer",ts),n=void 0!==t?this.layerManager.getLayerByName(t):void 0;void 0===n&&(this.visible=!1),this.layer=n}reset(){this.location.reset(),this.layer=void 0}}class ET extends Sn{constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new kn,this.validate=mn((()=>{const e=this.layerName_;if(void 0!==e){const t=this.layerManager.getLayerByName(e);void 0!==t&&this.filter(t)?(this.layer_=t,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}}),0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add((()=>{const e=this.layer_;if(void 0!==e)if(this.layerManager.layerSet.has(e)&&this.filter(e)){const t=e.name;t!==this.layerName_&&(this.layerName_=t,this.changed.dispatch())}else this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch()})))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(void 0!==e&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){const t=ts(e);this.layerName=t}toJSON(){const e=this.layer_;return void 0!==e?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class LT extends Sn{constructor(e,t,n,i){super(),this.layerManager=e,this.layer=t,this.predicate=n,this.getGroup=i,this.linkedLayers_=new Rt,this.changed=new kn,this.linkedLayersChanged=new kn,this.root_=t;const r=this;this.root={get value(){return r.root_},changed:r.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(void 0===e)return;const t=es(e);this.linkByName(t)}toJSON(){const e=this.root.value;if(e!==this.layer)return e.managedLayer.name}isolate(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const t=this.getGroup,n=this.layer,i=this.root_;if(i===n){const e=this.linkedLayers_;if(0!==e.size){for(const n of e){const e=t(n);e.root_=n,e.changed.dispatch()}e.clear(),this.linkedLayersChanged.dispatch()}return}const r=t(i);r.linkedLayers_.delete(n),r.linkedLayersChanged.dispatch(),this.root_=n,e&&this.changed.dispatch()}linkByName(e){const t=this.layer.managedLayer,n=this.layerManager.getLayerByName(e);if(void 0===n||n===t)return;const i=n.layer;null!==i&&this.predicate(i)&&this.linkToLayer(i)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);const t=this.getGroup,n=t(e).root_;if(n===this.layer)return;const i=t(n);i.linkedLayers_.add(this.layer),i.linkedLayersChanged.dispatch(),this.root_=n,this.changed.dispatch()}disposed(){this.isolate(!1)}}function IT(e,t){const n=is(t,"type",es,"auto");e.archived=is(t,"archived",hs,!1),e.archived?e.visible=!1:e.visible=is(t,"visible",hs,!0);const i=OT.get(n)||qT;return e.layer=new i(e),t}function DT(e,t){try{const n=e.layer;if(null===n)return;n.restoreState(t),n.initializationDone()}catch(n){throw $T(e),n}}function MT(e,t){try{Yr(t),IT(e,t),DT(e,t)}catch(n){throw $T(e),n}}function PT(e,t){try{MT(e,t)}catch(n){(new Bp).setErrorMessage(n instanceof Error?n.message:""+n)}}function AT(e,t,n){const i=new fT(t,e);return MT(i,n),i}class RT extends Sn{constructor(){super(...arguments),this.changed=new kn}}class NT extends RT{constructor(e,t,n,i,r,s,o,a,l){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=n,this.chunkManager=i,this.selectionState=r,this.selectedLayer=s,this.coordinateSpace=o,this.globalPosition=a,this.toolBinder=l,this.coordinateSpaceCombiner=new Pa(this.coordinateSpace,Ta),this.subsets=new Rt,this.layerSelectedValues=this.selectionState.layerSelectedValues,this.registerDisposer(n.layersChanged.add(this.changed.dispatch)),this.registerDisposer(n.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){let t;this.layerManager.clear(),Array.isArray(e)?t=e:(Yr(e),t=Cf(e).map((e=>{let[t,n]=e;return"string"==typeof n?{name:t,source:n}:(Yr(n),(0,i.bn)((0,i.bn)({},n),{name:t}))})));const n=[];for(const i of t){Yr(i);const e=this.layerManager.getUniqueLayerName(ns(i,"name",es)),t=new fT(e,this);try{IT(t,i),this.layerManager.addManagedLayer(t),n.push({managedLayer:t,spec:i})}catch(r){t.dispose(),(new Bp).setErrorMessage(`Error creating layer ${Bt(e)}: `+(r instanceof Error)?r.message:""+r)}}for(const i of n){const e=i.managedLayer,t=i.spec;try{DT(e,t)}catch(r){(new Bp).setErrorMessage(`Error creating layer ${Bt(name)}: `+(r instanceof Error)?r.message:""+r)}}}add(e,t){-1===this.layerManager.managedLayers.indexOf(e)&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){const e=[];let t=0;for(let n of this.layerManager.managedLayers){const i=n.toJSON();null!=i&&(e.push(i),++t)}if(0!==t)return e}get rootLayers(){return this.layerManager}}class VT extends RT{constructor(e){super(),this.master=e,this.changed=new kn,this.layerManager=this.registerDisposer(new gT),this.registerDisposer(e);const t=this.layerManager;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){const t=this.master.layerManager,n=[];for(const i of new Rt(Jr(e,es))){const e=t.getLayerByName(i);if(void 0===e)throw new Error(`Undefined layer referenced in subset specification: ${Bt(i)}`);e.archived||n.push(e)}this.layerManager.clear();for(const i of n)this.layerManager.addManagedLayer(i.addRef())}toJSON(){return this.layerManager.managedLayers.map((e=>e.name))}add(e,t){-1===this.master.layerManager.managedLayers.indexOf(e)&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}const OT=new pt,BT=new pt,_T=[e=>{const t=e.volume;if(void 0===t)return;const n=BT.get(t.volumeType);return void 0!==n?{layerConstructor:n,priority:0}:void 0}];function FT(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.type;OT.set(t,e)}function zT(e){_T.push(e)}function UT(e,t){BT.set(e,t)}function GT(e,t){const n=e.layer;if(null===n)return;const i=n.toJSON(),r=new t(e);r.restoreState(i),r.initializationDone(),e.layer=r}function WT(e,t){return t!==e.name&&(t=e.manager.root.layerManager.getUniqueLayerName(t),e.name=t,e.layerChanged.dispatch(),!0)}function $T(e){if(!e.wasDisposed)for(const t of e.containers)t.removeManagedLayer(e)}function jT(e,t){return void 0===e?t:void 0===t?e:e.priority<t.priority?t:e}function HT(e){let t;for(const i of _T)t=jT(t,i(e));const n=e.volume;if(void 0!==n){const e=BT.get(n.volumeType);void 0!==e&&(t=jT(t,{layerConstructor:e,priority:0}))}return t}function JT(e){let t;for(const n of e){t=jT(t,HT(n.subsourceEntry.subsource))}return t}class qT extends hT{activateDataSubsources(e){var t;this.detectedLayerConstructor=null===(t=JT(e))||void 0===t?void 0:t.layerConstructor}}qT.type="new",qT.typeAbbreviation="new";class YT extends hT{activateDataSubsources(e){var t;const n=null===(t=JT(e))||void 0===t?void 0:t.layerConstructor;void 0!==n&&GT(this.managedLayer,n)}}function ZT(e,t){const n=AT(e,"new layer",{type:"new"});e.add(n),t.layer=n,t.visible=!0}function XT(e,t){return t=ws(t,3432918353)>>>0,t=ws(t=(t<<15|t>>>17)>>>0,461845907)>>>0,e=ws(e=((e^=t)<<13|e>>>19)>>>0,5)+3864292196>>>0}function KT(e,t,n){let i=e;return i=XT(i,t),i=XT(i,n),function(e,t){return e^=t,e=ws(e^=e>>>16,2246822507)>>>0,e^=e>>>13,e*=3266489909,(e^=e>>>16)>>>0}(i,8)}YT.type="auto",YT.typeAbbreviation="auto",FT(qT),FT(YT);function QT(e,t,n){const i=e.length-1;for(;;){if(0===e[t&=i])return void(e[t]=n);++t}}function eE(e,t){return t<=255?new Uint8Array(e):t<=65535?new Uint16Array(e):new Uint32Array(e)}class tE{constructor(e){this.inlineProperties=e.inlineProperties}}class nE{constructor(e){var t;this.segmentPropertyMap=e;const n=e.inlineProperties;void 0!==n&&(this.inlineIdToIndex=function(e){const t=e.length/2,n=eE(2**(Math.ceil(ks(t))+1),t+1);for(let i=0;i<t;++i)QT(n,KT(0,e[2*i],e[2*i+1]),i+1);return n}(n.ids)),this.tags=n?.properties.find((e=>"tags"===e.type)),this.labels=n?.properties.find((e=>"label"===e.type)),this.numericalProperties=null!==(t=n?.properties.filter((e=>"number"===e.type)))&&void 0!==t?t:[]}getSegmentInlineIndex(e){const t=this.inlineIdToIndex;return void 0===t?-1:function(e,t,n,i){let r=KT(0,n,i);const s=e.length-1;for(;;){r&=s;let o=e[r];if(0===o)return-1;if(--o,t[2*o]===n&&t[2*o+1]===i)return o;++r}}(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){const t=this.getSegmentInlineIndex(e);if(-1===t)return;const n=this.labels,i=this.tags;let r="";if(void 0!==n&&(r=n.values[t]),void 0!==i){const e=i.tags;let n=i.values[t];for(let t=0,i=n.length;t<i;++t){const i=e[n.charCodeAt(t)];r.length>0&&(r+=" "),r+="#",r+=i}}return 0!==r.length?r:void 0}}function iE(e,t,n){for(let i=0,r=n.length;i<r;++i)t[n[i]]=e[i]}function rE(e,t,n){const r=e.type;return"label"===r||"description"===r||"string"===r||"tags"===r?function(e,t,n){const r=new Array(t);return r.fill(""),iE(e.values,r,n),(0,i.bn)((0,i.bn)({},e),{values:r})}(e,t,n):function(e,t,n){const r=new Float32Array(t);return r.fill(Number.NaN),iE(e.values,r,n),(0,i.bn)((0,i.bn)({},e),{values:r})}(e,t,n)}function sE(e,t){if(void 0===e)return t;if(void 0===t)return e;let n=0;const i=e.ids.length/2,r=t.ids.length/2,s=new Uint32Array(i),o=new Uint32Array(r),a=e.ids,l=t.ids;let c;if(function(e,t,n,i,r,s){let o=0,a=0;if(0!==e&&0!==t)for(;;){const l=n(o,a);if(l<0){if(i(o),++o===e)break}else if(l>0){if(r(a),++a===t)break}else if(s(o,a),++o,++a,o===e||a===t)break}for(;o<e;)i(o),++o;for(;a<t;)r(a),++a}(i,r,((e,t)=>{const n=a[2*e+1],i=a[2*e],r=l[2*t+1],s=l[2*t];return n-r||i-s}),(e=>{s[e]=n,++n}),(e=>{o[e]=n,++n}),((e,t)=>{s[e]=n,o[t]=n,++n})),n===i)c=a;else if(n===r)c=l;else{c=new Uint32Array(2*n);for(let e=0;e<i;++e){const t=s[e];c[2*t]=a[2*e],c[2*t+1]=a[2*e+1]}for(let e=0;e<r;++e){const t=o[e];c[2*t]=l[2*e],c[2*t+1]=l[2*e+1]}}const d=[];if(n===i)d.push(...e.properties);else for(const u of e.properties)d.push(rE(u,n,s));if(n===r)d.push(...t.properties);else for(const u of t.properties)d.push(rE(u,n,o));return{ids:c,properties:d}}function oE(e,t){return new tE({inlineProperties:sE(e.inlineProperties,t.inlineProperties)})}function aE(e,t){return e.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:t.map((e=>Gd(e)))},(()=>{const e=function(e){for(;;){if(0===e.length)return;if(1===e.length)return e[0];const t=[];for(let n=0,i=e.length;n<i;n+=2)n+1===i?t.push(e[n]):t.push(oE(e[n],e[n+1]));e=t}}(t);if(void 0!==e)return new nE(e)}))}const lE=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function cE(e){return"\\u"+e.toString(16).padStart(4,"0")}function dE(e,t,n){const i=t.values;var r=O(n,2);const s=r[0],o=r[1],a=o<=s?0:256/(o-s),l=new Uint32Array(258),c=e.query.numericalConstraints,d=c.findIndex((e=>e.fieldId===t.id));if(-1===d){const t=e.indices;for(let e=0,n=t.length;e<n;++e){const n=i[t[e]];isNaN(n)||++l[Math.min(255,Math.max(-1,(n-s)*a))+1>>>0]}}else{const t=e.intermediateIndices,n=e.intermediateIndicesMask,r=2**c.length-1-2**d;for(let e=0,o=t.length;e<o;++e)if((n[e]&r)==r){const n=i[t[e]];isNaN(n)||++l[Math.min(255,Math.max(-1,(n-s)*a))+1>>>0]}}return{queryResult:e,histogram:l,window:n}}function uE(e){return e?.tags||e?.labels?"label":"id"}const hE=new Ds;function pE(e,t,n){if(void 0===t)return;const i=t.explicitIds;if(void 0!==i)return void i.forEach(n);const r=t.indices;if(void 0!==r){var s=e?.segmentPropertyMap.inlineProperties;const t=s.ids;for(let e=0,i=r.length;e<i;++e){const i=r[e];hE.low=t[2*i],hE.high=t[2*i+1],n(hE,e)}}}function fE(e,t,n,r){const s=e.includeTags.filter((e=>e!==t)),o=e.excludeTags.filter((e=>e!==t));return!0===r&&(n?s:o).push(t),(0,i.bn)((0,i.bn)({},e),{includeTags:s,excludeTags:o})}function gE(e,t){if(void 0===e||void 0!==e.ids||void 0!==e.errors)return!1;const n=e.sortBy,i=e.includeColumns;return void 0!==n.find((e=>e.fieldId===t))||i.includes(t)}const mE=(0,i.bu)("disjoint_sets:rank"),vE=(0,i.bu)("disjoint_sets:parent"),yE=(0,i.bu)("disjoint_sets:next"),bE=(0,i.bu)("disjoint_sets:prev");function SE(e){let t=e,n=e[vE];for(;n!==e;)n=(e=n)[vE];for(e=t[vE];n!==e;)t[vE]=n,t=e,e=t[vE];return n}function*wE(e){let t=e;do{yield t,t=t[yE]}while(t!==e)}const xE=(0,i.bu)("disjoint_sets:min");function CE(e){return e[vE]===e}class kE{constructor(){this.map=new pt,this.visibleSegmentEquivalencePolicy=new En(up.MIN_REPRESENTATIVE),this.generation=0}has(e){let t=e.toString();return void 0!==this.map.get(t)}get(e){let t=e.toString(),n=this.map.get(t);return void 0===n?e:SE(n)[xE]}isMinElement(e){let t=this.get(e);return t===e||Ds.equal(t,e)}makeSet(e){let t=e.toString(),n=this.map,i=n.get(t);return void 0===i?(i=e.clone(),function(e){e[vE]=e,e[mE]=0,e[yE]=e[bE]=e}(i),i[xE]=i,n.set(t,i),i):SE(i)}link(e,t){if((e=this.makeSet(e))===(t=this.makeSet(t)))return!1;this.generation++;let n=function(e,t){let n=e[mE],i=t[mE];return n>i?(t[vE]=e,e):(e[vE]=t,n===i&&(t[mE]=i+1),t)}(e,t);!function(e,t){let n=e[bE],i=t[bE];t[bE]=n,n[yE]=t,e[bE]=i,i[yE]=e}(e,t);let i=e[xE],r=t[xE];const s=0!==(this.visibleSegmentEquivalencePolicy.value&up.MAX_REPRESENTATIVE);return n[xE]=Ds.less(i,r)===s?r:i,!0}linkAll(e){for(let t=1,n=e.length;t<n;++t)this.link(e[0],e[t])}deleteSet(e){const t=this.map;let n=!1;for(const i of this.setElements(e))t.delete(i.toString()),n=!0;return n}*setElements(e){let t=e.toString(),n=this.map.get(t);void 0===n?yield e:yield*wE(n)}clear(){let e=this.map;return 0!==e.size&&(++this.generation,e.clear(),!0)}get size(){return this.map.size}mappings(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Array(2);return function*(){for(let n of e.map.values())t[0]=n,t[1]=SE(n)[xE],yield t}()}*roots(){for(let e of this.map.values())CE(e)&&(yield e)}[i.bm](){return this.mappings()}toJSON(){let e=new Array;for(let t of this.map.values())if(CE(t)){let n=new Array;for(let e of wE(t))n.push(e);n.sort(Ds.compare),e.push(n)}return e.sort(((e,t)=>Ds.compare(e[0],t[0]))),e.map((e=>e.map((e=>e.toString()))))}}var TE,EE=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};const LE="DisjointUint64Sets.add",IE="DisjointUint64Sets.clear",DE="DisjointUint64Sets.highBitRepresentativeChanged",ME="DisjointUint64Sets.deleteSet";let PE=TE=class extends md{constructor(){super(...arguments),this.disjointSets=new kE,this.changed=new kn}get value(){return this}static makeWithCounterpart(e,t){let n=new this;return n.disjointSets.visibleSegmentEquivalencePolicy=t,n.registerDisposer(t.changed.add((()=>{NE(n)}))),n.initializeCounterpart(e),t.value&&NE(n),n}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(e,t){if(this.disjointSets.link(e,t)){let n=this.rpc;return n&&n.invoke(LE,{id:this.rpcId,al:e.low,ah:e.high,bl:t.low,bh:t.high}),this.changed.dispatch(),!0}return!1}linkAll(e){for(let t=1,n=e.length;t<n;++t)this.link(e[0],e[t])}has(e){return this.disjointSets.has(e)}get(e){return this.disjointSets.get(e)}clear(){if(this.disjointSets.clear()){let e=this.rpc;e&&e.invoke(IE,{id:this.rpcId}),this.changed.dispatch()}}setElements(e){return this.disjointSets.setElements(e)}deleteSet(e){if(this.disjointSets.deleteSet(e)){let t=this.rpc;t&&t.invoke(ME,{id:this.rpcId,l:e.low,h:e.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(e){if(void 0!==e){let t=[new Ds,new Ds];Jr(e,(e=>{Jr(e,((e,n)=>{t[n%2].parseString(String(e),10),0!==n&&this.link(t[0],t[1])}))}))}}assignFrom(e){this.clear(),e instanceof TE&&(e=e.disjointSets);for(const n of e){var t=O(n,2);const e=t[0],i=t[1];this.link(e,i)}}};PE=TE=EE([bd("DisjointUint64Sets")],PE);const AE=new Ds,RE=new Ds;function NE(e){e.rpc.invoke(DE,{id:e.rpcId,value:e.disjointSets.visibleSegmentEquivalencePolicy.value})}dd(LE,(function(e){let t=this.get(e.id);AE.low=e.al,AE.high=e.ah,RE.low=e.bl,RE.high=e.bh,t.disjointSets.link(AE,RE)&&t.changed.dispatch()})),dd(IE,(function(e){let t=this.get(e.id);t.disjointSets.clear()&&t.changed.dispatch()})),dd(DE,(function(e){this.get(e.id).disjointSets.visibleSegmentEquivalencePolicy.value=e.value})),dd(ME,(function(e){let t=this.get(e.id);AE.low=e.l,AE.high=e.h,t.disjointSets.deleteSet(AE)&&t.changed.dispatch()}));class VE extends hp{constructor(){super(...arguments),this.spanningTreeEdges=new pt,this.equivalences=new PE,this.connections=new Rt,this.changed=new Cn}link(e,t){this.equivalences.link(e,t);for(const n of this.connections)n.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(const e of this.connections)OE(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){const n=e.toString(),i=t.toString(),r=this.spanningTreeEdges;let s=r.get(n);void 0===s&&(s=new Rt,r.set(n,s));let o=r.get(i);void 0===o&&(o=new Rt,r.set(i,o)),s.add(i),o.add(n)}removeSpanningTreeEdge(e,t){const n=e.toString(),i=t.toString(),r=this.spanningTreeEdges,s=r.get(n),o=r.get(i);s.delete(i),0===s.size&&r.delete(n),o.delete(n),0===o.size&&r.delete(i)}*getSpanningTreeNeighbors(e){const t=new Ds,n=this.spanningTreeEdges.get(e.toString());if(void 0!==n)for(const i of n)t.parseString(i),yield t}restoreState(e){const t=this.equivalences,n=this.spanningTreeEdges;if(t.clear(),n.clear(),void 0===e)return;const i=[new Ds,new Ds];Jr(e,(e=>{Jr(e,((e,n)=>{i[n%2].parseString(String(e),10),0!==n&&t.link(i[0],i[1])&&this.addSpanningTreeEdge(i[0],i[1])}))}))}toJSON(){const e=this.spanningTreeEdges;if(0===e.size)return;const t=new Array;for(let i of e){var n=O(i,2);let e=n[0],r=n[1];const s=Ds.parseString(e);for(const n of r){const e=Ds.parseString(n);Ds.compare(s,e)>0||t.push([s,e])}}return t.sort(((e,t)=>Ds.compare(e[0],t[0])||Ds.compare(e[1],t[1]))),t.map((e=>e.map((e=>e.toString()))))}get visibleSegmentEquivalencePolicy(){return up.MIN_REPRESENTATIVE}async merge(e,t){const n=this.equivalences;return Ds.equal(n.get(e),n.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),n.get(e))}async split(e,t){const n=this.computeSplit(e,t);if(void 0===n)throw new Error("Segments are already split");const i=n.includeBaseSegments,r=n.includeRepresentative,s=n.excludeBaseSegments,o=n.excludeRepresentative,a=this.equivalences;this.deleteSet(e),this.linkAll(i),this.linkAll(s);const l=(e,t)=>{for(const n of e)for(const e of this.getSpanningTreeNeighbors(n))Ds.equal(a.get(e),t)||this.removeSpanningTreeEdge(n,e)},c=a.get(e),d=a.get(t);l(i,c),l(s,d);for(const u of this.connections){const e=u.segmentsState.visibleSegments;e.has(o)&&(e.delete(o),e.add(r))}return this.normalizeAll(),this.changed.dispatch(),{include:c,exclude:d}}trackSegment(e,t){return()=>{}}computeSplit(e,t){const n=this.equivalences,i=n.get(e);if(!Ds.equal(i,n.get(t)))return;const r=new kE;for(const d of n.setElements(i))if(!Ds.equal(d,t))for(const e of this.getSpanningTreeNeighbors(d))Ds.equal(e,t)||r.link(d,e);const s=[],o=[],a=r.get(e);let l=e,c=t;for(const d of n.setElements(i))Ds.equal(r.get(d),a)?(s.push(d),Ds.compare(d,l)<0&&(l=d)):(o.push(d),Ds.compare(d,c)<0&&(c=d));return s.sort(Ds.compare),o.sort(Ds.compare),{includeBaseSegments:s,includeRepresentative:l,excludeBaseSegments:o,excludeRepresentative:c}}connect(e){const t=new BE(this,e);return e.segmentEquivalences.assignFrom(this.equivalences),OE(e.visibleSegments,e.segmentEquivalences.disjointSets),t.registerDisposer(e.visibleSegments.changed.add(t.registerCancellable(mn((()=>OE(e.visibleSegments,e.segmentEquivalences.disjointSets)),0)))),this.connections.add(t),t.registerDisposer((()=>{this.connections.delete(t)})),t}}function OE(e,t){const n=[];for(const i of e.unsafeKeys()){const r=t.get(i);Ds.equal(i,r)||(n.push(r),e.delete(i))}for(const i of n)e.add(i)}class BE extends pp{computeSplit(e,t){return this.graph.computeSplit(e,t)}}var _E;function FE(e){const t=e.rank,n=e.dataType,r=e.compressedSegmentationBlockSize;var s=e.baseVoxelOffset;const o=void 0===s?new Float32Array(t):s;return(0,i.bn)((0,i.bn)({},Oh(e)),{compressedSegmentationBlockSize:r,baseVoxelOffset:o,dataType:n})}function zE(e){let t=e.rank,n=e.lowerVoxelBound,r=e.upperVoxelBound;if(!function(e){if(void 0!==e.compressedSegmentationBlockSize||e.volumeType!==_E.SEGMENTATION&&!e.volumeSourceOptions.discreteValues)return!1;switch(e.dataType){case sr.UINT32:case sr.UINT64:break;default:return!1}switch(e.rank){case 3:return!0;case 4:return 1===e.chunkDataSize[3];default:return!1}}(e))return FE(e);var s=e.volumeSourceOptions;let o=s.displayRank,a=s.multiscaleToViewTransform,l=e.chunkToMultiscaleTransform,c=e.chunkToViewTransform;void 0===c&&(c=wo(new Float32Array(t*o),o,a,o,l,t+1,o,t,t));const d=e.maxCompressedSegmentationBlockSize,u=e.chunkDataSize;return FE((0,i.bn)((0,i.bn)({},e),{compressedSegmentationBlockSize:Float32Array.from(Rh({rank:t,chunkToViewTransform:c,displayRank:o,lowerVoxelBound:n,upperVoxelBound:r,maxVoxelsPerChunkLog2:9,maxBlockSize:void 0===d?u:Ho(new Uint32Array(t),u,d)}))}))}function UE(e){const t=e.rank;var n=e.volumeSourceOptions;const r=n.displayRank,s=n.multiscaleToViewTransform,o=n.modelChannelDimensionIndices,a=e.chunkToMultiscaleTransform,l=wo(new Float32Array(r*t),r,s,r,a,t+1,r,t,t);let c=e.minBlockSize;void 0===c?(c=new Uint32Array(t),c.fill(1)):c=new Uint32Array(c);const d=e.lowerVoxelBound,u=e.upperVoxelBound;if(0!==o.length)for(const i of Ui(a,t,o)){let e=u[i];void 0!==d&&(e-=d[i]),c[i]=e}var h=e.chunkDataSizes;return(void 0===h?Vh((0,i.bn)((0,i.bn)({},e),{minBlockSize:c,chunkToViewTransform:l,displayRank:r})):h).map((t=>zE((0,i.bn)((0,i.bn)({},e),{chunkDataSize:t,chunkToViewTransform:l}))))}!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.IMAGE=1]="IMAGE",e[e.SEGMENTATION=2]="SEGMENTATION"}(_E||(_E={}));const GE=ti(),WE=ti();const $E=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),jE=(()=>{const e=[0,1,2,4,5,3,6,7],t=[0,1,2,5,3,4,6,7],n=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],i=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],r=new Int32Array(384);for(let s=0;s<8;++s)for(let o=0;o<n.length;++o){const a=8*t[s]+n[o];r[8*s*6+o]=e[i[a]]}return r})();function HE(e){e.addUniform("highp vec3","uPlaneNormal"),e.addUniform("highp float","uPlaneDistance"),e.addUniform("highp ivec2","uVertexIndex",24),e.addUniform("highp vec3","uVertexBasePosition",8),e.addInitializer((e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),$E)})),e.addVertexCode("\nvec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {\n  for (int e = 0; e < 4; ++e) {\n    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];\n    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));\n    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));\n    highp vec3 vDir = v2 - v1;\n    highp float denom = dot(vDir, uPlaneNormal);\n    if (abs(denom) > 0.001) {\n      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;\n      if ((lambda >= -0.001) && (lambda <= (1.0 + 0.001))) {\n        lambda = clamp(lambda, 0.0, 1.0);\n        highp vec3 position = v1 + lambda * vDir;\n        return position;\n      }\n    }\n  }\n  return vec3(0, 0, 0);\n}\nvec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {\n  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);\n}\n")}function JE(e,t,n,i,r){const s=Vi(GE,t,i);ui(s,s);!function(e,t,n){const i=e.gl;i.uniform3fv(e.uniform("uPlaneNormal"),t),i.uniform1f(e.uniform("uPlaneDistance"),n);const r=function(e){let t=0;for(var n=0;n<3;++n)e[n]<0&&(t+=1<<n);return t}(t);i.uniform2iv(e.uniform("uVertexIndex"),jE.subarray(48*r,48*(r+1)))}(e,s,hi(pi(WE,n,r),s))}const qE=qn();function YE(e,t,n,i,r,s){const o=n.projectionParameters.value,a=o.centerDataPosition;JE(t,o.viewportNormalInGlobalCoordinates,a,s.transform,s.invTransform),e.uniformMatrix4fv(t.uniform("uProjectionMatrix"),!1,Qn(qE,i,s.transform)),e.uniform3fv(t.uniform("uLowerClipBound"),r.lowerClipDisplayBound),e.uniform3fv(t.uniform("uUpperClipBound"),r.upperClipDisplayBound)}function ZE(e,t,n){e.uniform3fv(t.uniform("uChunkDataSize"),n)}function XE(e,t,n,i){e.uniform3fv(t.uniform("uTranslation"),n),i?Cb(t.gl,6,1):e.drawArrays(e.TRIANGLE_FAN,0,6)}function KE(e,t,n){return e>t?n>e?e:t>n?t:n:n>t?t:e>n?e:n}class QE extends Cp{constructor(e,t){var n=t.shaderError;const i=void 0===n?Xd():n,r=t.shaderParameters;super(e.chunkManager,e,t);const s=this.gl;this.vertexIdHelper=this.registerDisposer(Eb.get(s)),this.shaderParameters=r;const o=t.channelCoordinateSpace;this.channelCoordinateSpace=void 0===o?_n(ra):o,this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch));const a=this.registerDisposer(Rn(((e,t)=>({numChannelDimensions:e.rank,dataHistogramChannelSpecifications:t})),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=Qd(this,s,{memoizeKey:`volume/RenderLayer:${Gd(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:r,encodeParameters:t.encodeShaderParameters,shaderError:i,extraParameters:a,defineShader:(e,t,n,i)=>{const r=t.chunkFormat,s=t.dataHistogramsEnabled,o=i.dataHistogramChannelSpecifications,a=i.numChannelDimensions;if(function(e,t){if(Tb(e),HE(e),e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),t)return xb(e),e.setVertexMain("\nint vertexIndex1 = gl_VertexID / 6;\nint vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;\nvec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);\nvec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);\nemitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),\n         uProjectionMatrix * vec4(vertexPosition2, 1.0),\n         2.0);\n"),void e.setFragmentMain("\nemit(vec4(1.0, 1.0, 1.0, getLineAlpha()));\n");e.addVarying("highp vec3","vChunkPosition"),e.setVertexMain("\nvec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);\ngl_Position = uProjectionMatrix * vec4(position, 1.0);\ngl_Position.z = 0.0;\nvChunkPosition = (position - uTranslation) +\n    0.001 * abs(uPlaneNormal);\n")}(e,null===r),e.addOutputBuffer("vec4","v4f_fragData0",0),e.addFragmentCode("\nvoid emit(vec4 color) {\n  v4f_fragData0 = color;\n}\n"),null===r)return;$b(e,r,a,"vChunkPosition");const l=o.length;if(s&&l>0){let t="";const n=r.dataType;for(let i=0;i<l;++i){const r=o[i].channel,s=`out_histogram${i}`;e.addOutputBuffer("vec4",s,1+i);const a=`getDataValue(${r.join(",")})`,l=`invlerpForHistogram${i}`;e.addFragmentCode(nh(e,l,n,!1)),e.addFragmentCode(`\nfloat getHistogramValue${i}() {\n  return invlerpForHistogram${i}(${a});\n}\n`),t+=`{\nfloat x = getHistogramValue${i}();\nif (x < 0.0) x = 0.0;\nelse if (x > 1.0) x = 1.0;\nelse x = (1.0 + x * 253.0) / 255.0;\n${s} = vec4(x, x, x, 1.0);\n}`}e.addFragmentCode(`void userMain();\nvoid main() {\n  ${t}\n  userMain();\n}\n#define main userMain\n`)}this.defineShader(e,n)},getContextKey:e=>{var t;return`${null===(t=e.chunkFormat)||void 0===t?void 0:t.shaderKey}/${e.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){let t=this.tempChunkPosition;for(const n of this.visibleSourcesList){const i=n.source,r=n.chunkTransform;if(!Ha(t,e,this.localPosition.value,r.layerRank,r.combinedGlobalLocalToChunkTransform))continue;const s=i.getValueAt(t,r);if(null!=s)return s}return null}beginChunkFormat(e,t,n){const i=this.gl,r=this.dataHistogramSpecifications.visibility.visible,s=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:r}),o=s.shader,a=s.parameters,l=s.fallback;if(null!==o&&(o.bind(),function(e,t,n){n&&kb(e,t,1)}(o,n,null===t),null!==t)){if(r){const e=s.extraParameters.dataHistogramChannelSpecifications.length,n=this.dataHistogramSpecifications.bounds.value;for(let i=0;i<e;++i)rh(o,`invlerpForHistogram${i}`,t.dataType,n[i])}this.initializeShader(e,o,a,l),t.beginDrawing(i,o)}return s}endSlice(e,t,n){}draw(e){const t=e.sliceView,n=t.visibleLayers.get(this).visibleSources;if(0===n.length)return;const i=e.projectionParameters,r=e.wireFrame,s=this.gl;this.vertexIdHelper.enable();const o=ti(),a=this.renderScaleHistogram;void 0!==a&&a.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let l,c,d=null;const u=ti(),h=()=>{null!==d&&(null!==c&&c.endDrawing(s,d),this.endSlice(t,d,l.parameters))};let p=!0;for(const f of n){const e=Wh(i,f.chunkLayout),n=f.chunkTransform.channelToChunkDimensionIndices,g=f.source,m=f.fixedPositionWithinChunk,v=f.chunkDisplayDimensionIndices;for(const t of v)m[t]=0;const y=r?null:g.chunkFormat;if(y!==c&&(c=y,h(),l=this.beginChunkFormat(t,y,i),d=l.shader),null===d)continue;const b=g.chunks;u.fill(1);let S,w=e.size;const x=g.spec.rank;YE(s,d,t,i.viewProjectionMat,f,e),null!==y&&y.beginSource(s,d),p=!0;let C=0,k=0;if(t.forEachVisibleChunk(f,e,(e=>{let t=b.get(e);if(t&&t.state===el.GPU_MEMORY){let e=t.chunkDataSize;if(e!==S){S=e;for(let e=0;e<3;++e){const t=v[e];u[e]=-1===t||t>=x?1:S[t]}ZE(s,d,u)}const i=t.chunkGridPosition;for(let t=0;t<3;++t){const e=v[t];o[t]=-1===e||e>=x?0:w[t]*i[e]}null!==y&&y.bindChunk(s,d,t,m,v,n,p),p=!1,XE(s,d,o,r),++C}else++k})),(0!==C||0!==k)&&void 0!==a){const e=f.effectiveVoxelSize,t=KE(e[0],e[1],e[2]);a.add(t,t/i.pixelSize,C,k)}}if(h(),this.vertexIdHelper.disable(),!e.wireFrame){const e=this.getDataHistogramCount();e>0&&t.computeHistograms(e,this.dataHistogramSpecifications)}}}class eL{constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new Am}update(){let e=this.disjointSets;const t=e.generation;if(this.generation!==t){this.generation=t;let i=this.hashMap;i.clear();for(let t of e.mappings()){var n=O(t,2);let e=n[0],r=n[1];i.set(e,r)}}}}class tL extends QE{constructor(e,t){super(e,{shaderParameters:new Nn((e=>({hasEquivalences:e.registerDisposer(Rn((e=>0!==e.size),[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:e.registerDisposer(Rn((e=>0!==e.size),[t.segmentStatedColors])),hasSegmentDefaultColor:e.registerDisposer(Rn((e=>void 0!==e),[t.segmentDefaultColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring}))),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentationGroupState=this.displayState.segmentationGroupState.value,this.segmentColorShaderManager=new sv("segmentColorHash"),this.segmentStatedColorShaderManager=new cv("segmentStatedColor"),this.hashTableManager=new nv("visibleSegments"),this.gpuHashTable=this.registerDisposer(tv.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=tv.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesShaderManager=new iv("equivalences"),this.equivalencesHashMap=new eL(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new eL(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(tv.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(tv.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),Ay(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;null===(e=this.gpuSegmentStatedColorHashTable)||void 0===e||e.dispose()}getSources(e){return this.multiscaleSource.getSources((0,i.bn)((0,i.bn)({},e),{discreteValues:!0}))}defineShader(e,t){this.hashTableManager.defineShader(e);let n="\nuint64_t getUint64DataValue() {\n  uint64_t x = toUint64(getDataValue());\n";n+="return x;\n}\n",e.addFragmentCode("\nuint64_t getUint64DataValue() {\n  uint64_t x = toUint64(getDataValue());\nreturn x;\n}\n"),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`\nuint64_t getMappedObjectId(uint64_t value) {\n  uint64_t mappedValue;\n  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {\n    return mappedValue;\n  }\n  return value;\n}\n`)):e.addFragmentCode("\nuint64_t getMappedObjectId(uint64_t value) {\n  return value;\n}\n"),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uShowAllSegments"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let i=`\n  uint64_t baseValue = getUint64DataValue();\n  uint64_t value = getMappedObjectId(baseValue);\n  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};\n\n  float alpha = uSelectedAlpha;\n  float saturation = uSaturation;\n`;t.hideSegmentZero&&(i+="\n  if (value.value[0] == 0u && value.value[1] == 0u) {\n    emit(vec4(vec4(0, 0, 0, 0)));\n    return;\n  }\n"),i+=`\n  bool has = uShowAllSegments != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);\n  if (uSelectedSegment == value.value) {\n    float adjustment = has ? 0.5 : 0.75;\n    if (saturation > adjustment) {\n      saturation -= adjustment;\n    } else {\n      saturation += adjustment;\n    }\n  } else if (!has) {\n    alpha = uNotSelectedAlpha;\n  }\n`;let r="vec3 getMappedIdColor(uint64_t value) {\n";t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),r+=`\n  vec3 rgb;\n  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgb)) {\n    return rgb;\n  }\n`),t.hasSegmentDefaultColor?(e.addUniform("highp vec3","uSegmentDefaultColor"),r+="  return uSegmentDefaultColor;\n"):(this.segmentColorShaderManager.defineShader(e),r+="  return segmentColorHash(value);\n"),r+="\n}\n",e.addFragmentCode(r),i+="\n  vec3 rgb = getMappedIdColor(valueForColor);\n  emit(vec4(mix(vec3(1.0,1.0,1.0), rgb, saturation), alpha));\n",e.setFragmentMain(i)}initializeShader(e,t,n){const i=this.gl,r=this.displayState,s=this.segmentationGroupState,o=this.displayState.segmentSelectionState;var a=this.displayState;const l=a.segmentDefaultColor.value,c=a.segmentColorHash.value,d=vp(s),u=this.displayState.ignoreNullVisibleSet.value;let h=0,p=0;if(o.hasSelectedSegment){let e=o.selectedSegment;h=e.low,p=e.high}if(i.uniform1f(t.uniform("uSelectedAlpha"),r.selectedAlpha.value),i.uniform1f(t.uniform("uSaturation"),r.saturation.value),i.uniform1f(t.uniform("uNotSelectedAlpha"),r.notSelectedAlpha.value),i.uniform2ui(t.uniform("uSelectedSegment"),h,p),i.uniform1ui(t.uniform("uShowAllSegments"),d.hashTable.size||!u?0:1),this.hashTableManager.enable(i,t,s.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),n.hasEquivalences){const e=s.useTemporarySegmentEquivalences.value;(e?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(i,t,e?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}if(void 0===l?this.segmentColorShaderManager.enable(i,t,c):i.uniform3fv(t.uniform("uSegmentDefaultColor"),l),n.hasSegmentStatedColors){const e=this.displayState.segmentStatedColors.value;let n=this.gpuSegmentStatedColorHashTable;(void 0===n||n.hashTable!==e.hashTable)&&(n?.dispose(),this.gpuSegmentStatedColorHashTable=n=tv.get(i,e.hashTable)),this.segmentStatedColorShaderManager.enable(i,t,n)}}endSlice(e,t,n){const i=this.gl;this.hashTableManager.disable(i,t),n.hasEquivalences&&this.equivalencesShaderManager.disable(i,t),n.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(i,t),super.endSlice(e,t,n)}}function nL(){return new Ln(arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,ss)}const iL=Float32Array.from([0,0,0,0,0,1,9,1,0,0,1,0,1,10,0,1,0,0,1,1,11,1,1,0,1,1,1,12,0,0,0,0,1,0,13,0,0,1,0,1,1,14,1,0,0,1,1,0,15,1,0,1,1,1,1,16,0,0,0,1,0,0,17,0,0,1,1,0,1,18,0,1,0,1,1,0,19,0,1,1,1,1,1,20]),rL=qn(),sL=new Float32Array(6);let oL=class extends Xh{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl))}defineShader(e){Tb(e);const t=this.rank;Uu(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,n){Kn(rL,t.modelViewProjectionMatrix),function(e,t){t[0]=t[1]=t[2]=Number.POSITIVE_INFINITY,t[3]=t[4]=t[5]=Number.NEGATIVE_INFINITY;for(let n=0;n<8;++n){$i[0]=2*(1&n)-1,$i[1]=2*(n>>>1&1)-1,$i[2]=2*(n>>>2&1)-1,pi($i,$i,e);for(let e=0;e<3;++e){const n=$i[e];t[e]=Math.min(t[e],n),t[e+3]=Math.max(t[e+3],n)}}}(rL,sL);const i=t.chunkDisplayTransform.numChunkDisplayDims;for(let r=0;r<i;++r)sL[r]=0,sL[r+3]=0;for(let r=i;r<3;++r){const e=Math.abs(sL[r+3]-sL[r]);sL[r]-=e,sL[r+3]+=e}super.enable(e,t,(e=>{const i=e.vertexShaderInputBinders.Bounds;i.enable(1);const r=this.gl;r.uniform3fv(e.uniform("uModelSpaceBoundOffsets"),sL),r.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),i.bind(this.geometryDataStride,t.bufferOffset);const s=this.vertexIdHelper;s.enable(),n(e),s.disable(),i.disable()}))}};function aL(e){e.addVertexCode("\nvoid setBoundingBoxBorderWidth(float width) {}\nvoid setBoundingBoxBorderColor(vec4 color) {}\n")}function lL(e){e.addVertexCode("\nvoid setBoundingBoxFillColor(vec4 color) {}\n")}function cL(e){lL(e),e.addVertexCode("\nfloat ng_lineWidth;\nvoid setBoundingBoxBorderWidth(float size) {\n  ng_lineWidth = size;\n}\nvoid setBoundingBoxBorderColor(vec4 color) {\n  vColor = color;\n}\n")}Qh(Zs.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:class extends oL{constructor(){super(...arguments),this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",(e=>{const t=this.rank;super.defineShader(e),HE(e),xb(e),e.addVarying("highp float","vClipCoefficient"),cL(e),e.setVertexMain(`\nfloat modelPositionA[${t}] = getBounds0();\nfloat modelPositionB[${t}] = getBounds1();\nfor (int i = 0; i < ${t}; ++i) {\n  float a = modelPositionA[i];\n  float b = modelPositionB[i];\n  modelPositionA[i] = min(a, b);\n  modelPositionB[i] = max(a, b);\n}\nvClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);\nif (vClipCoefficient == 0.0) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\nvec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];\nvec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];\nint vertexIndex1 = gl_VertexID / 6;\nint vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;\nvec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);\nvec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);\nng_lineWidth = 1.0;\n${this.invokeUserMain}\nemitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),\n         uModelViewProjection * vec4(vertexPosition2, 1.0),\n         ng_lineWidth);\n${this.setPartIndex(e)};\n`),e.setFragmentMain("\nemitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));\n")})),this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",(e=>{const t=this.rank;super.defineShader(e),HE(e),e.addVarying("highp float","vClipCoefficient"),function(e){aL(e),e.addVertexCode("\nvoid setBoundingBoxFillColor(vec4 color) {\n  vColor = color;\n}\n")}(e),e.setVertexMain(`\nfloat modelPositionA[${t}] = getBounds0();\nfloat modelPositionB[${t}] = getBounds1();\nfor (int i = 0; i < ${t}; ++i) {\n  float a = modelPositionA[i];\n  float b = modelPositionB[i];\n  modelPositionA[i] = min(a, b);\n  modelPositionB[i] = max(a, b);\n}\nvClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);\nif (vClipCoefficient == 0.0) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\nvec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];\nvec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];\nint vertexIndex = gl_VertexID;\nvec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);\ngl_Position = uModelViewProjection * vec4(vertexPosition, 1);\n${this.invokeUserMain}\n${this.setPartIndex(e)};\n`),e.setFragmentMain("\nemitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));\n")}))}enableForBoundingBox(e,t,n){super.enable(e,t,(e=>{const i=t.renderContext.sliceView.projectionParameters.value;JE(e,i.viewportNormalInGlobalCoordinates,i.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),n(e)}))}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,(()=>{!function(e,t,n,i,r){e.drawArraysInstanced(t,n,i,r)}(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)})),this.enableForBoundingBox(this.faceShaderGetter,e,(t=>{kb(t,e.renderContext.projectionParameters,1),Cb(t.gl,6,e.count)}))}},perspectiveViewRenderHelper:class extends oL{constructor(){super(...arguments),this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(nu.fromData(this.gl,Ft(iL,7,1,6))),this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",(e=>{const t=this.rank;this.defineShader(e),xb(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),cL(e),e.setVertexMain(`\nfloat modelPositionA[${t}] = getBounds0();\nfloat modelPositionB[${t}] = getBounds1();\nvec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];\nvec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];\nvec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);\nvec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);\nvClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);\nif (vClipCoefficient == 0.0) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\nng_lineWidth = 1.0;\n${this.invokeUserMain}\nemitLine(uModelViewProjection * vec4(endpointA, 1.0),\n         uModelViewProjection * vec4(endpointB, 1.0),\n         ng_lineWidth);\n${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};\n`),e.setFragmentMain("\nemitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));\n")})),this.boxCornerOffsetsBuffer=this.registerDisposer(nu.fromData(this.gl,Ft($E,3,1,6))),this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",(e=>{const t=this.rank;this.defineShader(e),yb(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),cL(e),e.setVertexMain(`\nfloat modelPositionA[${t}] = getBounds0();\nfloat modelPositionB[${t}] = getBounds1();\nvClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);\nif (vClipCoefficient == 0.0) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\nvec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];\nvec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];\nvec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);\nemitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);\nuint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);\nuint cornerPickOffset = 1u + cornerIndex;\n${this.setPartIndex(e,"cornerPickOffset")};\n`),e.setFragmentMain("\nvec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);\nvec4 color = getCircleColor(vColor, borderColor);\ncolor.a *= vClipCoefficient;\nemitAnnotation(color);\n")}))}drawEdges(e){const t=this.gl;this.enable(this.edgeShaderGetter,e,(n=>{const i=n.attribute("aBoxCornerOffset1"),r=n.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1,28,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,4,WebGL2RenderingContext.FLOAT,!1,28,12),kb(n,e.renderContext.projectionParameters,1),Cb(t,12,e.count),t.disableVertexAttribArray(i),t.disableVertexAttribArray(r)}))}drawCorners(e){const t=this.gl;this.enable(this.cornerShaderGetter,e,(n=>{const i=n.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(i,3,WebGL2RenderingContext.FLOAT,!1),bb(n,e.renderContext.projectionParameters,{featherWidthInPixels:0}),Sb(n.gl,8,e.count),t.disableVertexAttribArray(i)}))}draw(e){this.drawEdges(e),this.drawCorners(e)}},defineShaderNoOpSetters(e){lL(e),aL(e)},pickIdsPerInstance:27,snapPosition(e,t,n,i){const r=e.length,s=new Float32Array(t,n,2*r);i>=1&&i<9&&function(e,t){const n=e.length;for(let i=0;i<n;++i){const r=t[i],s=t[i+n],o=e[i];e[i]=Math.abs(r-o)<Math.abs(s-o)?r:s}}(e,s)},getRepresentativePoint(e,t,n){e.set(t.pointA)},updateViaRepresentativePoint(e,t,n){const r=t.length,s=e.pointA,o=e.pointB,a=new Float32Array(r),l=new Float32Array(r);for(let i=0;i<r;++i){const e=a[i]=t[i];l[i]=o[i]+(e-s[i])}return(0,i.bn)((0,i.bn)({},e),{pointA:a,pointB:l})}});function dL(e){e.addVertexCode("\nvoid setEndpointMarkerSize(float startSize, float endSize) {}\nvoid setEndpointMarkerBorderWidth(float startSize, float endSize) {}\nvoid setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}\nvoid setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}\n")}function uL(e){e.addVertexCode("\nvoid setLineWidth(float width) {}\nvoid setLineColor(vec4 startColor, vec4 endColor) {}\n")}let hL=class extends Xh{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",(e=>{const t=this.rank;this.defineShader(e),xb(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode("\nfloat ng_LineWidth;\n"),dL(e),e.addVertexCode("\nvoid setLineWidth(float width) {\n  ng_LineWidth = width;\n}\nvoid setLineColor(vec4 startColor, vec4 endColor) {\n  vColor = mix(startColor, endColor, getLineEndpointCoefficient());\n}\n"),e.setVertexMain(`\nfloat modelPositionA[${t}] = getVertexPosition0();\nfloat modelPositionB[${t}] = getVertexPosition1();\nfor (int i = 0; i < ${t}; ++i) {\n  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());\n}\nng_LineWidth = 1.0;\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\n${this.invokeUserMain}\nemitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),\n         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),\n         ng_LineWidth);\n${this.setPartIndex(e)};\n`),e.setFragmentMain(`\nfloat clipCoefficient = getSubspaceClipCoefficient(vModelPosition);\nemitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *\n                                ${this.getCrossSectionFadeFactor()} *\n                                clipCoefficient));\n`)})),this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",(e=>{const t=this.rank;this.defineShader(e),yb(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),uL(e),e.addVertexCode("\nfloat ng_markerDiameter;\nfloat ng_markerBorderWidth;\nint getEndpointIndex() {\n  return gl_VertexID / 6;\n}\nvoid setEndpointMarkerSize(float startSize, float endSize) {\n  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));\n}\nvoid setEndpointMarkerBorderWidth(float startSize, float endSize) {\n  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));\n}\nvoid setEndpointMarkerColor(vec4 startColor, vec4 endColor) {\n  vColor = mix(startColor, endColor, float(getEndpointIndex()));\n}\nvoid setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {\n  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));\n}\n"),e.setVertexMain(`\nfloat modelPosition[${t}] = getVertexPosition0();\nfloat modelPositionB[${t}] = getVertexPosition1();\nfor (int i = 0; i < ${t}; ++i) {\n  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));\n}\nvClipCoefficient = getSubspaceClipCoefficient(modelPosition);\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\nvBorderColor = vec4(0.0, 0.0, 0.0, 1.0);\nng_markerDiameter = 5.0;\nng_markerBorderWidth = 1.0;\n${this.invokeUserMain}\nemitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);\n${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};\n`),e.setFragmentMain("\nvec4 color = getCircleColor(vColor, vBorderColor);\ncolor.a *= vClipCoefficient;\nemitAnnotation(color);\n")}))}defineShader(e){Tb(e);const t=this.rank;Uu(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,n){super.enable(e,t,(e=>{const i=e.vertexShaderInputBinders.VertexPosition;i.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),i.bind(this.geometryDataStride,t.bufferOffset);const r=this.vertexIdHelper;r.enable(),n(e),r.disable(),i.disable()}))}drawEdges(e){this.enable(this.edgeShaderGetter,e,(t=>{kb(t,e.renderContext.projectionParameters,1),Cb(t.gl,1,e.count)}))}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,(t=>{bb(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Sb(t.gl,2,e.count)}))}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};Qh(Zs.LINE,{sliceViewRenderHelper:hL,perspectiveViewRenderHelper:hL,defineShaderNoOpSetters(e){dL(e),uL(e)},pickIdsPerInstance:3,snapPosition(e,t,n,i){const r=e.length,s=new Float32Array(t,n,2*r);0===i?function(e,t){const n=e.length;Oi(e,t.subarray(0,n),t.subarray(n),e)}(e,s):function(e,t,n){const i=e.length,r=i*n;for(let s=0;s<i;++s)e[s]=t[r+s]}(e,s,i-1)},getRepresentativePoint(e,t,n){e.set(0===n||1===n?t.pointA:t.pointB)},updateViaRepresentativePoint(e,t,n){let r=(0,i.bn)({},e);const s=t.length;switch(n){case 0:{const n=e.pointA,r=e.pointB,o=new Float32Array(s),a=new Float32Array(s);for(let e=0;e<s;++e){const i=o[e]=t[e];a[e]=r[e]+(i-n[e])}return(0,i.bn)((0,i.bn)({},e),{pointA:o,pointB:a})}case 1:return(0,i.bn)((0,i.bn)({},e),{pointA:new Float32Array(t)});case 2:return(0,i.bn)((0,i.bn)({},e),{pointB:new Float32Array(t)})}return r}});let pL=class extends Xh{constructor(){super(...arguments),this.shaderGetter3d=this.getDependentShader("annotation/point:3d",(e=>{Tb(e),yb(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain("\nemitCircle(uModelViewProjection *\n           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);\n"),e.setFragmentMain("\nvec4 color = getCircleColor(vColor, vBorderColor);\nemitAnnotation(color);\n")})),this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,(t=>{Tb(t),xb(t,!0),this.defineShaderCommon(t),t.addVertexMain(`\nvec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);\nvec3 subspacePositionB = subspacePositionA;\nvec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);\nvec4 zCoeffs = uModelViewProjection[${e}];\nfloat minZ = 1e30;\nfloat maxZ = -1e30;\nfor (int i = 0; i < 3; ++i) {\n  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)\n  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])\n  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1\n  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];\n  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;\n  if (k1 != 0.0) {\n    minZ = min(minZ, q1);\n    maxZ = max(maxZ, q1);\n  }\n  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)\n  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])\n  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2\n  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];\n  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;\n  if (k2 != 0.0) {\n    minZ = min(minZ, q2);\n    maxZ = max(maxZ, q2);\n  }\n}\nif (minZ > maxZ) minZ = maxZ = 0.0;\nsubspacePositionA[${e}] = minZ;\nsubspacePositionB[${e}] = maxZ;\nemitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);\n`),t.setFragmentMain(`\nvec4 color = getRoundedLineColor(vColor, vBorderColor);\nemitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));\n`)})),this.shaderGetter2d=this.makeShaderGetter2d(2),this.shaderGetter1d=this.makeShaderGetter2d(1),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl))}defineShaderCommon(e){const t=this.rank;Uu(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode("\nfloat ng_markerDiameter;\nfloat ng_markerBorderWidth;\nvoid setPointMarkerSize(float size) {\n  ng_markerDiameter = size;\n}\nvoid setPointMarkerBorderWidth(float size) {\n  ng_markerBorderWidth = size;\n}\nvoid setPointMarkerColor(vec4 color) {\n  vColor = color;\n}\nvoid setPointMarkerBorderColor(vec4 color) {\n  vBorderColor = color;\n}\n"),e.addVertexMain(`\nng_markerDiameter = 5.0;\nng_markerBorderWidth = 1.0;\nvBorderColor = vec4(0.0, 0.0, 0.0, 1.0);\nfloat modelPosition[${t}] = getVertexPosition0();\nfloat clipCoefficient = getSubspaceClipCoefficient(modelPosition);\nif (clipCoefficient == 0.0) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\n${this.invokeUserMain}\nvColor.a *= clipCoefficient;\nvBorderColor.a *= clipCoefficient;\n${this.setPartIndex(e)};\n`)}enable(e,t,n){super.enable(e,t,(e=>{const i=e.vertexShaderInputBinders.VertexPosition;i.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),i.bind(this.geometryDataStride,t.bufferOffset);const r=this.vertexIdHelper;r.enable(),n(e),r.disable(),i.disable()}))}draw(e){const t=e.chunkDisplayTransform.numChunkDisplayDims;switch(t){case 3:this.enable(this.shaderGetter3d,e,(t=>{bb(t,e.renderContext.projectionParameters,{featherWidthInPixels:1}),Sb(t.gl,1,e.count)}));break;case 2:case 1:this.enable(2===t?this.shaderGetter2d:this.shaderGetter1d,e,(t=>{kb(t,e.renderContext.projectionParameters,1),Cb(t.gl,1,e.count)}))}}};Qh(Zs.POINT,{sliceViewRenderHelper:pL,perspectiveViewRenderHelper:pL,defineShaderNoOpSetters(e){e.addVertexCode("\nvoid setPointMarkerSize(float size) {}\nvoid setPointMarkerBorderWidth(float size) {}\nvoid setPointMarkerColor(vec4 color) {}\nvoid setPointMarkerBorderColor(vec4 color) {}\n")},pickIdsPerInstance:1,snapPosition(e,t,n){e.set(new Float32Array(t,n,e.length))},getRepresentativePoint(e,t){e.set(t.point)},updateViaRepresentativePoint:(e,t)=>(0,i.bn)((0,i.bn)({},e),{point:new Float32Array(t)})});const fL="\nstruct EllipseQuadraticForm {\n  highp float A;  // x*x coefficient\n  highp float B;  // x*y coefficient\n  highp float C;  // y*y coefficient\n  highp float D;  // x coefficient\n  highp float E;  // y coefficient\n  highp float F;  // 1 coefficient\n};\n",gL=[fL,"\nEllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {\n  EllipseQuadraticForm p;\n  p.A = A[0][0];\n  p.B = A[0][1] + A[1][0];\n  p.C = A[1][1];\n  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +\n        c[2] * (A[0][2] + A[2][0]);\n  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +\n        c[2] * (A[1][2] + A[2][1]);\n  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -\n        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -\n        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;\n  return p;\n}\n"],mL=[fL,"\nstruct CenterOrientEllipse {\n  vec2 k;   // center\n  vec2 u1;  // minor axis direction\n  vec2 u2;  // major axis direction\n  float a;  // semimajor axis\n  float b;  // semiminor axis\n  bool valid; // indicates if the ellipse is valid\n};\n","\nCenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {\n  CenterOrientEllipse r;\n  float a11 = p.A;\n  float a12 = p.B / 2.0;\n  float a22 = p.C;\n  float b1 = p.D;\n  float b2 = p.E;\n  float c = p.F;\n  float kdenom = 2.0 * (a12 * a12 - a11 * a22);\n  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;\n  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;\n  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);\n  float m11 = mu * a11;\n  float m12 = mu * a12;\n  float m22 = mu * a22;\n  float lambdaTerm1 = m11 + m22;\n  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);\n  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);\n  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);\n  r.a = 1.0 / sqrt(lambda1);\n  r.b = 1.0 / sqrt(lambda2);\n  r.valid = lambda1 > 0.0 && lambda2 > 0.0;\n  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {\n    r.u1 = vec2(1.0, 0.0);\n  } else if (m11 >= m22) {\n    r.u1 = normalize(vec2(lambda1 - m22, m12));\n  } else {\n    r.u1 = normalize(vec2(m12, lambda1 - m11));\n  }\n  r.u2 = vec2(-r.u1.y, r.u1.x);\n  return r;\n}\n"],vL=qn();let yL=class extends Xh{defineShader(e){const t=this.rank;Uu(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`\nstruct SubspaceParams {\n  highp vec3 subspaceCenter;\n  highp vec3 subspaceRadii;\n  highp float clipCoefficient;\n  bool cull;\n};\nSubspaceParams getSubspaceParams() {\n  SubspaceParams params;\n  highp float modelCenter[${t}] = getCenterAndRadii0();\n  highp float modelRadii[${t}] = getCenterAndRadii1();\n  float radiusAdjustment = 1.0;\n  float clipCoefficient = 1.0;\n  for (int i = 0; i < ${t}; ++i) {\n    float r = modelRadii[i];\n    float c = modelCenter[i];\n    float x = uModelClipBounds[i];\n    float clipRadius = uModelClipBounds[i + ${t}];\n    if (r != 0.0 && clipRadius != 0.0) {\n      float d = c - x;\n      d = d * d;\n      radiusAdjustment -= d / (r * r);\n    }\n    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;\n    clipCoefficient *= max(0.0, 1.0 - e);\n  }\n  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));\n  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);\n  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;\n  params.clipCoefficient = clipCoefficient;\n  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;\n  return params;\n}\nvoid setEllipsoidFillColor(vec4 color) {\n  vColor = color;\n}\n`)}enable(e,t,n){super.enable(e,t,(e=>{const i=e.vertexShaderInputBinders.CenterAndRadii;i.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),i.bind(this.geometryDataStride,t.bufferOffset),n(e),i.disable()}))}};Qh(Zs.ELLIPSOID,{sliceViewRenderHelper:class extends yL{constructor(){super(...arguments),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",(e=>{Tb(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(gL),e.addVertexCode(mL),e.addVertexCode(pb),e.setVertexMain(`\nSubspaceParams params = getSubspaceParams();\nif (params.cull) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\nvClipCoefficient = params.clipCoefficient;\nmat3 Aobject = mat3(0.0);\nfor (int i = 0; i < 3; ++i) {\n  float r = max(params.subspaceRadii[i], 1e-3);\n  Aobject[i][i] = 1.0 / (r * r);\n}\nmat3 RviewportToObject = mat3(uViewportToObject);\nmat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;\nvec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;\nEllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);\nvec2 u1, u2;\nfloat a, b;\nCenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);\nvec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));\nvec2 viewportCorner = centerOrient.k +\n  centerOrient.u1 * cornerOffset.x * centerOrient.a +\n  centerOrient.u2 * cornerOffset.y * centerOrient.b;\nif (centerOrient.valid) {\n  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);\n} else {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n}\nvCircleCoord = cornerOffset;\n${this.invokeUserMain}\n${this.setPartIndex(e)};\n`),e.setFragmentMain("\nif (dot(vCircleCoord, vCircleCoord) > 1.0) {\n  discard;\n}\nemitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));\n")})),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,(t=>{const n=t.gl,i=e.renderContext.sliceView.projectionParameters.value,r=Qn(vL,e.renderSubspaceInvModelMatrix,i.invViewMatrix);n.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,r),n.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,i.projectionMat);const s=vL;Kn(s,r),n.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,s);const o=this.vertexIdHelper;o.enable(),fb(n,1,e.count),o.disable()}))}},perspectiveViewRenderHelper:class extends yL{constructor(){super(...arguments),this.sphereRenderHelper=this.registerDisposer(new vb(this.gl,10,10)),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",(e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`\nSubspaceParams params = getSubspaceParams();\nif (params.cull) {\n  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);\n  return;\n}\nvClipCoefficient = params.clipCoefficient;\n${this.invokeUserMain}\nemitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);\n${this.setPartIndex(e)};\n`),e.setFragmentMain("\nemitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));\n")})),this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,(t=>{const n=t.gl;let i=this.tempLightVec;var r=e.renderContext;let s=r.lightDirection,o=r.ambientLighting;di(i,s,r.directionalLighting),i[3]=o,n.uniform4fv(t.uniform("uLightDirection"),i),n.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,Xn(qn(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)}))}},defineShaderNoOpSetters(e){e.addVertexCode("\nvoid setEllipsoidFillColor(vec4 color) {}\n")},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(e,t){e.set(t.center)},updateViaRepresentativePoint:(e,t)=>(0,i.bn)((0,i.bn)({},e),{center:new Float32Array(t)})});function bL(e){e.addVertexCode("\n void setAxisEndpointMarkerSize(float startSize, float endSize) {}\n void setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {}\n void setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {}\n void setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}\n ")}function SL(e){e.addVertexCode("\n void setAxisWidth(float width) {}\n void setAxisColor(vec4 startColor, vec4 endColor) {}\n ")}function wL(e){e.addVertexCode("\n void setSphereColor(vec4 color) {}\n ")}class xL extends Xh{constructor(){super(...arguments),this.sphereShader=this.registerDisposer(new wb(this.gl)),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/sphere/axis",(e=>{const t=this.rank;this.defineShader(e),xb(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode("\nfloat ng_LineWidth;\n"),bL(e),wL(e),e.addVertexCode("\nvoid setAxisWidth(float width) {\n  ng_LineWidth = width;\n}\nvoid setAxisColor(vec4 startColor, vec4 endColor) {\n  vColor = mix(startColor, endColor, getLineEndpointCoefficient());\n}\n"),e.setVertexMain(`\nfloat modelPositionA[${t}] = getVertexPosition0();\nfloat modelPositionB[${t}] = getVertexPosition1();\nfor (int i = 0; i < ${t}; ++i) {\n  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());\n}\nng_LineWidth = 1.0;\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\n${this.invokeUserMain}\nemitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),\n         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),\n         ng_LineWidth);\n${this.setPartIndex(e)};\n`),e.setFragmentMain(`\nfloat clipCoefficient = getSubspaceClipCoefficient(vModelPosition);\nemitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *\n                                ${this.getCrossSectionFadeFactor()} *\n                                clipCoefficient));\n`)})),this.endpointShaderGetter=this.getDependentShader("annotation/sphere/endpoint",(e=>{const t=this.rank;this.defineShader(e),yb(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),SL(e),wL(e),e.addVertexCode("\nfloat ng_markerDiameter;\nfloat ng_markerBorderWidth;\nint getEndpointIndex() {\n  return gl_VertexID / 6;\n}\nvoid setAxisEndpointMarkerSize(float startSize, float endSize) {\n  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));\n}\nvoid setAxisEndpointMarkerBorderWidth(float startSize, float endSize) {\n  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));\n}\nvoid setAxisEndpointMarkerColor(vec4 startColor, vec4 endColor) {\n  vColor = mix(startColor, endColor, float(getEndpointIndex()));\n}\nvoid setAxisEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {\n  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));\n}\n"),e.setVertexMain(`\nfloat modelPosition[${t}] = getVertexPosition0();\nfloat modelPositionB[${t}] = getVertexPosition1();\nfor (int i = 0; i < ${t}; ++i) {\n  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));\n}\nvClipCoefficient = getSubspaceClipCoefficient(modelPosition);\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\nvBorderColor = vec4(0.0, 0.0, 0.0, 1.0);\nng_markerDiameter = 5.0;\nng_markerBorderWidth = 1.0;\n${this.invokeUserMain}\nemitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);\n${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};\n`),e.setFragmentMain("\nvec4 color = getCircleColor(vColor, vBorderColor);\ncolor.a *= vClipCoefficient;\nemitAnnotation(color);\n")})),this.sphereShadeGetter=this.getDependentShader("annotation/sphere/sphere",(e=>{const t=this.rank;this.defineShader(e),this.sphereShader.defineShader(e),e.addVarying("highp float","vClipCoefficient"),SL(e),bL(e),e.addVertexCode("\n void setSphereColor(vec4 color) {\n   vColor = color;\n }\n "),e.setVertexMain(`\n float modelPosition[${t}] = getVertexPosition0();\n float modelPositionB[${t}] = getVertexPosition1();\n float diameter = 0.0;\n for (int i = 0; i < ${t}; ++i) {\n   float dx = modelPosition[i] - modelPositionB[i];\n   diameter += dx * dx;\n   modelPosition[i] = (modelPosition[i] + modelPositionB[i]) * 0.5;\n }\n float radius = sqrt(diameter) * 0.5;\n if (radius > 0.0) {\n   vClipCoefficient = getRadiusAdjustment(vec3(modelPosition[0], modelPosition[1], modelPosition[2]), radius);\n } else {\n   vClipCoefficient = 1.0;\n }\n\n // vClipCoefficient = getSubspaceClipCoefficient(modelPosition);\n vColor = vec4(1.0, 0.0, 0.0, 0.5);\n // vColor = vec4(defaultColor(), 0.5);\n ${this.invokeUserMain}\n // float radius = diameter * 0.5;\n emitSphere(uModelViewProjection, uNormalTransform, projectModelVectorToSubspace(modelPosition), vec3(radius, radius, radius), uLightDirection);\n ${this.setPartIndex(e)};\n `),e.setFragmentMain("\n     vec4 color = vColor;\n     color.a *= vClipCoefficient;\n     emitAnnotation(color);\n ")}))}defineShader(e){Tb(e);const t=this.rank;Uu(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];super.enable(e,t,(e=>{const r=e.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.serializedBytesPerAnnotation,t.bufferOffset);const s=this.vertexIdHelper;i&&s.enable(),n(e),i&&s.disable(),r.disable()}))}drawEdges(e){this.enable(this.edgeShaderGetter,e,(t=>{kb(t,e.renderContext.projectionParameters,1),Cb(t.gl,1,e.count)}))}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,(t=>{bb(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),Sb(t.gl,2,e.count)}))}drawSphere(e){this.enable(this.sphereShadeGetter,e,(t=>{this.sphereShader.draw(t,e,e.count)}),!1)}draw(e){this.drawEdges(e),this.drawEndpoints(e),this.drawSphere(e)}}Qh(Zs.SPHERE,{sliceViewRenderHelper:xL,perspectiveViewRenderHelper:xL,defineShaderNoOpSetters(e){bL(e),SL(e),wL(e)},pickIdsPerInstance:3,snapPosition(e,t,n,i){const r=e.length,s=new Float32Array(t,n,2*r);0===i?function(e,t){const n=e.length;Oi(e,t.subarray(0,n),t.subarray(n),e)}(e,s):function(e,t,n){const i=e.length,r=i*n;for(let s=0;s<i;++s)e[s]=t[r+s]}(e,s,i-1)},getRepresentativePoint(e,t,n){e.set(0===n||1===n?t.pointA:t.pointB)},updateViaRepresentativePoint(e,t,n){let r=(0,i.bn)({},e);const s=t.length;switch(n){case 0:{const n=e.pointA,r=e.pointB,o=new Float32Array(s),a=new Float32Array(s);for(let e=0;e<s;++e){const i=o[e]=t[e];a[e]=r[e]+(i-n[e])}return(0,i.bn)((0,i.bn)({},e),{pointA:o,pointB:a})}case 1:return(0,i.bn)((0,i.bn)({},e),{pointA:new Float32Array(t)});case 2:return(0,i.bn)((0,i.bn)({},e),{pointB:new Float32Array(t)})}return r}});const CL=qn(),kL=ti();function TL(e){e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),e.setFragmentMain("\nemit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);\n")}const EL={defineShader(e){TL(e),xb(e),e.addVertexCode("\nconst vec3[24] boxCornerOffsets = vec3[](\n  vec3(0, 0, 0), vec3(0, 0, 1),  // e1\n  vec3(1, 0, 0), vec3(1, 0, 1),  // e2\n  vec3(0, 1, 0), vec3(0, 1, 1),  // e3\n  vec3(1, 1, 0), vec3(1, 1, 1),  // e4\n  vec3(0, 0, 0), vec3(0, 1, 0),  // e5\n  vec3(0, 0, 1), vec3(0, 1, 1),  // e6\n  vec3(1, 0, 0), vec3(1, 1, 0),  // e7\n  vec3(1, 0, 1), vec3(1, 1, 1),  // e8\n  vec3(0, 0, 0), vec3(1, 0, 0),  // e9\n  vec3(0, 0, 1), vec3(1, 0, 1),  // e10\n  vec3(0, 1, 0), vec3(1, 1, 0),  // e11\n  vec3(0, 1, 1), vec3(1, 1, 1)  // e12\n);\n"),e.setVertexMain("\nint edgeIndex = gl_VertexID / 6;\nvec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));\nvec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));\nvec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);\nvec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);\nemitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),\n         uProjectionMatrix * vec4(vertexPosition2, 1.0),\n         2.0);\n")},initialize(e,t){kb(e,t,1)},draw(e,t,n){const i=e.gl,r=CL,s=t.chunkLayout;Qn(r,n.viewProjectionMat,s.transform),i.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,r),i.uniform3fv(e.uniform("uChunkDataSize"),s.size),i.uniform3fv(e.uniform("uLowerClipBound"),t.lowerClipDisplayBound),i.uniform3fv(e.uniform("uUpperClipBound"),t.upperClipDisplayBound);const o=s.size,a=t.curPositionInChunks,l=t.chunkDisplayDimensionIndices,c=kL;for(let d=0;d<3;++d){const e=l[d];c[d]=(-1===e?0:a[e])*o[d]}i.uniform3fv(e.uniform("uTranslation"),c),Cb(i,12,1)}},LL={defineShader(e){HE(e),TL(e),xb(e),e.setVertexMain("\nint vertexIndex1 = gl_VertexID / 6;\nint vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;\nvec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);\nvec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);\nemitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),\n         uProjectionMatrix * vec4(vertexPosition2, 1.0),\n         2.0);\n")},initialize(e,t){kb(e,t,1)},draw(e,t,n){const i=e.gl,r=CL,s=t.chunkLayout;Qn(r,n.viewProjectionMat,s.transform),i.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,r),i.uniform3fv(e.uniform("uChunkDataSize"),s.size),i.uniform3fv(e.uniform("uLowerClipBound"),t.lowerClipDisplayBound),i.uniform3fv(e.uniform("uUpperClipBound"),t.upperClipDisplayBound);const o=s.size,a=t.curPositionInChunks,l=t.chunkDisplayDimensionIndices,c=kL;for(let d=0;d<3;++d){const e=l[d];c[d]=(-1===e?0:a[e])*o[d]}i.uniform3fv(e.uniform("uTranslation"),c),JE(e,n.viewportNormalInGlobalCoordinates,n.centerDataPosition,s.transform,s.invTransform),Cb(i,6,1)}};var IL=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};const DL=qn();let ML=class extends(Ed(dp)){constructor(e,t,n,i){super(i),this.chunkManager=e,this.source=t,this.segmentationStates=n,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:t.rpcId,segmentationStates:this.serializeDisplayState()});this.registerDisposer(n.changed.add((()=>{const e={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke("annotation/RenderLayer.updateSegmentation",e)})))}serializeDisplayState(){const e=this.segmentationStates.value;if(void 0!==e)return e.map((e=>null==e?e:Fy(e.segmentationGroupState.value)))}};ML=IL([yd("annotation/RenderLayer")],ML);class PL extends Sn{constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new ol,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new kn,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.segmentationStates=this.registerDisposer(Rn((e=>{var t=this.state;const n=t.displayState,i=t.source,r=n.relationshipStates;return n.displayUnfiltered.value?void 0:i.relationships.map((e=>{const t=r.get(e);return t.showMatches.value?t.segmentationState.value:void 0}))}),[this.state.displayState.relationshipStates],((e,t)=>void 0===e||void 0===t?e===t:Ut(e,t)))),this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(On(((e,t)=>{if(this.handleChangeAffectingBuffer(),void 0!==t)for(const n of t)null!=n&&e.registerDisposer(Bn(((e,t)=>{e.registerDisposer(t.visibleSegments.changed.add((()=>this.handleChangeAffectingBuffer()))),e.registerDisposer(t.segmentEquivalences.changed.add((()=>this.handleChangeAffectingBuffer())))}),n.segmentationGroupState))}),this.segmentationStates)),this.source instanceof go||(this.sharedObject=this.registerDisposer(new ML(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));const n=this.state.displayState;this.registerDisposer(n.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){const e=this.sharedObject;if(void 0!==e)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){const e=this.source;if(e instanceof go){const t=e.changed.count;if(this.generation!==t){let n=this.buffer;void 0===n&&(n=this.buffer=this.registerDisposer(new nu(this.chunkManager.gl))),this.generation=t;const i=this.serializedAnnotations=function(e,t){const n=new bo(e.annotationPropertySerializers);for(const i of e)(void 0===t||t(i))&&n.add(i);return n.serialize()}(e,function(e){if(void 0!==e)return t=>{const n=t.relatedSegments;if(void 0===n)return!1;for(let r=0,s=n.length;r<s;++r){const t=e[r];if(null==t)continue;var i=t.segmentationGroupState.value;const s=i.visibleSegments,o=i.segmentEquivalences;for(const e of n[r])if(s.has(o.get(e)))return!0}return!1}}(this.segmentationStates.value));n.setData(this.serializedAnnotations.data),this.numPickIds=Fp(i)}}}}function AL(e){const t=e.chunkTransform.modelTransform.unpaddedRank,n=new Float32Array(2*t),i=new Float32Array(3*t);i.fill(0),n.fill(1,t);const r=e.numChunkDisplayDims,s=e.chunkDisplayDimensionIndices;for(let o=0;o<r;++o){const e=s[o];n[t+e]=0,i[3*e+o]=1}return{modelClipBounds:n,renderSubspaceTransform:i}}function RL(e,t,n){n.clearMessages();const i=e=>{n.addMessage({severity:Sl.error,message:e})};if(void 0!==e.error)return i(e.error);const r=$a(e.modelTransform,t.displayDimensionIndices);let s;try{s=ja(e,r)}catch(a){return i(a.message)}var o=AL(s);return{chunkTransform:e,chunkDisplayTransform:s,modelClipBounds:o.modelClipBounds,renderSubspaceTransform:o.renderSubspaceTransform}}function NL(e,t){return class extends e{constructor(e,t){super(),this.base=e,this.renderScaleHistogram=t,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;const n=e.visibility;void 0!==n&&this.registerDisposer(n.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer((()=>{for(const e of this.renderHelpers)e.dispose()})),this.role=e.state.role,this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged()}handleRankChanged(){const e=this.base.source.rank;if(e===this.curRank)return;this.curRank=e,this.tempChunkPosition=new Float32Array(e);const n=this.renderHelpers,i=this.gl;for(const t of n)t.dispose();const r=this.base.source.properties,s=this.base.state.displayState;for(const o of Xs){const a=ep(o),l=a[t],c=n[o]=new l(i,o,e,r,s.shaderControls,s.fallbackShaderControls,s.shaderError);c.pickIdsPerInstance=a.pickIdsPerInstance,c.targetIsSliceView="sliceViewRenderHelper"===t}}attach(e){super.attach(e),this.handleRankChanged();const t=this.chunkTransform,n=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:n,chunkRenderParameters:RL(t,n,e.messages)}}updateAttachmentState(e){const t=e.state;this.handleRankChanged();const n=this.chunkTransform,i=e.view.displayDimensionRenderInfo.value;return void 0!==t&&t.chunkTransform===n&&t.displayDimensionRenderInfo===i?t.chunkRenderParameters:(t.chunkTransform=n,t.displayDimensionRenderInfo=i,t.chunkRenderParameters=RL(n,i,e.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(e,t){const n=t.modelClipBounds,i=this.curRank,r=t.chunkTransform;Ha(n.subarray(0,i),e.projectionParameters.globalPosition,this.base.state.localPosition.value,r.layerRank,r.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(!e.bufferValid){let t=e.buffer;void 0===t&&(t=e.buffer=new nu(this.gl));const n=e.serializedAnnotations;t.setData(n.data),e.numPickIds=Fp(n),e.bufferValid=!0}this.drawGeometry(e,t,n,i)}drawGeometry(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const r=this.base,s=n.chunkDisplayTransform,o=e.serializedAnnotations,a=o.typeToIdMaps,l=o.typeToOffset;let c=0;t.emitPickID&&(c=t.pickIDs.register(this,e.numPickIds,0,0,e));const d=r.hoverState.value,u=Qn(DL,t.projectionParameters.viewProjectionMat,s.displaySubspaceModelMatrix),h={annotationLayer:r,renderContext:t,selectedIndex:0,basePickId:c,buffer:e.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:u,modelClipBounds:n.modelClipBounds,subspaceMatrix:n.renderSubspaceTransform,renderSubspaceModelMatrix:s.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:s.displaySubspaceInvModelMatrix,chunkDisplayTransform:s};for(const p of Xs){const e=a[p];let t=e.size;if(t>0){const n=ep(p);let r=4294967295;if(void 0!==d){const t=e.get(d.id);void 0!==t&&(r=t*n.pickIdsPerInstance)}t=Math.round(t*i),h.count=t,h.bufferOffset=l[p],h.selectedIndex=r,this.renderHelpers[p].draw(h),h.basePickId+=t*n.pickIdsPerInstance}}}updateMouseState(e,t,n,i){const r=i.serializedAnnotations,s=r.typeToIds,o=r.typeToOffset,a=this.curRank,l=this.chunkTransform;if(void 0===l.error)for(const c of Xs){const t=s[c],i=ep(c),d=i.pickIdsPerInstance;if(n<t.length*d){const s=Math.floor(n/d),u=t[s],h=n%d;e.pickedAnnotationId=u,e.pickedAnnotationLayer=this.base.state,e.pickedOffset=h,e.pickedAnnotationBuffer=r.data.buffer,e.pickedAnnotationType=c,e.pickedAnnotationBufferBaseOffset=r.data.byteOffset+o[c],e.pickedAnnotationIndex=s,e.pickedAnnotationCount=t.length;const p=this.tempChunkPosition,f=l.chunkToLayerTransform,g=l.combinedGlobalLocalToChunkTransform,m=l.layerRank,v=l.modelTransform.globalToRenderLayerDimensions,y=e.position;if(!Ha(p,y,this.base.state.localPosition.value,m,g))return;const b=this.base.source.annotationPropertySerializers[c];i.snapPosition(p,e.pickedAnnotationBuffer,e.pickedAnnotationBufferBaseOffset+e.pickedAnnotationIndex*b.propertyGroupBytes[0],h);const S=v.length;for(let e=0;e<S;++e){const t=v[e];if(-1===t)continue;let n=f[(a+1)*a+t];for(let e=0;e<a;++e)n+=p[e]*f[e*(m+1)+t];Sr(n)&&(y[e]=n)}return}n-=t.length*d}}transformPickedValue(e){const t=e.pickedAnnotationBuffer;if(void 0===t)return;const n=this.base.source.properties;if(0===n.length)return;const i=e.pickedAnnotationBufferBaseOffset,r=e.pickedAnnotationType,s=e.pickedAnnotationIndex,o=e.pickedAnnotationCount,a=this.base.source.annotationPropertySerializers,l=new Array(n.length);return a[r].deserialize(new DataView(t),i,s,o,dr.LITTLE===ur,l),function(e,t){switch(e.type){case"rgb":return Ki(Zi(t));case"rgba":return Ki(Xi(t));default:return no(e,t)}}(n[0],l[0])}isReady(){const e=this.base.source;if(!(e instanceof Xp))return!0;const t=this.base.segmentationStates.value;if(void 0===t)return!0;for(let n=0,i=t.length;n<i;++n){const i=t[n];if(null===i)return!1;if(void 0===i)continue;const r=e.segmentFilteredSources[n].chunks;let s=!1;if(yp(i.segmentationGroupState.value,(e=>{const t=gp(e);r.has(t)||(s=!0)})),s)return!1}return!0}}}const VL=e=>class extends e{constructor(){super(...arguments),this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(e,t){const n=this.updateAttachmentState(t);if(0===this.curRank||void 0===n)return;this.updateModelClipBounds(e,n);const i=this.base.source;if(i instanceof go){const t=this.base;t.updateBuffer(),this.drawGeometry(t,e,n)}else{const t=this.renderScaleHistogram;t.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(i.temporary.data,e,n);const r=this.base.segmentationStates.value;let s=0,o=0;if(void 0!==r)for(let a=0,l=r.length;a<l;++a){const t=r[a];if(null==t)continue;const l=i.segmentFilteredSources[a].chunks;yp(t.segmentationGroupState.value,(t=>{const i=gp(t),r=l.get(i);if(void 0!==r&&r.state===el.GPU_MEMORY){const t=r.data;if(void 0===t)return;this.drawGeometryChunkData(t,e,n),++s}else++o}))}t.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,s,o)}}},OL=NL(ym,"perspectiveViewRenderHelper");class BL extends(VL(OL)){}const _L=e=>class extends e{constructor(e){super(e.annotationLayer,e.renderScaleHistogram),this.wireFrameRenderHelper=this instanceof kp?LL:EL,this.wireFrameShaderGetter=eu(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof kp}`,parameters:_n(void 0),defineShader:e=>{this.wireFrameRenderHelper.defineShader(e)}}),this.renderScaleTarget=e.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));const t=this.registerDisposer(new dp(this.layerChunkProgressInfo)),n=this.base.chunkManager.rpc;t.RPC_TYPE_ID="annotation/SpatiallyIndexedRenderLayer",t.initializeCounterpart(n,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(Cd.makeFromExisting(n,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Cd.makeFromExisting(n,this.renderScaleTarget)).rpcId}),this.backend=t}attach(e){super.attach(e),e.state.sources=e.registerDisposer(On(((t,n,r)=>{const s=Vp(r,n,(e=>this.base.state.source.getSources(e)),e.messages,this);for(const e of s)for(const n of e)t.registerDisposer(n.source),(0,i.bn)(n,AL(n.chunkDisplayTransform));return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke("annotation/PerspectiveRenderLayer:updateSources",{layer:this.backend.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:r,sources:Ip(s)}),this.redrawNeeded.dispatch(),s}),this.base.state.transform,e.view.displayDimensionRenderInfo))}draw(e,t){const n=this.updateAttachmentState(t);if(0===this.curRank||void 0===n)return;const i=t.state.sources.value;if(0===i.length)return;this.updateModelClipBounds(e,n);const r=this.renderScaleHistogram;r.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const s=e.projectionParameters;let o;if(e.wireFrame){const t=this.wireFrameShaderGetter(e.emitter).shader;if(null===t)return;t.bind(),this.wireFrameRenderHelper.initialize(t,s),o=t}jh(s,this.base.state.localPosition.value,this.renderScaleTarget.value,i[0],(()=>{}),((t,i,a,l,c)=>{const d=t.source.chunks.get(t.curPositionInChunks.join());let u;if(void 0===d||d.state!==el.GPU_MEMORY)u=0;else{const i=d.data;if(void 0===i)return;void 0!==o?this.wireFrameRenderHelper.draw(o,t,s):this.drawGeometryChunkData(i,e,n,a),u=1}r.add(l,c,u,1-u)}))}},FL=_L(OL),zL=_L(NL(kp,"sliceViewRenderHelper")),UL=VL(NL(kp,"sliceViewRenderHelper"));class GL extends Sn{constructor(){super(...arguments),this.changed=new kn,this.isLoadingChanged=new kn,this.states=[],this.relationships=[],this.loadingCount=0}get value(){return this.states}get isLoading(){return 0!==this.loadingCount}markLoading(){return this.loadingCount++,()=>{0===--this.loadingCount&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort(((e,t)=>{let n=e.sourceIndex-t.sourceIndex;return 0!==n?n:e.subsourceIndex-t.subsourceIndex}))}updateRelationships(){const e=new Rt;for(const t of this.states)for(const n of t.source.relationships)e.add(n);this.relationships=It(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{const t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function WL(e,t,n){void 0===t.error&&e.setLayerPosition(t.modelTransform,n)}function $L(e,t,n){const i=t.layerRank,r=new Float32Array(i);po[e.type].visitGeometry(e,((e,s)=>{r.set(e);const o=new Float32Array(i);(s?Do:Io)(o,t.chunkToLayerTransform,i+1,r,i),n(o,s)}))}class jL extends TS{constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:e=>this.render(e),changed:new Cn},this.virtualList=new yS({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new pt,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.selectedAnnotationState=Pn(((e,t)=>{var n;if(void 0===e)return;const i=this.layer,r=null===(n=e.layers.find((e=>e.layer===i)))||void 0===n?void 0:n.state;if(void 0===r)return;const s=r.annotationId;if(void 0===s)return;const o=this.annotationStates.states.find((e=>e.sourceIndex===r.annotationSourceIndex&&(void 0===r.annotationSubsource||e.subsourceId===r.annotationSubsource)));return void 0!==o?{annotationId:s,annotationLayerState:o,pin:t}:void 0}),this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin),this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add((()=>this.updateView()))),this.registerDisposer(e.annotationStates.changed.add((()=>this.updateAttachedAnnotationLayerStates()))),this.headerRow.classList.add("neuroglancer-annotation-list-header");const n=document.createElement("div");n.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);const i=this.registerDisposer(new Gk(this.displayState.color));i.element.title="Change annotation display color",this.registerDisposer(new Bd(Pn((e=>null!==e.match(/\bdefaultColor\b/)),t.shaderControls.processedFragmentMain),i.element)),n.appendChild(i.element);const r=this.mutableControls,s=Jv({text:po[Zs.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new eI(this.layer,{})}});r.appendChild(s);const o=Jv({text:po[Zs.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new rI(this.layer,{})}});r.appendChild(o);const a=Jv({text:po[Zs.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new sI(this.layer,{})}});r.appendChild(a);const l=Jv({text:po[Zs.SPHERE].icon,title:"Annotate Sphere",onClick:()=>{this.layer.tool.value=new oI(this.layer,{})}});r.appendChild(l);const c=Jv({text:po[Zs.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new aI(this.layer,{})}});r.appendChild(c),n.appendChild(r),this.element.appendChild(n),this.element.appendChild(this.headerRow);const d=this.virtualList;d.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(d.element),this.virtualList.element.addEventListener("mouseleave",(()=>{this.displayState.hoverState.value=void 0}));const u=(void 0===Ev&&(Ev=yv.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[Mv(),0]]})),Ev);this.registerDisposer(new ly(this.virtualList.element,u)),this.virtualList.element.title=u.describe(),this.registerDisposer(this.displayState.hoverState.changed.add((()=>this.updateHoverView()))),this.registerDisposer(this.selectedAnnotationState.changed.add((()=>this.updateSelectionView()))),this.registerDisposer(this.layer.localCoordinateSpace.changed.add((()=>{this.updateCoordinateSpace(),this.updateView()}))),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add((()=>{this.updateCoordinateSpace(),this.updateView()}))),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){const e=this.annotationStates.states,t=this.attachedAnnotationStates,n=new pt;for(const r of t){var i=O(r,2);const n=i[0],s=i[1];e.includes(n)||(t.delete(n),s.refCounted.dispose())}for(const r of e){const e=t.get(r);if(void 0!==e){n.set(r,e);continue}const i=r.source,s=new Sn;(i instanceof go||i instanceof Xp)&&(s.registerDisposer(i.childAdded.add((e=>this.addAnnotationElement(e,r)))),s.registerDisposer(i.childUpdated.add((e=>this.updateAnnotationElement(e,r)))),s.registerDisposer(i.childDeleted.add((e=>this.deleteAnnotationElement(e,r)))),s.registerDisposer(i.childRefreshed.add((()=>this.clearAnnotationElement(r))))),s.registerDisposer(r.transform.changed.add(this.forceUpdateView)),n.set(r,{refCounted:s,annotations:[],idToIndex:new pt,listOffset:0})}this.attachedAnnotationStates=n,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){const e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,n=[],i=[];for(let r=0,s=t.rank;r<s;++r)this.annotationStates.states.some((e=>{const t=e.transform.value;return void 0===t.error&&-1!==t.globalToRenderLayerDimensions[r]}))&&n.push(r);for(let r=0,s=e.rank;r<s;++r)this.annotationStates.states.some((e=>{const t=e.transform.value;return void 0===t.error&&-1!==t.localToRenderLayerDimensions[r]}))&&i.push(r);(!Ut(n,this.globalDimensionIndices)||!Ut(i,this.localDimensionIndices))&&(this.localDimensionIndices=i,this.globalDimensionIndices=n,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=this.attachedAnnotationStates.get(e);if(null==i)return;const r=i.idToIndex.get(t);if(void 0===r)return;const s=i.listOffset+r;return n&&this.virtualList.scrollItemIntoView(r),this.virtualList.getItemElement(s)}clearSelectionClass(){const e=this.previousSelectedState;if(void 0===e)return;this.previousSelectedState=void 0;const t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);void 0!==t&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){const e=this.previousHoverId,t=this.previousHoverAnnotationLayerState;if(void 0!==t){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;const n=this.getRenderedAnnotationListElement(t,e);void 0!==n&&n.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){const e=this.selectedAnnotationState.value,t=this.previousSelectedState;if(t===e||void 0!==t&&void 0!==e&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,void 0===e))return;const n=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);void 0!==n&&n.classList.add("neuroglancer-annotation-selected")}updateHoverView(){const e=this.displayState.hoverState.value;let t,n;void 0!==e&&(t=e.id,n=e.annotationLayerState);const i=this.previousHoverId,r=this.previousHoverAnnotationLayerState;if(t===i&&n===r||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=n,void 0===t))return;const s=this.getRenderedAnnotationListElement(n,t);void 0!==s&&s.classList.add("neuroglancer-annotation-hover")}render(e){var t=this.listElements[e];const n=t.annotation,i=t.state;return this.makeAnnotationListElement(n,i)}setColumnWidth(e,t){t+=2;const n=this.columnWidths;n[e]>t||(n[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;this.columnWidths.length=0;const e=this.headerRow,t=document.createElement("div");t.style.gridColumn="symbol";const n=document.createElement("div");n.style.gridColumn="delete",Rv(e),e.appendChild(t);let i=0,r="[symbol] 2ch";const s=(t,n)=>{const s=document.createElement("div");s.classList.add("neuroglancer-annotations-view-dimension");const o=document.createElement("span");o.classList.add("neuroglancer-annotations-view-dimension-name"),o.textContent=t.names[n];const a=document.createElement("scale");a.classList.add("neuroglancer-annotations-view-dimension-scale"),a.textContent=Fo(t.scales[n],t.units[n],{precision:2}),s.appendChild(o),s.appendChild(a),s.style.gridColumn=`dim ${i+1}`,this.setColumnWidth(i,a.textContent.length+o.textContent.length+3),r+=` [dim] var(--neuroglancer-column-${i}-width)`,++i,e.appendChild(s)},o=this.layer.manager.root.coordinateSpace.value;for(const l of this.globalDimensionIndices)s(o,l);const a=this.layer.localCoordinateSpace.value;for(const l of this.localDimensionIndices)s(a,l);e.appendChild(n),r+=" [delete] 2ch",this.gridTemplate=r,e.style.gridTemplateColumns=r,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1;const t=this.listElements;t.length=0;for(const r of this.attachedAnnotationStates){var n=O(r,2);const i=n[0],s=n[1];if(i.source.readonly||(e=!0),void 0!==i.chunkTransform.value.error)continue;const o=i.source,a=It(o);s.annotations=a;const l=s.idToIndex;l.clear();for(let e=0,t=a.length;e<t;++e)l.set(a[e].id,e);for(const e of a)t.push({state:i,annotation:e})}const i=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:i,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(const t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}clearAnnotationElement(e){if(!this.visible)return void(this.updated=!1);if(!this.updated)return void this.updateView();const t=this.attachedAnnotationStates.get(e);if(void 0!==t){const e=t.annotations.length;t.annotations=[],t.idToIndex.clear(),this.listElements=[],this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:e,insertCount:0}])}this.resetOnUpdate()}addAnnotationElement(e,t){if(!this.visible)return void(this.updated=!1);if(!this.updated)return void this.updateView();const n=this.attachedAnnotationStates.get(t);if(void 0!==n){const i=n.annotations.length;n.annotations.push(e),n.idToIndex.set(e.id,i);const r=n.listOffset+i;this.listElements.splice(r,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible)return void(this.updated=!1);if(!this.updated)return void this.updateView();const n=this.attachedAnnotationStates.get(t);if(void 0!==n){const t=n.idToIndex.get(e.id);if(void 0!==t){const i=n.listOffset+t;n.annotations[t]=e,this.listElements[i].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:i,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible)return void(this.updated=!1);if(!this.updated)return void this.updateView();const n=this.attachedAnnotationStates.get(t);if(void 0!==n){const t=n.idToIndex,i=t.get(e);if(void 0!==i){const r=n.listOffset+i,s=n.annotations;s.splice(i,1),t.delete(e);for(let e=i,n=s.length;e<n;++e)t.set(s[e].id,e);this.listElements.splice(r,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){const n=t.chunkTransform.value,i=document.createElement("div");i.classList.add("neuroglancer-annotation-list-entry"),i.style.gridTemplateColumns=this.gridTemplate;const r=document.createElement("div");let s;r.className="neuroglancer-annotation-icon",r.textContent=po[e.type].icon,i.appendChild(r);let o=0;if($L(e,n,((r,a)=>{++o;const l=document.createElement("div");l.className="neuroglancer-annotation-position",i.appendChild(l);let c=0;const d=(e,t)=>{for(const n of e){const e=t[n];if(-1!==e){const t=Math.floor(r[e]),n=document.createElement("div"),i=t.toString();n.textContent=i,n.classList.add("neuroglancer-annotation-coordinate"),n.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,i.length),l.appendChild(n)}++c}};d(this.globalDimensionIndices,n.modelTransform.globalToRenderLayerDimensions),d(this.localDimensionIndices,n.modelTransform.localToRenderLayerDimensions),t.source.readonly||void 0===s&&(s=VC({title:"Delete annotation",onClick:n=>{n.stopPropagation(),n.preventDefault();const i=t.source.getReference(e.id);try{t.source.delete(i)}finally{i.dispose()}}}),s.classList.add("neuroglancer-annotation-list-entry-delete"),i.appendChild(s))})),e.description){++o;const t=document.createElement("div");t.classList.add("neuroglancer-annotation-description"),t.textContent=e.description,i.appendChild(t)}r.style.gridRow=`span ${o}`,void 0!==s&&(s.style.gridRow=`span ${o}`),i.addEventListener("mouseenter",(()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)})),i.addEventListener("action:select-position",(n=>{n.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")})),i.addEventListener("action:pin-annotation",(n=>{n.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)})),i.addEventListener("action:move-to-annotation",(t=>{t.stopPropagation(),t.preventDefault();const i=n.layerRank,r=new Float32Array(i),s=new Float32Array(i);(function(e,t){switch(t.type){case Zs.AXIS_ALIGNED_BOUNDING_BOX:case Zs.LINE:case Zs.SPHERE:Wo(e,t.pointA,t.pointB),function(e,t,n){const i=e.length;for(let r=0;r<i;++r)e[r]=t[r]*n}(e,e,.5);break;case Zs.POINT:e.set(t.point);break;case Zs.ELLIPSOID:e.set(t.center)}})(r,e),Io(s,n.chunkToLayerTransform,i+1,r,i),WL(this.layer,n,s)}));const a=this.selectedAnnotationState.value;return void 0!==a&&a.annotationLayerState===t&&a.annotationId===e.id&&i.classList.add("neuroglancer-annotation-selected"),i}}class HL extends TS{constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new jL(this.layer,this.layer.annotationDisplayState));const t=this.element;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function JL(e){let t=[];const n=e.source.relationships,i=e.displayState.relationshipStates;for(let r=0,s=n.length;r<s;++r){const e=i.get(n[r]).segmentationState.value;null!=e&&e.segmentSelectionState.hasSelectedSegment?t[r]=[e.segmentSelectionState.selectedSegment.clone()]:t[r]=[]}return t}class qL extends qS{constructor(e,t){super(e)}get annotationLayer(){for(const e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}const YL="annotatePoint",ZL="annotateLine",XL="annotateBoundingBox",KL="annotateEllipsoid",QL="annotateSphere";class eI extends qL{constructor(){super(...arguments),this.sourceSignalUpdated=!1}trigger(e){const t=this.annotationLayer;if(void 0!==t&&e.updateUnconditionally()){const n=tI(e,t);if(void 0===n)return;const i={id:"",description:"",relatedSegments:JL(t),point:n,type:Zs.POINT,properties:t.source.properties.map((e=>e.default))},r=t.source.add(i,!0);t.source instanceof Xp?this.sourceSignalUpdated||(t.source.childAdded.add((e=>{void 0===e.source&&this.layer.selectAnnotation(t,e.id,!0,!iT.expectingExternalUI)})),this.sourceSignalUpdated=!0):this.layer.selectAnnotation(t,r.id,!0),r.dispose()}}get description(){return"annotate point"}toJSON(){return YL}}function tI(e,t){const n=t.chunkTransform.value;if(void 0!==n.error)return;const i=new Float32Array(n.modelTransform.unpaddedRank);return Ha(i,e.unsnappedPosition,t.localPosition.value,n.layerRank,n.combinedGlobalLocalToChunkTransform)?i:void 0}class nI extends qL{trigger(e){const t=this.annotationLayer;if(void 0!==t&&e.updateUnconditionally()){const n=()=>{const n=this.inProgressAnnotation,i=n.reference,r=this.getUpdatedAnnotation(i.value,e,t);Bt(fo(r,t.source))!==Bt(fo(i.value,t.source))&&(n.annotationLayer.source.update(i,r),this.layer.selectAnnotation(t,i.id,!0,!iT.expectingExternalUI))};if(void 0===this.inProgressAnnotation){const i=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,i.id,!0,!iT.expectingExternalUI);const r=e.changed.add(n),s=()=>{r(),i.dispose()};this.inProgressAnnotation={annotationLayer:t,reference:i,disposer:s}}else n(),this.inProgressAnnotation.annotationLayer.source.commit(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0}}disposed(){this.deactivate(),super.disposed()}deactivate(){void 0!==this.inProgressAnnotation&&(this.inProgressAnnotation.annotationLayer.source.delete(this.inProgressAnnotation.reference),this.inProgressAnnotation.disposer(),this.inProgressAnnotation=void 0)}}class iI extends nI{getInitialAnnotation(e,t){const n=tI(e,t);return{id:"",type:this.annotationType,description:"",pointA:n,pointB:n,properties:t.source.properties.map((e=>e.default))}}getUpdatedAnnotation(e,t,n){const r=tI(t,n);return void 0===r?e:(0,i.bn)((0,i.bn)({},e),{pointB:r})}}class rI extends iI{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,n){const i=super.getUpdatedAnnotation(e,t,n),r=i.pointA,s=i.pointB,o=r.length;for(let a=0;a<o;++a)r[a]===s[a]&&(s[a]+=1);return i}toJSON(){return XL}}rI.prototype.annotationType=Zs.AXIS_ALIGNED_BOUNDING_BOX;class sI extends iI{get description(){return"annotate line"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=JL(t),n}getUpdatedAnnotation(e,t,n){const i=super.getUpdatedAnnotation(e,t,n),r=this.initialRelationships,s=JL(n);return i.relatedSegments=void 0===r?s:It(s,((e,t)=>{const n=r[t];return e=e.filter((e=>-1===n.findIndex((t=>Ds.equal(e,t))))),[...n,...e]})),i}toJSON(){return ZL}}sI.prototype.annotationType=Zs.LINE;class oI extends iI{get description(){return"annotate sphere"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=JL(t),n}getUpdatedAnnotation(e,t,n){const i=super.getUpdatedAnnotation(e,t,n),r=this.initialRelationships,s=JL(n);return i.relatedSegments=void 0===r?s:It(s,((e,t)=>{const n=r[t];return e=e.filter((e=>-1===n.findIndex((t=>Ds.equal(e,t))))),[...n,...e]})),i}toJSON(){return QL}}oI.prototype.annotationType=Zs.SPHERE;class aI extends nI{getInitialAnnotation(e,t){const n=tI(e,t);return{type:Zs.ELLIPSOID,id:"",description:"",segments:JL(t),center:n,radii:ii(0,0,0),properties:t.source.properties.map((e=>e.default))}}getUpdatedAnnotation(e,t,n){const r=tI(t,n);if(void 0===r)return e;const s=e.center,o=s.length;for(let i=0;i<o;++i)r[i]=Math.abs(s[i]-r[i]);return(0,i.bn)((0,i.bn)({},e),{radii:r})}get description(){return"annotate ellipsoid"}toJSON(){return KL}}QS(YL,((e,t)=>new eI(e,t))),QS(XL,((e,t)=>new rI(e,t))),QS(ZL,((e,t)=>new sI(e,t))),QS(KL,((e,t)=>new aI(e,t))),QS(QL,((e,t)=>new oI(e,t)));const lI=yv.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function cI(e,t,n,i){return new hy(n,((n,r,s)=>{const o=document.createElement("div");o.classList.add("neuroglancer-related-segment-list"),null!=n&&s.registerDisposer(xy(n,o));const a=document.createElement("div");a.classList.add("neuroglancer-related-segment-list-header");const l=dy({title:"Copy segment IDs",onClick:()=>{ay(t.map((e=>e.toString())).join(", "))}});let c;if(a.appendChild(l),null!=n&&(c=document.createElement("input"),c.type="checkbox",c.addEventListener("change",(()=>{const e=n.segmentationGroupState.value.visibleSegments,i=t.some((t=>!e.has(t)));for(const n of t)e.set(n,i)})),a.appendChild(c)),void 0!==i){const e=VC({title:"Remove all IDs",onClick:()=>{i([])}});a.appendChild(e)}const d=document.createElement("span");if(d.classList.add("neuroglancer-related-segment-list-title"),d.textContent=e,a.appendChild(d),void 0!==i){const e=Xb({title:"Add related segment ID",onClick:()=>{const e=new Sn,r=s.registerDisposer(xn(e)),a=document.createElement("div");a.classList.add("neuroglancer-segment-list-entry"),a.classList.add("neuroglancer-segment-list-entry-new");const l=dy({});if(l.classList.add("neuroglancer-segment-list-entry-copy"),a.appendChild(l),null!=n){const e=document.createElement("input");e.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.type="checkbox",a.appendChild(e)}const c=VC({title:"Cancel adding new segment ID",onClick:()=>{r()}});c.classList.add("neuroglancer-segment-list-entry-delete"),a.appendChild(c);const d=document.createElement("input");d.autocomplete="off",d.spellcheck=!1,d.classList.add("neuroglancer-segment-list-entry-id");e.registerDisposer(new tS(d,lI)).allShortcutsAreGlobal=!0;const u=()=>{const e=new Ds;if(e.tryParseString(d.value))return d.dataset.valid="true",e;d.dataset.valid="false"};u(),d.addEventListener("input",(()=>{u()})),d.addEventListener("blur",(()=>{const e=u();void 0!==e&&i([...t,e]),r()})),Cv(d,"cancel",r),Cv(d,"commit",(()=>{const e=u();void 0!==e&&i([...t,e]),r()})),a.appendChild(d),o.appendChild(a),d.focus(),e.registerDisposer((()=>{d.value="",a.remove()}))}});a.appendChild(e)}o.appendChild(a);const u=[],h=Ly.make(n??void 0,!1);for(const e of t){const n=h.get(e);if(u.push(n),void 0!==i){const r=VC({title:"Remove ID",onClick:n=>{i(t.filter((t=>!Ds.equal(t,e)))),n.stopPropagation()}});r.classList.add("neuroglancer-segment-list-entry-delete"),n.children[0].appendChild(r)}o.appendChild(n)}if(null!=n){const e=s.registerCancellable(al((()=>{const e=n.segmentationGroupState.value.visibleSegments;let i=0;for(const n of t)e.has(n)&&++i;for(const t of u)h.update(t);c.checked=i===t.length&&i>0,c.indeterminate=i>0&&i<t.length})));e(),e.flush(),Py(n,s,e),s.registerDisposer(n.segmentationGroupState.changed.add(e))}r.appendChild(o)}))}const dI="annotationColor";function uI(e){return class extends e{constructor(){let e;super(...arguments),this.annotationStates=this.registerDisposer(new GL),this.annotationDisplayState=new Ch,this.annotationCrossSectionRenderScaleHistogram=new xp,this.annotationCrossSectionRenderScaleTarget=wp(8),this.annotationProjectionRenderScaleHistogram=new xp,this.annotationProjectionRenderScaleTarget=wp(8),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new HL(this)});const t=()=>{const t=this.isReady;t&&void 0!==e?(e(),e=void 0):!t&&void 0===e&&(e=this.annotationStates.markLoading())};this.readyStateChanged.add(t),t();const n=this.manager.layerSelectedValues.mouseState;this.registerDisposer(n.changed.add((()=>{if(n.active){const e=n.pickedAnnotationLayer;if(void 0!==e&&this.annotationStates.states.includes(e)){const t=this.annotationDisplayState.hoverState.value;return void((void 0===t||t.id!==n.pickedAnnotationId||t.partIndex!==n.pickedOffset||t.annotationLayerState!==e)&&(this.annotationDisplayState.hoverState.value={id:n.pickedAnnotationId,partIndex:n.pickedOffset,annotationLayerState:e}))}}this.annotationDisplayState.hoverState.value=void 0})))}initializeAnnotationLayerViewTab(e){}restoreState(e){super.restoreState(e),this.annotationDisplayState.color.restoreState(e[dI])}captureSelectionState(e,t){super.captureSelectionState(e,t);const n=t.pickedAnnotationLayer;void 0===n||!this.annotationStates.states.includes(n)||(e.annotationId=t.pickedAnnotationId,e.annotationType=t.pickedAnnotationType,e.annotationBuffer=new Uint8Array(t.pickedAnnotationBuffer,t.pickedAnnotationBufferBaseOffset),e.annotationIndex=t.pickedAnnotationIndex,e.annotationCount=t.pickedAnnotationCount,e.annotationPartIndex=t.pickedOffset,e.annotationSourceIndex=n.sourceIndex,e.annotationSubsource=n.subsourceId)}displayAnnotationState(e,t,n){if(void 0===e.annotationId)return!1;const r=this.annotationStates.states.find((t=>t.sourceIndex===e.annotationSourceIndex&&(void 0===e.annotationSubsource||t.subsourceId===e.annotationSubsource)));if(void 0===r)return!1;r.source;const s=n.registerDisposer(r.source.getReference(e.annotationId));return t.appendChild(n.registerDisposer(new hy(n.registerDisposer(new Nn((()=>({annotation:s,chunkTransform:r.chunkTransform})))),((t,n,o)=>{let a,{annotation:l,chunkTransform:c}=t;if(null==l)if(void 0!==e.annotationType&&void 0!==e.annotationBuffer){const t=po[e.annotationType],n=r.source.rank,i=t.serializedBytes(n),s=e.annotationBuffer.byteOffset,o=new DataView(e.annotationBuffer.buffer),c=dr.LITTLE===ur,d=r.source.properties,u=new eo(n,i,d),h=e.annotationIndex,p=e.annotationCount;l=t.deserialize(o,s+u.propertyGroupBytes[0]*h,c,n,e.annotationId),u.deserialize(o,s,h,p,c,l.properties=new Array(d.length)),r.source.hasNonSerializedProperties()&&(a="Loading...")}else a=null===l?"Annotation not found":"Loading...";if(null!=l){const e=void 0===c.error?c.layerRank:0,t=document.createElement("div");t.classList.add("neuroglancer-selected-annotation-details-position-grid"),t.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${e}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,n.appendChild(t);const a=po[l.type],u=document.createElement("div");if(u.className="neuroglancer-selected-annotation-details-icon",u.textContent=a.icon,t.appendChild(u),0!==e){const n=c.modelTransform.layerDimensionNames;for(let i=0;i<e;++i){const e=document.createElement("div");e.classList.add("neuroglancer-selected-annotation-details-position-dim"),e.textContent=n[i],e.style.gridColumn=`dim ${i+1}`,t.appendChild(e)}$L(l,c,((n,i)=>{const r=dy({title:"Copy position",onClick:()=>{ay(n.map((e=>Math.floor(e))).join(", "))}});r.style.gridColumn="copy",t.appendChild(r);for(let s=0;s<e;++s){const e=document.createElement("div");e.classList.add("neuroglancer-selected-annotation-details-position-coord"),e.style.gridColumn=`coord ${s+1}`,e.textContent=Math.floor(n[s]).toString(),t.appendChild(e)}if(!i){const e=py({title:"Move to position",onClick:()=>{WL(this,c,n)}});e.style.gridColumn="move",t.appendChild(e)}}))}if(!r.source.readonly){const e=VC({title:"Delete annotation",onClick:()=>{r.source.delete(s)}});e.classList.add("neuroglancer-selected-annotation-details-delete"),t.appendChild(e)}var d=r.source;const h=d.relationships,p=d.properties,f=r.source.readonly;for(let i=0,r=p.length;i<r;++i){const e=p[i],t=document.createElement("label");t.classList.add("neuroglancer-annotation-property");const r=document.createElement("span");r.classList.add("neuroglancer-annotation-property-label"),r.textContent=e.identifier,t.appendChild(r);const s=e.description;void 0!==s&&(t.title=s);const o=l.properties[i],a=document.createElement("span");switch(a.classList.add("neuroglancer-annotation-property-value"),e.type){case"rgb":{const e=Zi(o),t=Ki(e);a.textContent=t,a.style.backgroundColor=t,a.style.color=tr(e)?"white":"black";break}case"rgba":{const e=Zi(o);a.textContent=Ki(Xi(o)),a.style.backgroundColor=Ki(Zi(o)),a.style.color=tr(e)?"white":"black";break}default:a.textContent=no(e,o)}t.appendChild(a),n.appendChild(t)}const g=l.relatedSegments;for(let l=0,c=h.length;l<c;++l){const e=void 0===g?[]:g[l];if(0===e.length&&f)continue;const t=l,a=h[l];n.appendChild(o.registerDisposer(cI(a,e,r.displayState.relationshipStates.get(a).segmentationState,f?void 0:e=>{const n=s.value;if(null==n)return;let o=n.relatedSegments;o=void 0===o?r.source.relationships.map((()=>[])):o.slice(),o[t]=e;const a=(0,i.bn)((0,i.bn)({},n),{relatedSegments:o});r.source.update(s,a),r.source.commit(s)})).element)}let m=null,v=r.source;if(v instanceof Xp&&v.makeEditWidget&&(m=v.makeEditWidget(s),m&&(m.className="neuroglancer-annotation-details-description",n.appendChild(m))),(!r.source.readonly||l.description)&&null===m)if(r.source.readonly){const e=document.createElement("div");e.className="neuroglancer-annotation-details-description",e.textContent=l.description||"",n.appendChild(e)}else{const e=document.createElement("textarea");e.value=l.description||"",e.rows=3,e.className="neuroglancer-annotation-details-description",e.placeholder="Description",e.addEventListener("change",(()=>{const t=e.value;r.source.update(s,(0,i.bn)((0,i.bn)({},l),{description:t||void 0})),r.source.commit(s)})),n.appendChild(e)}}if(void 0!==a){const e=document.createElement("div");e.classList.add("neuroglancer-selection-annotation-status"),e.textContent=a,n.appendChild(e)}}))).element),!0}displaySelectionState(e,t,n){let i=this.displayAnnotationState(e,t,n);return super.displaySelectionState(e,t,n)&&(i=!0),i}addLocalAnnotations(e,t,n){const i=e.subsourceEntry,r=new kh({localPosition:this.localPosition,transform:e.getRenderLayerTransform(),source:t,displayState:this.annotationDisplayState,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:i.id,role:n});this.addAnnotationLayerState(r,e)}addStaticAnnotations(e){const t=e.subsourceEntry.subsource.staticAnnotations;return void 0!==t&&(e.activate((()=>{this.addLocalAnnotations(e,t,Ld.DEFAULT_ANNOTATION)})),!0)}addAnnotationLayerState(e,t){const n=t.activated;n.registerDisposer(this.annotationStates.add(e));const i=new PL(this.manager.chunkManager,e.addRef());if(i.source instanceof Xp){const e=new zL({annotationLayer:i.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});n.registerDisposer(t.messages.addChild(e.messages));const r=new FL({annotationLayer:i.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});n.registerDisposer(t.messages.addChild(r.messages)),n.registerDisposer(On(((t,n)=>{n&&(t.registerDisposer(this.addRenderLayer(e.addRef())),t.registerDisposer(this.addRenderLayer(r.addRef())))}),this.annotationDisplayState.displayUnfiltered))}{const e=new UL(i,this.annotationCrossSectionRenderScaleHistogram);n.registerDisposer(this.addRenderLayer(e)),n.registerDisposer(t.messages.addChild(e.messages))}{const e=new BL(i.addRef(),this.annotationProjectionRenderScaleHistogram);n.registerDisposer(this.addRenderLayer(e)),n.registerDisposer(t.messages.addChild(e.messages))}}selectAnnotation(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this.manager.root.selectionState.captureSingleLayerState(this,(n=>(n.annotationId=t,n.annotationSourceIndex=e.sourceIndex,n.annotationSubsource=e.subsourceId,!0)),n,i)}toJSON(){const e=super.toJSON();return e[dI]=this.annotationDisplayState.color.toJSON(),e}}}const hI=yv.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});class pI extends Sn{constructor(e,t,n,r){super(),this.element=e,this.dataType=t,this.getModel=n,this.setModel=r,e.title=hI.describe(),this.registerDisposer(new ly(e,hI)),Cv(e,"set",(e=>{const t=e.detail,n=this.getModel(),i=this.getTargetValue(t);if(void 0===i)return;const r=function(e,t){return"number"==typeof t?Math.abs(t-e[0])<Math.abs(t-e[1])?0:1:Ds.less(Ds.absDifference(Fs,e[0],t),Ds.absDifference(zs,e[1],t))?0:1}(Vs(n.window,n.range),i),s=e=>{const t=this.getModel();this.setModel(gI(t,"range",r,e))};s(i),Hv(t,(e=>{const t=this.getTargetValue(e);void 0!==t&&s(t)}))})),Cv(e,"adjust-window-via-drag",(e=>{const t=e.detail,n=this.getTargetFraction(t),i=this.getWindowLerp(n),r=n<.5?0:1,s=e=>{const t=this.getModel();this.setModel(gI(t,"window",r,e))};Hv(t,(e=>{const t=this.getModel().window,n=this.getTargetFraction(e);s(0===r?Rs([i,t[1]],this.dataType,-n/(1-n)):Rs([t[0],i],this.dataType,1/n))}))})),Cv(e,"zoom-via-wheel",(e=>{const t=e.detail,n=Nw(t),r=this.getTargetFraction(t),s=this.dataType,o=this.getModel(),a=Rs(o.window,s,r*(1-n)),l=Rs(o.window,s,(1-r)*n+r);this.setModel((0,i.bn)((0,i.bn)({},o),{window:[a,l],range:o.range}))}))}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return Rs(this.getModel().window,this.dataType,e)}getTargetValue(e){const t=this.getTargetFraction(e);if(Sr(t))return this.getWindowLerp(t)}}const fI=(0,i.bu)("histogramSamplerTexture");function gI(e,t,n,r){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const o=(0,i.bn)({},e),a=e[t];if(o[t]=[a[0],a[1]],o[t][n]=r,"window"===t&&_s(r,a[1-n])*(2*n-1)<0&&(o[t][1-n]=r),"range"===t&&s){const t=[e.window[0],e.window[1]];for(let e=0;e<2;++e)_s(r,t[e])*(2*e-1)>0&&(t[e]=r);o.window=t}return o}const mI=255;class vI extends fl{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controller=this.registerDisposer(new pI(this.element,this.parent.dataType,(()=>this.parent.trackable.value),(e=>{this.parent.trackable.value=e}))),this.dataValuesBuffer=this.registerDisposer(iu(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,(()=>{const e=new Uint8Array(1530);for(let t=0;t<mI;++t)for(let n=0;n<6;++n)e[6*t+n]=t;return e}))).value,this.lineShader=this.registerDisposer((()=>{const e=new Zd(this.gl);return xb(e),e.addTextureSampler("sampler2D","uHistogramSampler",fI),e.addOutputBuffer("vec4","out_color",0),e.addAttribute("uint","aDataValue"),e.addUniform("float","uBoundsFraction"),e.addVertexCode("\nfloat getCount(int i) {\n  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;\n}\nvec4 getVertex(float cdf, int i) {\n  float x;\n  if (i == 0) {\n    x = -1.0;\n  } else if (i == 255) {\n    x = 1.0;\n  } else {\n    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;\n  }\n  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);\n}\n"),e.setVertexMain("\nint lineNumber = int(aDataValue);\nint dataValue = lineNumber;\nfloat cumSum = 0.0;\nfor (int i = 0; i <= dataValue; ++i) {\n  cumSum += getCount(i);\n}\nfloat total = cumSum + getCount(dataValue + 1);\nfloat cumSumEnd = dataValue == 254 ? cumSum : total;\nif (dataValue == 254) {\n  cumSum + getCount(dataValue + 1);\n}\nfor (int i = dataValue + 2; i < 256; ++i) {\n  total += getCount(i);\n}\ntotal = max(total, 1.0);\nfloat cdf1 = cumSum / total;\nfloat cdf2 = cumSumEnd / total;\nemitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);\n"),e.setFragmentMain("\nout_color = vec4(0.0, 1.0, 1.0, getLineAlpha());\n"),e.build()})()),this.regionCornersBuffer=su(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{const e=new Zd(this.gl);return e.addAttribute("vec2","aVertexPosition"),e.addUniform("vec2","uBounds"),e.addUniform("vec4","uColor"),e.addOutputBuffer("vec4","out_color",0),e.setVertexMain("\ngl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);\n"),e.setFragmentMain("\nout_color = uColor;\n"),e.build()})()),this.element.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){const e=this.lineShader,t=this.gl,n=this.regionShader;var i=this.parent;const r=i.dataType,s=i.trackable.value;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{n.bind(),t.uniform4f(n.uniform("uColor"),.2,.2,.2,1);const e=As(s.window,s.range[0]),i=As(s.window,s.range[1]),o=Hs(r,s.window);t.uniform2f(n.uniform("uBounds"),Math.min(e,i)*o,Math.max(e,i)*o+(1-o));const a=n.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(a,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(a)}if(this.parent.histogramSpecifications.producerVisibility.visible){const n=this.renderViewport;e.bind(),kb(e,{width:n.logicalWidth,height:n.logicalHeight},1);const i=e.textureUnit(fI);t.uniform1f(e.uniform("uBoundsFraction"),Hs(r,s.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+i),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),ou(t);const o=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(o,1,WebGL2RenderingContext.UNSIGNED_BYTE),Cb(t,mI,1),t.disableVertexAttribArray(o),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function yI(){}class bI extends fl{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=su(this.gl,-1,-1,1,1),this.element.classList.add("neuroglancer-invlerp-legend-panel");const t=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=eu(this,this.gl,(0,i.bn)((0,i.bn)({},t),{memoizeKey:{id:"colorLegendShader",base:t.memoizeKey},defineShader:(e,n,i)=>{e.addOutputBuffer("vec4","v4f_fragData0",0),e.addAttribute("vec2","aVertexPosition"),e.addUniform("float","uLegendOffset"),e.addVarying("float","vLinearPosition"),e.setVertexMain("\ngl_Position = vec4(aVertexPosition, 0.0, 1.0);\nvLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);\n");const r=this.parent.dataType,s=Bu(r);e.addFragmentCode(function(e,t,n){return[_u[n],th(e,t,n),eh[n],`\n${Bu(n)} ${t}(float inputValue) {\n  return computeLerp(inputValue, uLerpParams_${t});\n}\n`]}(e,"ng_colorLegendLerp",r)),e.addFragmentCode(`\nvoid emit(vec4 v) {\n  v4f_fragData0 = v;\n}\n${s} getDataValue() {\n  return ng_colorLegendLerp(vLinearPosition);\n}\n${s} getDataValue(int dummyChannel) {\n  return getDataValue();\n}\n${s} getInterpolatedDataValue() {\n  return getDataValue();\n}\n${s} getInterpolatedDataValue(int dummyChannel) {\n  return getDataValue();\n}\n`),t.defineShader(e,n,i)}}))}drawIndirect(){const e=this.shaderGetter(yI),t=e.shader;if(null===t)return;this.setGLLogicalViewport();const n=this.gl;n.clearColor(0,0,0,0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),n.enable(WebGL2RenderingContext.BLEND);var i=this.parent;const r=i.trackable.value.window,s=i.dataType;rh(t,"ng_colorLegendLerp",this.parent.dataType,r);const o=function(e,t){switch(e){case sr.FLOAT32:return 0;case sr.UINT64:return.5/Ds.absDifference(Fs,t[0],t[1]).toNumber();default:return.5/Math.abs(t[0]-t[1])}}(s,r);n.uniform1f(t.uniform("uLegendOffset"),Sr(o)?o:0),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),n.disable(WebGL2RenderingContext.DEPTH_TEST),n.disable(WebGL2RenderingContext.STENCIL_TEST);const a=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(a,2,WebGL2RenderingContext.FLOAT),n.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),n.disableVertexAttribArray(a)}isReady(){return!0}}function SI(e,t){const n=document.createElement("input");return n.addEventListener("focus",(()=>{n.select()})),n.classList.add("neuroglancer-invlerp-widget-bound"),n.classList.add(`neuroglancer-invlerp-widget-${e}-bound`),n.type="text",n.spellcheck=!1,n.autocomplete="off",n.title="range"===e?`Data value that maps to ${t}`:(0===t?"Lower":"Upper")+" bound for distribution",n}function wI(e,t,n){const i=document.createElement("div");i.classList.add("neuroglancer-invlerp-widget-bounds"),i.classList.add(`neuroglancer-invlerp-widget-${e}-bounds`);const r=[SI(e,0),SI(e,1)];for(let o=0;o<2;++o){const i=r[o];i.addEventListener("input",(()=>{xI(i)})),i.addEventListener("change",(()=>{const r=n.value,s=r[e];try{const s=Us(t,i.value);n.value=gI(r,e,o,s,!0)}catch{CI(i,s[o])}}))}let s;return i.appendChild(r[0]),i.appendChild(r[1]),"range"===e&&(s=[document.createElement("div"),document.createElement("div"),document.createElement("div")],s[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),i.insertBefore(s[0],r[0]),i.insertBefore(s[1],r[1]),i.appendChild(s[2])),{container:i,inputs:r,spacers:s}}function xI(e){Vv(e,Math.max(1,e.value.length+.1))}function CI(e,t){let n;n=t instanceof Ds||mr(t)?t.toString():t.toPrecision(6),e.value=n,xI(e)}function kI(e){const t=e.value,n=t.range;e.value=(0,i.bn)((0,i.bn)({},t),{range:[n[1],n[0]]})}class TI extends TS{constructor(e,t,n,i,r,s,o){super(e),this.display=t,this.dataType=n,this.trackable=i,this.histogramSpecifications=r,this.histogramIndex=s,this.legendShaderOptions=o,this.cdfPanel=this.registerDisposer(new vI(this)),this.boundElements={range:wI("range",this.dataType,this.trackable),window:wI("window",this.dataType,this.trackable)},this.registerDisposer(r.visibility.add(this.visibility));const a=this.element,l=this.boundElements;if(void 0!==o){const e=this.registerDisposer(new bI(this));a.appendChild(e.element)}const c=e=>{const t=Jv({svg:e,title:"Invert range",onClick:()=>{this.invertRange()}});return l.range.spacers[1].appendChild(t),t};this.invertArrows=[c(uv),c(dv)],a.appendChild(l.range.container),a.appendChild(this.cdfPanel.element),a.classList.add("neuroglancer-invlerp-widget"),a.appendChild(l.window.container),this.updateView(),this.registerDisposer(i.changed.add(this.registerCancellable(al((()=>this.updateView())))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){kI(this.trackable)}updateView(){const e=this.boundElements,t=this.trackable.value,n=this.dataType;for(let d=0;d<2;++d)CI(e.range.inputs[d],t.range[d]),CI(e.window.inputs[d],t.window[d]);const i=_s(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=i?"row-reverse":"row";const r=Vs(t.window,t.range),s=e.range.spacers,o=Hs(n,t.window),a=As(t.window,r[i?1:0])*o,l=As(t.window,r[i?0:1])*o+(1-o);s[i?2:0].style.width=100*a+"%",s[i?0:2].style.width=100*(1-l)+"%";const c=this.invertArrows;c[i?1:0].style.display="",c[i?0:1].style.display="none"}}const EI="mergeSegments",LI="splitSegments",II=yv.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),DI=yv.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});class MI extends JS{constructor(e){super(e),this.lastAnchorBaseSegment=new En(void 0);const t=()=>{const t=e.anchorSegment.value;if(void 0===t)return;const n=e.displayState.segmentSelectionState;if(!n.hasSelectedSegment)return;const i=e.displayState.segmentationGroupState.value.segmentEquivalences,r=i.get(t);if(!Ds.equal(n.selectedSegment,r))return;const s=n.baseSelectedSegment,o=function(e){return!(e.high>>>31)}(s),a=i.disjointSets.visibleSegmentEquivalencePolicy.value;a&up.NONREPRESENTATIVE_EXCLUDED&&o||a&up.REPRESENTATIVE_EXCLUDED&&!o||(this.lastAnchorBaseSegment.value=s.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return EI}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{let e=this.layer.anchorSegment.value,n=this.lastAnchorBaseSegment.value;if(void 0===e)return{anchorSegment:void 0,error:"Select anchor segment for merge"};const i=t.segmentEquivalences.get(e);return t.visibleSegments.has(i)?void 0!==n&&Ds.equal(t.segmentEquivalences.get(n),i)?{anchorSegment:n,error:void 0}:{anchorSegment:e,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:e,error:"Anchor segment must be in visible set"}},i=()=>{var e=n();let i=e.anchorSegment,r=e.error;if(void 0===i||void 0!==r)return{anchorSegment:i,error:r,otherSegment:void 0,anchorSegmentValid:!1};const s=this.layer.displayState,o=s.segmentSelectionState.baseValue;return void 0===o||Ds.equal(s.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(i))?{anchorSegment:i,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:i,otherSegment:o,error:void 0,anchorSegmentValid:!0}};var r=aw(e);const s=r.body;r.header.textContent="Merge segments",s.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(II),e.registerDisposer((()=>{yy(t)}));const o=()=>{Rv(s);const e=this.layer.displayState;var n=i();let r=n.anchorSegment,o=n.otherSegment,a=n.anchorSegmentValid,l=n.error;const c=e=>{const t=My(this.layer.displayState,e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t};if(void 0!==r&&s.appendChild(c(Sy(e,r))),void 0!==l){const e=document.createElement("span");e.textContent=l,s.appendChild(e)}if(void 0!==o){const t=document.createElement("span");t.textContent=" merge ",s.appendChild(t),s.appendChild(c(Sy(e,o)))}const d=t.segmentEquivalences;if(a){t.useTemporaryVisibleSegments.value=!0;const e=t.temporaryVisibleSegments;e.clear(),e.add(d.get(r)),void 0!==o&&e.add(d.get(o))}else yy(t)};o(),e.registerDisposer(xy(this.layer.displayState,s));const a=e.registerCancellable(al(o));Py(this.layer.displayState,e,a),e.registerDisposer(this.layer.anchorSegment.changed.add(a)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(a)),e.bindAction("merge-segments",(e=>{e.stopPropagation(),(async()=>{const e=t.graph.value;if(void 0===e)return;var n=i();const r=n.anchorSegment,s=n.otherSegment,o=n.error;if(void 0!==r&&void 0!==s&&void 0===o)try{await e.merge(r,s),Bp.showTemporaryMessage("Merge performed")}catch(a){Bp.showTemporaryMessage(`Merge failed: ${a}`)}})()})),e.bindAction("set-anchor",(e=>{e.stopPropagation();const n=this.layer.displayState.segmentSelectionState.baseValue;if(void 0===n)return;const i=this.layer.anchorSegment.value;t.visibleSegments.add(n),void 0!==i&&Ds.equal(i,n)||(this.layer.anchorSegment.value=n.clone())}))}get description(){return"merge"}}class PI extends JS{toJSON(){return LI}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{let e=this.layer.anchorSegment.value;if(void 0===e)return{anchorSegment:void 0,error:"Select anchor segment for split"};const n=t.segmentEquivalences.get(e);return t.visibleSegments.has(n)?{anchorSegment:e,error:void 0}:{anchorSegment:e,error:"Anchor segment must be in visible set"}};var i=aw(e);const r=i.body;i.header.textContent="Split segments",r.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(DI);const s=()=>{var e=n();let i=e.anchorSegment,r=e.error;if(void 0===i||void 0!==r)return{anchorSegment:i,error:r,otherSegment:void 0,anchorSegmentValid:!1};const s=this.layer.displayState,o=s.segmentSelectionState.baseValue;return void 0===o||!Ds.equal(s.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(i))||Ds.equal(o,i)?{anchorSegment:i,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:i,otherSegment:o,anchorSegmentValid:!0,error:void 0}};e.registerDisposer((()=>{yy(t)}));const o=()=>{Rv(r);const e=this.layer.displayState;var n=s();let i,o,a=n.anchorSegment,l=n.otherSegment,c=n.anchorSegmentValid,d=n.error;(()=>{const e=t.segmentEquivalences,n=this.layer.graphConnection;if(c&&void 0!==n){if(t.useTemporaryVisibleSegments.value=!0,void 0!==l){const e=n.computeSplit(a,l);if(void 0!==e){i=new my(a,e.includeRepresentative),o=new my(l,e.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;const n=e.includeRepresentative,r=e.excludeRepresentative,s=t.temporarySegmentEquivalences;s.clear();for(const t of e.includeBaseSegments)s.link(t,n);for(const t of e.excludeBaseSegments)s.link(t,r);const c=t.temporaryVisibleSegments;return c.clear(),c.add(n),void c.add(r)}}t.useTemporarySegmentEquivalences.value=!1;const r=t.temporaryVisibleSegments;r.clear(),r.add(e.get(a))}else yy(t)})();const u=e=>{const t=My(this.layer.displayState,e);return t.classList.add("neuroglancer-segment-list-entry-double-line"),t};if(void 0!==a&&r.appendChild(u(i??Sy(e,a))),void 0!==d){const e=document.createElement("span");e.textContent=d,r.appendChild(e)}if(void 0!==o){const e=document.createElement("span");e.textContent=" split ",r.appendChild(e),r.appendChild(u(o))}};e.registerDisposer(xy(this.layer.displayState,r)),o();const a=e.registerCancellable(al(o));Py(this.layer.displayState,e,a),e.registerDisposer(this.layer.anchorSegment.changed.add(a));const l=async e=>{const n=t.graph.value;if(void 0===n)return;var i=s();const r=i.anchorSegment,o=i.otherSegment,a=i.error;if(void 0!==r&&void 0!==o&&void 0===a)try{await n.split(r,o),e&&t.visibleSegments.add(t.segmentEquivalences.get(o)),Bp.showTemporaryMessage("Split performed")}catch(l){Bp.showTemporaryMessage(`Split failed: ${l}`)}};e.bindAction("split-segments",(e=>{e.stopPropagation(),l(!1)})),e.bindAction("split-and-select-segments",(e=>{e.stopPropagation(),l(!0)})),e.bindAction("set-anchor",(e=>{e.stopPropagation();const n=this.layer.displayState.segmentSelectionState.baseValue;if(void 0===n)return;t.visibleSegments.add(n);const i=this.layer.anchorSegment.value;void 0!==i&&Ds.equal(i,n)||(this.layer.anchorSegment.value=n.clone())}))}get description(){return"split"}}const AI="selectSegments",RI="mousedown0",NI=yv.fromObject({[`at:alt?+shift?+${RI}`]:"drag-select-segments"});var VI;!function(e){e[e.IDLE=0]="IDLE",e[e.SELECT=1]="SELECT",e[e.DESELECT=2]="DESELECT"}(VI||(VI={}));class OI extends JS{constructor(e){super(e)}toJSON(){return AI}activate(e){const t=this.layer;var n=aw(e);const i=n.body,r=n.header;let s=VI.IDLE,o=!1;e.bindInputEventMap(NI);const a=()=>2&Kb.value?VI.DESELECT:VI.SELECT,l=e=>{s!==e&&(s=e,o=!1,c())},c=()=>{Rv(i);const e=document.createElement("span");switch(s){case VI.IDLE:r.textContent="Select/Deselect segments",e.textContent=`${RI} to select segments; alt+${RI} to deselect segments.`;break;case VI.SELECT:case VI.DESELECT:r.textContent=(s==VI.SELECT?"Select":"Deselect")+" segments",e.textContent=`Drag to ${s==VI.SELECT?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}i.appendChild(e)};c();const d=()=>{if(s==VI.IDLE)return;const e=t.displayState.segmentSelectionState;if(e.hasSelectedSegment){const n=e.selectedSegment,i=t.displayState.segmentationGroupState.value.visibleSegments;switch(s){case VI.SELECT:i.add(n);break;case VI.DESELECT:i.delete(n)}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add((()=>{o&&d()}))),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(c)),e.registerDisposer(Kb.changed.add((()=>{s!=VI.IDLE&&l(a())})));e.bindAction("drag-select-segments",(e=>((e,t)=>{e.stopPropagation(),l(t),d();const n=e.detail.screenX,i=e.detail.screenY;Hv(e.detail,((e,t,r)=>{if(!o){const t=e.screenX-n,r=e.screenY-i;t*t+r*r>25&&(d(),o=!0)}}),(e=>{o=!1,l(VI.IDLE)}))})(e,a())))}get description(){return"select"}}const BI=new Ds;class _I extends Sn{constructor(e,t,n,i){super(),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=n,this.parentElement=i,this.changed=new Cn,this.explicitSegmentsVisible=!1,this.visibleSegmentsGeneration=-1,this.queryResult=new En(void 0),this.statusText=new En(""),this.selectedMatches=0,this.matchStatusTextPrefix="",this.debouncedUpdate=mn((()=>this.update()),0),this.render=e=>{const t=this.explicitSegments;let n,i=!1;if(void 0!==t&&e<t.length)n=t[e],i=this.explicitSegmentsVisible;else{void 0!==t&&(e-=t.length),n=BI;const i=this.queryResult.value.indices[e],r=this.segmentPropertyMap.segmentPropertyMap.inlineProperties.ids;n.low=r[2*i],n.high=r[2*i+1]}const r=this.segmentWidgetFactory.get(n);return i&&(r.dataset.visibleList="true"),r},this.update(),this.registerDisposer(n.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e,t;return null!==(t=null===(e=this.queryResult.value)||void 0===e?void 0:e.count)&&void 0!==t?t:0}update(){var e;const t=this.query.value,n=this.segmentPropertyMap,i=this.queryResult.value;let r;if(this.prevQuery===t)r=i;else{const e=function(e,t){var n;if(null!==t.match(lE)){const e=t.split(/[\s,]+/),n=[],i=new Rt;for(let t=0,r=e.length;t<r;++t){const r=e[t];if(""===r)continue;const s=new Ds;if(!s.tryParseString(r))continue;const o=s.toString();i.has(o)||(i.add(o),n.push(s))}return n.sort(Ds.compare),{ids:n}}const i={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},r=null===(n=e?.segmentPropertyMap.inlineProperties)||void 0===n?void 0:n.properties,s=e?.tags,o=s?.tags||[],a=o.map((e=>e.toLowerCase())),l=e?.labels,c=[];let d;for(let h=0;h<t.length;h=d){let n,s=t.indexOf(" ",h);if(d=-1===s?s=t.length:s+1,n=t.substring(h,s),0===n.length)continue;const p=(e,t)=>{const n=e.toLowerCase(),r=a.indexOf(n);if(-1!==r){if(e=o[r],!i.includeTags.includes(e)&&!i.excludeTags.includes(e))return e;c.push({begin:t,end:s,message:`Duplicate tag: ${e}`})}else c.push({begin:t,end:s,message:`Invalid tag: ${e}`})};if(n.startsWith("#")){const e=p(n.substring(1),h+1);void 0!==e&&i.includeTags.push(e);continue}if(n.startsWith("-#")){const e=p(n.substring(2),h+2);void 0!==e&&i.excludeTags.push(e);continue}if(n.startsWith("<")||n.startsWith(">")){let e=n.substring(1).toLowerCase();if("id"!==e&&"label"!==e){const t=r?.find((t=>t.id.toLowerCase()===e&&("number"===t.type||"label"===t.type||"string"===t.type)));if(void 0===t){c.push({begin:h+1,end:s,message:`Invalid field: ${e}`});continue}e=t.id}if(void 0!==i.sortBy.find((t=>t.fieldId===e))){c.push({begin:h+1,end:s,message:`Duplicate sort field: ${e}`});continue}i.sortBy.push({order:n[0],fieldId:e});continue}if(n.startsWith("|")){let e=n.substring(1).toLowerCase();if("id"===e||"label"===e)continue;const t=r?.find((t=>t.id.toLowerCase()===e&&("number"===t.type||"string"===t.type)));if(void 0===t){c.push({begin:h+1,end:s,message:`Invalid field: ${e}`});continue}if(e=t.id,i.sortBy.find((t=>t.fieldId===e))||i.includeColumns.find((t=>t===e)))continue;i.includeColumns.push(e);continue}if(n.startsWith("/")){if(void 0!==i.regexp){c.push({begin:h,end:s,message:"Only one regular expression allowed"});continue}if(void 0!==i.prefix){c.push({begin:h,end:s,message:"Prefix cannot be combined with regular expression"});continue}if(void 0===l){c.push({begin:h,end:s,message:"No label property"});continue}try{i.regexp=new RegExp(n.substring(1))}catch{c.push({begin:h,end:s,message:"Invalid regular expression syntax"})}continue}const f=n.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(null===f)void 0===i.regexp?void 0!==l?void 0!==i.prefix?i.prefix+=` ${n}`:i.prefix=n:c.push({begin:h,end:s,message:"No label property"}):c.push({begin:h,end:s,message:"Prefix cannot be combined with regular expression"});else{let t=f[1].toLowerCase();const n=f[2],r=e?.numericalProperties.find((e=>e.id.toLowerCase()===t));if(void 0===r){c.push({begin:h,end:h+t.length,message:`Invalid numerical field: ${t}`});continue}let o;t=r.id;try{o=Us(r.dataType,f[3])}catch(u){c.push({begin:h+f[1].length+f[2].length,end:s,message:u.message});continue}let a=i.numericalConstraints.find((e=>e.fieldId===t));void 0===a&&(a={fieldId:t,bounds:r.bounds},i.numericalConstraints.push(a));const l=Ns(r.bounds,a.bounds[0]),d=Ns(r.bounds,a.bounds[1]);let p=d,g=l;switch(n){case"<":p=js(r.dataType,o,-1);break;case"<=":p=o;break;case"=":p=g=o;break;case">=":g=o;break;case">":g=js(r.dataType,o,1)}if(g=_s(l,g)>0?l:g,p=_s(d,p)<0?d:p,_s(g,p)>0){c.push({begin:h,end:s,message:"Constraint would not match any values"});continue}a.bounds=[g,p]}}return c.length>0?{errors:c}:(0===i.sortBy.length&&i.sortBy.push({fieldId:uE(e),order:"<"}),i)}(n,t);r=function(e,t){var n;if(void 0!==t.errors)return{query:t,total:-1,count:0,errors:t.errors};if(void 0!==t.ids){const e=t.ids;return{query:t,total:-1,explicitIds:e,count:e.length}}const i=null===(n=e?.segmentPropertyMap)||void 0===n?void 0:n.inlineProperties;if(void 0===i)return{query:t,count:0,total:-1};const r=i?.properties,s=i.ids.length/2;let o=eE(s,s);for(let w=0;w<s;++w)o[w]=w;const a=e=>{let t=o.length,n=0;for(let i=0;i<t;++i){const t=o[i];e(t)&&(o[n]=t,++n)}o=o.subarray(0,n)};if(void 0!==t.regexp||void 0!==t.prefix){const n=e.labels.values,i=t.regexp,r=t.prefix;void 0!==i&&a((e=>null!==n[e].match(i))),void 0!==r&&a((e=>n[e].startsWith(r)))}const l=t.includeTags,c=t.excludeTags,d=e.tags;if(l.length>0||c.length>0){const e=d.values,t=d.tags,n=[];for(const a of l)n.push([t.indexOf(a),1]);for(const a of c)n.push([t.indexOf(a),0]);n.sort(((e,t)=>e[0]-t[0]));let i="^",r=0;const s=e=>{e<r||(i+=`[${cE(r)}-${cE(e)}]*`)};for(const a of n){var u=O(a,2);const e=u[0],t=u[1];s(e-1),t&&(i+=cE(e)),r=e+1}s(65535),i+="$";const o=new RegExp(i);a((t=>null!==e[t].match(o)))}let h,p;const f=t.numericalConstraints;if(f.length>0){const t=e.numericalProperties,n=f.length,i=2**n-1;h=eE(o.length,i);for(let e=0;e<n;++e){const n=f[e],i=t.find((e=>e.id===n.fieldId)).values,r=2**e;var g=O(n.bounds,2);const s=g[0],a=g[1];for(let e=0,t=o.length;e<t;++e){const t=i[o[e]];h[e]|=r*(t>=s&&t<=a)}}p=o,o=p.slice();let r=o.length,s=0;for(let e=0;e<r;++e)h[e]===i&&(o[s]=o[e],++s);o=o.subarray(0,s)}let m=[];if(void 0!==d){const e=[],n=d.tags,i=d.values,r=new Uint32Array(n.length);for(let t=0,s=o.length;t<s;++t){const e=i[o[t]];for(let t=0,n=e.length;t<n;++t)++r[e.charCodeAt(t)]}for(let s=0,o=n.length;s<o;++s){const i=r[s],o=n[s],a={tag:o,tagIndex:s,count:r[s]};t.includeTags.includes(o)||t.excludeTags.includes(o)?e.push(a):i>0&&m.push(a)}e.push(...m),m=e}const v=(e,t)=>{if("number"!==e.type){const n=e.values;o.sort(((e,i)=>Kp(n[e],n[i])*t))}else{const n=e.values;o.sort(((e,i)=>(n[e]-n[i])*t))}},y=t=>{void 0!==d&&v(d,t);const n=e?.labels;void 0!==n&&v(n,t)},b=t.sortBy;for(let w=b.length-1;w>=0;--w){var S=b[w];const e=S.fieldId,t=S.order,n="<"===t?1:-1;if("id"!==e)"label"===e?y(n):v(r.find((t=>t.id===e)),n);else{if(w+1===b.length){if("<"===t)continue;o.reverse();continue}o.sort(((e,t)=>n*(e-t)))}}return{query:t,intermediateIndices:p,intermediateIndicesMask:h,indices:o,tags:m,count:o.length,total:s}}(n,e)}const s=[];let o=!1,a="";const l=this.segmentationDisplayState.segmentationGroupState.value.visibleSegments,c=l.changed.count,d=this.visibleSegmentsGeneration,u=function(e){return void 0===e.ids&&(void 0!==e.errors||!(e.numericalConstraints.length>0||e.includeTags.length>0||e.excludeTags.length>0||e.prefix||e.regexp))}(r.query);if(u){if(d===c&&void 0!==this.explicitSegments&&this.explicitSegmentsVisible)s.push({retainCount:this.explicitSegments.length,deleteCount:0,insertCount:0});else{this.visibleSegmentsGeneration=c;const e=It(l,(e=>e.clone()));e.sort(Ds.compare);const t=this.explicitSegments;void 0===t?(this.explicitSegments=e,s.push({retainCount:0,insertCount:e.length,deleteCount:0})):s.push(...function(e,t,n){const i=[];let r=0,s=0,o=e.length,a=t.length;for(;r<o&&s<a;){let l,c=e[r],d=t[s];if(l=n(c,d),0!==l){if(l<0){let t=1;for(;++r<o&&(l=n(e[r],d))<0;)++t;i.push({retainCount:0,deleteCount:t,insertCount:0})}else if(l>0){let e=1;for(;++s<a&&(l=n(c,t[s]))>0;)++e;i.push({retainCount:0,deleteCount:0,insertCount:e})}}else{let c=1;for(++r,++s;r<o&&s<a&&0===(l=n(e[r],t[s]));)++c,++r,++s;i.push({retainCount:c,deleteCount:0,insertCount:0})}}return(r<o||s<a)&&i.push({retainCount:0,deleteCount:o-r,insertCount:a-s}),i}(t,e,Ds.compare)),this.explicitSegments=e,o=!0}this.explicitSegmentsVisible=!0}else this.visibleSegmentsGeneration=c,void 0!==this.explicitSegments&&this.explicitSegmentsVisible&&(s.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0),this.explicitSegmentsVisible=!1;const h=r.explicitIds;if(void 0!==h?this.explicitSegments=h:this.explicitSegmentsVisible||(this.explicitSegments=void 0),i!==r&&(s.push({retainCount:0,deleteCount:null!==(e=i?.count)&&void 0!==e?e:0,insertCount:r.count}),o=!0,this.queryResult.value=r),void 0!==r.explicitIds?a=`${r.count} ids`:u?a=`${r.count} listed ids`:r.total>0&&(a=`${r.count}/${r.total} matches`),i!==r||c!==d){let e=a,t=0;void 0!==n&&r.count>0&&(t=function(e,t,n){if(0===n.size)return 0;let i=0;return pE(e,t,(e=>{n.has(e)&&++i})),i}(n,r,l),e+=` (${t} visible)`),this.selectedMatches=t,this.statusText.value=e}this.prevQuery=t,this.matchStatusTextPrefix=a;const p=this.explicitSegments;this.length=(this.explicitSegmentsVisible?p.length:0)+r.count,o&&this.changed.dispatch(s)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem((e=>{this.updateRendering(e)}))}}const FI=yv.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}});function zI(e){Vv(e,Math.max(1,e.value.length+.1))}function UI(e,t){let n;if(mr(t))n=t.toString();else{const e=t.toString(),i=t.toPrecision(6);n=e.length<i.length?e:i}e.value=n,zI(e)}function GI(e,t,n){var r;const s=e?.query,o=s?.sortBy;if(void 0===o)return;const a=s.includeColumns,l="<"===(null===(r=o.find((e=>e.fieldId===n)))||void 0===r?void 0:r.order)?">":"<",c=a.filter((e=>e!==n));for(const i of o)"id"!==i.fieldId&&"label"!==i.fieldId&&i.fieldId!==n&&c.push(i.fieldId);t((0,i.bn)((0,i.bn)({},s),{sortBy:[{fieldId:n,order:l}],includeColumns:c}))}function WI(e,t,n){var i,r;const s=null===(i=e?.query)||void 0===i?void 0:i.sortBy,o=null===(r=s?.find((e=>e.fieldId===n)))||void 0===r?void 0:r.order;t.textContent=">"===o?"\u25bc":"\u25b2",t.style.visibility=void 0===o?"":"visible",t.title=`Sort by ${n} in ${"<"===o?"descending":"ascending"} order`}class $I extends Sn{constructor(e,t,n){super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=n,this.propertyHistograms=[],this.bounds={window:new En([]),range:new En([])},this.throttledUpdate=this.registerCancellable(qf((()=>this.updateHistograms()),100)),this.debouncedRender=this.registerCancellable(al((()=>this.updateHistogramRenderings()))),this.debouncedSetQuery=this.registerCancellable(mn((()=>this.setQueryFromBounds()),200));const i=e?.numericalProperties,r=[];let s;if(void 0!==i&&i.length>0){s=document.createElement("details");const e=document.createElement("summary");e.textContent=`${i.length} numerical propert${i.length>1?"ies":"y"}`,s.appendChild(e),s.classList.add("neuroglancer-segment-query-result-numerical-list");const t=this.bounds.window.value;for(let n=0,o=i.length;n<o;++n){const e=i[n],o=this.makeNumericalPropertySummary(n,e);r.push(o),s.appendChild(o.element),t[n]=e.bounds}}this.listElement=s,this.properties=r,this.registerDisposer(this.queryResult.changed.add((()=>{this.handleNewQueryResult()}))),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){const e=this.queryResult.value;if(void 0===e||void 0===e.indices)return;const t=e.query,n=[],r=this.bounds.range.value,s=this.properties;for(let i=0,o=s.length;i<o;++i){const e=s[i].property;n.push({fieldId:e.id,bounds:r[i]})}this.setQuery((0,i.bn)((0,i.bn)({},t),{numericalConstraints:n}))}getBounds(e){const t=this.bounds;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){const n=this.properties[e].property;let i=Vs(n.bounds,t.range);_s(i[0],i[1])>0&&(i=[i[1],i[0]]);const r=Vs(n.bounds,t.window),s=this.getBounds(e),o=this.properties[e].property.dataType;Ws(o,r,s.window)||(this.bounds.window.value[e]=r,this.bounds.window.changed.dispatch()),Ws(o,i,s.range)||(this.bounds.range.value[e]=i,this.bounds.range.changed.dispatch())}setBound(e,t,n,i){i=Ns(this.segmentPropertyMap.numericalProperties[n].bounds,i);const r=gI(this.getBounds(n),e,t,i,!0);this.setBounds(n,r)}handleNewQueryResult(){const e=this.queryResult.value;if(void 0!==this.listElement){if(void 0!==e?.indices){const t=e.query.numericalConstraints,n=this.segmentPropertyMap.numericalProperties,i=this.bounds.range.value,r=t.length,s=n.length;i.length=s;for(let e=0;e<s;++e)i[e]=n[e].bounds;for(let e=0;e<r;++e){const r=t[e];i[n.findIndex((e=>e.id===r.fieldId))]=r.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){const e=this.queryResult.value;void 0!==this.listElement&&(function(e,t,n,i){if(void 0===e)return n.length=0,void(i.length=0);const r=e.numericalProperties,s=r.length;if(void 0!==t?.indices)for(let o=0;o<s;++o){const e=n[o],s=i[o],a=r[o];void 0!==e&&e.queryResult===t&&Ws(a.dataType,e.window,s)||(n[o]=dE(t,a,s))}else n.length=0}(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();const e=this.listElement;if(void 0===e)return;const t=this.propertyHistograms;if(0===t.length)return void(e.style.display="none");e.style.display="";const n=this.properties;for(let i=0,r=n.length;i<r;++i)this.updateNumericalPropertySummary(i,n[i],t[i])}makeNumericalPropertySummary(e,t){const n=document.createElement("div");n.classList.add("neuroglancer-segment-query-result-numerical-plot-container");const r=document.createElement("img");r.classList.add("neuroglancer-segment-query-result-numerical-plot");const s=new pI(r,t.dataType,(()=>this.getBounds(e)),(t=>this.setBounds(e,t))),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");const a=document.createElement("input");a.type="checkbox",a.addEventListener("click",(()=>{!function(e,t,n){if(void 0===e||void 0===e.indices)return;const r=e.query;let s=r.sortBy,o=r.includeColumns;gE(r,n)?(s=s.filter((e=>e.fieldId!==n)),o=o.filter((e=>e!==n))):o.push(n),t((0,i.bn)((0,i.bn)({},r),{sortBy:s,includeColumns:o}))}(this.queryResult.value,this.setQuery,t.id)}));const l=n=>{const i=document.createElement("div");i.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),i.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${n}`);const r=i=>{const r=function(e,t){const n=document.createElement("input");return n.addEventListener("focus",(()=>{n.select()})),n.classList.add(`neuroglancer-segment-query-result-numerical-plot-${e}-bound`),n.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),n.type="text",n.spellcheck=!1,n.autocomplete="off",n.title=(0===t?"Lower":"Upper")+" bound "+("range"===e?"range":"for distribution"),n.addEventListener("input",(()=>{zI(n)})),n}(n,i);return r.addEventListener("change",(()=>{if(void 0!==this.bounds[n].value[e]){try{const s=Us(t.dataType,r.value);this.setBound(n,i,e,s),this.bounds[n].changed.dispatch()}catch{}UI(r,this.bounds[n].value[e][i])}})),r},s=[r(0),r(1)];let l;if("range"===n){l=[document.createElement("div"),document.createElement("div"),document.createElement("div")],l[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),l[1].appendChild(a);const e=document.createElement("span");e.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),e.appendChild(document.createTextNode(t.id)),e.appendChild(o),e.addEventListener("click",(()=>{GI(this.queryResult.value,this.setQuery,t.id)})),l[1].appendChild(e);const n=t.description;n&&(l[1].title=n),i.appendChild(l[0]),i.appendChild(s[0]);const r=document.createElement("div");r.textContent="\u2264",r.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),i.appendChild(r),i.appendChild(l[1]);const c=document.createElement("div");c.textContent="\u2264",c.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),i.appendChild(c),i.appendChild(s[1]),i.appendChild(l[2])}else i.appendChild(s[0]),i.appendChild(s[1]);return{container:i,spacers:l,inputs:s}},c={range:l("range"),window:l("window")};return n.appendChild(c.range.container),n.appendChild(r),n.appendChild(c.window.container),{property:t,controller:s,element:n,plotImg:r,boundElements:c,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:a,sortIcon:o}}updateNumericalPropertySummary(e,t,n){const i=t.bounds.window,r=this.bounds.window.value[e],s=t.bounds.range,o=this.bounds.range.value[e],a=t.property,l=this.queryResult.value,c=gE(l?.query,a.id);if(t.columnCheckbox.checked=c,t.columnCheckbox.title=c?"Remove column from result table":"Add column to result table",WI(l,t.sortIcon,a.id),t.propertyHistogram===n&&Ws(a.dataType,i,r)&&Ws(a.dataType,s,o))return;const d=n.histogram,u="http://www.w3.org/2000/svg",h=document.createElementNS(u,"svg");h.setAttribute("width","1"),h.setAttribute("height","1"),h.setAttribute("preserveAspectRatio","none");const p=document.createElementNS(u,"rect"),f=As(r,o[0]),g=As(r,o[1]);p.setAttribute("x",`${f}`),p.setAttribute("y","0"),p.setAttribute("width",""+(g-f)),p.setAttribute("height","1"),p.setAttribute("fill","#4f4f4f"),h.appendChild(p);const m=d.length,v=(e,t,i)=>{const s=document.createElementNS(u,"polyline");let o="",a=0;for(let n=e;n<i;++n)a+=d[n];if(0===a)return;const l=As(r,n.window[0]),c=As(r,n.window[1]),h=(e,t)=>{const n=e/(m-2);o+=` ${l*(1-n)+c*n},${1-t}`};0!==e&&h(e,0);let p=0;for(let n=e;n<t;++n){p+=d[n],h(n,p/a)}return s.setAttribute("fill","none"),s.setAttribute("stroke-width","1px"),s.setAttribute("points",o),s.setAttribute("vector-effect","non-scaling-stroke"),s};{const e=v(0,m-1,m);void 0!==e&&(e.setAttribute("stroke","cyan"),h.appendChild(e))}if(!Ws(a.dataType,a.bounds,o)){const e=Math.floor(Math.max(0,Math.min(1,As(n.window,o[0])))*(m-2)),t=Math.ceil(Math.max(0,Math.min(1,As(n.window,o[1])))*(m-2)),i=v(e,t,t);void 0!==i&&(i.setAttribute("stroke","white"),h.appendChild(i))}const y=(new XMLSerializer).serializeToString(h);t.plotImg.src=`data:image/svg+xml;base64,${btoa(y)}`,t.propertyHistogram=n;for(let k=0;k<2;++k)i[k]=r[k],UI(t.boundElements.window.inputs[k],r[k]),s[k]=o[k],UI(t.boundElements.range.inputs[k],o[k]);const b=t.boundElements.range.spacers,S=Vs(r,o),w=Hs(a.dataType,r),x=As(r,S[0])*w,C=As(r,S[1])*w+(1-w);b[0].style.width=100*x+"%",b[2].style.width=100*(1-C)+"%"}}class jI extends TS{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new hy(e.displayState.segmentationGroupState.value.graph,((t,n,i)=>{if(void 0===t)return;const r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(ow(i,e,{toolJson:EI,label:"Merge",title:"Merge segments"})),r.appendChild(ow(i,e,{toolJson:LI,label:"Split",title:"Split segments"})),n.appendChild(r)}))).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(ow(this,e,{toolJson:AI,label:"Select",title:"Select/Deselect segments"})),t.appendChild(n);const i=document.createElement("input");i.classList.add("neuroglancer-segment-list-query"),i.addEventListener("focus",(()=>{i.select()}));this.registerDisposer(new tS(i,FI)).allShortcutsAreGlobal=!0;const r=this.layer.displayState.segmentQuery,s=this.registerCancellable(mn((()=>{r.value=i.value}),200));i.autocomplete="off",i.title=FI.describe(),i.spellcheck=!1,i.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(Fn((e=>{i.value=e}),r)),this.registerDisposer(Fn((e=>{Date.now()-e<100&&(setTimeout((()=>{i.focus()}),0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)}),this.layer.segmentQueryFocusTime)),t.appendChild(i),t.appendChild(this.registerDisposer(new hy(e.displayState.segmentPropertyMap,((t,n,o)=>{const a=e=>{i.focus(),i.select();const n=function(e,t){const n=t.ids;if(void 0!==n)return n.map((e=>e.toString())).join(", ");let i="";var r=t;const s=r.prefix,o=r.regexp;void 0!==s?i=s:void 0!==o&&(i=`/${o}`);for(const c of t.includeTags)i.length>0&&(i+=" "),i+=`#${c}`;for(const c of t.excludeTags)i.length>0&&(i+=" "),i+=`-#${c}`;for(const c of t.numericalConstraints){const t=c.fieldId,n=c.bounds;var a=O(n,2);const r=a[0],s=a[1],o=e.numericalProperties.find((e=>e.id===t));if(!Ws(o.dataType,o.bounds,n)){if(0===_s(r,s)){i.length>0&&(i+=" "),i+=`${t}=${r}`;continue}if(_s(r,o.bounds[0])>0){i.length>0&&(i+=" ");const e=js(o.dataType,r,-1),n=r.toString(),s=e.toString();o.dataType!==sr.FLOAT32||n.length<=s.length?i+=`${t}>=${n}`:i+=`${t}>${s}`}if(_s(s,o.bounds[1])<0){i.length>0&&(i+=" ");const e=js(o.dataType,s,1),n=s.toString(),r=e.toString();o.dataType!==sr.FLOAT32||n.length<=r.length?i+=`${t}<=${n}`:i+=`${t}<${r}`}}}let l=t.sortBy;if(1===l.length){const t=l[0];"<"===t.order&&t.fieldId===uE(e)&&(l=[])}for(const c of l)i.length>0&&(i+=" "),i+=`${c.order}${c.fieldId}`;for(const c of t.includeColumns)i.length>0&&(i+=" "),i+=`|${c}`;return i}(t,e);document.execCommand("insertText",!1,n),r.value=n,i.select()},l=o.registerDisposer(new _I(r,t,e.displayState,n)),c=e.displayState.segmentationGroupState.value,d=document.createElement("ul");d.classList.add("neuroglancer-segment-query-errors"),n.appendChild(d);const u=document.createElement("div");u.classList.add("neuroglancer-segment-query-result-statistics");const h=document.createElement("span"),p=document.createElement("input");p.type="checkbox",p.checked=!0,p.title="Deselect all segment IDs",p.addEventListener("change",(()=>{c.visibleSegments.clear()}));const f=dy({title:"Copy visible segment IDs",onClick:()=>{const e=It(c.visibleSegments,(e=>e.clone()));e.sort(Ds.compare),ay(e.join(", "))}}),g=document.createElement("span");h.appendChild(f),h.appendChild(p),h.appendChild(g);const m=document.createElement("span"),v=document.createElement("input"),y=dy({onClick:()=>{s(),s.flush(),l.debouncedUpdate.flush();const e=l.queryResult.value;if(void 0===e)return;const n=new Array(e.count);pE(t,e,((e,t)=>{n[t]=e.toString()})),ay(n.join(", "))}});v.type="checkbox";const b=()=>{s(),s.flush(),l.debouncedUpdate.flush();const e=l.queryResult.value;if(void 0===e)return;const n=c.visibleSegments,i=l.selectedMatches,r=i!==e.count;if(r&&e.count-i>100){if(!k)return k=!0,S.textContent=`Confirm: show ${e.count-i} segments?`,!1;k=!1,C()}return pE(t,e,(e=>{n.set(e,r)})),!0};v.addEventListener("click",(e=>{b()||e.preventDefault()}));const S=document.createElement("span");m.appendChild(y),m.appendChild(v),m.appendChild(S),h.classList.add("neuroglancer-segment-list-status"),m.classList.add("neuroglancer-segment-list-status"),n.appendChild(u);const w=document.createElement("div");w.classList.add("neuroglancer-segment-query-result-statistics-separator"),n.appendChild(w),n.appendChild(m),n.appendChild(h);let x=-1;const C=()=>{const e=c.visibleSegments.size;x!==e&&(x=e,g.textContent=`${e} visible in total`,p.checked=e>0,p.style.visibility=e?"visible":"hidden",f.style.visibility=e?"visible":"hidden"),S.textContent=l.statusText.value;const t=l.numMatches,n=l.selectedMatches;y.style.visibility=t?"visible":"hidden",y.title=`Copy ${t} segment ID(s)`,v.style.visibility=t?"visible":"hidden",0===n?(v.checked=!1,v.indeterminate=!1,v.title=`Show ${t} segment ID(s)`):n===t?(v.checked=!0,v.indeterminate=!1,v.title=`Hide ${n} segment ID(s)`):(v.checked=!0,v.indeterminate=!0,v.title=`Show ${t-n} segment ID(s)`)};C(),l.statusText.changed.add(C),o.registerDisposer(c.visibleSegments.changed.add(C));let k=!1;o.registerEventListener(i,"input",(()=>{s(),k&&(k=!1,C())})),o.registerDisposer(Cv(i,"cancel",(()=>{i.focus(),i.select(),document.execCommand("delete"),i.blur(),i.value="",r.value="",k=!1,C()}))),o.registerDisposer(Cv(i,"toggle-listed",b)),o.registerDisposer(Cv(i,"hide-all",(()=>{c.visibleSegments.clear()}))),o.registerDisposer(Cv(i,"hide-listed",(()=>{s(),s.flush(),l.debouncedUpdate.flush();const e=c.visibleSegments;if(""===r.value)e.clear();else{const n=l.queryResult.value;if(void 0===n)return;pE(t,n,(t=>{e.delete(t)}))}})));const T=o.registerDisposer(new yS({source:l,horizontalScroll:!0})),E=o.registerCancellable(al((()=>{l.updateRenderedItems(T)}))),L=this.layer.displayState;o.registerDisposer(L.segmentSelectionState.changed.add(E)),o.registerDisposer(c.visibleSegments.changed.add(E)),o.registerDisposer(L.segmentColorHash.changed.add(E)),o.registerDisposer(L.segmentStatedColors.changed.add(E)),o.registerDisposer(L.segmentDefaultColor.changed.add(E)),T.element.classList.add("neuroglancer-segment-list"),o.registerDisposer(e.bindSegmentListWidth(T.element)),o.registerDisposer(new ly(T.element,Mv()));const I=o.registerDisposer(new $I(t,l.queryResult,a));{const e=I.listElement;void 0!==e&&u.appendChild(e)}let D;Fn((e=>{if(l.segmentWidgetFactory=new Dy(l.segmentationDisplayState,l.parentElement,(t=>gE(e?.query,t.id))),T.scrollToTop(),Rv(T.header),void 0!==t){const t=l.segmentWidgetFactory.getHeader();t.container.classList.add("neuroglancer-segment-list-header");for(const n of t.propertyLabels){const t=n.label,i=n.sortIcon,r=n.id;t.addEventListener("click",(()=>{GI(l.queryResult.value,a,r)})),WI(e,i,r)}T.header.appendChild(t.container)}if((e=>{const t=e?.errors;if(Rv(d),void 0!==t)for(const n of t){const e=document.createElement("li");e.textContent=n.message,d.appendChild(e)}})(e),w.style.display="none",D?.remove(),void 0===e)return;let n=e.query;void 0!==n.errors||void 0!==n.ids||(D=function(e,t){const n=e.tags;if(void 0===n||0===n.length)return;const i=e.query,r=document.createElement("div");r.classList.add("neuroglancer-segment-query-result-tag-list");for(const s of n){const n=s.tag,o=s.count,a=document.createElement("div");a.classList.add("neuroglancer-segment-query-result-tag");const l=document.createElement("span");l.classList.add("neuroglancer-segment-query-result-tag-name"),l.textContent=n,r.appendChild(a);const c=i.includeTags.includes(n),d=i.excludeTags.includes(n);let u;u=c?"Remove tag from required set":d?"Remove tag from excluded set":"Add tag to required set",l.addEventListener("click",(()=>{t(fE(i,n,!0,!c&&!d))})),l.title=u;const h=c||d,p=r=>{const s=r?o:e.count-o,l=document.createElement("div");if(l.classList.add("neuroglancer-segment-query-result-tag-toggle"),l.classList.add("neuroglancer-segment-query-result-tag-"+(r?"include":"exclude")),a.appendChild(l),!h&&0===s)return;const u=r?c:d;l.appendChild(new cy({get value(){return u},set value(e){t(fE(i,n,r,e))},changed:Tn},{text:r?"+":"-",enableTitle:`Add tag to ${r?"required":"exclusion"} set`,disableTitle:`Remove tag from ${r?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};p(!0),p(!1),a.appendChild(l);const f=document.createElement("span");f.classList.add("neuroglancer-segment-query-result-tag-count"),h||(f.textContent=o.toString()),a.appendChild(f)}return r}(e,a),void 0!==D&&u.appendChild(D),(I.properties.length>0||void 0!==D)&&(w.style.display=""))}),l.queryResult),n.appendChild(T.element)}))).element)}}function HI(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({text:"?"},e))}function JI(e,t,n,i){const r=document.createElement("label");r.classList.add("neuroglancer-layer-control-container");const s=document.createElement("div");s.classList.add("neuroglancer-layer-control-label-container");const o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),s.appendChild(o);const a=document.createElement("div");a.classList.add("neuroglancer-layer-control-label-text-container"),a.appendChild(document.createTextNode(n.label)),o.appendChild(a),n.title&&(o.title=n.title),r.appendChild(s);var l=n.makeControl(t,e,{labelContainer:s,labelTextContainer:a,display:t.manager.root.display,visibility:i});const c=l.control,d=l.controlElement;return d.classList.add("neuroglancer-layer-control-control"),r.appendChild(d),{controlContainer:r,label:o,labelContainer:s,labelTextContainer:a,control:c}}class qI extends JS{constructor(e,t){super(e),this.options=t}activate(e){const t=this.options,n=this.layer,i=t.isValid;if(void 0!==i&&!i(n).value)return;var r=aw(e);const s=r.header,o=r.body;var a=JI(e,n,t,new kd(kd.VISIBLE));const l=a.controlContainer,c=a.control,d=a.labelContainer;s.appendChild(d),o.appendChild(l),t.activateTool(e,c)}get description(){var e;const t=this.options;return null!==(e=t.toolDescription)&&void 0!==e?e:t.label}toJSON(){return this.options.toolJson}}function YI(e,t,n,i){var r=JI(e,t,n,i);const s=r.controlContainer,o=r.label;return s.classList.add("neuroglancer-layer-options-control-container"),o.prepend(e.registerDisposer(new rw(t,n.toolJson)).element),s}function ZI(e,t,n,i){const r=i.isValid;return void 0===r?YI(e,t,i,n):e.registerDisposer(new hy(r(t),((e,r,s)=>{e&&r.appendChild(YI(s,t,i,n))}),n)).element}function XI(e,t){const n=t.toolJson;ew(e,"string"==typeof n?n:n.type,(e=>new qI(e,t)))}class KI extends Sn{constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");const t=this.element,n=this.label,i=this.topRow,r=this.selectElement,s=this.linkedLayers,o=this.unlinkButton;i.appendChild(n),i.appendChild(r),i.appendChild(o),o.textContent="Unlink",o.addEventListener("click",(()=>{this.group.isolate()})),t.appendChild(i),t.appendChild(s),this.updateView();const a=mn((()=>this.updateView()),0);this.registerEventListener(r,"change",(()=>{this.updateModel(),a()})),this.registerDisposer(this.group.changed.add(a)),this.registerDisposer(this.group.linkedLayersChanged.add(a)),this.registerDisposer(this.group.layerManager.layersChanged.add(a))}updateModel(){const e=this.selectElement.value;""===e&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){var e;const t=this.selectElement,n=this.group,i=n.predicate;Rv(t);const r=0!==this.group.rootGroup.linkedLayers.size;this.unlinkButton.style.display=r?"":"none";const s=this.linkedLayers,o=0!==n.linkedLayers.size;if(s.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",t.style.display="none",Rv(s);for(const e of n.linkedLayers){const t=document.createElement("div");t.classList.add("neuroglancer-linked-layer-widget-layer");const n=qv({title:"Unlink layer",onClick:()=>{this.group.getGroup(e).isolate()}});t.appendChild(n),t.appendChild(document.createTextNode(e.managedLayer.name)),s.appendChild(t)}}else{t.style.display="";const r=document.createElement("option");t.appendChild(r);let s=0;for(const e of this.group.layerManager.managedLayers){const r=e.layer;if(null!==r&&r!==n.layer&&i(r)){++s;const n=document.createElement("option"),i=e.name;n.textContent=i,n.value=i,t.appendChild(n)}}t.value=null!==(e=n.toJSON())&&void 0!==e?e:"",this.element.style.display=0===s?"none":""}}}function QI(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Jv((0,i.bn)({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0ibWF4aW1pc2VJY29uVGl0bGUiPgogICAgPHRpdGxlIGlkPSJtYXhpbWlzZUljb25UaXRsZSI+TWF4aW1pc2UgVmlldzwvdGl0bGU+ICAgIAogICAgPHBvbHlsaW5lIHBvaW50cz0iMjEgMTYgMjEgMjEgMTYgMjEiLz4KICAgIDxwb2x5bGluZSBwb2ludHM9IjggMjEgMyAyMSAzIDE2Ii8+CiAgICA8cG9seWxpbmUgcG9pbnRzPSIxNiAzIDIxIDMgMjEgOCIvPgogICAgPHBvbHlsaW5lIHBvaW50cz0iMyA4IDMgMyA4IDMiLz4KPC9zdmc+"},e))}!function(e){var t="CodeMirror-lint-markers",n="CodeMirror-lint-line-";function i(t,n,i){var r=document.createElement("div");function s(t){if(!r.parentNode)return e.off(document,"mousemove",s);var n=Math.max(0,t.clientY-r.offsetHeight-5),i=Math.max(0,Math.min(t.clientX+5,r.ownerDocument.defaultView.innerWidth-r.offsetWidth));r.style.top=n+"px",r.style.left=i+"px"}return r.className="CodeMirror-lint-tooltip cm-s-"+t.options.theme,r.appendChild(i.cloneNode(!0)),t.state.lint.options.selfContain?t.getWrapperElement().appendChild(r):document.body.appendChild(r),e.on(document,"mousemove",s),s(n),null!=r.style.opacity&&(r.style.opacity=1),r}function r(e){e.parentNode&&e.parentNode.removeChild(e)}function s(e){e.parentNode&&(null==e.style.opacity&&r(e),e.style.opacity=0,setTimeout((function(){r(e)}),600))}function o(t,n,r,o){var a=i(t,n,r);function l(){e.off(o,"mouseout",l),a&&(s(a),a=null)}var c=setInterval((function(){if(a)for(var e=o;;e=e.parentNode){if(e&&11==e.nodeType&&(e=e.host),e==document.body)return;if(!e){l();break}}if(!a)return clearInterval(c)}),400);e.on(o,"mouseout",l)}function a(e,t,n){for(var i in this.marked=[],t instanceof Function&&(t={getAnnotations:t}),(!t||!0===t)&&(t={}),this.options={},this.linterOptions=t.options||{},l)this.options[i]=l[i];for(var i in t)l.hasOwnProperty(i)?null!=t[i]&&(this.options[i]=t[i]):t.options||(this.linterOptions[i]=t[i]);this.timeout=null,this.hasGutter=n,this.onMouseOver=function(t){S(e,t)},this.waitingFor=0}var l={highlightLines:!1,tooltips:!0,delay:500,lintOnChange:!0,getAnnotations:null,async:!1,selfContain:null,formatAnnotation:null,onUpdateLinting:null};function c(e){var n=e.state.lint;n.hasGutter&&e.clearGutter(t),n.options.highlightLines&&d(e);for(var i=0;i<n.marked.length;++i)n.marked[i].clear();n.marked.length=0}function d(e){e.eachLine((function(t){var n=t.wrapClass&&/\bCodeMirror-lint-line-\w+\b/.exec(t.wrapClass);n&&e.removeLineClass(t,"wrap",n[0])}))}function u(t,n,i,r,s){var a=document.createElement("div"),l=a;return a.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+i,r&&((l=a.appendChild(document.createElement("div"))).className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),0!=s&&e.on(l,"mouseover",(function(e){o(t,e,n,l)})),a}function h(e,t){return"error"==e?e:t}function p(e){for(var t=[],n=0;n<e.length;++n){var i=e[n],r=i.from.line;(t[r]||(t[r]=[])).push(i)}return t}function f(e){var t=e.severity;t||(t="error");var n=document.createElement("div");return n.className="CodeMirror-lint-message CodeMirror-lint-message-"+t,typeof e.messageHTML<"u"?n.innerHTML=e.messageHTML:n.appendChild(document.createTextNode(e.message)),n}function g(t,n){var i=t.state.lint,r=++i.waitingFor;function s(){r=-1,t.off("change",s)}t.on("change",s),n(t.getValue(),(function(n,o){t.off("change",s),i.waitingFor==r&&(o&&n instanceof e&&(n=o),t.operation((function(){v(t,n)})))}),i.linterOptions,t)}function m(t){var n=t.state.lint;if(n){var i=n.options,r=i.getAnnotations||t.getHelper(e.Pos(0,0),"lint");if(r)if(i.async||r.async)g(t,r);else{var s=r(t.getValue(),n.linterOptions,t);if(!s)return;s.then?s.then((function(e){t.operation((function(){v(t,e)}))})):t.operation((function(){v(t,s)}))}}}function v(e,i){var r=e.state.lint;if(r){var s=r.options;c(e);for(var o=p(i),a=0;a<o.length;++a){var l=o[a];if(l){for(var d=null,g=r.hasGutter&&document.createDocumentFragment(),m=0;m<l.length;++m){var v=l[m],y=v.severity;y||(y="error"),d=h(d,y),s.formatAnnotation&&(v=s.formatAnnotation(v)),r.hasGutter&&g.appendChild(f(v)),v.to&&r.marked.push(e.markText(v.from,v.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+y,__annotation:v}))}r.hasGutter&&e.setGutterMarker(a,t,u(e,g,d,l.length>1,s.tooltips)),s.highlightLines&&e.addLineClass(a,"wrap",n+d)}}s.onUpdateLinting&&s.onUpdateLinting(i,o,e)}}function y(e){var t=e.state.lint;t&&(clearTimeout(t.timeout),t.timeout=setTimeout((function(){m(e)}),t.options.delay))}function b(e,t,n){for(var i=n.target||n.srcElement,r=document.createDocumentFragment(),s=0;s<t.length;s++){var a=t[s];r.appendChild(f(a))}o(e,n,r,i)}function S(e,t){var n=t.target||t.srcElement;if(/\bCodeMirror-lint-mark-/.test(n.className)){for(var i=n.getBoundingClientRect(),r=(i.left+i.right)/2,s=(i.top+i.bottom)/2,o=e.findMarksAt(e.coordsChar({left:r,top:s},"client")),a=[],l=0;l<o.length;++l){var c=o[l].__annotation;c&&a.push(c)}a.length&&b(e,a,t)}}e.defineOption("lint",!1,(function(n,i,r){if(r&&r!=e.Init&&(c(n),!1!==n.state.lint.options.lintOnChange&&n.off("change",y),e.off(n.getWrapperElement(),"mouseover",n.state.lint.onMouseOver),clearTimeout(n.state.lint.timeout),delete n.state.lint),i){for(var s=n.getOption("gutters"),o=!1,l=0;l<s.length;++l)s[l]==t&&(o=!0);var d=n.state.lint=new a(n,i,o);d.options.lintOnChange&&n.on("change",y),0!=d.options.tooltips&&"gutter"!=d.options.tooltips&&e.on(n.getWrapperElement(),"mouseover",d.onMouseOver),m(n)}})),e.defineExtension("performLint",(function(){m(this)}))}(Mk());var eD=function(e){function t(e){for(var t={},n=e.split(" "),i=0;i<n.length;++i)t[n[i]]=!0;return t}e.defineMode("glsl",(function(e,r){var s,o=e.indentUnit,a=r.keywords||t(n),l=r.builtins||t(i),c=r.blockKeywords||t("case do else for if switch while struct"),d=r.atoms||t("null"),u=r.hooks||{},h=r.multiLineStrings,p=/[+\-*&%=<>!?|\/]/;function f(e,t){var n=e.next();if(u[n]){var i=u[n](e,t);if(!1!==i)return i}if('"'==n||"'"==n)return t.tokenize=function(e){return function(t,n){for(var i,r=!1,s=!1;null!=(i=t.next());){if(i==e&&!r){s=!0;break}r=!r&&"\\"==i}return(s||!(r||h))&&(n.tokenize=f),"string"}}(n),t.tokenize(e,t);if(/[\[\]{}\(\),;\:\.]/.test(n))return s=n,"bracket";if(/\d/.test(n))return e.eatWhile(/[\w\.]/),"number";if("/"==n){if(e.eat("*"))return t.tokenize=g,g(e,t);if(e.eat("/"))return e.skipToEnd(),"comment"}if("#"==n)return e.eatWhile(/[\S]+/),e.eatWhile(/[\s]+/),e.eatWhile(/[\S]+/),e.eatWhile(/[\s]+/),"comment";if(p.test(n))return e.eatWhile(p),"operator";e.eatWhile(/[\w\$_]/);var r=e.current();return a.propertyIsEnumerable(r)?(c.propertyIsEnumerable(r)&&(s="newstatement"),"keyword"):l.propertyIsEnumerable(r)?"builtin":d.propertyIsEnumerable(r)?"atom":"word"}function g(e,t){for(var n,i=!1;n=e.next();){if("/"==n&&i){t.tokenize=f;break}i="*"==n}return"comment"}function m(e,t,n,i,r){this.indented=e,this.column=t,this.type=n,this.align=i,this.prev=r}function v(e,t,n){return e.context=new m(e.indented,t,n,null,e.context)}function y(e){var t=e.context.type;return(")"==t||"]"==t||"}"==t)&&(e.indented=e.context.indented),e.context=e.context.prev}return{startState:function(e){return{tokenize:null,context:new m((e||0)-o,0,"top",!1),indented:0,startOfLine:!0}},token:function(e,t){var n=t.context;if(e.sol()&&(null==n.align&&(n.align=!1),t.indented=e.indentation(),t.startOfLine=!0),e.eatSpace())return null;s=null;var i=(t.tokenize||f)(e,t);if("comment"==i||"meta"==i)return i;if(null==n.align&&(n.align=!0),";"!=s&&":"!=s||"statement"!=n.type)if("{"==s)v(t,e.column(),"}");else if("["==s)v(t,e.column(),"]");else if("("==s)v(t,e.column(),")");else if("}"==s){for(;"statement"==n.type;)n=y(t);for("}"==n.type&&(n=y(t));"statement"==n.type;)n=y(t)}else s==n.type?y(t):("}"==n.type||"top"==n.type||"statement"==n.type&&"newstatement"==s)&&v(t,e.column(),"statement");else y(t);return t.startOfLine=!1,i},indent:function(e,t){if(e.tokenize!=f&&null!=e.tokenize)return 0;var n=t&&t.charAt(0),i=e.context,r=n==i.type;return"statement"==i.type?i.indented+("{"==n?0:o):i.align?i.column+(r?0:1):i.indented+(r?0:o)},electricChars:"{}"}}));var n="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",i="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function r(e,t){return!!t.startOfLine&&(e.skipToEnd(),"meta")}e.defineMIME("text/x-glsl",{name:"glsl",keywords:t(n),builtins:t(i),blockKeywords:t("case do else for if switch while struct"),atoms:t("null"),hooks:{"#":r}})};(0,i.g)(eD)(Ak);class tD extends Sn{constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=mn((()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}}),500),this.textEditor=Ak((e=>{}),{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",(()=>{this.setValidState(void 0),this.debouncedValueUpdater()})),this.registerDisposer(this.state.fragmentMain.changed.add((()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)}))),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add((()=>{this.updateErrorState()})));const t=this.state.shaderControlState;void 0!==t&&this.registerDisposer(t.parseErrors.changed.add((()=>{this.updateErrorState()}))),this.updateErrorState();const n=new IntersectionObserver((e=>{e.some((e=>e.isIntersecting))&&this.textEditor.refresh()}),{root:document.body});n.observe(this.element),this.registerDisposer((()=>n.disconnect()))}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){var e=this.state.sourceStringNumber;const t=void 0===e?1:e,n=this.state.shaderError.value;let i;const r=this.state.shaderControlState;i=void 0!==r?r.parseErrors.value:[],void 0===n&&0===i.length?this.setValidState(void 0):null!=n||0!==i.length?(this.textEditor.setOption("lint",{getAnnotations:()=>{const e=[];for(const t of i)e.push({message:t.message,severity:"error",from:Ak.Pos(t.line)});if(null!=n)if("ShaderCompilationError"===n.name)for(const i of n.errorMessages)e.push({message:i.message,severity:"error",from:Ak.Pos(i.file===t&&i.line||0)});else"ShaderLinkError"===n.name?e.push({message:n.log,severity:"error",from:Ak.Pos(0)}):e.push({message:n.message,severity:"error",from:Ak.Pos(0)});return e}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){let t=this.element;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),!0===e?t.classList.add("valid-input"):!1===e&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,Nv(this.element),this.textEditor=void 0,super.disposed()}}const nD=yv.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function iD(e){return{makeControl:(t,n,r)=>{var s=e(t);const o=s.watchableValue,a=s.channelCoordinateSpaceCombiner,l=s.dataType,c=s.defaultChannel,d=s.histogramSpecifications,u=s.legendShaderOptions,h=s.histogramIndex;if(void 0!==a&&0!==c.length){const e=n.registerDisposer(new jg(a.combined)),t=n.registerDisposer(new YC(e,a,{copyButton:!1}));n.registerDisposer(e.changed.add((()=>{const t=e.value,n=It(t,(e=>Math.floor(e)));Ut(o.value.channel,n)||(o.value=(0,i.bn)((0,i.bn)({},o.value),{channel:n}))})));const s=()=>{const t=e.value,n=o.value;Ut(t,n.channel)||(t.set(n.channel),e.changed.dispatch())};s(),n.registerDisposer(o.changed.add(s)),r.labelContainer.appendChild(t.element)}const p=n.registerDisposer(new TI(r.visibility,r.display,l,o,d,h,0===c.length?u:void 0));return{control:p,controlElement:p.element}},activateTool:(e,t)=>{e.bindInputEventMap(nD),e.bindAction("adjust-contrast-via-wheel",(e=>{e.stopPropagation();const n=Nw(e.detail);!function(e,t,n){const r=t.value,s=Rs(r.range,e,.5-n/2),o=Rs(r.range,e,.5+n/2);t.value=(0,i.bn)((0,i.bn)({},r),{range:[s,o]})}(t.dataType,t.trackable,n)})),e.bindAction("adjust-via-drag",(e=>{e.stopPropagation();let n=e.detail.screenX,r=e.detail.screenY,s=t.trackable.value.range,o=s,a=n,l=r;Hv(e.detail,(e=>{const c=t.trackable.value.range,d=e.screenX,u=e.screenY;Ws(t.dataType,c,o)||(s=c,n=a,r=l),function(e,t,n,r,s){const o=Math.exp(s),a=t.value,l=Rs(n,e,.5-o/2+r),c=Rs(n,e,.5+o/2+r);t.value=(0,i.bn)((0,i.bn)({},a),{range:[l,c]})}(t.dataType,t.trackable,s,2*(u-r)/screen.height,4*(d-n)/screen.width),o=t.trackable.value.range,a=d,l=u}))})),e.bindAction("invert-range",(e=>{e.stopPropagation(),kI(t.trackable)}))}}}function rD(e){return{makeControl:(t,n)=>{const i=e(t),r=n.registerDisposer(new Od(i));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}const sD=yv.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function oD(e){return{makeControl:(t,n)=>{const i=e(t),r=n.registerDisposer(new Gk(i));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(sD),e.bindAction("adjust-via-wheel",(e=>{e.stopPropagation(),e.preventDefault(),t.adjustHueViaWheel(e.detail)}))}}}class aD extends Sn{constructor(e){let{min:t=0,max:n=1,step:i=.01}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");let r=this.element,s=this.inputElement,o=this.numericInputElement;r.className="range-slider";const a=e=>{e.min=""+t,e.max=""+n,e.step=""+i,e.valueAsNumber=this.value.value,this.registerEventListener(e,"change",(()=>this.inputValueChanged(e))),this.registerEventListener(e,"input",(()=>this.inputValueChanged(e))),this.registerEventListener(e,"wheel",(t=>{this.adjustViaWheel(e,t)}))};s.type="range",a(s),o.type="number";const l=Math.max(t.toString().length,n.toString().length,Math.min(n,t+i).toString().length,Math.max(t,n-i).toString().length);o.style.width=l+2+"ch",a(o),r.appendChild(s),r.appendChild(o),e.changed.add((()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value}))}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){const n=this.inputElement;let i=t.deltaY;i>0?(n.stepUp(),this.inputValueChanged(e)):i<0&&(n.stepDown(),this.inputValueChanged(e))}disposed(){Nv(this.element),super.disposed()}}const lD=yv.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function cD(e){return{makeControl:(t,n)=>{var i=e(t);const r=i.value,s=i.options,o=n.registerDisposer(new aD(r,s));return{control:o,controlElement:o.element}},activateTool:(e,t)=>{e.bindInputEventMap(lD),e.bindAction("adjust-via-wheel",(e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(t.inputElement,e.detail)}))}}}function dD(e,t){const n=e.shaderControlState,i=n.state.get(t);if(void 0===i)return;const r=i.control;switch(r.type){case"slider":return cD((()=>({value:i.trackable,options:{min:r.min,max:r.max,step:r.step}})));case"color":return oD((()=>i.trackable));case"checkbox":return rD((()=>i.trackable));case"invlerp":{let o=0;for(const e of n.state){var s=O(e,2);const n=s[0],i=s[1].control.type;if(n===t)break;"invlerp"===i&&++o}return iD((()=>({dataType:r.dataType,defaultChannel:r.default.channel,watchableValue:i.trackable,channelCoordinateSpaceCombiner:n.channelCoordinateSpaceCombiner,histogramSpecifications:n.histogramSpecifications,histogramIndex:o,legendShaderOptions:e.legendShaderOptions})))}}}function uD(e,t,n){return{label:n,toolJson:gD(n,t),makeControl:(t,i,r)=>dD(e(t),n).makeControl(t,i,r),activateTool:(t,i)=>dD(e(t.tool.layer),n).activateTool(t,i)}}class hD extends TS{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};super(i.visibility),this.state=e,this.display=t,this.layer=n,this.options=i,this.controlDisposer=void 0;var r=i.toolId;const s=void 0===r?pD:r;this.toolId=s;this.element.style.display="contents";const o=e.controls;this.registerDisposer(o.changed.add(this.registerCancellable(mn((()=>this.updateControls()),0)))),this.updateControls()}updateControls(){const e=this.element;void 0!==this.controlDisposer&&(this.controlDisposer.dispose(),Rv(e));const t=this.controlDisposer=new Sn,n=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(const i of this.state.state.keys())e.appendChild(ZI(t,this.layer,this.visibility,uD(n,this.toolId,i)))}disposed(){var e;null===(e=this.controlDisposer)||void 0===e||e.dispose(),super.disposed()}}const pD="shaderControl",fD="control";function gD(e,t){return{type:t,[fD]:e}}class mD extends qI{constructor(e,t,n,i){super(e,uD((()=>t),n,i)),this.layerShaderControls=t,this.control=i,this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable(mn((()=>{void 0===t.shaderControlState.state.get(i)&&this.unbind()})))))}activate(e){void 0!==this.layerShaderControls.shaderControlState.state.get(this.control)&&super.activate(e)}}function vD(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:pD;ew(e,n,((e,i)=>{const r=ns(i,fD,es);return new mD(e,t(e),n,r)}))}function yD(e){return new tD({fragmentMain:e.displayState.skeletonRenderingOptions.shader,shaderError:e.displayState.shaderError,shaderControlState:e.displayState.skeletonRenderingOptions.shaderControlState})}class bD extends TS{constructor(e){super(),this.layer=e;const t=this.element;t.classList.add("neuroglancer-segmentation-rendering-tab");{const n=this.registerDisposer(new KI(e.displayState.linkedSegmentationGroup));n.label.textContent="Linked to: ",t.appendChild(n.element)}{const n=this.registerDisposer(new KI(e.displayState.linkedSegmentationColorGroup));n.label.textContent="Colors linked to: ",t.appendChild(n.element)}for(const i of lM)t.appendChild(ZI(this,e,this.visibility,i));const n=this.registerDisposer(new hy(e.hasSkeletonsLayer,((t,n,i)=>{if(!t)return;let r=document.createElement("div");r.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let s=document.createElement("div");s.style.flex="1",s.textContent="Skeleton shader:",r.appendChild(s),r.appendChild(QI({title:"Show larger editor view",onClick:()=>{new SD(this.layer)}})),r.appendChild(HI({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),n.appendChild(r);const o=i.registerDisposer(yD(this.layer));n.appendChild(o.element),n.appendChild(i.registerDisposer(new hD(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:eM})).element),o.textEditor.refresh()}),this.visibility));t.appendChild(n.element)}}let SD=class extends mk{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(yD(this.layer)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var wD,xD=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};let CD=wD=class extends md{constructor(){super(...arguments),this.hashTable=new Am,this.changed=new Cn}get value(){return this}static makeWithCounterpart(e){let t=new wD;return t.initializeCounterpart(e),t}set_(e,t){return this.hashTable.set(e,t)}set(e,t){if(this.set_(e,t)){let n=this.rpc;n&&n.invoke("Uint64Map.set",{id:this.rpcId,key:e,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}get(e,t){return this.hashTable.get(e,t)}[i.bm](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(e){return this.hashTable.delete(e)}delete(e){if(this.delete_(e)){let t=this.rpc;t&&t.invoke("Uint64Map.delete",{id:this.rpcId,key:e}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}assignFrom(e){this.clear();for(const n of e.unsafeEntries()){var t=O(n,2);const e=t[0],i=t[1];this.set(e,i)}}clear(){if(this.hashTable.clear()){let e=this.rpc;e&&e.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e={};for(let n of this.hashTable.unsafeEntries()){var t=O(n,2);let i=t[0],r=t[1];e[i.toString()]=r.toString()}return e}};CD=wD=xD([bd("Uint64Map")],CD),dd("Uint64Map.set",(function(e){let t=this.get(e.id);t.set_(e.key,e.value)&&t.changed.dispatch()})),dd("Uint64Map.delete",(function(e){let t=this.get(e.id);t.delete_(e.key)&&t.changed.dispatch()})),dd("Uint64Map.clear",(function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()}));var kD,TD=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};let ED=kD=class extends md{constructor(){super(...arguments),this.hashTable=new Lm,this.changed=new Cn}get value(){return this}static makeWithCounterpart(e){let t=new kD;return t.initializeCounterpart(e),t}set(e,t){t?this.add(e):this.delete(e)}reserve_(e){return this.hashTable.reserve(e)}reserve(e){if(this.reserve_(e)){let t=this.rpc;t&&t.invoke("Uint64Set.reserve",{id:this.rpcId,value:e})}}add_(e){let t=!1;for(const n of e)t=this.hashTable.add(n)||t;return t}add(e){const t=Array().concat(e);if(this.add_(t)){let n=this.rpc;n&&n.invoke("Uint64Set.add",{id:this.rpcId,value:t}),this.changed.dispatch(e,!0)}}has(e){return this.hashTable.has(e)}[i.bm](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(e){let t=!1;for(const n of e)t=this.hashTable.delete(n)||t;return t}delete(e){const t=Array().concat(e);if(this.delete_(Array().concat(e))){let n=this.rpc;n&&n.invoke("Uint64Set.delete",{id:this.rpcId,value:t}),this.changed.dispatch(e,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){let e=this.rpc;e&&e.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){let e=new Array;for(let t of this.unsafeKeys())e.push(t.toString());return e.sort(),e}assignFrom(e){this.clear();for(const t of e.unsafeKeys())this.add(t)}};ED=kD=TD([bd("Uint64Set")],ED),dd("Uint64Set.reserve",(function(e){let t=this.get(e.id);t.reserve_(e.value)&&t.changed.dispatch()})),dd("Uint64Set.add",(function(e){let t=this.get(e.id);t.add_(e.value)&&t.changed.dispatch()})),dd("Uint64Set.delete",(function(e){let t=this.get(e.id);t.delete_(e.value)&&t.changed.dispatch()})),dd("Uint64Set.clear",(function(e){let t=this.get(e.id);t.hashTable.clear()&&t.changed.dispatch()}));const LD=yv.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function ID(e){return{makeControl:(t,n)=>{const i=e(t),r=n.registerDisposer(new ek(i));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(LD),e.bindAction("adjust-via-wheel",(e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(e.detail)}))}}}const DD=yv.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});class MD extends Sn{constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new En(void 0),this.throttledUpdateView=this.registerCancellable(qf((()=>this.debouncedUpdateView()),200,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable(mn((()=>this.updateView()),0));const n=this.canvas,i=this.label,r=this.element,s=this.legend,o=this.legendRenderScale,a=this.legendSpatialScale,l=this.legendChunks;i.className="neuroglancer-render-scale-widget-prompt",r.className="neuroglancer-render-scale-widget",r.title=DD.describe(),s.className="neuroglancer-render-scale-widget-legend",r.appendChild(i),r.appendChild(n),r.appendChild(s),o.title="Target resolution of data in screen pixels",l.title="Number of chunks rendered",s.appendChild(o),s.appendChild(l),s.appendChild(a),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new ly(n,DD)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));const c=e=>function(e){return 2**(.5*e-4)}(e.offsetX/n.width*bp);this.registerEventListener(n,"pointermove",(e=>{this.hoverTarget.value=[c(e),e.offsetY]})),this.registerEventListener(n,"pointerleave",(()=>{this.hoverTarget.value=void 0})),this.registerDisposer(Cv(n,"set",(e=>{this.target.value=c(e.detail)}))),this.registerDisposer(Cv(n,"adjust-via-wheel",(e=>{this.adjustViaWheel(e.detail)}))),this.registerDisposer(Cv(n,"reset",(e=>{this.reset(),e.preventDefault()})));const d=new ResizeObserver((()=>this.debouncedUpdateView()));d.observe(n),this.registerDisposer((()=>d.disconnect())),this.updateView()}adjustViaWheel(e){const t=e.deltaY;0!==t&&(this.hoverTarget.value=void 0,this.target.value*=2**ug(t),e.preventDefault())}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){const e=this.ctx,t=this.canvas,n=t.width=t.offsetWidth,i=t.height=t.offsetHeight,r=this.target.value,s=this.hoverTarget.value;{const e=this.legendRenderScale,t=function(e){if(e<1||e>1024){const t=0|ks(e);return`${fx(e/2**t,1)}p${t}`}return Math.round(e)+""}(void 0===s?r:s[0]);e.textContent=t+" px"}function o(e){return e*n/bp}e.clearRect(0,0,n,i);const a=this.histogram,l=a.value,c=a.spatialScales;a.visibility.visible||l.fill(0);const d=It(c.keys());d.sort();const u=ti();let h=1;const p=c.size;let f=0,g=0;for(let S=0;S<bp;++S){let e=0;for(let t=0;t<p;++t){const n=t*bp*2+S,i=l[n],r=l[n+bp];f+=i,g+=r,e+=i+r}h=Math.max(e,h)}const m=i/Math.log(1+h);function v(e){return i-Math.log(1+e)*m}let y;if(void 0!==s){const e=Math.floor(Sp(s[0]));if(e>=0&&e<bp){let t=0;const n=s[1];for(let i=p-1;i>=0;--i){const r=d[i],s=2*c.get(r)*bp+e,o=l[s]+l[s+bp];if(0===o)continue;const a=Math.round(v(t));if(t+=o,Math.round(v(t))<=n&&n<=a){y=r;break}}}}if(void 0!==y){f=0,g=0;const e=2*c.get(y)*bp;for(let t=0;t<bp;++t){const n=e+t;f+=l[n],g+=l[n+bp]}Sr(y)?this.legendSpatialScale.textContent=Fo(y,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${f}/${f+g}`;const b=d.map((e=>{const t=e===y?.5:1;let n;n=Sr(e)?(.1*ks(e)%1+1)%1:0,rv(u,n,t,1);const i=Ki(u);rv(u,n,t,.5);return[i,Ki(u)]}));for(let S=0;S<bp;++S){let t=0;for(let n=p-1;n>=0;--n){const i=d[n],r=c.get(i)*bp*2+S,s=l[r],a=l[r+bp],u=s+a;if(0===u)continue;const h=Math.round(o(S)),p=Math.round(o(S+1)),f=Math.round(v(t));t+=u;const g=Math.round(v(t)),m=(s*g+a*f)/u;e.fillStyle=b[n][1],e.fillRect(h,g,p-h,m-g),e.fillStyle=b[n][0],e.fillRect(h,m,p-h,f-m)}}{const t=r;e.fillStyle="#fff";const n=o(Sp(t)),s=1;e.fillRect(Math.floor(n),0,s,i)}if(void 0!==s){const t=s[0];e.fillStyle="#888";const n=o(Sp(t)),r=1;e.fillRect(Math.floor(n),0,r,i)}}}const PD=yv.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function AD(e){return{makeControl:(t,n)=>{var i=e(t);const r=i.histogram,s=i.target,o=n.registerDisposer(new MD(r,s));return{control:o,controlElement:o.element}},activateTool:(e,t)=>{e.bindInputEventMap(PD),e.bindAction("adjust-via-wheel",(e=>{e.stopPropagation(),e.preventDefault(),t.adjustViaWheel(e.detail)})),e.bindAction("reset",(e=>{e.stopPropagation(),e.preventDefault(),t.reset()}))}}}function RD(e,t){e.displayState.segmentDefaultColor.value=t?ii(1,0,0):void 0}const ND="selectedAlpha",VD="notSelectedAlpha",OD="objectAlpha",BD="saturation",_D="hideSegmentZero",FD="baseSegmentColoring",zD="ignoreNullVisibleSet",UD="segments",GD="equivalences",WD="colorSeed",$D="segmentColors",jD="meshRenderScale",HD="crossSectionRenderScale",JD="skeletonRendering",qD="segmentQuery",YD="meshSilhouetteRendering",ZD="linkedSegmentationGroup",XD="linkedSegmentationColorGroup",KD="segmentDefaultColor",QD="anchorSegment",eM="skeletonShaderControl";class tM extends Sn{constructor(e){super(),this.layer=e,this.specificationChanged=new Cn,this.localGraph=new VE,this.visibleSegments=this.registerDisposer(ED.makeWithCounterpart(this.layer.manager.rpc)),this.segmentPropertyMap=new En(void 0),this.graph=new En(void 0),this.segmentEquivalences=this.registerDisposer(PE.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(Rn((e=>e&&e.visibleSegmentEquivalencePolicy||up.MIN_REPRESENTATIVE),[this.graph])))),this.localSegmentEquivalences=!1,this.maxIdLength=new En(1),this.hideSegmentZero=new Vd(!0,!0),this.segmentQuery=new Ln("",es),this.temporaryVisibleSegments=this.layer.registerDisposer(ED.makeWithCounterpart(this.layer.manager.rpc)),this.temporarySegmentEquivalences=this.layer.registerDisposer(PE.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=this.layer.registerDisposer(Cd.make(this.layer.manager.rpc,!1)),this.useTemporarySegmentEquivalences=this.layer.registerDisposer(Cd.make(this.layer.manager.rpc,!1));const t=this.specificationChanged;this.visibleSegments.changed.add(t.dispatch),this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch)}restoreState(e){is(e,_D,(e=>this.hideSegmentZero.restoreState(e))),is(e,GD,(e=>{this.localGraph.restoreState(e)})),is(e,UD,(e=>{const t=this.segmentEquivalences,n=this.visibleSegments;Jr(e,(e=>{let i=Ds.parseString(String(e),10);n.add(t.get(i))}))})),is(e,qD,(e=>this.segmentQuery.restoreState(e)))}toJSON(){const e={};e[_D]=this.hideSegmentZero.toJSON();let t=this.visibleSegments;t.size>0&&(e[UD]=t.toJSON());let n=this.segmentEquivalences;return this.localSegmentEquivalences&&n.size>0&&(e[GD]=n.toJSON()),e[qD]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}}class nM extends Sn{constructor(e){super(),this.layer=e,this.specificationChanged=new Cn,this.segmentColorHash=lv.getDefault(),this.segmentStatedColors=this.registerDisposer(new CD),this.segmentDefaultColor=new ir;const t=this.specificationChanged;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch)}restoreState(e){is(e,WD,(e=>this.segmentColorHash.restoreState(e))),is(e,KD,(e=>this.segmentDefaultColor.restoreState(e))),is(e,$D,(e=>{let t=rs(e,(e=>qi(String(e))));for(let i of t){var n=O(i,2);let e=n[0],t=n[1];const r=Ds.parseString(String(e)),s=new Ds(Yi(t));this.segmentStatedColors.set(r,s)}}))}toJSON(){const e={};e[WD]=this.segmentColorHash.toJSON(),e[KD]=this.segmentDefaultColor.toJSON();const t=this.segmentStatedColors;if(t.size>0){const i=e[$D]={};for(const e of t.unsafeEntries()){var n=O(e,2);const t=n[0],r=n[1];i[t.toString()]=Ki(Zi(r.low))}}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.segmentDefaultColor.value=e.segmentDefaultColor.value}}class iM extends Sn{constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}get changed(){return this.linkedGroup.root.changed}get value(){const e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;const t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){const e=this.curGroupState;void 0!==e&&(t.assignFrom(e),e.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;null===(e=this.curGroupState)||void 0===e||e.dispose()}}class rM{constructor(e){this.layer=e,this.segmentSelectionState=new vy,this.selectedAlpha=nL(.5),this.saturation=nL(1),this.notSelectedAlpha=nL(0),this.silhouetteRendering=new Ln(0,Er,0),this.objectAlpha=nL(1),this.ignoreNullVisibleSet=new Vd(!0,!0),this.skeletonRenderingOptions=new Vb,this.shaderError=Xd(),this.renderScaleHistogram=new xp,this.renderScaleTarget=wp(1),this.selectSegment=this.layer.selectSegment,this.transparentPickEnabled=this.layer.pick,this.baseSegmentColoring=new Vd(!1,!1),this.filterBySegmentLabel=this.layer.filterBySegmentLabel,this.moveToSegment=e=>{this.layer.moveToSegment(e)},this.linkedSegmentationGroup=this.layer.registerDisposer(new LT(this.layer.manager.rootLayers,this.layer,(e=>e instanceof oM),(e=>e.displayState.linkedSegmentationGroup))),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new LT(this.layer.manager.rootLayers,this.layer,(e=>e instanceof oM),(e=>e.displayState.linkedSegmentationColorGroup))),this.originalSegmentationGroupState=this.layer.registerDisposer(new tM(this.layer)),this.originalSegmentationColorGroupState=this.layer.registerDisposer(new nM(this.layer)),e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new iM(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new iM(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new zn(this.segmentationGroupState,(e=>e.hideSegmentZero))),this.segmentColorHash=this.layer.registerDisposer(new Un(this.segmentationColorGroupState,(e=>e.segmentColorHash))),this.segmentStatedColors=this.layer.registerDisposer(new Un(this.segmentationColorGroupState,(e=>e.segmentStatedColors))),this.segmentDefaultColor=this.layer.registerDisposer(new Un(this.segmentationColorGroupState,(e=>e.segmentDefaultColor))),this.segmentQuery=this.layer.registerDisposer(new zn(this.segmentationGroupState,(e=>e.segmentQuery))),this.segmentPropertyMap=this.layer.registerDisposer(new zn(this.segmentationGroupState,(e=>e.segmentPropertyMap)))}}const sM=uI(hT);class oM extends sM{constructor(e){super(e),this.sliceViewRenderScaleHistogram=new xp,this.sliceViewRenderScaleTarget=wp(1),this.segmentQueryFocusTime=new En(Number.NEGATIVE_INFINITY),this.selectSegment=(e,t)=>{this.manager.root.selectionState.captureSingleLayerState(this,(t=>(t.value=e.clone(),!0)),t)},this.filterBySegmentLabel=e=>{const t=Sy(this.displayState,e).label;t&&this.filterSegments(t)},this.filterSegments=e=>{this.displayState.segmentationGroupState.value.segmentQuery.value=e,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer},this.displayState=new rM(this),this.anchorSegment=new Ln(void 0,(e=>void 0===e?void 0:Ds.parseString(e))),this.has2dLayer=this.registerDisposer(Pn((e=>e.some((e=>e instanceof tL))),{changed:this.layersChanged,value:this.renderLayers})),this.has3dLayer=this.registerDisposer(Pn((e=>e.some((e=>e instanceof Ky||e instanceof rb||e instanceof Bb||e instanceof _b))),{changed:this.layersChanged,value:this.renderLayers})),this.hasSkeletonsLayer=this.registerDisposer(Pn((e=>e.some((e=>e instanceof Bb))),{changed:this.layersChanged,value:this.renderLayers})),this.registerDisposer(Bn(((e,t)=>{e.registerDisposer(t.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()}),this.displayState.segmentationGroupState)),this.registerDisposer(Bn(((e,t)=>{e.registerDisposer(t.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()}),this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add((()=>this.updateDataSubsourceActivations())),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new bD(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new jI(this)}),this.tabs.default="rendering"}bindSegmentListWidth(e){return xy(this.displayState,e)}get volumeOptions(){return{volumeType:_E.SEGMENTATION}}activateDataSubsources(e){const t=[],n=this.displayState.linkedSegmentationGroup.root.value===this;let r;for(const o of e){if(this.addStaticAnnotations(o))continue;var s=o.subsourceEntry.subsource;const e=s.volume,a=s.mesh,l=s.segmentPropertyMap,c=s.segmentationGraph,d=s.local;if(e instanceof Yb){if(e.dataType===sr.FLOAT32){o.deactivate("Data type not compatible with segmentation layer");continue}o.activate((()=>o.addRenderLayer(new tL(e,(0,i.bn)((0,i.bn)({},this.displayState),{transform:o.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})))),this.displayState.segmentationGroupState.value)}else void 0!==a?o.activate((()=>{const e=(0,i.bn)((0,i.bn)({},this.displayState),{transform:o.getRenderLayerTransform()});if(a instanceof tb)o.addRenderLayer(new Ky(this.manager.chunkManager,a,e));else if(a instanceof ab)o.addRenderLayer(new rb(this.manager.chunkManager,a,e));else{const t=new Ob(this.manager.chunkManager,a,e);o.addRenderLayer(new Bb(t.addRef())),o.addRenderLayer(new _b(t))}}),this.displayState.segmentationGroupState.value):void 0!==l?n?(o.activate((()=>{})),t.push(l)):o.deactivate("Not supported on non-root linked segmentation layers"):void 0!==c?n?void 0!==r?o.deactivate("Only one segmentation graph is supported"):(r=c,o.activate((e=>{this.graphConnection=e.registerDisposer(c.connect(this.displayState.segmentationGroupState.value));const t=(0,i.bn)((0,i.bn)({},this.displayState),{transform:o.getRenderLayerTransform()}),n=this.graphConnection.createRenderLayers(this.manager.chunkManager,t,this.localPosition);for(const i of n)o.addRenderLayer(i)}))):o.deactivate("Not supported on non-root linked segmentation layers"):d===af.equivalences?n?void 0!==r?o.deactivate("Only one segmentation graph is supported"):(r=this.displayState.originalSegmentationGroupState.localGraph,o.activate((e=>{this.graphConnection=e.registerDisposer(r.connect(this.displayState.segmentationGroupState.value)),e.registerDisposer((()=>{this.graphConnection=void 0}))}))):o.deactivate("Not supported on non-root linked segmentation layers"):o.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=aE(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=r}getLegacyDataSourceSpecifications(e,t,n,i){const r=super.getLegacyDataSourceSpecifications(e,t,n,i),s=is(t,"mesh",(e=>null===e?null:es(e))),o=is(t,"skeletons",(e=>null===e?null:es(e)));if(void 0!==s||void 0!==o)for(const a of r)a.enableDefaultSubsources=!1,a.subsources=new pt([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return null!=s&&r.push(Zf(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:s,type:"mesh"}))),null!=o&&r.push(Zf(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"skeletons"}))),void 0!==t[GD]&&void 0===i.find((e=>e.url===uf))&&r.push({url:uf,enableDefaultSubsources:!0,transform:{outputSpace:sa,sourceRank:0,transform:void 0,inputSpace:sa},subsources:new pt}),r}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[ND]),this.displayState.saturation.restoreState(e[BD]),this.displayState.notSelectedAlpha.restoreState(e[VD]),this.displayState.objectAlpha.restoreState(e[OD]),this.displayState.baseSegmentColoring.restoreState(e[FD]),this.displayState.silhouetteRendering.restoreState(e[YD]),this.displayState.ignoreNullVisibleSet.restoreState(e[zD]);const t=this.displayState.skeletonRenderingOptions;t.restoreState(e[JD]);const n=e.skeletonShader;void 0!==n&&t.shader.restoreState(n),this.displayState.renderScaleTarget.restoreState(e[jD]),this.anchorSegment.restoreState(e[QD]),this.sliceViewRenderScaleTarget.restoreState(e[HD]);const i=is(e,ZD,es);void 0!==i&&this.displayState.linkedSegmentationGroup.linkByName(i);const r=is(e,XD,(e=>!1===e?void 0:es(e)),i);void 0!==r&&this.displayState.linkedSegmentationColorGroup.linkByName(r),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){var e;const t=super.toJSON();t[ND]=this.displayState.selectedAlpha.toJSON(),t[VD]=this.displayState.notSelectedAlpha.toJSON(),t[BD]=this.displayState.saturation.toJSON(),t[OD]=this.displayState.objectAlpha.toJSON(),t[FD]=this.displayState.baseSegmentColoring.toJSON(),t[zD]=this.displayState.ignoreNullVisibleSet.toJSON(),t[YD]=this.displayState.silhouetteRendering.toJSON(),t[QD]=this.anchorSegment.toJSON(),t[JD]=this.displayState.skeletonRenderingOptions.toJSON(),t[jD]=this.displayState.renderScaleTarget.toJSON(),t[HD]=this.sliceViewRenderScaleTarget.toJSON();var n=this.displayState;const r=n.linkedSegmentationGroup,s=n.linkedSegmentationColorGroup;return t[ZD]=r.toJSON(),s.root.value!==r.root.value&&(t[XD]=null!==(e=s.toJSON())&&void 0!==e&&e),t[GD]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),r.root.value===this&&(0,i.bn)(t,this.displayState.segmentationGroupState.value.toJSON()),s.root.value===this&&(0,i.bn)(t,this.displayState.segmentationColorGroupState.value.toJSON()),t}transformPickedValue(e){return null==e?e:by(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break;case"clear-segments":if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break;case"select":{if(!this.pick.value)break;const e=this.displayState.segmentSelectionState;if(e.hasSelectedSegment){const n=e.selectedSegment,i=this.displayState.segmentationGroupState.value.visibleSegments,r=!i.has(n);(r||void 0===t.segmentationToggleSegmentState)&&(t.segmentationToggleSegmentState=r),t.defer((()=>{t.segmentationToggleSegmentState===r&&i.set(n,r)}))}break}case"copy-segment-id":{if(!this.pick.value)break;const e=this.displayState.segmentSelectionState;if(e.hasSelectedSegment){const t=e.selectedSegment;this.copiedSegments=[t.clone()];const n=t.toString();ay(n)&&Bp.showTemporaryMessage(n+" copied to clipboard")}break}case"add-copy-segment-id":{if(!this.pick.value)break;const e=this.displayState.segmentSelectionState;if(e.hasSelectedSegment){const t=e.selectedSegment;this.copiedSegments.push(t.clone());const n=this.copiedSegments.map((e=>e.toString())).join(",");ay(n)&&Bp.showTemporaryMessage(n+" copied to clipboard")}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);const n=new Ds;let i=e.value;"number"==typeof i&&(i=i.toString()),"string"==typeof i&&n.tryParseString(i)?e.value=n:e.value=void 0}selectionStateToJson(e,t){const n=super.selectionStateToJson(e,t);let i=e.value;return i instanceof my?n.value=t?{key:i.key.toString(),value:i.value?i.value.toString():void 0,label:i.label}:(i.value||i.key).toString():i instanceof Ds&&(n.value=i.toString()),n}displaySegmentationSelection(e,t,n){const i=e.value;let r;if(("number"==typeof i||"string"==typeof i)&&(r=new Ds,!r.tryParseString(i.toString())))return!1;if(i instanceof Ds)r=i.clone();else{if(!(i instanceof my))return!1;r=i.key.clone()}const s=this.displayState,o=Sy(s,r);var a=this.displayState.segmentationGroupState.value;const l=a.segmentEquivalences,c=a.segmentPropertyMap.value,d=l.get(r),u=My(this.displayState,o);if(Py(s,n,n.redraw),n.registerDisposer(xy(s,u)),u.classList.add("neuroglancer-selection-details-segment"),t.appendChild(u),void 0!==c){const e=c.segmentPropertyMap.inlineProperties;if(void 0!==e){const n=c.getSegmentInlineIndex(d);if(-1!==n)for(const i of e.properties)if("label"!==i.type)if("description"===i.type){const e=i.values[n];if(!e)continue;const r=document.createElement("div");r.classList.add("neuroglancer-selection-details-segment-description"),r.textContent=e,t.appendChild(r)}else if("number"===i.type||"string"===i.type){const e=i.values[n];if("number"===i.type?isNaN(e):!e)continue;const r=document.createElement("div");r.classList.add("neuroglancer-selection-details-segment-property");const s=document.createElement("div");s.classList.add("neuroglancer-selection-details-segment-property-name"),s.textContent=i.id,i.description&&(s.title=i.description);const o=document.createElement("div");o.classList.add("neuroglancer-selection-details-segment-property-value"),o.textContent=e.toString(),r.appendChild(s),r.appendChild(o),t.appendChild(r)}}}return!0}displaySelectionState(e,t,n){let i=this.displaySegmentationSelection(e,t,n);return super.displaySelectionState(e,t,n)&&(i=!0),i}moveToSegment(e){for(const n of this.renderLayers){if(!(n instanceof rb))continue;const t=n.getObjectPosition(e);if(void 0!==t)return void this.setLayerPosition(n.displayState.transform.value,t)}let t=!1;for(const n of this.renderLayers)if(n instanceof tL){const i=n.multiscaleSource;i.getSegmentPosition&&(t=!0,i.getSegmentPosition(e).then((e=>{this.setLayerPosition(null,e)})).catch((t=>{Bp.showTemporaryMessage(`Failed to retrieve position for segment ${e}: ${t}`)})))}t||Bp.showTemporaryMessage(`No position information loaded for segment ${e}`)}}oM.type="segmentation",oM.typeAbbreviation="seg",oM.supportsPickOption=!0;function aM(e){return[(0,i.bn)({label:`Skeleton mode (${e})`,toolJson:`${JD}.mode${e}`,isValid:e=>e.hasSkeletonsLayer},ID((t=>t.displayState.skeletonRenderingOptions[`params${e}`].mode))),(0,i.bn)({label:`Line width (${e})`,toolJson:`${JD}.lineWidth${e}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${e})`,title:`Skeleton line width (${e})`},cD((t=>({value:t.displayState.skeletonRenderingOptions[`params${e}`].lineWidth,options:{min:1,max:40,step:1}}))))]}const lM=[(0,i.bn)({label:"Color seed",title:"Color segments based on a hash of their id",toolJson:WD},function(){const e=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(t,n,i)=>{let{labelTextContainer:r}=i;const s=document.createElement("input");s.type="radio",s.addEventListener("change",(()=>{RD(t,!s.checked)})),r.prepend(s);const o=document.createElement("div");o.classList.add("neuroglancer-segmentation-color-seed-control");const a=n.registerDisposer(new $k(t.displayState.segmentColorHash));o.appendChild(a.element);const l=Jv({svg:"data:image/svg+xml;base64,PHN2ZyByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGFyaWEtbGFiZWxsZWRieT0icm90YXRlSWNvblRpdGxlIj4KICAgIDx0aXRsZSBpZD0icm90YXRlSWNvblRpdGxlIj5Sb3RhdGU8L3RpdGxlPiAgICAKICAgIDxwYXRoIGQ9Ik0yMiAxMmwtMyAzLTMtMyIvPgogICAgPHBhdGggZD0iTTIgMTJsMy0zIDMgMyIvPgogICAgPHBhdGggZD0iTTE5LjAxNiAxNHYtMS45NUE3LjA1IDcuMDUgMCAwIDAgOCA2LjIyIi8+CiAgICA8cGF0aCBkPSJNMTYuMDE2IDE3Ljg0NUE3LjA1IDcuMDUgMCAwIDEgNSAxMi4wMTVWMTAiLz4KICAgIDxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTUgMTBWOSIvPgogICAgPHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBkPSJNMTkgMTV2LTEiLz4KPC9zdmc+",title:"Randomize",onClick:()=>e(t)});return o.appendChild(l),n.registerDisposer(Fn((e=>{const t=void 0===e;o.style.visibility=t?"":"hidden",s.checked=t}),t.displayState.segmentDefaultColor)),{controlElement:o,control:a}},activateTool:t=>{const n=t.tool.layer;RD(n,!1),e(n)}}}()),(0,i.bn)({label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:KD},function(){const e=oD((e=>e.displayState.segmentDefaultColor));return(0,i.bn)((0,i.bn)({},e),{makeControl:(t,n,i)=>{const r=e.makeControl(t,n,i),s=r.controlElement,o=document.createElement("input");return o.type="radio",o.addEventListener("change",(()=>{RD(t,o.checked),o.checked&&s.click()})),i.labelTextContainer.prepend(o),n.registerDisposer(Fn((e=>{const t=void 0!==e;s.style.visibility=t?"":"hidden",o.checked=t}),t.displayState.segmentDefaultColor)),r},activateTool:(t,n)=>{RD(t.tool.layer,!0),e.activateTool(t,n)}})}()),(0,i.bn)({label:"Saturation",toolJson:BD,title:"Saturation of segment colors"},cD((e=>({value:e.displayState.saturation})))),(0,i.bn)({label:"Opacity (on)",toolJson:ND,isValid:e=>e.has2dLayer,title:"Opacity in cross-section views of segments that are selected"},cD((e=>({value:e.displayState.selectedAlpha})))),(0,i.bn)({label:"Opacity (off)",toolJson:VD,isValid:e=>e.has2dLayer,title:"Opacity in cross-section views of segments that are not selected"},cD((e=>({value:e.displayState.notSelectedAlpha})))),(0,i.bn)({label:"Resolution (slice)",toolJson:HD,isValid:e=>e.has2dLayer},AD((e=>({histogram:e.sliceViewRenderScaleHistogram,target:e.sliceViewRenderScaleTarget})))),(0,i.bn)({label:"Resolution (mesh)",toolJson:jD,isValid:e=>e.has3dLayer},AD((e=>({histogram:e.displayState.renderScaleHistogram,target:e.displayState.renderScaleTarget})))),(0,i.bn)({label:"Opacity (3d)",toolJson:OD,isValid:e=>e.has3dLayer,title:"Opacity of meshes and skeletons"},cD((e=>({value:e.displayState.objectAlpha})))),(0,i.bn)({label:"Silhouette (3d)",toolJson:YD,isValid:e=>e.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction"},cD((e=>({value:e.displayState.silhouetteRendering,options:{min:0,max:10,step:.1}})))),(0,i.bn)({label:"Hide segment ID 0",toolJson:_D,title:"Disallow selection and display of segment id 0"},rD((e=>e.displayState.hideSegmentZero))),(0,i.bn)({label:"Base segment coloring",toolJson:FD,title:"Color base segments individually"},rD((e=>e.displayState.baseSegmentColoring))),(0,i.bn)({label:"Show all by default",title:"Show all segments if none are selected",toolJson:zD},rD((e=>e.displayState.ignoreNullVisibleSet))),...aM("2d"),...aM("3d")];for(const iV of lM)XI(oM,iV);FT(oM),UT(_E.SEGMENTATION,oM),zT((e=>{if(void 0!==e.mesh)return{layerConstructor:oM,priority:1}})),vD(oM,(e=>({shaderControlState:e.displayState.skeletonRenderingOptions.shaderControlState})),eM),ew(oM,EI,(e=>new MI(e))),ew(oM,LI,(e=>new PI(e))),ew(oM,AI,(e=>new OI(e)));const cM=Object.freeze(Object.defineProperty({__proto__:null,LAYER_CONTROLS:lM,SKELETON_RENDERING_SHADER_CONTROL_TOOL_ID:eM,SegmentationUserLayer:oM,SegmentationUserLayerColorGroupState:nM,SegmentationUserLayerGroupState:tM},Symbol.toStringTag,{value:"Module"}));class dM extends Sn{constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);const t=this.element,n=this.selectElement;t.appendChild(n),this.updateView(),this.registerEventListener(n,"change",(()=>this.updateModel())),this.registerDisposer(this.ref.changed.add(mn((()=>this.updateView()),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){const e=this.selectElement,t=this.ref,n=t.filter;Rv(e);const i=document.createElement("option");e.appendChild(i);for(const r of this.ref.layerManager.managedLayers)if(n(r)){const t=document.createElement("option"),n=r.name;t.textContent=n,t.value=n,e.appendChild(t)}e.value=t.layerName||""}}const uM="annotations",hM="annotationProperties",pM="annotationRelationships",fM="crossSectionAnnotationSpacing",gM="projectionAnnotationSpacing",mM="shader",vM="shaderControls";function yM(e,t){void 0!==t&&Jr(t,((t,n)=>{e.add({type:Zs.POINT,id:""+n,point:cs(t),properties:[]})}))}function bM(e){const t=e.layer;return null===t||t instanceof oM}const SM="linkedSegmentationLayer",wM="filterBySegmentation",xM="ignoreNullSegmentFilter";class CM extends Sn{constructor(e,t,n){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=n,this.changed=new kn,this.curGeneration=-1,this.wasLoading=void 0,this.map=new pt,this.registerDisposer(t.changed.add((()=>this.update()))),this.registerDisposer(t.isLoadingChanged.add((()=>this.update()))),this.update()}update(){const e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;const n=this.map;let i=!1;for(const s of this.annotationStates.relationships){let t=n.get(s);void 0===t&&(t=this.addRelationship(s),i=!0),t.seenGeneration=e}if(!t)for(const s of n){var r=O(s,2);const t=r[0];r[1].seenGeneration!==e&&(n.delete(t),i=!0)}i&&this.changed.dispatch()}addRelationship(e){const t=this.annotationDisplayState.relationshipStates.get(e),n=new ET(this.layerManager.addRef(),bM);n.registerDisposer(n.changed.add((()=>{t.segmentationState.value=void 0===n.layerName?void 0:function(e){if(void 0===e)return null;const t=e.layer;return null!==t&&t instanceof oM?t.displayState:null}(n.layer)})));const i=t.showMatches,r={layerRef:n,showMatches:i,seenGeneration:-1};return n.changed.add(this.changed.dispatch),i.changed.add(this.changed.dispatch),this.map.set(e,r),r}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(const e of this.map.values())e.showMatches.reset()}toJSON(){const e=this.map;if(0===e.size)return{};let t;const n=[];for(const r of e){var i=O(r,2);const e=i[0],s=i[1];s.showMatches.value&&n.push(e);const o=s.layerRef.layerName;void 0!==o&&((t=t||{})[e]=o)}return n.sort(),{[SM]:t,[wM]:0===n.length?void 0:n}}restoreState(e){const t=this.annotationStates.isLoading;is(e,SM,(e=>{"string"==typeof e&&(e={segments:e}),Yr(e);for(const i of f(e)){const n=es(e[i]);let r=this.map.get(i);if(void 0===r){if(!t)continue;r=this.addRelationship(i)}r.layerRef.layerName=n}for(const t of this.map){var n=O(t,2);const i=n[0],r=n[1];Object.prototype.hasOwnProperty.call(e,i)||(r.layerRef.layerName=void 0)}})),is(e,wM,(e=>{"boolean"==typeof e&&(e=!0===e?["segments"]:[]);for(const n of ds(e)){let e=this.map.get(n);if(void 0===e){if(!t)continue;e=this.addRelationship(n)}e.showMatches.value=!0}}))}disposed(){const e=this.map;for(const t of e.values())this.unbind(t);e.clear(),super.disposed()}}class kM extends Sn{constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;const n=this.element,i=this.registerDisposer(new Od(t.showMatches)),r=new dM(t.layerRef);n.appendChild(i.element),n.appendChild(document.createTextNode(e)),n.appendChild(r.element)}}class TM extends Sn{constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new pt,this.element=document.createElement("div"),this.element.style.display="contents";const t=this.registerCancellable(al((()=>this.updateView())));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){const e=this.linkedSegmentationLayers,t=e.annotationStates,n=t.changed.count,i=this.widgets;for(const s of i){var r=O(s,2);const e=r[0],t=r[1];t.seenGeneration!==n&&(t.dispose(),i.delete(e))}Ov(this.element,function*(){for(const r of t.relationships){let t=i.get(r);void 0===t&&(t=new kM(r,e.get(r))),t.seenGeneration=n,yield t.element}}.call(this))}disposed(){super.disposed();for(const e of this.widgets.values())e.dispose()}}const EM=uI(hT);class LM extends EM{constructor(e){super(e),this.annotationProperties=new En(void 0),this.localAnnotationsJson=void 0,this.pointAnnotationsJson=void 0,this.linkedSegmentationLayers=this.registerDisposer(new CM(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState)),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new MM(this)}),this.tabs.default="annotations",this.allowingRefresh=!0}disposed(){const e=this.localAnnotations;void 0!==e&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[uM],this.localAnnotationProperties=is(e,hM,ao),this.localAnnotationRelationships=is(e,pM,ds,["segments"]),this.pointAnnotationsJson=e.points,this.annotationCrossSectionRenderScaleTarget.restoreState(e[fM]),this.annotationProjectionRenderScaleTarget.restoreState(e[gM]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[xM]),this.annotationDisplayState.shader.restoreState(e[mM]),this.annotationDisplayState.shaderControls.restoreState(e[vM])}getLegacyDataSourceSpecifications(e,t,n,r){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,n,r);const s=is(t,"voxelSize",(e=>qr(new Float64Array(3),e,(e=>Lr(e)/1e9))));if(void 0!==s){const e=ia({rank:3,units:["m","m","m"],scales:s,names:["x","y","z"]});n=void 0===n?{outputSpace:e,sourceRank:3,transform:void 0,inputSpace:e}:(0,i.bn)((0,i.bn)({},n),{inputSpace:e})}return[{url:df,transform:n,enableDefaultSubsources:!0,subsources:new pt}]}activateDataSubsources(e){var t;let n,i=!1;for(const r of e){const e=r.subsourceEntry,s=e=>void 0!==n&&Pr(e)!==Pr(n)?(r.deactivate("Annotation properties are not compatible"),!1):(n=e,!0);if(e.subsource.local===af.annotations){if(i){r.deactivate("Only one local annotations source per layer is supported");continue}if(i=!0,!s(null!==(t=this.localAnnotationProperties)&&void 0!==t?t:[]))continue;r.activate((t=>{var n;const i=this.localAnnotations=new mo(r.loadedDataSource.transform,null!==(n=this.localAnnotationProperties)&&void 0!==n?n:[],this.localAnnotationRelationships);try{i.restoreState(this.localAnnotationsJson)}catch{}t.registerDisposer((()=>{i.dispose(),this.localAnnotations=void 0})),t.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{yM(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;const s=new kh({localPosition:this.localPosition,transform:t.registerDisposer(Ga(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,r.loadedDataSource.transform,void 0)),source:i.addRef(),displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:e.id,role:Ld.ANNOTATION});this.addAnnotationLayerState(s,r)}));continue}const o=e.subsource.annotation;if(void 0===o)r.deactivate("Not compatible with annotation layer");else{if(!s(o.properties))continue;r.activate((()=>{const t=new kh({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:o,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:e.id,role:Ld.ANNOTATION});this.addAnnotationLayerState(t,r)}))}}Pr(this.annotationProperties.value)!==Pr(n)&&(this.annotationProperties.value=n)}initializeAnnotationLayerViewTab(e){const t=e.registerDisposer(Pn((e=>e.some((e=>e.source instanceof Xp))),this.annotationStates)),n=e.registerDisposer(new hy(t,((e,t,n)=>{if(e){{const e=n.registerDisposer(new MD(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));e.label.textContent="Spacing (cross section)",t.appendChild(e.element)}{const e=n.registerDisposer(new MD(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));e.label.textContent="Spacing (projection)",t.appendChild(e.element)}}})));e.element.insertBefore(n.element,e.element.firstChild);{const t=e.registerDisposer(new Od(this.annotationDisplayState.ignoreNullSegmentFilter)),n=document.createElement("label");n.appendChild(document.createTextNode("Ignore null related segment filter")),n.title="Display all annotations if filtering by related segments is enabled but no segments are selected",n.appendChild(t.element),e.element.appendChild(n)}e.element.appendChild(e.registerDisposer(new TM(this.linkedSegmentationLayers)).element)}toJSON(){const e=super.toJSON();e[fM]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[gM]=this.annotationProjectionRenderScaleTarget.toJSON(),void 0!==this.localAnnotations?e[uM]=this.localAnnotations.toJSON():void 0!==this.localAnnotationsJson&&(e[uM]=this.localAnnotationsJson),e[hM]=function(e){if(void 0!==e&&0!==e.length)return e.map(oo)}(this.localAnnotationProperties);const t=this.localAnnotationRelationships;return e[pM]=t&&1===t.length&&"segments"===t[0]?void 0:t,e[xM]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[mM]=this.annotationDisplayState.shader.toJSON(),e[vM]=this.annotationDisplayState.shaderControls.toJSON(),(0,i.bn)(e,this.linkedSegmentationLayers.toJSON()),e}}function IM(e){return new tD({shaderError:e.annotationDisplayState.shaderError,fragmentMain:e.annotationDisplayState.shader,shaderControlState:e.annotationDisplayState.shaderControls})}LM.type="annotation",LM.typeAbbreviation="ann";let DM=class extends mk{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(IM(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},MM=class extends TS{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(IM(this.layer));const t=this.element;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new hy(e.annotationProperties,((e,t)=>{if(void 0===e||0===e.length)return;const n=document.createElement("div");t.appendChild(n),n.classList.add("neuroglancer-annotation-shader-property-list");for(const i of e){const e=document.createElement("div");e.classList.add("neuroglancer-annotation-shader-property");const t=document.createElement("span");t.classList.add("neuroglancer-annotation-shader-property-type"),t.textContent=i.type;const r=document.createElement("span");r.classList.add("neuroglancer-annotation-shader-property-identifier"),r.textContent=`prop_${i.identifier}`,e.appendChild(t),e.appendChild(r);const s=i.description;void 0!==s&&(e.title=s),n.appendChild(e)}}))).element);let n=document.createElement("div");n.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";let i=document.createElement("div");i.style.flex="1",i.textContent="Annotation shader:",n.appendChild(i),n.appendChild(QI({title:"Show larger editor view",onClick:()=>{new DM(this.layer)}})),n.appendChild(HI({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/annotation/rendering.md"})),t.appendChild(n),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new hD(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};FT(LM),FT(LM,"pointAnnotation"),zT((e=>e.local===af.annotations?{layerConstructor:LM,priority:100}:void 0!==e.annotation?{layerConstructor:LM,priority:1}:void 0)),vD(LM,(e=>({shaderControlState:e.annotationDisplayState.shaderControls})));const PM=Object.freeze(Object.defineProperty({__proto__:null,AnnotationUserLayer:LM},Symbol.toStringTag,{value:"Module"})),AM=(0,i.bz)(PM),RM=(0,i.bz)(Wy),NM=(0,i.bz)(cM),VM=(0,i.bz)(rr);function OM(e){e.registerEventListener(document,"paste",(t=>{if(Bv(t.target))return;const n=t.clipboardData;if(null!==n){const t=function(e,t){let n=zC`^[\[\]{}()\s,]*`;for(let s=0;s<t;++s)0!==s&&(n+=zC`[,\s]+`),n+=zC`(\d+(?:\.\d+)?)`;n+=zC`[\[\]{}()\s,]*$`;const i=e.match(n);if(null===i)return;const r=new Float32Array(t);for(let s=0;s<t;++s){const e=Number(i[s+1]);if(!Sr(e))return;r[s]=e}return r}(n.getData("text/plain"),e.coordinateSpace.value.rank);void 0!==t&&(e.navigationState.position.value=t)}t.preventDefault()}))}const BM=(0,i.bu)("SingleTextureVolumeChunk.textureUnit"),_M=(0,i.bu)("SingleTextureVolumeChunk.textureLayout");class FM extends Sn{constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",BM)}beginDrawing(e,t){let n=t.textureUnit(BM);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),t[_M]=null}endDrawing(e,t){e.bindTexture(Yd[this.shaderSamplerType],null),t[_M]=null}bindChunk(e,t,n,i,r,s,o){let a=n.textureLayout;(t[_M]!==a||o)&&(t[_M]=a,this.setupTextureLayout(e,t,a,i,r,s)),e.bindTexture(Yd[this.shaderSamplerType],n.texture)}beginSource(e,t){}}class zM extends qb{constructor(e,t){super(e,t),this.texture=null,this.data=t.data}copyToGPU(e){super.copyToGPU(e);let t=this.texture=e.createTexture();const n=Yd[this.chunkFormat.shaderSamplerType];e.bindTexture(n,t),this.setTextureData(e),e.bindTexture(n,null)}freeGPUMemory(e){super.freeGPUMemory(e),e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null}}let UM=class e extends Sn{constructor(e,t,n){super(),this.chunkDataSize=t,this.textureDims=n,this.textureShape=new Uint32Array(this.textureDims);const i=t.length;let r=0;for(const d of t)1!==d&&++r;const s=this.strides=new Uint32Array(i*n),o=3===n?e.max3dTextureSize:e.maxTextureSize;let a=0,l=1;const c=this.textureShape;c.fill(1);for(let d=0;d<i;++d){const e=t[d];if(1===e)continue;const i=e*l;let u;i>o||1!==l&&a+r<n?(++a,l=e,u=1):(u=l,l=i),s[n*d+a]=u,c[a]=l}}static get(t,n,i){return t.memoize.get(`sliceview.UncompressedTextureLayout:${n.join()}:${i}`,(()=>new e(t,n,i)))}},GM=new Uint32Array(15),WM=class e extends FM{constructor(e,t,n,i){super(n,t),this.textureDims=i,jm(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${i}D`,this.textureAccessHelper=new Km("chunkData",i)}static get(t,n,i){const r=`sliceview.UncompressedChunkFormat:${n}:${i}`;return t.memoize.get(r,(()=>new e(t,n,r,i)))}defineShader(e,t){super.defineShader(e,t);const n=this.textureDims,i=`ivec${this.textureDims}`;let r=this.textureAccessHelper;const s=(4+t)*n;GM.length<s&&(GM=new Uint32Array(s)),e.addUniform(`highp ${i}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(r.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let o=`\n${Bu(this.dataType)} getDataValueAt(highp ivec3 p`;for(let a=0;a<t;++a)o+=`, highp int channelIndex${a}`;o+=`) {\n  highp ${i} offset = uVolumeChunkStrides[0]\n                     + p.x * uVolumeChunkStrides[1]\n                     + p.y * uVolumeChunkStrides[2]\n                     + p.z * uVolumeChunkStrides[3];\n`;for(let a=0;a<t;++a)o+=`\n  offset += channelIndex${a} * uVolumeChunkStrides[${4+a}];\n`;o+="\n  return readVolumeData(offset);\n}\n",e.addFragmentCode(o)}setupTextureLayout(e,t,n,i,r,s){const o=GM,a=s.length,l=n.strides,c=i.length,d=this.textureDims;for(let h=0;h<d;++h){let e=0;for(let t=0;t<c;++t)e+=i[t]*l[t*d+h];o[h]=e}for(let h=0;h<3;++h){const e=r[h];if(!(e>=c))for(let t=0;t<d;++t)o[(h+1)*d+t]=l[e*d+t]}for(let h=0;h<a;++h){const e=s[h];if(-1===e)o.fill(0,(4+h)*d,(4+h+1)*d);else for(let t=0;t<d;++t)o[(4+h)*d+t]=l[e*d+t]}const u=(4+a)*d;3===d?e.uniform3iv(t.uniform("uVolumeChunkStrides"),o,0,u):e.uniform2iv(t.uniform("uVolumeChunkStrides"),o,0,u)}getTextureLayout(e,t){return UM.get(e,t,this.textureDims)}setTextureData(e,t,n){const i=t.textureShape;(3===this.textureDims?qm:Jm)(e,this,n,i[0],i[1],i[2])}};class $M extends zM{setTextureData(e){let t,n=this.source,i=n.chunkFormatHandler,r=i.chunkFormat;this.chunkDataSize===n.spec.chunkDataSize?this.textureLayout=t=i.textureLayout.addRef():this.textureLayout=t=r.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,t,this.data)}getValueAt(e){let t=this.chunkFormat;const n=this.chunkDataSize;let i=0,r=1;const s=e.length;for(let l=0;l<s;++l)i+=r*e[l],r*=n[l];let o=t.dataType,a=this.data;switch(o){case sr.UINT8:case sr.INT8:case sr.FLOAT32:case sr.UINT16:case sr.INT16:case sr.UINT32:case sr.INT32:return a[i];case sr.UINT64:{let e=2*i;return new Ds(a[e],a[e+1])}}}}class jM extends Sn{constructor(e,t){super();let n=0;for(const i of t.chunkDataSize)i>1&&++n;this.chunkFormat=this.registerDisposer(WM.get(e,t.dataType,n>=3?3:2)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize))}getChunk(e,t){return new $M(e,t)}}function HM(e,t,n,i,r,s){let o=0,a=0,l=1,c=1;for(let g=0;g<3;++g){let e=r[g],t=i[g],s=e%t;o+=Math.floor(e/t)*l,l*=Math.ceil(n[g]/t),a+=s*c,c*=t}let d=t+2*o,u=e[d],h=e[d+1],p=16777215&u,f=u>>24&255;if(f>0){p+=s*(e[(t+h&16777215)+Math.floor(a*f/32)]>>a*f%32&(1<<f)-1)}return p}Hb(((e,t)=>null==t.compressedSegmentationBlockSize?new jM(e,t):null));class JM extends Sn{constructor(e,t){super(),this.chunkDataSize=e,this.subchunkSize=t;const n=this.subchunkGridSize=ti();for(let i=0;i<3;++i)n[i]=Math.ceil(e[i]/t[i])}static get(e,t,n){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${Ni(t)},${Ni(n)}`,(()=>new JM(t,n)))}}const qM=jm(new Rm,sr.UINT32);let YM=new Uint32Array(16);class ZM extends FM{constructor(e,t,n,i){super(i,e),this.subchunkSize=t,this.numChannels=n,this.textureAccessHelper=new Xm("chunkData")}static get(e,t,n,i){let r=`sliceview.CompressedSegmentationChunkFormat:${t}:${i}`,s=`${r}:${Ni(n)}`;return e.memoize.get(s,(()=>new ZM(t,n,i,r)))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);const n=4*(4+t);YM.length<n&&(YM=new Uint32Array(n));let i=this.textureAccessHelper;i.defineShader(e);let r=e=>"compressedSegmentationChunkFormat_"+e;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode("\nhighp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {\n  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);\n}\n");const s=this.dataType,o=Bu(s);s===sr.UINT64?e.addFragmentCode(yu):e.addFragmentCode(Au),e.addFragmentCode(i.getAccessor(r("readTextureValue"),"uVolumeChunkSampler",sr.UINT32,1));let a=`\nuint ${r("getChannelOffset")}(int channelIndex) {\n  if (channelIndex == 0) {\n    return ${this.numChannels}u;\n  }\n  return ${r("readTextureValue")}(uint(channelIndex)).value;\n}\n${o} getDataValueAt(highp ivec3 p`;for(let l=0;l<t;++l)a+=`, highp int channelIndex${l}`;a+=") {\n  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +\n                     + p.x * uVolumeChunkStrides[1]\n                     + p.y * uVolumeChunkStrides[2]\n                     + p.z * uVolumeChunkStrides[3];\n";for(let l=0;l<t;++l)a+=`\n  chunkPositionFull += channelIndex${l} * uVolumeChunkStrides[${4+l}];\n`;a+=`\n  highp ivec3 chunkPosition = chunkPositionFull.xyz;\n\n  // TODO: maybe premultiply this and store as uniform.\n  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;\n  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);\n\n  int channelOffset = int(${r("getChannelOffset")}(chunkPositionFull[3]));\n\n  // TODO: Maybe just combine this offset into subchunkGridStrides.\n  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;\n\n  highp uint subchunkHeader0 = ${r("readTextureValue")}(uint(subchunkHeaderOffset)).value;\n  highp uint subchunkHeader1 = ${r("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;\n  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);\n  highp uint encodingBits = subchunkHeader0 >> 24u;\n  if (encodingBits > 0u) {\n    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;\n    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);\n    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);\n    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;\n    uint encodedValue = ${r("readTextureValue")}(encodedValueOffset).value;\n    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;\n    uint encodedValueShifted = encodedValue >> wordOffset;\n    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);\n    outputValueOffset += decodedValue * ${this.dataType===sr.UINT64?"2u":"1u"};\n  }\n  ${o} result;\n`,s===sr.UINT64?a+=`\n  result.value[0] = ${r("readTextureValue")}(outputValueOffset).value;\n  result.value[1] = ${r("readTextureValue")}(outputValueOffset+1u).value;\n`:a+=`\n  result.value = ${r("readTextureValue")}(outputValueOffset).value;\n`,a+="\n  return result;\n}\n",e.addFragmentCode(a)}setupTextureLayout(e,t,n,i,r,s){const o=n.subchunkGridSize;e.uniform3i(t.uniform("uSubchunkGridSize"),o[0],o[1],o[2]);const a=YM,l=s.length;a.fill(0);for(let c=0;c<3;++c){a[c]=i[c];const e=r[c];-1!==e&&(a[4*(c+1)+e]=1)}for(let c=0;c<l;++c){const e=s[c];-1!==e&&(a[4*(4+c)+e]=1)}e.uniform4iv(t.uniform("uVolumeChunkStrides"),a,0,4*(l+4))}setTextureData(e,t,n){Hm(e,qM,n)}getTextureLayout(e,t){return JM.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);const n=this.subchunkSize;e.uniform3i(t.uniform("uSubchunkSize"),n[0],n[1],n[2])}}class XM extends zM{setTextureData(e){let t=this.data,n=this.chunkFormat,i=this.textureLayout=n.getTextureLayout(e,this.chunkDataSize);n.setTextureData(e,i,t)}getValueAt(e){let t=this.chunkDataSize,n=this.chunkFormat,i=this.data,r=i[e[3]||0];if(n.dataType===sr.UINT64){let s=new Ds;return function(e,t,n,i,r,s){let o=HM(t,n,i,r,s,2)+n;e.low=t[o],e.high=t[o+1]}(s,i,r,t,n.subchunkSize,e),s}return function(e,t,n,i,r){return e[HM(e,t,n,i,r,1)+t]}(i,r,t,n.subchunkSize,e)}}class KM extends Sn{constructor(e,t){super();let n=t.dataType;if(n!==sr.UINT64&&n!==sr.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${sr[n]}`);this.chunkFormat=this.registerDisposer(ZM.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1))}getChunk(e,t){return new XM(e,t)}}Hb(((e,t)=>null!=t.compressedSegmentationBlockSize?new KM(e,t):null));const QM="DVID";function eP(e){return e.text()}function tP(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:id;return function(e,t,n,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:id;return Xx(e,t,n,r,((e,t)=>{const n=(0,i.bn)({},t);return e.token&&(n.headers=(0,i.bn)((0,i.bn)({},n.headers),{Authorization:`Bearer ${e}`})),n}),(e=>{if(504===e.status)return"retry";throw e}),s)}(e,t.url,{method:t.method,body:t.payload},""===t.responseType?eP:"json"===t.responseType?Hx:jx,n)}class nP extends uw{constructor(e){super(),this.authServer=e,this.get=pw((e=>{if(!this.authServer)return Qc.resolve({token:""});const t=new Bp(!0);let n;return new Qc(((i,r)=>{function s(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"DVID authorization required.",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Request authorization.";t.setText(n+" ");let r=document.createElement("button");r.textContent=i,t.element.appendChild(r),r.addEventListener("click",(()=>{let t=e.match(/^[^\/]+\/\/[^\/\.]+\.([^\/]+)/);if(t){const n=`https://flyemlogin.${t[1]}/login`;window.alert(`Please log into ${n} and then refresh the neurogalncer page to try again.\nIf you are unable to log into ${n}, please check your authorization server ${e} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${e} to make sure it is correct.`)})),t.setVisible(!0)}var o;e.add((()=>{void 0!==n&&(n.cancel(),n=void 0,t.dispose(),r(ed))})),o=this.authServer,void 0!==n&&n.cancel(),n=new rd,s(o,"Waiting for DVID authorization...","Retry"),async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:id;return{token:await Jx(e,{method:"GET",credentials:"include"},eP,t)}}(o,n).then((e=>{void 0!==n&&(n=void 0,t.dispose(),i(e))}),(e=>{void 0!==n&&(n=void 0,s(o,`DVID authorization failed: ${e}.`,"Retry"))}))}))}))}}class iP extends vw{constructor(e,t){super(new nP(t),{})}}yw.register(QM,(e=>new iP(e.dvidServer,e.authServer)));var rP=globalThis&&globalThis.__decorate||function(e,t,n,r){var s,o=arguments.length,a=o<3?t:null===r?r=Qa(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var l=e.length-1;l>=0;l--)(s=e[l])&&(a=(o<3?s(a):o>3?s(t,n,a):s(t,n))||a);return o>3&&a&&(0,i.bt)(t,n,a),a};let sP=class extends gd{constructor(e,t){super(),this.provider=e,this.registerDisposer(e),this.initializeCounterpart(t)}get(e,t){return this.provider.get(e,t)}};function oP(){return function(e){return class extends e{constructor(){var e;super(...arguments);const t=arguments.length<=1?void 0:arguments[1];this.credentialsProvider=null===(e=t.credentialsProvider)||void 0===e?void 0:e.addRef()}initializeCounterpart(e,t){const n=this.credentialsProvider;t.credentialsProvider=function(e,t){if(void 0===t)return;const n=e.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:Gd(t)},(()=>new sP(t.addRef(),e.rpc))),i=n.addCounterpartRef();return n.dispose(),i}(this.chunkManager,n),super.initializeCounterpart(e,t)}static encodeOptions(e){const t=super.encodeOptions(e),n=e.credentialsProvider;return t.credentialsProvider=void 0===n?void 0:Gd(n),t}}}}sP=rP([yd("CredentialsProvider")],sP),hd("CredentialsProvider.get",(function(e,t){return this.get(e.providerId).get(e.invalidCredentials,t).then((e=>({value:e})))}));const aP=ii(128,128,128);var lP;!function(e){e[e.JPEG=0]="JPEG",e[e.RAW=1]="RAW",e[e.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",e[e.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY"}(lP||(lP={}));class cP{}let dP=class extends cP{};dP.RPC_ID="dvid/VolumeChunkSource";let uP=class extends cP{};uP.RPC_ID="dvid/SkeletonSource";let hP=class extends cP{};hP.RPC_ID="dvid/MeshSource";let pP=class extends cP{constructor(){super(...arguments),this.chunkDataSize=aP}},fP=class extends pP{};fP.RPC_ID="dvid/AnnotationSource";let gP=class extends pP{};gP.RPC_ID="dvid/AnnotationChunkSource";let mP=class{constructor(e,t){this.numLevels=1;try{if(Yr(e),"dvid"===t){let t=ns(e,"Extended",Yr);if(t.MaxDownresLevel){let e=ns(t,"MaxDownresLevel",Xr);this.numLevels=e+1}this.voxelSize=ns(t,"VoxelSize",(e=>Mr(ti(),e))),this.upperVoxelBound=ns(t,"MaxPoint",(e=>Mr(ti(),e.map((e=>++e))))),this.lowerVoxelBound=ns(t,"MinPoint",(e=>Mr(ti(),e))),this.blockSize=ns(t,"BlockSize",(e=>Mr(ti(),e)))}else{if("gs"!==t)throw new Error("unrecognized volume info");{Yr(e);const t=ns(e,"scales",(e=>e));if(0===t.length)throw new Error("Expected at least one scale");const n=t[0];this.voxelSize=ns(n,"resolution",(e=>Dr(ti(),e))),this.lowerVoxelBound=is(n,"offset",(e=>Mr(ti(),e)))||ii(0,0,0);const i=ns(n,"size",(e=>Mr(ti(),e)));this.upperVoxelBound=si(ti(),i,this.lowerVoxelBound),this.blockSize=ii(64,64,64)}}}catch(n){throw new Error(`Failed to parse volume geometry: ${n.message}`)}}},vP=class{constructor(e){try{this.scales=[],this.scales.push(e);let t=e.voxelSize,n=e.lowerVoxelBound,r=e.upperVoxelBound;for(let s=1;s<e.numLevels;++s){let s=(0,i.bn)({},e);s.voxelSize=ai(ti(),t,ii(2,2,2)),t=s.voxelSize,s.upperVoxelBound=ci(ti(),li(ti(),r,ii(2,2,2))),r=s.upperVoxelBound,s.lowerVoxelBound=ci(ti(),li(ti(),n,ii(2,2,2))),n=s.lowerVoxelBound,this.scales.push(s)}}catch(t){throw new Error(`Failed to parse multiscale volume specification: ${t.message}`)}}get numChannels(){return 0===this.scales.length?0:this.scales[0].numChannels}},yP=new pt;yP.set("uint8",sr.UINT8),yP.set("uint32",sr.UINT32),yP.set("uint64",sr.UINT64);class bP{constructor(e){this.obj=e,Yr(e),ns(e,"TypeName",es)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}get tags(){return this.obj.Tags}}class SP{constructor(e,t,n){this.name=t,this.base=n,this.volumeInfo=new mP(function(e,t){if(!e)return t;const n=t&&t.Extended||{};let r=n.MaxDownresLevel,s=n.MaxPoint,o=n.MinPoint,a=n.VoxelSize,l=n.BlockSize;try{e.MaxDownresLevel&&"string"==typeof e.MaxDownresLevel?(r=parseInt(ns(e,"MaxDownresLevel",es)),r<0&&(r=n.MaxDownresLevel)):"number"==typeof e.MaxDownresLevel&&(r=ns(e,"MaxDownresLevel",Kr))}catch{}try{e.MaxPoint&&"string"==typeof e.MaxPoint?s=JSON.parse(ns(e,"MaxPoint",es)):Array.isArray(e.MaxPoint)&&3===e.MaxPoint.length&&(s=e.MaxPoint)}catch{}try{e.MinPoint&&"string"==typeof e.MinPoint?o=JSON.parse(ns(e,"MinPoint",es)):Array.isArray(e.MinPoint)&&3===e.MinPoint.length&&(o=e.MinPoint)}catch{}try{e.VoxelSize&&"string"==typeof e.VoxelSize?a=JSON.parse(ns(e,"VoxelSize",es)):Array.isArray(e.VoxelSize)&&3===e.VoxelSize.length&&(a=e.VoxelSize)}catch{}try{e.BlockSize&&"string"==typeof e.BlockSize?l=JSON.parse(ns(e,"BlockSize",es)):Array.isArray(e.BlockSize)&&3===e.BlockSize.length&&(l=e.BlockSize)}catch{}return{Base:t&&t.Base||{},Extended:(0,i.bn)((0,i.bn)({},n),{VoxelSize:a,MinPoint:o,MaxPoint:s,MaxDownresLevel:r,BlockSize:l})}}(n.tags,e),"dvid")}get lowerVoxelBound(){return this.volumeInfo.lowerVoxelBound}get upperVoxelBound(){return this.volumeInfo.upperVoxelBound}get blockSize(){return this.volumeInfo.blockSize}get voxelSize(){return this.volumeInfo.voxelSize}get numLevels(){return this.volumeInfo.numLevels}}class wP extends(cp(oP()(Jb),dP)){}class xP extends(cp(oP()(Wb),uP)){}class CP extends(cp(oP()(tb),hP)){}class kP extends SP{constructor(e,t,n,i,r){super(e,t,n),this.encoding=i;let s=ns(e,"Extended",Yr),o=ns(s,"Values",(e=>Jr(e,Yr)));if(o.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");let a=new Rt(r);if(i!==lP.COMPRESSED_SEGMENTATIONARRAY)for(;a.has(t+"_"+this.volumeInfo.numLevels.toString());)this.volumeInfo.numLevels+=1;a.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",a.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=ns(o[0],"DataType",(e=>Qr(e,yP)))}get volumeType(){return this.encoding===lP.COMPRESSED_SEGMENTATION||this.encoding===lP.COMPRESSED_SEGMENTATIONARRAY?_E.SEGMENTATION:_E.IMAGE}getSources(e,t,n,r){const s=this.encoding,o=[];for(let a=0;a<this.numLevels;++a){const l=Math.pow(2,a),c=Math.pow(2,-a),d=ti(),u=ti();for(let e=0;e<3;++e){const t=Math.floor(this.lowerVoxelBound[e]*c);d[e]=t-t%64;const n=Math.ceil(this.upperVoxelBound[e]*c);u[e]=n,n%64!==0&&(u[e]+=64-n%64)}let h=t.dataInstanceKey;s!==lP.COMPRESSED_SEGMENTATIONARRAY&&a>0&&(h+="_"+a.toString());const p=(0,i.bn)((0,i.bn)({},t),{dataInstanceKey:h,dataScale:a.toString(),encoding:s}),f=qn();for(let e=0;e<3;++e)f[5*e]=l,f[12+e]=d[e]*l;const g=UE({rank:3,chunkToMultiscaleTransform:f,dataType:this.dataType,baseVoxelOffset:d,upperVoxelBound:oi(ti(),u,d),volumeType:this.volumeType,volumeSourceOptions:n,compressedSegmentationBlockSize:s===lP.COMPRESSED_SEGMENTATION||s===lP.COMPRESSED_SEGMENTATIONARRAY?ii(8,8,8):void 0}).map((t=>({chunkSource:e.getChunkSource(wP,{spec:t,parameters:p,credentialsProvider:r}),chunkToMultiscaleTransform:f})));o.push(g)}return $t(o)}}function TP(e){let t=ns(e,"Base",Yr),n=ns(t,"Syncs",ds);return 1===n.length?n[0]:""}class EP extends SP{get tags(){return ns(this.base.obj,"Tags",Yr)}constructor(e,t,n){super(e,t,n)}}function LP(e,t,n){Yr(e);let i=e[t],r=ns(i,"Base",(e=>new bP(e)));if("annotation"===r.typeName){let n=TP(i);return n&&(i=e[n]),new EP(i,t,r)}return function(e,t,n){Yr(e);let i=ns(e,"Base",(e=>new bP(e)));switch(i.typeName){case"uint8blk":case"grayscale8":let r=-1!==i.compressionName.indexOf("jpeg");return new kP(e,t,i,r?lP.JPEG:lP.RAW,n);case"labels64":case"labelblk":return new kP(e,t,i,lP.COMPRESSED_SEGMENTATION,n);case"labelarray":case"labelmap":return new kP(e,t,i,lP.COMPRESSED_SEGMENTATIONARRAY,n);default:throw new Error(`DVID data type ${Bt(i.typeName)} is not supported.`)}}(i,t,n)}class IP{constructor(e){if(this.errors=[],this.dataInstances=new pt,this.vnodes=new Rt,e instanceof IP)return this.alias=e.alias,this.description=e.description,this.errors=e.errors,void(this.dataInstances=e.dataInstances);Yr(e),this.alias=ns(e,"Alias",es),this.description=ns(e,"Description",es);let t=ns(e,"DataInstances",Yr),n=f(t);for(let o of n)try{this.dataInstances.set(o,LP(t,o,n))}catch(s){let e=`Failed to parse data instance ${Bt(o)}: ${s.message}`;console.log(e),this.errors.push(e)}let i=ns(e,"DAG",Yr),r=ns(i,"Nodes",Yr);for(let o of f(r))this.vnodes.add(o)}}class DP{constructor(e){this.repositories=function(e){try{let i=rs(e,(e=>new IP(e))),r=new pt;for(let e of i){var t=O(e,2);let n=t[0],i=t[1];r.set(n,i);for(let e of i.vnodes)if(e!==n){let t=new IP(i);r.set(e,t)}}for(let e of r){var n=O(e,2);let t=n[0];n[1].uuid=t}return r}catch(i){throw new Error(`Failed to parse DVID repositories info: ${i.message}`)}}(e)}getNode(e){let t=[];for(let n of this.repositories.keys())n.startsWith(e)&&t.push(n);if(1!==t.length)throw new Error(`Node key ${Bt(e)} matches ${Bt(t)} nodes.`);return this.repositories.get(t[0])}}function MP(e,t,n){return e.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:t},(()=>{const e=tP(n,{url:`${t}/api/repos/info`,method:"GET",responseType:"json"}).then((e=>new DP(e))),i=`repository info for DVID server ${t}`;return Bp.forPromise(e,{initialMessage:`Retrieving ${i}.`,delay:!0,errorPrefix:`Error retrieving ${i}: `}),e}))}class PP extends Yb{constructor(e,t,n,i){super(e),this.sourceParameters=t,this.info=n,this.credentialsProvider=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}get baseUrl(){return this.sourceParameters.baseUrl}get nodeKey(){return this.sourceParameters.nodeKey}get dataInstanceKey(){return this.sourceParameters.dataInstanceKey}get supervoxels(){return this.sourceParameters.supervoxels||!1}getSegmentPosition(e){const t=this.sourceParameters.dvidService;return t?fetch(`${t}/locate-body?dvid=${this.baseUrl}&uuid=${this.nodeKey}&segmentation=${this.dataInstanceKey}&body=${e.toString()}${this.supervoxels?"&supervoxels=true":""}`,{method:"GET"}).then((e=>e.json())).then((e=>new Float32Array(e))):Qc.reject("No locate service is available")}getSources(e){return this.info.getSources(this.chunkManager,this.sourceParameters,e,this.credentialsProvider)}}const AP=/^((?:http|https):\/\/[^\/]+)\/([^\/]+)\/([^\/\?#]+)(?:(?:\?|#)(.*))?$/;function RP(e){if(e.startsWith("https"))return e+"/api/server/token"}function NP(e,t){let n=e=>{const n=e.lowerVoxelBound,i=e.upperVoxelBound,r=function(e,t,n){return e.usertag?mi(ti(),n,t):e.chunkDataSize}(t,n,i);return{spec:Oh({rank:3,chunkDataSize:Uint32Array.from(r),lowerVoxelBound:n,upperVoxelBound:i}),chunkToMultiscaleTransform:qn()}};if(t.usertag){if(t.user)return[[n(e.scales[0])]];throw"Expecting a valid user"}return[e.scales.map((e=>n(e)))]}const VP=cp(oP()(Xp),fP);class OP extends(cp(oP()(Wp),gP)){}class BP extends VP{constructor(e,t){super(e,(0,i.bn)({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.multiscaleVolumeInfo=t.multiscaleVolumeInfo,this.childAdded=this.childAdded||new Cn,this.childUpdated=this.childUpdated||new Cn,this.childDeleted=this.childDeleted||new Cn,this.childRefreshed=this.childRefreshed||new kn,void 0!==this.parameters.readonly&&(this.readonly=this.parameters.readonly),this.parameters.user||(this.readonly=!0)}getSources(e){let t=NP(this.multiscaleVolumeInfo,this.parameters),n=0;return t[0].length>1&&(n=3),this.chunkSources=t.map((e=>e.map((e=>{let{spec:t,chunkToMultiscaleTransform:r}=e;return{chunkSource:this.chunkManager.getChunkSource(OP,{spec:(0,i.bn)({limit:n,chunkToMultiscaleTransform:r},t),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:r}})))),this.chunkSources}invalidateCache(){this.metadataChunkSource.invalidateCache();for(let e of this.chunkSources)for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache();this.childRefreshed.dispatch()}}async function _P(e,t,n,i){const r={lowerBounds:new Float64Array(n.lowerVoxelBound),upperBounds:Float64Array.from(n.upperVoxelBound)},s=ia({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(n.voxelSize,(e=>e/1e9)),boundingBoxes:[ua(r)]}),o=await async function(e,t,n,i){let r=new vP(n.volumeInfo);return s=r,o=t,e.chunkManager.getChunkSource(BP,{parameters:o,credentialsProvider:i,multiscaleVolumeInfo:s});var s,o}(e,t,n,i);return{modelTransform:ma(s),subsources:[{id:"default",subsource:{annotation:o},default:!0}]}}function FP(e){return e.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",sourceUrl:e.providerUrl},(async()=>{const t=function(e){let t=e.match(AP);if(null===t)throw new Error(`Invalid DVID URL: ${Bt(e)}.`);let n={baseUrl:t[1],nodeKey:t[2],dataInstanceKey:t[3]};const i=t[4];if(i){const e=os(i);"true"===e.usertag&&(n.usertag=!0),e.user&&(n.user=e.user);const t=e.dvidService||e.dvidservice||e["dvid-service"];t&&(n.dvidService=t),(e.forceDvidService||e.forcedividservice||e["force-dvid-service"])&&(n.forceDvidService=!0),n.supervoxels="true"===e.supervoxels}return n.authServer=RP(n.baseUrl),n}(e.providerUrl),n=t.baseUrl,r=t.nodeKey,s=t.dataInstanceKey,o=r.indexOf(":"),a=-1!==o?r.slice(0,o):r,l=e.credentialsManager.getCredentialsProvider(QM,{dvidServer:t.baseUrl,authServer:t.authServer}),c=(await MP(e.chunkManager,n,l)).getNode(a);if(void 0===c)throw new Error(`Invalid node: ${Bt(r)}.`);const d=c.dataInstances.get(s);if(!d)throw new Error(`Invalid data instance ${s}.`);if("annotation"===d.base.typeName){if(!(d instanceof EP))throw new Error(`Invalid data instance ${s}.`);let n=(0,i.bn)((0,i.bn)({},new fP),t);return d.blockSize&&(n.chunkDataSize=d.blockSize),n.syncedLabel=TP({Base:d.base.obj}),n.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1},{identifier:"confidence",description:"confidence",type:"float32",default:0,min:0,max:1,step:.01}],_P(e,n,d,l)}if(!(d instanceof kP))throw new Error(`Invalid data instance ${s}.`);return function(e,t,n,r){const s=n,o={lowerBounds:new Float64Array(s.lowerVoxelBound),upperBounds:Float64Array.from(s.upperVoxelBound)},a=ia({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(s.voxelSize,(e=>e/1e9)),boundingBoxes:[ua(o)]}),l=new PP(e.chunkManager,t,s,r),c={modelTransform:ma(a),subsources:[{id:"default",subsource:{volume:l},default:!0}]};if(s.meshSrc){const n=qn();for(let e=0;e<3;++e)n[5*e]=1/s.voxelSize[e];c.subsources.push({id:"meshes",default:!0,subsource:{mesh:e.chunkManager.getChunkSource(CP,{parameters:(0,i.bn)((0,i.bn)({},t),{segmentationName:s.name,dataInstanceKey:s.meshSrc}),credentialsProvider:r})},subsourceToModelSubspaceTransform:n})}return s.skeletonSrc&&c.subsources.push({id:"skeletons",default:!0,subsource:{mesh:e.chunkManager.getChunkSource(xP,{parameters:(0,i.bn)((0,i.bn)({},t),{dataInstanceKey:s.skeletonSrc}),credentialsProvider:r})}}),c.subsources.push({id:"bounds",subsource:{staticAnnotations:yo(o)},default:!0}),c}(e,t,d,l)}))}function zP(e,t){let n=t.match(/^(?:([^\/]+)(?:\/([^\/]*))?)?$/);if(null===n)throw new Error("Invalid DVID URL syntax.");if(void 0===n[2])return{offset:0,completions:nf(t,e.repositories.values(),(e=>e.uuid+"/"),(e=>`${e.alias}: ${e.description}`))};let i=n[1],r=e.getNode(i);return ef(i.length+1,function(e,t){return{offset:0,completions:nf(t,e.dataInstances.values(),(e=>e.name),(e=>`${e.base.typeName}`))}}(r,n[2]))}class UP extends cf{constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return FP(e)}completeUrl(e){return async function(e){let t=e.providerUrl.match(/^((?:http|https):\/\/[^\/]+)\/([^\?]*).*$/);if(null===t)throw null;let n=t[1],i=t[2],r=RP(n);const s=await MP(e.chunkManager,n,e.credentialsManager.getCredentialsProvider(QM,{dvidServer:n,authServer:r}));return ef(n.length+1,zP(s,i))}(e)}}function GP(e){return e.text()}function WP(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:id;const s={method:n.method,body:n.payload};return"POST"===s.method&&(s.headers={"Content-Type":"application/json"}),function(e,t,n,r,s){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:id;return Xx(e,n,r,s,function(e){return(t,n)=>{let r=(0,i.bn)({},n);return t?r.headers=(0,i.bn)((0,i.bn)({},r.headers),{Authorization:`Bearer ${t}`}):e.startsWith("https:")&&(r.credentials="include"),r}}(n),(e=>{const n=e.status;if((403===n||401===n)&&t)return"refresh";if(504===n)return"retry";throw e}),o)}(e,t,n.url,s,""===n.responseType?GP:"json"===n.responseType?Hx:jx,r)}Gx("dvid",(e=>new UP(e.credentialsManager)));class $P extends uw{constructor(e,t){var n;super(),n=this,this.authServer=e,this.retry=t,this.get=pw((e=>{const t=new Bp(!0);let i;return new Qc(((r,s)=>{e.add((()=>{void 0!==i&&(i.cancel(),i=void 0,t.dispose(),s(ed))}));const o=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Authorization required.",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Request authorization.";if(t.setText(e+" "),n.retry){let e=document.createElement("button");e.textContent=i,t.element.appendChild(e),e.addEventListener("click",n.retry)}t.setVisible(!0)};let a=this.authServer;(()=>{void 0!==i&&i.cancel(),i=new rd,o("Waiting for authorization...","Retry"),this.getAuthToken(a,i).then((e=>{void 0!==i&&(i=void 0,t.dispose(),r(e))}),(e=>{void 0!==i&&(i=void 0,o(`Authorization failed: ${e}.`,"Retry"))}))})()}))}))}getAuthToken(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:id;if(e){if(e.startsWith("token:"))return Qc.resolve(e.substring(6));if("neurohub"==e)return function(e){return"neurohub"in e?Qc.resolve(e.neurohub.clio.auth.getAuthResponse().id_token):Qc.resolve("")}(window);{const n=new Headers;return Jx(e,{method:"GET",headers:n},GP,t).catch((()=>Jx(e,{method:"GET"},GP,t)))}}return Qc.resolve("")}}const jP="Clio",HP=/^([^\/]+:\/\/[^\/]+)\/([^\/]+)\/([^\/\?]+)(\?.*)?$/;function JP(e){let t=qx(e);return"precomputed"===t.protocol&&(t=qx(t.host+t.path)),t}function qP(e){let t=e.protocol,n=e.host,i=e.path;switch(t){case"gs":return`https://storage.googleapis.com/${n}${i}/info`;case"dvid":const e=function(e){let t=e.match(HP);if(null===t)throw new Error(`Invalid DVID URL: ${Bt(e)}.`);return{baseUrl:t[1],nodeKey:t[2],dataInstanceKey:t[3]}}(n+i);return`${e.baseUrl}/api/node/${e.nodeKey}/${e.dataInstanceKey}/info`;case"https":return`${t}://${n}${i}/info`;default:throw Error("Unrecognized volume information")}}class YP{constructor(e){this.parameters=e}getTopLevelUrl(){var e=this.parameters;return`${e.baseUrl}/${e.api||"clio_toplevel"}`}getDatasetsUrl(){return`${this.getTopLevelUrl()}/datasets`}getGrayscaleInfoUrl(){return qP(JP(this.parameters.grayscale))}getAnnotationEndpoint(){return"Atlas"===this.parameters.kind?"atlas":"annotations"}getAnnotationEntryUrl(){return`${this.getTopLevelUrl()}/${this.getAnnotationEndpoint()}/${this.parameters.dataset}`}getAllAnnotationsUrl(){return this.getAnnotationEntryUrl()+(this.parameters.groups?`?groups=${this.parameters.groups}`:"")}hasPointQueryApi(){return"clio_toplevel"===this.parameters.api||"Atlas"===this.parameters.kind}getPostAnnotationUrl(e){return this.hasPointQueryApi()?`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`:this.getAnnotationEntryUrl()}getDeleteAnnotationUrl(e){if(this.hasPointQueryApi()){const t=e.match(/(-?\d+)_(-?\d+)_(-?\d+)/);if(t)return this.getAnnotationUrl(t?.slice(1,4))}return`${this.getAnnotationEntryUrl()}/${e}`}getAnnotationUrl(e){return`${this.getAnnotationEntryUrl()}?x=${e[0]}&y=${e[1]}&z=${e[2]}`}}class ZP extends $P{constructor(e){super(e),this.authServer=e}}yw.register(jP,(e=>new ZP(e)));dd("annotation.add.signal",(function(e){const t=this.get(e.id),n=So(e.newAnnotation);n&&(t.parent.updateReference(n),t.parent.childAdded.dispatch(n))}));class XP{constructor(e){this.annotation=e}get renderingAttribute(){if("Atlas"===this.kind){if(!this.title)return-1;if(this.checked)return 1}else{if("False Split"===this.bookmarkType)return 2;if("False Merge"===this.bookmarkType)return 3}return 0}get confidence(){return 0}updateProperties(){this.annotation.properties=[this.renderingAttribute,this.confidence]}get ext(){return void 0===this.annotation.ext&&(this.annotation.ext={}),this.annotation.ext}get prop(){return this.annotation.prop}set prop(e){this.annotation.prop=e}get bookmarkType(){if(this.prop)switch(this.prop.type){case"Split":return"False Merge";case"Merge":return"False Split"}return"Other"}get type(){return this.annotation.type}get kind(){return this.annotation.kind}set kind(e){this.annotation.kind=e,this.update()}roundPos(){this.annotation.type===Zs.POINT?this.annotation.point=this.annotation.point.map((e=>Math.round(e))):(this.annotation.type===Zs.LINE||this.annotation.type===Zs.SPHERE)&&(this.annotation.pointA=this.annotation.pointA.map((e=>Math.round(e))),this.annotation.pointB=this.annotation.pointB.map((e=>Math.round(e))))}setProp(e){this.prop=(0,i.bn)((0,i.bn)({},this.prop),e)}get user(){return this.prop&&this.prop.user}set user(e){this.setProp({user:e})}get comment(){return this.prop&&this.prop.comment}get description(){return this.comment}updatePresentation(){this.title?this.annotation.description=this.title+": ":this.annotation.description="",this.description&&(this.annotation.description+=this.description)}update(){this.updatePresentation(),this.updateProperties()}set comment(e){this.setProp({comment:e}),this.updatePresentation()}updateComment(){this.comment=this.annotation.description||"",this.annotation.description=void 0}get title(){return this.prop&&this.prop.title}set title(e){this.setProp({title:e}),this.updatePresentation()}get timestamp(){return this.prop&&this.prop.timestamp?Number(this.prop.timestamp):0}addTimeStamp(){this.setProp({timestamp:String(Date.now())})}get checked(){return this.ext&&this.ext.verified||this.prop&&this.prop.checked||!1}set checked(e){this.setProp({checked:e})}get presentation(){return this.updatePresentation(),this.annotation.description||""}set presentation(e){this.annotation.description=e}}function KP(e,t){let n;const i=function(e){const t=e.split(".")[1];if(t){const e=t.replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)}}(e);if(i&&("user"in i?n=i.user:"email"in i&&(n=i.email)),n){if(t&&t!==n)return}else n=t;return n}const QP={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["comment"],properties:{comment:{$id:"#/properties/Prop/properties/comment",type:"string",title:"Comment",default:""}}}}};class eA extends XP{get title(){return this.annotation.ext&&this.annotation.ext.title}set title(e){this.ext.title=e}get description(){return this.annotation.ext&&this.annotation.ext.description}set description(e){this.ext.description=e}get user(){return this.annotation.ext&&this.annotation.ext.user}set user(e){this.ext.user=e}get checked(){return this.ext&&this.ext.verified}set checked(e){this.ext.verified=e}}const tA={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["description"],properties:{description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}},nA={definitions:{},type:"object",required:["Prop"],properties:{Prop:{$id:"#/properties/Prop",type:"object",title:"Properties",required:["title","description"],properties:{title:{$id:"#/properties/Prop/properties/title",type:"string",title:"Title",default:""},description:{$id:"#/properties/Prop/properties/description",type:"string",title:"Description",default:""}}}}};function iA(e){return Array.isArray(e)}function rA(e){return!iA(e)&&null!==e&&"object"==typeof e}class sA{constructor(e){this.name=e,this.childNodeList=new Array,this.parentNode=null}isRoot(){return null===this.parentNode}isLeaf(){return 0===this.childNodeList.length}*[i.bm](){yield*function*e(t){yield t;for(let n of t.childNodeList)yield*e(n)}(this)}*leafNodes(){for(let e of this)0===e.childNodeList.length&&(yield e)}get fullName(){let e=this.name,t=this.parentNode;for(;t;)e=t.name+"/"+e,t=t.parentNode;return e}get nameArray(){let e=new Array;if(!this.isRoot()){e.push(this.name);let t=this.parentNode;for(;t&&!t.isRoot();)e.push(t.name),t=t.parentNode}return e}getPropertyValue(e){if(!this.isRoot()&&e){let t=this.nameArray,n=e;for(let e=t.length-1;e>=0;--e){if(!rA(n))return n;n=n[t[e]]}return n}}}function oA(e,t){if("object"==e.type){null==t.properties&&(t.properties={}),t.properties.title=e.title;let n=e.required;iA(n)&&n.forEach((n=>{let i=new sA(n);i.parentNode=t,t.childNodeList.push(i),oA(e.properties[n],i)}))}else t.properties=e}function aA(e,t){let n=new sA(t);return oA(e,n),n}function lA(e,t,n){let i,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=document.createElement("div"),o=e.title;switch(o&&s.appendChild(document.createTextNode(o)),e.type){case"number":i=document.createElement("input"),"number"==typeof n&&(i.text=n);break;case"string":let t=e.enum;Array.isArray(t)?(i=document.createElement("select"),s.appendChild(i),t.forEach((e=>{let t=document.createElement("option");t.text=e,t.value=e,t.disabled=r,i.appendChild(t)})),void 0!==n&&(i.value=n)):(i=document.createElement("input"),i.setAttribute("autocomplete","off"),"string"==typeof n&&(i.value=n,i.setAttribute("value",n)));break;case"boolean":i=document.createElement("input"),i.type="checkbox",i.checked="boolean"==typeof n?n:1==n}return i&&(i.id=t,i.readOnly=r,s.appendChild(i)),s}function cA(e,t){return function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=document.createElement("div"),s=aA(e,n);s.record=r;for(let o of s)if(!o.isRoot())if(o.isLeaf()){let e=o.getPropertyValue(t),n=lA(o.properties,o.fullName,e,i);o.parentNode.record.appendChild(n)}else{let e=document.createElement("fieldset"),t=document.createElement("legend");t.textContent=o.properties.title,e.appendChild(t),o.record=e,o.parentNode.record.appendChild(e)}return r}(e,t,"annotation",arguments.length>2&&void 0!==arguments[2]&&arguments[2])}function dA(e,t,n,i){"object"===e.type?e.required.forEach((r=>{let s=n;t&&(typeof n[t]>"u"&&(n[t]={}),s=n[t]),dA(e.properties[r],r,s,function(e,t){return e+"/"+t}(i,r))})):n[t]=function(e){let t=document.getElementById(e);if(t)return"checkbox"===t.type?t.checked:t.value}(i)}JSON.parse('\n{\n  "definitions": {},\n  "type": "object",\n  "required": [\n    "Prop"\n  ],\n  "properties": {\n    "Prop": {\n      "$id": "#/properties/Prop",\n      "type": "object",\n      "title": "Properties",\n      "required": [\n        "comment",\n        "type",\n        "checked"\n      ],\n      "properties": {\n        "comment": {\n          "$id": "#/properties/Prop/properties/comment",\n          "type": "string",\n          "title": "Comment",\n          "default": ""\n        },\n        "type": {\n          "$id": "#/properties/Prop/properties/type",\n          "type": "string",\n          "title": "Type",\n          "enum": ["Merge", "Split", "Other"]\n        },\n        "checked": {\n          "$id": "#/properties/Prop/properties/checked",\n          "type": "boolean",\n          "title": "Checked"\n        }\n      }\n    }\n  }\n}\n');const uA=ii(64,64,64);class hA{}class pA extends hA{constructor(){super(...arguments),this.chunkDataSize=uA}}let fA=class extends pA{};fA.RPC_ID="clio/Annotation";class gA extends pA{}gA.RPC_ID="clio/AnnotationChunkSource";class mA extends(cp(oP()(Wp),gA)){}async function vA(e){const t=e.grayscale;if(t){let e=JP(t);return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:id;const n=`${e.url}`,i={method:e.method,body:e.payload};return""===e.responseType?Jx(n,i,eP,t):"arraybuffer"===e.responseType?Jx(n,i,jx,t):Jx(n,i,Hx,t)}({method:"GET",url:qP(e),responseType:"json"}).then((t=>new mP(t,"https"===e.protocol?"gs":e.protocol)))}return Qc.resolve({numChannels:1,voxelSize:ii(8,8,8),lowerVoxelBound:ii(0,0,0),upperVoxelBound:ii(5e4,5e4,5e4),blockSize:ii(64,64,64),numLevels:1})}const yA=cp(oP()(Xp),fA);class bA extends yA{constructor(e,t){super(e,(0,i.bn)({rank:3,relationships:["segments"],properties:t.parameters.properties},t)),this.readonly=!1,this.parameters=t.parameters,this.dataInfo=t.dataInfo,this.childAdded=this.childAdded||new Cn,this.childUpdated=this.childUpdated||new Cn,this.childDeleted=this.childDeleted||new Cn,this.makeEditWidget=e=>function(e,t,n,r,s,o){const a=(0,i.bn)({},e.value);if(a.type!==Zs.POINT&&a.type!==Zs.LINE&&a.type!==Zs.SPHERE)return null;t||(t=QP);const l=r(a),c=s?s(a):l.prop;let d=cA(t,c?{Prop:c}:{},n.readonly),u=document.createElement("button");return u.textContent="update",u.onclick=()=>{let i={};dA(t,"",i,"annotation");const r=i.Prop;o?o(a,r):l.setProp(r),l.update(),n.update(e,a),n.commit(e)},d.appendChild(u),d}(e,this.parameters.schema,this,(e=>new eA(e)),(e=>(0,i.bn)((0,i.bn)({},e.prop),e.ext)),((e,t)=>{const n=new eA(e);t.title&&(n.title=t.title),t.description&&(n.description=t.description)})),this.getUser=()=>this.parameters.user}getSources(e){let t=function(e){return[[(e=>{const t=e.upperVoxelBound;return{spec:Oh({rank:3,chunkDataSize:Uint32Array.from(t),lowerVoxelBound:e.lowerVoxelBound,upperVoxelBound:e.upperVoxelBound}),chunkToMultiscaleTransform:qn()}})(e)]]}(this.dataInfo),n=0;return t[0].length>1&&(n=10),t.map((e=>e.map((e=>{let{spec:t,chunkToMultiscaleTransform:r}=e;return{chunkSource:this.chunkManager.getChunkSource(mA,{spec:(0,i.bn)({limit:n,chunkToMultiscaleTransform:r},t),parent:this,credentialsProvider:this.credentialsProvider,parameters:this.parameters}),chunkToMultiscaleTransform:r}}))))}*[i.bm](){for(let e of this.references)e[1].value&&(yield e[1].value)}commit(e){e.value&&(e.value.type===Zs.LINE||e.value.type===Zs.SPHERE)&&(e.value.pointA=e.value.pointA.map((e=>Math.round(e))),e.value.pointB=e.value.pointB.map((e=>Math.round(e)))),super.commit(e)}add(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.readonly){let e="Permission denied for changing annotations.";throw Bp.showTemporaryMessage(e),Error(e)}const n=new eA(e);if(n.addTimeStamp(),this.parameters.user&&(n.user=this.parameters.user),e.type===Zs.POINT&&(n.kind=this.parameters.kind||"Note",e.description)){let t=function(e){let t=e.match(/^\${(.*):JSON}$/);return t?JSON.parse(t[1]):null}(e.description);t&&n.setProp(t)}return n.roundPos(),n.update(),super.add(e,t)}update(e,t){const n=new eA(t);n.roundPos(),n.update(),super.update(e,t)}invalidateCache(){this.references.forEach((e=>{e.dispose()})),this.references.clear(),this.childRefreshed.dispatch(),this.metadataChunkSource.invalidateCache();for(let e of this.getSources({multiscaleToViewTransform:new Float32Array,displayRank:1,modelChannelDimensionIndices:[]}))for(let t of e)t.chunkSource.invalidateCache();for(let e of this.segmentFilteredSources)e.invalidateCache()}}async function SA(e,t,n){const i=await vA(t),r={lowerBounds:new Float64Array(i.lowerVoxelBound),upperBounds:Float64Array.from(i.upperVoxelBound)},s=ia({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(i.voxelSize,(e=>e/1e9)),boundingBoxes:[ua(r)]}),o=await async function(e,t,n,i){return r=n,s=t,e.chunkManager.getChunkSource(bA,{parameters:s,credentialsProvider:i,dataInfo:r});var r,s}(e,t,i,n);return{modelTransform:ma(s),subsources:[{id:"default",subsource:{annotation:o},default:!0}]}}const wA=/^([^\/]+:\/\/[^\/]+)\/(?:([^\/\?#]+)\/)?([^\/\?#]+)(?:(?:\?|#)(.*))?$/;async function xA(e,t){let n=function(e){let t=e.match(wA);if(null===t)throw new Error(`Invalid Clio URL: ${Bt(e)}.`);let n={baseUrl:t[1],api:t[2],dataset:t[3]},i=t[4];if(i){let e=os(i);e.token?(n.authToken=e.token,n.authServer="token:"+e.token):e.auth&&(n.authServer=e.auth),e.user?n.user=e.user:n.authToken&&(n.user=KP(n.authToken)),e.kind?"atlas"===e.kind?n.kind="Atlas":n.kind=e.kind:n.kind="Normal",e.groups&&(n.groups=e.groups)}return n}(e.providerUrl);if(!n.user&&n.authServer){let e=t(n.authServer).get();n.authToken=(await e).credentials,n.user=KP(n.authToken)}return e.chunkManager.memoize.getUncounted((0,i.bn)({type:"clio:MultiscaleVolumeChunkSource"},n),(async()=>{n=await async function(e,t){const n=new YP(e);return WP(t(e.authServer),function(e){return!!e.authServer&&("neurohub"===e.authServer||e.authServer.startsWith("http"))}(e),{url:n.getDatasetsUrl(),method:"GET",responseType:"json"}).then((t=>{const n=ns(t,e.dataset,Yr);if("location"in n)e.grayscale=ns(n,"location",es);else if("mainLayer"in n){const t=ns(n,"mainLayer",es),i=ns(n,"neuroglancer",Yr).layers.find((e=>e.name===t));i.source&&i.source.url?e.grayscale=ns(i.source,"url",es):e.grayscale=ns(i,"source",es)}return e}))}(n,t);let r=(0,i.bn)((0,i.bn)({},new fA),n);"Atlas"===n.kind?r.schema=nA:r.schema=tA,r.properties=[{identifier:"rendering_attribute",description:"rendering attribute",type:"int32",default:0,min:0,max:5,step:1}];const s=t(n.authServer);return SA(e,r,s)}))}class CA extends cf{constructor(e){super(),this.credentialsManager=e,this.description="Clio"}getCredentialsProvider(e){let t="";return e&&(t=e),this.credentialsManager.getCredentialsProvider(jP,t)}get(e){return xA(e,this.getCredentialsProvider.bind(this))}completeUrl(e){return async function(){return Qc.resolve({offset:0,completions:[{value:""}]})}(e.providerUrl)}}Gx("clio",(e=>new CA(e.credentialsManager)));const kA="google-brainmaps";function TA(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:id;return Kx(t,`${e.serverUrl}${n.path}`,{method:n.method,body:n.payload},"json"===n.responseType?Hx:jx,i)}var EA;!function(e){e[e.RAW=0]="RAW",e[e.JPEG=1]="JPEG",e[e.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION"}(EA||(EA={}));class LA{}LA.RPC_ID="brainmaps/VolumeChunkSource";let IA=class{};IA.RPC_ID="brainmaps/MultiscaleMeshSource";let DA=class{};DA.RPC_ID="brainmaps/MeshSource";let MA=class{};MA.RPC_ID="brainmaps/SkeletonSource";let PA=class{};PA.RPC_ID="brainmaps/Annotation";let AA=class{};AA.RPC_ID="brainmaps/AnnotationSpatialIndex";class RA extends(cp(oP()(Jb),LA)){}class NA extends(cp(oP()(ab),IA)){}class VA extends(cp(oP()(tb),DA)){}class OA extends(cp(oP()(Wb),MA)){}class BA extends(cp(oP()(Wp),AA)){}const _A=new pt;function FA(e){Yr(e);try{return{corner:ns(e,"corner",(e=>Ir(ti(),e,Tr))),size:ns(e,"size",(e=>Ir(ti(),e,Lr))),metadata:ns(e,"metadata",ts)}}catch(t){throw new Error(`Failed to parse bounding box: ${t.message}`)}}_A.set("UINT8",sr.UINT8),_A.set("FLOAT",sr.FLOAT32),_A.set("UINT32",sr.UINT32),_A.set("UINT64",sr.UINT64);class zA{constructor(e){try{Yr(e),this.numChannels=ns(e,"channelCount",Xr),this.dataType=ns(e,"channelType",(e=>Qr(e,_A))),this.voxelSize=ns(e,"pixelSize",(e=>Ir(ti(),e,Lr))),this.upperVoxelBound=ns(e,"volumeSize",(e=>Ir(ti(),e,Xr))),this.boundingBoxes=ns(e,"boundingBox",(e=>void 0===e?[]:Jr(e,FA)))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}}function UA(e){return Yr(e),{name:ns(e,"name",es),type:ns(e,"type",es)}}const GA="([0-9]+)",WA=new RegExp(`^(.*)_${GA}x${GA}x${GA}_lod([0-9]+)_([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)$`);function $A(e,t){const n=function(e,t){const n=new pt,i=e.scales[0],r=new Rt;for(const o of t){if("TRIANGLES"!==o.type)continue;const e=o.name.match(WA);if(null===e)continue;const t=e[1];let s=n.get(t);void 0===s&&(s={key:t,chunkShape:ti(),lods:[]},n.set(t,s));const a=parseInt(e[5]);if(void 0!==s.lods[a]){r.add(t);continue}const l=ii(parseInt(e[2],10),parseInt(e[3],10),parseInt(e[4],10)),c=new Uint32Array(3);for(let n=0;n<3;++n)c[n]=Math.ceil(i.upperVoxelBound[n]/l[n]);s.lods[a]={info:o,scale:parseFloat(e[6]),relativeBlockShape:l,gridShape:c}}const s=[];e:for(const o of n.values()){if(r.has(o.key))continue e;const e=o.lods[0];if(void 0===e)continue e;const t=e.relativeBlockShape;ai(o.chunkShape,t,i.voxelSize);for(let n=1;n<o.lods.length;++n){const e=o.lods[n];if(void 0===e)continue e;const i=e.relativeBlockShape;for(let n=0;n<3;++n){const e=i[n],r=t[n];if(e<r||e%r!==0)continue e;i[n]=e/r}}t.fill(1),s.push(o)}return s}(e,t),i=[],r=e=>{i.some((t=>t.name===e.name))||i.push(e)},s=new Rt;for(const o of n){r({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(const e of o.lods)s.add(e.info)}for(const o of t)r({single:o,multi:void 0,name:o.name,partOfMultiscale:s.has(o)});return i}class jA{constructor(e){try{Yr(e);let t=this.scales=ns(e,"geometry",(e=>Jr(e,(e=>new zA(e)))));if(0===t.length)throw new Error("Expected at least one scale.");let n=t[0],i=this.numChannels=n.numChannels,r=this.dataType=n.dataType;for(let e=1,s=t.length;e<s;++e){let n=t[e];if(n.dataType!==r)throw new Error(`Scale ${e} has data type ${sr[n.dataType]} but scale 0 has data type ${sr[r]}.`);if(n.numChannels!==i)throw new Error(`Scale ${e} has ${n.numChannels} channel(s) but scale 0 has ${i} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(n.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.scales[0],n=["x","y","z"],i=["m","m","m"],r=It(t.voxelSize,(e=>e/1e9)),s=It(t.upperVoxelBound);return e&&(n.push("c^"),i.push(""),r.push(1),s.push(this.numChannels)),ia({names:n,units:i,scales:Float64Array.from(r),boundingBoxes:[ua({lowerBounds:new Float64Array(n.length),upperBounds:Float64Array.from(s)})]})}}let HA=class extends Yb{constructor(e,t,n,i,r,s,o){super(e),this.instance=t,this.credentialsProvider=n,this.volumeId=i,this.changeSpec=r,this.multiscaleVolumeInfo=s,this.encoding=o.encoding,this.jpegQuality=o.jpegQuality,this.chunkLayoutPreference=o.chunkLayoutPreference;let a=_E.IMAGE;this.dataType===sr.UINT64&&(a=_E.SEGMENTATION),this.volumeType=a}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return 1!==this.multiscaleVolumeInfo.numChannels?4:3}getSources(e){let t=EA.RAW;this.dataType!==sr.UINT64&&this.dataType!==sr.UINT32||this.volumeType!==_E.SEGMENTATION||this.encoding===EA.RAW?this.volumeType===_E.IMAGE&&this.dataType===sr.UINT8&&1===this.multiscaleVolumeInfo.numChannels&&this.encoding!==EA.RAW&&!0!==e.discreteValues&&(t=EA.JPEG):t=EA.COMPRESSED_SEGMENTATION;const n=t===EA.JPEG?this.jpegQuality:void 0,i=this.scales[0],r=i.upperVoxelBound,s=ti(),o=this.rank;return $t(this.scales.map(((a,l)=>{li(s,a.voxelSize,i.voxelSize);let c,d=a.upperVoxelBound,u=a.numChannels;const h=new Float32Array((o+1)**2);h[(o+1)*o+o]=1;const p=new Float32Array(o);1!==u&&(d=Float32Array.of(...d,u),c=Uint32Array.of(1,1,1,u),h[3*(o+1)+3]=1,p[3]=u);for(let e=0;e<3;++e)h[(o+1)*e+e]=s[e],p[e]=r[e]/s[e];return UE({rank:o,minBlockSize:c,chunkToMultiscaleTransform:h,dataType:a.dataType,upperVoxelBound:d,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:ii(64,64,64)}).map((e=>({chunkSource:this.chunkManager.getChunkSource(RA,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:l,encoding:t,jpegQuality:n,instance:this.instance}}),chunkToMultiscaleTransform:h,upperClipBound:p})))})))}};function JA(e){const t=qn(),n=e.scales[0].voxelSize;for(let i=0;i<3;++i)t[5*i]=1/n[i];return t}function qA(e){try{return Yr(e),{id:ns(e,"id",es),label:ns(e,"label",es),description:ns(e,"description",ts)}}catch(t){throw new Error(`Failed to parse project: ${t.message}`)}}function YA(e,t){try{return Yr(e),ns(e,t,(e=>void 0===e?[]:Jr(e,es)))}catch(n){throw new Error(`Error parsing dataset list: ${n.message}`)}}const ZA=cp(oP()(Xp),PA);class XA extends ZA{constructor(e,t){super(e,(0,i.bn)({rank:3,relationships:["segments"],properties:[]},t)),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){const e=this.parameters.upperVoxelBound,t=Oh({rank:3,chunkDataSize:e,upperVoxelBound:e}),n=qn();return[[{chunkSource:this.chunkManager.getChunkSource(BA,{parent:this,spec:(0,i.bn)({limit:0,chunkToMultiscaleTransform:n},t),parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:n}]]}}const KA=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class QA extends cf{constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:Gd(this.credentialsProvider)},(()=>TA(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then((e=>new jA(e)))))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:Gd(this.credentialsProvider)},(()=>TA(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then((t=>function(t){try{return Yr(t),ns(t,"meshes",(e=>void 0===e?[]:Jr(e,UA)))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}(t)))))}get(e){var t=function(e){const t=e.match(/^([^:?\/]+:[^:?\/]+:[^:?\/]+)(?::([^:?\/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(null===t)throw new Error(`Invalid Brain Maps volume key: ${Bt(e)}.`);let n;void 0!==t[2]&&(n={changeStackId:t[2]});const i=os(t[4]||"");return{volumeId:t[1],changeSpec:n,meshName:t[3],parameters:i}}(e.providerUrl);const n=t.volumeId,i=t.changeSpec,r=t.meshName,s=t.parameters;Yr(s);const o=is(s,"encoding",(e=>ls(e,EA))),a=is(s,"jpegQuality",(e=>{const t=Zr(e);if(t<1||t>100)throw new Error(`Expected integer in range [1, 100], but received: ${e}`);return t}),70),l={encoding:o,chunkLayoutPreference:is(s,"chunkLayout",(e=>ls(e,Nh))),jpegQuality:a};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:n,changeSpec:i,brainmapsOptions:l},(async()=>{var t=await Qc.all([this.getMultiscaleInfo(e.chunkManager,n),this.getMeshesInfo(e.chunkManager,n)]),s=O(t,2);const o=s[0],a=s[1],c=new HA(e.chunkManager,this.instance,this.credentialsProvider,n,i,o,l),d={modelTransform:ma(o.getModelSpace(1!==o.numChannels)),subsources:[{id:void 0===r?"default":"volume",subsource:{volume:c},default:void 0===r}]},u=yo(o.box);o.scales[0].boundingBoxes.forEach(((e,t)=>{u.add({type:Zs.AXIS_ALIGNED_BOUNDING_BOX,description:e.metadata,pointA:e.corner,pointB:si(ti(),e.corner,e.size),id:`boundingBox${t}`,properties:[]})})),d.subsources.push({id:"bounds",subsource:{staticAnnotations:u},default:!0});const h=$A(o,a),p=(t,s)=>{let a;const l=t.single;if(void 0!==l)a="TRIANGLES"===l.type?e.chunkManager.getChunkSource(VA,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:n,meshName:l.name,changeSpec:i}}):e.chunkManager.getChunkSource(OA,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:n,meshName:t.name,changeSpec:i}});else{const r=t.multi;a=e.chunkManager.getChunkSource(NA,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:fm.float32},parameters:{instance:this.instance,volumeId:n,info:r,changeSpec:i}})}d.subsources.push({id:void 0===r?`/${t.name}`:"default",subsource:{mesh:a},subsourceToModelSubspaceTransform:JA(o),modelSubspaceDimensionIndices:[0,1,2],default:s})};if(void 0!==r){const e=h.find((e=>e.name===r));if(void 0===e)throw new Error(`Mesh/skeleton source not found: ${Bt(e)}`);p(e,!0)}else{let e=!0;for(const t of h)t.partOfMultiscale||(p(t,e),e=!1)}return void 0!==i&&d.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(XA,{parameters:{volumeId:n,changestack:i.changeStackId,instance:this.instance,upperVoxelBound:o.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),d}))}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},(()=>{let t=TA(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then((t=>function(t){try{return Yr(t),ns(t,"project",(e=>void 0===e?[]:Jr(e,qA)))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}(t)));const n=`${this.instance.description} project list`;return Bp.forPromise(t,{delay:!0,initialMessage:`Retrieving ${n}.`,errorPrefix:`Error retrieving ${n}: `}),t}))}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},(()=>{let e=TA(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then((e=>YA(e,"datasetIds")));const n=`${this.instance.description} dataset list`;return Bp.forPromise(e,{delay:!0,initialMessage:`Retrieving ${n}`,errorPrefix:`Error retrieving ${n}`}),e}))}getVolumeList(e,t,n){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${n}:getVolumeList`},(()=>{let e=TA(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${n}`,responseType:"json"}).then((e=>{const i=YA(e,"volumeId"),r=t.length+n.length+2,s=[];for(const t of i)s.push(t.substring(r));return s}));const i=`${this.instance.description} volume list`;return Bp.forPromise(e,{delay:!0,initialMessage:`Retrieving ${i}`,errorPrefix:`Error retrieving ${i}`}),e}))}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},(()=>{let e=TA(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then((e=>function(e){return ns(e,"changeStackId",(e=>void 0===e?void 0:Jr(e,es)))}(e)));const n=`change stacks for ${t}`;return Bp.forPromise(e,{delay:!0,initialMessage:`Retrieving ${n}.`,errorPrefix:`Error retrieving ${n}: `}),e}))}async completeUrl(e){const t=e.providerUrl,n=t.match(/^([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*)(?::([^:\/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(null===n)throw null;var i=O(n,7);const r=i[1],s=i[2],o=i[3],a=i[4],l=i[5],c=i[6];if(void 0!==c)return ef(t.length-c.length,await rf(c,KA));if(void 0!==l){const n=`${r}:${s}:${o}`,i=await this.getMeshesInfo(e.chunkManager,n),a=[],c=new Rt;for(const e of i)if(e.name.startsWith(l))switch(e.type){case"LINE_SEGMENTS":a.push({value:e.name,description:"Skeletons"});break;case"TRIANGLES":{a.push({value:e.name,description:"Mesh (single-resolution)"});const t=e.name.match(WA);if(null!==t){const e=t[1];if(c.has(e))break;c.add(e),a.push({value:e,description:"Mesh (multi-resolution)"})}break}}return a.sort(((e,t)=>Kp(e.value,t.value))),{offset:t.length-l.length,completions:a}}if(void 0!==a){const n=`${r}:${s}:${o}`,i=await this.getChangeStackList(e.chunkManager,n);if(void 0===i)throw null;return{offset:t.length-a.length,completions:tf(a,i)}}if(void 0!==o)return{offset:t.length-o.length,completions:tf(o,await this.getVolumeList(e.chunkManager,r,s))};if(void 0!==s){const n=await this.getDatasetList(e.chunkManager,r);return{offset:t.length-s.length,completions:tf(s,n.map((e=>`${e}:`)))}}return{offset:0,completions:nf(r,await this.getProjectList(e.chunkManager),(e=>`${e.id}:`),(e=>e.label))}}}const eR={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};if(Gx("brainmaps",(e=>new QA(eR,e.credentialsManager.getCredentialsProvider(kA)))),typeof NEUROGLANCER_BRAINMAPS_SERVERS<"u")for(const iV of Cf(NEUROGLANCER_BRAINMAPS_SERVERS)){var tR=O(iV,2);const e=tR[0],t=tR[1];Gx(`brainmaps-${e}`,(e=>new QA(t,e.credentialsManager.getCredentialsProvider(kA))))}const nR="https://accounts.google.com";class iR{constructor(){this.finished=new Cn}}class rR{constructor(){this.proxyName=`postmessageRelay${Js()}`,this.rpcToken=`${Js()}`,this.relayReadyService=`oauth2relayReady:${this.rpcToken}`,this.oauth2CallbackService=`oauth2callback:${this.rpcToken}`,this.pendingRequests=new pt,function(e,t){let n=document.createElement("iframe");n.style.display="none",n.id=e,n.name=e;const i=location.origin;n.src=`https://accounts.google.com/o/oauth2/postmessageRelay?parent=${encodeURIComponent(i)}#rpctoken=${t}`,document.body.appendChild(n)}(this.proxyName,this.rpcToken),this.relayReadyPromise=new Qc((e=>{addEventListener("message",(t=>{if(t.origin===nR)try{let n=Yr(JSON.parse(t.data)),i=es(n.s);if(i===this.relayReadyService&&e(),i===this.oauth2CallbackService){let e=es(Jr(n.a,(e=>e))[0]),t=location.origin;if(!e.startsWith(t+"#")&&!e.startsWith(t+"?"))throw new Error(`oauth2callback: URL ${Bt(e)} does not match current origin ${t}.`);let i=e.substring(t.length+1).split("&"),r=new pt;for(let n of i){let e=n.match("^([a-z_]+)=(.*)$");if(null===e)throw new Error(`oauth2callback: URL part ${Bt(e)} does not match expected pattern.`);r.set(e[1],e[2])}let s=r.get("state");if(void 0===s)throw new Error("oauth2callback: State argument is missing.");let o=this.pendingRequests.get(s);if(void 0===o)return;let a=r.get("error");if(void 0!==a){let e=r.get("error_subtype"),t=a;return void 0!==e&&(t+=": "+e),void o.finished.dispatch(void 0,new Error(`Error obtaining Google OAuth2 token: ${t}`))}let l=r.get("access_token"),c=r.get("token_type"),d=r.get("expires_in"),u=r.get("scope");if(void 0===l||void 0===c||void 0===d||void 0===u)throw new Error("oauth2callback: URL lacks expected parameters.");return void o.finished.dispatch({accessToken:l,tokenType:c,expiresIn:d,scope:u})}}catch(n){throw new Error(`Invalid message received from ${nR}: ${Bt(t.data)}: ${n.message}.`)}}))}))}addPendingRequest(e){let t=new iR;return this.pendingRequests.set(e,t),t.finished.add((()=>{this.pendingRequests.delete(e)})),t}makeAuthRequestUrl(e){let t=`https://accounts.google.com/o/oauth2/auth?client_id=${encodeURIComponent(e.clientId)}`;t+="&redirect_uri=postmessage",t+="&response_type=token";var n=e.origin;let i=void 0===n?location.origin:n;return t+=`&origin=${encodeURIComponent(i)}`,t+=`&proxy=${this.proxyName}`,t+="&include_granted_scopes=true",t+=`&scope=${encodeURIComponent(e.scopes.join(" "))}`,e.state&&(t+=`&state=${e.state}`),e.approvalPrompt&&(t+=`&approval_prompt=${encodeURIComponent(e.approvalPrompt)}`),e.loginHint&&(t+=`&login_hint=${encodeURIComponent(e.loginHint)}`),e.immediate&&(t+="&immediate=true"),void 0!==e.authUser&&(t+=`&authuser=${e.authUser}`),t}}let sR;function oR(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:id;const n=Js(),i=(void 0===sR&&(sR=new rR),sR),r=i.makeAuthRequestUrl({state:n,clientId:e.clientId,scopes:e.scopes,approvalPrompt:e.approvalPrompt,loginHint:e.loginHint,immediate:e.immediate,authUser:e.authUser}),s=i.addPendingRequest(n),o=new Qc(((e,t)=>{s.finished.add(((n,i)=>{void 0!==n?e(n):t(i)}))}));if(s.finished.add(t.add((()=>{s.finished.dispatch(void 0,ed)}))),e.immediate)i.relayReadyPromise.then((()=>{if(t.isCanceled)return;const e=document.createElement("iframe");e.src=r,e.style.display="none",document.body.appendChild(e),s.finished.add((()=>{Nv(e)}))}));else if(!t.isCanceled){const e=open(r);null!==e&&s.finished.add((()=>{e.close()}))}return o}class aR extends uw{constructor(e){super(),this.options=e,this.get=pw((e=>{const t=this.options,n=new Bp(!0);let i;return new Qc(((r,s)=>{function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:`${t.description} authorization required.`,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Request authorization.";n.setText(e+"  ");let r=document.createElement("button");r.textContent=i,n.element.appendChild(r),r.addEventListener("click",(()=>{a(!1)})),n.setVisible(!0)}function a(e){void 0!==i&&i.cancel(),i=new rd,o(`Waiting for ${t.description} authorization...`,"Retry"),oR({clientId:t.clientId,scopes:t.scopes,immediate:e,authUser:0},i).then((e=>{void 0!==i&&(i=void 0,n.dispose(),r(e))}),(n=>{void 0!==i&&(i=void 0,e?o():o(`${t.description} authorization failed: ${n}.`,"Retry"))}))}e.add((()=>{void 0!==i&&(i.cancel(),i=void 0,n.dispose(),s(ed))})),a(!0)}))}))}}class lR extends aR{constructor(e){super({clientId:e,scopes:["https://www.googleapis.com/auth/brainmaps"],description:"Brain Maps"})}}var cR;yw.register(kA,(()=>new lR(BRAINMAPS_CLIENT_ID))),function(e){e[e.RAW=0]="RAW",e[e.JPEG=1]="JPEG",e[e.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",e[e.COMPRESSO=3]="COMPRESSO",e[e.PNG=4]="PNG"}(cR||(cR={}));let dR=class{};dR.RPC_ID="precomputed/VolumeChunkSource";class uR{}var hR,pR;uR.RPC_ID="precomputed/MeshSource",function(e){e[e.RAW=0]="RAW",e[e.GZIP=1]="GZIP"}(hR||(hR={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128"}(pR||(pR={}));class fR{}fR.RPC_ID="precomputed/MultiscaleMeshSource";class gR{}gR.RPC_ID="precomputed/SkeletonSource";class mR{}mR.RPC_ID="precomputed/AnnotationSpatialIndexSource";class vR{}vR.RPC_ID="precomputed/AnnotationSource";class yR{}async function bR(e,t,n,i,r){if(!i.startsWith("/"))throw null;const s=await async function(e,t,n,i,r){const s=await Kx(e,`https://www.googleapis.com/storage/v1/b/${t}/o?delimiter=${encodeURIComponent(i)}&prefix=${encodeURIComponent(n)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},Hx,r);return Yr(s),[...is(s,"prefixes",ds,[]),...is(s,"items",(e=>Jr(e,(e=>(Yr(e),ns(e,"name",es))))),[]).filter((e=>!e.endsWith("_$folder$")))]}(e,n,i.substring(1),"/",r);let o=i.lastIndexOf("/");return{offset:o+t.length+1,completions:s.map((e=>({value:e.substring(o)})))}}async function SR(e,t,n){console.log("getHtmlPathCompletions");const i=e.match(/^([a-z]+:\/\/.*\/)([^\/?#]*)$/);if(null===i)throw null;const r=await async function(e,t,n){var i=await oC(n,e,{headers:{accept:"text/html"}},(async e=>({text:await e.text(),contentType:e.headers.get("content-type")})),t);const r=i.text,s=i.contentType;if(null===s||null===/\btext\/html\b/i.exec(s))return[];const o=(new DOMParser).parseFromString(r,"text/html"),a=o.evaluate("//a/@href",o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let c=0,d=a.snapshotLength;c<d;++c){const t=a.snapshotItem(c).textContent;t&&l.push(new URL(t,e).toString())}return l}(i[1],t,n),s=i[1].length,o=[];for(const a of r)a.startsWith(e)&&o.push({value:a.substring(s)});return{offset:s,completions:o}}yR.RPC_ID="precomputed/IndexedSegmentPropertySource";const wR=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+json://",description:"Google Cloud Storage (storage JSON API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function xR(e,t,n){if(!t.includes("://"))return{offset:0,completions:nf(t,wR,(e=>e.value),(e=>e.description))};var i=sC(t,e);const r=i.url,s=i.credentialsProvider,o=t.length-r.length;let a;try{a=qx(r)}catch{throw null}var l=a;const c=l.protocol,d=l.host,u=l.path,h=await(async()=>{if("gs+xml"===c&&u.length>0)return await Qx(s,`${c}://${d}`,`https://storage.googleapis.com/${d}`,u,n);if(("gs"===c||"gs+json"===c)&&u.length>0)return await bR(s,`${c}://${d}`,d,u,n);if("s3"===c&&u.length>0)return await async function(e,t,n){const i=(await nC(e).get()).credentials.region;return await Qx(void 0,`s3://${e}`,`https://${e}.s3.${i}.amazonaws.com`,t,n)}(d,u,n);const e=r.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^\/]+|[^\/]+\.storage\.googleapis\.com|[^\/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(null!==e)return await Qx(s,e[1],e[1],e[2],n);if(("http"===c||"https"===c)&&u.length>0)return await SR(r,n,s);throw null})();return{offset:o+h.offset,completions:h.completions}}class CR extends(cp(oP()(Jb),dR)){}class kR extends(cp(oP()(tb),uR)){}class TR extends(cp(oP()(ab),fR)){}class ER extends(cp(oP()(Wb),gR)){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function LR(e,t){const n=e.split("/");for(const i of t.split("/"))".."!==i||0===n.length?n.push(i):n.length=n.length-1;return n.join("/")}class IR{constructor(e,t){Yr(e);const n=1===t?3:4,i=this.resolution=new Float64Array(n),r=this.voxelOffset=new Float32Array(n),s=this.size=new Float32Array(n);if(4===n&&(i[3]=1,s[3]=t),ns(e,"resolution",(e=>qr(i.subarray(0,3),e,Lr))),is(e,"voxel_offset",(e=>qr(r.subarray(0,3),e,Zr))),ns(e,"size",(e=>qr(s.subarray(0,3),e,Xr))),this.chunkSizes=ns(e,"chunk_sizes",(e=>Jr(e,(e=>{const i=new Uint32Array(n);return 4===n&&(i[3]=t),qr(i.subarray(0,3),e,Xr),i})))),0===this.chunkSizes.length)throw new Error("No chunk sizes specified.");if(this.sharding=ns(e,"sharding",BR),void 0!==this.sharding&&1!==this.chunkSizes.length)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=ns(e,"encoding",(e=>ls(e,cR))))===cR.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=ns(e,"compressed_segmentation_block_size",(e=>qr(ti(),e,Xr)))),this.key=ns(e,"key",es)}}class DR extends Yb{constructor(e,t,n,i){super(e),this.credentialsProvider=t,this.url=n,this.info=i}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){const t=this.info.scales[0].resolution,n=this.rank;return $t(this.info.scales.map((i=>{const r=i.resolution,s=n+1,o=new Float32Array(s*s);o[o.length-1]=1;var a=this.info.modelSpace.boundingBoxes[0].box;const l=a.lowerBounds,c=a.upperBounds,d=new Float32Array(n),u=new Float32Array(n);for(let e=0;e<3;++e){const a=r[e]/t[e];o[s*e+e]=a;const h=i.voxelOffset[e];o[s*n+e]=h*a,d[e]=l[e]/a-h,u[e]=c[e]/a-h}return 4===n&&(o[3*s+3]=1,d[3]=l[3],u[3]=c[3]),UE({rank:n,dataType:this.dataType,chunkToMultiscaleTransform:o,upperVoxelBound:i.size,volumeType:this.volumeType,chunkDataSizes:i.chunkSizes,baseVoxelOffset:i.voxelOffset,compressedSegmentationBlockSize:i.compressedSegmentationBlockSize,volumeSourceOptions:e}).map((e=>({chunkSource:this.chunkManager.getChunkSource(CR,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:LR(this.url,i.key),encoding:i.encoding,sharding:i.sharding}}),chunkToMultiscaleTransform:o,lowerClipBound:d,upperClipBound:u})))})))}}const MR=cp(oP()(Xp),vR);class PR extends(cp(oP()(Wp),mR)){}class AR extends MR{constructor(e,t){const n=t.parameters;super(e,{rank:n.rank,relationships:n.relationships.map((e=>e.name)),properties:n.properties,parameters:n}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map((e=>{const t=e.spec;return{chunkSource:this.chunkManager.getChunkSource(PR,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}}))]}}function RR(e,t,n){return e.getChunkSource(kR,{parameters:n,credentialsProvider:t})}function NR(e){return ns(e,"transform",(e=>{const t=qn();return void 0!==e&&qr(t.subarray(0,12),e,Tr),Xn(t,t),t}))}async function VR(e,t,n){let i;try{i=await GR(e,t,n)}catch(r){if(Yx(r))return{metadata:void 0};throw r}return function(e){Yr(e);const t=ns(e,"@type",es);let n;if("neuroglancer_legacy_mesh"===t)n=void 0;else{if("neuroglancer_multilod_draco"!==t)throw new Error(`Unsupported mesh type: ${Bt(t)}`);{const t=ns(e,"lod_scale_multiplier",Lr),i=ns(e,"vertex_quantization_bits",Xr);n={lodScaleMultiplier:t,transform:NR(e),sharding:ns(e,"sharding",BR),vertexQuantizationBits:i}}}return{metadata:n,segmentPropertyMap:ns(e,"segment_properties",ts)}}(i)}function OR(e){return void 0===e?hR.RAW:ls(e,hR)}function BR(e){if(void 0===e)return;Yr(e);const t=ns(e,"@type",es);if("neuroglancer_uint64_sharded_v1"!==t)throw new Error(`Unsupported sharding format: ${Bt(t)}`);return{hash:ns(e,"hash",(e=>ls(e,pR))),preshiftBits:ns(e,"preshift_bits",Zr),shardBits:ns(e,"shard_bits",Zr),minishardBits:ns(e,"minishard_bits",Zr),minishardIndexEncoding:ns(e,"minishard_index_encoding",OR),dataEncoding:ns(e,"data_encoding",OR)}}async function _R(e,t,n){return function(e){Yr(e);const t=ns(e,"@type",es);if("neuroglancer_skeletons"!==t)throw new Error(`Unsupported skeleton type: ${Bt(t)}`);const n=NR(e),i=new pt;ns(e,"vertex_attributes",(e=>{void 0!==e&&Jr(e,(e=>{Yr(e);const t=ns(e,"id",es);if(""===t)throw new Error("vertex attribute id must not be empty");if(i.has(t))throw new Error(`duplicate vertex attribute id ${Bt(t)}`);const n=ns(e,"data_type",(e=>ls(e,sr))),r=ns(e,"num_components",Xr);i.set(t,{dataType:n,numComponents:r})}))}));const r=ns(e,"sharding",BR),s=ns(e,"segment_properties",ts);return{metadata:{transform:n,vertexAttributes:i,sharding:r},segmentPropertyMap:s}}(await GR(e,t,n))}function FR(){return ia({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function zR(e,t,n){var i=await VR(e,t,n);const r=i.metadata,s=i.segmentPropertyMap;if(void 0===r)return{source:RR(e,t,{url:n,lod:0}),transform:qn(),segmentPropertyMap:s};let o;const a=r.vertexQuantizationBits;if(10===a)o=fm.uint10;else{if(16!==a)throw new Error(`Invalid vertex quantization bits: ${a}`);o=fm.uint16}return{source:e.getChunkSource(TR,{credentialsProvider:t,parameters:{url:n,metadata:r},format:{fragmentRelativeVertices:!0,vertexPositionFormat:o}}),transform:r.transform,segmentPropertyMap:s}}async function UR(e,t,n){var i=await _R(e,t,n);const r=i.metadata,s=i.segmentPropertyMap;return{source:e.getChunkSource(ER,{credentialsProvider:t,parameters:{url:n,metadata:r}}),transform:r.transform,segmentPropertyMap:s}}function GR(e,t,n){return e.memoize.getUncounted({type:"precomputed:metadata",url:n,credentialsProvider:Gd(t)},(async()=>await oC(t,`${n}/info`,{},Hx)))}function WR(e){const t=qn(),n=e.scales[0].resolution;for(let i=0;i<3;++i)t[5*i]=1/n[i];return t}async function $R(e,t,n,i){const r=function(e){Yr(e);const t=ns(e,"data_type",(e=>ls(e,sr))),n=ns(e,"num_channels",Xr),i=ns(e,"type",(e=>ls(e,_E))),r=ns(e,"mesh",ts),s=ns(e,"skeletons",ts),o=ns(e,"segment_properties",ts),a=ns(e,"scales",(e=>Jr(e,(e=>new IR(e,n)))));if(0===a.length)throw new Error("Expected at least one scale");const l=a[0],c=1===n?3:4,d=new Float64Array(c),u=new Float64Array(c),h=new Float64Array(c),p=["x","y","z"],f=["m","m","m"];for(let g=0;g<3;++g)d[g]=l.resolution[g]/1e9,u[g]=l.voxelOffset[g],h[g]=u[g]+l.size[g];return 4===c&&(d[3]=1,h[3]=n,p[3]="c^",f[3]=""),{dataType:t,volumeType:i,mesh:r,skeletons:s,segmentPropertyMap:o,scales:a,modelSpace:ia({rank:c,names:p,units:f,scales:d,boundingBoxes:[ua({lowerBounds:u,upperBounds:h})]})}}(i),s=new DR(e.chunkManager,t,n,r),o=r.modelSpace,a=[{id:"default",default:!0,subsource:{volume:s}},{id:"bounds",default:!0,subsource:{staticAnnotations:yo(o.bounds)}}];if(void 0!==r.segmentPropertyMap){const i=LR(n,r.segmentPropertyMap),s=await GR(e.chunkManager,t,i),o=YR(e.chunkManager,t,s);a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:o}})}if(void 0!==r.mesh){const i=LR(n,r.mesh);var l=await zR(e.chunkManager,t,i);const s=l.source,o=l.transform,c=WR(r);Qn(c,c,o),a.push({id:"mesh",default:!0,subsource:{mesh:s},subsourceToModelSubspaceTransform:c})}if(void 0!==r.skeletons){const i=LR(n,r.skeletons);var c=await UR(e.chunkManager,t,i);const s=c.source,o=c.transform,l=WR(r);Qn(l,l,o),a.push({id:"skeletons",default:!0,subsource:{mesh:s},subsourceToModelSubspaceTransform:l})}return{modelTransform:ma(o),subsources:a}}function jR(e,t){return Yr(t),{url:LR(e,ns(t,"key",es)),sharding:ns(t,"sharding",BR)}}class HR{constructor(e,t){this.url=e,Yr(t);const n=ns(t,"dimensions",aa),r=n.rank,s=ns(t,"lower_bound",(e=>qr(new Float64Array(r),e,Tr))),o=ns(t,"upper_bound",(e=>qr(new Float64Array(r),e,Tr)));this.coordinateSpace=ia({rank:r,names:n.names,units:n.units,scales:n.scales,boundingBoxes:[ua({lowerBounds:s,upperBounds:o})]}),this.parameters={type:ns(t,"annotation_type",(e=>ls(e,Zs))),rank:r,relationships:ns(t,"relationships",(t=>Jr(t,(t=>{const n=jR(e,t),r=ns(t,"id",es);return(0,i.bn)((0,i.bn)({},n),{name:r})})))),properties:ns(t,"properties",ao),byId:ns(t,"by_id",(t=>jR(e,t)))},this.spatialIndices=ns(t,"spatial",(t=>Jr(t,(t=>{const n=jR(e,t),o=ns(t,"grid_shape",(e=>qr(new Float32Array(r),e,Xr))),a=ns(t,"chunk_size",(e=>qr(new Float32Array(r),e,Lr))),l=ns(t,"limit",Xr),c=new Float32Array(r);for(let e=0;e<r;++e)c[e]=o[e]*a[e];const d=xo(Float32Array,r+1);for(let e=0;e<r;++e)d[(r+1)*r+e]=s[e];const u=(0,i.bn)({limit:l,chunkToMultiscaleTransform:d},Oh({rank:r,chunkDataSize:a,upperVoxelBound:c}));return u.upperChunkBound=o,{parameters:n,spec:u,limit:l}})))),this.spatialIndices.reverse()}}async function JR(e,t,n){var i=await zR(e.chunkManager,t,n);const r=i.source,s=i.transform,o=i.segmentPropertyMap,a=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:s}];if(void 0!==o){const i=LR(n,o),r=await GR(e.chunkManager,t,i),s=YR(e.chunkManager,t,r);a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:s}})}return{modelTransform:ma(FR()),subsources:a}}function qR(e){Yr(e);const t=new Ds,n=ns(e,"ids",(e=>{const n=(e=ds(e)).length,i=new Uint32Array(2*n);for(let r=0;r<n;++r){if(!t.tryParseString(e[r]))throw new Error(`Invalid uint64 id: ${Bt(e[r])}`);i[2*r]=t.low,i[2*r+1]=t.high}return i})),r=n.length/2;return function(e){const t=e.ids;if(function(e){const t=e.length;if(0===t)return!0;let n=e[0],i=e[1];for(let r=0;r<t;r+=2){const t=e[r],s=e[r+1];if((s-i||t-n)<=0)return!1;n=t,i=s}return!0}(t))return e;const n=t.length/2,r=eE(n,n-1);for(let i=0;i<n;++i)r[i]=i;r.sort(((e,n)=>{const i=t[2*e],r=t[2*e+1],s=t[2*n];return r-t[2*n+1]||i-s}));const s=new Uint32Array(2*n);for(let i=0;i<n;++i){const e=r[i];s[2*i]=t[2*e],s[2*i+1]=t[2*e+1]}return{ids:s,properties:e.properties.map((e=>{const t=e.values,s=new t.constructor(n);for(let i=0;i<n;++i)s[i]=t[r[i]];return(0,i.bn)((0,i.bn)({},e),{values:s})}))}}({ids:n,properties:ns(e,"properties",(e=>Jr(e,(e=>{Yr(e);const t=ns(e,"id",es),n=is(e,"description",es),i=ns(e,"type",(e=>{if("label"!==e&&"description"!==e&&"string"!==e&&"tags"!==e&&"number"!==e)throw new Error(`Invalid property type: ${Bt(e)}`);return e}));if("tags"===i){const s=ns(e,"tags",ds);let o=is(e,"tag_descriptions",ds);if(void 0===o)o=new Array(s.length),o.fill("");else if(o.length!==s.length)throw new Error(`Expected tag_descriptions to have length: ${s.length}`);return{id:t,description:n,type:i,tags:s,tagDescriptions:o,values:ns(e,"values",(e=>{if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected ${r} values, but received: ${e.length}`);return e.map((e=>String.fromCharCode(...e)))}))}}if("number"===i){const s=ns(e,"data_type",(e=>ls(e,sr)));if(s===sr.UINT64)throw new Error("uint64 properties not supported");const o=ns(e,"values",(e=>{if(!Array.isArray(e)||e.length!==r)throw new Error(`Expected ${r} values, but received: ${e.length}`);return cr[s].from(e)}));let a=1/0,l=-1/0;for(let e=o.length-1;e>=0;--e){const t=o[e];t<a&&(a=t),t>l&&(l=t)}return{id:t,description:n,type:i,dataType:s,values:o,bounds:[a,l]}}return{id:t,description:n,type:i,values:ns(e,"values",(e=>{if(ds(e),e.length!==r)throw new Error(`Expected ${r} values, but received: ${e.length}`);return e}))}}))))})}function YR(e,t,n,i){try{const e=ns(n,"@type",es);if("neuroglancer_segment_properties"!==e)throw new Error(`Unsupported segment property map type: ${Bt(e)}`);const t=is(n,"inline",qR);return new tE({inlineProperties:t})}catch(r){throw new Error(`Error parsing segment property map: ${r.message}`)}}cp(oP()(class extends lp{constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}),yR);const ZR=/^([^#]*)(?:#(.*))?$/;function XR(e){var t=e.match(ZR),n=O(t,3);let i=n[1],r=n[2];i.endsWith("/")&&(i=i.substring(0,i.length-1));return{url:i,parameters:os(r||"")}}function KR(e,t){const n=as(t);return n&&(e+=`#${n}`),e}class QR extends cf{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){var t=XR(e.providerUrl);const n=t.url,i=t.parameters;return e.providerProtocol+"://"+KR(n,i)}convertLegacyUrl(e){var t=XR(e.providerUrl);const n=t.url,i=t.parameters;return"mesh"===e.type&&(i.type="mesh"),e.providerProtocol+"://"+KR(n,i)}get(e){var t=XR(e.providerUrl);const n=t.url,i=t.parameters;return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:n,parameters:i},(async()=>{var t=sC(n,e.credentialsManager);const r=t.url,s=t.credentialsProvider;let o;try{o=await GR(e.chunkManager,s,r)}catch(c){if(Yx(c)&&"mesh"===i.type)return await JR(e,s,r);throw c}Yr(o);const a=is(o,"redirect",es);if(void 0!==a)throw new sf(a);const l=is(o,"@type",es);switch(l){case"neuroglancer_skeletons":return await async function(e,t,n){var i=await UR(e.chunkManager,t,n);const r=i.source,s=i.transform,o=i.segmentPropertyMap,a=[{id:"default",default:!0,subsource:{mesh:r},subsourceToModelSubspaceTransform:s}];if(void 0!==o){const i=LR(n,o),r=await GR(e.chunkManager,t,i),s=YR(e.chunkManager,0,r);a.push({id:"properties",default:!0,subsource:{segmentPropertyMap:s}})}return{modelTransform:ma(FR()),subsources:a}}(e,s,r);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await JR(e,s,r);case"neuroglancer_annotations_v1":return await async function(e,t,n,i){const r=new HR(n,i);return{modelTransform:ma(r.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:e.chunkManager.getChunkSource(AR,{credentialsProvider:t,metadata:r,parameters:r.parameters})}}]}}(e,s,r,o);case"neuroglancer_segment_properties":return await async function(e,t,n,i){return{modelTransform:ma(sa),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:YR(e.chunkManager,0,i)}}]}}(e,0,0,o);case"neuroglancer_multiscale_volume":case void 0:return await $R(e,s,r,o);default:throw new Error(`Invalid type: ${Bt(l)}`)}}))}completeUrl(e){return xR(e.credentialsManager,e.providerUrl,e.cancellationToken)}}Gx("precomputed",(()=>new QR));var eN,tN=function(e){if(null==e)throw new TypeError("Cannot destructure undefined")};!function(e){e[e.RAW=0]="RAW",e[e.GZIP=1]="GZIP",e[e.BLOSC=2]="BLOSC"}(eN||(eN={}));let nN=class{};nN.RPC_ID="n5/VolumeChunkSource";class iN extends(cp(oP()(Jb),nN)){}let rN=class extends Yb{constructor(e,t,n,i){let r,s;if(super(e),this.credentialsProvider=t,this.multiscaleMetadata=n,this.scales=i,i.forEach(((e,t)=>{if(void 0!==e){if(void 0===s&&(s=t),void 0!==r&&e.dataType!==r)throw new Error(`Scale s${t} has data type ${sr[e.dataType]} but expected ${sr[r]}.`);r=e.dataType}})),void 0===r)throw new Error("At least one scale must be specified.");const o=n.scales[s],a=i[s];this.dataType=r,this.volumeType=_E.IMAGE,this.baseScaleIndex=s;const l=n.modelSpace,c=l.rank;this.modelSpace=ia({names:l.names,scales:l.scales,units:l.units,boundingBoxes:[{transform:Co(Float64Array,o.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(c),upperBounds:new Float64Array(a.size)}}],coordinateArrays:l.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){tN(this);const t=this.scales,n=this.rank,i=this.multiscaleMetadata.scales;return $t(t.filter((e=>void 0!==e)).map(((t,r)=>{const s=i[r],o=Co(Float32Array,s.downsamplingFactor);return UE({rank:n,chunkToMultiscaleTransform:o,dataType:t.dataType,upperVoxelBound:t.size,volumeType:this.volumeType,chunkDataSizes:[t.chunkSize],volumeSourceOptions:e}).map((e=>({chunkSource:this.chunkManager.getChunkSource(iN,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:s.url,encoding:t.encoding}}),chunkToMultiscaleTransform:o})))})))}};class sN{constructor(e){let t;Yr(e),this.dataType=ns(e,"dataType",(e=>ls(e,sr))),this.size=Float32Array.from(ns(e,"dimensions",(e=>Jr(e,Xr)))),this.chunkSize=ns(e,"blockSize",(e=>qr(new Uint32Array(this.size.length),e,Xr))),is(e,"compression",(e=>{t=ns(e,"type",(e=>ls(e,eN)))})),void 0===t&&(t=ns(e,"compressionType",(e=>ls(e,eN)))),this.encoding=t}}async function oN(e,t,n,r){const s=function(e){var t=qx(e);let n=t.protocol,i=t.host,r=t.path;r.endsWith("/")&&(r=r.substring(0,r.length-1));const s=[];for(;;){s.push(`${n}://${i}${r}/attributes.json`);const e=r.lastIndexOf("/");if(-1===e)break;r=r.substring(0,e)}return s}(n),o=await Qc.all(s.map(((n,i)=>function(e,t,n,i){return e.memoize.getUncounted({type:"n5:attributes.json",url:n,credentialsProvider:Gd(t)},(()=>oC(t,n,{},Hx).then((e=>{try{return Yr(e)}catch(o){throw new Error(`Error reading attributes from ${n}: ${o.message}`)}})).catch((e=>{if(Yx(e))return i?void 0:{};throw e}))))}(e,t,n,r&&i===s.length-1))));if(-1===o.indexOf(void 0))return o.reverse(),(0,i.bn)({},...o)}function aN(e,t){if(-1!==e&&t!==e)throw new Error(`Rank mismatch, received ${t} but expected ${e}`);return t}function lN(e){return Float64Array.from(Jr(e,Lr))}function cN(e){const t=Hr(e);if(0===t.length)throw new Error("Expected non-empty array");let n=-1;return{all:Jr(t,(e=>{const t=lN(e);return n=aN(n,t.length),t})),single:void 0,rank:n}}const dN=["x","y","z","t","c"];function uN(e,t){Yr(t);let n,i,r=-1,s=is(t,"resolution",(e=>{const t=Float64Array.from(Jr(e,Lr));return r=aN(r,t.length),t})),o=is(t,"axes",(e=>{const t=Jr(e,es);return r=aN(r,t.length),t})),a=is(t,"units",(e=>{const t=Jr(e,Uo);return r=aN(r,t.length),t})),l={unit:"m",exponent:-9};is(t,"downsamplingFactors",(e=>{var t=function(e){const t=Hr(e);if(0===t.length)throw new Error("Expected non-empty array");if(Array.isArray(t[0]))return cN(t);const n=lN(e);return{all:void 0,single:n,rank:n.length}}(e);const s=t.single,o=t.all,a=t.rank;r=aN(r,a),void 0!==s&&(n=s),void 0!==o&&(i=o)})),is(t,"pixelResolution",(e=>{l=ns(e,"unit",Uo),is(e,"dimensions",(e=>{s=Float64Array.from(Jr(e,Lr)),r=aN(r,s.length)}))})),is(t,"scales",(e=>{var t=cN(e);const n=t.all,s=t.rank;r=aN(r,s),i=n}));const c=is(t,"dimensions",(e=>{const t=Jr(e,Xr);return r=aN(r,t.length),t}));if(-1===r)throw new Error("Unable to determine rank of dataset");void 0===a&&(a=new Array(r),a.fill(l)),void 0===s&&(s=new Float64Array(r),s.fill(1));for(let h=0;h<r;++h)s[h]=Go(s[h],a[h].exponent);const d=new Array(r);void 0!==o&&is(t,"coordinateArrays",(e=>{Yr(e);for(let t=0;t<r;++t){const n=o[t];if(Object.prototype.hasOwnProperty.call(e,n)){const i=ds(e[n]);d[t]={explicit:!1,labels:i,coordinates:It(i,((e,t)=>t))},a[t]={unit:"",exponent:0},s[t]=1}}})),void 0===o&&(o=function(e){const t=dN.slice(0,e);for(;t.length<e;)t.push(`d${t.length+1}`);return t}(r));const u=ia({rank:r,valid:!0,names:o,scales:s,units:a.map((e=>e.unit)),coordinateArrays:d});if(void 0===c){if(void 0===i)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:u,url:e,attributes:t,scales:i.map(((t,n)=>({url:`${e}/s${n}`,downsamplingFactor:t})))}}return void 0===n&&(n=new Float64Array(r),n.fill(1)),{modelSpace:u,url:e,attributes:t,scales:[{url:e,downsamplingFactor:n}]}}class hN extends cf{get description(){return"N5 data source"}get(e){let t=e.providerUrl;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},(async()=>{var n=sC(t,e.credentialsManager);const i=n.url,r=n.credentialsProvider,s=uN(i,await oN(e.chunkManager,r,i,!1)),o=await function(e,t,n){return Qc.all(n.scales.map((async n=>{const i=await oN(e,t,n.url,!0);if(void 0!==i)return new sN(i)})))}(e.chunkManager,r,s),a=new rN(e.chunkManager,r,s,o);return{modelTransform:ma(a.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:a}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:yo(a.modelSpace.bounds)}}]}}))}completeUrl(e){return xR(e.credentialsManager,e.providerUrl,e.cancellationToken)}}var pN;Gx("n5",(()=>new hN)),function(e){e[e.RAW=0]="RAW",e[e.GZIP=1]="GZIP",e[e.BLOSC=2]="BLOSC"}(pN||(pN={}));class fN{}fN.RPC_ID="zarr/VolumeChunkSource";const gN=new pt;gN.set("|u1",{endianness:dr.LITTLE,dataType:sr.UINT8}),gN.set("|i1",{endianness:dr.LITTLE,dataType:sr.INT8});for(let iV of[["<",dr.LITTLE],[">",dr.BIG]]){var mN=O(iV,2);let e=mN[0],t=mN[1];for(let n of["u","i"])gN.set(`${e}${n}8`,{endianness:t,dataType:sr.UINT64});gN.set(`${e}u2`,{endianness:t,dataType:sr.UINT16}),gN.set(`${e}i2`,{endianness:t,dataType:sr.INT16}),gN.set(`${e}u4`,{endianness:t,dataType:sr.UINT32}),gN.set(`${e}i4`,{endianness:t,dataType:sr.INT32}),gN.set(`${e}f4`,{endianness:t,dataType:sr.FLOAT32})}class vN extends(cp(oP()(Jb),fN)){}function yN(e){return is(e,"dimension_separator",(e=>{if("."!==e&&"/"!==e)throw new Error(`Expected "." or "/", but received: ${Bt(e)}`);return e}))}function bN(e){try{Yr(e),ns(e,"zarr_format",(e=>{if(2!==e)throw new Error(`Expected 2 but received: ${Bt(e)}`)}));const t=ns(e,"shape",(e=>Jr(e,(e=>{if("number"!=typeof e||!mr(e)||e<0)throw new Error(`Expected non-negative integer, but received: ${Bt(e)}`);return e})))),n=ns(e,"chunks",(e=>qr(new Array(t.length),e,(e=>{if("number"!=typeof e||!mr(e)||e<=0)throw new Error(`Expected positive integer, but received: ${Bt(e)}`);return e})))),i=ns(e,"order",(e=>{if("C"!==e&&"F"!==e)throw new Error(`Expected "C" or "F", but received: ${Bt(e)}`);return e})),r=yN(e),s=ns(e,"dtype",(e=>function(e){const t=gN.get(e);if(void 0===t)throw new Error(`Unsupported numpy data type: ${Bt(e)}`);return t}(es(e)))),o=ns(e,"compressor",(e=>{if(null===e)return pN.RAW;Yr(e);const t=ns(e,"id",es);switch(t){case"blosc":return pN.BLOSC;case"gzip":case"zlib":return pN.GZIP;default:throw new Error(`Unsupported compressor: ${Bt(t)}`)}}));return{rank:t.length,shape:t,chunks:n,order:i,dataType:s.dataType,encoding:{compressor:o,endianness:s.endianness},dimensionSeparator:r}}catch(t){throw new Error(`Error parsing zarr metadata: ${t.message}`)}}class SN extends Yb{constructor(e,t,n,i,r,s){super(e),this.credentialsProvider=t,this.url=n,this.separator=i,this.metadata=r,this.attrs=s,this.dataType=r.dataType,this.volumeType=_E.IMAGE;let o=is(s,"_ARRAY_DIMENSIONS",(e=>qr(new Array(r.rank),e,es)));void 0===o&&(o=It(r.shape,((e,t)=>`d${t}`))),this.modelSpace=ia({names:o,scales:Float64Array.from(r.shape,(()=>1)),units:It(r.shape,(()=>"")),boundingBoxes:[ua({lowerBounds:new Float64Array(r.rank),upperBounds:Float64Array.from(r.shape)})]})}get rank(){return this.metadata.rank}getSources(e){const t=this.metadata,n=t.rank,i=t.chunks,r=t.shape;let s,o,a;if("F"===t.order)s=Uint32Array.from(i),o=Float32Array.from(r),a=xo(Float32Array,n+1);else{s=new Uint32Array(n),o=new Float32Array(n),a=new Float32Array((n+1)**2),a[(n+1)**2-1]=1;for(let e=0;e<n;++e)s[e]=i[n-1-e],o[e]=r[n-1-e],a[e+(n-1-e)*(n+1)]=1}return $t([UE({rank:n,chunkToMultiscaleTransform:a,dataType:t.dataType,upperVoxelBound:o,volumeType:this.volumeType,chunkDataSizes:[s],volumeSourceOptions:e}).map((e=>({chunkSource:this.chunkManager.getChunkSource(vN,{credentialsProvider:this.credentialsProvider,spec:e,parameters:{url:this.url,encoding:t.encoding,separator:this.separator}}),chunkToMultiscaleTransform:a})))])}}function wN(e,t,n){return e.memoize.getUncounted({type:"zarr:.zattrs json",url:n,credentialsProvider:Gd(t)},(async()=>{try{const e=await oC(t,n+"/.zattrs",{},Hx);return Yr(e),e}catch(e){if(Yx(e))return{};throw e}}))}function xN(e,t,n){return e.memoize.getUncounted({type:"zarr:.zarray json",url:n,credentialsProvider:Gd(t)},(async()=>bN(await oC(t,n+"/.zarray",{},Hx))))}const CN=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];class kN extends cf{get description(){return"Zarr data source"}get(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/),n=O(t,3);let i=n[1];const r=os(n[2]||"");Yr(r);const s=yN(r);return i.endsWith("/")&&(i=i.substring(0,i.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:i,dimensionSeparator:s},(async()=>{var t=sC(i,e.credentialsManager);const n=t.url,r=t.credentialsProvider;var o=await Qc.all([xN(e.chunkManager,r,n),wN(e.chunkManager,r,n)]),a=O(o,2);const l=a[0],c=a[1];if(void 0!==l.dimensionSeparator&&void 0!==s&&l.dimensionSeparator!==s)throw new Error(`Explicitly specified dimension separator ${Bt(s)} does not match value in .zarray ${Bt(l.dimensionSeparator)}`);const d=new SN(e.chunkManager,r,n,s||l.dimensionSeparator||".",l,c);return{modelTransform:ma(d.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:d}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:yo(d.modelSpace.bounds)}}]}}))}async completeUrl(e){var t=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);let n=O(t,3)[2];return void 0!==n?ef(e.providerUrl.length-n.length,await rf(n,CN)):await xR(e.credentialsManager,e.providerUrl,e.cancellationToken)}}var TN;Gx("zarr",(()=>new kN)),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.ADDITIVE=1]="ADDITIVE"}(TN||(TN={}));const EN=new pt([[TN.DEFAULT,e=>{e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}],[TN.ADDITIVE,e=>{e.blendFunc(e.SRC_ALPHA,e.ONE)}]]);const LN="#uicontrol invlerp normalized\nvoid main() {\n  emitGrayscale(normalized());\n}\n";function IN(e,t){e.addFragmentCode("\n#define VOLUME_RENDERING false\n\nvoid emitRGBA(vec4 rgba) {\n  emit(vec4(rgba.rgb, rgba.a * uOpacity));\n}\nvoid emitRGB(vec3 rgb) {\n  emit(vec4(rgb, uOpacity));\n}\nvoid emitGrayscale(float value) {\n  emit(vec4(value, value, value, uOpacity));\n}\nvoid emitTransparent() {\n  emit(vec4(0.0, 0.0, 0.0, 0.0));\n}\n"),e.addFragmentCode(Hh),dh(t,e),e.setFragmentMainFunction(tu(t.parseResult.code))}class DN extends QE{constructor(e,t){var n,r,s;const o=t.opacity,a=t.blendMode,l=t.shaderControlState;super(e,(0,i.bn)((0,i.bn)({},t),{fallbackShaderParameters:new En(mh(lh(LN,{imageData:{dataType:e.dataType,channelRank:null!==(s=null===(r=null===(n=t.channelCoordinateSpace)||void 0===n?void 0:n.value)||void 0===r?void 0:r.rank)&&void 0!==s?s:0}}))),encodeShaderParameters:e=>e.key,shaderParameters:l.builderState,dataHistogramSpecifications:l.histogramSpecifications})),this.shaderControlState=l,this.opacity=o,this.blendMode=a,this.registerDisposer(o.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(a.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(l.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(0!==t.parseResult.errors.length)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),IN(e,t)}initializeShader(e,t,n){const i=this.gl;i.uniform1f(t.uniform("uOpacity"),this.opacity.value),bh(i,t,this.shaderControlState,n.parseResult.controls)}setGLBlendMode(e,t){const n=this.blendMode.value;n===TN.ADDITIVE||t>0?(e.enable(e.BLEND),EN.get(n)(e)):e.disable(WebGL2RenderingContext.BLEND)}}const MN=jn();function PN(e,t,n,i,r,s){if(0===i.length)return;const o=e.viewMatrix,a=e.projectionMat,l=Ri(e.displayDimensionRenderInfo.voxelPhysicalScales),c=(Wi(a)/64)**3,d=Hn(Bi(MN,o)),u=e=>{const t=i[e];return Math.abs(t.chunkLayout.detTransform*d)};let h=i.length-1,p=u(h);for(let y=h-1;y>=0;--y){const e=u(y);if(!(Math.abs(e-c)<Math.abs(p-c)))break;p=e,h=y}const f=Math.pow(p*l/d,1/3),g=Math.pow(p,1/3)*e.width/(2*a[0]);let m=!0;const v=i[h];Gh(e,t,v,((e,t)=>{m&&(r(v,h,f,g,t),m=!1),s(v,h,e)}))}const AN=qn(),RN=new Float32Array(24);class NN extends ym{constructor(e){super(),this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.renderScaleTarget=e.renderScaleTarget,this.renderScaleHistogram=e.renderScaleHistogram,this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility));const t=this.registerDisposer(Rn((e=>e.rank),[this.channelCoordinateSpace]));this.shaderGetter=Qd(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:e=>{let{emitter:t,chunkFormat:n}=e;return`${Gd(t)}:${n.shaderKey}`},shaderError:e.shaderError,extraParameters:t,defineShader:(e,t,n,i)=>{let{emitter:r,chunkFormat:s}=t;if(0!==n.parseResult.errors.length)throw new Error("Invalid UI control specification");Tb(e),e.addFragmentCode("\n#define VOLUME_RENDERING true\n"),r(e),e.addUniform("highp float","uNearLimitFraction"),e.addUniform("highp float","uFarLimitFraction"),e.addUniform("highp int","uMaxSteps"),e.addUniform("highp vec3","uTranslation"),e.addUniform("highp mat4","uModelViewProjectionMatrix"),e.addUniform("highp mat4","uInvModelViewProjectionMatrix"),e.addUniform("highp vec3","uChunkDataSize"),e.addUniform("highp vec3","uLowerClipBound"),e.addUniform("highp vec3","uUpperClipBound"),e.addUniform("highp float","uBrightnessFactor"),e.addVarying("highp vec4","vNormalizedPosition"),e.addVertexCode("\nvec3 getBoxFaceVertexPosition(int vertexIndex) {\n  const vec3 vertexPositions[] = vec3[](\n  // Front face\n  vec3(0.0, 0.0,  1.0), // 0\n  vec3(1.0, 0.0,  1.0), // 1\n  vec3(1.0,  1.0,  1.0), // 2\n  vec3(0.0,  1.0,  1.0), // 3\n\n  // Back face\n  vec3(0.0, 0.0, 0.0), // 4\n  vec3(0.0,  1.0, 0.0), // 5\n  vec3(1.0,  1.0, 0.0), // 6\n  vec3(1.0, 0.0, 0.0), // 7\n\n  // Top face\n  vec3(0.0,  1.0, 0.0), // 8\n  vec3(0.0,  1.0,  1.0), // 9\n  vec3(1.0,  1.0,  1.0), // 10\n  vec3(1.0,  1.0, 0.0), // 11\n\n  // Bottom face\n  vec3(0.0, 0.0, 0.0), // 12\n  vec3( 1.0, 0.0, 0.0), // 13\n  vec3( 1.0, 0.0,  1.0), // 14\n  vec3(0.0, 0.0,  1.0), // 15\n\n  // Right face\n  vec3( 1.0, 0.0, 0.0), // 16\n  vec3( 1.0,  1.0, 0.0), // 17\n  vec3( 1.0,  1.0,  1.0), // 18\n  vec3( 1.0, 0.0,  1.0), // 19\n\n  // Left face\n  vec3(0.0, 0.0, 0.0), // 20\n  vec3(0.0, 0.0,  1.0), // 21\n  vec3(0.0,  1.0,  1.0), // 22\n  vec3(0.0,  1.0, 0.0) // 23\n  );\n  const int indices[] = int[](\n    0,  1,  2,      0,  2,  3,    // front\n    4,  5,  6,      4,  6,  7,    // back\n    8,  9,  10,     8,  10, 11,   // top\n    12, 13, 14,     12, 14, 15,   // bottom\n    16, 17, 18,     16, 18, 19,   // right\n    20, 21, 22,     20, 22, 23   // left\n  );\n  return vertexPositions[indices[vertexIndex]];\n}\n"),e.setVertexMain("\nvec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);\nvec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));\nvNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);\ngl_Position.z = 0.0;\n"),e.addFragmentCode("\nvec3 curChunkPosition;\nvec4 outputColor;\nvoid userMain();\n"),$b(e,s,i,"curChunkPosition"),e.addFragmentCode("\nvoid emitRGBA(vec4 rgba) {\n  float alpha = rgba.a * uBrightnessFactor;\n  outputColor += vec4(rgba.rgb * alpha, alpha);\n}\nvoid emitRGB(vec3 rgb) {\n  emitRGBA(vec4(rgb, 1.0));\n}\nvoid emitGrayscale(float value) {\n  emitRGB(vec3(value, value, value));\n}\nvoid emitTransparent() {\n  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));\n}\n"),e.setFragmentMainFunction("\nvoid main() {\n  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;\n  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);\n  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);\n  vec3 nearPoint = nearPointH.xyz / nearPointH.w;\n  vec3 farPoint = farPointH.xyz / farPointH.w;\n  vec3 rayVector = farPoint - nearPoint;\n  vec3 boxStart = max(uLowerClipBound, uTranslation);\n  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);\n  float intersectStart = uNearLimitFraction;\n  float intersectEnd = uFarLimitFraction;\n  for (int i = 0; i < 3; ++i) {\n    float startPt = nearPoint[i];\n    float endPt = farPoint[i];\n    float boxLower = boxStart[i];\n    float boxUpper = boxEnd[i];\n    float r = rayVector[i];\n    float startFraction;\n    float endFraction;\n    if (startPt >= boxLower && startPt <= boxUpper) {\n      startFraction = 0.0;\n    } else {\n      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);\n    }\n    if (endPt >= boxLower && endPt <= boxUpper) {\n      endFraction = 1.0;\n    } else {\n      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);\n    }\n    intersectStart = max(intersectStart, startFraction);\n    intersectEnd = min(intersectEnd, endFraction);\n  }\n  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);\n  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));\n  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);\n  outputColor = vec4(0, 0, 0, 0);\n  for (int step = startStep; step < endStep; ++step) {\n    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);\n    curChunkPosition = position - uTranslation;\n    userMain();\n  }\n  emit(outputColor, 0u);\n}\n"),e.addFragmentCode(Hh),dh(n,e),e.addFragmentCode("\n#define main userMain\n"+tu(n.parseResult.code)+"\n#undef main\n")}}),this.vertexIdHelper=this.registerDisposer(Eb.get(this.gl)),this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));const n=this.multiscaleSource.chunkManager,i=this.registerDisposer(new dp(this.layerChunkProgressInfo)),r=n.rpc;i.RPC_TYPE_ID="volume_rendering/VolumeRenderingRenderLayer",i.initializeCounterpart(r,{chunkManager:n.rpcId,localPosition:this.registerDisposer(Cd.makeFromExisting(r,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Cd.makeFromExisting(r,this.renderScaleTarget)).rpcId}),this.backend=i}get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(On(((t,n,i)=>{const r=Vp(i,n,(e=>this.multiscaleSource.getSources(e)),e.messages,this);for(const e of r)for(const n of e)t.registerDisposer(n.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke("volume_rendering/VolumeRenderingRenderLayer/update",{layer:this.backend.rpcId,view:e.view.rpcId,sources:Ip(r)}),this.redrawNeeded.dispatch(),r}),this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;const n=t.state.sources.value;if(0===n.length)return;let i,r,s=0,o=0,a=null;const l=ti(),c=this.gl;this.vertexIdHelper.enable();const d=this.renderScaleHistogram;d.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const u=()=>{null!==a&&(null!==i&&i.endDrawing(c,a),(0!==m||0!==v)&&d.add(s,o,m,v))};let h=!0;const p=e.projectionParameters;let f,g,m=0,v=0;const y=this.multiscaleSource.rank,b=ti();c.enable(WebGL2RenderingContext.CULL_FACE),c.cullFace(WebGL2RenderingContext.FRONT),PN(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,n[0],((t,n,d,h)=>{s=d,o=h;const m=Wh(p,t.chunkLayout),v=t.source,y=t.fixedPositionWithinChunk,b=t.chunkDisplayDimensionIndices;for(const e of b)y[e]=0;const S=v.chunkFormat;if(S!==i&&(i=S,u(),r=this.shaderGetter({emitter:e.emitter,chunkFormat:S}),a=r.shader,null!==a&&(a.bind(),null!==S&&(bh(c,a,this.shaderControlState,r.parameters.parseResult.controls),S.beginDrawing(c,a),S.beginSource(c,a)))),g=void 0,null===a)return;f=v.chunks,l.fill(1);const w=Qn(AN,p.viewProjectionMat,m.transform);c.uniformMatrix4fv(a.uniform("uModelViewProjectionMatrix"),!1,w);const x=RN;_i(x,w),Kn(w,w),c.uniformMatrix4fv(a.uniform("uInvModelViewProjectionMatrix"),!1,w);var C=function(e,t,n){let i=0,r=0;for(let l=0;l<3;++l){const s=e[16+l],o=s*t[l],a=s*n[l];i+=Math.min(o,a),r+=Math.max(o,a)}const s=-e[19],o=Math.max(s,i),a=e[23];return{near:s,far:a,adjustedNear:o,adjustedFar:Math.min(a,r)}}(x,t.lowerClipDisplayBound,t.upperClipDisplayBound);const k=C.near,T=C.far,E=C.adjustedNear,L=C.adjustedFar,I=(L-E)/63/(T-k);c.uniform1f(a.uniform("uBrightnessFactor"),I);const D=(E-k)/(T-k),M=(L-k)/(T-k);c.uniform1f(a.uniform("uNearLimitFraction"),D),c.uniform1f(a.uniform("uFarLimitFraction"),M),c.uniform1i(a.uniform("uMaxSteps"),64),c.uniform3fv(a.uniform("uLowerClipBound"),t.lowerClipDisplayBound),c.uniform3fv(a.uniform("uUpperClipBound"),t.upperClipDisplayBound)}),(e=>{if(null===a)return;const t=e.curPositionInChunks.join(),n=f.get(t);if(void 0!==n&&n.state===el.GPU_MEMORY){const t=e.chunkLayout.size;let r=n.chunkDataSize;const s=e.chunkDisplayDimensionIndices,o=e.fixedPositionWithinChunk,d=e.chunkTransform.channelToChunkDimensionIndices;if(tN(e),r!==g){g=r;for(let e=0;e<3;++e){const t=s[e];l[e]=-1===t||t>=y?1:g[t]}c.uniform3fv(a.uniform("uChunkDataSize"),l)}const u=n.chunkGridPosition;for(let e=0;e<3;++e){const n=s[e];b[e]=-1===n||n>=y?0:t[e]*u[n]}i?.bindChunk(c,a,n,o,s,d,h),h=!1,c.uniform3fv(a.uniform("uTranslation"),b),function(e,t,n){e.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,36*t,n)}(c,1,1),++m}else++v})),c.disable(WebGL2RenderingContext.CULL_FACE),u(),this.vertexIdHelper.disable()}isReady(e,t){const n=t.state.sources.value;if(0===n.length)return!0;let i=!1;return PN(e.projectionParameters,this.localPosition.value,this.renderScaleTarget.value,n[0],(()=>{}),(e=>{const t=e.source.chunks.get(e.curPositionInChunks.join());(void 0===t||t.state!==el.GPU_MEMORY)&&(i=!0)})),i}}const VN=yv.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class ON{constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");const t=this.element,n=this.nameContainer,i=this.nameElement,r=this.lowerElement,s=this.upperElement;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),n.classList.add("neuroglancer-channel-dimensions-widget-name-container"),i.classList.add("neuroglancer-channel-dimensions-widget-name"),n.appendChild(i),r.classList.add("neuroglancer-channel-dimensions-widget-lower"),s.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(n),t.appendChild(r),t.appendChild(s),n.draggable=!0,i.disabled=!0,i.spellcheck=!1,i.autocomplete="off",i.required=!0,i.placeholder=" ",n.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",n.addEventListener("dblclick",(()=>{i.disabled=!1,i.focus(),i.select()})),i.addEventListener("focus",(()=>{i.select()}))}}class BN extends Sn{constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=this.combiner.combined;const t=this.element;t.classList.add("neuroglancer-channel-dimensions-widget");const n=this.registerCancellable(al((()=>this.updateView())));this.registerDisposer(e.combined.changed.add(n));this.registerDisposer(new tS(t,VN)).allShortcutsAreGlobal=!0,this.registerDisposer(Cv(t,"cancel",(e=>{this.forceUpdateView();const t=e.target;t instanceof HTMLElement&&t.blur()}))),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;const n=this.coordinateSpace;n.value=Ba(n.value,e,t)}makeNewDimensionWidget(e){const t=new ON(e);return t.nameContainer.addEventListener("dragstart",(e=>{this.dragSource=t,e.stopPropagation(),e.dataTransfer.setData("neuroglancer-dimension","")})),t.nameContainer.addEventListener("dragenter",(e=>{const n=this.dragSource;if(void 0===n||n===t)return;const i=this.dimensionWidgets,r=i.indexOf(n),s=i.indexOf(t);-1===r||-1===s||(e.preventDefault(),this.reorderDimensionTo(s,r))})),t.nameContainer.addEventListener("dragend",(e=>{this.dragSource===t&&(this.dragSource=void 0)})),t.nameElement.addEventListener("blur",(e=>{t.nameElement.disabled=!0;const n=e.relatedTarget;this.dimensionWidgets.some((e=>e.nameElement===n))||this.updateNames()||this.forceUpdateView()})),t.nameElement.addEventListener("input",(()=>{Vv(t.nameElement),this.updateNameValidity()})),Cv(t.nameElement,"commit",(()=>{this.updateNames()})),Cv(t.nameElement,"tab-forward",(e=>this.selectAdjacentField(e,t,1))),Cv(t.nameElement,"tab-backward",(e=>this.selectAdjacentField(e,t,-1))),t}selectAdjacentField(e,t,n){e.stopPropagation();const i=this.dimensionWidgets,r=i.indexOf(t);if(-1===r)return;const s=r+n;if(s<0||s>=i.length)return;const o=i[s];o.nameElement.disabled=!1,o.nameElement.focus(),e.preventDefault()}updateNames(){const e=this.dimensionWidgets,t=this.coordinateSpace,n=t.value,r=e.map((e=>e.nameElement.value));if(this.combiner.getRenameValidity(r).includes(!1))return!1;const s=n.names;if(Ut(s,r))return!1;const o=n.timestamps.map(((e,t)=>s[t]===r[t]?e:Date.now())),a=(0,i.bn)((0,i.bn)({},n),{names:r,timestamps:o});return t.value=a,!0}updateNameValidity(){const e=this.dimensionWidgets,t=e.map((e=>e.nameElement.value)),n=t.length,i=this.combiner.getRenameValidity(t);for(let r=0;r<n;++r)e[r].nameElement.dataset.isValid=!1===i[r]?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){const e=this.coordinateSpace.value;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;const t=this.element,n=this.dimensionWidgets,i=this.dimensionWidgets=e.ids.map((e=>n.find((t=>t.id===e))||this.makeNewDimensionWidget(e)));Ov(t,function*(){const t=e.names,n=e.rank;var r=e.bounds;const s=r.lowerBounds,o=r.upperBounds;for(let e=0;e<n;++e){const n=i[e];n.nameElement.value=t[e],delete n.nameElement.dataset.isValid,Vv(n.nameElement),n.lowerElement.textContent=s[e].toString(),n.upperElement.textContent=o[e].toString(),yield n.element}}.call(this))}}const _N="opacity",FN="blend",zN="shader",UN="shaderControls",GN="crossSectionRenderScale",WN="channelDimensions",$N="volumeRendering",jN=uI(hT);class HN extends jN{constructor(e){super(e),this.opacity=nL(.5),this.blendMode=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:TN.DEFAULT;return new Og(TN,e)}(),this.fragmentMain=function(){return Kd(arguments.length>0&&void 0!==arguments[0]?arguments[0]:LN)}(),this.shaderError=Xd(),this.dataType=new En(void 0),this.sliceViewRenderScaleHistogram=new xp,this.sliceViewRenderScaleTarget=wp(1),this.volumeRenderingRenderScaleHistogram=new xp,this.volumeRenderingRenderScaleTarget=wp(1),this.channelCoordinateSpace=new ca,this.channelCoordinateSpaceCombiner=new Pa(this.channelCoordinateSpace,ka),this.channelSpace=this.registerDisposer(Pn((e=>_d((()=>function(e){const t=e.rank;var n=e.bounds;const i=n.lowerBounds,r=n.upperBounds;if(i.some((e=>0!==e)))throw new Error("Lower bounds of channel coordinate space must all be 0");if(r.some((e=>!mr(e)||e<=0||e>=2**32)))throw new Error("Upper bounds of channel coordinate space must all be positive integers");const s=new Uint32Array(r),o=jo(s),a=new Uint32Array(o*t);for(let l=0;l<o;++l){let e=l;for(let n=0;n<t;++n){const i=e%s[n];e=(e-i)/s[n],a[l*t+n]=i}}return{channelCoordinateSpace:e,shape:s,numChannels:o,coordinates:a}}(e)))),this.channelCoordinateSpace)),this.volumeRendering=new Vd(!1,!1),this.shaderControlState=this.registerDisposer(new vh(this.fragmentMain,this.registerDisposer(Rn(((e,t)=>void 0===e?null:{imageData:{dataType:e,channelRank:t.rank}}),[this.dataType,this.channelCoordinateSpace],((e,t)=>Bt(e)===Bt(t)))),this.channelCoordinateSpaceCombiner)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=xa,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new YN(this)}),this.tabs.default="rendering"}markLoading(){const e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){const t=super.addCoordinateSpace(e),n=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}activateDataSubsources(e){let t;for(const n of e){if(this.addStaticAnnotations(n))continue;const e=n.subsourceEntry.subsource.volume;e instanceof Yb?t&&e.dataType!==t?n.deactivate(`Data type must be ${sr[e.dataType].toLowerCase()}`):(t=e.dataType,n.activate((t=>{n.addRenderLayer(new DN(e,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));const i=t.registerDisposer(new NN({multiscaleSource:e,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.volumeRenderingRenderScaleTarget,renderScaleHistogram:this.volumeRenderingRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));t.registerDisposer(n.messages.addChild(i.messages)),t.registerDisposer(On(((e,t)=>{t&&e.registerDisposer(this.addRenderLayer(i.addRef()))}),this.volumeRendering)),this.shaderError.changed.dispatch()}))):n.deactivate("Not compatible with image layer")}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[_N]),is(e,FN,(e=>this.blendMode.restoreState(e))),this.fragmentMain.restoreState(e[zN]),this.shaderControlState.restoreState(e[UN]),this.sliceViewRenderScaleTarget.restoreState(e[GN]),this.channelCoordinateSpace.restoreState(e[WN]),this.volumeRendering.restoreState(e[$N])}toJSON(){const e=super.toJSON();return e[_N]=this.opacity.toJSON(),e[FN]=this.blendMode.toJSON(),e[zN]=this.fragmentMain.toJSON(),e[UN]=this.shaderControlState.toJSON(),e[GN]=this.sliceViewRenderScaleTarget.toJSON(),e[WN]=this.channelCoordinateSpace.toJSON(),e[$N]=this.volumeRendering.toJSON(),e}displayImageSelectionState(e,t){const n=e.value;if(null==n)return!1;const i=this.channelSpace.value;if(void 0!==i.error)return!1;const r=i.numChannels,s=i.coordinates;var o=i.channelCoordinateSpace;const a=o.names,l=o.rank,c=document.createElement("div");c.classList.add("neuroglancer-selection-details-value-grid");let d="[copy] 0fr ";0!==l&&(d+=`repeat(${l}, [dim] 0fr [coord] 0fr) `),d+="[value] 1fr",c.style.gridTemplateColumns=d;for(let u=0;u<r;++u){const e=0===l?n:n[u],t=null==e?"":e.toString(),i=dy({title:"Copy value",onClick:()=>{ay(t)}});c.appendChild(i);for(let n=0;n<l;++n){const e=document.createElement("div");e.classList.add("neuroglancer-selection-details-value-grid-dim"),e.textContent=a[n],c.appendChild(e);const t=document.createElement("div");t.classList.add("neuroglancer-selection-details-value-grid-coord"),t.textContent=s[u*l+n].toString(),c.appendChild(t)}const r=document.createElement("div");r.classList.add("neuroglancer-selection-details-value-grid-value"),r.textContent=t,c.appendChild(r)}return t.appendChild(c),!0}displaySelectionState(e,t,n){let i=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,n)&&(i=!0),i}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode("\n#define uOpacity 1.0\n"),IN(e,t)},initializeShader:e=>{const t=e.shader;bh(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}}function JN(e){return new tD({shaderError:e.shaderError,fragmentMain:e.fragmentMain,shaderControlState:e.shaderControlState})}HN.type="image",HN.typeAbbreviation="img";const qN=[(0,i.bn)({label:"Resolution (slice)",toolJson:GN},AD((e=>({histogram:e.sliceViewRenderScaleHistogram,target:e.sliceViewRenderScaleTarget})))),(0,i.bn)({label:"Blending",toolJson:FN},ID((e=>e.blendMode))),(0,i.bn)({label:"Volume rendering (experimental)",toolJson:$N},rD((e=>e.volumeRendering))),(0,i.bn)({label:"Resolution (3d)",toolJson:"volumeRenderScale",isValid:e=>e.volumeRendering},AD((e=>({histogram:e.volumeRenderingRenderScaleHistogram,target:e.volumeRenderingRenderScaleTarget})))),(0,i.bn)({label:"Opacity",toolJson:_N},cD((e=>({value:e.opacity}))))];for(const iV of qN)XI(HN,iV);class YN extends TS{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(JN(this.layer));const t=this.element;t.classList.add("neuroglancer-image-dropdown");for(const r of qN)t.appendChild(ZI(this,e,this.visibility,r));let n=document.createElement("div");n.style.flex="1";let i=document.createElement("div");i.className="neuroglancer-image-dropdown-top-row",i.appendChild(document.createTextNode("Shader")),i.appendChild(n),i.appendChild(QI({title:"Show larger editor view",onClick:()=>{new ZN(this.layer)}})),i.appendChild(HI({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/neuroglancer/sliceview/image_layer_rendering.md"})),t.appendChild(i),t.appendChild(this.registerDisposer(new BN(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new hD(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}class ZN extends mk{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(JN(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}FT(HN),UT(_E.IMAGE,HN),zT((e=>{const t=e.volume;if(void 0!==t&&t.volumeType===_E.UNKNOWN)return{layerConstructor:HN,priority:-100}})),vD(HN,(e=>({shaderControlState:e.shaderControlState,legendShaderOptions:e.getLegendShaderOptions()})));const XN=Object.freeze(Object.defineProperty({__proto__:null,default:class{version(){return"0.0.1"}},setupDefaultViewer:function(e){if(e.brainMapsClientId){const t=e.brainMapsClientId;yw.register(kA,(()=>new lR(t)))}let t=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.getElementById("neuroglancer-container");try{let n=new ml(t);return new rT(n,e)}catch(n){throw Bp.showMessage(`Error: ${n.message}`),n}}({bundleRoot:e.bundleRoot},e.target);return Av(t.inputEventBindings),function(e){e.registerEventListener(document,"copy",(t=>{if(Bv(t.target))return;const n=document.getSelection();if(null!==n&&"Range"===n.type)return;const i=Vg(e.state).value,r=t.clipboardData;null!==r&&r.setData("text/plain",Bt(i,void 0,"  ")),t.preventDefault()}))}(t),OM(t),function(){bn(arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,"contextmenu",(e=>{e.preventDefault()}))}(e.target),t}},Symbol.toStringTag,{value:"Module"})),KN=(0,i.bz)(XN),QN=(0,i.bz)(Ms),eV=(0,i.bz)(fs),tV=(0,i.bz)(Zk);!function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.parseUrlHash=function(e){var t=null,n=e.replace(/^[^#]+/,"");if((""===n||"#"===n||"#!"===n)&&(n="#!{}"),n.startsWith("#!+"))n=n.slice(3),n=decodeURIComponent(n),t=(0,h.urlSafeParse)(n);else{if(!n.startsWith("#!"))throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');n=n.slice(2),n=decodeURIComponent(n),t=(0,h.urlSafeParse)(n)}return t},e.getNeuroglancerViewerState=function(e){var t=e?E[e]:T;return t?t.state.toJSON():{}},e.getNeuroglancerColor=function(e,t){try{var n=u.Uint64.parseString(e),i=t?E[t]:T;if(i){var r,s=C(i.layerManager.managedLayers);try{for(s.s();!(r=s.n()).done;){var o=r.value;if(o.layer instanceof l.SegmentationUserLayer){var d=o.layer.displayState,h=(0,a.getObjectColor)(d,n);if(d.segmentSelectionState.isSelected(n))for(var p=0;p<3;p+=1)h[p]=(h[p]-.5)/.5;return(0,c.serializeColor)(h)}}}catch(f){s.e(f)}finally{s.f()}}}catch{}return""},e.closeSelectionTab=function(e){var t=e?E[e]:T;t&&t.closeSelectionTab&&t.closeSelectionTab()},e.getLayerManager=L,e.getManagedLayer=I,e.getAnnotationLayer=D,e.getAnnotationSource=function(e,t){var n=D(e,t);if(n&&n.dataSources&&n.dataSources[0].loadState_){var i=n.dataSources[0].loadState_.dataSource;if(i)return i.subsources[0].subsource.annotation}},e.addLayerSignalRemover=M,e.unsubscribeLayersChangedSignals=P,e.configureLayersChangedSignals=function(e,t){var n=L(e);if(n){var i=t.layerName;if(P(n,i),t.process){s=n.layersChanged.add((function(){var e=I(void 0,i);e&&t.process(e)})),M(void 0,i,s);var r=I(void 0,i);return r&&t.process(r),function(){t.cancel&&t.cancel(),P(n,i)}}}var s;return t.cancel},e.configureAnnotationLayer=A,e.configureAnnotationLayerChanged=function(e,t,n){if(!e.layerChanged.signalReady){var i=e.layerChanged.add((function(){A(e.layer,t,n)}));e.layerChanged.signalReady=!0,n(i),n((function(){e.layerChanged.signalReady=!1})),A(e.layer,t,n)}},e.getAnnotationSelectionHost=function(e){var t=e?E[e]:T;return t?t.selectionDetailsState?"viewer":"layer":null},e.getSelectedAnnotationId=function(e,t){var n=e?E[e]:T;if(n)if(n.selectionDetailsState){if(n.selectionDetailsState.value){var i=n.selectionDetailsState.value.layers;if(i){var r=i.find((function(e){return e.layer.managedLayer.name===t}));if(r&&r.state)return r.state.annotationId}}}else{var s=D(void 0,t);if(s&&s.selectedAnnotation&&s.selectedAnnotation.value)return s.selectedAnnotation.value.id}return null},e.default=void 0;var n=f(r),s=f(i.bA),o=AM,a=RM,l=NM,c=VM,d=KN,u=QN,h=eV,p=tV;function f(e){return e&&e.__esModule?e:{default:e}}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){x(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function v(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function y(e,t){return(y=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e){var n=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch{return!1}}();return function(){var i,r=w(e);if(n){var s=w(this).constructor;i=Reflect.construct(r,arguments,s)}else i=r.apply(this,arguments);return function(e,n){return!n||"object"!==t(n)&&"function"!=typeof n?S(e):n}(this,i)}}function S(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function w(e){return(w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function C(e,t){var n;if(typeof Symbol>"u"||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return k(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return k(e,t)}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{!o&&null!=n.return&&n.return()}finally{if(a)throw s}}}}function k(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var T,E={};function L(e){var t=e?E[e]:T;if(t)return t.layerManager}function I(e,t){var n=L(e);if(n)return n.managedLayers.filter((function(e){return e.name===t}))[0]}function D(e,t){var n=I(e,t);if(n&&n.layer instanceof o.AnnotationUserLayer)return n.layer}function M(e,t,n){var i=L(e);i&&t&&n&&(i.customSignalHandlerRemovers||(i.customSignalHandlerRemovers={}),i.customSignalHandlerRemovers[t]||(i.customSignalHandlerRemovers[t]=[]),i.customSignalHandlerRemovers[t].push(n))}function P(e,t){e&&e.customSignalHandlerRemovers&&e.customSignalHandlerRemovers[t]&&(e.customSignalHandlerRemovers[t].forEach((function(e){e()})),delete e.customSignalHandlerRemovers[t])}function A(e,t,n){e&&(e.expectingExternalTable=!0,e.selectedAnnotation&&!e.selectedAnnotation.changed.signalReady&&t.onAnnotationSelectionChanged&&(n(e.selectedAnnotation.changed.add((function(){t.onAnnotationSelectionChanged(e.selectedAnnotation.value)}))),n((function(){e.selectedAnnotation.changed.signalReady=!1})),e.selectedAnnotation.changed.signalReady=!0),function(e,t,n){var i=function(){var i=function(e){var t=function(e){if(e.dataSources&&e.dataSources.length>0&&e.dataSources[0].loadState_&&e.dataSources[0].loadState_.dataSource)return e.dataSources[0].loadState_.dataSource}(e);if(t)return t.subsources[0].subsource.annotation}(e);i&&function(e,t,n){e&&!e.signalReady&&(t.onAnnotationAdded&&n(e.childAdded.add((function(e){t.onAnnotationAdded(e)}))),t.onAnnotationDeleted&&n(e.childDeleted.add((function(e){t.onAnnotationDeleted(e)}))),t.onAnnotationUpdated&&n(e.childUpdated.add((function(e){t.onAnnotationUpdated(e)}))),t.onAnnotationChanged&&e.referencesChanged&&n(e.referencesChanged.add(t.onAnnotationChanged)),e.signalReady=!0,n((function(){e.signalReady=!1})))}(i,t,n)},r=e.dataSourcesChanged;r&&!r.signalReady&&(n(r.add(i)),r.signalReady=!0,n((function(){r.signalReady=!1})),i())}(e,t,n))}var R=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&y(e,t)}(i,e);var t=b(i);function i(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),x(S(r=t.call(this,e)),"updateEventBindings",(function(e){var t=r.viewer.inputEventBindings,n=function t(n){var i=function(e,t,n){var i=e.get(t);i&&(e.delete(t),n&&e.set(n,i))},r=n.bindings;e.forEach((function(e){var t=Array.isArray(e)?e[0]:e,n="at:".concat(t),s=e[1]?"at:".concat(e[1]):void 0;i(r,n,s);var o="bubble:".concat(t),a=e[1]?"bubble:".concat(e[1]):void 0;i(r,o,a)})),n.parents.forEach((function(e){t(e)}))};n(t.global),n(t.perspectiveView),n(t.sliceView)})),x(S(r),"selectionDetailsStateChanged",(function(){if(r.viewer){var e=r.props.onSelectionDetailsStateChanged;e&&e()}})),x(S(r),"layersChanged",(function(){if(r.handlerRemovers&&r.handlerRemovers.forEach((function(e){return e()})),r.viewer){var e=r.props,t=e.onSelectedChanged,n=e.onVisibleChanged;if(t||n){r.handlerRemovers=[];var i,s=C(r.viewer.layerManager.managedLayers);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(o.layer instanceof l.SegmentationUserLayer){var a=o.layer.displayState.segmentSelectionState,c=o.layer.displayState.segmentationGroupState.value.visibleSegments;if(a&&t){var d=r.selectedChanged.bind(void 0,o),u=a.changed.add(d);r.handlerRemovers.push(u),o.registerDisposer(u)}if(c&&n){var h=r.visibleChanged.bind(void 0,o),p=c.changed.add(h);r.handlerRemovers.push(p),o.registerDisposer(p)}}}}catch(f){s.e(f)}finally{s.f()}}}})),x(S(r),"selectedChanged",(function(e){if(r.viewer){var t=r.props.onSelectedChanged;if(t){var n=e.layer.displayState.segmentSelectionState;if(n)t(n.hasSelectedSegment?n.selectedSegment:null,e)}}})),x(S(r),"visibleChanged",(function(e){if(r.viewer){var t=r.props.onVisibleChanged;if(t){var n=e.layer.displayState.segmentationGroupState.value.visibleSegments;n&&t(n,e)}}})),r.ngContainer=n.default.createRef(),r.viewer=null,r}return function(e,t,n){t&&v(e.prototype,t),n&&v(e,n)}(i,[{key:"componentDidMount",value:function(){var e=this,t=this.props,n=t.perspectiveZoom,i=t.viewerState,r=t.brainMapsClientId,s=t.eventBindingsToUpdate,o=t.onViewerStateChanged,a=t.callbacks,l=t.ngServer,c=t.key,u=t.bundleRoot;if(this.viewer=(0,d.setupDefaultViewer)({brainMapsClientId:r,target:this.ngContainer.current,bundleRoot:u||"/"}),this.setCallbacks(a),s&&this.updateEventBindings(s),this.viewer.expectingExternalUI=!0,l&&(this.viewer.makeUrlFromState=function(e){var t=m({},e);return e.layers&&(t.layers=e.layers.filter((function(e){if(e.source){var t=e.source.url||e.source;if("string"==typeof t)return!t.startsWith("clio://")}return!0}))),"".concat(l,"/#!").concat((0,p.encodeFragment)(JSON.stringify(t)))}),this.viewer.selectionDetailsState&&this.viewer.selectionDetailsState.changed.add(this.selectionDetailsStateChanged),this.viewer.layerManager.layersChanged.add(this.layersChanged),i){var h=i;null===h.projectionScale&&delete h.projectionScale,null===h.crossSectionScale&&delete h.crossSectionScale,null===h.projectionOrientation&&delete h.projectionOrientation,null===h.crossSectionOrientation&&delete h.crossSectionOrientation,this.viewer.state.restoreState(h)}else this.viewer.state.restoreState({layers:{grayscale:{type:"image",source:"dvid://https://flyem.dvid.io/ab6e610d4fe140aba0e030645a1d7229/grayscalejpeg"},segmentation:{type:"segmentation",source:"dvid://https://flyem.dvid.io/d925633ed0974da78e2bb5cf38d01f4d/segmentation"}},perspectiveZoom:n,navigation:{zoomFactor:8}});this.viewer.state.changed.add((function(){if(o)try{e.viewer.state.viewer.position&&o(e.viewer.state.toJSON())}catch(t){console.debug(t)}})),c?E[c]=this.viewer:T=this.viewer,window.viewer=this.viewer}},{key:"componentDidUpdate",value:function(){var e,t=this,n={},i=C(this.viewer.layerManager.managedLayers);try{for(i.s();!(e=i.n()).done;){var r=e.value;if(r.layer instanceof l.SegmentationUserLayer){var s=r.layer.displayState.segmentSelectionState;n[r.name]=s.selectedSegment}}}catch(p){i.e(p)}finally{i.f()}var o=this.props.viewerState;if(o){var a=m({},o),c=[function(){t.viewer.state.restoreState(a)}];null===o.projectionScale&&(delete a.projectionScale,c.push((function(){t.viewer.projectionScale.reset()}))),null===o.crossSectionScale&&delete a.crossSectionScale,c.forEach((function(e){return e()}))}var d,u=C(this.viewer.layerManager.managedLayers);try{for(u.s();!(d=u.n()).done;){var h=d.value;if(h.layer instanceof l.SegmentationUserLayer)h.layer.displayState.segmentSelectionState.set(n[h.name])}}catch(p){u.e(p)}finally{u.f()}"position"in o&&Array.isArray(o.position)&&0===o.position.length&&this.viewer.position.reset()}},{key:"componentWillUnmount",value:function(){var e=this.props.key;e?delete E[e]:T=void 0}},{key:"setCallbacks",value:function(e){var t=this;e.forEach((function(e){t.viewer.bindCallback(e.name,e.function),t.viewer.inputEventBindings.sliceView.set(e.event,e.name)}))}},{key:"render",value:function(){var e=this.props.perspectiveZoom;return n.default.createElement("div",{className:"neuroglancer-container",ref:this.ngContainer},n.default.createElement("p",null,"Neuroglancer here with zoom ",e))}}]),i}(n.default.Component);e.default=R,R.propTypes={perspectiveZoom:s.default.number,viewerState:s.default.object,brainMapsClientId:s.default.string,key:s.default.string,eventBindingsToUpdate:s.default.array,onSelectedChanged:s.default.func,onVisibleChanged:s.default.func,onSelectionDetailsStateChanged:s.default.func,onViewerStateChanged:s.default.func,callbacks:s.default.arrayOf(s.default.object),ngServer:s.default.string},R.defaultProps={perspectiveZoom:20,eventBindingsToUpdate:null,brainMapsClientId:"NOT_A_VALID_ID",viewerState:null,onSelectedChanged:null,onVisibleChanged:null,onSelectionDetailsStateChanged:null,onViewerStateChanged:null,key:null,callbacks:[],ngServer:"https://neuroglancer-demo.appspot.com/"}}(o);const nV=s({__proto__:null,default:(0,i.g)(o)},[o])}}]);
//# sourceMappingURL=491.ecc4ebdb.chunk.js.map